function e(e,t,i,r){return new(i||(i=Promise))((function(s,n){function o(e){try{h(r.next(e))}catch(e){n(e)}}function a(e){try{h(r.throw(e))}catch(e){n(e)}}function h(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}h((r=r.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;class t{constructor(){this.enabled=!1,this.defaultEnabled=!1,this.bufferFetcherService=null,this.bufferDecoderService=null,this.configService=null}isEnabled(){return this.enabled}isDefaultEnabled(){return this.defaultEnabled}setDefaultEnabled(e){this.defaultEnabled=e}setEnabled(e){this.enabled=e}enable(){this.setEnabled(!0)}disable(){this.setEnabled(!1)}toggle(){this.setEnabled(!this.isEnabled())}}var i;!function(e){e.LOADING_BUFFERS="loadingBuffers",e.LOADING_BUFFERS_ERROR="loadingBuffersError",e.FETCHING_BUFFERS="fetchingBuffers",e.FETCHING_BUFFERS_ERROR="fetchingBuffersError",e.FINISHED_FETCHING_BUFFERS="finishedFetchingBuffers",e.LOADED_BUFFERS="loadedBuffers",e.COMPATIBILITY_MODE_AUTO_ENABLED="compatibilityModeAutoEnabled",e.RENDERING_AUDIO_PROBLEM_DETECTED="renderingAudioProblemDetected",e.AUDIO_RENDERING_FINISHED="audioRenderingFinished",e.OFFLINE_AUDIO_RENDERING_FINISHED="offlineAudioRenderingFinished",e.PLAYING_STOPPED="playingStopped",e.PLAYING_STARTED="playingStarted",e.PLAYING_FINISHED="playingFinished",e.PLAYING_UPDATE="playingUpdate",e.RECORDER_INIT="recorderInit",e.RECORDER_SUCCESS="recorderSuccess",e.RECORDER_ERROR="recorderError",e.RECORDER_UPDATE_CONSTRAINTS="recorderUpdateConstraints",e.RECORDER_RECORDING="recorderRecording",e.RECORDER_STOPPED="recorderStopped",e.RECORDER_PAUSED="recorderPaused",e.RECORDER_RESETED="recorderReseted",e.RECORDER_COUNT_UPDATE="recorderCountUpdate",e.SAMPLE_RATE_CHANGED="sampleRateChanged",e.DECODING_AUDIO_FILE="decodingAudioFile",e.DECODED_AUDIO_FILE="decodedAudioFile",e.ERROR_DECODING_AUDIO_FILE="errorDecodingAudioFile",e.RECORDER_NOT_FOUND_ERROR="recorderNotFoundError",e.RECORDER_UNKNOWN_ERROR="recorderUnknownError",e.UPDATE_AUDIO_TREATMENT_PERCENT="updateAudioTreatmentPercent",e.UPDATE_REMAINING_TIME_ESTIMATED="updateRemainingTimeEstimated",e.CANCELLED_AND_LOADED_INITIAL_AUDIO="cancelledAndLoadedInitialAudio",e.CANCELLING_AUDIO_PROCESSING="cancellingAudioProcessing"}(i||(i={}));const r={calcAudioDuration:(e,t)=>{if(e){let i=e.duration+1;return t&&(i/=t),i}return 0},loadAudioBuffer:(t,i)=>e(void 0,void 0,void 0,(function*(){const e=yield r.readAsArrayBufferPromisified(i),s=yield t.decodeAudioData(e);return r.decodeBuffer(t,s)})),readAsArrayBufferPromisified:e=>new Promise(((t,i)=>{const r=new FileReader;r.onload=e=>{var r;const s=null===(r=null==e?void 0:e.target)||void 0===r?void 0:r.result;s instanceof ArrayBuffer?t(s):i()},e&&r.readAsArrayBuffer(e)})),decodeBuffer:(e,t)=>{if(1==t.numberOfChannels){e.resume();const i=t.duration,r=e.sampleRate,s=e.createBuffer(2,r*i+2*r,r),n=t.getChannelData(0),o=s.getChannelData(0),a=s.getChannelData(1);for(let e=0;e<n.length;e++)o[e]=n[e],a[e]=n[e];return s}return t},convertAudioBufferToFloat32Array:e=>{const t=[];for(let i=0;i<e.numberOfChannels;i++)t.push(e.getChannelData(i));return t},convertAudioParamToFloat32Array:(e,t)=>{const i=new Float32Array(t);for(let r=0;r<t;r++)i.set([e.value],r);return i},sumAudioBufferChannel:(e,t)=>e.getChannelData(t).reduce(((e,t)=>e+t),0),sumAudioBuffer(e){let t=0;for(let i=0;i<e.numberOfChannels;i++)t+=this.sumAudioBufferChannel(e,i);return t},isAudioWorkletCompatible:e=>void 0!==e&&void 0!==e.audioWorklet,isSettingValueValid:e=>!(void 0===e||isNaN(Number(e))||"string"==typeof e&&""===e.trim()),calculateAudioDuration(e,t,i){if(e&&t){return this.calcAudioDuration(e,i)+t.getAddingTime()}return 0},resetAudioRenderingProgress(e){e&&(e.emit(i.UPDATE_AUDIO_TREATMENT_PERCENT,0),e.emit(i.UPDATE_REMAINING_TIME_ESTIMATED,-1))}};class s{constructor(){this.listeners={},this.listeners={}}on(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}emit(e,t){this.listeners[e]&&this.listeners[e].forEach((e=>{e(t)}))}off(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter((e=>e!==t)))}}const n={AUDIO_EDITOR:"audioEditor",VOICE_RECORDER:"voiceRecorder",BUFFER_PLAYER:"bufferPlayer",AUDIO_CONTEXT_MANAGER:"audioContextManager",AUDIO_PROCESSOR:"audioProcessor",BUFFER_MANAGER:"bufferManager",FILTER_MANAGER:"filterManager",RENDERER_MANAGER:"rendererManager",SAVE_BUFFER_MANAGER:"saveBufferManager",EXPORT_WAV_COMMAND:"exportWAV",EXPORT_MP3_COMMAND:"exportMP3",AUDIO_WAV:"audio/wav",AUDIO_MP3:"audio/mp3",RECORD_COMMAND:"record",INIT_COMMAND:"init",FILTERS_NAMES:{REVERB:"reverb",ECHO:"echo",BASS_BOOST:"bassboost",BITCRUSHER:"bitcrusher",HIGH_PASS:"highpass",LIMITER:"limiter",LOW_PASS:"lowpass",PASSTHROUGH:"passthroughfilter",RETURN_AUDIO:"returnAudio",SOUNDTOUCH:"soundtouch",TELEPHONIZER:"telephonizer",VOCODER:"vocoder"},WORKLET_PATHS:{BITCRUSHER:"BitCrusher.worklet.js",LIMITER:"Limiter.worklet.js",SOUNDTOUCH:"Soundtouch.worklet.js",RECORDER_WORKLET:"RecorderWorklet.js",PASSTHROUGH:"Passthrough.worklet.js"},WORKLET_NAMES:{BITCRUSHER:"bitcrusher-processor",LIMITER:"limiter-processor",SOUNDTOUCH:"soundtouch-worklet",RECORDER_WORKLET:"recorder-worklet",PASSTHROUGH:"passthrough"},PREFERENCES_KEYS:{COMPATIBILITY_MODE_ENABLED:"compatibility-mode-enabled",COMPATIBILITY_MODE_CHECKED:"compatibility-mode-checked",ENABLE_AUDIO_WORKLET:"enable-audio-worklet",ENABLE_SOUNDTOUCH_AUDIO_WORKLET:"enable-soundtouch-audio-worklet",BUFFER_SIZE:"buffer-size",SAMPLE_RATE:"sample-rate",DISABLE_INITIAL_RENDERING:"disable-initial-rendering",BITRATE_MP3:"bitrate-mp3"},ENABLE_SOUNDTOUCH_AUDIO_WORKLET:!0,ENABLE_AUDIO_WORKLET:!0,ENABLE_RECORDER_AUDIO_WORKLET:!0,SOUNDTOUCH_PITCH_SHIFTER_BUFFER_SIZE:16384,DEFAULT_REVERB_ENVIRONMENT:{name:"Medium Damping Cave E002 M2S",url:"impulse_response.wav",size:1350278,addDuration:4,link:"http://www.cksde.com/p_6_250.htm"},VOCODER_MODULATOR:"modulator.mp3",DEFAULT_BUFFER_SIZE:0,VALID_BUFFER_SIZE:[0,256,512,1024,2048,4096,8192,16384],VALID_MP3_BITRATES:[32,64,96,128,160,256,320],DEFAULT_SAMPLE_RATE:0,VALID_SAMPLE_RATES:[0,8e3,11025,16e3,22050,32e3,44100,48e3,88200,96e3,176400,192e3],TREATMENT_TIME_COUNTING_THROTTLE_INTERVAL:100,TREATMENT_TIME_COUNTING_SMOOTHING_FACTOR:.9,DISABLE_INITIAL_RENDERING:!0,DEFAULT_SAVE_FORMAT:"wav",DEFAULT_MP3_BITRATE:320};class o extends t{constructor(t,i){super(),this.buffer=null,this.source=null,this.currentTime=0,this.displayTime=0,this.duration=0,this.intervals=[],this.playing=!1,this.loop=!1,this.speedAudio=1,this.onBeforePlayingCallback=()=>e(this,void 0,void 0,(function*(){})),this.compatibilityMode=!1,this.currentNode=null,this._contextManager=t,this.eventEmitter=i||new s}init(e){this.playing=!1,this._contextManager&&this._contextManager.currentContext&&(this._contextManager.currentContext.resume(),!this.compatibilityMode&&this.buffer&&(null==this.source||e||this.source.disconnect(),this.source=this._contextManager.currentContext.createBufferSource(),this.source.buffer=this.buffer,this.duration=this.buffer.duration*this.speedAudio,this.source.connect(this._contextManager.currentContext.destination))),this.updateInfos()}loadBuffer(e){this.compatibilityMode=!1,this.reset(),this.buffer=e,this.init()}setCompatibilityMode(e,t){this.compatibilityMode=!0,this.reset(),this.init(),null!=t&&(this.duration=t*this.speedAudio),this.currentNode=e,this.updateInfos()}reset(e){this.clearIntervals(),this.currentTime=0,this.displayTime=0,e||this.stop()}stop(){var e;this.clearIntervals(),null!=this.source&&null!=this.source&&this.playing&&(this.source.stop(0),this.playing=!1),this.currentNode&&(this.currentNode.disconnect(),this.compatibilityMode&&(this.currentTime=0,this.displayTime=0)),null===(e=this.eventEmitter)||void 0===e||e.emit(i.PLAYING_STOPPED),this.updateInfos()}clearIntervals(){for(const e of this.intervals)clearInterval(e);this.intervals=[]}start(t){return e(this,void 0,void 0,(function*(){var e;if(this.source||this.compatibilityMode){if(t||this.stop(),this.init(t),yield this.onBeforePlayingCallback(),null===(e=this.eventEmitter)||void 0===e||e.emit(i.PLAYING_STARTED),this.compatibilityMode){if(!(this.currentNode&&this._contextManager&&this._contextManager.currentContext))return;this.currentNode.connect(this._contextManager.currentContext.destination)}else{if(!this.source)return;this.source.start(0,t?0:this.currentTime/this.speedAudio),this.playing=!0}let r=performance.now();this.intervals.push(window.setInterval((()=>{var e,s;const n=performance.now(),o=n-r;r=n,this.currentTime+=o/1e3*this.speedAudio,this.displayTime=this.currentTime,this.currentTime>this.duration?this.loop?this.compatibilityMode?null===(e=this.eventEmitter)||void 0===e||e.emit(i.PLAYING_FINISHED):(this.reset(t),this.start()):(null===(s=this.eventEmitter)||void 0===s||s.emit(i.PLAYING_FINISHED),this.reset(t)):this.updateInfos()}),100))}}))}playDirect(){return e(this,void 0,void 0,(function*(){this.compatibilityMode?this.start(!1):this.start(!0)}))}pause(){this.stop()}updateInfos(){var e;null===(e=this.eventEmitter)||void 0===e||e.emit(i.PLAYING_UPDATE)}setTimePercent(e){this.compatibilityMode||(this.currentTime=Math.round(this.duration*(e/100)),this.displayTime=this.currentTime,this.playing?(this.pause(),this.start()):this.updateInfos())}setTime(e){this.compatibilityMode||(this.currentTime=e,this.displayTime=this.currentTime,this.playing?(this.pause(),this.start()):this.updateInfos())}onBeforePlaying(e){this.onBeforePlayingCallback=e}toggleLoop(){this.loop=!this.loop}on(e,t){var i;null===(i=this.eventEmitter)||void 0===i||i.on(e,t)}get currentTimeDisplay(){return("0"+Math.trunc(this.displayTime/60)).slice(-2)+":"+("0"+Math.trunc(this.displayTime%60)).slice(-2)}get maxTimeDisplay(){return("0"+Math.trunc(this.duration/60)).slice(-2)+":"+("0"+Math.trunc(this.duration%60)).slice(-2)}get percent(){return 100-Math.round((this.duration-this.displayTime)/this.duration*100)}get remainingTimeDisplay(){return("0"+Math.trunc((this.duration-this.displayTime)/60)).slice(-2)+":"+("0"+Math.trunc((this.duration-this.displayTime)%60)).slice(-2)}set contextManager(e){this._contextManager=e}get order(){return-1}get id(){return n.BUFFER_PLAYER}}class a{constructor(e,t,i){this.buffers=new Map,this.bufferErrors=[],this.configService=null,this.contextManager=e,this.eventEmitter=i||new s,this.configService=t}fetchBuffer(t,s){return e(this,void 0,void 0,(function*(){var e,n,o,a;const h=(this.configService?this.configService.getSoundBasePath():"")+t;if(null==this.buffers.get(this.getKeyFromLocation(h))||s){null===(e=this.eventEmitter)||void 0===e||e.emit(i.FETCHING_BUFFERS,h);try{const e=yield fetch(h);if(!e.ok)throw this.bufferErrors.push(h),null===(n=this.eventEmitter)||void 0===n||n.emit(i.FETCHING_BUFFERS_ERROR,h),i.FETCHING_BUFFERS_ERROR;{const t=yield e.arrayBuffer();if(this.contextManager&&this.contextManager.currentContext){const e=yield this.contextManager.currentContext.decodeAudioData(t);this.buffers.set(this.getKeyFromLocation(h),r.decodeBuffer(this.contextManager.currentContext,e))}}null===(o=this.eventEmitter)||void 0===o||o.emit(i.FINISHED_FETCHING_BUFFERS,h)}catch(e){throw this.bufferErrors.push(h),null===(a=this.eventEmitter)||void 0===a||a.emit(i.FETCHING_BUFFERS_ERROR,h),i.FETCHING_BUFFERS_ERROR}}}))}fetchAllBuffers(t){return e(this,void 0,void 0,(function*(){for(const e of t)yield this.fetchBuffer(e)}))}getAudioBuffer(e){return this.buffers.get(this.getKeyFromLocation(e))}getOrFetchAudioBuffer(t){return e(this,void 0,void 0,(function*(){return null==this.getAudioBuffer(t)&&(yield this.fetchBuffer(t)),this.getAudioBuffer(t)}))}getDownloadedBuffersList(){return Array.from(this.buffers.keys())}getKeyFromLocation(e){return e.substring(e.lastIndexOf("/")+1)}reset(){this.buffers.clear()}}class h{constructor(){this.mapConfig=new Map}getConfig(e){return this.mapConfig.get(e)}setConfig(e,t){this.mapConfig.set(e,t)}isCompatibilityModeEnabled(){return"true"==this.getConfig(n.PREFERENCES_KEYS.COMPATIBILITY_MODE_ENABLED)}isCompatibilityModeChecked(){return"true"==this.getConfig(n.PREFERENCES_KEYS.COMPATIBILITY_MODE_CHECKED)}isAudioWorkletEnabled(){const e=this.getConfig(n.PREFERENCES_KEYS.ENABLE_AUDIO_WORKLET);return null!=e?"true"==e:n.ENABLE_AUDIO_WORKLET}isSoundtouchAudioWorkletEnabled(){const e=this.getConfig(n.PREFERENCES_KEYS.ENABLE_SOUNDTOUCH_AUDIO_WORKLET);return null!=e?"true"==e:n.ENABLE_SOUNDTOUCH_AUDIO_WORKLET}getBufferSize(){const e=this.getConfig(n.PREFERENCES_KEYS.BUFFER_SIZE);return null!=e?parseInt(e):n.DEFAULT_BUFFER_SIZE}getSampleRate(){const e=this.getConfig(n.PREFERENCES_KEYS.SAMPLE_RATE);return null!=e?parseInt(e):n.DEFAULT_SAMPLE_RATE}getBitrateMP3(){const e=this.getConfig(n.PREFERENCES_KEYS.BITRATE_MP3);return null!=e?parseInt(e):n.DEFAULT_MP3_BITRATE}enableCompatibilityMode(){this.setConfig(n.PREFERENCES_KEYS.COMPATIBILITY_MODE_ENABLED,"true")}disableCompatibilityMode(){this.setConfig(n.PREFERENCES_KEYS.COMPATIBILITY_MODE_ENABLED,"false")}getWorkletBasePath(){return""}getWorkerBasePath(){return""}getSoundBasePath(){return""}isInitialRenderingDisabled(){const e=this.getConfig(n.PREFERENCES_KEYS.DISABLE_INITIAL_RENDERING);return null!=e?"true"==e:n.DISABLE_INITIAL_RENDERING}}class u{constructor(e,t){this.contextManager=e,this.eventEmitter=t||new s}decodeBufferFromFile(t){return e(this,void 0,void 0,(function*(){this.eventEmitter&&this.eventEmitter.emit(i.DECODING_AUDIO_FILE);try{if(this.contextManager&&this.contextManager.currentContext){const e=yield r.loadAudioBuffer(this.contextManager.currentContext,t);return this.eventEmitter&&this.eventEmitter.emit(i.DECODED_AUDIO_FILE),e}}catch(e){console.error(e),this.eventEmitter&&(this.eventEmitter.emit(i.DECODED_AUDIO_FILE),this.eventEmitter.emit(i.ERROR_DECODING_AUDIO_FILE))}return null}))}}class l extends t{constructor(){super(...arguments),this.defaultSettings=null,this.eventEmitter=void 0,this._totalSamples=0}getAddingTime(){return 0}initializeDefaultSettings(){this.defaultSettings=this.getSettings()}getDefaultSettings(){return this.defaultSettings}resetSettings(){return e(this,void 0,void 0,(function*(){if(this.defaultSettings)for(const e in this.defaultSettings)this.defaultSettings&&void 0!==this.defaultSettings[e]&&(yield this.setSetting(e,this.defaultSettings[e]))}))}isWorklet(){return!1}bufferFetcherReseted(){return e(this,void 0,void 0,(function*(){return!1}))}set totalSamples(e){this._totalSamples=e}}class c extends l{constructor(e,t,i,r){super(),this.frequencyBooster=200,this.frequencyReduce=200,this.dbBooster=15,this.dbReduce=-2,this.frequencyBooster=e,this.dbBooster=t,this.frequencyReduce=i,this.dbReduce=r}getNode(e){const t=e.createBiquadFilter();t.type="lowshelf",t.frequency.value=this.frequencyBooster,t.gain.value=this.dbBooster;const i=e.createBiquadFilter();return i.type="highshelf",i.frequency.value=this.frequencyReduce,i.gain.value=this.dbReduce,i.connect(t),{input:i,output:t}}get order(){return 3}get id(){return n.FILTERS_NAMES.BASS_BOOST}getSettings(){return{frequencyBooster:this.frequencyBooster,frequencyReduce:this.frequencyReduce,dbBooster:this.dbBooster,dbReduce:this.dbReduce}}setSetting(t,i){return e(this,void 0,void 0,(function*(){if(r.isSettingValueValid(i))switch(t){case"frequencyBooster":this.frequencyBooster=parseInt(i);break;case"frequencyReduce":this.frequencyReduce=parseInt(i);break;case"dbBooster":this.dbBooster=parseInt(i);break;case"dbReduce":this.dbReduce=parseInt(i)}}))}}class d{constructor(e,t){this._value=0,this._minValue=0,this._maxValue=Number.MAX_SAFE_INTEGER,this._defaultValue=0,this.context=null,this.automationRate="a-rate",this._defaultValue=void 0!==t?t:0,this._value=this._defaultValue,this.context=e}get value(){return this._value}set value(e){this._value=Math.max(this._minValue,Math.min(this._maxValue,e))}get minValue(){return this._minValue}get maxValue(){return this._maxValue}get defaultValue(){return this._defaultValue}setValueAtTime(e,t){return console.warn("setValueAtTime used with AudioParamPolyfill, is not fully compatible with standard AudioParam"),this.value=e,new d(this.context,e)}linearRampToValueAtTime(e,t){return console.warn("linearRampToValueAtTime used with AudioParamPolyfill, is not fully compatible with standard AudioParam"),this.value=e,new d(this.context,e)}exponentialRampToValueAtTime(e,t){return console.warn("exponentialRampToValueAtTime used with AudioParamPolyfill, is not fully compatible with standard AudioParam"),this.value=e,new d(this.context,e)}cancelAndHoldAtTime(e){throw new Error("Method not implemented.")}cancelScheduledValues(e){throw new Error("Method not implemented.")}setTargetAtTime(e,t,i){throw new Error("Method not implemented.")}setValueCurveAtTime(e,t,i){throw new Error("Method not implemented.")}}class f{constructor(e,t,i){this._parameters=new Map,this._port=null,this.currentContext=null,this.workletProcessor=t,this.currentContext=e,this._scriptProcessorNode=e.createScriptProcessor(i,2,2),this.setupPort(),this.setupProcessor(),this.setupWorkletScope(e)}setupPort(){const e=new MessageChannel;e.port1.onmessage=e=>{this.workletProcessor&&this.workletProcessor.port2&&this.workletProcessor.port2.postMessage(e.data)},this.workletProcessor&&this.workletProcessor.port2&&(this.workletProcessor.port2.onmessage=t=>{e.port1.postMessage(t.data)}),this._port=e.port2}setupProcessor(){if(!this._scriptProcessorNode)return;this._scriptProcessorNode.onaudioprocess=e=>{if(this.workletProcessor){const t=[r.convertAudioBufferToFloat32Array(e.inputBuffer)],i=[r.convertAudioBufferToFloat32Array(e.outputBuffer)],s=[];for(const[e,t]of this._parameters.entries())s.push([e,r.convertAudioParamToFloat32Array(t,1)]);const n=Object.fromEntries(s);this.workletProcessor.process(t,i,n)}};const e=this.workletProcessor.defaultParameterDescriptors;e&&e.forEach((e=>{this.currentContext&&this._parameters.set(e.name,new d(this.currentContext,e.defaultValue))}))}setupWorkletScope(e){"undefined"!=typeof window&&(window.sampleRate=e.sampleRate)}get port(){return this._port}get parameters(){return this._parameters}get node(){return this._scriptProcessorNode}get context(){var e;return null===(e=this._scriptProcessorNode)||void 0===e?void 0:e.context}}class p{static registerProcessor(e,t){p.processorsMap.set(e,t)}static getProcessor(e){const t=p.processorsMap.get(e);return t?new t:null}}p.processorsMap=new Map;class m{constructor(){this.messageChannel=null,this.messageChannel=new MessageChannel}process(e,t,i){return!0}get port(){return this.messageChannel&&this.messageChannel.port1}get port2(){return this.messageChannel&&this.messageChannel.port2}get parameters(){throw new Error("Method not implemented.")}get parameterDescriptors(){throw new Error("Method not implemented.")}get defaultParameterDescriptors(){return[]}}"undefined"==typeof window||"AudioWorkletProcessor"in window||(window.AudioWorkletProcessor=m,window.registerProcessor=p.registerProcessor),"undefined"==typeof global||"AudioWorkletProcessor"in global||(global.AudioWorkletProcessor=m,global.registerProcessor=p.registerProcessor);class g extends l{constructor(){super(...arguments),this.currentWorkletNode=null,this.fallbackToScriptProcessor=!1,this.keepCurrentNodeIfPossible=!1}initializeWorklet(t){return e(this,void 0,void 0,(function*(){if(this.stop(),!r.isAudioWorkletCompatible(t))return console.error("Audio Worklets not supported on this browser. Fallback to ScriptProcessor"),void(this.fallbackToScriptProcessor=!0);const e=(this.configService?this.configService.getWorkletBasePath():"")+this.workletPath;yield t.audioWorklet.addModule(e).catch((t=>{console.error(`Error when loading Worklet (${e}) for filter ${this.id}. Fallback to ScriptProcessor. Exception:`,t),this.fallbackToScriptProcessor=!0}))}))}isAudioWorkletEnabled(){return this.configService?this.configService.isAudioWorkletEnabled():n.ENABLE_AUDIO_WORKLET}initializeNode(e,t){if(this.isAudioWorkletEnabled()&&!this.fallbackToScriptProcessor)this.currentWorkletNode=new AudioWorkletNode(e,t);else{const i=p.getProcessor(t);if(!i)throw new Error(`No processor registered with name ${t} for filter ${this.id} to use the fallback/polyfill for AudioWorklet. Make sure you have created the class.`);this.currentWorkletNode=new f(e,i,this.configService.getBufferSize())}this.currentWorkletNode&&this.currentWorkletNode.port&&(this.currentWorkletNode.port.onmessage=e=>this.receiveEvent(e))}applyCurrentSettingsToWorklet(){if(this.currentWorkletNode&&this.currentWorkletNode.parameters){const e=this.getSettings();for(const t of Object.keys(e)){const i=this.currentWorkletNode.parameters.get(t);i&&(i.value=e[t],i.setValueAtTime(e[t],0))}}}getNode(e){if(this.keepCurrentNodeIfPossible&&this.currentWorkletNode&&this.currentWorkletNode.context==e||(this.stop(),this.initializeNode(e,this.workletName)),this.applyCurrentSettingsToWorklet(),this.setEnabled(this.isEnabled()),this.currentWorkletNode)return this.currentWorkletNode instanceof f?{input:this.currentWorkletNode.node,output:this.currentWorkletNode.node}:{input:this.currentWorkletNode,output:this.currentWorkletNode};throw new Error("Worklet node has not yet been created")}stop(){this.currentWorkletNode&&this.currentWorkletNode.port&&(this.currentWorkletNode.port.postMessage("stop"),this.currentWorkletNode.port.onmessage=null),this.currentWorkletNode=null}setEnabled(e){this.currentWorkletNode&&this.currentWorkletNode.port&&this.currentWorkletNode.port.postMessage(e?"enable":"disable"),super.setEnabled(e)}isWorklet(){return!0}}class E extends AudioWorkletProcessor{constructor(){super(),this.stopped=!1,this.phaser=null,this.last=null,this.port.onmessage=e=>{"stop"==e.data&&this.stop()}}static get parameterDescriptors(){return[{name:"bits",defaultValue:16},{name:"normFreq",defaultValue:.9}]}get defaultParameterDescriptors(){return E.parameterDescriptors}process(e,t,i){if(this.stopped)return!1;const r=e[0],s=t[0],n=2*Math.pow(.5,i.bits[0]),o=(1-i.normFreq[0])/(sampleRate/48e3);if(null==this.last&&(this.last=new Array(r.length).fill(0)),null==this.phaser&&(this.phaser=new Array(r.length).fill(0)),r&&r[0]){const e=r[0].length;for(let t=0;t<r.length;t++){const i=r[t],a=s[t];if(i&&a)for(let r=0;r<e;r++)this.phaser[t]+=o,this.phaser[t]>=1&&(this.phaser[t]-=1,this.last[t]=n*Math.floor(i[r]*(1/n)+.5)),a[r]=this.last[t]}}return!0}stop(){this.stopped=!0,this.phaser=null,this.last=null}}registerProcessor(n.WORKLET_NAMES.BITCRUSHER,E);let v=class extends g{constructor(e,t){super(),this.bits=16,this.normFreq=.9,this.bits=e,this.normFreq=t}receiveEvent(e){}get workletPath(){return n.WORKLET_PATHS.BITCRUSHER}get workletName(){return n.WORKLET_NAMES.BITCRUSHER}get order(){return 6}get id(){return n.FILTERS_NAMES.BITCRUSHER}getSettings(){return{bits:this.bits,normFreq:this.normFreq}}setSetting(t,i){return e(this,void 0,void 0,(function*(){if(r.isSettingValueValid(i)){switch(t){case"bits":this.bits=parseInt(i);break;case"normFreq":this.normFreq=parseFloat(i)}this.applyCurrentSettingsToWorklet()}}))}};class S extends l{constructor(e,t){super(),this.delay=.2,this.gain=.75,this.delay=e,this.gain=t}getNode(e){const t=e.createDelay(179);t.delayTime.value=this.delay;const i=e.createGain();return i.gain.value=this.gain,i.connect(t),t.connect(i),{input:i,output:t}}get order(){return 7}get id(){return n.FILTERS_NAMES.ECHO}getAddingTime(){return 5}getSettings(){return{delay:this.delay,gain:this.gain}}setSetting(t,i){return e(this,void 0,void 0,(function*(){if(r.isSettingValueValid(i))switch(t){case"delay":this.delay=parseFloat(i);break;case"gain":this.gain=parseFloat(i)}}))}}class _ extends l{constructor(e){super(),this.highFrequency=3500,this.highFrequency=e}getNode(e){const t=e.createBiquadFilter();return t.type="highpass",t.frequency.value=this.highFrequency,{input:t,output:t}}get order(){return 4}get id(){return n.FILTERS_NAMES.HIGH_PASS}getSettings(){return{highFrequency:this.highFrequency}}setSetting(t,i){return e(this,void 0,void 0,(function*(){if(r.isSettingValueValid(i)&&"highFrequency"===t)this.highFrequency=parseInt(i)}))}}class R{constructor(e){this._array=new Float32Array,this.n=0,this.length=0,this.readPointer=0,this.writePointer=0,this.n=Math.floor(e),this.init()}init(){this._array=new Float32Array(2*this.n),this.length=this._array.length,this.readPointer=0,this.writePointer=this.n-1,this._array.fill(0)}read(){const e=this._array[this.readPointer%this.length];return this.readPointer=(this.readPointer+1)%this.length,e}push(e){this._array[this.writePointer%this.length]=e,this.writePointer=(this.writePointer+1)%this.length}reset(){this.init()}clear(){this._array=new Float32Array,this.length=0,this.readPointer=0,this.writePointer=0}sum(){return this._array.reduce(((e,t)=>e+t),0)}}class A extends AudioWorkletProcessor{constructor(){super(),this.delayBuffer=[],this.envelopeSample=0,this.stopped=!1,this.disabled=!1,this.port.onmessage=e=>{"reset"==e.data?this.reset():"stop"==e.data?this.stop():"disable"==e.data?this.disabled=!0:"enable"==e.data&&(this.disabled=!1)}}static get parameterDescriptors(){return[{name:"preGain",defaultValue:0},{name:"postGain",defaultValue:0},{name:"attackTime",defaultValue:0},{name:"releaseTime",defaultValue:3},{name:"threshold",defaultValue:-.05},{name:"lookAheadTime",defaultValue:0}]}get defaultParameterDescriptors(){return A.parameterDescriptors}getEnvelope(e,t,i,r){const s=Math.exp(-1/(r*t)),n=Math.exp(-1/(r*i)),o=new Float32Array(e.length);for(let t=0;t<e.length;t++){const i=Math.abs(e[t]);this.envelopeSample<i?this.envelopeSample=i+s*(this.envelopeSample-i):this.envelopeSample=i+n*(this.envelopeSample-i),o[t]=this.envelopeSample}return o}getMaxEnvelope(e,t,i){let r=e[0][i];for(let s=0;s<t;s++)e[s][i]>r&&(r=e[s][i]);return r}ampToDB(e){return 20*Math.log10(e)}dBToAmp(e){return Math.pow(10,e/20)}process(e,t,i){if(this.stopped)return!1;const r=e[0],s=t[0],n=[],o=this.dBToAmp(i.postGain[0]),a=this.dBToAmp(i.preGain[0]);for(let e=0;e<s.length;e++){const t=r[e],o=s[e];if(null==this.delayBuffer[e]&&(this.delayBuffer[e]=new R(i.lookAheadTime[0]*sampleRate)),t&&o)for(let e=0;e<t.length;++e)this.disabled?o[e]=t[e]:o[e]=a*t[e];!this.disabled&&o&&(n[e]=this.getEnvelope(o,i.attackTime[0],i.releaseTime[0],sampleRate))}for(let e=0;e<s.length;e++){const t=r[e],a=s[e];if(i.lookAheadTime[0]>0&&a)for(let t=0;t<a.length;t++)this.delayBuffer[e].push(a[t]),a[t]=this.delayBuffer[e].read();if(this.disabled)continue;const h=1;if(t&&a)for(let e=0;e<t.length;e++){let t=h*(i.threshold[0]-this.ampToDB(this.getMaxEnvelope(n,s.length,e)));t=Math.min(0,t);const r=this.dBToAmp(t);a[e]*=r*o}}return!0}reset(){for(let e=0;e<this.delayBuffer.length;e++)null!=this.delayBuffer[e]&&this.delayBuffer[e].reset();this.envelopeSample=0}stop(){for(let e=0;e<this.delayBuffer.length;e++)null!=this.delayBuffer[e]&&this.delayBuffer[e].clear();this.delayBuffer=[],this.envelopeSample=0,this.stopped=!0}}registerProcessor(n.WORKLET_NAMES.LIMITER,A);class C extends g{constructor(e,t,i,r,s,n){super(),this.preGain=0,this.postGain=0,this.attackTime=0,this.releaseTime=3,this.threshold=-.05,this.lookAheadTime=.1,this.preGain=e||this.preGain,this.postGain=t||this.postGain,this.attackTime=i||this.attackTime,this.releaseTime=r||this.releaseTime,this.threshold=s||this.threshold,this.lookAheadTime=n||this.lookAheadTime,this.keepCurrentNodeIfPossible=!0,this.enable(),this.setDefaultEnabled(!0)}receiveEvent(e){}get workletPath(){return n.WORKLET_PATHS.LIMITER}get workletName(){return n.WORKLET_NAMES.LIMITER}get order(){return 11}get id(){return n.FILTERS_NAMES.LIMITER}getAddingTime(){return this.lookAheadTime}getSettings(){return{preGain:this.preGain,postGain:this.postGain,attackTime:this.attackTime,releaseTime:this.releaseTime,threshold:this.threshold,lookAheadTime:this.lookAheadTime}}setSetting(t,i){return e(this,void 0,void 0,(function*(){if(r.isSettingValueValid(i)){switch(t){case"preGain":this.preGain=parseFloat(i);break;case"postGain":this.postGain=parseFloat(i);break;case"attackTime":this.attackTime=parseFloat(i);break;case"releaseTime":this.releaseTime=parseFloat(i);break;case"threshold":this.threshold=parseFloat(i);break;case"lookAheadTime":this.lookAheadTime=parseFloat(i)}this.applyCurrentSettingsToWorklet()}}))}}class T extends l{constructor(e){super(),this.lowFrequency=3500,this.lowFrequency=e}getNode(e){const t=e.createBiquadFilter();return t.type="lowpass",t.frequency.value=this.lowFrequency,{input:t,output:t}}get order(){return 5}get id(){return n.FILTERS_NAMES.LOW_PASS}getSettings(){return{lowFrequency:this.lowFrequency}}setSetting(t,i){return e(this,void 0,void 0,(function*(){if(r.isSettingValueValid(i)&&"lowFrequency"===t)this.lowFrequency=parseInt(i)}))}}class b extends l{constructor(){super(...arguments),this.reverbEnvironment=n.DEFAULT_REVERB_ENVIRONMENT,this.reverbCustomEnvironmentAddTime=5,this.customEnvironment=null}getNode(e){const t=e.createConvolver();this.reverbEnvironment&&("custom"!=this.reverbEnvironment.url||this.customEnvironment)||(this.reverbEnvironment=n.DEFAULT_REVERB_ENVIRONMENT);const i=this.getReverbBuffer(e);return i&&(t.buffer=i),{input:t,output:t}}getReverbBuffer(e){if("custom"==this.reverbEnvironment.url&&this.customEnvironment){if(this.customEnvironment.sampleRate===e.sampleRate)return this.customEnvironment;this.reverbEnvironment=n.DEFAULT_REVERB_ENVIRONMENT}else if(this.bufferFetcherService)return this.bufferFetcherService.getAudioBuffer(this.reverbEnvironment.url)}get order(){return 9}get id(){return n.FILTERS_NAMES.REVERB}getAddingTime(){const e=this.getSettings();if(e&&e.reverbEnvironment){if("custom"==e.reverbEnvironment.value)return this.reverbCustomEnvironmentAddTime;if(e.reverbEnvironment.additionalData)return e.reverbEnvironment.additionalData.addDuration}return 0}getSettings(){var e;return this.reverbEnvironment?{reverbEnvironment:{name:this.reverbEnvironment.name,value:this.reverbEnvironment.url,additionalData:{size:this.reverbEnvironment.size,link:this.reverbEnvironment.link,addDuration:this.reverbEnvironment.addDuration}},downloadedBuffers:null===(e=this.bufferFetcherService)||void 0===e?void 0:e.getDownloadedBuffersList(),hasCustomEnvironment:!!this.customEnvironment,reverbCustomEnvironmentAddTime:this.reverbCustomEnvironmentAddTime}:{reverbCustomEnvironmentAddTime:this.reverbCustomEnvironmentAddTime}}setSetting(t,i){return e(this,void 0,void 0,(function*(){var e;if("reverbEnvironment"==t){const t=i;if(t){const i=t.value;try{"custom"!=i&&(yield null===(e=this.bufferFetcherService)||void 0===e?void 0:e.fetchBuffer(i)),t.additionalData?this.reverbEnvironment={name:t.name,url:i,size:t.additionalData.size,addDuration:t.additionalData.addDuration,link:t.additionalData.link}:this.reverbEnvironment={name:t.name,url:i,size:0,addDuration:0,link:""}}catch(e){}}}else"reverbCustomEnvironmentAddTime"==t?r.isSettingValueValid(i)&&(this.reverbCustomEnvironmentAddTime=parseInt(i)):"reverbCustomEnvironmentFile"==t&&this.bufferDecoderService&&i&&(this.customEnvironment=yield this.bufferDecoderService.decodeBufferFromFile(i),this.customEnvironment||(this.reverbEnvironment=n.DEFAULT_REVERB_ENVIRONMENT))}))}bufferFetcherReseted(){return e(this,void 0,void 0,(function*(){var e;const t=this.getSettings();if(t){const i=null===(e=t.reverbEnvironment)||void 0===e?void 0:e.value;if(i&&"custom"!==i&&this.bufferFetcherService)return yield this.bufferFetcherService.fetchBuffer(i),!0}return!1}))}}class B{constructor(){this._vector=new Float32Array,this._position=0,this._frameCount=0}get vector(){return this._vector}get position(){return this._position}get startIndex(){return 2*this._position}get frameCount(){return this._frameCount}get endIndex(){return 2*(this._position+this._frameCount)}clear(){this.receive(this._frameCount),this.rewind()}put(e){this._frameCount+=e}putSamples(e,t,i=0){const r=2*(t=t||0);i>=0||(i=(e.length-r)/2);const s=2*i;this.ensureCapacity(i+this._frameCount);const n=this.endIndex;this.vector.set(e.subarray(r,r+s),n),this._frameCount+=i}putBuffer(e,t,i=0){t=t||0,i>=0||(i=e.frameCount-t),this.putSamples(e.vector,e.position+t,i)}receive(e){e>=0&&!(e>this._frameCount)||(e=this.frameCount),this._frameCount-=e,this._position+=e}receiveSamples(e,t=0){const i=2*t,r=this.startIndex;e.set(this._vector.subarray(r,r+i)),this.receive(t)}extract(e,t=0,i=0){const r=this.startIndex+2*t,s=2*i;e.set(this._vector.subarray(r,r+s))}ensureCapacity(e=0){const t=parseInt(2*e);if(this._vector.length<t){const e=new Float32Array(t);e.set(this._vector.subarray(this.startIndex,this.endIndex)),this._vector=e,this._position=0}else this.rewind()}ensureAdditionalCapacity(e=0){this.ensureCapacity(this._frameCount+e)}rewind(){this._position>0&&(this._vector.set(this._vector.subarray(this.startIndex,this.endIndex)),this._position=0)}}class P{constructor(e){e?(this._inputBuffer=new B,this._outputBuffer=new B):this._inputBuffer=this._outputBuffer=null}get inputBuffer(){return this._inputBuffer}set inputBuffer(e){this._inputBuffer=e}get outputBuffer(){return this._outputBuffer}set outputBuffer(e){this._outputBuffer=e}clear(){this._inputBuffer.clear(),this._outputBuffer.clear()}}class N extends P{constructor(e){super(e),this.reset(),this._rate=1}set rate(e){this._rate=e}reset(){this.slopeCount=0,this.prevSampleL=0,this.prevSampleR=0}clone(){const e=new N;return e.rate=this._rate,e}process(){const e=this._inputBuffer.frameCount;this._outputBuffer.ensureAdditionalCapacity(e/this._rate+1);const t=this.transpose(e);this._inputBuffer.receive(),this._outputBuffer.put(t)}transpose(e=0){if(0===e)return 0;const t=this._inputBuffer.vector,i=this._inputBuffer.startIndex,r=this._outputBuffer.vector,s=this._outputBuffer.endIndex;let n=0,o=0;for(;this.slopeCount<1;)r[s+2*o]=(1-this.slopeCount)*this.prevSampleL+this.slopeCount*t[i],r[s+2*o+1]=(1-this.slopeCount)*this.prevSampleR+this.slopeCount*t[i+1],o+=1,this.slopeCount+=this._rate;if(this.slopeCount-=1,1!==e)e:for(;;){for(;this.slopeCount>1;)if(this.slopeCount-=1,n+=1,n>=e-1)break e;const a=i+2*n;r[s+2*o]=(1-this.slopeCount)*t[a]+this.slopeCount*t[a+2],r[s+2*o+1]=(1-this.slopeCount)*t[a+1]+this.slopeCount*t[a+3],o+=1,this.slopeCount+=this._rate}return this.prevSampleL=t[i+2*e-2],this.prevSampleR=t[i+2*e-1],o}}class y{constructor(e){this._pipe=e}get pipe(){return this._pipe}get inputBuffer(){return this._pipe.inputBuffer}get outputBuffer(){return this._pipe.outputBuffer}fillInputBuffer(){throw new Error("fillInputBuffer() not overridden")}fillOutputBuffer(e=0){for(;this.outputBuffer.frameCount<e;){const e=16384-this.inputBuffer.frameCount;if(this.fillInputBuffer(e),this.inputBuffer.frameCount<16384)break;this._pipe.process()}}clear(){this._pipe.clear()}}const M=function(){};class I extends y{constructor(e,t,i=M){super(t),this.callback=i,this.sourceSound=e,this.historyBufferSize=22050,this._sourcePosition=0,this.outputBufferPosition=0,this._position=0}get position(){return this._position}set position(e){if(e>this._position)throw new RangeError("New position may not be greater than current position");const t=this.outputBufferPosition-(this._position-e);if(t<0)throw new RangeError("New position falls outside of history buffer");this.outputBufferPosition=t,this._position=e}get sourcePosition(){return this._sourcePosition}set sourcePosition(e){this.clear(),this._sourcePosition=e}onEnd(){this.callback()}fillInputBuffer(e=0){const t=new Float32Array(2*e),i=this.sourceSound.extract(t,e,this._sourcePosition);this._sourcePosition+=i,this.inputBuffer.putSamples(t,0,i)}extract(e,t=0){this.fillOutputBuffer(this.outputBufferPosition+t);const i=Math.min(t,this.outputBuffer.frameCount-this.outputBufferPosition);this.outputBuffer.extract(e,this.outputBufferPosition,i);const r=this.outputBufferPosition+i;return this.outputBufferPosition=Math.min(this.historyBufferSize,r),this.outputBuffer.receive(Math.max(r-this.historyBufferSize,0)),this._position+=i,i}handleSampleData(e){this.extract(e.data,4096)}clear(){super.clear(),this.outputBufferPosition=0}}const D=[[124,186,248,310,372,434,496,558,620,682,744,806,868,930,992,1054,1116,1178,1240,1302,1364,1426,1488,0],[-100,-75,-50,-25,25,50,75,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[-20,-15,-10,-5,5,10,15,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[-4,-3,-2,-1,1,2,3,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],F=-10/1.5;class O extends P{constructor(e){super(e),this._quickSeek=!0,this.midBufferDirty=!1,this.midBuffer=null,this.overlapLength=0,this.autoSeqSetting=!0,this.autoSeekSetting=!0,this._tempo=1,this.setParameters(44100,0,0,8)}clear(){super.clear(),this.clearMidBuffer()}clearMidBuffer(){this.midBufferDirty&&(this.midBufferDirty=!1,this.midBuffer=null)}setParameters(e,t,i,r){e>0&&(this.sampleRate=e),r>0&&(this.overlapMs=r),t>0?(this.sequenceMs=t,this.autoSeqSetting=!1):this.autoSeqSetting=!0,i>0?(this.seekWindowMs=i,this.autoSeekSetting=!1):this.autoSeekSetting=!0,this.calculateSequenceParameters(),this.calculateOverlapLength(this.overlapMs),this.tempo=this._tempo}set tempo(e){let t;this._tempo=e,this.calculateSequenceParameters(),this.nominalSkip=this._tempo*(this.seekWindowLength-this.overlapLength),this.skipFract=0,t=Math.floor(this.nominalSkip+.5),this.sampleReq=Math.max(t+this.overlapLength,this.seekWindowLength)+this.seekLength}get tempo(){return this._tempo}get inputChunkSize(){return this.sampleReq}get outputChunkSize(){return this.overlapLength+Math.max(0,this.seekWindowLength-2*this.overlapLength)}calculateOverlapLength(e=0){let t;t=this.sampleRate*e/1e3,t=t<16?16:t,t-=t%8,this.overlapLength=t,this.refMidBuffer=new Float32Array(2*this.overlapLength),this.midBuffer=new Float32Array(2*this.overlapLength)}checkLimits(e,t,i){return e<t?t:e>i?i:e}calculateSequenceParameters(){let e,t;this.autoSeqSetting&&(e=150+-50*this._tempo,e=this.checkLimits(e,50,125),this.sequenceMs=Math.floor(e+.5)),this.autoSeekSetting&&(t=28.333333333333332+F*this._tempo,t=this.checkLimits(t,15,25),this.seekWindowMs=Math.floor(t+.5)),this.seekWindowLength=Math.floor(this.sampleRate*this.sequenceMs/1e3),this.seekLength=Math.floor(this.sampleRate*this.seekWindowMs/1e3)}set quickSeek(e){this._quickSeek=e}clone(){const e=new O;return e.tempo=this._tempo,e.setParameters(this.sampleRate,this.sequenceMs,this.seekWindowMs,this.overlapMs),e}seekBestOverlapPosition(){return this._quickSeek?this.seekBestOverlapPositionStereoQuick():this.seekBestOverlapPositionStereo()}seekBestOverlapPositionStereo(){let e,t,i,r=0;for(this.preCalculateCorrelationReferenceStereo(),e=0,t=Number.MIN_VALUE;r<this.seekLength;r+=1)i=this.calculateCrossCorrelationStereo(2*r,this.refMidBuffer),i>t&&(t=i,e=r);return e}seekBestOverlapPositionStereoQuick(){let e,t,i,r,s,n=0;for(this.preCalculateCorrelationReferenceStereo(),t=Number.MIN_VALUE,e=0,r=0,s=0;n<4;n+=1){let o=0;for(;D[n][o]&&(s=r+D[n][o],!(s>=this.seekLength));)i=this.calculateCrossCorrelationStereo(2*s,this.refMidBuffer),i>t&&(t=i,e=s),o+=1;r=e}return e}preCalculateCorrelationReferenceStereo(){let e,t,i=0;for(;i<this.overlapLength;i+=1)t=i*(this.overlapLength-i),e=2*i,this.refMidBuffer[e]=this.midBuffer[e]*t,this.refMidBuffer[e+1]=this.midBuffer[e+1]*t}calculateCrossCorrelationStereo(e,t){const i=this._inputBuffer.vector;e+=this._inputBuffer.startIndex;let r=0,s=2;const n=2*this.overlapLength;let o;for(;s<n;s+=2)o=s+e,r+=i[o]*t[s]+i[o+1]*t[s+1];return r}overlap(e){this.overlapStereo(2*e)}overlapStereo(e){const t=this._inputBuffer.vector;e+=this._inputBuffer.startIndex;const i=this._outputBuffer.vector,r=this._outputBuffer.endIndex;let s,n,o=0;const a=1/this.overlapLength;let h,u,l;for(;o<this.overlapLength;o+=1)n=(this.overlapLength-o)*a,h=o*a,s=2*o,u=s+e,l=s+r,i[l+0]=t[u+0]*h+this.midBuffer[s+0]*n,i[l+1]=t[u+1]*h+this.midBuffer[s+1]*n}process(){let e,t,i;if(null===this.midBuffer){if(this._inputBuffer.frameCount<this.overlapLength)return;this.midBuffer=new Float32Array(2*this.overlapLength),this._inputBuffer.receiveSamples(this.midBuffer,this.overlapLength)}for(;this._inputBuffer.frameCount>=this.sampleReq;){e=this.seekBestOverlapPosition(),this._outputBuffer.ensureAdditionalCapacity(this.overlapLength),this.overlap(Math.floor(e)),this._outputBuffer.put(this.overlapLength),t=this.seekWindowLength-2*this.overlapLength,t>0&&this._outputBuffer.putBuffer(this._inputBuffer,e+this.overlapLength,t);const r=this._inputBuffer.startIndex+2*(e+this.seekWindowLength-this.overlapLength);this.midBuffer.set(this._inputBuffer.vector.subarray(r,r+2*this.overlapLength)),this.skipFract+=this.nominalSkip,i=Math.floor(this.skipFract),this.skipFract-=i,this._inputBuffer.receive(i)}}}const w=function(e,t){return(e>t?e-t:t-e)>1e-10};class k{constructor(){this.transposer=new N(!1),this.stretch=new O(!1),this._inputBuffer=new B,this._intermediateBuffer=new B,this._outputBuffer=new B,this._rate=0,this._tempo=0,this.virtualPitch=1,this.virtualRate=1,this.virtualTempo=1,this.calculateEffectiveRateAndTempo()}clear(){this.transposer.clear(),this.stretch.clear()}clone(){const e=new k;return e.rate=this.rate,e.tempo=this.tempo,e}get rate(){return this._rate}set rate(e){this.virtualRate=e,this.calculateEffectiveRateAndTempo()}set rateChange(e){this._rate=1+.01*e}get tempo(){return this._tempo}set tempo(e){this.virtualTempo=e,this.calculateEffectiveRateAndTempo()}set tempoChange(e){this.tempo=1+.01*e}set pitch(e){this.virtualPitch=e,this.calculateEffectiveRateAndTempo()}set pitchOctaves(e){this.pitch=Math.exp(.69314718056*e),this.calculateEffectiveRateAndTempo()}set pitchSemitones(e){this.pitchOctaves=e/12}get inputBuffer(){return this._inputBuffer}get outputBuffer(){return this._outputBuffer}calculateEffectiveRateAndTempo(){const e=this._tempo,t=this._rate;this._tempo=this.virtualTempo/this.virtualPitch,this._rate=this.virtualRate*this.virtualPitch,w(this._tempo,e)&&(this.stretch.tempo=this._tempo),w(this._rate,t)&&(this.transposer.rate=this._rate),this._rate>1?this._outputBuffer!=this.transposer.outputBuffer&&(this.stretch.inputBuffer=this._inputBuffer,this.stretch.outputBuffer=this._intermediateBuffer,this.transposer.inputBuffer=this._intermediateBuffer,this.transposer.outputBuffer=this._outputBuffer):this._outputBuffer!=this.stretch.outputBuffer&&(this.transposer.inputBuffer=this._inputBuffer,this.transposer.outputBuffer=this._intermediateBuffer,this.stretch.inputBuffer=this._intermediateBuffer,this.stretch.outputBuffer=this._outputBuffer)}process(){this._rate>1?(this.stretch.process(),this.transposer.process()):(this.transposer.process(),this.stretch.process())}}class x{constructor(e){this.buffer=e,this._position=0}get dualChannel(){return this.buffer.numberOfChannels>1}get position(){return this._position}set position(e){this._position=e}extract(e,t=0,i=0){this.position=i;let r=this.buffer.getChannelData(0),s=this.dualChannel?this.buffer.getChannelData(1):this.buffer.getChannelData(0),n=0;for(;n<t;n++)e[2*n]=r[n+i],e[2*n+1]=s[n+i];return Math.min(t,r.length-i)}}const L=function(e){const t=Math.floor(e/60);return`${t}:${i=parseInt(e-60*t),r=2,s=s||"0",(i+="").length>=r?i:new Array(r-i.length+1).join(s)+i}`;var i,r,s},G=function(e){const t=this.timePlayed,i=this.sampleRate;if(this.sourcePosition=e,this.timePlayed=e/i,t!==this.timePlayed){const e=new CustomEvent("play",{detail:{timePlayed:this.timePlayed,formattedTimePlayed:this.formattedTimePlayed,percentagePlayed:this.percentagePlayed}});this._node.dispatchEvent(e)}};class U{constructor(e,t,i,r=M){this._soundtouch=new k;const s=new x(t);this.timePlayed=0,this.sourcePosition=0,this._filter=new I(s,this._soundtouch,r),this._node=function(e,t,i=M,r=4096){const s=e.createScriptProcessor(r,2,2),n=new Float32Array(2*r);return s.onaudioprocess=e=>{let s=e.outputBuffer.getChannelData(0),o=e.outputBuffer.getChannelData(1),a=t.extract(n,r);i(t.sourcePosition),0===a&&t.onEnd();let h=0;for(;h<a;h++)s[h]=n[2*h],o[h]=n[2*h+1]},s}(e,this._filter,(e=>G.call(this,e)),i),this.tempo=1,this.rate=1,this.duration=t.duration,this.sampleRate=e.sampleRate,this.listeners=[]}get formattedDuration(){return L(this.duration)}get formattedTimePlayed(){return L(this.timePlayed)}get percentagePlayed(){return 100*this._filter.sourcePosition/(this.duration*this.sampleRate)}set percentagePlayed(e){this._filter.sourcePosition=parseInt(e*this.duration*this.sampleRate),this.sourcePosition=this._filter.sourcePosition,this.timePlayed=this.sourcePosition/this.sampleRate}get node(){return this._node}set pitch(e){this._soundtouch.pitch=e}set pitchSemitones(e){this._soundtouch.pitchSemitones=e}set rate(e){this._soundtouch.rate=e}set tempo(e){this._soundtouch.tempo=e}connect(e){this._node.connect(e)}disconnect(){this._node.disconnect()}on(e,t){this.listeners.push({name:e,cb:t}),this._node.addEventListener(e,(e=>t(e.detail)))}off(e=null){let t=this.listeners;e&&(t=t.filter((t=>t.name===e))),t.forEach((e=>{this._node.removeEventListener(e.name,(t=>e.cb(t.detail)))}))}}let W;"undefined"!=typeof window&&void 0!==window.AudioWorkletNode&&(W=class extends AudioWorkletNode{constructor(e,t,i){super(e,t,i),this.name="",this.running=!1,this._tempo=1,this._pitch=1,this.name=this.constructor.name,this.running=!0,this.updateInterval=i.processorOptions.updateInterval}setup(t,i){return e(this,void 0,void 0,(function*(){return new Promise((e=>{this.port&&(this.port.onmessage=t=>{t&&t.data&&"OK"===t.data.status&&"setup"===t.data.args[0]&&(this.port.onmessage=this.messageProcessor.bind(this),e())},this.port.postMessage({command:"setup",args:[t,i]}),this._tempo=t,this._pitch=i)}))}))}set updateInterval(e){this.port.postMessage({command:"updateInterval",args:[e]})}get node(){return this}set tempo(e){this.port.postMessage({command:"setTempo",args:[e]})}set pitch(e){this.port.postMessage({command:"setPitch",args:[e]})}get tempo(){return this.port.postMessage({command:"getTempo",args:[]}),this._tempo}get pitch(){return this.port.postMessage({command:"getPitch",args:[]}),this._pitch}stop(){return e(this,void 0,void 0,(function*(){this.running&&(this.port.postMessage({command:"stop",args:[]}),this.disconnect(),this.running=!1)}))}messageProcessor(e){if(e.data.command){const{command:t}=e.data;if("End"===t)this.stop();if(e.data.status){const t=e.data.args[1];switch(e.data.args[0]){case"getTempo":this._tempo=t;break;case"getPitch":this._pitch=t}return}}}});var V=W;class q extends g{constructor(){super(),this.speedAudio=1,this.frequencyAudio=1,this.currentSpeedAudio=1,this.isOfflineMode=!1,this.enable(),this.setDefaultEnabled(!0)}initializeWorklet(){return e(this,void 0,void 0,(function*(){}))}receiveEvent(e){}get workletPath(){return n.WORKLET_PATHS.SOUNDTOUCH}constructAudioWorkletProcessor(){throw new Error("Method not implemented.")}get workletName(){return n.WORKLET_NAMES.SOUNDTOUCH}getEntrypointNode(t,i,s){return e(this,void 0,void 0,(function*(){if(this.isOfflineMode=s,this.cleanUpOldNodes(),s){if(!this.isEnabled()||1==this.speedAudio&&1==this.frequencyAudio){const e=t.createBufferSource();return e.buffer=i,e.start(),{input:e,output:e}}return this.isAudioWorkletEnabled()&&r.isAudioWorkletCompatible(t)&&1==this.speedAudio?this.renderWithWorklet(i,t):this.renderWithScriptProcessorNode(i,t)}return this.currentPitchShifter=this.getSoundtouchScriptProcessorNode(i,t),this.updateState(),{input:this.currentPitchShifter,output:this.currentPitchShifter}}))}cleanUpOldNodes(){this.currentPitchShifterWorklet&&(this.currentPitchShifterWorklet.stop(),this.currentPitchShifterWorklet.disconnect()),this.currentPitchShifter&&(this.currentPitchShifter.disconnect(),this.currentPitchShifter._filter=null)}getSoundtouchScriptProcessorNode(e,t){return new U(t,e,n.SOUNDTOUCH_PITCH_SHIFTER_BUFFER_SIZE)}renderWithScriptProcessorNode(t,i){return e(this,void 0,void 0,(function*(){const e=r.calcAudioDuration(t,this.speedAudio),s=new OfflineAudioContext(2,i.sampleRate*e,i.sampleRate);this.currentPitchShifter=this.getSoundtouchScriptProcessorNode(t,s),this.updateState(),this.currentPitchShifter.connect(s.destination);const n=yield s.startRendering(),o=i.createBufferSource();return o.buffer=n,o.start(),this.cleanUpOldNodes(),{input:o,output:o}}))}renderWithWorklet(t,i){return e(this,void 0,void 0,(function*(){const e=r.calcAudioDuration(t,this.speedAudio);try{yield i.audioWorklet.addModule((this.configService?this.configService.getWorkletBasePath():"")+n.WORKLET_PATHS.SOUNDTOUCH);const r=i.createBufferSource();return r.buffer=t,r.start(),this.currentPitchShifterWorklet=new V(i,"soundtouch-worklet",{processorOptions:{bypass:!1,recording:!1,nInputFrames:this.approximateNInputFrames(e,i),updateInterval:10,sampleRate:t.sampleRate}}),r.connect(this.currentPitchShifterWorklet.node),this.isEnabled()?yield this.currentPitchShifterWorklet.setup(this.speedAudio,this.frequencyAudio):yield this.currentPitchShifterWorklet.setup(1,1),{input:this.currentPitchShifterWorklet,output:this.currentPitchShifterWorklet}}catch(e){return console.error(e),this.renderWithScriptProcessorNode(t,i)}}))}approximateNInputFrames(e,t){return e*t.sampleRate*(Math.round(14*Math.exp(-4*this.frequencyAudio))+1)}get order(){return 2}get id(){return n.FILTERS_NAMES.SOUNDTOUCH}getSettings(){return{speedAudio:this.speedAudio,frequencyAudio:this.frequencyAudio}}isAudioWorkletEnabled(){return this.configService?this.configService.isSoundtouchAudioWorkletEnabled():n.ENABLE_SOUNDTOUCH_AUDIO_WORKLET}getCurrentPitchShifter(){return this.isOfflineMode?1==this.speedAudio&&1==this.frequencyAudio?null:this.isAudioWorkletEnabled()&&this.currentPitchShifterWorklet&&1==this.speedAudio?this.currentPitchShifterWorklet:this.currentPitchShifter:this.currentPitchShifter}updateState(){const e=this.getCurrentPitchShifter();this.isEnabled()?(e&&(e.pitch=this.frequencyAudio,e.tempo=this.speedAudio),this.currentSpeedAudio=this.speedAudio):(e&&(e.pitch=1,e.tempo=1),this.currentSpeedAudio=1)}setSetting(t,i){return e(this,void 0,void 0,(function*(){if(!r.isSettingValueValid(i))return;const e=parseFloat(i);switch(t){case"speedAudio":this.speedAudio=e;break;case"frequencyAudio":this.frequencyAudio=e}this.updateState()}))}setEnabled(e){super.setEnabled(e),this.updateState()}getSpeed(){return this.currentSpeedAudio}}class H extends l{getNode(e){const t=e.createBiquadFilter();t.type="lowpass",t.frequency.value=2e3;const i=e.createBiquadFilter();i.type="lowpass",i.frequency.value=2e3;const r=e.createBiquadFilter();r.type="highpass",r.frequency.value=500;const s=e.createBiquadFilter();return s.type="highpass",s.frequency.value=500,t.connect(i),i.connect(r),r.connect(s),{input:t,output:s}}get order(){return 7}get id(){return n.FILTERS_NAMES.TELEPHONIZER}getSettings(){return{}}setSetting(t,i){return e(this,void 0,void 0,(function*(){}))}}class K{constructor(e,t,i){this.FILTER_QUALITY=6,this.FOURIER_SIZE=4096,this.WAVETABLEBOOST=40,this.SAWTOOTHBOOST=.4,this.oscillatorType=4,this.oscillatorDetuneValue=0,this.audioContext=null,this.carrierBuffer=null,this.modulatorNode=null,this.vocoding=!1,this.modulatorInput=null,this.carrierInput=null,this.modulatorGain=null,this.modulatorGainValue=1,this.noiseBuffer=null,this.noiseNode=null,this.noiseGain=null,this.noiseGainValue=.2,this.carrierSampleNode=null,this.carrierSampleGain=null,this.carrierSampleGainValue=0,this.oscillatorNode=null,this.oscillatorGain=null,this.oscillatorGainValue=1,this.wavetable=null,this.wavetableSignalGain=null,this.modFilterBands=null,this.modFilterPostGains=null,this.heterodynes=null,this.powers=null,this.lpFilters=null,this.lpFilterPostGains=null,this.carrierBands=null,this.carrierFilterPostGains=null,this.carrierBandGains=null,this.vocoderBands=null,this.numVocoderBands=0,this.hpFilterGain=null,this.outputGain=null,this.audioContext=e,this.carrierBuffer=t,this.modulatorBuffer=i}init(){this.generateVocoderBands(55,7040,28),this.setupVocoderGraph(),this.vocode()}getNodes(){return{modulatorNode:this.modulatorNode,modulatorGain:this.modulatorGain,synthLevel:this.oscillatorGain,noiseNode:this.noiseGain,oscillatorNode:this.oscillatorNode,hpFilterGain:this.hpFilterGain,outputGain:this.outputGain}}shutOffCarrier(){this.oscillatorNode&&this.noiseNode&&this.carrierSampleNode&&(this.oscillatorNode.stop(0),this.oscillatorNode=null,this.noiseNode.stop(0),this.noiseNode=null,this.carrierSampleNode.stop(0),this.carrierSampleNode=null)}selectSawtooth(){this.wavetableSignalGain&&(this.wavetableSignalGain.gain.value=this.SAWTOOTHBOOST),this.oscillatorNode&&(this.oscillatorNode.type="sawtooth")}selectWavetable(){this.wavetableSignalGain&&(this.wavetableSignalGain.gain.value=this.WAVETABLEBOOST),this.oscillatorNode&&this.wavetable&&this.oscillatorNode.setPeriodicWave(this.wavetable),this.wavetableSignalGain&&(this.wavetableSignalGain.gain.value=this.WAVETABLEBOOST)}updateModGain(e){this.modulatorGainValue=e,this.modulatorGain&&(this.modulatorGain.gain.value=e)}updateSampleLevel(e){this.carrierSampleGainValue=e,this.carrierSampleGain&&(this.carrierSampleGain.gain.value=e)}updateSynthLevel(e){this.oscillatorGainValue=e,this.oscillatorGain&&(this.oscillatorGain.gain.value=e)}updateNoiseLevel(e){this.noiseGainValue=e,this.noiseGain&&(this.noiseGain.gain.value=e)}updateDetuneValue(e){this.oscillatorDetuneValue=e,this.oscillatorNode&&(this.oscillatorNode.detune.value=e)}generateVocoderBands(e,t,i){const r=1200*Math.log(t/e)/Math.LN2/i,s=Math.pow(2,r/1200);this.vocoderBands=[];let n=e;for(let e=0;e<i;e++)this.vocoderBands[e]={frequency:n},n*=s;this.numVocoderBands=i}loadNoiseBuffer(){if(!this.audioContext)return;const e=5*this.audioContext.sampleRate;this.noiseBuffer=this.audioContext.createBuffer(1,e,this.audioContext.sampleRate);const t=this.noiseBuffer.getChannelData(0);for(let i=0;i<e;++i)t[i]=2*Math.random()-1}initBandpassFilters(){if(!this.audioContext)return;this.modulatorInput=this.audioContext.createGain(),this.carrierInput=this.audioContext.createGain(),null==this.modFilterBands&&(this.modFilterBands=[]),null==this.modFilterPostGains&&(this.modFilterPostGains=[]),null==this.heterodynes&&(this.heterodynes=[]),null==this.powers&&(this.powers=[]),null==this.lpFilters&&(this.lpFilters=[]),null==this.lpFilterPostGains&&(this.lpFilterPostGains=[]),null==this.carrierBands&&(this.carrierBands=[]),null==this.carrierFilterPostGains&&(this.carrierFilterPostGains=[]),null==this.carrierBandGains&&(this.carrierBandGains=[]);const e=new Float32Array(65536),t=32768;let i;for(let r=0;r<t;++r)i=r/t,e[t+r]=i,e[t-r-1]=i;const r=this.audioContext.createBiquadFilter();r.type="highpass",r.frequency.value=8e3,r.Q.value=1,this.modulatorInput.connect(r),this.hpFilterGain=this.audioContext.createGain(),this.hpFilterGain.gain.value=0,r.connect(this.hpFilterGain),this.modulatorBuffer&&this.hpFilterGain.connect(this.audioContext.destination),this.modFilterBands.length=0,this.modFilterPostGains.length=0,this.heterodynes.length=0,this.powers.length=0,this.lpFilters.length=0,this.lpFilterPostGains.length=0,this.carrierBands.length=0,this.carrierFilterPostGains.length=0,this.carrierBandGains.length=0,this.outputGain=this.audioContext.createGain(),this.modulatorBuffer&&this.outputGain.connect(this.audioContext.destination);const s=new Float32Array(65536);for(let e=-32768;e<32768;e++)s[e+32768]=(e>0?e:-e)/32768;for(let t=0;t<this.numVocoderBands;t++){const i=this.audioContext.createBiquadFilter();i.type="bandpass",this.vocoderBands&&(i.frequency.value=this.vocoderBands[t].frequency),i.Q.value=this.FILTER_QUALITY,this.modulatorInput.connect(i),this.modFilterBands.push(i);const r=this.audioContext.createBiquadFilter();r.type="bandpass",this.vocoderBands&&(r.frequency.value=this.vocoderBands[t].frequency),r.Q.value=this.FILTER_QUALITY,i.connect(r);const n=this.audioContext.createGain();n.gain.value=6,r.connect(n),this.modFilterPostGains.push(n);const o=this.audioContext.createOscillator();this.vocoderBands&&(o.frequency.value=this.vocoderBands[t].frequency),o.start(0);const a=this.audioContext.createGain();n.connect(a),a.gain.value=0,o.connect(a.gain);const h=this.audioContext.createGain();h.gain.value=2,a.connect(h),this.heterodynes.push(h);const u=this.audioContext.createWaveShaper();u.curve=s,h.connect(u);const l=this.audioContext.createBiquadFilter();l.type="lowpass",l.frequency.value=5,l.Q.value=1,this.lpFilters.push(l),u.connect(l);const c=this.audioContext.createGain();c.gain.value=1,l.connect(c),this.lpFilterPostGains.push(c);const d=this.audioContext.createWaveShaper();d.curve=e,c.connect(d);const f=this.audioContext.createBiquadFilter();f.type="bandpass",this.vocoderBands&&(f.frequency.value=this.vocoderBands[t].frequency),f.Q.value=this.FILTER_QUALITY,this.carrierBands.push(f),this.carrierInput.connect(f);const p=this.audioContext.createBiquadFilter();p.type="bandpass",this.vocoderBands&&(p.frequency.value=this.vocoderBands[t].frequency),p.Q.value=this.FILTER_QUALITY,f.connect(p);const m=this.audioContext.createGain();m.gain.value=10,p.connect(m),this.carrierFilterPostGains.push(m);const g=this.audioContext.createGain();this.carrierBandGains.push(g),m.connect(g),g.gain.value=0,d.connect(g.gain),g.connect(this.outputGain)}const n=new Float32Array(this.FOURIER_SIZE),o=new Float32Array(this.FOURIER_SIZE);n[0]=0,o[0]=0;for(let e=1;e<this.FOURIER_SIZE;e++)n[e]=1,o[e]=1;this.wavetable=this.audioContext.createPeriodicWave(n,o),this.loadNoiseBuffer()}setupVocoderGraph(){this.initBandpassFilters()}createCarriersAndPlay(e){this.audioContext&&e&&(this.carrierSampleNode=this.audioContext.createBufferSource(),this.carrierSampleNode.buffer=this.carrierBuffer,this.carrierSampleNode.loop=!0,this.carrierSampleGain=this.audioContext.createGain(),this.carrierSampleGain.gain.value=this.carrierSampleGainValue,this.carrierSampleNode.connect(this.carrierSampleGain),this.carrierSampleGain.connect(e),this.wavetableSignalGain=this.audioContext.createGain(),this.oscillatorNode=this.audioContext.createOscillator(),4==this.oscillatorType&&this.wavetable?(this.oscillatorNode.setPeriodicWave(this.wavetable),this.wavetableSignalGain.gain.value=this.WAVETABLEBOOST):this.wavetableSignalGain.gain.value=this.SAWTOOTHBOOST,this.oscillatorNode.frequency.value=110,this.oscillatorNode.detune.value=this.oscillatorDetuneValue,this.oscillatorNode.connect(this.wavetableSignalGain),this.oscillatorGain=this.audioContext.createGain(),this.oscillatorGain.gain.value=this.oscillatorGainValue,this.wavetableSignalGain.connect(this.oscillatorGain),this.oscillatorGain.connect(e),this.noiseNode=this.audioContext.createBufferSource(),this.noiseNode.buffer=this.noiseBuffer,this.noiseNode.loop=!0,this.noiseGain=this.audioContext.createGain(),this.noiseGain.gain.value=this.noiseGainValue,this.noiseNode.connect(this.noiseGain),this.noiseGain.connect(e),this.oscillatorNode.start(0),this.noiseNode.start(0),this.carrierSampleNode.start(0))}vocode(){if(this.audioContext){if(this.vocoding)return this.modulatorNode&&this.modulatorNode.stop(0),this.shutOffCarrier(),void(this.vocoding=!1);this.createCarriersAndPlay(this.carrierInput),this.vocoding=!0,this.modulatorGain=this.audioContext.createGain(),this.modulatorGain.gain.value=this.modulatorGainValue,this.modulatorBuffer&&(this.modulatorNode=this.audioContext.createBufferSource(),this.modulatorNode.buffer=this.modulatorBuffer,this.modulatorNode.connect(this.modulatorGain),this.modulatorNode.start(0)),this.modulatorInput&&this.modulatorGain.connect(this.modulatorInput)}}}class Y extends l{constructor(){super(...arguments),this.currentVocoder=null,this.modulatorGainValue=1,this.carrierSampleGainValue=0,this.oscillatorGainValue=1,this.noiseGainValue=.2,this.oscillatorDetuneValue=0}getNode(e){var t;const i=null===(t=this.bufferFetcherService)||void 0===t?void 0:t.getAudioBuffer(n.VOCODER_MODULATOR);this.currentVocoder=new K(e,i),this.currentVocoder.init(),this.applyCurrentSettingsToVocoder();const{modulatorGain:r,outputGain:s}=this.currentVocoder.getNodes();return{input:r,output:s}}getSettings(){return{modulatorGainValue:this.modulatorGainValue,carrierSampleGainValue:this.carrierSampleGainValue,oscillatorGainValue:this.oscillatorGainValue,noiseGainValue:this.noiseGainValue,oscillatorDetuneValue:this.oscillatorDetuneValue}}setSetting(t,i){return e(this,void 0,void 0,(function*(){if(r.isSettingValueValid(i)){switch(t){case"modulatorGainValue":this.modulatorGainValue=parseFloat(i);break;case"carrierSampleGainValue":this.carrierSampleGainValue=parseFloat(i);break;case"oscillatorGainValue":this.oscillatorGainValue=parseFloat(i);break;case"noiseGainValue":this.noiseGainValue=parseFloat(i);break;case"oscillatorDetuneValue":this.oscillatorDetuneValue=parseFloat(i)}this.applyCurrentSettingsToVocoder()}}))}applyCurrentSettingsToVocoder(){this.currentVocoder&&(this.currentVocoder.updateModGain(this.modulatorGainValue),this.currentVocoder.updateSampleLevel(this.carrierSampleGainValue),this.currentVocoder.updateSynthLevel(this.oscillatorGainValue),this.currentVocoder.updateNoiseLevel(this.noiseGainValue),this.currentVocoder.updateDetuneValue(this.oscillatorDetuneValue))}get order(){return 1}get id(){return n.FILTERS_NAMES.VOCODER}}class z extends AudioWorkletProcessor{constructor(){super(),this.stopped=!1,this.samplesCount=0,this.port.onmessage=e=>{"stop"==e.data&&this.stop()}}static get parameterDescriptors(){return[]}get defaultParameterDescriptors(){return z.parameterDescriptors}process(e,t){if(this.stopped)return!1;const i=e[0],r=t[0];if(i&&i[0]&&(this.samplesCount+=i[0].length),r){for(let e=0;e<r.length;e++){const t=i[e],s=r[e];if(t)for(let e=0;e<t.length;e++)s[e]=t[e]}this.port.postMessage({command:"update",samplesCount:this.samplesCount})}return!0}stop(){this.stopped=!0}}registerProcessor(n.WORKLET_NAMES.PASSTHROUGH,z);class j extends g{constructor(){super(...arguments),this.currentTime=0,this.lastSampleCount=0,this.samplePerSecond=0,this.currentTimeSamplesPerSecond=0}receiveEvent(e){const t=performance.now(),i=e.data.samplesCount;"update"===e.data.command&&this.calculatePercentageProcessed(t,i),this.calculateRemainingTimeProcessing(t,i)}calculatePercentageProcessed(e,t){0===this.currentTime&&(this.currentTime=e);const r=e-this.currentTime,s=t/this._totalSamples;this.eventEmitter&&r>=n.TREATMENT_TIME_COUNTING_THROTTLE_INTERVAL&&(this.eventEmitter.emit(i.UPDATE_AUDIO_TREATMENT_PERCENT,100*s),this.currentTime=e)}calculateRemainingTimeProcessing(e,t){0===this.currentTimeSamplesPerSecond&&(this.currentTimeSamplesPerSecond=e);const r=e-this.currentTimeSamplesPerSecond,s=this._totalSamples-t;if(this.eventEmitter&&s<=0)this.eventEmitter.emit(i.UPDATE_REMAINING_TIME_ESTIMATED,0);else if(this.eventEmitter&&r>=1e3){this.calculateSmoothedSamplePerSecond(r,t);const n=s/this.samplePerSecond;this.currentTimeSamplesPerSecond=e,this.lastSampleCount=t,isNaN(n)||!isFinite(n)?this.eventEmitter.emit(i.UPDATE_REMAINING_TIME_ESTIMATED,-1):this.eventEmitter.emit(i.UPDATE_REMAINING_TIME_ESTIMATED,n)}}calculateSmoothedSamplePerSecond(e,t){if(e>0){const i=(t-this.lastSampleCount)/(e/1e3);this.samplePerSecond=n.TREATMENT_TIME_COUNTING_SMOOTHING_FACTOR*i+(1-n.TREATMENT_TIME_COUNTING_SMOOTHING_FACTOR)*this.samplePerSecond}}get workletName(){return n.WORKLET_NAMES.PASSTHROUGH}get workletPath(){return n.WORKLET_PATHS.PASSTHROUGH}get order(){return 10}get id(){return n.FILTERS_NAMES.PASSTHROUGH}set totalSamples(e){super.totalSamples=e,this.currentTime=0,this.currentTimeSamplesPerSecond=0,this.samplePerSecond=0,this.lastSampleCount=0}getSettings(){return{}}isEnabled(){return!0}setSetting(t,i){return e(this,void 0,void 0,(function*(){}))}}class Q extends t{constructor(e,t,i,r){super(),this.filters=[],this._entryPointFilter=null,this._currentNodes=null,this.eventEmitter=e||new s,this.configService=r||new h,this.bufferFetcherService=t,this.bufferDecoderService=i,this.setupDefaultFilters()}addFilters(...e){for(const t of e)t.initializeDefaultSettings(),t.bufferFetcherService=this.bufferFetcherService,t.bufferDecoderService=this.bufferDecoderService,t.configService=this.configService,t.eventEmitter=this.eventEmitter;this.filters.push(...e)}setupDefaultFilters(){const e=new c(200,15,200,-2),t=new v(16,.9),i=new S(.2,.75),r=new _(3500),s=new T(3500),n=new b,o=new q,a=new C(0,0,0,3,-.05,.1),h=new H,u=new Y,l=new j;this._entryPointFilter=o,this.addFilters(e,t,i,r,s,n,a,h,o,u,l)}getFiltersState(){const e={};return this.filters.forEach((t=>{e[t.id]=t.isEnabled()})),e}getFiltersSettings(){const e=new Map;for(const t of this.filters)e.set(t.id,t.getSettings());return e}toggleFilter(e){const t=this.filters.find((t=>t.id===e));t&&t.toggle()}changeFilterSettings(t,i){return e(this,void 0,void 0,(function*(){const e=this.filters.find((e=>e.id===t));if(e)for(const t of Object.keys(i))yield e.setSetting(t,i[t])}))}resetFilterSettings(t){return e(this,void 0,void 0,(function*(){const e=this.filters.find((e=>e.id===t));e&&(yield e.resetSettings())}))}resetAllFiltersState(){this.filters.forEach((e=>{e.isDefaultEnabled()?e.enable():e.disable()}))}connectNodes(t,i,r,s){return e(this,void 0,void 0,(function*(){if(!this._entryPointFilter)return;let e=null;if(r&&this._currentNodes)e=this._currentNodes.input;else{const r=yield this._entryPointFilter.getEntrypointNode(t,i,!s);e=r.input}const n=[];let o=e;this.disconnectOldNodes(r);const a=this.filters.sort(((e,t)=>e.order-t.order)).filter(((e,t)=>e!==this._entryPointFilter&&(e.isEnabled()||t>=this.filters.length-1)));for(const e of a){const i=e.getNode(t);o&&o.connect(i.input),o=i.output,n.push(i)}this._entryPointFilter&&this._entryPointFilter.updateState(),this._currentNodes={input:e,output:o,intermediateNodes:n.filter((t=>t.input!=o&&t.output!=o&&t.input!=e&&t.output!=e))}}))}disconnectOldNodes(e){if(this._currentNodes&&(this._currentNodes.input.disconnect(),e||this._currentNodes.output.disconnect(),this._currentNodes.intermediateNodes))for(const e of this._currentNodes.intermediateNodes)e.input.disconnect(),e.output.disconnect()}initializeWorklets(t){return e(this,void 0,void 0,(function*(){for(const e of this.filters)e.isWorklet()&&(yield e.initializeWorklet(t))}))}getAddingTime(){let e=0;for(const t of this.filters)t.isEnabled()&&(e+=t.getAddingTime());return e}setupTotalSamples(e,t){if(t){const i=e*t.sampleRate;for(const e of this.filters)e.totalSamples=i}}resetFilterBuffers(){return e(this,void 0,void 0,(function*(){for(const e of this.filters)yield e.bufferFetcherReseted()}))}get entrypointFilter(){return this._entryPointFilter}get currentNodes(){return this._currentNodes}get order(){return-1}get id(){return n.FILTER_MANAGER}}class X extends t{constructor(e,t,i){super(),this.previousSampleRate=n.DEFAULT_SAMPLE_RATE,this._currentContext=e,this.eventEmitter=i||new s,this.configService=t,this.setup()}setup(){this.configService&&(this.previousSampleRate=this.configService.getSampleRate(),this.eventEmitter&&this.eventEmitter.emit(i.SAMPLE_RATE_CHANGED,this.previousSampleRate)),this.currentContext||this.createNewContext(this.previousSampleRate)}createNewContextIfNeeded(e){if(this.configService&&this.configService.isCompatibilityModeEnabled()&&e){if(this.currentSampleRate!=e.sampleRate)return this.createNewContext(e.sampleRate),this.previousSampleRate=e.sampleRate,!0}else{let e=n.DEFAULT_SAMPLE_RATE;if(this.configService&&(e=this.configService.getSampleRate()),e!=this.previousSampleRate)return this.createNewContext(e),this.previousSampleRate=e,!0}return!1}createNewContext(e){this._currentContext&&(this.oldAudioContext=this._currentContext,this.destroyOldContext());const t={latencyHint:"interactive"};0!=e&&(t.sampleRate=e),this._currentContext=new AudioContext(t),this.eventEmitter&&this.eventEmitter.emit(i.SAMPLE_RATE_CHANGED,this.currentSampleRate)}destroyOldContext(){this.oldAudioContext&&(this.oldAudioContext.close(),this.oldAudioContext=null)}get currentSampleRate(){return this.currentContext?this.currentContext.sampleRate:0}get currentContext(){return this._currentContext}get order(){return-1}get id(){return n.AUDIO_CONTEXT_MANAGER}}function Z(e){return new Worker((e||"")+"RecorderWorker.js")}class ${constructor(e){this.worker=null,this.node=null,this.context=null,this.config={bufferLen:4096,sampleRate:44100,numChannels:2,mimeType:"audio/wav",workletBasePath:"worklets/",workerBasePath:"workers/",bitrate:n.DEFAULT_MP3_BITRATE,callback:()=>{}},this.callbacks={getBuffer:[],exportWAV:[],exportMP3:[]},this.recording=!1,Object.assign(this.config,e)}setup(t){return e(this,void 0,void 0,(function*(){this.node&&(this.node instanceof AudioWorkletNode&&this.node.port.postMessage("stop"),this.node.disconnect()),t&&(this.context=t.context,yield this.createRecorderNode(),this.node&&this.context&&(t.connect(this.node),this.node.connect(this.context.destination))),this.context&&!this.worker&&(this.worker=Z(this.config.workerBasePath),this.worker&&(this.worker.postMessage({command:"init",config:{sampleRate:this.context.sampleRate,numChannels:this.config.numChannels,bitrate:this.config.bitrate}}),this.worker.onmessage=e=>{let t=null;switch(e.data.command){case"getBuffer":t=this.callbacks.getBuffer;break;case n.EXPORT_WAV_COMMAND:t=this.callbacks.exportWAV;break;case n.EXPORT_MP3_COMMAND:t=this.callbacks.exportMP3}if(t){const i=t.pop();"function"==typeof i&&i(e.data.data)}}))}))}createRecorderNode(){return e(this,void 0,void 0,(function*(){if(this.context)if(r.isAudioWorkletCompatible(this.context)&&n.ENABLE_RECORDER_AUDIO_WORKLET)try{yield this.createRecorderWorklet()}catch(e){this.createRecorderScriptProcessorNode()}else this.createRecorderScriptProcessorNode()}))}createRecorderWorklet(){return e(this,void 0,void 0,(function*(){if(this.context&&(yield this.context.audioWorklet.addModule(this.config.workletBasePath+n.WORKLET_PATHS.RECORDER_WORKLET),this.node=new AudioWorkletNode(this.context,n.WORKLET_NAMES.RECORDER_WORKLET),this.node&&this.node.port)){const e=this.node.parameters.get("numChannels");e&&(e.value=this.config.numChannels,e.setValueAtTime(this.config.numChannels,0)),this.node.port.onmessage=e=>{this.worker&&"record"==e.data.command&&e.data.buffer.length>0&&this.worker.postMessage({command:"record",buffer:e.data.buffer})}}}))}createRecorderScriptProcessorNode(){this.context&&(this.node=this.context.createScriptProcessor.call(this.context,this.config.bufferLen,this.config.numChannels,this.config.numChannels),this.node.onaudioprocess=e=>{if(!this.recording)return;const t=[];for(let i=0;i<this.config.numChannels;i++)t.push(e.inputBuffer.getChannelData(i));this.worker&&this.worker.postMessage({command:"record",buffer:t})})}record(){this.recording=!0,this.node instanceof AudioWorkletNode&&this.node.port.postMessage("record")}stop(){this.recording=!1,this.node instanceof AudioWorkletNode&&this.node.port.postMessage("stop")}clear(){this.worker&&this.worker.postMessage({command:"clear"})}kill(){this.clear(),this.stop(),this.worker&&this.worker.terminate()}getBuffer(e){if(!(e=e||this.config.callback))throw new Error("Callback not set");this.callbacks.getBuffer.push(e),this.worker&&this.worker.postMessage({command:"getBuffer"})}exportWAV(e,t){if(t=t||this.config.mimeType,!(e=e||this.config.callback))throw new Error("Callback not set");this.callbacks.exportWAV.push(e),this.worker&&this.worker.postMessage({command:n.EXPORT_WAV_COMMAND,type:t})}exportMP3(e,t){if(t=t||this.config.mimeType,!(e=e||this.config.callback))throw new Error("Callback not set");this.callbacks.exportMP3.push(e),this.worker&&this.worker.postMessage({command:n.EXPORT_MP3_COMMAND,type:t})}static forceDownload(e,t){const i=window.document.createElement("a"),r=(window.URL||window.webkitURL).createObjectURL(e);window.document.body.appendChild(i),i.href=r,i.download=t||"output.wav",i.click(),window.URL.revokeObjectURL(r)}}class J extends t{constructor(e,t,i,r){super(),this.savingBuffer=!1,this.playingStoppedCallback=null,this.contextManager=e,this.eventEmitter=i||new s,this.bufferPlayer=r,this.configService=t,this.setup()}setup(){this.bufferPlayer&&this.bufferPlayer.on(i.PLAYING_FINISHED,(()=>{this.savingBuffer&&this.playingStoppedCallback&&this.eventEmitter&&this.eventEmitter.off(i.PLAYING_STOPPED,this.playingStoppedCallback)}))}saveBuffer(t,i){return e(this,void 0,void 0,(function*(){if(this.savingBuffer)throw new Error("The buffer is currently saving");if(!this.bufferPlayer)throw new Error("No buffer player was found");this.savingBuffer=!0;let e=!1;return e=this.bufferPlayer.compatibilityMode?yield this.saveBufferCompatibilityMode(i):yield this.saveBufferDirect(t,i),this.savingBuffer=!1,e}))}saveBufferDirect(e,t){return new Promise(((i,r)=>{var s;if(!e||this.contextManager&&!this.contextManager.currentContext)return r("No rendered buffer or AudioContext not initialized");const o=Z(null===(s=this.configService)||void 0===s?void 0:s.getWorkerBasePath());if(o){const r=[];for(let t=0;t<e.numberOfChannels;t++)r.push(e.getChannelData(t));o.onmessage=e=>{e.data.command!=n.EXPORT_WAV_COMMAND&&e.data.command!=n.EXPORT_MP3_COMMAND||this.downloadAudioBlob(e.data.data,t),o.terminate(),this.savingBuffer=!1,i(!0)},o.postMessage({command:n.INIT_COMMAND,config:{sampleRate:e.sampleRate,numChannels:2,bitrate:(null==t?void 0:t.bitrate)||n.DEFAULT_MP3_BITRATE}}),o.postMessage({command:n.RECORD_COMMAND,buffer:r}),o.postMessage({command:"mp3"===(null==t?void 0:t.format)||"mp3"===n.DEFAULT_SAVE_FORMAT?n.EXPORT_MP3_COMMAND:n.EXPORT_WAV_COMMAND,type:n.AUDIO_WAV})}}))}saveBufferCompatibilityMode(e){return new Promise(((t,r)=>{if(!this.bufferPlayer)return r("No buffer player found");this.bufferPlayer.start().then((()=>{if(!this.configService)return r("No config service found");if(!this.filterManager)return r("No filter manager found");const s=new $({bufferLen:this.configService.getBufferSize(),sampleRate:this.configService.getSampleRate(),numChannels:2,workletBasePath:this.configService.getWorkletBasePath(),workerBasePath:this.configService.getWorkerBasePath(),mimeType:"mp3"==(null==e?void 0:e.format)?n.AUDIO_MP3:n.AUDIO_WAV,bitrate:(null==e?void 0:e.bitrate)||n.DEFAULT_MP3_BITRATE});s.setup(this.filterManager.currentNodes.output).then((()=>{s.record(),this.playingStoppedCallback=()=>{s.kill(),this.savingBuffer=!1,this.eventEmitter&&(this.eventEmitter.off(i.PLAYING_FINISHED,r),this.playingStoppedCallback&&this.eventEmitter.off(i.PLAYING_STOPPED,this.playingStoppedCallback)),t(!0)};const r=()=>{this.playingStoppedCallback&&this.eventEmitter&&this.eventEmitter.off(i.PLAYING_STOPPED,this.playingStoppedCallback),s.stop();const o=n=>{this.downloadAudioBlob(n,e),this.savingBuffer=!1,this.eventEmitter&&this.eventEmitter.off(i.PLAYING_FINISHED,r),s.kill(),t(!0)};"mp3"===(null==e?void 0:e.format)||"mp3"===n.DEFAULT_SAVE_FORMAT?s.exportMP3(o):s.exportWAV(o)};this.eventEmitter&&(this.eventEmitter.on(i.PLAYING_FINISHED,r),this.eventEmitter.on(i.PLAYING_STOPPED,this.playingStoppedCallback))}))}))}))}downloadAudioBlob(e,t){$.forceDownload(e,"audio-"+(new Date).toISOString()+"."+((null==t?void 0:t.format)||n.DEFAULT_SAVE_FORMAT))}get order(){return-1}get id(){return n.SAVE_BUFFER_MANAGER}}class ee extends t{constructor(e,t,i,r,n,o,a){super(),this._renderedBuffer=null,this.audioRenderingLastCanceled=!1,this.initialRenderingDone=!1,this.sumPrincipalBuffer=0,this.contextManager=e,this.eventEmitter=i||new s,this.bufferPlayer=r,this.configService=t,this.filterManager=n,this.rendererManager=o,this.bufferManager=a}prepareContext(t){return e(this,void 0,void 0,(function*(){if(this.contextManager){this.contextManager.createNewContextIfNeeded(t)&&this.bufferManager&&(yield this.bufferManager.resetBufferFetcher()),this.contextManager.currentContext&&this.contextManager.currentContext.resume()}}))}renderAudio(t){return e(this,void 0,void 0,(function*(){if(yield this.prepareContext(t),!this.contextManager||!this.contextManager.currentContext)throw new Error("AudioContext is not yet available");if(!this.filterManager)throw new Error("Filter manager is not available");if(!this.rendererManager)throw new Error("Renderer manager is not available");if(!this.filterManager.entrypointFilter)throw new Error("Entrypoint filter is not available");if(!t)throw new Error("No principal buffer available");if(!this.initialRenderingDone&&this.configService&&this.configService.isInitialRenderingDisabled()&&!this.configService.isCompatibilityModeEnabled())return this.loadInitialBuffer(t),this.initialRenderingDone=!0,!0;this.configService&&this.bufferPlayer&&!this.configService.isCompatibilityModeEnabled()&&this.bufferPlayer.compatibilityMode&&this.bufferPlayer.stop();const e=this.filterManager.entrypointFilter.getSpeed(),i=r.calculateAudioDuration(t,this.filterManager,e),s=new OfflineAudioContext(2,this.contextManager.currentContext.sampleRate*i,this.contextManager.currentContext.sampleRate),n=this.configService&&this.configService.isCompatibilityModeEnabled()?this.contextManager.currentContext:s;return this._renderedBuffer=yield this.rendererManager.executeAudioRenderers(t,n),this.currentOfflineContext=null,this.audioRenderingLastCanceled=!1,r.resetAudioRenderingProgress(this.eventEmitter),this.filterManager.setupTotalSamples(i,this.contextManager.currentContext),yield this.setupOutput(t,n,i,s)}))}setupPlayerSpeed(e){if(this.filterManager&&this.filterManager.entrypointFilter){const t=this.filterManager.entrypointFilter.getSpeed();e.speedAudio=t}}setupOutput(t,r,s,n){return e(this,void 0,void 0,(function*(){if(this._renderedBuffer&&this.configService&&this.eventEmitter&&this.bufferPlayer&&this.filterManager){if(yield this.filterManager.initializeWorklets(r),yield this.filterManager.connectNodes(r,this._renderedBuffer,!1,this.configService.isCompatibilityModeEnabled()),this.setupPlayerSpeed(this.bufferPlayer),!this.configService.isCompatibilityModeEnabled()&&n&&this.filterManager.currentNodes){this.currentOfflineContext=n,this.filterManager.currentNodes.output.connect(r.destination);const e=yield n.startRendering();if(this.contextManager&&!this.loadRenderedAudio(t,e))return yield this.setupOutput(t,this.contextManager.currentContext,s);if(this.audioRenderingLastCanceled)return!1;this.eventEmitter.emit(i.OFFLINE_AUDIO_RENDERING_FINISHED)}else this.bufferPlayer.setCompatibilityMode(this.filterManager.currentNodes.output,s),this.initialRenderingDone=!0;return this.eventEmitter.emit(i.AUDIO_RENDERING_FINISHED),!0}return!1}))}loadRenderedAudio(e,t){if(this.eventEmitter&&this.bufferPlayer){if(this.audioRenderingLastCanceled)this.initialRenderingDone||(this.loadInitialBuffer(e),this.eventEmitter.emit(i.CANCELLED_AND_LOADED_INITIAL_AUDIO));else{if(0==r.sumAudioBuffer(t)&&0!==this.sumPrincipalBuffer){if(this.configService&&!this.configService.isCompatibilityModeChecked())return this.setCompatibilityModeChecked(!0),this.configService.enableCompatibilityMode(),this.eventEmitter.emit(i.COMPATIBILITY_MODE_AUTO_ENABLED),!1;this.eventEmitter.emit(i.RENDERING_AUDIO_PROBLEM_DETECTED)}this._renderedBuffer=t,this.bufferPlayer.loadBuffer(this._renderedBuffer)}this.initialRenderingDone=!0}return!0}loadInitialBuffer(e){this.bufferPlayer&&(this._renderedBuffer=e,this.bufferPlayer.loadBuffer(e))}cancelAudioRendering(){this.currentOfflineContext&&!this.audioRenderingLastCanceled&&this.filterManager&&(this.audioRenderingLastCanceled=!0,this.filterManager.disconnectOldNodes(!1),this.eventEmitter&&this.eventEmitter.emit(i.CANCELLING_AUDIO_PROCESSING))}setCompatibilityModeChecked(e){this.configService&&this.configService.setConfig(n.PREFERENCES_KEYS.COMPATIBILITY_MODE_CHECKED,""+e)}get renderedBuffer(){return this._renderedBuffer}get order(){return-1}get id(){return n.AUDIO_PROCESSOR}}class te extends t{constructor(e,t,i,r){super(),this.downloadingInitialData=!1,this.audioBuffersToFetch=[],this.bufferFetcherService=e,this.eventEmitter=i||new s,this.filterManager=t,this.filterManager=t,this.audioBuffersToFetch=r,this.setup()}setup(){this.audioBuffersToFetch.length>0&&this.fetchBuffers(!1)}fetchBuffers(t){return e(this,void 0,void 0,(function*(){if(!this.downloadingInitialData&&this.bufferFetcherService){this.downloadingInitialData=!0,this.eventEmitter&&!t&&this.eventEmitter.emit(i.LOADING_BUFFERS);try{yield this.bufferFetcherService.fetchAllBuffers(this.audioBuffersToFetch),this.downloadingInitialData=!1,this.eventEmitter&&!t&&this.eventEmitter.emit(i.LOADED_BUFFERS)}catch(e){this.eventEmitter&&!t&&this.eventEmitter.emit(i.LOADING_BUFFERS_ERROR)}}}))}resetBufferFetcher(){return e(this,void 0,void 0,(function*(){this.bufferFetcherService&&(this.bufferFetcherService.reset(),yield this.fetchBuffers(!0),this.filterManager&&(yield this.filterManager.resetFilterBuffers()))}))}get order(){return-1}get id(){return n.BUFFER_MANAGER}}class ie extends t{}class re extends ie{renderAudio(e,t){return new Promise((i=>{const r=t.numberOfChannels,s=e.sampleRate*t.duration+2*e.sampleRate,n=e.createBuffer(r,s,e.sampleRate);for(let e=0;e<r;e++){const i=n.getChannelData(e),r=t.getChannelData(e);for(let e=0;e<s;e++)e<r.length?i[e]=r[r.length-1-e]:i[e]=0}i(n)}))}get order(){return 0}get id(){return n.FILTERS_NAMES.RETURN_AUDIO}}class se extends t{constructor(e,t,i,r){super(),this.renderers=[],this.eventEmitter=e||new s,this.configService=r||new h,this.bufferFetcherService=t,this.bufferDecoderService=i,this.setupDefaultRenderers()}addRenderers(...e){for(const t of e)t.bufferFetcherService=this.bufferFetcherService,t.bufferDecoderService=this.bufferDecoderService,t.configService=this.configService;this.renderers.push(...e)}setupDefaultRenderers(){const e=new re;this.addRenderers(e)}getRenderersState(){const e={};return this.renderers.forEach((t=>{e[t.id]=t.isEnabled()})),e}toggleRenderer(e){const t=this.renderers.find((t=>t.id===e));t&&t.toggle()}resetAllRenderersState(){this.renderers.forEach((e=>{e.isDefaultEnabled()?e.enable():e.disable()}))}executeAudioRenderers(t,i){return e(this,void 0,void 0,(function*(){let e=t;for(const t of this.renderers.sort(((e,t)=>e.order-t.order)))t.isEnabled()&&(e=yield t.renderAudio(i,e));return e}))}get order(){return-1}get id(){return n.RENDERER_MANAGER}}class ne extends t{constructor(e,t,i,r,n){super(),this.principalBuffer=null,this.eventEmitter=i||new s,this.configService=r||new h,this.contextManager=new X(e,this.configService,this.eventEmitter),this.bufferPlayer=t||new o(this.contextManager,this.eventEmitter),this.bufferFetcherService=new a(this.contextManager,this.configService,this.eventEmitter),this.bufferDecoderService=new u(this.contextManager,this.eventEmitter),this.filterManager=new Q(this.eventEmitter,this.bufferFetcherService,this.bufferDecoderService,this.configService),this.rendererManager=new se(this.eventEmitter,this.bufferFetcherService,this.bufferDecoderService,this.configService),this.saveBufferManager=new J(this.contextManager,this.configService,this.eventEmitter,this.bufferPlayer),this.bufferManager=new te(this.bufferFetcherService,this.filterManager,this.eventEmitter,n||[]),this.audioProcessor=new ee(this.contextManager,this.configService,this.eventEmitter,this.bufferPlayer,this.filterManager,this.rendererManager,this.bufferManager),this.setup()}setup(){this.bufferPlayer&&(this.bufferPlayer.onBeforePlaying((()=>e(this,void 0,void 0,(function*(){this.bufferPlayer&&this.bufferPlayer.compatibilityMode&&this.contextManager&&this.contextManager.currentContext&&this.audioProcessor&&(yield this.audioProcessor.setupOutput(this.principalBuffer,this.contextManager.currentContext))})))),this.bufferPlayer.on(i.PLAYING_FINISHED,(()=>{this.bufferPlayer&&this.bufferPlayer.loop&&this.bufferPlayer.start()})),this.bufferPlayer.contextManager=this.contextManager)}addFilters(...e){this.filterManager&&this.filterManager.addFilters(...e)}addRenderers(...e){this.rendererManager&&this.rendererManager.addRenderers(...e)}get currentSampleRate(){return this.contextManager?this.contextManager.currentSampleRate:0}get defaultDeviceSampleRate(){const e=new AudioContext;let t=0;return e&&(t=e.sampleRate,e.close()),t}loadBufferFromFile(t){return e(this,void 0,void 0,(function*(){if(this.principalBuffer=null,this.audioProcessor&&(yield this.audioProcessor.prepareContext(this.principalBuffer)),!(this.contextManager&&this.contextManager.currentContext&&this.bufferDecoderService&&this.audioProcessor))throw new Error("Audio Context is not ready!");if(this.principalBuffer=yield this.bufferDecoderService.decodeBufferFromFile(t),this.audioProcessor.initialRenderingDone=!1,!this.principalBuffer)throw new Error("Error decoding audio file");this.audioProcessor.sumPrincipalBuffer=r.sumAudioBuffer(this.principalBuffer),r.resetAudioRenderingProgress(this.eventEmitter)}))}loadBuffer(e){this.principalBuffer=e,this.audioProcessor&&(this.audioProcessor.sumPrincipalBuffer=r.sumAudioBuffer(this.principalBuffer),this.audioProcessor.initialRenderingDone=!1)}getOutputBuffer(){return this.audioProcessor?this.audioProcessor.renderedBuffer:null}renderAudio(){return e(this,void 0,void 0,(function*(){return!!this.audioProcessor&&(yield this.audioProcessor.renderAudio(this.principalBuffer))}))}isAudioWorkletAvailable(){return!(!this.contextManager||!this.contextManager.currentContext)&&r.isAudioWorkletCompatible(this.contextManager.currentContext)}getFiltersState(){return this.filterManager&&this.rendererManager?Object.assign(Object.assign({},this.filterManager.getFiltersState()),this.rendererManager.getRenderersState()):{}}getFiltersSettings(){return this.filterManager?this.filterManager.getFiltersSettings():new Map}reconnectNodesIfNeeded(){return e(this,void 0,void 0,(function*(){if(this.contextManager&&this.bufferPlayer&&this.bufferPlayer.compatibilityMode&&this.contextManager.currentContext&&this.principalBuffer&&this.filterManager&&this.filterManager.entrypointFilter){yield this.filterManager.connectNodes(this.contextManager.currentContext,this.principalBuffer,!0,this.bufferPlayer.compatibilityMode);const e=this.filterManager.entrypointFilter.getSpeed();this.bufferPlayer.speedAudio=e,this.bufferPlayer.duration=r.calculateAudioDuration(this.principalBuffer,this.filterManager,e)*e}}))}toggleFilter(e){this.rendererManager&&this.rendererManager.toggleRenderer(e),this.filterManager&&(this.filterManager.toggleFilter(e),this.reconnectNodesIfNeeded())}changeFilterSettings(t,i){return e(this,void 0,void 0,(function*(){this.filterManager&&(yield this.filterManager.changeFilterSettings(t,i),yield this.reconnectNodesIfNeeded())}))}resetFilterSettings(t){return e(this,void 0,void 0,(function*(){this.filterManager&&(yield this.filterManager.resetFilterSettings(t),yield this.reconnectNodesIfNeeded())}))}resetAllFiltersState(){this.rendererManager&&this.rendererManager.resetAllRenderersState(),this.filterManager&&(this.filterManager.resetAllFiltersState(),this.reconnectNodesIfNeeded())}exit(){this.bufferPlayer&&(this.bufferPlayer.stop(),this.bufferPlayer.reset()),this.cancelAudioRendering(),this.principalBuffer=null}cancelAudioRendering(){this.audioProcessor&&this.audioProcessor.cancelAudioRendering()}on(e,t){this.eventEmitter&&this.eventEmitter.on(e,t)}off(e,t){this.eventEmitter&&this.eventEmitter.off(e,t)}saveBuffer(t){return e(this,void 0,void 0,(function*(){var e;return!(!this.saveBufferManager||!this.audioProcessor)&&(yield null===(e=this.saveBufferManager)||void 0===e?void 0:e.saveBuffer(this.audioProcessor.renderedBuffer,t))}))}set downloadingInitialData(e){this.bufferManager&&(this.bufferManager.downloadingInitialData=e)}get downloadingInitialData(){return!!this.bufferManager&&this.bufferManager.downloadingInitialData}get order(){return-1}get id(){return n.AUDIO_EDITOR}}class oe{constructor(e,t){this.seconds=0,this.initialSeconds=0,this.interval=null,this.incr=1,this.countCallback=()=>{},this.seconds=e,this.initialSeconds=e,this.interval,this.incr=t}start(){this.interval=window.setInterval((()=>this.count()),1e3)}stop(){clearInterval(this.interval)}count(){this.seconds+=this.incr,this.seconds<=0&&this.stop(),this.countCallback&&this.countCallback()}onCount(e){this.countCallback=e}}class ae extends t{constructor(e,t,i){super(),this.input=null,this.stream=null,this.recorder=null,this.alreadyInit=!1,this.timer=null,this.enableAudioFeedback=!1,this.recording=!1,this.deviceList=[],this.constraints={audio:{noiseSuppression:!0,echoCancellation:!0,autoGainControl:!0,sampleRate:{ideal:44100}}},this.eventEmitter=null,this.previousSampleRate=n.DEFAULT_SAMPLE_RATE,this.sampleRateConfigNotSupported=!1,this.context=e,this.eventEmitter=t||new s,this.configService=i||null,this.configService&&(this.previousSampleRate=this.configService.getSampleRate())}init(){return e(this,void 0,void 0,(function*(){var e;if(this.isRecordingAvailable()){this.sampleRateConfigNotSupported=!navigator.mediaDevices.getSupportedConstraints().sampleRate,this.context?yield this.createNewContextIfNeeded():yield this.createNewContext(this.previousSampleRate),null===(e=this.eventEmitter)||void 0===e||e.emit(i.RECORDER_INIT);try{const e=yield navigator.mediaDevices.getUserMedia(this.constraints);this.context&&this.context.resume(),yield this.setup(e,!1,!1),this.alreadyInit=!0,this.timer=new oe(0,1),this.timer.onCount((()=>{var e;null===(e=this.eventEmitter)||void 0===e||e.emit(i.RECORDER_COUNT_UPDATE)})),this.successCallback()}catch(e){console.error(e);if(e)switch(e.name){case"SecurityError":case"NotAllowedError":this.errorCallback();break;case"NotFoundError":this.notFoundErrorCallback();break;case"NotSupportedError":this.sampleRateConfigNotSupported||(this.previousSampleRate=0,this.sampleRateConfigNotSupported=!0,this.init());break;default:this.unknownErrorCallback()}}navigator.mediaDevices.ondevicechange=()=>this.updateInputList()}}))}createNewContextIfNeeded(){return e(this,void 0,void 0,(function*(){let e=n.DEFAULT_SAMPLE_RATE;this.configService&&(e=this.configService.getSampleRate()),e!=this.previousSampleRate&&(yield this.createNewContext(e),this.previousSampleRate=e)}))}createNewContext(t){return e(this,void 0,void 0,(function*(){this.context&&(yield this.context.close());const e={latencyHint:"balanced"};0==t||this.sampleRateConfigNotSupported||(e.sampleRate=t),this.context=new AudioContext(e),this.constraints.audio.sampleRate={ideal:this.context.sampleRate}}))}successCallback(){var e;null===(e=this.eventEmitter)||void 0===e||e.emit(i.RECORDER_SUCCESS)}errorCallback(){var e;null===(e=this.eventEmitter)||void 0===e||e.emit(i.RECORDER_ERROR)}notFoundErrorCallback(){var e;null===(e=this.eventEmitter)||void 0===e||e.emit(i.RECORDER_NOT_FOUND_ERROR)}unknownErrorCallback(){var e;null===(e=this.eventEmitter)||void 0===e||e.emit(i.RECORDER_UNKNOWN_ERROR)}audioFeedback(e){var t;this.context&&(e?(this.input&&this.input.connect(this.context.destination),this.enableAudioFeedback=!0):(this.input&&this.input.connect(this.context.destination)&&this.input.disconnect(this.context.destination),this.enableAudioFeedback=!1),null===(t=this.eventEmitter)||void 0===t||t.emit(i.RECORDER_UPDATE_CONSTRAINTS))}getConstraints(){if(this.stream){const e=this.stream.getTracks();if(e&&e.length>0)return e[0].getSettings()}return null}updateConstraints(){var e;const t=this.getConstraints();t&&(this.constraints.audio=Object.assign(this.constraints.audio,t),null===(e=this.eventEmitter)||void 0===e||e.emit(i.RECORDER_UPDATE_CONSTRAINTS))}resetConstraints(t){return e(this,void 0,void 0,(function*(){if(this.stream){const e=this.enableAudioFeedback,i=this.recording,r=this.stream.getTracks();if(t&&(this.updateConstraints(),this.constraints.audio=Object.assign(this.constraints.audio,t.audio)),r&&r.length>0)try{yield r[0].applyConstraints(this.constraints.audio);const s=this.getConstraints(),n=t?Object.keys(t.audio)[0]:"";if(this.audioFeedback(!1),this.pause(),!t||s&&s[n]!=t.audio[n]){this.stopStream();const t=yield navigator.mediaDevices.getUserMedia(this.constraints);yield this.setup(t,i,e)}else yield this.setup(null,i,e)}catch(e){this.errorCallback()}}}))}setup(t,i,r){return e(this,void 0,void 0,(function*(){t&&this.context&&(this.input=this.context.createMediaStreamSource(t),this.stream=t),this.recorder&&this.input&&(yield this.recorder.setup(this.input),i&&(yield this.record())),this.audioFeedback(r),this.updateConstraints(),yield this.updateInputList()}))}setNoiseSuppression(e){this.resetConstraints({audio:{noiseSuppression:e}})}setAutoGain(e){this.resetConstraints({audio:{autoGainControl:e}})}setEchoCancellation(e){this.resetConstraints({audio:{echoCancellation:e}})}updateInputList(){return e(this,void 0,void 0,(function*(){if(this.deviceList){const e=yield navigator.mediaDevices.enumerateDevices();this.deviceList=[],e.forEach((e=>{"audioinput"==e.kind&&this.deviceList.push(e)}))}}))}changeInput(e,t){t&&(this.constraints.audio.deviceId=e,this.constraints.audio.groupId=t,this.resetConstraints())}record(){return e(this,void 0,void 0,(function*(){this.alreadyInit&&this.configService&&this.input&&(this.recorder||(this.recorder=new $({bufferLen:this.configService.getBufferSize(),sampleRate:this.configService.getSampleRate(),numChannels:2,workletBasePath:this.configService.getWorkletBasePath(),workerBasePath:this.configService.getWorkerBasePath(),mimeType:"audio/wav"}),yield this.recorder.setup(this.input)),this.recorder&&this.recorder.record(),this.timer&&this.timer.start(),this.recording=!0,this.eventEmitter&&this.eventEmitter.emit(i.RECORDER_RECORDING))}))}stop(){return e(this,void 0,void 0,(function*(){this.alreadyInit&&this.recorder&&(this.recorder.stop(),this.timer&&this.timer.stop(),this.recording=!1,this.recorder.getBuffer((e=>{var t;if(this.context){this.context.resume();const r=this.context.createBuffer(2,e[0].length,this.context.sampleRate);r.getChannelData(0).set(e[0]),r.getChannelData(1).set(e[1]),null===(t=this.eventEmitter)||void 0===t||t.emit(i.RECORDER_STOPPED,r),this.reset()}})))}))}pause(){var e;this.alreadyInit&&(this.recorder&&this.recorder.stop(),this.timer&&this.timer.stop(),this.recording=!1,null===(e=this.eventEmitter)||void 0===e||e.emit(i.RECORDER_PAUSED))}stopStream(){if(this.stream){const e=this.stream.getTracks();for(let t=0,i=e.length;t<i;t++)e[t].stop()}}reset(){var e;this.recorder&&this.recorder.kill(),this.timer&&this.timer.stop(),this.audioFeedback(!1),this.stopStream(),this.input=null,this.recorder=null,this.stream=null,this.alreadyInit=!1,this.timer=null,null===(e=this.eventEmitter)||void 0===e||e.emit(i.RECORDER_RESETED)}get currentTimeDisplay(){var e,t,i;return(null===(e=this.timer)||void 0===e?void 0:e.seconds)?("0"+Math.trunc((null===(t=this.timer)||void 0===t?void 0:t.seconds)/60)).slice(-2)+":"+("0"+Math.trunc((null===(i=this.timer)||void 0===i?void 0:i.seconds)%60)).slice(-2):"00:00"}get currentTime(){return this.timer?this.timer.seconds:0}getSettings(){return{deviceList:this.deviceList,audioFeedback:this.enableAudioFeedback,constraints:this.constraints.audio}}on(e,t){var i;null===(i=this.eventEmitter)||void 0===i||i.on(e,t)}isRecordingAvailable(){return void 0!==navigator.mediaDevices&&void 0!==navigator.mediaDevices.getUserMedia}get order(){return-1}get id(){throw n.VOICE_RECORDER}}export{t as AbstractAudioElement,l as AbstractAudioFilter,g as AbstractAudioFilterWorklet,ie as AbstractAudioRenderer,ne as AudioEditor,o as BufferPlayer,n as Constants,s as EventEmitter,i as EventType,h as GenericConfigService,r as UtilFunctions,ae as VoiceRecorder};
//# sourceMappingURL=SimpleSoundStudioLibrary.js.map
