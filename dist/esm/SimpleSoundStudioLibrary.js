function e(e,t,i,r){var n,s=arguments.length,o=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(o=(s<3?n(o):s>3?n(t,i,o):n(t,i))||o);return s>3&&o&&Object.defineProperty(t,i,o),o}function t(e,t){return function(i,r){t(i,r,e)}}function i(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function r(e,t,i,r){return new(i||(i=Promise))((function(n,s){function o(e){try{u(r.next(e))}catch(e){s(e)}}function a(e){try{u(r.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((r=r.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;var n,s="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},o={};function a(e){return("object"==typeof e&&null!==e||"function"==typeof e)&&"function"==typeof e.then}function u(e){switch(typeof e){case"string":case"symbol":return e.toString();case"function":return e.name;default:throw new Error(`Unexpected ${typeof e} service id type`)}}!function(){return n||(n=1,function(e){!function(){var t="object"==typeof globalThis?globalThis:"object"==typeof s?s:"object"==typeof self?self:"object"==typeof this?this:function(){try{return Function("return this;")()}catch(e){}}()||function(){try{return(0,eval)("(function() { return this; })()")}catch(e){}}(),i=r(e);function r(e,t){return function(i,r){Object.defineProperty(e,i,{configurable:!0,writable:!0,value:r}),t&&t(i,r)}}void 0!==t.Reflect&&(i=r(t.Reflect,i)),function(e,t){var i=Object.prototype.hasOwnProperty,r="function"==typeof Symbol,n=r&&void 0!==Symbol.toPrimitive?Symbol.toPrimitive:"@@toPrimitive",s=r&&void 0!==Symbol.iterator?Symbol.iterator:"@@iterator",o="function"==typeof Object.create,a={__proto__:[]}instanceof Array,u=!o&&!a,c={create:o?function(){return le(Object.create(null))}:a?function(){return le({__proto__:null})}:function(){return le({})},has:u?function(e,t){return i.call(e,t)}:function(e,t){return t in e},get:u?function(e,t){return i.call(e,t)?e[t]:void 0}:function(e,t){return e[t]}},h=Object.getPrototypeOf(Function),l="function"==typeof Map&&"function"==typeof Map.prototype.entries?Map:ue(),d="function"==typeof Set&&"function"==typeof Set.prototype.entries?Set:ce(),f="function"==typeof WeakMap?WeakMap:he(),p=r?Symbol.for("@reflect-metadata:registry"):void 0,g=ne(),m=se(g);function v(e,t,i,r){if(x(i)){if(!K(e))throw new TypeError;if(!Y(t))throw new TypeError;return C(e,t)}if(!K(e))throw new TypeError;if(!U(t))throw new TypeError;if(!U(r)&&!x(r)&&!L(r))throw new TypeError;return L(r)&&(r=void 0),B(e,t,i=H(i),r)}function E(e,t){function i(i,r){if(!U(i))throw new TypeError;if(!x(r)&&!z(r))throw new TypeError;O(e,t,i,r)}return i}function y(e,t,i,r){if(!U(i))throw new TypeError;return x(r)||(r=H(r)),O(e,t,i,r)}function S(e,t,i){if(!U(t))throw new TypeError;return x(i)||(i=H(i)),M(e,t,i)}function b(e,t,i){if(!U(t))throw new TypeError;return x(i)||(i=H(i)),P(e,t,i)}function _(e,t,i){if(!U(t))throw new TypeError;return x(i)||(i=H(i)),T(e,t,i)}function A(e,t,i){if(!U(t))throw new TypeError;return x(i)||(i=H(i)),N(e,t,i)}function w(e,t){if(!U(e))throw new TypeError;return x(t)||(t=H(t)),D(e,t)}function R(e,t){if(!U(e))throw new TypeError;return x(t)||(t=H(t)),F(e,t)}function I(e,t,i){if(!U(t))throw new TypeError;if(x(i)||(i=H(i)),!U(t))throw new TypeError;x(i)||(i=H(i));var r=ae(t,i,!1);return!x(r)&&r.OrdinaryDeleteMetadata(e,t,i)}function C(e,t){for(var i=e.length-1;i>=0;--i){var r=(0,e[i])(t);if(!x(r)&&!L(r)){if(!Y(r))throw new TypeError;t=r}}return t}function B(e,t,i,r){for(var n=e.length-1;n>=0;--n){var s=(0,e[n])(t,i,r);if(!x(s)&&!L(s)){if(!U(s))throw new TypeError;r=s}}return r}function M(e,t,i){if(P(e,t,i))return!0;var r=ie(t);return!L(r)&&M(e,r,i)}function P(e,t,i){var r=ae(t,i,!1);return!x(r)&&j(r.OrdinaryHasOwnMetadata(e,t,i))}function T(e,t,i){if(P(e,t,i))return N(e,t,i);var r=ie(t);return L(r)?void 0:T(e,r,i)}function N(e,t,i){var r=ae(t,i,!1);if(!x(r))return r.OrdinaryGetOwnMetadata(e,t,i)}function O(e,t,i,r){ae(i,r,!0).OrdinaryDefineOwnMetadata(e,t,i,r)}function D(e,t){var i=F(e,t),r=ie(e);if(null===r)return i;var n=D(r,t);if(n.length<=0)return i;if(i.length<=0)return n;for(var s=new d,o=[],a=0,u=i;a<u.length;a++){var c=u[a];s.has(c)||(s.add(c),o.push(c))}for(var h=0,l=n;h<l.length;h++){c=l[h];s.has(c)||(s.add(c),o.push(c))}return o}function F(e,t){var i=ae(e,t,!1);return i?i.OrdinaryOwnMetadataKeys(e,t):[]}function k(e){if(null===e)return 1;switch(typeof e){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return null===e?1:6;default:return 6}}function x(e){return void 0===e}function L(e){return null===e}function G(e){return"symbol"==typeof e}function U(e){return"object"==typeof e?null!==e:"function"==typeof e}function W(e,t){switch(k(e)){case 0:case 1:case 2:case 3:case 4:case 5:return e}var i="string",r=Q(e,n);if(void 0!==r){var s=r.call(e,i);if(U(s))throw new TypeError;return s}return V(e)}function V(e,t){var i,r,n=e.toString;if($(n)&&!U(r=n.call(e)))return r;if($(i=e.valueOf)&&!U(r=i.call(e)))return r;throw new TypeError}function j(e){return!!e}function q(e){return""+e}function H(e){var t=W(e);return G(t)?t:q(t)}function K(e){return Array.isArray?Array.isArray(e):e instanceof Object?e instanceof Array:"[object Array]"===Object.prototype.toString.call(e)}function $(e){return"function"==typeof e}function Y(e){return"function"==typeof e}function z(e){switch(k(e)){case 3:case 4:return!0;default:return!1}}function X(e,t){return e===t||e!=e&&t!=t}function Q(e,t){var i=e[t];if(null!=i){if(!$(i))throw new TypeError;return i}}function Z(e){var t=Q(e,s);if(!$(t))throw new TypeError;var i=t.call(e);if(!U(i))throw new TypeError;return i}function J(e){return e.value}function ee(e){var t=e.next();return!t.done&&t}function te(e){var t=e.return;t&&t.call(e)}function ie(e){var t=Object.getPrototypeOf(e);if("function"!=typeof e||e===h)return t;if(t!==h)return t;var i=e.prototype,r=i&&Object.getPrototypeOf(i);if(null==r||r===Object.prototype)return t;var n=r.constructor;return"function"!=typeof n||n===e?t:n}function re(){var e,i,r,n;x(p)||void 0===t.Reflect||p in t.Reflect||"function"!=typeof t.Reflect.defineMetadata||(e=oe(t.Reflect));var s=new f,o={registerProvider:a,getProvider:c,setProvider:g};return o;function a(t){if(!Object.isExtensible(o))throw new Error("Cannot add provider to a frozen registry.");switch(!0){case e===t:break;case x(i):i=t;break;case i===t:break;case x(r):r=t;break;case r===t:break;default:void 0===n&&(n=new d),n.add(t)}}function u(t,s){if(!x(i)){if(i.isProviderFor(t,s))return i;if(!x(r)){if(r.isProviderFor(t,s))return i;if(!x(n))for(var o=Z(n);;){var a=ee(o);if(!a)return;var u=J(a);if(u.isProviderFor(t,s))return te(o),u}}}if(!x(e)&&e.isProviderFor(t,s))return e}function c(e,t){var i,r=s.get(e);return x(r)||(i=r.get(t)),x(i)?(x(i=u(e,t))||(x(r)&&(r=new l,s.set(e,r)),r.set(t,i)),i):i}function h(e){if(x(e))throw new TypeError;return i===e||r===e||!x(n)&&n.has(e)}function g(e,t,i){if(!h(i))throw new Error("Metadata provider not registered.");var r=c(e,t);if(r!==i){if(!x(r))return!1;var n=s.get(e);x(n)&&(n=new l,s.set(e,n)),n.set(t,i)}return!0}}function ne(){var e;return!x(p)&&U(t.Reflect)&&Object.isExtensible(t.Reflect)&&(e=t.Reflect[p]),x(e)&&(e=re()),!x(p)&&U(t.Reflect)&&Object.isExtensible(t.Reflect)&&Object.defineProperty(t.Reflect,p,{enumerable:!1,configurable:!1,writable:!1,value:e}),e}function se(e){var t=new f,i={isProviderFor:function(e,i){var r=t.get(e);return!x(r)&&r.has(i)},OrdinaryDefineOwnMetadata:o,OrdinaryHasOwnMetadata:n,OrdinaryGetOwnMetadata:s,OrdinaryOwnMetadataKeys:a,OrdinaryDeleteMetadata:u};return g.registerProvider(i),i;function r(r,n,s){var o=t.get(r),a=!1;if(x(o)){if(!s)return;o=new l,t.set(r,o),a=!0}var u=o.get(n);if(x(u)){if(!s)return;if(u=new l,o.set(n,u),!e.setProvider(r,n,i))throw o.delete(n),a&&t.delete(r),new Error("Wrong provider for target.")}return u}function n(e,t,i){var n=r(t,i,!1);return!x(n)&&j(n.has(e))}function s(e,t,i){var n=r(t,i,!1);if(!x(n))return n.get(e)}function o(e,t,i,n){r(i,n,!0).set(e,t)}function a(e,t){var i=[],n=r(e,t,!1);if(x(n))return i;for(var s=Z(n.keys()),o=0;;){var a=ee(s);if(!a)return i.length=o,i;var u=J(a);try{i[o]=u}catch(e){try{te(s)}finally{throw e}}o++}}function u(e,i,n){var s=r(i,n,!1);if(x(s))return!1;if(!s.delete(e))return!1;if(0===s.size){var o=t.get(i);x(o)||(o.delete(n),0===o.size&&t.delete(o))}return!0}}function oe(e){var t=e.defineMetadata,i=e.hasOwnMetadata,r=e.getOwnMetadata,n=e.getOwnMetadataKeys,s=e.deleteMetadata,o=new f,a={isProviderFor:function(e,t){var i=o.get(e);return!(x(i)||!i.has(t))||!!n(e,t).length&&(x(i)&&(i=new d,o.set(e,i)),i.add(t),!0)},OrdinaryDefineOwnMetadata:t,OrdinaryHasOwnMetadata:i,OrdinaryGetOwnMetadata:r,OrdinaryOwnMetadataKeys:n,OrdinaryDeleteMetadata:s};return a}function ae(e,t,i){var r=g.getProvider(e,t);if(!x(r))return r;if(i){if(g.setProvider(e,t,m))return m;throw new Error("Illegal state.")}}function ue(){var e={},t=[],i=function(){function e(e,t,i){this._index=0,this._keys=e,this._values=t,this._selector=i}return e.prototype["@@iterator"]=function(){return this},e.prototype[s]=function(){return this},e.prototype.next=function(){var e=this._index;if(e>=0&&e<this._keys.length){var i=this._selector(this._keys[e],this._values[e]);return e+1>=this._keys.length?(this._index=-1,this._keys=t,this._values=t):this._index++,{value:i,done:!1}}return{value:void 0,done:!0}},e.prototype.throw=function(e){throw this._index>=0&&(this._index=-1,this._keys=t,this._values=t),e},e.prototype.return=function(e){return this._index>=0&&(this._index=-1,this._keys=t,this._values=t),{value:e,done:!0}},e}();return function(){function t(){this._keys=[],this._values=[],this._cacheKey=e,this._cacheIndex=-2}return Object.defineProperty(t.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),t.prototype.has=function(e){return this._find(e,!1)>=0},t.prototype.get=function(e){var t=this._find(e,!1);return t>=0?this._values[t]:void 0},t.prototype.set=function(e,t){var i=this._find(e,!0);return this._values[i]=t,this},t.prototype.delete=function(t){var i=this._find(t,!1);if(i>=0){for(var r=this._keys.length,n=i+1;n<r;n++)this._keys[n-1]=this._keys[n],this._values[n-1]=this._values[n];return this._keys.length--,this._values.length--,X(t,this._cacheKey)&&(this._cacheKey=e,this._cacheIndex=-2),!0}return!1},t.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=e,this._cacheIndex=-2},t.prototype.keys=function(){return new i(this._keys,this._values,r)},t.prototype.values=function(){return new i(this._keys,this._values,n)},t.prototype.entries=function(){return new i(this._keys,this._values,o)},t.prototype["@@iterator"]=function(){return this.entries()},t.prototype[s]=function(){return this.entries()},t.prototype._find=function(e,t){if(!X(this._cacheKey,e)){this._cacheIndex=-1;for(var i=0;i<this._keys.length;i++)if(X(this._keys[i],e)){this._cacheIndex=i;break}}return this._cacheIndex<0&&t&&(this._cacheIndex=this._keys.length,this._keys.push(e),this._values.push(void 0)),this._cacheIndex},t}();function r(e,t){return e}function n(e,t){return t}function o(e,t){return[e,t]}}function ce(){return function(){function e(){this._map=new l}return Object.defineProperty(e.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),e.prototype.has=function(e){return this._map.has(e)},e.prototype.add=function(e){return this._map.set(e,e),this},e.prototype.delete=function(e){return this._map.delete(e)},e.prototype.clear=function(){this._map.clear()},e.prototype.keys=function(){return this._map.keys()},e.prototype.values=function(){return this._map.keys()},e.prototype.entries=function(){return this._map.entries()},e.prototype["@@iterator"]=function(){return this.keys()},e.prototype[s]=function(){return this.keys()},e}()}function he(){var e=16,t=c.create(),r=n();return function(){function e(){this._key=n()}return e.prototype.has=function(e){var t=s(e,!1);return void 0!==t&&c.has(t,this._key)},e.prototype.get=function(e){var t=s(e,!1);return void 0!==t?c.get(t,this._key):void 0},e.prototype.set=function(e,t){return s(e,!0)[this._key]=t,this},e.prototype.delete=function(e){var t=s(e,!1);return void 0!==t&&delete t[this._key]},e.prototype.clear=function(){this._key=n()},e}();function n(){var e;do{e="@@WeakMap@@"+u()}while(c.has(t,e));return t[e]=!0,e}function s(e,t){if(!i.call(e,r)){if(!t)return;Object.defineProperty(e,r,{value:c.create()})}return e[r]}function o(e,t){for(var i=0;i<t;++i)e[i]=255*Math.random()|0;return e}function a(e){if("function"==typeof Uint8Array){var t=new Uint8Array(e);return"undefined"!=typeof crypto?crypto.getRandomValues(t):"undefined"!=typeof msCrypto?msCrypto.getRandomValues(t):o(t,e),t}return o(new Array(e),e)}function u(){var t=a(e);t[6]=79&t[6]|64,t[8]=191&t[8]|128;for(var i="",r=0;r<e;++r){var n=t[r];4!==r&&6!==r&&8!==r||(i+="-"),n<16&&(i+="0"),i+=n.toString(16).toLowerCase()}return i}}function le(e){return e.__=void 0,delete e.__,e}e("decorate",v),e("metadata",E),e("defineMetadata",y),e("hasMetadata",S),e("hasOwnMetadata",b),e("getMetadata",_),e("getOwnMetadata",A),e("getMetadataKeys",w),e("getOwnMetadataKeys",R),e("deleteMetadata",I)}(i,t),void 0===t.Reflect&&(t.Reflect=e)}()}(e||(e={}))),o;var e}();const c=Symbol.for("@inversifyjs/common/islazyServiceIdentifier");class h{[c];#e;constructor(e){this.#e=e,this[c]=!0}static is(e){return"object"==typeof e&&null!==e&&!0===e[c]}unwrap(){return this.#e()}}function l(e,t){return Reflect.getOwnMetadata(t,e)}function d(e,t,i){Reflect.defineMetadata(t,i,e)}function f(e,t,i,r){const n=r(l(e,t)??i());Reflect.defineMetadata(t,n,e)}const p="Request",g="Singleton",m="Transient",v="ConstantValue",E="DynamicValue",y="Factory",S="Instance",b="Provider",_="ResolvedValue",A="ServiceRedirection";function*w(...e){for(const t of e)yield*t}class R{#e;#t;#i;constructor(e){this.#e=new Map,this.#t={};for(const t of Reflect.ownKeys(e))this.#t[t]=new Map;this.#i=e}add(e,t){this.#r(e).push(t);for(const i of Reflect.ownKeys(t))this.#n(i,t[i]).push(e)}clone(){const e=Reflect.ownKeys(this.#i),t=new R(this.#i);this.#s(this.#e,t.#e);for(const i of e)this.#s(this.#t[i],t.#t[i]);return t}get(e,t){return this.#t[e].get(t)}getAllKeys(e){return this.#t[e].keys()}removeByRelation(e,t){const i=this.get(e,t);if(void 0===i)return;const r=new Set(i);for(const i of r){const r=this.#e.get(i);if(void 0===r)throw new Error("Expecting model relation, none found");for(const n of r)n[e]===t&&this.#o(i,n);this.#e.delete(i)}}#r(e){let t=this.#e.get(e);return void 0===t&&(t=[],this.#e.set(e,t)),t}#n(e,t){let i=this.#t[e].get(t);return void 0===i&&(i=[],this.#t[e].set(t,i)),i}#s(e,t){for(const[i,r]of e)t.set(i,[...r])}#o(e,t){for(const i of Reflect.ownKeys(t))this.#a(e,i,t[i])}#a(e,t,i){const r=this.#t[t].get(i);if(void 0!==r){const n=r.indexOf(e);-1!==n&&r.splice(n,1),0===r.length&&this.#t[t].delete(i)}}}var I,C,B;!function(e){e.moduleId="moduleId",e.serviceId="serviceId"}(I||(I={}));class M{#u;#c;constructor(e,t){this.#u=t??new R({moduleId:{isOptional:!0},serviceId:{isOptional:!1}}),this.#c=e}static build(e){return new M(e)}add(e,t){this.#u.add(e,t)}clone(){return new M(this.#c,this.#u.clone())}get(e){const t=[],i=this.#u.get(I.serviceId,e);void 0!==i&&t.push(i);const r=this.#c?.get(e);if(void 0!==r&&t.push(r),0!==t.length)return w(...t)}removeAllByModuleId(e){this.#u.removeByRelation(I.moduleId,e)}removeAllByServiceId(e){this.#u.removeByRelation(I.serviceId,e)}}!function(e){e.id="id",e.moduleId="moduleId",e.serviceId="serviceId"}(C||(C={}));class P{#h;#c;constructor(e,t){this.#h=t??new R({id:{isOptional:!1},moduleId:{isOptional:!0},serviceId:{isOptional:!1}}),this.#c=e}static build(e){return new P(e)}clone(){return new P(this.#c,this.#h.clone())}get(e){return this.getNonParentBindings(e)??this.#c?.get(e)}getById(e){return this.#h.get(C.id,e)??this.#c?.getById(e)}getByModuleId(e){return this.#h.get(C.moduleId,e)??this.#c?.getByModuleId(e)}getNonParentBindings(e){return this.#h.get(C.serviceId,e)}getNonParentBoundServices(){return this.#h.getAllKeys(C.serviceId)}removeById(e){this.#h.removeByRelation(C.id,e)}removeAllByModuleId(e){this.#h.removeByRelation(C.moduleId,e)}removeAllByServiceId(e){this.#h.removeByRelation(C.serviceId,e)}set(e){const t={[C.id]:e.id,[C.serviceId]:e.serviceIdentifier};void 0!==e.moduleId&&(t[C.moduleId]=e.moduleId),this.#h.add(e,t)}}!function(e){e.moduleId="moduleId",e.serviceId="serviceId"}(B||(B={}));class T{#l;#c;constructor(e,t){this.#l=t??new R({moduleId:{isOptional:!0},serviceId:{isOptional:!1}}),this.#c=e}static build(e){return new T(e)}add(e,t){this.#l.add(e,t)}clone(){return new T(this.#c,this.#l.clone())}get(e){const t=[],i=this.#l.get(B.serviceId,e);void 0!==i&&t.push(i);const r=this.#c?.get(e);if(void 0!==r&&t.push(r),0!==t.length)return w(...t)}removeAllByModuleId(e){this.#l.removeByRelation(B.moduleId,e)}removeAllByServiceId(e){this.#l.removeByRelation(B.serviceId,e)}}const N="@inversifyjs/core/classMetadataReflectKey";function O(){return{constructorArguments:[],lifecycle:{postConstructMethodName:void 0,preDestroyMethodName:void 0},properties:new Map,scope:void 0}}const D="@inversifyjs/core/pendingClassMetadataCountReflectKey",F=Symbol.for("@inversifyjs/core/InversifyCoreError");class k extends Error{[F];kind;constructor(e,t,i){super(t,i),this[F]=!0,this.kind=e}static is(e){return"object"==typeof e&&null!==e&&!0===e[F]}static isErrorOfKind(e,t){return k.is(e)&&e.kind===t}}var x,L,G;function U(e){const t=l(e,N)??O();if(!function(e){const t=l(e,D);return void 0!==t&&0!==t}(e))return function(e,t){const i=[];if(t.length<e.length)throw new k(x.missingInjectionDecorator,`Found unexpected missing metadata on type "${e.name}". "${e.name}" constructor requires at least ${e.length.toString()} arguments, found ${t.length.toString()} instead.\nAre you using @inject, @multiInject or @unmanaged decorators in every non optional constructor argument?\n\nIf you're using typescript and want to rely on auto injection, set "emitDecoratorMetadata" compiler option to true`);for(let e=0;e<t.length;++e)void 0===t[e]&&i.push(e);if(i.length>0)throw new k(x.missingInjectionDecorator,`Found unexpected missing metadata on type "${e.name}" at constructor indexes "${i.join('", "')}".\n\nAre you using @inject, @multiInject or @unmanaged decorators at those indexes?\n\nIf you're using typescript and want to rely on auto injection, set "emitDecoratorMetadata" compiler option to true`)}(e,t.constructorArguments),t;!function(e,t){const i=[];for(let r=0;r<t.constructorArguments.length;++r){const n=t.constructorArguments[r];void 0!==n&&n.kind!==L.unknown||i.push(`  - Missing or incomplete metadata for type "${e.name}" at constructor argument with index ${r.toString()}.\nEvery constructor parameter must be decorated either with @inject, @multiInject or @unmanaged decorator.`)}for(const[r,n]of t.properties)n.kind===L.unknown&&i.push(`  - Missing or incomplete metadata for type "${e.name}" at property "${r.toString()}".\nThis property must be decorated either with @inject or @multiInject decorator.`);if(0===i.length)throw new k(x.unknown,`Unexpected class metadata for type "${e.name}" with uncompletion traces.\nThis might be caused by one of the following reasons:\n\n1. A third party library is targeting inversify reflection metadata.\n2. A bug is causing the issue. Consider submiting an issue to fix it.`);throw new k(x.missingInjectionDecorator,`Invalid class metadata at type ${e.name}:\n\n${i.join("\n\n")}`)}(e,t)}function W(){return 0}function V(e){return t=>{void 0!==t&&t.kind===L.unknown&&f(e,D,W,(e=>e-1))}}!function(e){e[e.injectionDecoratorConflict=0]="injectionDecoratorConflict",e[e.missingInjectionDecorator=1]="missingInjectionDecorator",e[e.planning=2]="planning",e[e.resolution=3]="resolution",e[e.unknown=4]="unknown"}(x||(x={})),function(e){e[e.unknown=32]="unknown"}(L||(L={})),function(e){e[e.multipleInjection=0]="multipleInjection",e[e.singleInjection=1]="singleInjection",e[e.unmanaged=2]="unmanaged"}(G||(G={}));const j=function(e,t){return(...i)=>r=>{if(void 0===r)return e(...i);if(r.kind===G.unmanaged)throw new k(x.injectionDecoratorConflict,"Unexpected injection found. Multiple @inject, @multiInject or @unmanaged decorators found");return t(r,...i)}}((function(e,t){return{kind:e,name:void 0,optional:!1,tags:new Map,value:t}}),(function(e,t,i){return function(e){if(e.kind!==L.unknown&&!0!==e.isFromTypescriptParamType)throw new k(x.injectionDecoratorConflict,"Unexpected injection found. Multiple @inject, @multiInject or @unmanaged decorators found")}(e),{...e,kind:t,value:i}}));function q(e,t){return i=>{const r=i.properties.get(t);return i.properties.set(t,e(r)),i}}var H;function K(e,t){return(i,r,n)=>{try{void 0===n?function(e,t){const i=$(e,t);return(e,t)=>{f(e.constructor,N,O,q(i(e),t))}}(e,t)(i,r):"number"==typeof n?function(e,t){const i=$(e,t);return(e,t,r)=>{if(!function(e,t){return"function"==typeof e&&void 0===t}(e,t))throw new k(x.injectionDecoratorConflict,`Found an @inject decorator in a non constructor parameter.\nFound @inject decorator at method "${t?.toString()??""}" at class "${e.constructor.name}"`);f(e,N,O,function(e,t){return i=>{const r=i.constructorArguments[t];return i.constructorArguments[t]=e(r),i}}(i(e),r))}}(e,t)(i,r,n):function(e,t){const i=$(e,t);return(e,t,r)=>{if(!function(e){return void 0!==e.set}(r))throw new k(x.injectionDecoratorConflict,`Found an @inject decorator in a non setter property method.\nFound @inject decorator at method "${t.toString()}" at class "${e.constructor.name}"`);f(e.constructor,N,O,q(i(e),t))}}(e,t)(i,r,n)}catch(e){!function(e,t,i,r){if(k.isErrorOfKind(r,x.injectionDecoratorConflict)){const n=function(e,t,i){if(void 0===i){if(void 0===t)throw new k(x.unknown,"Unexpected undefined property and index values");return{kind:H.property,property:t,targetClass:e.constructor}}return"number"==typeof i?{index:i,kind:H.parameter,targetClass:e}:{kind:H.method,method:t,targetClass:e}}(e,t,i);throw new k(x.injectionDecoratorConflict,`Unexpected injection error.\n\nCause:\n\n${r.message}\n\nDetails\n\n${function(e){switch(e.kind){case H.method:return`[class: "${e.targetClass.name}", method: "${e.method.toString()}"]`;case H.parameter:return`[class: "${e.targetClass.name}", index: "${e.index.toString()}"]`;case H.property:return`[class: "${e.targetClass.name}", property: "${e.property.toString()}"]`}}(n)}`,{cause:r})}throw r}(i,r,n,e)}}}function $(e,t){return i=>{const r=t(i);return t=>(r(t),e(t))}}function Y(e){return K(j(G.singleInjection,e),V)}!function(e){e[e.method=0]="method",e[e.parameter=1]="parameter",e[e.property=2]="property"}(H||(H={}));const z="@inversifyjs/core/classIsInjectableFlagReflectKey",X=[Array,BigInt,Boolean,Function,Number,Object,String];function Q(e){return e=>{!function(e){if(void 0!==l(e,z))throw new k(x.injectionDecoratorConflict,`Cannot apply @injectable decorator multiple times at class "${e.name}"`);d(e,z,!0)}(e),function(e){const t=l(e,"design:paramtypes");void 0!==t&&f(e,N,O,function(e){return t=>(e.forEach(((e,i)=>{var r;void 0!==t.constructorArguments[i]||(r=e,X.includes(r))||(t.constructorArguments[i]=function(e){return{isFromTypescriptParamType:!0,kind:G.singleInjection,name:void 0,optional:!1,tags:new Map,value:e}}(e))})),t)}(t))}(e)}}function Z(e){return K(j(G.multipleInjection,e),V)}var J,ee;!function(e){e[e.multipleInjection=0]="multipleInjection",e[e.singleInjection=1]="singleInjection"}(J||(J={}));class te{#d;constructor(e){this.#d=e}get name(){return this.#d.elem.name}get serviceIdentifier(){return this.#d.elem.serviceIdentifier}get tags(){return this.#d.elem.tags}getAncestor(){if(void 0!==this.#d.previous)return new te(this.#d.previous)}}class ie{last;constructor(e){this.last=e}concat(e){return new ie({elem:e,previous:this.last})}[Symbol.iterator](){let e=this.last;return{next:()=>{if(void 0===e)return{done:!0,value:void 0};const t=e.elem;return e=e.previous,{done:!1,value:t}}}}}function re(e,t,i){const r=i?.customServiceIdentifier??t.serviceIdentifier,n=[...e.getBindings(r)??[]].filter((e=>e.isSatisfiedBy(t)));if(0===n.length&&void 0!==e.autobindOptions&&"function"==typeof r){const t=function(e,t){return{cache:{isRight:!1,value:void 0},id:0,implementationType:t,isSatisfiedBy:()=>!0,moduleId:void 0,onActivation:void 0,onDeactivation:void 0,scope:e.scope,serviceIdentifier:t,type:S}}(e.autobindOptions,r);e.setBinding(t),n.push(t)}return n}function ne(e){return void 0!==e.redirections}function se(e,t,i,r){let n,s;ne(i)?(n=i.binding.targetServiceIdentifier,s=i.binding.serviceIdentifier):(n=i.serviceIdentifier,s=i.parent?.binding.serviceIdentifier),Array.isArray(e)?function(e,t,i,r,n){if(0!==e.length){const t=`Ambiguous bindings found for service: "${u(i)}".\n\nRegistered bindings:\n\n${e.map((e=>function(e){switch(e.type){case S:return`[ type: "${e.type}", serviceIdentifier: "${u(e.serviceIdentifier)}", scope: "${e.scope}", implementationType: "${e.implementationType.name}" ]`;case A:return`[ type: "${e.type}", serviceIdentifier: "${u(e.serviceIdentifier)}", redirection: "${u(e.targetServiceIdentifier)}" ]`;default:return`[ type: "${e.type}", serviceIdentifier: "${u(e.serviceIdentifier)}", scope: "${e.scope}" ]`}}(e.binding))).join("\n")}\n\nTrying to resolve bindings for "${ae(i,r)}".\n\n${ue(n)}`;throw new k(x.planning,t)}t||oe(i,r,n)}(e,t,n,s,r):function(e,t,i,r,n){void 0!==e||t||oe(i,r,n)}(e,t,n,s,r)}function oe(e,t,i){const r=`No bindings found for service: "${u(e)}".\n\nTrying to resolve bindings for "${ae(e,t)}".\n\n${ue(i)}`;throw new k(x.planning,r)}function ae(e,t){return void 0===t?`${u(e)} (Root service)`:u(t)}function ue(e){const t=0===e.tags.size?"":`\n- tags:\n  - ${[...e.tags.keys()].map((e=>e.toString())).join("\n  - ")}`;return`Binding constraints:\n- service identifier: ${u(e.serviceIdentifier)}\n- name: ${e.name?.toString()??"-"}${t}`}function ce(e,t,i){if(1!==e.redirections.length)se(e.redirections,t,e,i);else{const[r]=e.redirections;ne(r)&&ce(r,t,i)}}function he(e,t,i){if(Array.isArray(e.bindings)&&1===e.bindings.length){const[r]=e.bindings;ne(r)&&ce(r,t,i)}else se(e.bindings,t,e,i)}function le(e){try{const t=new Map;void 0!==e.rootConstraints.tag&&t.set(e.rootConstraints.tag.key,e.rootConstraints.tag.value);const i=new ie({elem:{name:e.rootConstraints.name,serviceIdentifier:e.rootConstraints.serviceIdentifier,tags:t},previous:void 0}),r=new te(i.last),n=re(e,r),s=[],o={bindings:s,parent:void 0,serviceIdentifier:e.rootConstraints.serviceIdentifier};if(s.push(...me(e,i,n,o)),!e.rootConstraints.isMultiple){he(o,e.rootConstraints.isOptional??!1,r);const[t]=s;o.bindings=t}return{tree:{root:o}}}catch(t){!function(e,t){if(function(e){return e instanceof Error&&(e instanceof RangeError&&/stack space|call stack|too much recursion/i.test(e.message)||"InternalError"===e.name&&/too much recursion/.test(e.message))}(t)){const i=function(e){const t=[...e];return 0===t.length?"(No dependency trace)":t.map(u).join(" -> ")}(function(e){const t=new Set;for(const i of e.servicesBranch){if(t.has(i))return[...t,i];t.add(i)}return[...t]}(e));throw new k(x.planning,`Circular dependency found: ${i}`,{cause:t})}throw t}(e,t)}}function de(e,t,i,r){const n={binding:t,classMetadata:e.getClassMetadata(t.implementationType),constructorParams:[],parent:r,propertyParams:new Map};return Ee({autobindOptions:e.autobindOptions,getBindings:e.getBindings,getClassMetadata:e.getClassMetadata,node:n,servicesBranch:e.servicesBranch,setBinding:e.setBinding},i)}function fe(e,t,i){if(i.kind===G.unmanaged)return;const r=h.is(i.value)?i.value.unwrap():i.value,n=t.concat({name:i.name,serviceIdentifier:r,tags:i.tags}),s=new te(n.last),o=re(e,s),a=[],u={bindings:a,parent:e.node,serviceIdentifier:r};if(a.push(...me(e,n,o,u)),i.kind===G.singleInjection){he(u,i.optional,s);const[e]=a;u.bindings=e}return u}function pe(e,t,i){const r=h.is(i.value)?i.value.unwrap():i.value,n=t.concat({name:i.name,serviceIdentifier:r,tags:i.tags}),s=new te(n.last),o=re(e,s),a=[],u={bindings:a,parent:e.node,serviceIdentifier:r};if(a.push(...me(e,n,o,u)),i.kind===J.singleInjection){he(u,i.optional,s);const[e]=a;u.bindings=e}return u}function ge(e,t,i,r){const n={binding:t,params:[],parent:r};return Ee({autobindOptions:e.autobindOptions,getBindings:e.getBindings,getClassMetadata:e.getClassMetadata,node:n,servicesBranch:e.servicesBranch,setBinding:e.setBinding},i)}function me(e,t,i,r){const n=ne(r)?r.binding.targetServiceIdentifier:r.serviceIdentifier;e.servicesBranch.push(n);const s=[];for(const n of i)switch(n.type){case S:s.push(de(e,n,t,r));break;case _:s.push(ge(e,n,t,r));break;case A:{const i=ve(e,t,n,r);s.push(i);break}default:s.push({binding:n,parent:r})}return e.servicesBranch.pop(),s}function ve(e,t,i,r){const n={binding:i,parent:r,redirections:[]},s=re(e,new te(t.last),{customServiceIdentifier:i.targetServiceIdentifier});return n.redirections.push(...me(e,t,s,n)),n}function Ee(e,t){return e.node.binding.type===S?function(e,t,i){const r=t.classMetadata;for(const[n,s]of r.constructorArguments.entries())t.constructorParams[n]=fe(e,i,s);for(const[n,s]of r.properties){const r=fe(e,i,s);void 0!==r&&t.propertyParams.set(n,r)}return e.node}(e,e.node,t):function(e,t,i){const r=t.binding.metadata;for(const[n,s]of r.arguments.entries())t.params[n]=pe(e,i,s);return e.node}(e,e.node,t)}!function(e){e[e.singleMandatory=0]="singleMandatory",e[e.singleOptional=1]="singleOptional",e[e.multipleMandatory=2]="multipleMandatory",e[e.multipleOptional=3]="multipleOptional",e[e.length=4]="length"}(ee||(ee={}));class ye{#f;#p;#g;#m;#v;constructor(){this.#f=this.#E(),this.#p=this.#E(),this.#m=this.#E(),this.#g=this.#E(),this.#v=[]}clearCache(){for(const e of this.#y())e.clear();for(const e of this.#v)e.clearCache()}get(e){return void 0===e.name?void 0===e.tag?this.#S(this.#f,e).get(e.serviceIdentifier):this.#S(this.#g,e).get(e.serviceIdentifier)?.get(e.tag.key)?.get(e.tag.value):void 0===e.tag?this.#S(this.#p,e).get(e.serviceIdentifier)?.get(e.name):this.#S(this.#m,e).get(e.serviceIdentifier)?.get(e.name)?.get(e.tag.key)?.get(e.tag.value)}set(e,t){void 0===e.name?void 0===e.tag?this.#S(this.#f,e).set(e.serviceIdentifier,t):this.#b(this.#b(this.#S(this.#g,e),e.serviceIdentifier),e.tag.key).set(e.tag.value,t):void 0===e.tag?this.#b(this.#S(this.#p,e),e.serviceIdentifier).set(e.name,t):this.#b(this.#b(this.#b(this.#S(this.#m,e),e.serviceIdentifier),e.name),e.tag.key).set(e.tag.value,t)}subscribe(e){this.#v.push(e)}#E(){const e=new Array(ee.length);for(let t=0;t<e.length;++t)e[t]=new Map;return e}#b(e,t){let i=e.get(t);return void 0===i&&(i=new Map,e.set(t,i)),i}#S(e,t){return e[this.#_(t)]}#y(){return[...this.#f,...this.#p,...this.#m,...this.#g]}#_(e){return e.isMultiple?!0===e.optional?ee.multipleOptional:ee.multipleMandatory:!0===e.optional?ee.singleOptional:ee.singleMandatory}}function Se(e,t){return a(t)?(e.cache={isRight:!0,value:t},t.then((t=>be(e,t)))):be(e,t)}function be(e,t){return e.cache={isRight:!0,value:t},t}async function _e(e,t,i){let r=await t,n=i.next();for(;!0!==n.done;)r=await n.value(e.context,r),n=i.next();return r}function Ae(e,t,i){let r=i;if(void 0!==t.onActivation){const i=t.onActivation;r=a(r)?r.then((t=>i(e.context,t))):i(e.context,r)}return function(e,t,i){const r=e.getActivations(t);return void 0===r?i:a(i)?_e(e,i,r[Symbol.iterator]()):function(e,t,i){let r=t,n=i.next();for(;!0!==n.done;){const t=n.value(e.context,r);if(a(t))return _e(e,t,i);r=t,n=i.next()}return r}(e,i,r[Symbol.iterator]())}(e,t.serviceIdentifier,r)}function we(e){return(t,i)=>i.cache.isRight?i.cache.value:Se(i,Ae(t,i,e(t,i)))}const Re=we((function(e,t){return t.value}));function Ie(e){return e}function Ce(e,t){return(i,r)=>{const n=e(r);switch(n.scope){case g:return n.cache.isRight?n.cache.value:Se(n,Ae(i,n,t(i,r)));case p:{if(i.requestScopeCache.has(n.id))return i.requestScopeCache.get(n.id);const e=Ae(i,n,t(i,r));return i.requestScopeCache.set(n.id,e),e}case m:return Ae(i,n,t(i,r))}}}const Be=Ce(Ie,(function(e,t){return t.value(e.context)})),Me=we((function(e,t){return t.factory(e.context)}));function Pe(e,t,i){const r=function(e,t,i){if(void 0!==i){if(!(i in e))throw new k(x.resolution,`Expecting a "${i.toString()}" property when resolving "${t.implementationType.name}" class @postConstruct decorated method, none found.`);if("function"!=typeof e[i])throw new k(x.resolution,`Expecting a "${i.toString()}" method when resolving "${t.implementationType.name}" class @postConstruct decorated method, a non function property was found instead.`);{let r;try{r=e[i]()}catch(e){throw new k(x.resolution,`Unexpected error found when calling "${i.toString()}" @postConstruct decorated method on class "${t.implementationType.name}"`,{cause:e})}if(a(r))return async function(e,t,i){try{await i}catch(i){throw new k(x.resolution,`Unexpected error found when calling "${t.toString()}" @postConstruct decorated method on class "${e.implementationType.name}"`,{cause:i})}}(t,i,r)}}}(e,t,i);return a(r)?r.then((()=>e)):e}function Te(e){return(t,i,r)=>{const n=new r.binding.implementationType(...t),s=e(i,n,r);return a(s)?s.then((()=>Pe(n,r.binding,r.classMetadata.lifecycle.postConstructMethodName))):Pe(n,r.binding,r.classMetadata.lifecycle.postConstructMethodName)}}const Ne=we((function(e,t){return t.provider(e.context)}));function Oe(e){return e.binding}function De(e){return e.binding}const Fe=(We=je,(e,t,i)=>{const r=[];for(const[n,s]of i.propertyParams){const o=i.classMetadata.properties.get(n);if(void 0===o)throw new k(x.resolution,`Expecting metadata at property "${n.toString()}", none found`);o.kind!==G.unmanaged&&void 0!==s.bindings&&(t[n]=We(e,s),a(t[n])&&r.push((async()=>{t[n]=await t[n]})()))}if(r.length>0)return Promise.all(r).then((()=>{}))}),ke=function(e){return function t(i,r){const n=[];for(const s of r.redirections)ne(s)?n.push(...t(i,s)):n.push(e(i,s));return n}}(Ve),xe=function(e,t,i){return(r,n)=>{const s=e(r,n);return a(s)?t(s,r,n):i(s,r,n)}}(function(e){return(t,i)=>{const r=[];for(const n of i.constructorParams)void 0===n?r.push(void 0):r.push(e(t,n));return r.some(a)?Promise.all(r):r}}(je),function(e){return async(t,i,r)=>{const n=await t;return e(n,i,r)}}(Te(Fe)),Te(Fe)),Le=function(e){return(t,i)=>{const r=e(t,i);return a(r)?r.then((e=>i.binding.factory(...e))):i.binding.factory(...r)}}(function(e){return(t,i)=>{const r=[];for(const n of i.params)r.push(e(t,n));return r.some(a)?Promise.all(r):r}}(je)),Ge=Ce(Oe,xe),Ue=Ce(De,Le);var We;function Ve(e,t){switch(t.binding.type){case v:return Re(e,t.binding);case E:return Be(e,t.binding);case y:return Me(e,t.binding);case S:return Ge(e,t);case b:return Ne(e,t.binding);case _:return Ue(e,t)}}function je(e,t){if(void 0!==t.bindings)return Array.isArray(t.bindings)?function(e,t){const i=[];for(const r of t)ne(r)?i.push(...ke(e,r)):i.push(Ve(e,r));return i.some(a)?Promise.all(i):i}(e,t.bindings):function(e,t){if(ne(t)){const i=ke(e,t);if(1===i.length)return i[0];throw new k(x.resolution,"Unexpected multiple resolved values on single injection")}return Ve(e,t)}(e,t.bindings)}function qe(e){return void 0!==e.scope}function He(e,t){if(void 0!==e.lifecycle.preDestroyMethodName&&"function"==typeof t[e.lifecycle.preDestroyMethodName])return t[e.lifecycle.preDestroyMethodName]()}function Ke(e,t,i){const r=e.getDeactivations(t);if(void 0!==r)return a(i)?$e(i,r[Symbol.iterator]()):function(e,t){let i=t.next();for(;!0!==i.done;){if(a(i.value(e)))return $e(e,t);i=t.next()}}(i,r[Symbol.iterator]())}async function $e(e,t){const i=await e;let r=t.next();for(;!0!==r.done;)await r.value(i),r=t.next()}function Ye(e,t){const i=function(e,t){if(t.type===S){const i=e.getClassMetadata(t.implementationType),r=t.cache.value;return a(r)?r.then((e=>He(i,e))):He(i,r)}}(e,t);return void 0===i?ze(e,t):i.then((()=>ze(e,t)))}function ze(e,t){const i=t.cache;return a(i.value)?i.value.then((i=>Xe(e,t,i))):Xe(e,t,i.value)}function Xe(e,t,i){let r;return void 0!==t.onDeactivation&&(r=(0,t.onDeactivation)(i)),void 0===r?Ke(e,t.serviceIdentifier,i):r.then((()=>Ke(e,t.serviceIdentifier,i)))}function Qe(e,t){if(void 0===t)return;const i=function(e){const t=[];for(const i of e)qe(i)&&i.scope===g&&i.cache.isRight&&t.push(i);return t}(t),r=[];for(const t of i){const i=Ye(e,t);void 0!==i&&r.push(i)}return r.length>0?Promise.all(r).then((()=>{})):void 0}function Ze(e,t){const i=e.getBindings(t);return Qe(e,i)}const Je=Symbol.for("@inversifyjs/container/bindingIdentifier");function et(e){return"object"==typeof e&&null!==e&&!0===e[Je]}class tt{static always=e=>!0}const it="@inversifyjs/container/bindingId";function rt(){const e=l(Object,it)??0;return e===Number.MAX_SAFE_INTEGER?d(Object,it,Number.MIN_SAFE_INTEGER):f(Object,it,(()=>e),(e=>e+1)),e}function nt(e){return{[Je]:!0,id:e.id}}function st(e){return t=>{for(let i=t.getAncestor();void 0!==i;i=i.getAncestor())if(e(i))return!0;return!1}}function ot(e){return t=>t.name===e}function at(e){return t=>t.serviceIdentifier===e}function ut(e,t){return i=>i.tags.has(e)&&i.tags.get(e)===t}function ct(e){return void 0===e.name&&0===e.tags.size}function ht(e){const t=st(e);return e=>!t(e)}function lt(e){return t=>{const i=t.getAncestor();return void 0===i||!e(i)}}function dt(e){return t=>{const i=t.getAncestor();return void 0!==i&&e(i)}}class ft{#i;constructor(e){this.#i=e}getIdentifier(){return nt(this.#i)}inRequestScope(){return this.#i.scope=p,new vt(this.#i)}inSingletonScope(){return this.#i.scope=g,new vt(this.#i)}inTransientScope(){return this.#i.scope=m,new vt(this.#i)}}class pt{#t;#a;#s;#o;constructor(e,t,i,r){this.#t=e,this.#a=t,this.#s=i,this.#o=r}to(e){const t=U(e),i={cache:{isRight:!1,value:void 0},id:rt(),implementationType:e,isSatisfiedBy:tt.always,moduleId:this.#a,onActivation:void 0,onDeactivation:void 0,scope:t.scope??this.#s,serviceIdentifier:this.#o,type:S};return this.#t(i),new Et(i)}toSelf(){if("function"!=typeof this.#o)throw new Error('"toSelf" function can only be applied when a newable function is used as service identifier');return this.to(this.#o)}toConstantValue(e){const t={cache:{isRight:!1,value:void 0},id:rt(),isSatisfiedBy:tt.always,moduleId:this.#a,onActivation:void 0,onDeactivation:void 0,scope:g,serviceIdentifier:this.#o,type:v,value:e};return this.#t(t),new vt(t)}toDynamicValue(e){const t={cache:{isRight:!1,value:void 0},id:rt(),isSatisfiedBy:tt.always,moduleId:this.#a,onActivation:void 0,onDeactivation:void 0,scope:this.#s,serviceIdentifier:this.#o,type:E,value:e};return this.#t(t),new Et(t)}toResolvedValue(e,t){const i={cache:{isRight:!1,value:void 0},factory:e,id:rt(),isSatisfiedBy:tt.always,metadata:this.#n(t),moduleId:this.#a,onActivation:void 0,onDeactivation:void 0,scope:this.#s,serviceIdentifier:this.#o,type:_};return this.#t(i),new Et(i)}toFactory(e){const t={cache:{isRight:!1,value:void 0},factory:e,id:rt(),isSatisfiedBy:tt.always,moduleId:this.#a,onActivation:void 0,onDeactivation:void 0,scope:g,serviceIdentifier:this.#o,type:y};return this.#t(t),new vt(t)}toProvider(e){const t={cache:{isRight:!1,value:void 0},id:rt(),isSatisfiedBy:tt.always,moduleId:this.#a,onActivation:void 0,onDeactivation:void 0,provider:e,scope:g,serviceIdentifier:this.#o,type:b};return this.#t(t),new vt(t)}toService(e){const t={id:rt(),isSatisfiedBy:tt.always,moduleId:this.#a,serviceIdentifier:this.#o,targetServiceIdentifier:e,type:A};this.#t(t)}#n(e){return{arguments:(e??[]).map((e=>function(e){return"object"==typeof e&&!h.is(e)}(e)?{kind:!0===e.isMultiple?J.multipleInjection:J.singleInjection,name:e.name,optional:e.optional??!1,tags:new Map((e.tags??[]).map((e=>[e.key,e.value]))),value:e.serviceIdentifier}:{kind:J.singleInjection,name:void 0,optional:!1,tags:new Map,value:e}))}}}class gt{#i;constructor(e){this.#i=e}getIdentifier(){return nt(this.#i)}onActivation(e){return this.#i.onActivation=e,new mt(this.#i)}onDeactivation(e){return this.#i.onDeactivation=e,new mt(this.#i)}}class mt{#i;constructor(e){this.#i=e}getIdentifier(){return nt(this.#i)}when(e){return this.#i.isSatisfiedBy=e,new gt(this.#i)}whenAnyAncestor(e){return this.when(st(e))}whenAnyAncestorIs(e){return this.when(st(at(e)))}whenAnyAncestorNamed(e){return this.when(function(e){return st(ot(e))}(e))}whenAnyAncestorTagged(e,t){return this.when(function(e,t){return st(ut(e,t))}(e,t))}whenDefault(){return this.when(ct)}whenNamed(e){return this.when(ot(e))}whenNoParent(e){return this.when(lt(e))}whenNoParentIs(e){return this.when(lt(at(e)))}whenNoParentNamed(e){return this.when(function(e){return lt(ot(e))}(e))}whenNoParentTagged(e,t){return this.when(function(e,t){return lt(ut(e,t))}(e,t))}whenParent(e){return this.when(dt(e))}whenParentIs(e){return this.when(dt(at(e)))}whenParentNamed(e){return this.when(function(e){return dt(ot(e))}(e))}whenParentTagged(e,t){return this.when(function(e,t){return dt(ut(e,t))}(e,t))}whenTagged(e,t){return this.when(ut(e,t))}whenNoAncestor(e){return this.when(ht(e))}whenNoAncestorIs(e){return this.when(ht(at(e)))}whenNoAncestorNamed(e){return this.when(function(e){return ht(ot(e))}(e))}whenNoAncestorTagged(e,t){return this.when(function(e,t){return ht(ut(e,t))}(e,t))}}class vt extends mt{#h;constructor(e){super(e),this.#h=new gt(e)}onActivation(e){return this.#h.onActivation(e)}onDeactivation(e){return this.#h.onDeactivation(e)}}class Et extends vt{#u;constructor(e){super(e),this.#u=new ft(e)}inRequestScope(){return this.#u.inRequestScope()}inSingletonScope(){return this.#u.inSingletonScope()}inTransientScope(){return this.#u.inTransientScope()}}const yt=Symbol.for("@inversifyjs/container/InversifyContainerError");class St extends Error{[yt];kind;constructor(e,t,i){super(t,i),this[yt]=!0,this.kind=e}static is(e){return"object"==typeof e&&null!==e&&!0===e[yt]}static isErrorOfKind(e,t){return St.is(e)&&e.kind===t}}var bt,_t;(_t=bt||(bt={}))[_t.invalidOperation=0]="invalidOperation";const At=m;class wt{#l;#c;#m;#v;#p;#_;#f;#A;#d;#E;#g;constructor(e){this.#m=this.#b(),this.#p=e=>this.#l.get(e),this.#A=new ye,this.#d=this.#S(),void 0===e?.parent?(this.#l=M.build(void 0),this.#c=P.build(void 0),this.#v=T.build(void 0)):(this.#l=M.build(e.parent.#l),this.#c=P.build(e.parent.#c),this.#v=T.build(e.parent.#v),e.parent.#A.subscribe(this.#A)),this.#_=this.#c.get.bind(this.#c),this.#E=this.#w.bind(this),this.#f={autobind:e?.autobind??!1,defaultScope:e?.defaultScope??At},this.#g=[]}bind(e){return new pt((e=>{this.#w(e)}),void 0,this.#f.defaultScope,e)}get(e,t){const i=this.#R(!1,e,t),r=this.#I(i);if(a(r))throw new St(bt.invalidOperation,`Unexpected asyncronous service when resolving service "${u(e)}"`);return r}getAll(e,t){const i=this.#R(!0,e,t),r=this.#I(i);if(a(r))throw new St(bt.invalidOperation,`Unexpected asyncronous service when resolving service "${u(e)}"`);return r}async getAllAsync(e,t){const i=this.#R(!0,e,t);return this.#I(i)}async getAsync(e,t){const i=this.#R(!1,e,t);return this.#I(i)}isBound(e,t){const i=this.#c.get(e);return this.#C(e,i,t)}isCurrentBound(e,t){const i=this.#c.getNonParentBindings(e);return this.#C(e,i,t)}async load(...e){await Promise.all(this.#e(...e))}loadSync(...e){const t=this.#e(...e);for(const e of t)if(void 0!==e)throw new St(bt.invalidOperation,"Unexpected asyncronous module load. Consider using Container.load() instead.")}onActivation(e,t){this.#l.add(t,{serviceId:e})}onDeactivation(e,t){this.#v.add(t,{serviceId:e})}restore(){const e=this.#g.pop();if(void 0===e)throw new St(bt.invalidOperation,"No snapshot available to restore");this.#l=e.activationService,this.#c=e.bindingService,this.#v=e.deactivationService,this.#B()}async rebind(e){return await this.unbind(e),this.bind(e)}rebindSync(e){return this.unbindSync(e),this.bind(e)}snapshot(){this.#g.push({activationService:this.#l.clone(),bindingService:this.#c.clone(),deactivationService:this.#v.clone()})}async unbind(e){await this.#y(e)}async unbindAll(){const e=[...this.#c.getNonParentBoundServices()];await Promise.all(e.map((async e=>Ze(this.#m,e))));for(const t of e)this.#l.removeAllByServiceId(t),this.#c.removeAllByServiceId(t),this.#v.removeAllByServiceId(t);this.#A.clearCache()}unbindSync(e){void 0!==this.#y(e)&&this.#M(e)}async unload(...e){await Promise.all(this.#P(...e)),this.#T(e)}unloadSync(...e){const t=this.#P(...e);for(const e of t)if(void 0!==e)throw new St(bt.invalidOperation,"Unexpected asyncronous module unload. Consider using Container.unload() instead.");this.#T(e)}#N(e){return{bind:t=>new pt((e=>{this.#w(e)}),e,this.#f.defaultScope,t),isBound:this.isBound.bind(this),onActivation:(t,i)=>{this.#l.add(i,{moduleId:e,serviceId:t})},onDeactivation:(t,i)=>{this.#v.add(i,{moduleId:e,serviceId:t})},rebind:this.rebind.bind(this),rebindSync:this.rebindSync.bind(this),unbind:this.unbind.bind(this),unbindSync:this.unbindSync.bind(this)}}#b(){return{getBindings:e=>this.#c.get(e),getBindingsFromModule:e=>this.#c.getByModuleId(e),getClassMetadata:U,getDeactivations:e=>this.#v.get(e)}}#O(e,t,i){return{isMultiple:e,name:i?.name,optional:i?.optional,serviceIdentifier:t,tag:i?.tag}}#D(e,t,i){const r={autobindOptions:i?.autobind??this.#f.autobind?{scope:this.#f.defaultScope}:void 0,getBindings:this.#_,getClassMetadata:U,rootConstraints:{isMultiple:t,serviceIdentifier:e},servicesBranch:[],setBinding:this.#E};return this.#F(r,i),r}#R(e,t,i){const r=this.#O(e,t,i),n=this.#A.get(r);if(void 0!==n)return n;const s=le(this.#D(t,e,i));return this.#A.set(r,s),s}#S(){return{get:this.get.bind(this),getAll:this.getAll.bind(this),getAllAsync:this.getAllAsync.bind(this),getAsync:this.getAsync.bind(this)}}#I(e){return function(e){return je(e,e.planResult.tree.root)}({context:this.#d,getActivations:this.#p,planResult:e,requestScopeCache:new Map})}#F(e,t){void 0!==t&&(void 0!==t.name&&(e.rootConstraints.name=t.name),!0===t.optional&&(e.rootConstraints.isOptional=!0),void 0!==t.tag&&(e.rootConstraints.tag={key:t.tag.key,value:t.tag.value}))}#C(e,t,i){if(void 0===t)return!1;const r={getAncestor:()=>{},name:i?.name,serviceIdentifier:e,tags:new Map};void 0!==i?.tag&&r.tags.set(i.tag.key,i.tag.value);for(const e of t)if(e.isSatisfiedBy(r))return!0;return!1}#e(...e){return e.map((e=>e.load(this.#N(e.id))))}#P(...e){return e.map((e=>function(e,t){const i=e.getBindingsFromModule(t);return Qe(e,i)}(this.#m,e.id)))}#B(){this.#A.clearCache(),this.#p=e=>this.#l.get(e),this.#_=this.#c.get.bind(this.#c),this.#d=this.#S(),this.#E=this.#w.bind(this)}#w(e){this.#c.set(e),this.#A.clearCache()}#M(e){let t;if(et(e)){const r=this.#c.getById(e.id),n=(i=r,function(e){if(void 0===e)return;const t=e.next();return!0!==t.done?t.value:void 0}(i?.[Symbol.iterator]()))?.serviceIdentifier;t=void 0===n?"Unexpected asyncronous deactivation when unbinding binding identifier. Consider using Container.unbind() instead.":`Unexpected asyncronous deactivation when unbinding "${u(n)}" binding. Consider using Container.unbind() instead.`}else t=`Unexpected asyncronous deactivation when unbinding "${u(e)}" service. Consider using Container.unbind() instead.`;var i;throw new St(bt.invalidOperation,t)}#y(e){return et(e)?this.#k(e):this.#x(e)}#k(e){const t=this.#c.getById(e.id),i=Qe(this.#m,t);if(void 0!==i)return i.then((()=>{this.#L(e)}));this.#L(e)}#L(e){this.#c.removeById(e.id),this.#A.clearCache()}#T(e){for(const t of e)this.#l.removeAllByModuleId(t.id),this.#c.removeAllByModuleId(t.id),this.#v.removeAllByModuleId(t.id);this.#A.clearCache()}#x(e){const t=Ze(this.#m,e);if(void 0!==t)return t.then((()=>{this.#G(e)}));this.#G(e)}#G(e){this.#l.removeAllByServiceId(e),this.#c.removeAllByServiceId(e),this.#v.removeAllByServiceId(e),this.#A.clearCache()}}const Rt={AudioContextManager:Symbol.for("AudioContextManager"),AudioEditor:Symbol.for("AudioEditor"),AudioProcessor:Symbol.for("AudioProcessor"),BufferManager:Symbol.for("BufferManager"),FilterManager:Symbol.for("FilterManager"),RendererManager:Symbol.for("RendererManager"),SaveBufferManager:Symbol.for("SaveBufferManager"),ConfigService:Symbol.for("ConfigService"),EventEmitter:Symbol.for("EventEmitter"),BufferPlayer:Symbol.for("BufferPlayer"),BufferDecoderService:Symbol.for("BufferDecoderService"),BufferFetcherService:Symbol.for("BufferFetcherService"),AudioBuffersToFetch:Symbol.for("AudioBuffersToFetch"),Renderers:Symbol.for("Renderers"),Filters:Symbol.for("Filters"),EntryPointFilter:Symbol.for("EntryPointFilter"),VoiceRecorder:Symbol.for("VoiceRecorder")};let It=class{constructor(){this.bufferFetcherService=null,this.bufferDecoderService=null,this.configService=null,this.eventEmitter=null}injectDependencies(e,t,i,r){e&&(this.bufferFetcherService=e),t&&(this.bufferDecoderService=t),i&&(this.configService=i),r&&(this.eventEmitter=r)}};e([Y(Rt.BufferFetcherService),i("design:type",Object)],It.prototype,"bufferFetcherService",void 0),e([Y(Rt.BufferDecoderService),i("design:type",Object)],It.prototype,"bufferDecoderService",void 0),e([Y(Rt.ConfigService),i("design:type",Object)],It.prototype,"configService",void 0),e([Y(Rt.EventEmitter),i("design:type",Object)],It.prototype,"eventEmitter",void 0),It=e([Q()],It);var Ct,Bt=It;!function(e){e.LOADING_BUFFERS="loadingBuffers",e.LOADING_BUFFERS_ERROR="loadingBuffersError",e.FETCHING_BUFFERS="fetchingBuffers",e.FETCHING_BUFFERS_ERROR="fetchingBuffersError",e.FINISHED_FETCHING_BUFFERS="finishedFetchingBuffers",e.LOADED_BUFFERS="loadedBuffers",e.COMPATIBILITY_MODE_AUTO_ENABLED="compatibilityModeAutoEnabled",e.STARTED_RENDERING_AUDIO="renderingAudio",e.RENDERING_AUDIO_PROBLEM_DETECTED="renderingAudioProblemDetected",e.AUDIO_RENDERING_FINISHED="audioRenderingFinished",e.AUDIO_RENDERING_EXCEPTION_THROWN="audioRenderingExceptionThrown",e.OFFLINE_AUDIO_RENDERING_FINISHED="offlineAudioRenderingFinished",e.PLAYING_STOPPED="playingStopped",e.PLAYING_STARTED="playingStarted",e.PLAYING_FINISHED="playingFinished",e.PLAYING_UPDATE="playingUpdate",e.RECORDER_INIT="recorderInit",e.RECORDER_SUCCESS="recorderSuccess",e.RECORDER_ERROR="recorderError",e.RECORDER_UPDATE_CONSTRAINTS="recorderUpdateConstraints",e.RECORDER_RECORDING="recorderRecording",e.RECORDER_STOPPED="recorderStopped",e.RECORDER_PAUSED="recorderPaused",e.RECORDER_RESETED="recorderReseted",e.RECORDER_COUNT_UPDATE="recorderCountUpdate",e.SAMPLE_RATE_CHANGED="sampleRateChanged",e.DECODING_AUDIO_FILE="decodingAudioFile",e.DECODED_AUDIO_FILE="decodedAudioFile",e.ERROR_DECODING_AUDIO_FILE="errorDecodingAudioFile",e.RECORDER_NOT_FOUND_ERROR="recorderNotFoundError",e.RECORDER_UNKNOWN_ERROR="recorderUnknownError",e.UPDATE_AUDIO_TREATMENT_PERCENT="updateAudioTreatmentPercent",e.UPDATE_REMAINING_TIME_ESTIMATED="updateRemainingTimeEstimated",e.CANCELLED_AND_LOADED_INITIAL_AUDIO="cancelledAndLoadedInitialAudio",e.CANCELLING_AUDIO_PROCESSING="cancellingAudioProcessing",e.PLAYING_FINISHED_LOOP_ALL="playingFinishedLoopAll",e.LOADED_AUDIO_FILE_FROM_LIST="loadedAudioFileFromList"}(Ct||(Ct={}));const Mt={calcAudioDuration:(e,t)=>{if(e){let i=e.duration+1;return t&&(i/=t),i}return 0},loadAudioBuffer:(e,t)=>r(void 0,void 0,void 0,(function*(){const i=yield Mt.readAsArrayBufferPromisified(t),r=yield e.decodeAudioData(i);return Mt.decodeBuffer(e,r)})),readAsArrayBufferPromisified:e=>new Promise(((t,i)=>{const r=new FileReader;r.onload=e=>{var r;const n=null===(r=null==e?void 0:e.target)||void 0===r?void 0:r.result;n instanceof ArrayBuffer?t(n):i()},e&&r.readAsArrayBuffer(e)})),decodeBuffer:(e,t)=>{if(1==t.numberOfChannels){e.resume();const i=t.duration,r=e.sampleRate,n=e.createBuffer(2,r*i+2*r,r),s=t.getChannelData(0),o=n.getChannelData(0),a=n.getChannelData(1);for(let e=0;e<s.length;e++)o[e]=s[e],a[e]=s[e];return n}return t},convertAudioBufferToFloat32Array:e=>{const t=[];for(let i=0;i<e.numberOfChannels;i++)t.push(e.getChannelData(i));return t},convertAudioParamToFloat32Array:(e,t)=>{const i=new Float32Array(t);for(let r=0;r<t;r++)i.set([e.value],r);return i},sumAudioBufferChannel:(e,t)=>e.getChannelData(t).reduce(((e,t)=>e+t),0),sumAudioBuffer(e){let t=0;for(let i=0;i<e.numberOfChannels;i++)t+=this.sumAudioBufferChannel(e,i);return t},isAudioWorkletCompatible:e=>void 0!==e&&void 0!==e.audioWorklet,isSettingValueValid:e=>!(void 0===e||isNaN(Number(e))||"string"==typeof e&&""===e.trim()),calculateAudioDuration(e,t,i){if(e&&t){return this.calcAudioDuration(e,i)+t.getAddingTime()}return 0},resetAudioRenderingProgress(e){e&&(e.emit(Ct.UPDATE_AUDIO_TREATMENT_PERCENT,0),e.emit(Ct.UPDATE_REMAINING_TIME_ESTIMATED,-1))},forceDownload(e,t){const i=window.document.createElement("a"),r=URL.createObjectURL(e);window.document.body.appendChild(i),i.href=r,i.download=t||"output.wav",i.click(),URL.revokeObjectURL(r),window.document.body.removeChild(i)},clearAudioBuffer(e){if(e)for(let t=0;t<e.numberOfChannels;t++){const i=e.getChannelData(t);for(let e=0;e<i.length;e++)i[e]=0}}};let Pt=class extends Bt{constructor(e,t,i,r,n,s,o){super(),this.principalBuffer=null,this.fileList=null,this.fileListCurrIndex=0,this.loadingAudio=!1,this.renderingAudio=!1,this.filterManager=e,this.rendererManager=t,this.contextManager=i,this.saveBufferManager=r,this.audioProcessor=n,this.bufferManager=s,this.bufferPlayer=o,this.setup()}setup(){this.bufferPlayer&&(this.bufferPlayer.onBeforePlaying((()=>r(this,void 0,void 0,(function*(){this.bufferPlayer&&this.bufferPlayer.compatibilityMode&&this.contextManager&&this.contextManager.currentContext&&this.audioProcessor&&(yield this.audioProcessor.setupOutput(this.principalBuffer,this.contextManager.currentContext))})))),this.bufferPlayer.on(Ct.PLAYING_FINISHED,(()=>{this.bufferPlayer&&this.bufferPlayer.loop&&this.bufferPlayer.start()})),this.bufferPlayer.on(Ct.PLAYING_FINISHED_LOOP_ALL,(()=>r(this,void 0,void 0,(function*(){this.bufferPlayer&&this.bufferPlayer.loopAll&&!this.renderingAudio&&!this.loadingAudio&&(yield this.loadNextAudio(!0),this.bufferPlayer.start())})))))}addFilters(...e){this.filterManager&&this.filterManager.addFilters(...e)}addRenderers(...e){this.rendererManager&&this.rendererManager.addRenderers(...e)}get currentSampleRate(){return this.contextManager?this.contextManager.currentSampleRate:0}get defaultDeviceSampleRate(){const e=new AudioContext;let t=0;return e&&(t=e.sampleRate,e.close()),t}loadBufferFromFile(e){return r(this,void 0,void 0,(function*(){if(this.clearBuffers(),this.loadingAudio=!0,this.audioProcessor&&(yield this.audioProcessor.prepareContext(this.principalBuffer)),!(this.contextManager&&this.contextManager.currentContext&&this.bufferDecoderService&&this.audioProcessor))throw this.loadingAudio=!1,new Error("Audio Context is not ready!");if(this.principalBuffer=yield this.bufferDecoderService.decodeBufferFromFile(e),this.audioProcessor.initialRenderingDone=!1,!this.principalBuffer)throw this.loadingAudio=!1,new Error("Error decoding audio file");this.audioProcessor.sumInputBuffer=Mt.sumAudioBuffer(this.principalBuffer),Mt.resetAudioRenderingProgress(this.eventEmitter),this.bufferPlayer&&this.bufferPlayer.loopAll&&this.totalFileList<=1&&this.bufferPlayer.toggleLoop(),this.loadingAudio=!1}))}loadFileList(e){return r(this,void 0,void 0,(function*(){this.fileList=e,yield this.loadBufferFromFileListIndex(0)}))}loadBufferFromFileListIndex(e){return r(this,void 0,void 0,(function*(){if(this.fileList){this.fileListCurrIndex=e;const t=this.fileList.item(this.fileListCurrIndex);this.eventEmitter&&this.eventEmitter.emit(Ct.LOADED_AUDIO_FILE_FROM_LIST,e),t&&(yield this.loadBufferFromFile(t))}}))}loadPreviousAudio(e){return r(this,void 0,void 0,(function*(){const t=this.currentIndexFileList,i=this.totalFileList,r=t-1;r!=t&&(r<0?yield this.loadBufferFromFileListIndex(i-1):yield this.loadBufferFromFileListIndex(r),yield this.renderAudio(e))}))}loadNextAudio(e){return r(this,void 0,void 0,(function*(){const t=this.currentIndexFileList,i=this.totalFileList,r=t+1;r!=t&&(r>=i?yield this.loadBufferFromFileListIndex(0):yield this.loadBufferFromFileListIndex(r),yield this.renderAudio(e))}))}getCurrentFileList(){if(this.fileList){const e=new Map;for(let t=0;t<this.fileList.length;t++){const i=this.fileList.item(t);i&&e.set(i.name,this.currentIndexFileList===t)}return e}return new Map}get currentIndexFileList(){return this.fileListCurrIndex}get totalFileList(){return this.fileList?this.fileList.length:0}loadBuffer(e){this.principalBuffer=e,this.audioProcessor&&(this.audioProcessor.sumInputBuffer=Mt.sumAudioBuffer(this.principalBuffer),this.audioProcessor.initialRenderingDone=!1)}getOutputBuffer(){return this.audioProcessor?this.audioProcessor.renderedBuffer:null}renderAudio(e){return r(this,void 0,void 0,(function*(){if(this.audioProcessor)try{this.renderingAudio=!0,this.eventEmitter&&this.eventEmitter.emit(Ct.STARTED_RENDERING_AUDIO);const t=yield this.audioProcessor.renderAudio(this.principalBuffer,e);return this.eventEmitter&&this.eventEmitter.emit(Ct.AUDIO_RENDERING_FINISHED),this.renderingAudio=!1,t}catch(e){this.eventEmitter&&(this.eventEmitter.emit(Ct.AUDIO_RENDERING_FINISHED),this.eventEmitter.emit(Ct.AUDIO_RENDERING_EXCEPTION_THROWN,e)),this.renderingAudio=!1}return!1}))}isAudioWorkletAvailable(){return!(!this.contextManager||!this.contextManager.currentContext)&&Mt.isAudioWorkletCompatible(this.contextManager.currentContext)}getFiltersState(){return this.filterManager&&this.rendererManager?Object.assign(Object.assign({},this.filterManager.getFiltersState()),this.rendererManager.getRenderersState()):{}}getFiltersSettings(){return this.filterManager?this.filterManager.getFiltersSettings():new Map}reconnectNodesIfNeeded(){return r(this,void 0,void 0,(function*(){if(this.contextManager&&this.bufferPlayer&&this.bufferPlayer.compatibilityMode&&this.contextManager.currentContext&&this.principalBuffer&&this.filterManager&&this.filterManager.entrypointFilter){yield this.filterManager.connectNodes(this.contextManager.currentContext,this.principalBuffer,!0,this.bufferPlayer.compatibilityMode);const e=this.filterManager.entrypointFilter.getSpeed();this.bufferPlayer.speedAudio=e,this.bufferPlayer.duration=Mt.calculateAudioDuration(this.principalBuffer,this.filterManager,e)*e}}))}enableFilter(e){this.rendererManager&&this.rendererManager.enableRenderer(e),this.filterManager&&(this.filterManager.enableFilter(e),this.reconnectNodesIfNeeded())}disableFilter(e){this.rendererManager&&this.rendererManager.disableRenderer(e),this.filterManager&&(this.filterManager.disableFilter(e),this.reconnectNodesIfNeeded())}toggleFilter(e){this.rendererManager&&this.rendererManager.toggleRenderer(e),this.filterManager&&(this.filterManager.toggleFilter(e),this.reconnectNodesIfNeeded())}changeFilterSettings(e,t){return r(this,void 0,void 0,(function*(){this.filterManager&&(yield this.filterManager.changeFilterSettings(e,t),yield this.reconnectNodesIfNeeded())}))}resetFilterSettings(e){return r(this,void 0,void 0,(function*(){this.filterManager&&(yield this.filterManager.resetFilterSettings(e),yield this.reconnectNodesIfNeeded())}))}resetAllFiltersState(){this.rendererManager&&this.rendererManager.resetAllRenderersState(),this.filterManager&&(this.filterManager.resetAllFiltersState(),this.reconnectNodesIfNeeded())}exit(){this.bufferPlayer&&(this.bufferPlayer.stop(),this.bufferPlayer.reset()),this.cancelAudioRendering(),this.clearBuffers(),this.fileList=null,this.fileListCurrIndex=0}clearBuffers(){Mt.clearAudioBuffer(this.principalBuffer),this.principalBuffer=null,this.audioProcessor&&this.audioProcessor.clearRenderedBuffer()}cancelAudioRendering(){this.audioProcessor&&this.audioProcessor.cancelAudioRendering()}on(e,t){this.eventEmitter&&this.eventEmitter.on(e,t)}off(e,t){this.eventEmitter&&this.eventEmitter.off(e,t)}saveBuffer(e){return r(this,void 0,void 0,(function*(){var t;return!(!this.saveBufferManager||!this.audioProcessor)&&(yield null===(t=this.saveBufferManager)||void 0===t?void 0:t.saveBuffer(this.audioProcessor.renderedBuffer,e))}))}set downloadingInitialData(e){this.bufferManager&&(this.bufferManager.downloadingInitialData=e)}get downloadingInitialData(){return!!this.bufferManager&&this.bufferManager.downloadingInitialData}};Pt=e([Q(),t(0,Y(Rt.FilterManager)),t(1,Y(Rt.RendererManager)),t(2,Y(Rt.AudioContextManager)),t(3,Y(Rt.SaveBufferManager)),t(4,Y(Rt.AudioProcessor)),t(5,Y(Rt.BufferManager)),t(6,Y(Rt.BufferPlayer)),i("design:paramtypes",[Object,Object,Object,Object,Object,Object,Object])],Pt);var Tt=Pt;let Nt=class extends Bt{constructor(e){super(),this.buffer=null,this.source=null,this.gainNode=null,this.intervals=[],this.onBeforePlayingCallback=()=>r(this,void 0,void 0,(function*(){})),this._volume=1,this.currentTime=0,this.displayTime=0,this.duration=0,this.playing=!1,this.loop=!1,this.loopAll=!1,this.speedAudio=1,this.compatibilityMode=!1,this.currentNode=null,this._contextManager=e}init(e){this.playing=!1,this._contextManager&&this._contextManager.currentContext&&(this._contextManager.currentContext.resume(),!this.compatibilityMode&&this.buffer&&(null==this.source||e||(this.source.buffer=null,this.source.disconnect()),this.source=this._contextManager.currentContext.createBufferSource(),this.source.buffer=this.buffer,this.gainNode=this._contextManager.currentContext.createGain(),this.setGainNodeValue(),this.duration=this.buffer.duration*this.speedAudio,this.source.connect(this.gainNode),this.gainNode.connect(this._contextManager.currentContext.destination))),this.updateInfos()}loadBuffer(e){this.compatibilityMode=!1,this.reset(),this.buffer=e,this.init()}setCompatibilityMode(e,t){this.compatibilityMode=!0,this.reset(),this.init(),null!=t&&(this.duration=t*this.speedAudio),this.currentNode=e,this.updateInfos()}reset(e){this.clearIntervals(),this.currentTime=0,this.displayTime=0,e||this.stop()}stop(){var e;this.clearIntervals(),null!=this.source&&null!=this.source&&this.playing&&(this.source.stop(0),this.playing=!1),this.currentNode&&(this.currentNode.disconnect(),this.compatibilityMode&&(this.currentTime=0,this.displayTime=0)),null===(e=this.eventEmitter)||void 0===e||e.emit(Ct.PLAYING_STOPPED),this.updateInfos()}clearIntervals(){for(const e of this.intervals)clearInterval(e);this.intervals=[]}start(e){return r(this,void 0,void 0,(function*(){var t;if(this.source||this.compatibilityMode){if(e||this.stop(),this.init(e),yield this.onBeforePlayingCallback(),null===(t=this.eventEmitter)||void 0===t||t.emit(Ct.PLAYING_STARTED),this.compatibilityMode){if(!(this.currentNode&&this._contextManager&&this._contextManager.currentContext))return;this.currentNode.connect(this._contextManager.currentContext.destination)}else{if(!this.source)return;this.source.start(0,e?0:this.currentTime/this.speedAudio),this.playing=!0}let i=performance.now();this.intervals.push(window.setInterval((()=>{var t,r,n;const s=performance.now(),o=s-i;i=s,this.currentTime+=o/1e3*this.speedAudio,this.displayTime=this.currentTime,this.currentTime>this.duration?this.loop?this.compatibilityMode?null===(t=this.eventEmitter)||void 0===t||t.emit(Ct.PLAYING_FINISHED):(this.reset(e),this.start()):(null===(r=this.eventEmitter)||void 0===r||r.emit(Ct.PLAYING_FINISHED),this.reset(e),this.loopAll&&(null===(n=this.eventEmitter)||void 0===n||n.emit(Ct.PLAYING_FINISHED_LOOP_ALL))):this.updateInfos()}),100))}}))}playDirect(){return r(this,void 0,void 0,(function*(){this.compatibilityMode?this.start(!1):this.start(!0)}))}pause(){this.stop()}updateInfos(){var e;null===(e=this.eventEmitter)||void 0===e||e.emit(Ct.PLAYING_UPDATE)}setTimePercent(e){this.compatibilityMode||(this.currentTime=Math.round(this.duration*(e/100)),this.displayTime=this.currentTime,this.playing?(this.pause(),this.start()):this.updateInfos())}setTime(e){this.compatibilityMode||(this.currentTime=e,this.displayTime=this.currentTime,this.playing?(this.pause(),this.start()):this.updateInfos())}set volume(e){this._volume=e,this.setGainNodeValue()}setGainNodeValue(){this.gainNode&&(this.gainNode.gain.value=Math.pow(this._volume,2))}get volume(){return this._volume}onBeforePlaying(e){this.onBeforePlayingCallback=e}toggleLoop(){this.loopAll=!1,this.loop=!this.loop}toggleLoopAll(){this.loop=!1,this.loopAll=!this.loopAll}on(e,t){this.eventEmitter&&this.eventEmitter.on(e,t)}get currentTimeDisplay(){return("0"+Math.trunc(this.displayTime/60)).slice(-2)+":"+("0"+Math.trunc(this.displayTime%60)).slice(-2)}get maxTimeDisplay(){return("0"+Math.trunc(this.duration/60)).slice(-2)+":"+("0"+Math.trunc(this.duration%60)).slice(-2)}get percent(){return 100-Math.round((this.duration-this.displayTime)/this.duration*100)}get remainingTimeDisplay(){return("0"+Math.trunc((this.duration-this.displayTime)/60)).slice(-2)+":"+("0"+Math.trunc((this.duration-this.displayTime)%60)).slice(-2)}};Nt=e([Q(),t(0,Y(Rt.AudioContextManager)),i("design:paramtypes",[Object])],Nt);var Ot=Nt;class Dt{constructor(e,t){this.seconds=0,this.initialSeconds=0,this.interval=null,this.incr=1,this.countCallback=()=>{},this.seconds=e,this.initialSeconds=e,this.incr=t}start(){this.interval=window.setInterval((()=>this.count()),1e3)}stop(){clearInterval(this.interval)}count(){this.seconds+=this.incr,this.seconds<=0&&this.stop(),this.countCallback&&this.countCallback()}onCount(e){this.countCallback=e}}const Ft={REVERB:"reverb",ECHO:"echo",BASS_BOOST:"bassboost",BITCRUSHER:"bitcrusher",HIGH_PASS:"highpass",LIMITER:"limiter",LOW_PASS:"lowpass",PASSTHROUGH:"passthroughfilter",RETURN_AUDIO:"returnAudio",SOUNDTOUCH:"soundtouch",TELEPHONIZER:"telephonizer",VOCODER:"vocoder"},kt={AUDIO_EDITOR:"audioEditor",VOICE_RECORDER:"voiceRecorder",BUFFER_PLAYER:"bufferPlayer",AUDIO_CONTEXT_MANAGER:"audioContextManager",AUDIO_PROCESSOR:"audioProcessor",BUFFER_MANAGER:"bufferManager",FILTER_MANAGER:"filterManager",RENDERER_MANAGER:"rendererManager",SAVE_BUFFER_MANAGER:"saveBufferManager",EXPORT_WAV_COMMAND:"exportWAV",EXPORT_MP3_COMMAND:"exportMP3",AUDIO_WAV:"audio/wav",AUDIO_MP3:"audio/mp3",RECORD_COMMAND:"record",INIT_COMMAND:"init",FILTERS_NAMES:Ft,WORKLET_PATHS:{BITCRUSHER:"BitCrusher.worklet.js",LIMITER:"Limiter.worklet.js",SOUNDTOUCH:"Soundtouch.worklet.js",RECORDER_WORKLET:"RecorderWorklet.js",PASSTHROUGH:"Passthrough.worklet.js"},WORKLET_NAMES:{BITCRUSHER:"bitcrusher-processor",LIMITER:"limiter-processor",SOUNDTOUCH:"soundtouch-worklet",RECORDER_WORKLET:"recorder-worklet",PASSTHROUGH:"passthrough"},PREFERENCES_KEYS:{COMPATIBILITY_MODE_ENABLED:"compatibility-mode-enabled",COMPATIBILITY_MODE_CHECKED:"compatibility-mode-checked",ENABLE_AUDIO_WORKLET:"enable-audio-worklet",ENABLE_SOUNDTOUCH_AUDIO_WORKLET:"enable-soundtouch-audio-worklet",BUFFER_SIZE:"buffer-size",SAMPLE_RATE:"sample-rate",DISABLE_INITIAL_RENDERING:"disable-initial-rendering",BITRATE_MP3:"bitrate-mp3"},ENABLE_SOUNDTOUCH_AUDIO_WORKLET:!0,ENABLE_AUDIO_WORKLET:!0,ENABLE_RECORDER_AUDIO_WORKLET:!0,SOUNDTOUCH_PITCH_SHIFTER_BUFFER_SIZE:16384,DEFAULT_REVERB_ENVIRONMENT:{name:"Medium Damping Cave E002 M2S",url:"impulse_response.wav",size:1350278,addDuration:4,link:"http://www.cksde.com/p_6_250.htm"},VOCODER_MODULATOR:"modulator.mp3",DEFAULT_BUFFER_SIZE:0,VALID_BUFFER_SIZE:[0,256,512,1024,2048,4096,8192,16384],VALID_MP3_BITRATES:[32,64,96,128,160,256,320],DEFAULT_SAMPLE_RATE:0,VALID_SAMPLE_RATES:[0,8e3,11025,16e3,22050,32e3,44100,48e3,88200,96e3,176400,192e3],TREATMENT_TIME_COUNTING_THROTTLE_INTERVAL:100,TREATMENT_TIME_COUNTING_SMOOTHING_FACTOR:.9,DISABLE_INITIAL_RENDERING:!1,DEFAULT_SAVE_FORMAT:"wav",DEFAULT_MP3_BITRATE:320};function xt(e){return new Worker((e||"")+"RecorderWorker.js")}let Lt=class{constructor(e){this.worker=null,this.node=null,this.context=null,this.config={bufferLen:4096,sampleRate:44100,numChannels:2,mimeType:"audio/wav",workletBasePath:"worklets/",workerBasePath:"workers/",bitrate:kt.DEFAULT_MP3_BITRATE,callback:()=>{}},this.callbacks={getBuffer:[],exportWAV:[],exportMP3:[]},this.recording=!1,Object.assign(this.config,e)}setup(e){return r(this,void 0,void 0,(function*(){this.node&&(this.node instanceof AudioWorkletNode&&this.node.port.postMessage("stop"),this.node.disconnect()),e&&(this.context=e.context,yield this.createRecorderNode(),this.node&&this.context&&(e.connect(this.node),this.node.connect(this.context.destination))),this.context&&!this.worker&&(this.worker=xt(this.config.workerBasePath),this.worker&&(this.worker.postMessage({command:"init",config:{sampleRate:this.context.sampleRate,numChannels:this.config.numChannels,bitrate:this.config.bitrate}}),this.worker.onmessage=e=>{let t=null;switch(e.data.command){case"getBuffer":t=this.callbacks.getBuffer;break;case kt.EXPORT_WAV_COMMAND:t=this.callbacks.exportWAV;break;case kt.EXPORT_MP3_COMMAND:t=this.callbacks.exportMP3}if(t){const i=t.pop();"function"==typeof i&&i(e.data.data)}}))}))}createRecorderNode(){return r(this,void 0,void 0,(function*(){if(this.context)if(Mt.isAudioWorkletCompatible(this.context)&&kt.ENABLE_RECORDER_AUDIO_WORKLET)try{yield this.createRecorderWorklet()}catch(e){console.error(e),this.createRecorderScriptProcessorNode()}else this.createRecorderScriptProcessorNode()}))}createRecorderWorklet(){return r(this,void 0,void 0,(function*(){if(this.context&&(yield this.context.audioWorklet.addModule(this.config.workletBasePath+kt.WORKLET_PATHS.RECORDER_WORKLET),this.node=new AudioWorkletNode(this.context,kt.WORKLET_NAMES.RECORDER_WORKLET),this.node&&this.node.port)){const e=this.node.parameters.get("numChannels");e&&(e.value=this.config.numChannels,e.setValueAtTime(this.config.numChannels,0)),this.node.port.onmessage=e=>{this.worker&&"record"==e.data.command&&e.data.buffer.length>0&&this.worker.postMessage({command:"record",buffer:e.data.buffer})}}}))}createRecorderScriptProcessorNode(){this.context&&(this.node=this.context.createScriptProcessor.call(this.context,this.config.bufferLen,this.config.numChannels,this.config.numChannels),this.node.onaudioprocess=e=>{if(!this.recording)return;const t=[];for(let i=0;i<this.config.numChannels;i++)t.push(e.inputBuffer.getChannelData(i));this.worker&&this.worker.postMessage({command:"record",buffer:t})})}record(){this.recording=!0,this.node instanceof AudioWorkletNode&&this.node.port.postMessage("record")}stop(){this.recording=!1,this.node instanceof AudioWorkletNode&&this.node.port.postMessage("stop")}clear(){this.worker&&this.worker.postMessage({command:"clear"})}kill(){this.clear(),this.stop(),this.worker&&this.worker.terminate()}getBuffer(e){if(!(e=e||this.config.callback))throw new Error("Callback not set");this.callbacks.getBuffer.push(e),this.worker&&this.worker.postMessage({command:"getBuffer"})}exportWAV(e,t){if(t=t||this.config.mimeType,!(e=e||this.config.callback))throw new Error("Callback not set");this.callbacks.exportWAV.push(e),this.worker&&this.worker.postMessage({command:kt.EXPORT_WAV_COMMAND,type:t})}exportMP3(e,t){if(t=t||this.config.mimeType,!(e=e||this.config.callback))throw new Error("Callback not set");this.callbacks.exportMP3.push(e),this.worker&&this.worker.postMessage({command:kt.EXPORT_MP3_COMMAND,type:t})}};Lt=e([Q(),i("design:paramtypes",[Object])],Lt);var Gt=Lt;let Ut=class extends Bt{constructor(e,t){super(),this.recorder=null,this.input=null,this.stream=null,this.alreadyInit=!1,this.timer=null,this.enableAudioFeedback=!1,this.recording=!1,this.deviceList=[],this.constraints={audio:{noiseSuppression:!0,echoCancellation:!0,autoGainControl:!0,sampleRate:{ideal:44100}}},this.sampleRateConfigNotSupported=!1,this.contextManager=e,this.configService=t}init(){return r(this,void 0,void 0,(function*(){var e;if(this.isRecordingAvailable()){this.sampleRateConfigNotSupported=!navigator.mediaDevices.getSupportedConstraints().sampleRate,this.contextManager&&(this.sampleRateConfigNotSupported?this.contextManager.createNewContext(0):this.contextManager.createNewContextIfNeeded()),null===(e=this.eventEmitter)||void 0===e||e.emit(Ct.RECORDER_INIT);try{const e=yield navigator.mediaDevices.getUserMedia(this.constraints);this.contextManager&&this.contextManager.currentContext&&this.contextManager.currentContext.resume(),yield this.setup(e,!1,!1),this.alreadyInit=!0,this.timer=new Dt(0,1),this.timer.onCount((()=>{var e;null===(e=this.eventEmitter)||void 0===e||e.emit(Ct.RECORDER_COUNT_UPDATE)})),this.successCallback()}catch(e){console.error(e);if(e)switch(e.name){case"SecurityError":case"NotAllowedError":this.errorCallback();break;case"NotFoundError":this.notFoundErrorCallback();break;case"NotSupportedError":this.sampleRateConfigNotSupported||(this.sampleRateConfigNotSupported=!0,this.init());break;default:this.unknownErrorCallback()}}navigator.mediaDevices.ondevicechange=()=>this.updateInputList()}}))}successCallback(){var e;null===(e=this.eventEmitter)||void 0===e||e.emit(Ct.RECORDER_SUCCESS)}errorCallback(){var e;null===(e=this.eventEmitter)||void 0===e||e.emit(Ct.RECORDER_ERROR)}notFoundErrorCallback(){var e;null===(e=this.eventEmitter)||void 0===e||e.emit(Ct.RECORDER_NOT_FOUND_ERROR)}unknownErrorCallback(){var e;null===(e=this.eventEmitter)||void 0===e||e.emit(Ct.RECORDER_UNKNOWN_ERROR)}audioFeedback(e){var t;this.contextManager&&this.contextManager.currentContext&&(e?(this.input&&this.input.connect(this.contextManager.currentContext.destination),this.enableAudioFeedback=!0):(this.input&&(this.input.connect(this.contextManager.currentContext.destination),this.input.disconnect(this.contextManager.currentContext.destination)),this.enableAudioFeedback=!1),null===(t=this.eventEmitter)||void 0===t||t.emit(Ct.RECORDER_UPDATE_CONSTRAINTS))}getConstraints(){if(this.stream){const e=this.stream.getTracks();if(e&&e.length>0)return e[0].getSettings()}return null}updateConstraints(){var e;const t=this.getConstraints();t&&(this.constraints.audio=Object.assign(this.constraints.audio,t),null===(e=this.eventEmitter)||void 0===e||e.emit(Ct.RECORDER_UPDATE_CONSTRAINTS))}resetConstraints(e){return r(this,void 0,void 0,(function*(){if(this.stream){const t=this.enableAudioFeedback,i=this.recording,r=this.stream.getTracks();if(e&&(this.updateConstraints(),this.constraints.audio=Object.assign(this.constraints.audio,e.audio)),r&&r.length>0)try{yield r[0].applyConstraints(this.constraints.audio);const n=this.getConstraints(),s=e?Object.keys(e.audio)[0]:"";if(this.audioFeedback(!1),this.pause(),!e||n&&n[s]!=e.audio[s]){this.stopStream();const e=yield navigator.mediaDevices.getUserMedia(this.constraints);yield this.setup(e,i,t)}else yield this.setup(null,i,t)}catch(e){console.error(e),this.errorCallback()}}}))}setup(e,t,i){return r(this,void 0,void 0,(function*(){e&&this.contextManager&&this.contextManager.currentContext&&(this.input=this.contextManager.currentContext.createMediaStreamSource(e),this.stream=e),this.recorder&&this.input&&(yield this.recorder.setup(this.input),t&&(yield this.record())),this.audioFeedback(i),this.updateConstraints(),yield this.updateInputList()}))}setNoiseSuppression(e){this.resetConstraints({audio:{noiseSuppression:e}})}setAutoGain(e){this.resetConstraints({audio:{autoGainControl:e}})}setEchoCancellation(e){this.resetConstraints({audio:{echoCancellation:e}})}updateInputList(){return r(this,void 0,void 0,(function*(){if(this.deviceList){const e=yield navigator.mediaDevices.enumerateDevices();this.deviceList=[],e.forEach((e=>{"audioinput"==e.kind&&this.deviceList.push(e)}))}}))}changeInput(e,t){t&&(this.constraints.audio.deviceId=e,this.constraints.audio.groupId=t,this.resetConstraints())}record(){return r(this,void 0,void 0,(function*(){this.alreadyInit&&this.configService&&this.input&&(this.recorder||(this.recorder=new Gt({bufferLen:this.configService.getBufferSize(),sampleRate:this.configService.getSampleRate(),numChannels:2,workletBasePath:this.configService.getWorkletBasePath(),workerBasePath:this.configService.getWorkerBasePath(),mimeType:"audio/wav"}),yield this.recorder.setup(this.input)),this.recorder&&this.recorder.record(),this.timer&&this.timer.start(),this.recording=!0,this.eventEmitter&&this.eventEmitter.emit(Ct.RECORDER_RECORDING))}))}stop(){return r(this,void 0,void 0,(function*(){this.alreadyInit&&this.recorder&&(this.recorder.stop(),this.timer&&this.timer.stop(),this.recording=!1,this.recorder.getBuffer((e=>{var t;if(this.contextManager&&this.contextManager.currentContext){this.contextManager.currentContext.resume();const i=this.contextManager.currentContext.createBuffer(2,e[0].length,this.contextManager.currentContext.sampleRate);i.getChannelData(0).set(e[0]),i.getChannelData(1).set(e[1]),null===(t=this.eventEmitter)||void 0===t||t.emit(Ct.RECORDER_STOPPED,i),this.reset()}})))}))}pause(){var e;this.alreadyInit&&(this.recorder&&this.recorder.stop(),this.timer&&this.timer.stop(),this.recording=!1,null===(e=this.eventEmitter)||void 0===e||e.emit(Ct.RECORDER_PAUSED))}stopStream(){if(this.stream){const e=this.stream.getTracks();for(let t=0,i=e.length;t<i;t++)e[t].stop()}}reset(){var e;this.recorder&&this.recorder.kill(),this.timer&&this.timer.stop(),this.audioFeedback(!1),this.stopStream(),this.input=null,this.recorder=null,this.stream=null,this.alreadyInit=!1,this.timer=null,null===(e=this.eventEmitter)||void 0===e||e.emit(Ct.RECORDER_RESETED)}get currentTimeDisplay(){var e,t,i;return(null===(e=this.timer)||void 0===e?void 0:e.seconds)?("0"+Math.trunc((null===(t=this.timer)||void 0===t?void 0:t.seconds)/60)).slice(-2)+":"+("0"+Math.trunc((null===(i=this.timer)||void 0===i?void 0:i.seconds)%60)).slice(-2):"00:00"}get currentTime(){return this.timer?this.timer.seconds:0}getSettings(){return{deviceList:this.deviceList,audioFeedback:this.enableAudioFeedback,constraints:this.constraints.audio}}on(e,t){var i;null===(i=this.eventEmitter)||void 0===i||i.on(e,t)}isRecordingAvailable(){return void 0!==navigator.mediaDevices&&void 0!==navigator.mediaDevices.getUserMedia}};Ut=e([Q(),t(0,Y(Rt.AudioContextManager)),t(1,Y(Rt.ConfigService)),i("design:paramtypes",[Object,Object])],Ut);var Wt=Ut;let Vt=class extends Bt{constructor(){super(...arguments),this.enabled=!1,this.defaultEnabled=!1}isEnabled(){return this.enabled}isDefaultEnabled(){return this.defaultEnabled}setDefaultEnabled(e){this.defaultEnabled=e,e?this.enable():this.disable()}setEnabled(e){this.enabled=e}enable(){this.setEnabled(!0)}disable(){this.setEnabled(!1)}toggle(){this.setEnabled(!this.isEnabled())}};Vt=e([Q()],Vt);var jt=Vt;class qt extends jt{constructor(){super(...arguments),this.defaultSettings=null,this._totalSamples=0}getAddingTime(){return 0}initializeDefaultSettings(){this.defaultSettings=this.getSettings()}getDefaultSettings(){return this.defaultSettings}resetSettings(){return r(this,void 0,void 0,(function*(){if(this.defaultSettings)for(const e in this.defaultSettings)this.defaultSettings&&void 0!==this.defaultSettings[e]&&(yield this.setSetting(e,this.defaultSettings[e]))}))}isWorklet(){return!1}bufferFetcherReseted(){return r(this,void 0,void 0,(function*(){return!1}))}set totalSamples(e){this._totalSamples=e}}class Ht{constructor(e,t){this._value=0,this._minValue=0,this._maxValue=Number.MAX_SAFE_INTEGER,this._defaultValue=0,this.context=null,this.automationRate="a-rate",this._defaultValue=void 0!==t?t:0,this._value=this._defaultValue,this.context=e}get value(){return this._value}set value(e){this._value=Math.max(this._minValue,Math.min(this._maxValue,e))}get minValue(){return this._minValue}get maxValue(){return this._maxValue}get defaultValue(){return this._defaultValue}setValueAtTime(e,t){return console.warn("setValueAtTime used with AudioParamPolyfill, is not fully compatible with standard AudioParam"),this.value=e,new Ht(this.context,e)}linearRampToValueAtTime(e,t){return console.warn("linearRampToValueAtTime used with AudioParamPolyfill, is not fully compatible with standard AudioParam"),this.value=e,new Ht(this.context,e)}exponentialRampToValueAtTime(e,t){return console.warn("exponentialRampToValueAtTime used with AudioParamPolyfill, is not fully compatible with standard AudioParam"),this.value=e,new Ht(this.context,e)}cancelAndHoldAtTime(e){throw new Error("Method not implemented.")}cancelScheduledValues(e){throw new Error("Method not implemented.")}setTargetAtTime(e,t,i){throw new Error("Method not implemented.")}setValueCurveAtTime(e,t,i){throw new Error("Method not implemented.")}}class Kt{constructor(e,t,i){this._parameters=new Map,this._port=null,this.currentContext=null,this.workletProcessor=t,this.currentContext=e,this._scriptProcessorNode=e.createScriptProcessor(i,2,2),this.setupPort(),this.setupProcessor(),this.setupWorkletScope(e)}setupPort(){const e=new MessageChannel;e.port1.onmessage=e=>{this.workletProcessor&&this.workletProcessor.port2&&this.workletProcessor.port2.postMessage(e.data)},this.workletProcessor&&this.workletProcessor.port2&&(this.workletProcessor.port2.onmessage=t=>{e.port1.postMessage(t.data)}),this._port=e.port2}setupProcessor(){if(!this._scriptProcessorNode)return;this._scriptProcessorNode.onaudioprocess=e=>{if(this.workletProcessor){const t=[Mt.convertAudioBufferToFloat32Array(e.inputBuffer)],i=[Mt.convertAudioBufferToFloat32Array(e.outputBuffer)],r=[];for(const[e,t]of this._parameters.entries())r.push([e,Mt.convertAudioParamToFloat32Array(t,1)]);const n=Object.fromEntries(r);this.workletProcessor.process(t,i,n)}};const e=this.workletProcessor.defaultParameterDescriptors;e&&e.forEach((e=>{this.currentContext&&this._parameters.set(e.name,new Ht(this.currentContext,e.defaultValue))}))}setupWorkletScope(e){"undefined"!=typeof window&&(window.sampleRate=e.sampleRate)}get port(){return this._port}get parameters(){return this._parameters}get node(){return this._scriptProcessorNode}get context(){var e;return null===(e=this._scriptProcessorNode)||void 0===e?void 0:e.context}}class $t{static registerProcessor(e,t){$t.processorsMap.set(e,t)}static getProcessor(e){const t=$t.processorsMap.get(e);return t?new t:null}}$t.processorsMap=new Map;class Yt{constructor(){this.messageChannel=null,this.messageChannel=new MessageChannel}process(e,t,i){return!0}get port(){return this.messageChannel&&this.messageChannel.port1}get port2(){return this.messageChannel&&this.messageChannel.port2}get parameters(){throw new Error("Method not implemented.")}get parameterDescriptors(){throw new Error("Method not implemented.")}get defaultParameterDescriptors(){return[]}}"undefined"==typeof window||"AudioWorkletProcessor"in window||(window.AudioWorkletProcessor=Yt,window.registerProcessor=$t.registerProcessor),"undefined"==typeof global||"AudioWorkletProcessor"in global||(global.AudioWorkletProcessor=Yt,global.registerProcessor=$t.registerProcessor);class zt extends qt{constructor(){super(...arguments),this.currentWorkletNode=null,this.fallbackToScriptProcessor=!1,this.keepCurrentNodeIfPossible=!1}initializeWorklet(e){return r(this,void 0,void 0,(function*(){if(this.stop(),!Mt.isAudioWorkletCompatible(e))return console.error("Audio Worklets not supported on this browser. Fallback to ScriptProcessor"),void(this.fallbackToScriptProcessor=!0);const t=(this.configService?this.configService.getWorkletBasePath():"")+this.workletPath;yield e.audioWorklet.addModule(t).catch((e=>{console.error(`Error when loading Worklet (${t}) for filter ${this.id}. Fallback to ScriptProcessor. Exception:`,e),this.fallbackToScriptProcessor=!0}))}))}isAudioWorkletEnabled(){return this.configService?this.configService.isAudioWorkletEnabled():kt.ENABLE_AUDIO_WORKLET}initializeNode(e,t){if(this.isAudioWorkletEnabled()&&!this.fallbackToScriptProcessor)this.currentWorkletNode=new AudioWorkletNode(e,t);else{const i=$t.getProcessor(t);if(!i)throw new Error(`No processor registered with name ${t} for filter ${this.id} to use the fallback/polyfill for AudioWorklet. Make sure you have created the class.`);this.currentWorkletNode=new Kt(e,i,this.configService.getBufferSize())}this.currentWorkletNode&&this.currentWorkletNode.port&&(this.currentWorkletNode.port.onmessage=e=>this.receiveEvent(e))}applyCurrentSettingsToWorklet(){if(this.currentWorkletNode&&this.currentWorkletNode.parameters){const e=this.getSettings();for(const t of Object.keys(e)){const i=this.currentWorkletNode.parameters.get(t);i&&(i.value=e[t],i.setValueAtTime(e[t],0))}}}getNode(e){if(this.keepCurrentNodeIfPossible&&this.currentWorkletNode&&this.currentWorkletNode.context==e||(this.stop(),this.initializeNode(e,this.workletName)),this.applyCurrentSettingsToWorklet(),this.setEnabled(this.isEnabled()),this.currentWorkletNode)return this.currentWorkletNode instanceof Kt?{input:this.currentWorkletNode.node,output:this.currentWorkletNode.node}:{input:this.currentWorkletNode,output:this.currentWorkletNode};throw new Error("Worklet node has not yet been created")}stop(){this.currentWorkletNode&&this.currentWorkletNode.port&&(this.currentWorkletNode.port.postMessage("stop"),this.currentWorkletNode.port.onmessage=null),this.currentWorkletNode=null}setEnabled(e){this.currentWorkletNode&&this.currentWorkletNode.port&&this.currentWorkletNode.port.postMessage(e?"enable":"disable"),super.setEnabled(e)}isWorklet(){return!0}}class Xt extends jt{}let Qt=class{constructor(){this.listeners={},this.listeners={}}on(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}emit(e,t){this.listeners[e]&&this.listeners[e].forEach((e=>{e(t)}))}off(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter((e=>e!==t)))}};Qt=e([Q(),i("design:paramtypes",[])],Qt);var Zt=Qt;let Jt=class{constructor(){this.mapConfig=new Map,this.workerBasePath="",this.workletBasePath="",this.soundBasePath=""}getConfig(e){return this.mapConfig.get(e)}setConfig(e,t){this.mapConfig.set(e,t)}isCompatibilityModeEnabled(){return"true"==this.getConfig(kt.PREFERENCES_KEYS.COMPATIBILITY_MODE_ENABLED)}isCompatibilityModeChecked(){return"true"==this.getConfig(kt.PREFERENCES_KEYS.COMPATIBILITY_MODE_CHECKED)}isAudioWorkletEnabled(){const e=this.getConfig(kt.PREFERENCES_KEYS.ENABLE_AUDIO_WORKLET);return null!=e?"true"==e:kt.ENABLE_AUDIO_WORKLET}isSoundtouchAudioWorkletEnabled(){const e=this.getConfig(kt.PREFERENCES_KEYS.ENABLE_SOUNDTOUCH_AUDIO_WORKLET);return null!=e?"true"==e:kt.ENABLE_SOUNDTOUCH_AUDIO_WORKLET}getBufferSize(){const e=this.getConfig(kt.PREFERENCES_KEYS.BUFFER_SIZE);return null!=e?parseInt(e):kt.DEFAULT_BUFFER_SIZE}getSampleRate(){const e=this.getConfig(kt.PREFERENCES_KEYS.SAMPLE_RATE);return null!=e?parseInt(e):kt.DEFAULT_SAMPLE_RATE}getBitrateMP3(){const e=this.getConfig(kt.PREFERENCES_KEYS.BITRATE_MP3);return null!=e?parseInt(e):kt.DEFAULT_MP3_BITRATE}enableCompatibilityMode(){this.setConfig(kt.PREFERENCES_KEYS.COMPATIBILITY_MODE_ENABLED,"true")}disableCompatibilityMode(){this.setConfig(kt.PREFERENCES_KEYS.COMPATIBILITY_MODE_ENABLED,"false")}getWorkletBasePath(){return this.workletBasePath}getWorkerBasePath(){return this.workerBasePath}getSoundBasePath(){return this.soundBasePath}setWorkletBasePath(e){this.workletBasePath=e}setWorkerBasePath(e){this.workerBasePath=e}setSoundBasePath(e){this.soundBasePath=e}isInitialRenderingDisabled(){const e=this.getConfig(kt.PREFERENCES_KEYS.DISABLE_INITIAL_RENDERING);return null!=e?"true"==e:kt.DISABLE_INITIAL_RENDERING}};Jt=e([Q()],Jt);var ei=Jt;let ti=class{constructor(e,t){this.previousSampleRate=kt.DEFAULT_SAMPLE_RATE,this.eventEmitter=e||new Zt,this.configService=t,this.setup()}setup(){this.configService&&(this.previousSampleRate=this.configService.getSampleRate(),this.eventEmitter&&this.eventEmitter.emit(Ct.SAMPLE_RATE_CHANGED,this.previousSampleRate)),this.currentContext||this.createNewContext(this.previousSampleRate)}createNewContextIfNeeded(e){if(this.configService&&this.configService.isCompatibilityModeEnabled()&&e){if(this.currentSampleRate!=e.sampleRate)return this.createNewContext(e.sampleRate),!0}else{let e=kt.DEFAULT_SAMPLE_RATE;if(this.configService&&(e=this.configService.getSampleRate()),e!=this.previousSampleRate)return this.createNewContext(e),!0}return!1}createNewContext(e){this._currentContext&&this.destroyOldContext(this._currentContext);const t={latencyHint:"interactive"};0!=e&&(t.sampleRate=e),this._currentContext=new AudioContext(t),this.eventEmitter&&this.eventEmitter.emit(Ct.SAMPLE_RATE_CHANGED,this.currentSampleRate),this.previousSampleRate=e}destroyOldContext(e){e&&e.close()}get currentSampleRate(){return this.currentContext?this.currentContext.sampleRate:0}get currentContext(){return this._currentContext}};ti=e([Q(),t(0,Y(Rt.EventEmitter)),t(1,Y(Rt.ConfigService)),i("design:paramtypes",[Object,Object])],ti);var ii=ti;let ri=class extends Bt{constructor(e,t,i,r,n){super(),this._renderedBuffer=null,this.audioRenderingLastCanceled=!1,this.initialRenderingDone=!1,this.sumInputBuffer=0,this.contextManager=i,this.bufferPlayer=r,this.filterManager=e,this.rendererManager=t,this.bufferManager=n}prepareContext(e){return r(this,void 0,void 0,(function*(){if(this.contextManager){this.contextManager.createNewContextIfNeeded(e)&&this.bufferManager&&(yield this.bufferManager.resetBufferFetcher()),this.contextManager.currentContext&&this.contextManager.currentContext.resume()}}))}renderAudio(e,t){return r(this,void 0,void 0,(function*(){if(yield this.prepareContext(e),!this.contextManager||!this.contextManager.currentContext)throw new Error("AudioContext is not yet available");if(!this.filterManager)throw new Error("Filter manager is not available");if(!this.rendererManager)throw new Error("Renderer manager is not available");if(!this.filterManager.entrypointFilter)throw new Error("Entrypoint filter is not available");if(!e)throw new Error("No principal buffer available");if(!this.initialRenderingDone&&this.configService&&this.configService.isInitialRenderingDisabled()&&!this.configService.isCompatibilityModeEnabled()&&!t)return this.loadInitialBuffer(e),this.initialRenderingDone=!0,!0;this.configService&&this.bufferPlayer&&!this.configService.isCompatibilityModeEnabled()&&this.bufferPlayer.compatibilityMode&&this.bufferPlayer.stop();const i=this.filterManager.entrypointFilter.getSpeed(),r=Mt.calculateAudioDuration(e,this.filterManager,i),n=new OfflineAudioContext(2,this.contextManager.currentContext.sampleRate*r,this.contextManager.currentContext.sampleRate),s=this.configService&&this.configService.isCompatibilityModeEnabled()?this.contextManager.currentContext:n;return this._renderedBuffer=yield this.rendererManager.executeAudioRenderers(e,s),this.currentOfflineContext=null,this.audioRenderingLastCanceled=!1,Mt.resetAudioRenderingProgress(this.eventEmitter),this.filterManager.setupTotalSamples(r,this.contextManager.currentContext),yield this.setupOutput(e,s,r,n)}))}setupPlayerSpeed(e){if(this.filterManager&&this.filterManager.entrypointFilter){const t=this.filterManager.entrypointFilter.getSpeed();e.speedAudio=t}}setupOutput(e,t,i,n){return r(this,void 0,void 0,(function*(){if(this._renderedBuffer&&this.configService&&this.eventEmitter&&this.bufferPlayer&&this.filterManager){if(yield this.filterManager.initializeWorklets(t),yield this.filterManager.connectNodes(t,this._renderedBuffer,!1,this.configService.isCompatibilityModeEnabled()),this.setupPlayerSpeed(this.bufferPlayer),!this.configService.isCompatibilityModeEnabled()&&n&&this.filterManager.currentNodes){this.currentOfflineContext=n,this.filterManager.currentNodes.output.connect(t.destination);const r=yield n.startRendering();if(this.filterManager.clearWorklets(),this.contextManager&&!this.loadRenderedAudio(e,r))return yield this.setupOutput(e,this.contextManager.currentContext,i);if(this.audioRenderingLastCanceled)return!1;this.eventEmitter.emit(Ct.OFFLINE_AUDIO_RENDERING_FINISHED)}else this.filterManager.currentNodes&&(this.bufferPlayer.setCompatibilityMode(this.filterManager.currentNodes.output,i),this.initialRenderingDone=!0);return this.eventEmitter&&this.eventEmitter.emit(Ct.AUDIO_RENDERING_FINISHED),!0}return!1}))}loadRenderedAudio(e,t){if(this.eventEmitter&&this.bufferPlayer){if(this.audioRenderingLastCanceled)this.initialRenderingDone||(this.loadInitialBuffer(e),this.eventEmitter.emit(Ct.CANCELLED_AND_LOADED_INITIAL_AUDIO));else{if(0==Mt.sumAudioBuffer(t)&&0!==this.sumInputBuffer){if(this.configService&&!this.configService.isCompatibilityModeChecked())return this.setCompatibilityModeChecked(!0),this.configService.enableCompatibilityMode(),this.eventEmitter.emit(Ct.COMPATIBILITY_MODE_AUTO_ENABLED),console.warn("Compatibility mode has been automatically enabled because a problem has been detected with the web browser."),!1;this.eventEmitter.emit(Ct.RENDERING_AUDIO_PROBLEM_DETECTED)}this._renderedBuffer=t,this.bufferPlayer.loadBuffer(this._renderedBuffer)}this.initialRenderingDone=!0}return!0}loadInitialBuffer(e){this.bufferPlayer&&(this._renderedBuffer=e,this.bufferPlayer.loadBuffer(e))}cancelAudioRendering(){this.currentOfflineContext&&!this.audioRenderingLastCanceled&&this.filterManager&&(this.audioRenderingLastCanceled=!0,this.filterManager.disconnectOldNodes(!1),this.eventEmitter&&this.eventEmitter.emit(Ct.CANCELLING_AUDIO_PROCESSING))}clearRenderedBuffer(){Mt.clearAudioBuffer(this._renderedBuffer),this._renderedBuffer=null}setCompatibilityModeChecked(e){this.configService&&this.configService.setConfig(kt.PREFERENCES_KEYS.COMPATIBILITY_MODE_CHECKED,""+e)}get renderedBuffer(){return this._renderedBuffer}};ri=e([Q(),t(0,Y(Rt.FilterManager)),t(1,Y(Rt.RendererManager)),t(2,Y(Rt.AudioContextManager)),t(3,Y(Rt.BufferPlayer)),t(4,Y(Rt.BufferManager)),i("design:paramtypes",[Object,Object,Object,Object,Object])],ri);var ni=ri;let si=class extends Bt{constructor(e,t,i,r){super(),this.downloadingInitialData=!1,this.audioBuffersToFetch=[],this.bufferFetcherService=t,this.eventEmitter=i,this.filterManager=e,this.filterManager=e,this.audioBuffersToFetch=r,this.setup()}setup(){this.audioBuffersToFetch.length>0&&this.fetchBuffers(!1)}fetchBuffers(e){return r(this,void 0,void 0,(function*(){if(!this.downloadingInitialData&&this.bufferFetcherService){this.downloadingInitialData=!0,this.eventEmitter&&!e&&this.eventEmitter.emit(Ct.LOADING_BUFFERS);try{this.bufferFetcherService.fetchAllBuffers(this.audioBuffersToFetch),this.downloadingInitialData=!1,this.eventEmitter&&!e&&this.eventEmitter.emit(Ct.LOADED_BUFFERS)}catch(t){console.error(t),this.eventEmitter&&!e&&this.eventEmitter.emit(Ct.LOADING_BUFFERS_ERROR)}}}))}resetBufferFetcher(){return r(this,void 0,void 0,(function*(){this.bufferFetcherService&&(this.bufferFetcherService.reset(),yield this.fetchBuffers(!0),this.filterManager&&(yield this.filterManager.resetFilterBuffers()))}))}};si=e([Q(),t(0,Y(Rt.FilterManager)),t(1,Y(Rt.BufferFetcherService)),t(2,Y(Rt.EventEmitter)),t(3,Y(Rt.AudioBuffersToFetch)),i("design:paramtypes",[Object,Object,Object,Array])],si);var oi=si;let ai=class extends Bt{constructor(e,t){super(),this.filters=[],this._entryPointFilter=null,this._currentNodes=null,this.filters=e,this._entryPointFilter=t,this.setup()}setup(){for(const e of this.filters)e.initializeDefaultSettings()}addFilters(...e){for(const t of e)t.initializeDefaultSettings(),t.injectDependencies(this.bufferFetcherService,this.bufferDecoderService,this.configService,this.eventEmitter);this.filters.push(...e)}getFiltersState(){const e={};return this.filters.forEach((t=>{e[t.id]=t.isEnabled()})),e}getFiltersSettings(){const e=new Map;for(const t of this.filters)e.set(t.id,t.getSettings());return e}enableFilter(e){const t=this.filters.find((t=>t.id===e));t&&t.enable()}disableFilter(e){const t=this.filters.find((t=>t.id===e));t&&t.disable()}toggleFilter(e){const t=this.filters.find((t=>t.id===e));t&&t.toggle()}changeFilterSettings(e,t){return r(this,void 0,void 0,(function*(){const i=this.filters.find((t=>t.id===e));if(i)for(const e of Object.keys(t))yield i.setSetting(e,t[e])}))}resetFilterSettings(e){return r(this,void 0,void 0,(function*(){const t=this.filters.find((t=>t.id===e));t&&(yield t.resetSettings())}))}resetAllFiltersState(){this.filters.forEach((e=>{e.isDefaultEnabled()?e.enable():e.disable()}))}connectNodes(e,t,i,n){return r(this,void 0,void 0,(function*(){if(!this._entryPointFilter)return;let r=null;if(i&&this._currentNodes)r=this._currentNodes.input;else{const i=yield this._entryPointFilter.getEntrypointNode(e,t,!n);r=i.input}const s=[];let o=r;this.disconnectOldNodes(i);const a=this.filters.sort(((e,t)=>e.order-t.order)).filter(((e,t)=>e!==this._entryPointFilter&&(e.isEnabled()||t>=this.filters.length-1)));for(const t of a){const i=t.getNode(e);o&&o.connect(i.input),o=i.output,s.push(i)}this._entryPointFilter&&this._entryPointFilter.updateState(),this._currentNodes={input:r,output:o,intermediateNodes:s.filter((e=>e.input!=o&&e.output!=o&&e.input!=r&&e.output!=r))}}))}disconnectOldNodes(e){if(this._currentNodes&&(this._currentNodes.input.disconnect(),e||this._currentNodes.output.disconnect(),this._currentNodes.intermediateNodes))for(const e of this._currentNodes.intermediateNodes)e.input.disconnect(),e.output.disconnect()}initializeWorklets(e){return r(this,void 0,void 0,(function*(){for(const t of this.filters)t.isWorklet()&&(this.clearWorklets(),yield t.initializeWorklet(e))}))}clearWorklets(){for(const e of this.filters)e.isWorklet()&&e.stop()}getAddingTime(){let e=0;for(const t of this.filters)t.isEnabled()&&(e+=t.getAddingTime());return e}setupTotalSamples(e,t){if(t){const i=e*t.sampleRate;for(const e of this.filters)e.totalSamples=i}}resetFilterBuffers(){return r(this,void 0,void 0,(function*(){for(const e of this.filters)yield e.bufferFetcherReseted()}))}get entrypointFilter(){return this._entryPointFilter}get currentNodes(){return this._currentNodes}};ai=e([Q(),t(0,Z(Rt.Filters)),t(1,Y(Rt.EntryPointFilter)),i("design:paramtypes",[Array,Object])],ai);var ui=ai;let ci=class extends Bt{constructor(e=[]){super(),this.renderers=[],this.renderers=e}addRenderers(...e){for(const t of e)t.injectDependencies(this.bufferFetcherService,this.bufferDecoderService,this.configService,this.eventEmitter);this.renderers.push(...e)}getRenderersState(){const e={};return this.renderers.forEach((t=>{e[t.id]=t.isEnabled()})),e}enableRenderer(e){const t=this.renderers.find((t=>t.id===e));t&&t.enable()}disableRenderer(e){const t=this.renderers.find((t=>t.id===e));t&&t.disable()}toggleRenderer(e){const t=this.renderers.find((t=>t.id===e));t&&t.toggle()}resetAllRenderersState(){this.renderers.forEach((e=>{e.isDefaultEnabled()?e.enable():e.disable()}))}executeAudioRenderers(e,t){return r(this,void 0,void 0,(function*(){let i=e;for(const e of this.renderers.sort(((e,t)=>e.order-t.order)))e.isEnabled()&&(i=yield e.renderAudio(t,i));return i}))}};ci=e([Q(),t(0,Z(Rt.Renderers)),i("design:paramtypes",[Array])],ci);var hi=ci;let li=class extends Bt{constructor(e,t,i){super(),this._savingBuffer=!1,this.playingStoppedCallback=null,this.contextManager=t,this.bufferPlayer=i,this.filterManager=e,this.setup()}setup(){this.bufferPlayer&&this.bufferPlayer.on(Ct.PLAYING_FINISHED,(()=>{this._savingBuffer&&this.playingStoppedCallback&&this.eventEmitter&&this.eventEmitter.off(Ct.PLAYING_STOPPED,this.playingStoppedCallback)}))}saveBuffer(e,t,i){return r(this,void 0,void 0,(function*(){if(this._savingBuffer)throw new Error("The buffer is currently saving");if(!this.bufferPlayer)throw new Error("No buffer player was found");this._savingBuffer=!0;let r=!1;return r=this.bufferPlayer.compatibilityMode?yield this.saveBufferCompatibilityMode(t,i):yield this.saveBufferDirect(e,t),this._savingBuffer=!1,r}))}saveBufferDirect(e,t){return new Promise(((i,r)=>{var n;if(!e||this.contextManager&&!this.contextManager.currentContext)return r("No rendered buffer or AudioContext not initialized");const s=xt(null===(n=this.configService)||void 0===n?void 0:n.getWorkerBasePath());if(s){const r=[];for(let t=0;t<e.numberOfChannels;t++)r.push(e.getChannelData(t));s.onmessage=e=>{e.data.command!=kt.EXPORT_WAV_COMMAND&&e.data.command!=kt.EXPORT_MP3_COMMAND||this.downloadAudioBlob(e.data.data,t),s.terminate(),this._savingBuffer=!1,i(!0)},s.postMessage({command:kt.INIT_COMMAND,config:{sampleRate:e.sampleRate,numChannels:2,bitrate:(null==t?void 0:t.bitrate)||kt.DEFAULT_MP3_BITRATE}}),s.postMessage({command:kt.RECORD_COMMAND,buffer:r}),s.postMessage({command:"mp3"===(null==t?void 0:t.format)||"mp3"===kt.DEFAULT_SAVE_FORMAT?kt.EXPORT_MP3_COMMAND:kt.EXPORT_WAV_COMMAND,type:kt.AUDIO_WAV})}}))}saveBufferCompatibilityMode(e,t){return new Promise(((i,r)=>{if(!this.bufferPlayer)return r("No buffer player found");this.bufferPlayer.start().then((()=>{if(!this.configService)return r("No config service found");if(!this.filterManager)return r("No filter manager found");if(!this.filterManager.currentNodes)return r("No current nodes found");const n=t||new Lt({bufferLen:this.configService.getBufferSize(),sampleRate:this.configService.getSampleRate(),numChannels:2,workletBasePath:this.configService.getWorkletBasePath(),workerBasePath:this.configService.getWorkerBasePath(),mimeType:"mp3"==(null==e?void 0:e.format)?kt.AUDIO_MP3:kt.AUDIO_WAV,bitrate:(null==e?void 0:e.bitrate)||kt.DEFAULT_MP3_BITRATE});n.setup(this.filterManager.currentNodes.output).then((()=>{n.record(),this.playingStoppedCallback=()=>{n.kill(),this._savingBuffer=!1,this.eventEmitter&&(this.eventEmitter.off(Ct.PLAYING_FINISHED,t),this.playingStoppedCallback&&this.eventEmitter.off(Ct.PLAYING_STOPPED,this.playingStoppedCallback)),i(!0)};const t=()=>{this.playingStoppedCallback&&this.eventEmitter&&this.eventEmitter.off(Ct.PLAYING_STOPPED,this.playingStoppedCallback),n.stop();const r=r=>{this.downloadAudioBlob(r,e),this._savingBuffer=!1,this.eventEmitter&&this.eventEmitter.off(Ct.PLAYING_FINISHED,t),n.kill(),i(!0)};"mp3"===(null==e?void 0:e.format)||"mp3"===kt.DEFAULT_SAVE_FORMAT?n.exportMP3(r):n.exportWAV(r)};this.eventEmitter&&(this.eventEmitter.on(Ct.PLAYING_FINISHED,t),this.eventEmitter.on(Ct.PLAYING_STOPPED,this.playingStoppedCallback))}))}))}))}downloadAudioBlob(e,t){Mt.forceDownload(e,"audio-"+(new Date).toISOString()+"."+((null==t?void 0:t.format)||kt.DEFAULT_SAVE_FORMAT))}get savingBuffer(){return this._savingBuffer}};li=e([Q(),t(0,Y(Rt.FilterManager)),t(1,Y(Rt.AudioContextManager)),t(2,Y(Rt.BufferPlayer)),i("design:paramtypes",[Object,Object,Object])],li);var di=li;let fi=class{constructor(e,t,i){this.buffers=new Map,this.bufferErrors=[],this.configService=null,this.contextManager=e,this.eventEmitter=i||new Zt,this.configService=t}fetchBuffer(e,t){return r(this,void 0,void 0,(function*(){var i,r,n,s;const o=(this.configService?this.configService.getSoundBasePath():"")+e;if(null==this.buffers.get(this.getKeyFromLocation(o))||t){null===(i=this.eventEmitter)||void 0===i||i.emit(Ct.FETCHING_BUFFERS,o);try{const e=yield fetch(o);if(!e.ok)throw this.bufferErrors.push(o),null===(r=this.eventEmitter)||void 0===r||r.emit(Ct.FETCHING_BUFFERS_ERROR,o),Ct.FETCHING_BUFFERS_ERROR;{const t=yield e.arrayBuffer();if(this.contextManager&&this.contextManager.currentContext){const e=yield this.contextManager.currentContext.decodeAudioData(t);this.buffers.set(this.getKeyFromLocation(o),Mt.decodeBuffer(this.contextManager.currentContext,e))}}null===(n=this.eventEmitter)||void 0===n||n.emit(Ct.FINISHED_FETCHING_BUFFERS,o)}catch(e){throw console.error(e),this.bufferErrors.push(o),null===(s=this.eventEmitter)||void 0===s||s.emit(Ct.FETCHING_BUFFERS_ERROR,o),Ct.FETCHING_BUFFERS_ERROR}}}))}fetchAllBuffers(e){return r(this,void 0,void 0,(function*(){for(const t of e)yield this.fetchBuffer(t)}))}getAudioBuffer(e){return this.buffers.get(this.getKeyFromLocation(e))}getOrFetchAudioBuffer(e){return r(this,void 0,void 0,(function*(){return null==this.getAudioBuffer(e)&&(yield this.fetchBuffer(e)),this.getAudioBuffer(e)}))}getDownloadedBuffersList(){return Array.from(this.buffers.keys())}getKeyFromLocation(e){return e.substring(e.lastIndexOf("/")+1)}reset(){this.buffers.clear()}};fi=e([Q(),t(0,Y(Rt.AudioContextManager)),t(1,Y(Rt.ConfigService)),t(2,Y(Rt.EventEmitter)),i("design:paramtypes",[Object,Object,Object])],fi);var pi=fi;let gi=class{constructor(e,t){this.contextManager=e,this.eventEmitter=t||new Zt}decodeBufferFromFile(e){return r(this,void 0,void 0,(function*(){this.eventEmitter&&this.eventEmitter.emit(Ct.DECODING_AUDIO_FILE);try{if(this.contextManager&&this.contextManager.currentContext){const t=yield Mt.loadAudioBuffer(this.contextManager.currentContext,e);return this.eventEmitter&&this.eventEmitter.emit(Ct.DECODED_AUDIO_FILE),t}}catch(e){console.error(e),this.eventEmitter&&(this.eventEmitter.emit(Ct.DECODED_AUDIO_FILE),this.eventEmitter.emit(Ct.ERROR_DECODING_AUDIO_FILE))}return null}))}};gi=e([Q(),t(0,Y(Rt.AudioContextManager)),t(1,Y(Rt.EventEmitter)),i("design:paramtypes",[Object,Object])],gi);var mi=gi;class vi extends Xt{renderAudio(e,t){return new Promise((i=>{const r=t.numberOfChannels,n=e.sampleRate*t.duration+2*e.sampleRate,s=e.createBuffer(r,n,e.sampleRate);for(let e=0;e<r;e++){const i=s.getChannelData(e),r=t.getChannelData(e);for(let e=0;e<n;e++)e<r.length?i[e]=r[r.length-1-e]:i[e]=0}i(s)}))}get order(){return 0}get id(){return kt.FILTERS_NAMES.RETURN_AUDIO}}class Ei extends qt{constructor(){super(...arguments),this.frequencyBooster=200,this.frequencyReduce=200,this.dbBooster=15,this.dbReduce=-2}getNode(e){const t=e.createBiquadFilter();t.type="lowshelf",t.frequency.value=this.frequencyBooster,t.gain.value=this.dbBooster;const i=e.createBiquadFilter();return i.type="highshelf",i.frequency.value=this.frequencyReduce,i.gain.value=this.dbReduce,i.connect(t),{input:i,output:t}}get order(){return 3}get id(){return kt.FILTERS_NAMES.BASS_BOOST}getSettings(){return{frequencyBooster:this.frequencyBooster,frequencyReduce:this.frequencyReduce,dbBooster:this.dbBooster,dbReduce:this.dbReduce}}setSetting(e,t){return r(this,void 0,void 0,(function*(){if(Mt.isSettingValueValid(t))switch(e){case"frequencyBooster":this.frequencyBooster=parseInt(t);break;case"frequencyReduce":this.frequencyReduce=parseInt(t);break;case"dbBooster":this.dbBooster=parseInt(t);break;case"dbReduce":this.dbReduce=parseInt(t)}}))}}class yi extends AudioWorkletProcessor{constructor(){super(),this.stopped=!1,this.phaser=null,this.last=null,this.port.onmessage=e=>{"stop"==e.data&&this.stop()}}static get parameterDescriptors(){return[{name:"bits",defaultValue:16},{name:"normFreq",defaultValue:.9}]}get defaultParameterDescriptors(){return yi.parameterDescriptors}process(e,t,i){if(this.stopped)return!1;const r=e[0],n=t[0],s=2*Math.pow(.5,i.bits[0]),o=(1-i.normFreq[0])/(sampleRate/48e3);if(null==this.last&&(this.last=new Array(r.length).fill(0)),null==this.phaser&&(this.phaser=new Array(r.length).fill(0)),r&&r[0]){const e=r[0].length;for(let t=0;t<r.length;t++){const i=r[t],a=n[t];if(i&&a)for(let r=0;r<e;r++)this.phaser[t]+=o,this.phaser[t]>=1&&(this.phaser[t]-=1,this.last[t]=s*Math.floor(i[r]*(1/s)+.5)),a[r]=this.last[t]}}return!0}stop(){this.stopped=!0,this.phaser=null,this.last=null}}registerProcessor(kt.WORKLET_NAMES.BITCRUSHER,yi);class Si extends zt{constructor(){super(...arguments),this.bits=16,this.normFreq=.9}receiveEvent(e){}get workletPath(){return kt.WORKLET_PATHS.BITCRUSHER}get workletName(){return kt.WORKLET_NAMES.BITCRUSHER}get order(){return 6}get id(){return kt.FILTERS_NAMES.BITCRUSHER}getSettings(){return{bits:this.bits,normFreq:this.normFreq}}setSetting(e,t){return r(this,void 0,void 0,(function*(){if(Mt.isSettingValueValid(t)){switch(e){case"bits":this.bits=parseInt(t);break;case"normFreq":this.normFreq=parseFloat(t)}this.applyCurrentSettingsToWorklet()}}))}}class bi extends qt{constructor(){super(...arguments),this.delay=.2,this.gain=.75}getNode(e){const t=e.createDelay(179);t.delayTime.value=this.delay;const i=e.createGain();return i.gain.value=this.gain,i.connect(t),t.connect(i),{input:i,output:t}}get order(){return 7}get id(){return kt.FILTERS_NAMES.ECHO}getAddingTime(){return 5}getSettings(){return{delay:this.delay,gain:this.gain}}setSetting(e,t){return r(this,void 0,void 0,(function*(){if(Mt.isSettingValueValid(t))switch(e){case"delay":this.delay=parseFloat(t);break;case"gain":this.gain=parseFloat(t)}}))}}class _i extends qt{constructor(){super(...arguments),this.highFrequency=3500}getNode(e){const t=e.createBiquadFilter();return t.type="highpass",t.frequency.value=this.highFrequency,{input:t,output:t}}get order(){return 4}get id(){return kt.FILTERS_NAMES.HIGH_PASS}getSettings(){return{highFrequency:this.highFrequency}}setSetting(e,t){return r(this,void 0,void 0,(function*(){if(Mt.isSettingValueValid(t)&&"highFrequency"===e)this.highFrequency=parseInt(t)}))}}class Ai{constructor(e){this._array=new Float32Array,this.n=0,this.length=0,this.readPointer=0,this.writePointer=0,this.n=Math.floor(e),this.init()}init(){this._array=new Float32Array(2*this.n),this.length=this._array.length,this.readPointer=0,this.writePointer=this.n-1,this._array.fill(0)}read(){const e=this._array[this.readPointer%this.length];return this.readPointer=(this.readPointer+1)%this.length,e}push(e){this._array[this.writePointer%this.length]=e,this.writePointer=(this.writePointer+1)%this.length}reset(){this.init()}clear(){this._array=new Float32Array,this.length=0,this.readPointer=0,this.writePointer=0}sum(){return this._array.reduce(((e,t)=>e+t),0)}}class wi extends AudioWorkletProcessor{constructor(){super(),this.delayBuffer=[],this.envelopeSample=0,this.stopped=!1,this.disabled=!1,this.port.onmessage=e=>{"reset"==e.data?this.reset():"stop"==e.data?this.stop():"disable"==e.data?this.disabled=!0:"enable"==e.data&&(this.disabled=!1)}}static get parameterDescriptors(){return[{name:"preGain",defaultValue:0},{name:"postGain",defaultValue:0},{name:"attackTime",defaultValue:0},{name:"releaseTime",defaultValue:3},{name:"threshold",defaultValue:-.05},{name:"lookAheadTime",defaultValue:0}]}get defaultParameterDescriptors(){return wi.parameterDescriptors}getEnvelope(e,t,i,r){const n=Math.exp(-1/(r*t)),s=Math.exp(-1/(r*i)),o=new Float32Array(e.length);for(let t=0;t<e.length;t++){const i=Math.abs(e[t]);this.envelopeSample<i?this.envelopeSample=i+n*(this.envelopeSample-i):this.envelopeSample=i+s*(this.envelopeSample-i),o[t]=this.envelopeSample}return o}getMaxEnvelope(e,t,i){let r=e[0][i];for(let n=0;n<t;n++)e[n][i]>r&&(r=e[n][i]);return r}ampToDB(e){return 20*Math.log10(e)}dBToAmp(e){return Math.pow(10,e/20)}process(e,t,i){if(this.stopped)return!1;const r=e[0],n=t[0],s=[],o=this.dBToAmp(i.postGain[0]),a=this.dBToAmp(i.preGain[0]);for(let e=0;e<n.length;e++){const t=r[e],o=n[e];if(null==this.delayBuffer[e]&&(this.delayBuffer[e]=new Ai(i.lookAheadTime[0]*sampleRate)),t&&o)for(let e=0;e<t.length;++e)this.disabled?o[e]=t[e]:o[e]=a*t[e];!this.disabled&&o&&(s[e]=this.getEnvelope(o,i.attackTime[0],i.releaseTime[0],sampleRate))}for(let e=0;e<n.length;e++){const t=r[e],a=n[e];if(i.lookAheadTime[0]>0&&a)for(let t=0;t<a.length;t++)this.delayBuffer[e].push(a[t]),a[t]=this.delayBuffer[e].read();if(this.disabled)continue;const u=1;if(t&&a)for(let e=0;e<t.length;e++){let t=u*(i.threshold[0]-this.ampToDB(this.getMaxEnvelope(s,n.length,e)));t=Math.min(0,t);const r=this.dBToAmp(t);a[e]*=r*o}}return!0}reset(){for(let e=0;e<this.delayBuffer.length;e++)null!=this.delayBuffer[e]&&this.delayBuffer[e].reset();this.envelopeSample=0}stop(){for(let e=0;e<this.delayBuffer.length;e++)null!=this.delayBuffer[e]&&this.delayBuffer[e].clear();this.delayBuffer=[],this.envelopeSample=0,this.stopped=!0}}registerProcessor(kt.WORKLET_NAMES.LIMITER,wi);class Ri extends zt{constructor(){super(),this.preGain=0,this.postGain=0,this.attackTime=0,this.releaseTime=6,this.threshold=0,this.lookAheadTime=.3,this.keepCurrentNodeIfPossible=!0,this.setDefaultEnabled(!0)}receiveEvent(e){}get workletPath(){return kt.WORKLET_PATHS.LIMITER}get workletName(){return kt.WORKLET_NAMES.LIMITER}get order(){return 11}get id(){return kt.FILTERS_NAMES.LIMITER}getAddingTime(){return this.lookAheadTime}getSettings(){return{preGain:this.preGain,postGain:this.postGain,attackTime:this.attackTime,releaseTime:this.releaseTime,threshold:this.threshold,lookAheadTime:this.lookAheadTime}}setSetting(e,t){return r(this,void 0,void 0,(function*(){if(Mt.isSettingValueValid(t)){switch(e){case"preGain":this.preGain=parseFloat(t);break;case"postGain":this.postGain=parseFloat(t);break;case"attackTime":this.attackTime=parseFloat(t);break;case"releaseTime":this.releaseTime=parseFloat(t);break;case"threshold":this.threshold=parseFloat(t);break;case"lookAheadTime":this.lookAheadTime=parseFloat(t)}this.applyCurrentSettingsToWorklet()}}))}}class Ii extends qt{constructor(){super(...arguments),this.lowFrequency=3500}getNode(e){const t=e.createBiquadFilter();return t.type="lowpass",t.frequency.value=this.lowFrequency,{input:t,output:t}}get order(){return 5}get id(){return kt.FILTERS_NAMES.LOW_PASS}getSettings(){return{lowFrequency:this.lowFrequency}}setSetting(e,t){return r(this,void 0,void 0,(function*(){if(Mt.isSettingValueValid(t)&&"lowFrequency"===e)this.lowFrequency=parseInt(t)}))}}class Ci extends qt{constructor(){super(...arguments),this.reverbEnvironment=kt.DEFAULT_REVERB_ENVIRONMENT,this.reverbCustomEnvironmentAddTime=5,this.customEnvironment=null}getNode(e){const t=e.createConvolver();this.reverbEnvironment&&("custom"!=this.reverbEnvironment.url||this.customEnvironment)||(this.reverbEnvironment=kt.DEFAULT_REVERB_ENVIRONMENT);const i=this.getReverbBuffer(e);return i&&(t.buffer=i),{input:t,output:t}}getReverbBuffer(e){if("custom"==this.reverbEnvironment.url&&this.customEnvironment){if(this.customEnvironment.sampleRate===e.sampleRate)return this.customEnvironment;this.reverbEnvironment=kt.DEFAULT_REVERB_ENVIRONMENT}else if(this.bufferFetcherService)return this.bufferFetcherService.getAudioBuffer(this.reverbEnvironment.url)}get order(){return 9}get id(){return kt.FILTERS_NAMES.REVERB}getAddingTime(){const e=this.getSettings();if(e&&e.reverbEnvironment){if("custom"==e.reverbEnvironment.value)return this.reverbCustomEnvironmentAddTime;if(e.reverbEnvironment.additionalData)return e.reverbEnvironment.additionalData.addDuration}return 0}getSettings(){var e;return this.reverbEnvironment?{reverbEnvironment:{name:this.reverbEnvironment.name,value:this.reverbEnvironment.url,additionalData:{size:this.reverbEnvironment.size,link:this.reverbEnvironment.link,addDuration:this.reverbEnvironment.addDuration}},downloadedBuffers:null===(e=this.bufferFetcherService)||void 0===e?void 0:e.getDownloadedBuffersList(),hasCustomEnvironment:!!this.customEnvironment,reverbCustomEnvironmentAddTime:this.reverbCustomEnvironmentAddTime}:{reverbCustomEnvironmentAddTime:this.reverbCustomEnvironmentAddTime}}setSetting(e,t){return r(this,void 0,void 0,(function*(){var i;if("reverbEnvironment"==e){const e=t;if(e){const t=e.value;try{"custom"!=t&&(yield null===(i=this.bufferFetcherService)||void 0===i?void 0:i.fetchBuffer(t)),e.additionalData?this.reverbEnvironment={name:e.name,url:t,size:e.additionalData.size,addDuration:e.additionalData.addDuration,link:e.additionalData.link}:this.reverbEnvironment={name:e.name,url:t,size:0,addDuration:0,link:""}}catch(e){console.error(e)}}}else"reverbCustomEnvironmentAddTime"==e?Mt.isSettingValueValid(t)&&(this.reverbCustomEnvironmentAddTime=parseInt(t)):"reverbCustomEnvironmentFile"==e&&this.bufferDecoderService&&t&&(this.customEnvironment=yield this.bufferDecoderService.decodeBufferFromFile(t),this.customEnvironment||(this.reverbEnvironment=kt.DEFAULT_REVERB_ENVIRONMENT))}))}bufferFetcherReseted(){return r(this,void 0,void 0,(function*(){var e;const t=this.getSettings();if(t){const i=null===(e=t.reverbEnvironment)||void 0===e?void 0:e.value;if(i&&"custom"!==i&&this.bufferFetcherService)return yield this.bufferFetcherService.fetchBuffer(i),!0}return!1}))}}class Bi{constructor(){this._vector=new Float32Array,this._position=0,this._frameCount=0}get vector(){return this._vector}get position(){return this._position}get startIndex(){return 2*this._position}get frameCount(){return this._frameCount}get endIndex(){return 2*(this._position+this._frameCount)}clear(){this.receive(this._frameCount),this.rewind()}put(e){this._frameCount+=e}putSamples(e,t,i=0){const r=2*(t=t||0);i>=0||(i=(e.length-r)/2);const n=2*i;this.ensureCapacity(i+this._frameCount);const s=this.endIndex;this.vector.set(e.subarray(r,r+n),s),this._frameCount+=i}putBuffer(e,t,i=0){t=t||0,i>=0||(i=e.frameCount-t),this.putSamples(e.vector,e.position+t,i)}receive(e){e>=0&&!(e>this._frameCount)||(e=this.frameCount),this._frameCount-=e,this._position+=e}receiveSamples(e,t=0){const i=2*t,r=this.startIndex;e.set(this._vector.subarray(r,r+i)),this.receive(t)}extract(e,t=0,i=0){const r=this.startIndex+2*t,n=2*i;e.set(this._vector.subarray(r,r+n))}ensureCapacity(e=0){const t=parseInt(2*e);if(this._vector.length<t){const e=new Float32Array(t);e.set(this._vector.subarray(this.startIndex,this.endIndex)),this._vector=e,this._position=0}else this.rewind()}ensureAdditionalCapacity(e=0){this.ensureCapacity(this._frameCount+e)}rewind(){this._position>0&&(this._vector.set(this._vector.subarray(this.startIndex,this.endIndex)),this._position=0)}}class Mi{constructor(e){e?(this._inputBuffer=new Bi,this._outputBuffer=new Bi):this._inputBuffer=this._outputBuffer=null}get inputBuffer(){return this._inputBuffer}set inputBuffer(e){this._inputBuffer=e}get outputBuffer(){return this._outputBuffer}set outputBuffer(e){this._outputBuffer=e}clear(){this._inputBuffer.clear(),this._outputBuffer.clear()}}class Pi extends Mi{constructor(e){super(e),this.reset(),this._rate=1}set rate(e){this._rate=e}reset(){this.slopeCount=0,this.prevSampleL=0,this.prevSampleR=0}clone(){const e=new Pi;return e.rate=this._rate,e}process(){const e=this._inputBuffer.frameCount;this._outputBuffer.ensureAdditionalCapacity(e/this._rate+1);const t=this.transpose(e);this._inputBuffer.receive(),this._outputBuffer.put(t)}transpose(e=0){if(0===e)return 0;const t=this._inputBuffer.vector,i=this._inputBuffer.startIndex,r=this._outputBuffer.vector,n=this._outputBuffer.endIndex;let s=0,o=0;for(;this.slopeCount<1;)r[n+2*o]=(1-this.slopeCount)*this.prevSampleL+this.slopeCount*t[i],r[n+2*o+1]=(1-this.slopeCount)*this.prevSampleR+this.slopeCount*t[i+1],o+=1,this.slopeCount+=this._rate;if(this.slopeCount-=1,1!==e)e:for(;;){for(;this.slopeCount>1;)if(this.slopeCount-=1,s+=1,s>=e-1)break e;const a=i+2*s;r[n+2*o]=(1-this.slopeCount)*t[a]+this.slopeCount*t[a+2],r[n+2*o+1]=(1-this.slopeCount)*t[a+1]+this.slopeCount*t[a+3],o+=1,this.slopeCount+=this._rate}return this.prevSampleL=t[i+2*e-2],this.prevSampleR=t[i+2*e-1],o}}class Ti{constructor(e){this._pipe=e}get pipe(){return this._pipe}get inputBuffer(){return this._pipe.inputBuffer}get outputBuffer(){return this._pipe.outputBuffer}fillInputBuffer(){throw new Error("fillInputBuffer() not overridden")}fillOutputBuffer(e=0){for(;this.outputBuffer.frameCount<e;){const e=16384-this.inputBuffer.frameCount;if(this.fillInputBuffer(e),this.inputBuffer.frameCount<16384)break;this._pipe.process()}}clear(){this._pipe.clear()}}const Ni=function(){};class Oi extends Ti{constructor(e,t,i=Ni){super(t),this.callback=i,this.sourceSound=e,this.historyBufferSize=22050,this._sourcePosition=0,this.outputBufferPosition=0,this._position=0}get position(){return this._position}set position(e){if(e>this._position)throw new RangeError("New position may not be greater than current position");const t=this.outputBufferPosition-(this._position-e);if(t<0)throw new RangeError("New position falls outside of history buffer");this.outputBufferPosition=t,this._position=e}get sourcePosition(){return this._sourcePosition}set sourcePosition(e){this.clear(),this._sourcePosition=e}onEnd(){this.callback()}fillInputBuffer(e=0){const t=new Float32Array(2*e),i=this.sourceSound.extract(t,e,this._sourcePosition);this._sourcePosition+=i,this.inputBuffer.putSamples(t,0,i)}extract(e,t=0){this.fillOutputBuffer(this.outputBufferPosition+t);const i=Math.min(t,this.outputBuffer.frameCount-this.outputBufferPosition);this.outputBuffer.extract(e,this.outputBufferPosition,i);const r=this.outputBufferPosition+i;return this.outputBufferPosition=Math.min(this.historyBufferSize,r),this.outputBuffer.receive(Math.max(r-this.historyBufferSize,0)),this._position+=i,i}handleSampleData(e){this.extract(e.data,4096)}clear(){super.clear(),this.outputBufferPosition=0}}const Di=[[124,186,248,310,372,434,496,558,620,682,744,806,868,930,992,1054,1116,1178,1240,1302,1364,1426,1488,0],[-100,-75,-50,-25,25,50,75,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[-20,-15,-10,-5,5,10,15,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[-4,-3,-2,-1,1,2,3,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],Fi=-10/3.75;class ki extends Mi{constructor(e){super(e),this._quickSeek=!0,this.midBufferDirty=!1,this.midBuffer=null,this.overlapLength=0,this.autoSeqSetting=!0,this.autoSeekSetting=!0,this._tempo=1,this.setParameters(44100,0,0,8)}clear(){super.clear(),this.clearMidBuffer()}clearMidBuffer(){this.midBufferDirty&&(this.midBufferDirty=!1,this.midBuffer=null)}setParameters(e,t,i,r){e>0&&(this.sampleRate=e),r>0&&(this.overlapMs=r),t>0?(this.sequenceMs=t,this.autoSeqSetting=!1):this.autoSeqSetting=!0,i>0?(this.seekWindowMs=i,this.autoSeekSetting=!1):this.autoSeekSetting=!0,this.calculateSequenceParameters(),this.calculateOverlapLength(this.overlapMs),this.tempo=this._tempo}set tempo(e){let t;this._tempo=e,this.calculateSequenceParameters(),this.nominalSkip=this._tempo*(this.seekWindowLength-this.overlapLength),this.skipFract=0,t=Math.floor(this.nominalSkip+.5),this.sampleReq=Math.max(t+this.overlapLength,this.seekWindowLength)+this.seekLength}get tempo(){return this._tempo}get inputChunkSize(){return this.sampleReq}get outputChunkSize(){return this.overlapLength+Math.max(0,this.seekWindowLength-2*this.overlapLength)}calculateOverlapLength(e=0){let t;t=this.sampleRate*e/1e3,t=t<16?16:t,t-=t%8,this.overlapLength=t,this.refMidBuffer=new Float32Array(2*this.overlapLength),this.midBuffer=new Float32Array(2*this.overlapLength)}checkLimits(e,t,i){return e<t?t:e>i?i:e}calculateSequenceParameters(){let e,t;this.autoSeqSetting&&(e=130+-20*this._tempo,e=this.checkLimits(e,50,125),this.sequenceMs=Math.floor(e+.5)),this.autoSeekSetting&&(t=25.666666666666668+Fi*this._tempo,t=this.checkLimits(t,15,25),this.seekWindowMs=Math.floor(t+.5)),this.seekWindowLength=Math.floor(this.sampleRate*this.sequenceMs/1e3),this.seekLength=Math.floor(this.sampleRate*this.seekWindowMs/1e3)}set quickSeek(e){this._quickSeek=e}clone(){const e=new ki;return e.tempo=this._tempo,e.setParameters(this.sampleRate,this.sequenceMs,this.seekWindowMs,this.overlapMs),e}seekBestOverlapPosition(){return this._quickSeek?this.seekBestOverlapPositionStereoQuick():this.seekBestOverlapPositionStereo()}seekBestOverlapPositionStereo(){let e,t,i,r=0;for(this.preCalculateCorrelationReferenceStereo(),e=0,t=Number.MIN_VALUE;r<this.seekLength;r+=1)i=this.calculateCrossCorrelationStereo(2*r,this.refMidBuffer),i>t&&(t=i,e=r);return e}seekBestOverlapPositionStereoQuick(){let e,t,i,r,n,s=0;for(this.preCalculateCorrelationReferenceStereo(),t=Number.MIN_VALUE,e=0,r=0,n=0;s<4;s+=1){let o=0;for(;Di[s][o]&&(n=r+Di[s][o],!(n>=this.seekLength));)i=this.calculateCrossCorrelationStereo(2*n,this.refMidBuffer),i>t&&(t=i,e=n),o+=1;r=e}return e}preCalculateCorrelationReferenceStereo(){let e,t,i=0;for(;i<this.overlapLength;i+=1)t=i*(this.overlapLength-i),e=2*i,this.refMidBuffer[e]=this.midBuffer[e]*t,this.refMidBuffer[e+1]=this.midBuffer[e+1]*t}calculateCrossCorrelationStereo(e,t){const i=this._inputBuffer.vector;e+=this._inputBuffer.startIndex;let r=0,n=2;const s=2*this.overlapLength;let o;for(;n<s;n+=2)o=n+e,r+=i[o]*t[n]+i[o+1]*t[n+1];return r}overlap(e){this.overlapStereo(2*e)}overlapStereo(e){const t=this._inputBuffer.vector;e+=this._inputBuffer.startIndex;const i=this._outputBuffer.vector,r=this._outputBuffer.endIndex;let n,s,o=0;const a=1/this.overlapLength;let u,c,h;for(;o<this.overlapLength;o+=1)s=(this.overlapLength-o)*a,u=o*a,n=2*o,c=n+e,h=n+r,i[h+0]=t[c+0]*u+this.midBuffer[n+0]*s,i[h+1]=t[c+1]*u+this.midBuffer[n+1]*s}process(){let e,t,i;if(null===this.midBuffer){if(this._inputBuffer.frameCount<this.overlapLength)return;this.midBuffer=new Float32Array(2*this.overlapLength),this._inputBuffer.receiveSamples(this.midBuffer,this.overlapLength)}for(;this._inputBuffer.frameCount>=this.sampleReq;){e=this.seekBestOverlapPosition(),this._outputBuffer.ensureAdditionalCapacity(this.overlapLength),this.overlap(Math.floor(e)),this._outputBuffer.put(this.overlapLength),t=this.seekWindowLength-2*this.overlapLength,t>0&&this._outputBuffer.putBuffer(this._inputBuffer,e+this.overlapLength,t);const r=this._inputBuffer.startIndex+2*(e+this.seekWindowLength-this.overlapLength);this.midBuffer.set(this._inputBuffer.vector.subarray(r,r+2*this.overlapLength)),this.skipFract+=this.nominalSkip,i=Math.floor(this.skipFract),this.skipFract-=i,this._inputBuffer.receive(i)}}}const xi=function(e,t){return(e>t?e-t:t-e)>1e-10};class Li{constructor(){this.transposer=new Pi(!1),this.stretch=new ki(!1),this._inputBuffer=new Bi,this._intermediateBuffer=new Bi,this._outputBuffer=new Bi,this._rate=0,this._tempo=0,this.virtualPitch=1,this.virtualRate=1,this.virtualTempo=1,this.calculateEffectiveRateAndTempo()}clear(){this.transposer.clear(),this.stretch.clear()}clone(){const e=new Li;return e.rate=this.rate,e.tempo=this.tempo,e}get rate(){return this._rate}set rate(e){this.virtualRate=e,this.calculateEffectiveRateAndTempo()}set rateChange(e){this._rate=1+.01*e}get tempo(){return this._tempo}set tempo(e){this.virtualTempo=e,this.calculateEffectiveRateAndTempo()}set tempoChange(e){this.tempo=1+.01*e}set pitch(e){this.virtualPitch=e,this.calculateEffectiveRateAndTempo()}set pitchOctaves(e){this.pitch=Math.exp(.69314718056*e),this.calculateEffectiveRateAndTempo()}set pitchSemitones(e){this.pitchOctaves=e/12}get inputBuffer(){return this._inputBuffer}get outputBuffer(){return this._outputBuffer}calculateEffectiveRateAndTempo(){const e=this._tempo,t=this._rate;this._tempo=this.virtualTempo/this.virtualPitch,this._rate=this.virtualRate*this.virtualPitch,xi(this._tempo,e)&&(this.stretch.tempo=this._tempo),xi(this._rate,t)&&(this.transposer.rate=this._rate),this._rate>1?this._outputBuffer!=this.transposer.outputBuffer&&(this.stretch.inputBuffer=this._inputBuffer,this.stretch.outputBuffer=this._intermediateBuffer,this.transposer.inputBuffer=this._intermediateBuffer,this.transposer.outputBuffer=this._outputBuffer):this._outputBuffer!=this.stretch.outputBuffer&&(this.transposer.inputBuffer=this._inputBuffer,this.transposer.outputBuffer=this._intermediateBuffer,this.stretch.inputBuffer=this._intermediateBuffer,this.stretch.outputBuffer=this._outputBuffer)}process(){this._rate>1?(this.stretch.process(),this.transposer.process()):(this.transposer.process(),this.stretch.process())}}class Gi{constructor(e){this.buffer=e,this._position=0}get dualChannel(){return this.buffer.numberOfChannels>1}get position(){return this._position}set position(e){this._position=e}extract(e,t=0,i=0){this.position=i;let r=this.buffer.getChannelData(0),n=this.dualChannel?this.buffer.getChannelData(1):this.buffer.getChannelData(0),s=0;for(;s<t;s++)e[2*s]=r[s+i],e[2*s+1]=n[s+i];return Math.min(t,r.length-i)}}const Ui=function(e){const t=Math.floor(e/60);return`${t}:${function(e,t,i){return i=i||"0",(e+="").length>=t?e:new Array(t-e.length+1).join(i)+e}(parseInt(e-60*t),2)}`},Wi=function(e){const t=this.timePlayed,i=this.sampleRate;if(this.sourcePosition=e,this.timePlayed=e/i,t!==this.timePlayed){const e=new CustomEvent("play",{detail:{timePlayed:this.timePlayed,formattedTimePlayed:this.formattedTimePlayed,percentagePlayed:this.percentagePlayed}});this._node.dispatchEvent(e)}};class Vi{constructor(e,t,i,r=Ni){this._soundtouch=new Li;const n=new Gi(t);this.timePlayed=0,this.sourcePosition=0,this._filter=new Oi(n,this._soundtouch,r),this._node=function(e,t,i=Ni,r=4096){const n=e.createScriptProcessor(r,2,2),s=new Float32Array(2*r);return n.onaudioprocess=e=>{let n=e.outputBuffer.getChannelData(0),o=e.outputBuffer.getChannelData(1),a=t.extract(s,r);i(t.sourcePosition),0===a&&t.onEnd();let u=0;for(;u<a;u++)n[u]=s[2*u],o[u]=s[2*u+1]},n}(e,this._filter,(e=>Wi.call(this,e)),i),this.tempo=1,this.rate=1,this.duration=t.duration,this.sampleRate=e.sampleRate,this.listeners=[]}get formattedDuration(){return Ui(this.duration)}get formattedTimePlayed(){return Ui(this.timePlayed)}get percentagePlayed(){return 100*this._filter.sourcePosition/(this.duration*this.sampleRate)}set percentagePlayed(e){this._filter.sourcePosition=parseInt(e*this.duration*this.sampleRate),this.sourcePosition=this._filter.sourcePosition,this.timePlayed=this.sourcePosition/this.sampleRate}get node(){return this._node}set pitch(e){this._soundtouch.pitch=e}set pitchSemitones(e){this._soundtouch.pitchSemitones=e}set rate(e){this._soundtouch.rate=e}set tempo(e){this._soundtouch.tempo=e}connect(e){this._node.connect(e)}disconnect(){this._node.disconnect()}on(e,t){this.listeners.push({name:e,cb:t}),this._node.addEventListener(e,(e=>t(e.detail)))}off(e=null){let t=this.listeners;e&&(t=t.filter((t=>t.name===e))),t.forEach((e=>{this._node.removeEventListener(e.name,(t=>e.cb(t.detail)))}))}}let ji;"undefined"!=typeof window&&void 0!==window.AudioWorkletNode&&(ji=class extends AudioWorkletNode{constructor(e,t,i){super(e,t,i),this.name="",this.running=!1,this._tempo=1,this._pitch=1,this.name=this.constructor.name,this.running=!0,this.updateInterval=i.processorOptions.updateInterval}setup(e,t){return r(this,void 0,void 0,(function*(){return new Promise((i=>{this.port&&(this.port.onmessage=e=>{e&&e.data&&"OK"===e.data.status&&"setup"===e.data.args[0]&&(this.port.onmessage=this.messageProcessor.bind(this),i())},this.port.postMessage({command:"setup",args:[e,t]}),this._tempo=e,this._pitch=t)}))}))}set updateInterval(e){this.port.postMessage({command:"updateInterval",args:[e]})}get node(){return this}set tempo(e){this.port.postMessage({command:"setTempo",args:[e]})}set pitch(e){this.port.postMessage({command:"setPitch",args:[e]})}get tempo(){return this.port.postMessage({command:"getTempo",args:[]}),this._tempo}get pitch(){return this.port.postMessage({command:"getPitch",args:[]}),this._pitch}stop(){return r(this,void 0,void 0,(function*(){this.running&&(this.port.postMessage({command:"stop",args:[]}),this.disconnect(),this.running=!1)}))}messageProcessor(e){if(e.data.command){const{command:t}=e.data;if("End"===t)this.stop();if(e.data.status){const t=e.data.args[1];switch(e.data.args[0]){case"getTempo":this._tempo=t;break;case"getPitch":this._pitch=t}return}}}});var qi=ji;class Hi extends zt{constructor(){super(),this.speedAudio=1,this.frequencyAudio=1,this.currentSpeedAudio=1,this.isOfflineMode=!1,this.setDefaultEnabled(!0)}initializeWorklet(){return r(this,void 0,void 0,(function*(){}))}receiveEvent(e){}get workletPath(){return kt.WORKLET_PATHS.SOUNDTOUCH}constructAudioWorkletProcessor(){throw new Error("Method not implemented.")}get workletName(){return kt.WORKLET_NAMES.SOUNDTOUCH}getEntrypointNode(e,t,i){return r(this,void 0,void 0,(function*(){if(this.isOfflineMode=i,this.cleanUpOldNodes(),i){if(!this.isEnabled()||1==this.speedAudio&&1==this.frequencyAudio){const i=e.createBufferSource();return i.buffer=t,i.start(),{input:i,output:i}}return this.isAudioWorkletEnabled()&&Mt.isAudioWorkletCompatible(e)&&1==this.speedAudio?this.renderWithWorklet(t,e):this.renderWithScriptProcessorNode(t,e)}return this.currentPitchShifter=this.getSoundtouchScriptProcessorNode(t,e),this.updateState(),{input:this.currentPitchShifter,output:this.currentPitchShifter}}))}cleanUpOldNodes(){this.currentPitchShifterWorklet&&(this.currentPitchShifterWorklet.stop(),this.currentPitchShifterWorklet.disconnect()),this.currentPitchShifter&&(this.currentPitchShifter.disconnect(),this.currentPitchShifter._filter=null)}getSoundtouchScriptProcessorNode(e,t){return new Vi(t,e,kt.SOUNDTOUCH_PITCH_SHIFTER_BUFFER_SIZE)}renderWithScriptProcessorNode(e,t){return r(this,void 0,void 0,(function*(){const i=Mt.calcAudioDuration(e,this.speedAudio),r=new OfflineAudioContext(2,t.sampleRate*i,t.sampleRate);this.currentPitchShifter=this.getSoundtouchScriptProcessorNode(e,r),this.updateState(),this.currentPitchShifter.connect(r.destination);const n=yield r.startRendering(),s=t.createBufferSource();return s.buffer=n,s.start(),this.cleanUpOldNodes(),{input:s,output:s}}))}renderWithWorklet(e,t){return r(this,void 0,void 0,(function*(){const i=Mt.calcAudioDuration(e,this.speedAudio);try{yield t.audioWorklet.addModule((this.configService?this.configService.getWorkletBasePath():"")+kt.WORKLET_PATHS.SOUNDTOUCH);const r=t.createBufferSource();return r.buffer=e,r.start(),this.currentPitchShifterWorklet=new qi(t,"soundtouch-worklet",{processorOptions:{bypass:!1,recording:!1,nInputFrames:this.approximateNInputFrames(i,t),updateInterval:10,sampleRate:e.sampleRate}}),r.connect(this.currentPitchShifterWorklet.node),this.isEnabled()?yield this.currentPitchShifterWorklet.setup(this.speedAudio,this.frequencyAudio):yield this.currentPitchShifterWorklet.setup(1,1),{input:this.currentPitchShifterWorklet,output:this.currentPitchShifterWorklet}}catch(i){return console.error(i),this.renderWithScriptProcessorNode(e,t)}}))}approximateNInputFrames(e,t){return e*t.sampleRate*(Math.round(14*Math.exp(-4*this.frequencyAudio))+1)}get order(){return 2}get id(){return kt.FILTERS_NAMES.SOUNDTOUCH}getSettings(){return{speedAudio:this.speedAudio,frequencyAudio:this.frequencyAudio}}isAudioWorkletEnabled(){return this.configService?this.configService.isSoundtouchAudioWorkletEnabled():kt.ENABLE_SOUNDTOUCH_AUDIO_WORKLET}getCurrentPitchShifter(){return this.isOfflineMode?1==this.speedAudio&&1==this.frequencyAudio?null:this.isAudioWorkletEnabled()&&this.currentPitchShifterWorklet&&1==this.speedAudio?this.currentPitchShifterWorklet:this.currentPitchShifter:this.currentPitchShifter}updateState(){const e=this.getCurrentPitchShifter();this.isEnabled()?(e&&(e.pitch=this.frequencyAudio,e.tempo=this.speedAudio),this.currentSpeedAudio=this.speedAudio):(e&&(e.pitch=1,e.tempo=1),this.currentSpeedAudio=1)}setSetting(e,t){return r(this,void 0,void 0,(function*(){if(!Mt.isSettingValueValid(t))return;const i=parseFloat(t);switch(e){case"speedAudio":this.speedAudio=i;break;case"frequencyAudio":this.frequencyAudio=i}this.updateState()}))}setEnabled(e){super.setEnabled(e),this.updateState()}getSpeed(){return this.currentSpeedAudio}}class Ki extends qt{getNode(e){const t=e.createBiquadFilter();t.type="lowpass",t.frequency.value=2e3;const i=e.createBiquadFilter();i.type="lowpass",i.frequency.value=2e3;const r=e.createBiquadFilter();r.type="highpass",r.frequency.value=500;const n=e.createBiquadFilter();return n.type="highpass",n.frequency.value=500,t.connect(i),i.connect(r),r.connect(n),{input:t,output:n}}get order(){return 7}get id(){return kt.FILTERS_NAMES.TELEPHONIZER}getSettings(){return{}}setSetting(e,t){return r(this,void 0,void 0,(function*(){}))}}class $i{constructor(e,t,i){this.FILTER_QUALITY=6,this.FOURIER_SIZE=4096,this.WAVETABLEBOOST=40,this.SAWTOOTHBOOST=.4,this.oscillatorType=4,this.oscillatorDetuneValue=0,this.audioContext=null,this.carrierBuffer=null,this.modulatorNode=null,this.vocoding=!1,this.modulatorInput=null,this.carrierInput=null,this.modulatorGain=null,this.modulatorGainValue=1,this.noiseBuffer=null,this.noiseNode=null,this.noiseGain=null,this.noiseGainValue=.2,this.carrierSampleNode=null,this.carrierSampleGain=null,this.carrierSampleGainValue=0,this.oscillatorNode=null,this.oscillatorGain=null,this.oscillatorGainValue=1,this.wavetable=null,this.wavetableSignalGain=null,this.modFilterBands=null,this.modFilterPostGains=null,this.heterodynes=null,this.powers=null,this.lpFilters=null,this.lpFilterPostGains=null,this.carrierBands=null,this.carrierFilterPostGains=null,this.carrierBandGains=null,this.vocoderBands=null,this.numVocoderBands=0,this.hpFilterGain=null,this.outputGain=null,this.audioContext=e,this.carrierBuffer=t,this.modulatorBuffer=i}init(){this.generateVocoderBands(55,7040,28),this.setupVocoderGraph(),this.vocode()}getNodes(){return{modulatorNode:this.modulatorNode,modulatorGain:this.modulatorGain,synthLevel:this.oscillatorGain,noiseNode:this.noiseGain,oscillatorNode:this.oscillatorNode,hpFilterGain:this.hpFilterGain,outputGain:this.outputGain}}shutOffCarrier(){this.oscillatorNode&&this.noiseNode&&this.carrierSampleNode&&(this.oscillatorNode.stop(0),this.oscillatorNode=null,this.noiseNode.stop(0),this.noiseNode=null,this.carrierSampleNode.stop(0),this.carrierSampleNode=null)}selectSawtooth(){this.wavetableSignalGain&&(this.wavetableSignalGain.gain.value=this.SAWTOOTHBOOST),this.oscillatorNode&&(this.oscillatorNode.type="sawtooth")}selectWavetable(){this.wavetableSignalGain&&(this.wavetableSignalGain.gain.value=this.WAVETABLEBOOST),this.oscillatorNode&&this.wavetable&&this.oscillatorNode.setPeriodicWave(this.wavetable),this.wavetableSignalGain&&(this.wavetableSignalGain.gain.value=this.WAVETABLEBOOST)}updateModGain(e){this.modulatorGainValue=e,this.modulatorGain&&(this.modulatorGain.gain.value=e)}updateSampleLevel(e){this.carrierSampleGainValue=e,this.carrierSampleGain&&(this.carrierSampleGain.gain.value=e)}updateSynthLevel(e){this.oscillatorGainValue=e,this.oscillatorGain&&(this.oscillatorGain.gain.value=e)}updateNoiseLevel(e){this.noiseGainValue=e,this.noiseGain&&(this.noiseGain.gain.value=e)}updateDetuneValue(e){this.oscillatorDetuneValue=e,this.oscillatorNode&&(this.oscillatorNode.detune.value=e)}generateVocoderBands(e,t,i){const r=1200*Math.log(t/e)/Math.LN2/i,n=Math.pow(2,r/1200);this.vocoderBands=[];let s=e;for(let e=0;e<i;e++)this.vocoderBands[e]={frequency:s},s*=n;this.numVocoderBands=i}loadNoiseBuffer(){if(!this.audioContext)return;const e=5*this.audioContext.sampleRate;this.noiseBuffer=this.audioContext.createBuffer(1,e,this.audioContext.sampleRate);const t=this.noiseBuffer.getChannelData(0);for(let i=0;i<e;++i)t[i]=2*Math.random()-1}initBandpassFilters(){if(!this.audioContext)return;this.modulatorInput=this.audioContext.createGain(),this.carrierInput=this.audioContext.createGain(),null==this.modFilterBands&&(this.modFilterBands=[]),null==this.modFilterPostGains&&(this.modFilterPostGains=[]),null==this.heterodynes&&(this.heterodynes=[]),null==this.powers&&(this.powers=[]),null==this.lpFilters&&(this.lpFilters=[]),null==this.lpFilterPostGains&&(this.lpFilterPostGains=[]),null==this.carrierBands&&(this.carrierBands=[]),null==this.carrierFilterPostGains&&(this.carrierFilterPostGains=[]),null==this.carrierBandGains&&(this.carrierBandGains=[]);const e=new Float32Array(65536),t=32768;let i;for(let r=0;r<t;++r)i=r/t,e[t+r]=i,e[t-r-1]=i;const r=this.audioContext.createBiquadFilter();r.type="highpass",r.frequency.value=8e3,r.Q.value=1,this.modulatorInput.connect(r),this.hpFilterGain=this.audioContext.createGain(),this.hpFilterGain.gain.value=0,r.connect(this.hpFilterGain),this.modulatorBuffer&&this.hpFilterGain.connect(this.audioContext.destination),this.modFilterBands.length=0,this.modFilterPostGains.length=0,this.heterodynes.length=0,this.powers.length=0,this.lpFilters.length=0,this.lpFilterPostGains.length=0,this.carrierBands.length=0,this.carrierFilterPostGains.length=0,this.carrierBandGains.length=0,this.outputGain=this.audioContext.createGain(),this.modulatorBuffer&&this.outputGain.connect(this.audioContext.destination);const n=new Float32Array(65536);for(let e=-32768;e<32768;e++)n[e+32768]=(e>0?e:-e)/32768;for(let t=0;t<this.numVocoderBands;t++){const i=this.audioContext.createBiquadFilter();i.type="bandpass",this.vocoderBands&&(i.frequency.value=this.vocoderBands[t].frequency),i.Q.value=this.FILTER_QUALITY,this.modulatorInput.connect(i),this.modFilterBands.push(i);const r=this.audioContext.createBiquadFilter();r.type="bandpass",this.vocoderBands&&(r.frequency.value=this.vocoderBands[t].frequency),r.Q.value=this.FILTER_QUALITY,i.connect(r);const s=this.audioContext.createGain();s.gain.value=6,r.connect(s),this.modFilterPostGains.push(s);const o=this.audioContext.createOscillator();this.vocoderBands&&(o.frequency.value=this.vocoderBands[t].frequency),o.start(0);const a=this.audioContext.createGain();s.connect(a),a.gain.value=0,o.connect(a.gain);const u=this.audioContext.createGain();u.gain.value=2,a.connect(u),this.heterodynes.push(u);const c=this.audioContext.createWaveShaper();c.curve=n,u.connect(c);const h=this.audioContext.createBiquadFilter();h.type="lowpass",h.frequency.value=5,h.Q.value=1,this.lpFilters.push(h),c.connect(h);const l=this.audioContext.createGain();l.gain.value=1,h.connect(l),this.lpFilterPostGains.push(l);const d=this.audioContext.createWaveShaper();d.curve=e,l.connect(d);const f=this.audioContext.createBiquadFilter();f.type="bandpass",this.vocoderBands&&(f.frequency.value=this.vocoderBands[t].frequency),f.Q.value=this.FILTER_QUALITY,this.carrierBands.push(f),this.carrierInput.connect(f);const p=this.audioContext.createBiquadFilter();p.type="bandpass",this.vocoderBands&&(p.frequency.value=this.vocoderBands[t].frequency),p.Q.value=this.FILTER_QUALITY,f.connect(p);const g=this.audioContext.createGain();g.gain.value=10,p.connect(g),this.carrierFilterPostGains.push(g);const m=this.audioContext.createGain();this.carrierBandGains.push(m),g.connect(m),m.gain.value=0,d.connect(m.gain),m.connect(this.outputGain)}const s=new Float32Array(this.FOURIER_SIZE),o=new Float32Array(this.FOURIER_SIZE);s[0]=0,o[0]=0;for(let e=1;e<this.FOURIER_SIZE;e++)s[e]=1,o[e]=1;this.wavetable=this.audioContext.createPeriodicWave(s,o),this.loadNoiseBuffer()}setupVocoderGraph(){this.initBandpassFilters()}createCarriersAndPlay(e){this.audioContext&&e&&(this.carrierSampleNode=this.audioContext.createBufferSource(),this.carrierSampleNode.buffer=this.carrierBuffer,this.carrierSampleNode.loop=!0,this.carrierSampleGain=this.audioContext.createGain(),this.carrierSampleGain.gain.value=this.carrierSampleGainValue,this.carrierSampleNode.connect(this.carrierSampleGain),this.carrierSampleGain.connect(e),this.wavetableSignalGain=this.audioContext.createGain(),this.oscillatorNode=this.audioContext.createOscillator(),4==this.oscillatorType&&this.wavetable?(this.oscillatorNode.setPeriodicWave(this.wavetable),this.wavetableSignalGain.gain.value=this.WAVETABLEBOOST):this.wavetableSignalGain.gain.value=this.SAWTOOTHBOOST,this.oscillatorNode.frequency.value=110,this.oscillatorNode.detune.value=this.oscillatorDetuneValue,this.oscillatorNode.connect(this.wavetableSignalGain),this.oscillatorGain=this.audioContext.createGain(),this.oscillatorGain.gain.value=this.oscillatorGainValue,this.wavetableSignalGain.connect(this.oscillatorGain),this.oscillatorGain.connect(e),this.noiseNode=this.audioContext.createBufferSource(),this.noiseNode.buffer=this.noiseBuffer,this.noiseNode.loop=!0,this.noiseGain=this.audioContext.createGain(),this.noiseGain.gain.value=this.noiseGainValue,this.noiseNode.connect(this.noiseGain),this.noiseGain.connect(e),this.oscillatorNode.start(0),this.noiseNode.start(0),this.carrierSampleNode.start(0))}vocode(){if(this.audioContext){if(this.vocoding)return this.modulatorNode&&this.modulatorNode.stop(0),this.shutOffCarrier(),void(this.vocoding=!1);this.createCarriersAndPlay(this.carrierInput),this.vocoding=!0,this.modulatorGain=this.audioContext.createGain(),this.modulatorGain.gain.value=this.modulatorGainValue,this.modulatorBuffer&&(this.modulatorNode=this.audioContext.createBufferSource(),this.modulatorNode.buffer=this.modulatorBuffer,this.modulatorNode.connect(this.modulatorGain),this.modulatorNode.start(0)),this.modulatorInput&&this.modulatorGain.connect(this.modulatorInput)}}}class Yi extends qt{constructor(){super(...arguments),this.currentVocoder=null,this.modulatorGainValue=1,this.carrierSampleGainValue=0,this.oscillatorGainValue=1,this.noiseGainValue=.2,this.oscillatorDetuneValue=0}getNode(e){var t;const i=null===(t=this.bufferFetcherService)||void 0===t?void 0:t.getAudioBuffer(kt.VOCODER_MODULATOR);this.currentVocoder=new $i(e,i),this.currentVocoder.init(),this.applyCurrentSettingsToVocoder();const{modulatorGain:r,outputGain:n}=this.currentVocoder.getNodes();return{input:r,output:n}}getSettings(){return{modulatorGainValue:this.modulatorGainValue,carrierSampleGainValue:this.carrierSampleGainValue,oscillatorGainValue:this.oscillatorGainValue,noiseGainValue:this.noiseGainValue,oscillatorDetuneValue:this.oscillatorDetuneValue}}setSetting(e,t){return r(this,void 0,void 0,(function*(){if(Mt.isSettingValueValid(t)){switch(e){case"modulatorGainValue":this.modulatorGainValue=parseFloat(t);break;case"carrierSampleGainValue":this.carrierSampleGainValue=parseFloat(t);break;case"oscillatorGainValue":this.oscillatorGainValue=parseFloat(t);break;case"noiseGainValue":this.noiseGainValue=parseFloat(t);break;case"oscillatorDetuneValue":this.oscillatorDetuneValue=parseFloat(t)}this.applyCurrentSettingsToVocoder()}}))}applyCurrentSettingsToVocoder(){this.currentVocoder&&(this.currentVocoder.updateModGain(this.modulatorGainValue),this.currentVocoder.updateSampleLevel(this.carrierSampleGainValue),this.currentVocoder.updateSynthLevel(this.oscillatorGainValue),this.currentVocoder.updateNoiseLevel(this.noiseGainValue),this.currentVocoder.updateDetuneValue(this.oscillatorDetuneValue))}get order(){return 1}get id(){return kt.FILTERS_NAMES.VOCODER}}class zi extends AudioWorkletProcessor{constructor(){super(),this.stopped=!1,this.samplesCount=0,this.port.onmessage=e=>{"stop"==e.data&&this.stop()}}static get parameterDescriptors(){return[]}get defaultParameterDescriptors(){return zi.parameterDescriptors}process(e,t){if(this.stopped)return!1;const i=e[0],r=t[0];if(i&&i[0]&&(this.samplesCount+=i[0].length),r){for(let e=0;e<r.length;e++){const t=i[e],n=r[e];if(t)for(let e=0;e<t.length;e++)n[e]=t[e]}this.port.postMessage({command:"update",samplesCount:this.samplesCount})}return!0}stop(){this.stopped=!0}}registerProcessor(kt.WORKLET_NAMES.PASSTHROUGH,zi);class Xi extends zt{constructor(){super(...arguments),this.currentTime=0,this.lastSampleCount=0,this.samplePerSecond=0,this.currentTimeSamplesPerSecond=0}receiveEvent(e){const t=performance.now(),i=e.data.samplesCount;"update"===e.data.command&&this.calculatePercentageProcessed(t,i),this.calculateRemainingTimeProcessing(t,i)}calculatePercentageProcessed(e,t){0===this.currentTime&&(this.currentTime=e);const i=e-this.currentTime,r=t/this._totalSamples;this.eventEmitter&&i>=kt.TREATMENT_TIME_COUNTING_THROTTLE_INTERVAL&&(this.eventEmitter.emit(Ct.UPDATE_AUDIO_TREATMENT_PERCENT,100*r),this.currentTime=e)}calculateRemainingTimeProcessing(e,t){0===this.currentTimeSamplesPerSecond&&(this.currentTimeSamplesPerSecond=e);const i=e-this.currentTimeSamplesPerSecond,r=this._totalSamples-t;if(this.eventEmitter&&r<=0)this.eventEmitter.emit(Ct.UPDATE_REMAINING_TIME_ESTIMATED,0);else if(this.eventEmitter&&i>=1e3){this.calculateSmoothedSamplePerSecond(i,t);const n=r/this.samplePerSecond;this.currentTimeSamplesPerSecond=e,this.lastSampleCount=t,isNaN(n)||!isFinite(n)?this.eventEmitter.emit(Ct.UPDATE_REMAINING_TIME_ESTIMATED,-1):this.eventEmitter.emit(Ct.UPDATE_REMAINING_TIME_ESTIMATED,n)}}calculateSmoothedSamplePerSecond(e,t){if(e>0){const i=(t-this.lastSampleCount)/(e/1e3);this.samplePerSecond=kt.TREATMENT_TIME_COUNTING_SMOOTHING_FACTOR*i+(1-kt.TREATMENT_TIME_COUNTING_SMOOTHING_FACTOR)*this.samplePerSecond}}get workletName(){return kt.WORKLET_NAMES.PASSTHROUGH}get workletPath(){return kt.WORKLET_PATHS.PASSTHROUGH}get order(){return 10}get id(){return kt.FILTERS_NAMES.PASSTHROUGH}set totalSamples(e){super.totalSamples=e,this.currentTime=0,this.currentTimeSamplesPerSecond=0,this.samplePerSecond=0,this.lastSampleCount=0}getSettings(){return{}}isEnabled(){return!0}setSetting(e,t){return r(this,void 0,void 0,(function*(){}))}}class Qi{static createNewInstance(e){const t=function(){const e=new wt({defaultScope:"Singleton"});return e.bind(Rt.EntryPointFilter).to(Hi),e.bind(Rt.Renderers).to(vi),e.bind(Rt.Filters).toDynamicValue((()=>e.get(Rt.EntryPointFilter))),e.bind(Rt.Filters).to(Ei),e.bind(Rt.Filters).to(Si),e.bind(Rt.Filters).to(bi),e.bind(Rt.Filters).to(_i),e.bind(Rt.Filters).to(Ri),e.bind(Rt.Filters).to(Ii),e.bind(Rt.Filters).to(Ci),e.bind(Rt.Filters).to(Ki),e.bind(Rt.Filters).to(Yi),e.bind(Rt.Filters).to(Xi),e.bind(Rt.EventEmitter).to(Zt),e.bind(Rt.AudioContextManager).to(ii),e.bind(Rt.AudioEditor).to(Tt),e.bind(Rt.AudioProcessor).to(ni),e.bind(Rt.BufferManager).to(oi),e.bind(Rt.FilterManager).to(ui),e.bind(Rt.RendererManager).to(hi),e.bind(Rt.SaveBufferManager).to(di),e.bind(Rt.BufferPlayer).to(Ot),e.bind(Rt.BufferFetcherService).to(pi),e.bind(Rt.BufferDecoderService).to(mi),e.bind(Rt.VoiceRecorder).to(Wt),e}();return e&&e.configService?t.bind(Rt.ConfigService).toDynamicValue((()=>e.configService)):(t.bind(Rt.ConfigService).to(ei),console.warn("No ConfigService provided. Using default generic implementation.")),t.bind(Rt.AudioBuffersToFetch).toConstantValue(e&&e.buffersToFetch||[]),{audioEditor:t.get(Rt.AudioEditor),audioPlayer:t.get(Rt.BufferPlayer),configService:t.get(Rt.ConfigService),eventEmitter:t.get(Rt.EventEmitter),voiceRecorder:t.get(Rt.VoiceRecorder)}}static createAudioEditor(e,t){if(console.warn("[DEPRECATED] SoundStudioFactory.createAudioEditor is deprecated and will be removed in a future release of simple-sound-studio-lib. Please use SoundStudioFactory.createNewInstance instead, which doesn't work as a singleton."),!Qi.ready){const i=Qi.createNewInstance({configService:e,buffersToFetch:t});Qi.audioEditor=i.audioEditor,Qi.audioPlayer=i.audioPlayer,Qi.configService=i.configService,Qi.eventEmitter=i.eventEmitter,Qi.voiceRecorder=i.voiceRecorder,Qi.ready=!0}return Qi.audioEditor}static createVoiceRecorder(){return console.warn("[DEPRECATED] SoundStudioFactory.createVoiceRecorder is deprecated and will be removed in a future release of simple-sound-studio-lib. Please use SoundStudioFactory.createNewInstance instead, which doesn't work as a singleton."),Qi.voiceRecorder}static getAudioEditorInstance(){return console.warn("[DEPRECATED] SoundStudioFactory.getAudioEditorInstance is deprecated and will be removed in a future release of simple-sound-studio-lib. Please use SoundStudioFactory.createNewInstance instead, which doesn't work as a singleton."),Qi.audioEditor}static getAudioPlayerInstance(){return console.warn("[DEPRECATED] SoundStudioFactory.getAudioPlayerInstance is deprecated and will be removed in a future release of simple-sound-studio-lib. Please use SoundStudioFactory.createNewInstance instead, which doesn't work as a singleton."),Qi.audioPlayer}static getAudioRecorderInstance(){return console.warn("[DEPRECATED] SoundStudioFactory.getAudioRecorderInstance is deprecated and will be removed in a future release of simple-sound-studio-lib. Please use SoundStudioFactory.createNewInstance instead, which doesn't work as a singleton."),Qi.voiceRecorder}static getEventEmitterInstance(){return console.warn("[DEPRECATED] SoundStudioFactory.getEventEmitterInstance is deprecated and will be removed in a future release of simple-sound-studio-lib. Please use SoundStudioFactory.createNewInstance instead, which doesn't work as a singleton."),Qi.eventEmitter}static getConfigServiceInstance(){return console.warn("[DEPRECATED] SoundStudioFactory.getConfigServiceInstance is deprecated and will be removed in a future release of simple-sound-studio-lib. Please use SoundStudioFactory.createNewInstance instead, which doesn't work as a singleton."),Qi.configService}}Qi.ready=!1,Qi.audioEditor=null,Qi.audioPlayer=null,Qi.configService=null,Qi.eventEmitter=null,Qi.voiceRecorder=null;export{Bt as AbstractAudioElement,qt as AbstractAudioFilter,zt as AbstractAudioFilterWorklet,jt as AbstractAudioNode,Xt as AbstractAudioRenderer,Tt as AudioEditor,Ot as BufferPlayer,kt as Constants,Zt as EventEmitter,Ct as EventType,Ft as FilterNames,ei as GenericConfigService,Qi as SoundStudioFactory,Mt as UtilFunctions,Wt as VoiceRecorder};
//# sourceMappingURL=SimpleSoundStudioLibrary.js.map
