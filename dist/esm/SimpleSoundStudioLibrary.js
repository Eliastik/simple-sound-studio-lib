function e(e,t,i,s){return new(i||(i=Promise))((function(r,a){function n(e){try{l(s.next(e))}catch(e){a(e)}}function o(e){try{l(s.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,o)}l((s=s.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;class t{constructor(){this.enabled=!1,this.defaultEnabled=!1,this.bufferFetcherService=null,this.bufferDecoderService=null,this.configService=null}isEnabled(){return this.enabled}isDefaultEnabled(){return this.defaultEnabled}setDefaultEnabled(e){this.defaultEnabled=e}setEnabled(e){this.enabled=e}enable(){this.setEnabled(!0)}disable(){this.setEnabled(!1)}toggle(){this.setEnabled(!this.isEnabled())}}class i extends t{constructor(){super(...arguments),this.defaultSettings=null,this.eventEmitter=void 0}getAddingTime(){return 0}initializeDefaultSettings(){this.defaultSettings=this.getSettings()}getDefaultSettings(){return this.defaultSettings}resetSettings(){return e(this,void 0,void 0,(function*(){if(this.defaultSettings)for(const e in this.defaultSettings)this.defaultSettings&&void 0!==this.defaultSettings[e]&&(yield this.setSetting(e,this.defaultSettings[e]))}))}isWorklet(){return!1}}const s={AUDIO_EDITOR:"audioEditor",VOICE_RECORDER:"voiceRecorder",BUFFER_PLAYER:"bufferPlayer",EXPORT_WAV_COMMAND:"exportWAV",EXPORT_MP3_COMMAND:"exportMP3",AUDIO_WAV:"audio/wav",RECORD_COMMAND:"record",INIT_COMMAND:"init",FILTERS_NAMES:{REVERB:"reverb",ECHO:"echo",BASS_BOOST:"bassboost",BITCRUSHER:"bitcrusher",HIGH_PASS:"highpass",LIMITER:"limiter",LOW_PASS:"lowpass",PASSTHROUGH:"passthroughfilter",RETURN_AUDIO:"returnAudio",SOUNDTOUCH:"soundtouch",TELEPHONIZER:"telephonizer",VOCODER:"vocoder"},WORKLET_PATHS:{BITCRUSHER:"BitCrusher.worklet.js",LIMITER:"Limiter.worklet.js",SOUNDTOUCH:"Soundtouch.worklet.js",RECORDER_WORKLET:"RecorderWorklet.js",PASSTHROUGH:"Passthrough.worklet.js"},WORKLET_NAMES:{BITCRUSHER:"bitcrusher-processor",LIMITER:"limiter-processor",SOUNDTOUCH:"soundtouch-worklet",RECORDER_WORKLET:"recorder-worklet",PASSTHROUGH:"passthrough"},PREFERENCES_KEYS:{COMPATIBILITY_MODE_ENABLED:"compatibility-mode-enabled",COMPATIBILITY_MODE_CHECKED:"compatibility-mode-checked",ENABLE_AUDIO_WORKLET:"enable-audio-worklet",ENABLE_SOUNDTOUCH_AUDIO_WORKLET:"enable-soundtouch-audio-worklet",BUFFER_SIZE:"buffer-size",SAMPLE_RATE:"sample-rate",DISABLE_INITIAL_RENDERING:"disable-initial-rendering"},ENABLE_SOUNDTOUCH_AUDIO_WORKLET:!0,ENABLE_AUDIO_WORKLET:!0,ENABLE_RECORDER_AUDIO_WORKLET:!0,SOUNDTOUCH_PITCH_SHIFTER_BUFFER_SIZE:16384,DEFAULT_REVERB_ENVIRONMENT:{name:"Medium Damping Cave E002 M2S",url:"impulse_response.wav",size:1350278,addDuration:4,link:"http://www.cksde.com/p_6_250.htm"},VOCODER_MODULATOR:"modulator.mp3",DEFAULT_BUFFER_SIZE:0,VALID_BUFFER_SIZE:[0,256,512,1024,2048,4096,8192,16384],DEFAULT_SAMPLE_RATE:0,VALID_SAMPLE_RATES:[0,8e3,11025,16e3,22050,32e3,44100,48e3,88200,96e3,176400,192e3],TREATMENT_TIME_COUNTING_THROTTLE_INTERVAL:100,TREATMENT_TIME_COUNTING_SMOOTHING_FACTOR:.9,DISABLE_INITIAL_RENDERING:!0,DEFAULT_SAVE_FORMAT:"mp3",DEFAULT_MP3_BITRATE:320};var r="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function a(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var n={};function o(e){return new Int16Array(e)}function l(e){return new Int32Array(e)}function h(e){return new Float32Array(e)}var _={fill:function(e,t,i,s){if(2==arguments.length)for(var r=0;r<e.length;r++)e[r]=arguments[1];else for(r=t;r<i;r++)e[r]=s}},u={arraycopy:function(e,t,i,s,r){for(var a=t+r;t<a;)i[s++]=e[t++]},out:{}};u.out.println=function(e){console.log(e)},u.out.printf=function(){console.log.apply(console,arguments)};var c={};function f(e){this.ordinal=e}c.SQRT2=1.4142135623730951,c.FAST_LOG10=function(e){return Math.log10(e)},c.FAST_LOG10_X=function(e,t){return Math.log10(e)*t},f.short_block_allowed=new f(0),f.short_block_coupled=new f(1),f.short_block_dispensed=new f(2),f.short_block_forced=new f(3);var d={};function p(e){this.ordinal=e}d.MAX_VALUE=34028235e31,p.vbr_off=new p(0),p.vbr_mt=new p(1),p.vbr_rh=new p(2),p.vbr_abr=new p(3),p.vbr_mtrh=new p(4),p.vbr_default=p.vbr_mtrh;var m,b,v,g,S,E,R,A,B={System:u,VbrMode:p,Float:d,ShortBlock:f,Util:c,Arrays:_,new_array_n:function e(t){if(1==t.length)return new Array(t[0]);var i=t[0];t=t.slice(1);for(var s=[],r=0;r<i;r++)s.push(e(t));return s},new_byte:function(e){return new Int8Array(e)},new_double:function(e){return new Float64Array(e)},new_float:h,new_float_n:function e(t){if(1==t.length)return h(t[0]);var i=t[0];t=t.slice(1);for(var s=[],r=0;r<i;r++)s.push(e(t));return s},new_int:l,new_int_n:function e(t){if(1==t.length)return l(t[0]);var i=t[0];t=t.slice(1);for(var s=[],r=0;r<i;r++)s.push(e(t));return s},new_short:o,new_short_n:function e(t){if(1==t.length)return o(t[0]);var i=t[0];t=t.slice(1);for(var s=[],r=0;r<i;r++)s.push(e(t));return s},assert:function(e){}};function w(){if(g)return v;g=1;var e=T(),t=B,i=t.System;t.VbrMode,t.Float,t.ShortBlock,t.Util,t.Arrays,t.new_array_n,t.new_byte,t.new_double;var s=t.new_float,r=t.new_float_n;return t.new_int,t.new_int_n,t.assert,v=function(){this.l=s(e.SBMAX_l),this.s=r([e.SBMAX_s,3]);var t=this;this.assign=function(s){i.arraycopy(s.l,0,t.l,0,e.SBMAX_l);for(var r=0;r<e.SBMAX_s;r++)for(var a=0;a<3;a++)t.s[r][a]=s.s[r][a]}}}function T(){if(A)return R;A=1;var e=B,t=e.System,i=e.VbrMode;e.Float,e.ShortBlock,e.Util,e.Arrays;var s=e.new_array_n;e.new_byte,e.new_double;var r=e.new_float,a=e.new_float_n,n=e.new_int;e.new_int_n;var o=e.assert;function l(){var e=function(){if(b)return m;b=1;var e=B,t=e.System;e.VbrMode,e.Float,e.ShortBlock;var i=e.Util,s=e.Arrays;e.new_array_n,e.new_byte,e.new_double;var r=e.new_float;e.new_float_n,e.new_int,e.new_int_n,e.assert;var a=T();return m=function(){var e=[-.1482523854003001,32.308141959636465,296.40344946382766,883.1344870032432,11113.947376231741,1057.2713659324597,305.7402417275812,30.825928907280012,3.8533188138216365,59.42900443849514,709.5899960123345,5281.91112291017,-5829.66483675846,-817.6293103748613,-76.91656988279972,-4.594269939176596,.9063471690191471,.1960342806591213,-.15466694054279598,34.324387823855965,301.8067566458425,817.599602898885,11573.795901679885,1181.2520595540152,321.59731579894424,31.232021761053772,3.7107095756221318,53.650946155329365,684.167428119626,5224.56624370173,-6366.391851890084,-908.9766368219582,-89.83068876699639,-5.411397422890401,.8206787908286602,.3901806440322567,-.16070888947830023,36.147034243915876,304.11815768187864,732.7429163887613,11989.60988270091,1300.012278487897,335.28490093152146,31.48816102859945,3.373875931311736,47.232241542899175,652.7371796173471,5132.414255594984,-6909.087078780055,-1001.9990371107289,-103.62185754286375,-6.104916304710272,.7416505462720353,.5805693545089249,-.16636367662261495,37.751650073343995,303.01103387567713,627.9747488785183,12358.763425278165,1412.2779918482834,346.7496836825721,31.598286663170416,3.1598635433980946,40.57878626349686,616.1671130880391,5007.833007176154,-7454.040671756168,-1095.7960341867115,-118.24411666465777,-6.818469345853504,.6681786379192989,.7653668647301797,-.1716176790982088,39.11551877123304,298.3413246578966,503.5259106886539,12679.589408408976,1516.5821921214542,355.9850766329023,31.395241710249053,2.9164211881972335,33.79716964664243,574.8943997801362,4853.234992253242,-7997.57021486075,-1189.7624067269965,-133.6444792601766,-7.7202770609839915,.5993769336819237,.9427934736519954,-.17645823955292173,40.21879108166477,289.9982036694474,359.3226160751053,12950.259102786438,1612.1013903507662,362.85067106591504,31.045922092242872,2.822222032597987,26.988862316190684,529.8996541764288,4671.371946949588,-8535.899136645805,-1282.5898586244496,-149.58553632943463,-8.643494270763135,.5345111359507916,1.111140466039205,-.36174739330527045,41.04429910497807,277.5463268268618,195.6386023135583,13169.43812144731,1697.6433561479398,367.40983966190305,30.557037410382826,2.531473372857427,20.070154905927314,481.50208566532336,4464.970341588308,-9065.36882077239,-1373.62841526722,-166.1660487028118,-9.58289321133207,.4729647758913199,1.268786568327291,-.36970682634889585,41.393213350082036,261.2935935556502,12.935476055240873,13336.131683328815,1772.508612059496,369.76534388639965,29.751323653701338,2.4023193045459172,13.304795348228817,430.5615775526625,4237.0568611071185,-9581.931701634761,-1461.6913552409758,-183.12733958476446,-10.718010163869403,.41421356237309503,1.414213562373095,-.37677560326535325,41.619486213528496,241.05423794991074,-187.94665032361226,13450.063605744153,1836.153896465782,369.4908799925761,29.001847876923147,2.0714759319987186,6.779591200894186,377.7767837205709,3990.386575512536,-10081.709459700915,-1545.947424837898,-200.3762958015653,-11.864482073055006,.3578057213145241,1.546020906725474,-.3829366947518991,41.1516456456653,216.47684307105183,-406.1569483347166,13511.136535077321,1887.8076599260432,367.3025214564151,28.136213436723654,1.913880671464418,.3829366947518991,323.85365704338597,3728.1472257487526,-10561.233882199509,-1625.2025997821418,-217.62525175416,-13.015432208941645,.3033466836073424,1.66293922460509,-.5822628872992417,40.35639251440489,188.20071124269245,-640.2706748618148,13519.21490106562,1927.6022433578062,362.8197642637487,26.968821921868447,1.7463817695935329,-5.62650678237171,269.3016715297017,3453.386536448852,-11016.145278780888,-1698.6569643425091,-234.7658734267683,-14.16351421663124,.2504869601913055,1.76384252869671,-.5887180101749253,39.23429103868072,155.76096234403798,-889.2492977967378,13475.470561874661,1955.0535223723712,356.4450994756727,25.894952980042156,1.5695032905781554,-11.181939564328772,214.80884394039484,3169.1640829158237,-11443.321309975563,-1765.1588461316153,-251.68908574481912,-15.49755935939164,.198912367379658,1.847759065022573,-.7912582233652842,37.39369355329111,119.699486012458,-1151.0956593239027,13380.446257078214,1970.3952110853447,348.01959814116185,24.731487364283044,1.3850130831637748,-16.421408865300393,161.05030052864092,2878.3322807850063,-11838.991423510031,-1823.985884688674,-268.2854986386903,-16.81724543849939,.1483359875383474,1.913880671464418,-.7960642926861912,35.2322109610459,80.01928065061526,-1424.0212633405113,13235.794061869668,1973.804052543835,337.9908651258184,23.289159354463873,1.3934255946442087,-21.099669467133474,108.48348407242611,2583.700758091299,-12199.726194855148,-1874.2780658979746,-284.2467154529415,-18.11369784385905,.09849140335716425,1.961570560806461,-.998795456205172,32.56307803611191,36.958364584370486,-1706.075448829146,13043.287458812016,1965.3831106103316,326.43182772364605,22.175018750622293,1.198638339011324,-25.371248002043963,57.53505923036915,2288.41886619975,-12522.674544337233,-1914.8400385312243,-299.26241273417224,-19.37805630698734,.04912684976946725,1.990369453344394,.035780907*i.SQRT2*.5/2384e-9,.017876148*i.SQRT2*.5/2384e-9,.003134727*i.SQRT2*.5/2384e-9,.002457142*i.SQRT2*.5/2384e-9,971317e-9*i.SQRT2*.5/2384e-9,218868e-9*i.SQRT2*.5/2384e-9,101566e-9*i.SQRT2*.5/2384e-9,13828e-9*i.SQRT2*.5/2384e-9,12804.797818791945,1945.5515939597317,313.4244966442953,20.801593959731544,1995.1556208053692,9.000838926174497,-29.20218120805369],n=[[2382191739347913e-28,6423305872147834e-28,9400849094049688e-28,1122435026096556e-27,1183840321267481e-27,1122435026096556e-27,940084909404969e-27,6423305872147839e-28,2382191739347918e-28,5456116108943412e-27,4878985199565852e-27,4240448995017367e-27,3559909094758252e-27,2858043359288075e-27,2156177623817898e-27,1475637723558783e-27,8371015190102974e-28,2599706096327376e-28,-5456116108943412e-27,-4878985199565852e-27,-4240448995017367e-27,-3559909094758252e-27,-2858043359288076e-27,-2156177623817898e-27,-1475637723558783e-27,-8371015190102975e-28,-2599706096327376e-28,-2382191739347923e-28,-6423305872147843e-28,-9400849094049696e-28,-1122435026096556e-27,-1183840321267481e-27,-1122435026096556e-27,-9400849094049694e-28,-642330587214784e-27,-2382191739347918e-28],[2382191739347913e-28,6423305872147834e-28,9400849094049688e-28,1122435026096556e-27,1183840321267481e-27,1122435026096556e-27,9400849094049688e-28,6423305872147841e-28,2382191739347918e-28,5456116108943413e-27,4878985199565852e-27,4240448995017367e-27,3559909094758253e-27,2858043359288075e-27,2156177623817898e-27,1475637723558782e-27,8371015190102975e-28,2599706096327376e-28,-5461314069809755e-27,-4921085770524055e-27,-4343405037091838e-27,-3732668368707687e-27,-3093523840190885e-27,-2430835727329465e-27,-1734679010007751e-27,-974825365660928e-27,-2797435120168326e-28,0,0,0,0,0,0,-2283748241799531e-28,-4037858874020686e-28,-2146547464825323e-28],[.1316524975873958,.414213562373095,.7673269879789602,1.091308501069271,1.303225372841206,1.56968557711749,1.920982126971166,2.414213562373094,3.171594802363212,4.510708503662055,7.595754112725146,22.90376554843115,.984807753012208,.6427876096865394,.3420201433256688,.9396926207859084,-.1736481776669303,-.7660444431189779,.8660254037844387,.5,-.5144957554275265,-.4717319685649723,-.3133774542039019,-.1819131996109812,-.09457419252642064,-.04096558288530405,-.01419856857247115,-.003699974673760037,.8574929257125442,.8817419973177052,.9496286491027329,.9833145924917901,.9955178160675857,.9991605581781475,.999899195244447,.9999931550702802],[0,0,0,0,0,0,2283748241799531e-28,4037858874020686e-28,2146547464825323e-28,5461314069809755e-27,4921085770524055e-27,4343405037091838e-27,3732668368707687e-27,3093523840190885e-27,2430835727329466e-27,1734679010007751e-27,974825365660928e-27,2797435120168326e-28,-5456116108943413e-27,-4878985199565852e-27,-4240448995017367e-27,-3559909094758253e-27,-2858043359288075e-27,-2156177623817898e-27,-1475637723558782e-27,-8371015190102975e-28,-2599706096327376e-28,-2382191739347913e-28,-6423305872147834e-28,-9400849094049688e-28,-1122435026096556e-27,-1183840321267481e-27,-1122435026096556e-27,-9400849094049688e-28,-6423305872147841e-28,-2382191739347918e-28]],o=n[a.SHORT_TYPE],l=n[a.SHORT_TYPE],h=n[a.SHORT_TYPE],_=n[a.SHORT_TYPE],u=[0,1,16,17,8,9,24,25,4,5,20,21,12,13,28,29,2,3,18,19,10,11,26,27,6,7,22,23,14,15,30,31];function c(t,s,r){for(var a,n,o,l=10,h=s+238-14-286,_=-15;_<0;_++){var u,c,f;u=e[l+-10],c=t[h+-224]*u,f=t[s+224]*u,u=e[l+-9],c+=t[h+-160]*u,f+=t[s+160]*u,u=e[l+-8],c+=t[h+-96]*u,f+=t[s+96]*u,u=e[l+-7],c+=t[h+-32]*u,f+=t[s+32]*u,u=e[l+-6],c+=t[h+32]*u,f+=t[s+-32]*u,u=e[l+-5],c+=t[h+96]*u,f+=t[s+-96]*u,u=e[l+-4],c+=t[h+160]*u,f+=t[s+-160]*u,u=e[l+-3],c+=t[h+224]*u,f+=t[s+-224]*u,u=e[l+-2],c+=t[s+-256]*u,f-=t[h+256]*u,u=e[l+-1],c+=t[s+-192]*u,f-=t[h+192]*u,u=e[l+0],c+=t[s+-128]*u,f-=t[h+128]*u,u=e[l+1],c+=t[s+-64]*u,f-=t[h+64]*u,u=e[l+2],c+=t[s+0]*u,f-=t[h+0]*u,u=e[l+3],c+=t[s+64]*u,f-=t[h+-64]*u,u=e[l+4],c+=t[s+128]*u,f-=t[h+-128]*u,u=e[l+5],c+=t[s+192]*u,u=(f-=t[h+-192]*u)-(c*=e[l+6]),r[30+2*_]=f+c,r[31+2*_]=e[l+7]*u,l+=18,s--,h++}f=t[s+-16]*e[l+-10],c=t[s+-32]*e[l+-2],f+=(t[s+-48]-t[s+16])*e[l+-9],c+=t[s+-96]*e[l+-1],f+=(t[s+-80]+t[s+48])*e[l+-8],c+=t[s+-160]*e[l+0],f+=(t[s+-112]-t[s+80])*e[l+-7],c+=t[s+-224]*e[l+1],f+=(t[s+-144]+t[s+112])*e[l+-6],c-=t[s+32]*e[l+2],f+=(t[s+-176]-t[s+144])*e[l+-5],c-=t[s+96]*e[l+3],f+=(t[s+-208]+t[s+176])*e[l+-4],c-=t[s+160]*e[l+4],f+=(t[s+-240]-t[s+208])*e[l+-3],a=(c-=t[s+224])-f,n=c+f,f=r[14],c=r[15]-f,r[31]=n+f,r[30]=a+c,r[15]=a-c,r[14]=n-f,o=r[28]-r[0],r[0]+=r[28],r[28]=o*e[l+-36+7],o=r[29]-r[1],r[1]+=r[29],r[29]=o*e[l+-36+7],o=r[26]-r[2],r[2]+=r[26],r[26]=o*e[l+-72+7],o=r[27]-r[3],r[3]+=r[27],r[27]=o*e[l+-72+7],o=r[24]-r[4],r[4]+=r[24],r[24]=o*e[l+-108+7],o=r[25]-r[5],r[5]+=r[25],r[25]=o*e[l+-108+7],o=r[22]-r[6],r[6]+=r[22],r[22]=o*i.SQRT2,o=r[23]-r[7],r[7]+=r[23],r[23]=o*i.SQRT2-r[7],r[7]-=r[6],r[22]-=r[7],r[23]-=r[22],o=r[6],r[6]=r[31]-o,r[31]=r[31]+o,o=r[7],r[7]=r[30]-o,r[30]=r[30]+o,o=r[22],r[22]=r[15]-o,r[15]=r[15]+o,o=r[23],r[23]=r[14]-o,r[14]=r[14]+o,o=r[20]-r[8],r[8]+=r[20],r[20]=o*e[l+-180+7],o=r[21]-r[9],r[9]+=r[21],r[21]=o*e[l+-180+7],o=r[18]-r[10],r[10]+=r[18],r[18]=o*e[l+-216+7],o=r[19]-r[11],r[11]+=r[19],r[19]=o*e[l+-216+7],o=r[16]-r[12],r[12]+=r[16],r[16]=o*e[l+-252+7],o=r[17]-r[13],r[13]+=r[17],r[17]=o*e[l+-252+7],o=-r[20]+r[24],r[20]+=r[24],r[24]=o*e[l+-216+7],o=-r[21]+r[25],r[21]+=r[25],r[25]=o*e[l+-216+7],o=r[4]-r[8],r[4]+=r[8],r[8]=o*e[l+-216+7],o=r[5]-r[9],r[5]+=r[9],r[9]=o*e[l+-216+7],o=r[0]-r[12],r[0]+=r[12],r[12]=o*e[l+-72+7],o=r[1]-r[13],r[1]+=r[13],r[13]=o*e[l+-72+7],o=r[16]-r[28],r[16]+=r[28],r[28]=o*e[l+-72+7],o=-r[17]+r[29],r[17]+=r[29],r[29]=o*e[l+-72+7],o=i.SQRT2*(r[2]-r[10]),r[2]+=r[10],r[10]=o,o=i.SQRT2*(r[3]-r[11]),r[3]+=r[11],r[11]=o,o=i.SQRT2*(-r[18]+r[26]),r[18]+=r[26],r[26]=o-r[18],o=i.SQRT2*(-r[19]+r[27]),r[19]+=r[27],r[27]=o-r[19],o=r[2],r[19]-=r[3],r[3]-=o,r[2]=r[31]-o,r[31]+=o,o=r[3],r[11]-=r[19],r[18]-=o,r[3]=r[30]-o,r[30]+=o,o=r[18],r[27]-=r[11],r[19]-=o,r[18]=r[15]-o,r[15]+=o,o=r[19],r[10]-=o,r[19]=r[14]-o,r[14]+=o,o=r[10],r[11]-=o,r[10]=r[23]-o,r[23]+=o,o=r[11],r[26]-=o,r[11]=r[22]-o,r[22]+=o,o=r[26],r[27]-=o,r[26]=r[7]-o,r[7]+=o,o=r[27],r[27]=r[6]-o,r[6]+=o,o=i.SQRT2*(r[0]-r[4]),r[0]+=r[4],r[4]=o,o=i.SQRT2*(r[1]-r[5]),r[1]+=r[5],r[5]=o,o=i.SQRT2*(r[16]-r[20]),r[16]+=r[20],r[20]=o,o=i.SQRT2*(r[17]-r[21]),r[17]+=r[21],r[21]=o,o=-i.SQRT2*(r[8]-r[12]),r[8]+=r[12],r[12]=o-r[8],o=-i.SQRT2*(r[9]-r[13]),r[9]+=r[13],r[13]=o-r[9],o=-i.SQRT2*(r[25]-r[29]),r[25]+=r[29],r[29]=o-r[25],o=-i.SQRT2*(r[24]+r[28]),r[24]-=r[28],r[28]=o-r[24],o=r[24]-r[16],r[24]=o,o=r[20]-o,r[20]=o,o=r[28]-o,r[28]=o,o=r[25]-r[17],r[25]=o,o=r[21]-o,r[21]=o,o=r[29]-o,r[29]=o,o=r[17]-r[1],r[17]=o,o=r[9]-o,r[9]=o,o=r[25]-o,r[25]=o,o=r[5]-o,r[5]=o,o=r[21]-o,r[21]=o,o=r[13]-o,r[13]=o,o=r[29]-o,r[29]=o,o=r[1]-r[0],r[1]=o,o=r[16]-o,r[16]=o,o=r[17]-o,r[17]=o,o=r[8]-o,r[8]=o,o=r[9]-o,r[9]=o,o=r[24]-o,r[24]=o,o=r[25]-o,r[25]=o,o=r[4]-o,r[4]=o,o=r[5]-o,r[5]=o,o=r[20]-o,r[20]=o,o=r[21]-o,r[21]=o,o=r[12]-o,r[12]=o,o=r[13]-o,r[13]=o,o=r[28]-o,r[28]=o,o=r[29]-o,r[29]=o,o=r[0],r[0]+=r[31],r[31]-=o,o=r[1],r[1]+=r[30],r[30]-=o,o=r[16],r[16]+=r[15],r[15]-=o,o=r[17],r[17]+=r[14],r[14]-=o,o=r[8],r[8]+=r[23],r[23]-=o,o=r[9],r[9]+=r[22],r[22]-=o,o=r[24],r[24]+=r[7],r[7]-=o,o=r[25],r[25]+=r[6],r[6]-=o,o=r[4],r[4]+=r[27],r[27]-=o,o=r[5],r[5]+=r[26],r[26]-=o,o=r[20],r[20]+=r[11],r[11]-=o,o=r[21],r[21]+=r[10],r[10]-=o,o=r[12],r[12]+=r[19],r[19]-=o,o=r[13],r[13]+=r[18],r[18]-=o,o=r[28],r[28]+=r[3],r[3]-=o,o=r[29],r[29]+=r[2],r[2]-=o}function f(e,t){for(var i=0;i<3;i++){var s,r,o,l,h,_;r=(l=e[t+6]*n[a.SHORT_TYPE][0]-e[t+15])+(s=e[t+0]*n[a.SHORT_TYPE][2]-e[t+9]),o=l-s,h=(l=e[t+15]*n[a.SHORT_TYPE][0]+e[t+6])+(s=e[t+9]*n[a.SHORT_TYPE][2]+e[t+0]),_=-l+s,s=2069978111953089e-26*(e[t+3]*n[a.SHORT_TYPE][1]-e[t+12]),l=2069978111953089e-26*(e[t+12]*n[a.SHORT_TYPE][1]+e[t+3]),e[t+0]=190752519173728e-25*r+s,e[t+15]=190752519173728e-25*-h+l,o=.8660254037844387*o*1907525191737281e-26,h=.5*h*1907525191737281e-26+l,e[t+3]=o-h,e[t+6]=o+h,r=.5*r*1907525191737281e-26-s,_=.8660254037844387*_*1907525191737281e-26,e[t+9]=r+_,e[t+12]=r-_,t++}}this.mdct_sub48=function(e,i,d){for(var p,m,b,v,g,S,E,R,A,B,w,T,M,y,k,P,N,I,x,C,O,D=i,L=286,F=0;F<e.channels_out;F++){for(var V=0;V<e.mode_gr;V++){for(var H,G=e.l3_side.tt[V][F],U=G.xr,q=0,W=e.sb_sample[F][1-V],X=0,Y=0;Y<9;Y++)for(c(D,L,W[X]),c(D,L+32,W[X+1]),X+=2,L+=64,H=1;H<32;H+=2)W[X-1][H]*=-1;for(H=0;H<32;H++,q+=18){var K=G.block_type,j=e.sb_sample[F][V],z=e.sb_sample[F][1-V];if(0!=G.mixed_block_flag&&H<2&&(K=0),e.amp_filter[H]<1e-12)s.fill(U,q+0,q+18,0);else{if(e.amp_filter[H]<1)for(Y=0;Y<18;Y++)z[Y][u[H]]*=e.amp_filter[H];if(K==a.SHORT_TYPE){for(Y=-3;Y<0;Y++){var Z=n[a.SHORT_TYPE][Y+3];U[q+3*Y+9]=j[9+Y][u[H]]*Z-j[8-Y][u[H]],U[q+3*Y+18]=j[14-Y][u[H]]*Z+j[15+Y][u[H]],U[q+3*Y+10]=j[15+Y][u[H]]*Z-j[14-Y][u[H]],U[q+3*Y+19]=z[2-Y][u[H]]*Z+z[3+Y][u[H]],U[q+3*Y+11]=z[3+Y][u[H]]*Z-z[2-Y][u[H]],U[q+3*Y+20]=z[8-Y][u[H]]*Z+z[9+Y][u[H]]}f(U,q)}else{var Q=r(18);for(Y=-9;Y<0;Y++){var J,$;J=n[K][Y+27]*z[Y+9][u[H]]+n[K][Y+36]*z[8-Y][u[H]],$=n[K][Y+9]*j[Y+9][u[H]]-n[K][Y+18]*j[8-Y][u[H]],Q[Y+9]=J-$*o[3+Y+9],Q[Y+18]=J*o[3+Y+9]+$}p=U,m=q,v=void 0,g=void 0,S=void 0,E=void 0,R=void 0,A=void 0,B=void 0,w=void 0,T=void 0,M=void 0,y=void 0,k=void 0,P=void 0,N=void 0,I=void 0,x=void 0,C=void 0,O=void 0,S=(b=Q)[17]-b[9],R=b[15]-b[11],A=b[14]-b[12],B=b[0]+b[8],w=b[1]+b[7],T=b[2]+b[6],M=b[3]+b[5],p[m+17]=B+T-M-(w-b[4]),g=(B+T-M)*l[19]+(w-b[4]),v=(S-R-A)*l[18],p[m+5]=v+g,p[m+6]=v-g,E=(b[16]-b[10])*l[18],w=w*l[19]+b[4],v=S*l[12]+E+R*l[13]+A*l[14],g=-B*l[16]+w-T*l[17]+M*l[15],p[m+1]=v+g,p[m+2]=v-g,v=S*l[13]-E-R*l[14]+A*l[12],g=-B*l[17]+w-T*l[15]+M*l[16],p[m+9]=v+g,p[m+10]=v-g,v=S*l[14]-E+R*l[12]-A*l[13],g=B*l[15]-w+T*l[16]-M*l[17],p[m+13]=v+g,p[m+14]=v-g,y=b[8]-b[0],P=b[6]-b[2],N=b[5]-b[3],I=b[17]+b[9],x=b[16]+b[10],C=b[15]+b[11],O=b[14]+b[12],p[m+0]=I+C+O+(x+b[13]),v=(I+C+O)*l[19]-(x+b[13]),g=(y-P+N)*l[18],p[m+11]=v+g,p[m+12]=v-g,k=(b[7]-b[1])*l[18],x=b[13]-x*l[19],v=I*l[15]-x+C*l[16]+O*l[17],g=y*l[14]+k+P*l[12]+N*l[13],p[m+3]=v+g,p[m+4]=v-g,v=-I*l[17]+x-C*l[15]-O*l[16],g=y*l[13]+k-P*l[14]-N*l[12],p[m+7]=v+g,p[m+8]=v-g,v=-I*l[16]+x-C*l[17]-O*l[15],g=y*l[12]-k+P*l[13]-N*l[14],p[m+15]=v+g,p[m+16]=v-g}}if(K!=a.SHORT_TYPE&&0!=H)for(Y=7;Y>=0;--Y){var ee,te;ee=U[q+Y]*h[20+Y]+U[q+-1-Y]*_[28+Y],te=U[q+Y]*_[28+Y]-U[q+-1-Y]*h[20+Y],U[q+-1-Y]=ee,U[q+Y]=te}}}if(D=d,L=286,1==e.mode_gr)for(var ie=0;ie<18;ie++)t.arraycopy(e.sb_sample[F][1][ie],0,e.sb_sample[F][0][ie],0,32)}}}}(),h=function(){if(E)return S;E=1;var e=w();return S=function(){this.thm=new e,this.en=new e}}(),_=l.FFTOFFSET,u=l.MPG_MD_MS_LR,c=null;this.psy=null;var f=null,d=null,p=null;this.setModules=function(e,t,i,s){c=e,this.psy=t,f=t,d=s,p=i};var v=new e;this.lame_encode_mp3_frame=function(e,m,b,g,S,E){var R,A=s([2,2]);A[0][0]=new h,A[0][1]=new h,A[1][0]=new h,A[1][1]=new h;var B,w=s([2,2]);w[0][0]=new h,w[0][1]=new h,w[1][0]=new h,w[1][1]=new h;var T,M,y,k=[null,null],P=e.internal_flags,N=a([2,4]),I=[.5,.5],x=[[0,0],[0,0]],C=[[0,0],[0,0]];if(k[0]=m,k[1]=b,0==P.lame_encode_frame_init&&function(e,t){var i,s,a=e.internal_flags;if(0==a.lame_encode_frame_init){var n,h,_=r(2014),u=r(2014);for(a.lame_encode_frame_init=1,n=0,h=0;n<286+576*(1+a.mode_gr);++n)n<576*a.mode_gr?(_[n]=0,2==a.channels_out&&(u[n]=0)):(_[n]=t[0][h],2==a.channels_out&&(u[n]=t[1][h]),++h);for(s=0;s<a.mode_gr;s++)for(i=0;i<a.channels_out;i++)a.l3_side.tt[s][i].block_type=l.SHORT_TYPE;v.mdct_sub48(a,_,u),o(576>=l.FFTOFFSET),o(a.mf_size>=l.BLKSIZE+e.framesize-l.FFTOFFSET),o(a.mf_size>=512+e.framesize-32)}}(e,k),P.padding=0,(P.slot_lag-=P.frac_SpF)<0&&(P.slot_lag+=e.out_samplerate,P.padding=1),0!=P.psymodel){var O=[null,null],D=0,L=n(2);for(y=0;y<P.mode_gr;y++){for(M=0;M<P.channels_out;M++)O[M]=k[M],D=576+576*y-l.FFTOFFSET;if(0!=(e.VBR==i.vbr_mtrh||e.VBR==i.vbr_mt?f.L3psycho_anal_vbr(e,O,D,y,A,w,x[y],C[y],N[y],L):f.L3psycho_anal_ns(e,O,D,y,A,w,x[y],C[y],N[y],L)))return-4;for(e.mode==MPEGMode.JOINT_STEREO&&(I[y]=N[y][2]+N[y][3],I[y]>0&&(I[y]=N[y][3]/I[y])),M=0;M<P.channels_out;M++){var F=P.l3_side.tt[y][M];F.block_type=L[M],F.mixed_block_flag=0}}}else for(y=0;y<P.mode_gr;y++)for(M=0;M<P.channels_out;M++)P.l3_side.tt[y][M].block_type=l.NORM_TYPE,P.l3_side.tt[y][M].mixed_block_flag=0,C[y][M]=x[y][M]=700;if(function(e){var t,i;if(0!=e.ATH.useAdjust)if(i=e.loudness_sq[0][0],t=e.loudness_sq[1][0],2==e.channels_out?(i+=e.loudness_sq[0][1],t+=e.loudness_sq[1][1]):(i+=i,t+=t),2==e.mode_gr&&(i=Math.max(i,t)),i*=.5,(i*=e.ATH.aaSensitivityP)>.03125)e.ATH.adjust>=1?e.ATH.adjust=1:e.ATH.adjust<e.ATH.adjustLimit&&(e.ATH.adjust=e.ATH.adjustLimit),e.ATH.adjustLimit=1;else{var s=31.98*i+625e-6;e.ATH.adjust>=s?(e.ATH.adjust*=.075*s+.925,e.ATH.adjust<s&&(e.ATH.adjust=s)):e.ATH.adjustLimit>=s?e.ATH.adjust=s:e.ATH.adjust<e.ATH.adjustLimit&&(e.ATH.adjust=e.ATH.adjustLimit),e.ATH.adjustLimit=s}else e.ATH.adjust=1}(P),v.mdct_sub48(P,k[0],k[1]),P.mode_ext=l.MPG_MD_LR_LR,e.force_ms)P.mode_ext=l.MPG_MD_MS_LR;else if(e.mode==MPEGMode.JOINT_STEREO){var V=0,H=0;for(y=0;y<P.mode_gr;y++)for(M=0;M<P.channels_out;M++)V+=C[y][M],H+=x[y][M];if(V<=1*H){var G=P.l3_side.tt[0],U=P.l3_side.tt[P.mode_gr-1];G[0].block_type==G[1].block_type&&U[0].block_type==U[1].block_type&&(P.mode_ext=l.MPG_MD_MS_LR)}}if(P.mode_ext==u?(B=w,T=C):(B=A,T=x),e.analysis&&null!=P.pinfo)for(y=0;y<P.mode_gr;y++)for(M=0;M<P.channels_out;M++)P.pinfo.ms_ratio[y]=P.ms_ratio[y],P.pinfo.ms_ener_ratio[y]=I[y],P.pinfo.blocktype[y][M]=P.l3_side.tt[y][M].block_type,P.pinfo.pe[y][M]=T[y][M],t.arraycopy(P.l3_side.tt[y][M].xr,0,P.pinfo.xr[y][M],0,576),P.mode_ext==u&&(P.pinfo.ers[y][M]=P.pinfo.ers[y][M+2],t.arraycopy(P.pinfo.energy[y][M+2],0,P.pinfo.energy[y][M],0,P.pinfo.energy[y][M].length));if(e.VBR==i.vbr_off||e.VBR==i.vbr_abr){var q,W;for(q=0;q<18;q++)P.nsPsy.pefirbuf[q]=P.nsPsy.pefirbuf[q+1];for(W=0,y=0;y<P.mode_gr;y++)for(M=0;M<P.channels_out;M++)W+=T[y][M];for(P.nsPsy.pefirbuf[18]=W,W=P.nsPsy.pefirbuf[9],q=0;q<9;q++)W+=(P.nsPsy.pefirbuf[q]+P.nsPsy.pefirbuf[18-q])*l.fircoef[q];for(W=3350*P.mode_gr*P.channels_out/W,y=0;y<P.mode_gr;y++)for(M=0;M<P.channels_out;M++)T[y][M]*=W}if(P.iteration_loop.iteration_loop(e,T,I,B),c.format_bitstream(e),R=c.copy_buffer(P,g,S,E,1),e.bWriteVbrTag&&d.addVbrFrame(e),e.analysis&&null!=P.pinfo){for(M=0;M<P.channels_out;M++){var X;for(X=0;X<_;X++)P.pinfo.pcmdata[M][X]=P.pinfo.pcmdata[M][X+e.framesize];for(X=_;X<1600;X++)P.pinfo.pcmdata[M][X]=k[M][X-_]}p.set_frame_pinfo(e,B)}return function(e){var t,i;for(o(0<=e.bitrate_index&&e.bitrate_index<16),o(0<=e.mode_ext&&e.mode_ext<4),e.bitrate_stereoMode_Hist[e.bitrate_index][4]++,e.bitrate_stereoMode_Hist[15][4]++,2==e.channels_out&&(e.bitrate_stereoMode_Hist[e.bitrate_index][e.mode_ext]++,e.bitrate_stereoMode_Hist[15][e.mode_ext]++),t=0;t<e.mode_gr;++t)for(i=0;i<e.channels_out;++i){var s=0|e.l3_side.tt[t][i].block_type;0!=e.l3_side.tt[t][i].mixed_block_flag&&(s=4),e.bitrate_blockType_Hist[e.bitrate_index][s]++,e.bitrate_blockType_Hist[e.bitrate_index][5]++,e.bitrate_blockType_Hist[15][s]++,e.bitrate_blockType_Hist[15][5]++}}(P),R}}return l.ENCDELAY=576,l.POSTDELAY=1152,l.MDCTDELAY=48,l.FFTOFFSET=224+l.MDCTDELAY,l.DECDELAY=528,l.SBLIMIT=32,l.CBANDS=64,l.SBPSY_l=21,l.SBPSY_s=12,l.SBMAX_l=22,l.SBMAX_s=13,l.PSFB21=6,l.PSFB12=6,l.BLKSIZE=1024,l.HBLKSIZE=l.BLKSIZE/2+1,l.BLKSIZE_s=256,l.HBLKSIZE_s=l.BLKSIZE_s/2+1,l.NORM_TYPE=0,l.START_TYPE=1,l.SHORT_TYPE=2,l.STOP_TYPE=3,l.MPG_MD_LR_LR=0,l.MPG_MD_LR_I=1,l.MPG_MD_MS_LR=2,l.MPG_MD_MS_I=3,l.fircoef=[-.1039435,-.1892065,5*-.0432472,-.155915,3898045e-23,.0467745*5,.50455,.756825,.187098*5],R=l}a(B);var M=B;M.System,M.VbrMode,M.Float,M.ShortBlock;var y=M.Util;M.Arrays,M.new_array_n,M.new_byte,M.new_double;var k=M.new_float;M.new_float_n,M.new_int,M.new_int_n,M.assert;var P=T();var N=function(){var e=k(P.BLKSIZE),t=k(P.BLKSIZE_s/2),i=[.9238795325112867,.3826834323650898,.9951847266721969,.0980171403295606,.9996988186962042,.02454122852291229,.9999811752826011,.006135884649154475];function s(e,t,s){var r,a,n,o=0,l=t+(s<<=1);r=4;do{var h,_,u,c,f,d,p;p=r>>1,d=(f=r<<1)+(c=r),r=f<<1,n=(a=t)+p;do{R=e[a+0]-e[a+c],E=e[a+0]+e[a+c],T=e[a+f]-e[a+d],B=e[a+f]+e[a+d],e[a+f]=E-B,e[a+0]=E+B,e[a+d]=R-T,e[a+c]=R+T,R=e[n+0]-e[n+c],E=e[n+0]+e[n+c],T=y.SQRT2*e[n+d],B=y.SQRT2*e[n+f],e[n+f]=E-B,e[n+0]=E+B,e[n+d]=R-T,e[n+c]=R+T,n+=r,a+=r}while(a<l);for(_=i[o+0],h=i[o+1],u=1;u<p;u++){var m,b;m=1-2*h*h,b=2*h*_,a=t+u,n=t+c-u;do{var v,g,S,E,R,A,B,w,T,M;g=b*e[a+c]-m*e[n+c],v=m*e[a+c]+b*e[n+c],R=e[a+0]-v,E=e[a+0]+v,A=e[n+0]-g,S=e[n+0]+g,g=b*e[a+d]-m*e[n+d],v=m*e[a+d]+b*e[n+d],T=e[a+f]-v,B=e[a+f]+v,M=e[n+f]-g,w=e[n+f]+g,g=h*B-_*M,v=_*B+h*M,e[a+f]=E-v,e[a+0]=E+v,e[n+d]=A-g,e[n+c]=A+g,g=_*w-h*T,v=h*w+_*T,e[n+f]=S-v,e[n+0]=S+v,e[a+d]=R-g,e[a+c]=R+g,n+=r,a+=r}while(a<l);_=(m=_)*i[o+0]-h*i[o+1],h=m*i[o+1]+h*i[o+0]}o+=2}while(r<s)}var r=[0,128,64,192,32,160,96,224,16,144,80,208,48,176,112,240,8,136,72,200,40,168,104,232,24,152,88,216,56,184,120,248,4,132,68,196,36,164,100,228,20,148,84,212,52,180,116,244,12,140,76,204,44,172,108,236,28,156,92,220,60,188,124,252,2,130,66,194,34,162,98,226,18,146,82,210,50,178,114,242,10,138,74,202,42,170,106,234,26,154,90,218,58,186,122,250,6,134,70,198,38,166,102,230,22,150,86,214,54,182,118,246,14,142,78,206,46,174,110,238,30,158,94,222,62,190,126,254];this.fft_short=function(e,i,a,n,o){for(var l=0;l<3;l++){var h=P.BLKSIZE_s/2,_=65535&192*(l+1),u=P.BLKSIZE_s/8-1;do{var c,f,d,p,m,b=255&r[u<<2];f=(c=t[b]*n[a][o+b+_])-(m=t[127-b]*n[a][o+b+_+128]),c+=m,p=(d=t[b+64]*n[a][o+b+_+64])-(m=t[63-b]*n[a][o+b+_+192]),d+=m,h-=4,i[l][h+0]=c+d,i[l][h+2]=c-d,i[l][h+1]=f+p,i[l][h+3]=f-p,f=(c=t[b+1]*n[a][o+b+_+1])-(m=t[126-b]*n[a][o+b+_+129]),c+=m,p=(d=t[b+65]*n[a][o+b+_+65])-(m=t[62-b]*n[a][o+b+_+193]),d+=m,i[l][h+P.BLKSIZE_s/2+0]=c+d,i[l][h+P.BLKSIZE_s/2+2]=c-d,i[l][h+P.BLKSIZE_s/2+1]=f+p,i[l][h+P.BLKSIZE_s/2+3]=f-p}while(--u>=0);s(i[l],h,P.BLKSIZE_s/2)}},this.fft_long=function(t,i,a,n,o){var l=P.BLKSIZE/8-1,h=P.BLKSIZE/2;do{var _,u,c,f,d,p=255&r[l];u=(_=e[p]*n[a][o+p])-(d=e[p+512]*n[a][o+p+512]),_+=d,f=(c=e[p+256]*n[a][o+p+256])-(d=e[p+768]*n[a][o+p+768]),c+=d,i[(h-=4)+0]=_+c,i[h+2]=_-c,i[h+1]=u+f,i[h+3]=u-f,u=(_=e[p+1]*n[a][o+p+1])-(d=e[p+513]*n[a][o+p+513]),_+=d,f=(c=e[p+257]*n[a][o+p+257])-(d=e[p+769]*n[a][o+p+769]),c+=d,i[h+P.BLKSIZE/2+0]=_+c,i[h+P.BLKSIZE/2+2]=_-c,i[h+P.BLKSIZE/2+1]=u+f,i[h+P.BLKSIZE/2+3]=u-f}while(--l>=0);s(i,h,P.BLKSIZE/2)},this.init_fft=function(i){for(var s=0;s<P.BLKSIZE;s++)e[s]=.42-.5*Math.cos(2*Math.PI*(s+.5)/P.BLKSIZE)+.08*Math.cos(4*Math.PI*(s+.5)/P.BLKSIZE);for(s=0;s<P.BLKSIZE_s/2;s++)t[s]=.5*(1-Math.cos(2*Math.PI*(s+.5)/P.BLKSIZE_s))}};a(N);var I=B;I.System;var x=I.VbrMode,C=I.Float,O=I.ShortBlock,D=I.Util,L=I.Arrays;I.new_array_n,I.new_byte,I.new_double;var F=I.new_float,V=I.new_float_n,H=I.new_int;I.new_int_n;var G=I.assert,U=N,q=T();var W=function(){var e=new U,t=2.302585092994046,i=1/217621504/(q.BLKSIZE/2),s=.3,r=21,a=.2302585093;function n(e,t){for(var s=0,r=0;r<q.BLKSIZE/2;++r)s+=e[r]*t.ATH.eql_w[r];return s*=i}function o(t,i,s,r,a,o,l,h,_,u,c){var f=t.internal_flags;if(_<2)e.fft_long(f,r[a],_,u,c),e.fft_short(f,o[l],_,u,c);else if(2==_){for(var d=q.BLKSIZE-1;d>=0;--d){var p=r[a+0][d],m=r[a+1][d];r[a+0][d]=(p+m)*D.SQRT2*.5,r[a+1][d]=(p-m)*D.SQRT2*.5}for(var b=2;b>=0;--b)for(d=q.BLKSIZE_s-1;d>=0;--d){p=o[l+0][b][d],m=o[l+1][b][d];o[l+0][b][d]=(p+m)*D.SQRT2*.5,o[l+1][b][d]=(p-m)*D.SQRT2*.5}}i[0]=r[a+0][0],i[0]*=i[0];for(d=q.BLKSIZE/2-1;d>=0;--d){var v=r[a+0][q.BLKSIZE/2-d],g=r[a+0][q.BLKSIZE/2+d];i[q.BLKSIZE/2-d]=.5*(v*v+g*g)}for(b=2;b>=0;--b){s[b][0]=o[l+0][b][0],s[b][0]*=s[b][0];for(d=q.BLKSIZE_s/2-1;d>=0;--d){v=o[l+0][b][q.BLKSIZE_s/2-d],g=o[l+0][b][q.BLKSIZE_s/2+d];s[b][q.BLKSIZE_s/2-d]=.5*(v*v+g*g)}}var S=0;for(d=11;d<q.HBLKSIZE;d++)S+=i[d];if(f.tot_ener[_]=S,t.analysis){for(d=0;d<q.HBLKSIZE;d++)f.pinfo.energy[h][_][d]=f.pinfo.energy_save[_][d],f.pinfo.energy_save[_][d]=i[d];f.pinfo.pe[h][_]=f.pe[_]}2==t.athaa_loudapprox&&_<2&&(f.loudness_sq[h][_]=f.loudness_sq_save[_],f.loudness_sq_save[_]=n(i,f))}var l,h,_,u=[1,.79433,.63096,.63096,.63096,.63096,.63096,.25119,.11749],c=[3.3246*3.3246,3.23837*3.23837,9.9500500969,9.0247369744,8.1854926609,7.0440875649,2.46209*2.46209,2.284*2.284,4.4892710641,1.96552*1.96552,1.82335*1.82335,1.69146*1.69146,2.4621061921,2.1508568964,1.37074*1.37074,1.31036*1.31036,1.5691069696,1.4555939904,1.16203*1.16203,1.2715945225,1.09428*1.09428,1.0659*1.0659,1.0779838276,1.0382591025,1],f=[1.7782755904,1.35879*1.35879,1.38454*1.38454,1.39497*1.39497,1.40548*1.40548,1.3537*1.3537,1.6999465924,1.22321*1.22321,1.3169398564,1],d=[5.5396212496,2.29259*2.29259,4.9868695969,2.12675*2.12675,2.02545*2.02545,1.87894*1.87894,1.74303*1.74303,1.61695*1.61695,2.2499700001,1.39148*1.39148,1.29083*1.29083,1.19746*1.19746,1.2339655056,1.0779838276];function p(e,t,i,s,r,a){var n;if(t>e){if(!(t<e*h))return e+t;n=t/e}else{if(e>=t*h)return e+t;n=e/t}if(G(e>=0),G(t>=0),e+=t,s+3<=6){if(n>=l)return e;var o=0|D.FAST_LOG10_X(n,16);return e*f[o]}var u,p;o=0|D.FAST_LOG10_X(n,16);return t=0!=a?r.ATH.cb_s[i]*r.ATH.adjust:r.ATH.cb_l[i]*r.ATH.adjust,G(t>=0),e<_*t?e>t?(u=1,o<=13&&(u=d[o]),p=D.FAST_LOG10_X(e/t,10/15),e*((c[o]-u)*p+u)):o>13?e:e*d[o]:e*c[o]}var m=[1.7782755904,1.35879*1.35879,1.38454*1.38454,1.39497*1.39497,1.40548*1.40548,1.3537*1.3537,1.6999465924,1.22321*1.22321,1.3169398564,1];function b(e,t,i){var s;if(e<0&&(e=0),t<0&&(t=0),e<=0)return t;if(t<=0)return e;if(s=t>e?t/e:e/t,-2<=i&&i<=2){if(s>=l)return e+t;var r=0|D.FAST_LOG10_X(s,16);return(e+t)*m[r]}return s<h?e+t:(e<t&&(e=t),e)}function v(e,t,i,s,r){var a,n,o=0,l=0;for(a=n=0;a<q.SBMAX_s;++n,++a){for(var h=e.bo_s[a],_=e.npart_s,u=h<_?h:_;n<u;)G(t[n]>=0),G(i[n]>=0),o+=t[n],l+=i[n],n++;if(e.en[s].s[a][r]=o,e.thm[s].s[a][r]=l,n>=_){++a;break}G(t[n]>=0),G(i[n]>=0);var c=e.PSY.bo_s_weight[a],f=1-c;o=c*t[n],l=c*i[n],e.en[s].s[a][r]+=o,e.thm[s].s[a][r]+=l,o=f*t[n],l=f*i[n]}for(;a<q.SBMAX_s;++a)e.en[s].s[a][r]=0,e.thm[s].s[a][r]=0}function g(e,t,i,s){var r,a,n=0,o=0;for(r=a=0;r<q.SBMAX_l;++a,++r){for(var l=e.bo_l[r],h=e.npart_l,_=l<h?l:h;a<_;)G(t[a]>=0),G(i[a]>=0),n+=t[a],o+=i[a],a++;if(e.en[s].l[r]=n,e.thm[s].l[r]=o,a>=h){++r;break}G(t[a]>=0),G(i[a]>=0);var u=e.PSY.bo_l_weight[r],c=1-u;n=u*t[a],o=u*i[a],e.en[s].l[r]+=n,e.thm[s].l[r]+=o,n=c*t[a],o=c*i[a]}for(;r<q.SBMAX_l;++r)e.en[s].l[r]=0,e.thm[s].l[r]=0}function S(e,t,i,s,r,a){var n,o,l=e.internal_flags;for(o=n=0;o<l.npart_s;++o){for(var h=0,_=l.numlines_s[o],u=0;u<_;++u,++n){h+=t[a][n]}i[o]=h}for(G(o==l.npart_s),G(129==n),n=o=0;o<l.npart_s;o++){var c=l.s3ind_s[o][0],f=l.s3_ss[n++]*i[c];for(++c;c<=l.s3ind_s[o][1];)f+=l.s3_ss[n]*i[c],++n,++c;var d=2*l.nb_s1[r][o];if(s[o]=Math.min(f,d),l.blocktype_old[1&r]==q.SHORT_TYPE){d=16*l.nb_s2[r][o];var p=s[o];s[o]=Math.min(d,p)}l.nb_s2[r][o]=l.nb_s1[r][o],l.nb_s1[r][o]=f,G(s[o]>=0)}for(;o<=q.CBANDS;++o)i[o]=0,s[o]=0}function E(e,t,i){return i>=1?e:i<=0?t:t>0?Math.pow(e/t,i)*t:0}var R=[11.8,13.6,17.2,32,46.5,51.3,57.5,67.1,71.5,84.6,97.6,130];function A(e,i){for(var s=309.07,r=0;r<q.SBMAX_s-1;r++)for(var a=0;a<3;a++){var n=e.thm.s[r][a];if(G(r<R.length),n>0){var o=n*i,l=e.en.s[r][a];l>o&&(l>1e10*o?s+=R[r]*(10*t):(G(o>0),s+=R[r]*D.FAST_LOG10(l/o)))}}return s}var B=[6.8,5.8,5.8,6.4,6.5,9.9,12.1,14.4,15,18.9,21.6,26.9,34.2,40.2,46.8,56.5,60.7,73.9,85.7,93.4,126.1];function w(e,i){for(var s=281.0575,r=0;r<q.SBMAX_l-1;r++){var a=e.thm.l[r];if(G(r<B.length),a>0){var n=a*i,o=e.en.l[r];o>n&&(o>1e10*n?s+=B[r]*(10*t):(G(n>0),s+=B[r]*D.FAST_LOG10(o/n)))}}return s}function T(e,t,i,s,r){var a,n;for(a=n=0;a<e.npart_l;++a){var o,l=0,h=0;for(o=0;o<e.numlines_l[a];++o,++n){var _=t[n];G(_>=0),l+=_,h<_&&(h=_)}i[a]=l,s[a]=h,r[a]=l*e.rnumlines_l[a],G(e.rnumlines_l[a]>=0),G(l>=0),G(i[a]>=0),G(s[a]>=0),G(r[a]>=0)}}function M(e,t,i,s){var r=u.length-1,a=0,n=i[a]+i[a+1];(G(n>=0),n>0)?((o=t[a])<t[a+1]&&(o=t[a+1]),G(e.numlines_l[a]+e.numlines_l[a+1]-1>0),(l=0|(n=20*(2*o-n)/(n*(e.numlines_l[a]+e.numlines_l[a+1]-1))))>r&&(l=r),s[a]=l):s[a]=0;for(a=1;a<e.npart_l-1;a++){var o,l;if(n=i[a-1]+i[a]+i[a+1],G(n>=0),n>0)(o=t[a-1])<t[a]&&(o=t[a]),o<t[a+1]&&(o=t[a+1]),G(e.numlines_l[a-1]+e.numlines_l[a]+e.numlines_l[a+1]-1>0),(l=0|(n=20*(3*o-n)/(n*(e.numlines_l[a-1]+e.numlines_l[a]+e.numlines_l[a+1]-1))))>r&&(l=r),s[a]=l;else s[a]=0}(G(a>0),G(a==e.npart_l-1),n=i[a-1]+i[a],G(n>=0),n>0)?((o=t[a-1])<t[a]&&(o=t[a]),G(e.numlines_l[a-1]+e.numlines_l[a]-1>0),(l=0|(n=20*(2*o-n)/(n*(e.numlines_l[a-1]+e.numlines_l[a]-1))))>r&&(l=r),s[a]=l):s[a]=0;G(a==e.npart_l-1)}var y=[-1730326e-23,-.01703172,-1349528e-23,.0418072,-673278e-22,-.0876324,-30835e-21,.1863476,-1104424e-22,-.627638];function k(t,i,s,r,a,n,o,l){var h=t.internal_flags;if(r<2)e.fft_long(h,o[l],r,i,s);else if(2==r)for(var _=q.BLKSIZE-1;_>=0;--_){var u=o[l+0][_],c=o[l+1][_];o[l+0][_]=(u+c)*D.SQRT2*.5,o[l+1][_]=(u-c)*D.SQRT2*.5}n[0]=o[l+0][0],n[0]*=n[0];for(_=q.BLKSIZE/2-1;_>=0;--_){var f=o[l+0][q.BLKSIZE/2-_],d=o[l+0][q.BLKSIZE/2+_];n[q.BLKSIZE/2-_]=.5*(f*f+d*d)}var p=0;for(_=11;_<q.HBLKSIZE;_++)p+=n[_];if(h.tot_ener[r]=p,t.analysis){for(_=0;_<q.HBLKSIZE;_++)h.pinfo.energy[a][r][_]=h.pinfo.energy_save[r][_],h.pinfo.energy_save[r][_]=n[_];h.pinfo.pe[a][r]=h.pe[r]}}function P(t,i,s,r,a,n,o,l){var h=t.internal_flags;if(0==a&&r<2&&e.fft_short(h,o[l],r,i,s),2==r)for(var _=q.BLKSIZE_s-1;_>=0;--_){var u=o[l+0][a][_],c=o[l+1][a][_];o[l+0][a][_]=(u+c)*D.SQRT2*.5,o[l+1][a][_]=(u-c)*D.SQRT2*.5}n[a][0]=o[l+0][a][0],n[a][0]*=n[a][0];for(_=q.BLKSIZE_s/2-1;_>=0;--_){var f=o[l+0][a][q.BLKSIZE_s/2-_],d=o[l+0][a][q.BLKSIZE_s/2+_];n[a][q.BLKSIZE_s/2-_]=.5*(f*f+d*d)}}function N(e,t,i,s){var r=e.internal_flags;2==e.athaa_loudapprox&&i<2&&(r.loudness_sq[t][i]=r.loudness_sq_save[i],r.loudness_sq_save[i]=n(s,r))}this.L3psycho_anal_ns=function(e,t,i,a,n,l,h,_,c,f){var d,m,b,R,B,k,P,N,I,C,D=e.internal_flags,U=V([2,q.BLKSIZE]),W=V([2,3,q.BLKSIZE_s]),X=F(q.CBANDS+1),Y=F(q.CBANDS+1),K=F(q.CBANDS+2),j=H(2),z=H(2),Z=V([2,576]),Q=H(q.CBANDS+2),J=H(q.CBANDS+2);for(L.fill(J,0),d=D.channels_out,e.mode==MPEGMode.JOINT_STEREO&&(d=4),I=e.VBR==x.vbr_off?0==D.ResvMax?0:D.ResvSize/D.ResvMax*.5:e.VBR==x.vbr_rh||e.VBR==x.vbr_mtrh||e.VBR==x.vbr_mt?.6:1,m=0;m<D.channels_out;m++){var $=t[m],ee=i+576-350-r+192;for(G(10==y.length),R=0;R<576;R++){var te,ie;for(te=$[ee+R+10],ie=0,B=0;B<9;B+=2)te+=y[B]*($[ee+R+B]+$[ee+R+r-B]),ie+=y[B+1]*($[ee+R+B+1]+$[ee+R+r-B-1]);Z[m][R]=te+ie}n[a][m].en.assign(D.en[m]),n[a][m].thm.assign(D.thm[m]),d>2&&(l[a][m].en.assign(D.en[m+2]),l[a][m].thm.assign(D.thm[m+2]))}for(m=0;m<d;m++){var se,re=F(12),ae=[0,0,0,0],ne=F(12),oe=1,le=F(q.CBANDS),he=F(q.CBANDS),_e=[0,0,0,0],ue=F(q.HBLKSIZE),ce=V([3,q.HBLKSIZE_s]);for(G(D.npart_s<=q.CBANDS),G(D.npart_l<=q.CBANDS),R=0;R<3;R++)re[R]=D.nsPsy.last_en_subshort[m][R+6],G(D.nsPsy.last_en_subshort[m][R+4]>0),ne[R]=re[R]/D.nsPsy.last_en_subshort[m][R+4],ae[0]+=re[R];if(2==m)for(R=0;R<576;R++){var fe,de;fe=Z[0][R],de=Z[1][R],Z[0][R]=fe+de,Z[1][R]=fe-de}var pe=Z[1&m],me=0;for(R=0;R<9;R++){for(var be=me+64,ve=1;me<be;me++)ve<Math.abs(pe[me])&&(ve=Math.abs(pe[me]));D.nsPsy.last_en_subshort[m][R]=re[R+3]=ve,ae[1+R/3]+=ve,ve>re[R+3-2]?(G(re[R+3-2]>0),ve/=re[R+3-2]):re[R+3-2]>10*ve?(G(ve>0),ve=re[R+3-2]/(10*ve)):ve=0,ne[R+3]=ve}if(e.analysis){var ge=ne[0];for(R=1;R<12;R++)ge<ne[R]&&(ge=ne[R]);D.pinfo.ers[a][m]=D.pinfo.ers_save[m],D.pinfo.ers_save[m]=ge}for(se=3==m?D.nsPsy.attackthre_s:D.nsPsy.attackthre,R=0;R<12;R++)0==_e[R/3]&&ne[R]>se&&(_e[R/3]=R%3+1);for(R=1;R<4;R++){var Se;ae[R-1]>ae[R]?(G(ae[R]>0),Se=ae[R-1]/ae[R]):(G(ae[R-1]>0),Se=ae[R]/ae[R-1]),Se<1.7&&(_e[R]=0,1==R&&(_e[0]=0))}for(0!=_e[0]&&0!=D.nsPsy.lastAttacks[m]&&(_e[0]=0),3!=D.nsPsy.lastAttacks[m]&&_e[0]+_e[1]+_e[2]+_e[3]==0||(oe=0,0!=_e[1]&&0!=_e[0]&&(_e[1]=0),0!=_e[2]&&0!=_e[1]&&(_e[2]=0),0!=_e[3]&&0!=_e[2]&&(_e[3]=0)),m<2?z[m]=oe:0==oe&&(z[0]=z[1]=0),c[m]=D.tot_ener[m],o(e,ue,ce,U,1&m,W,1&m,a,m,t,i),T(D,ue,X,le,he),M(D,le,he,Q),N=0;N<3;N++){var Ee,Re;for(S(e,ce,Y,K,m,N),v(D,Y,K,m,N),P=0;P<q.SBMAX_s;P++){if(Re=D.thm[m].s[P][N],Re*=.8,_e[N]>=2||1==_e[N+1]){var Ae=0!=N?N-1:2;ve=E(D.thm[m].s[P][Ae],Re,.6*I);Re=Math.min(Re,ve)}if(1==_e[N]){Ae=0!=N?N-1:2,ve=E(D.thm[m].s[P][Ae],Re,s*I);Re=Math.min(Re,ve)}else if(0!=N&&3==_e[N-1]||0==N&&3==D.nsPsy.lastAttacks[m]){Ae=2!=N?N+1:0,ve=E(D.thm[m].s[P][Ae],Re,s*I);Re=Math.min(Re,ve)}Ee=re[3*N+3]+re[3*N+4]+re[3*N+5],6*re[3*N+5]<Ee&&(Re*=.5,6*re[3*N+4]<Ee&&(Re*=.5)),D.thm[m].s[P][N]=Re}}for(D.nsPsy.lastAttacks[m]=_e[2],k=0,b=0;b<D.npart_l;b++){for(var Be=D.s3ind[b][0],we=X[Be]*u[Q[Be]],Te=D.s3_ll[k++]*we;++Be<=D.s3ind[b][1];)we=X[Be]*u[Q[Be]],Te=p(Te,D.s3_ll[k++]*we,Be,Be-b,D,0);Te*=.158489319246111,D.blocktype_old[1&m]==q.SHORT_TYPE?K[b]=Te:K[b]=E(Math.min(Te,Math.min(2*D.nb_1[m][b],16*D.nb_2[m][b])),Te,I),D.nb_2[m][b]=D.nb_1[m][b],D.nb_1[m][b]=Te}for(;b<=q.CBANDS;++b)X[b]=0,K[b]=0;g(D,X,K,m)}(e.mode!=MPEGMode.STEREO&&e.mode!=MPEGMode.JOINT_STEREO||e.interChRatio>0&&function(e,t){var i=e.internal_flags;if(i.channels_out>1){for(var s=0;s<q.SBMAX_l;s++){var r=i.thm[0].l[s],a=i.thm[1].l[s];i.thm[0].l[s]+=a*t,i.thm[1].l[s]+=r*t}for(s=0;s<q.SBMAX_s;s++)for(var n=0;n<3;n++)r=i.thm[0].s[s][n],a=i.thm[1].s[s][n],i.thm[0].s[s][n]+=a*t,i.thm[1].s[s][n]+=r*t}}(e,e.interChRatio),e.mode==MPEGMode.JOINT_STEREO)&&(!function(e){for(var t=0;t<q.SBMAX_l;t++)if(!(e.thm[0].l[t]>1.58*e.thm[1].l[t]||e.thm[1].l[t]>1.58*e.thm[0].l[t])){var i=e.mld_l[t]*e.en[3].l[t],s=Math.max(e.thm[2].l[t],Math.min(e.thm[3].l[t],i));i=e.mld_l[t]*e.en[2].l[t];var r=Math.max(e.thm[3].l[t],Math.min(e.thm[2].l[t],i));e.thm[2].l[t]=s,e.thm[3].l[t]=r}for(t=0;t<q.SBMAX_s;t++)for(var a=0;a<3;a++)e.thm[0].s[t][a]>1.58*e.thm[1].s[t][a]||e.thm[1].s[t][a]>1.58*e.thm[0].s[t][a]||(i=e.mld_s[t]*e.en[3].s[t][a],s=Math.max(e.thm[2].s[t][a],Math.min(e.thm[3].s[t][a],i)),i=e.mld_s[t]*e.en[2].s[t][a],r=Math.max(e.thm[3].s[t][a],Math.min(e.thm[2].s[t][a],i)),e.thm[2].s[t][a]=s,e.thm[3].s[t][a]=r)}(D),C=e.msfix,Math.abs(C)>0&&function(e,t,i){var s=t,r=Math.pow(10,i);t*=2,s*=2;for(var a=0;a<q.SBMAX_l;a++)_=e.ATH.cb_l[e.bm_l[a]]*r,(o=Math.min(Math.max(e.thm[0].l[a],_),Math.max(e.thm[1].l[a],_)))*t<(l=Math.max(e.thm[2].l[a],_))+(h=Math.max(e.thm[3].l[a],_))&&G((l*=u=o*s/(l+h))+(h*=u)>0),e.thm[2].l[a]=Math.min(l,e.thm[2].l[a]),e.thm[3].l[a]=Math.min(h,e.thm[3].l[a]);for(r*=q.BLKSIZE_s/q.BLKSIZE,a=0;a<q.SBMAX_s;a++)for(var n=0;n<3;n++){var o,l,h,_,u;_=e.ATH.cb_s[e.bm_s[a]]*r,(o=Math.min(Math.max(e.thm[0].s[a][n],_),Math.max(e.thm[1].s[a][n],_)))*t<(l=Math.max(e.thm[2].s[a][n],_))+(h=Math.max(e.thm[3].s[a][n],_))&&G((l*=u=o*t/(l+h))+(h*=u)>0),e.thm[2].s[a][n]=Math.min(e.thm[2].s[a][n],l),e.thm[3].s[a][n]=Math.min(e.thm[3].s[a][n],h)}}(D,C,e.ATHlower*D.ATH.adjust));for(function(e,t,i,s){var r=e.internal_flags;e.short_blocks!=O.short_block_coupled||0!=t[0]&&0!=t[1]||(t[0]=t[1]=0);for(var a=0;a<r.channels_out;a++)s[a]=q.NORM_TYPE,e.short_blocks==O.short_block_dispensed&&(t[a]=1),e.short_blocks==O.short_block_forced&&(t[a]=0),0!=t[a]?(G(r.blocktype_old[a]!=q.START_TYPE),r.blocktype_old[a]==q.SHORT_TYPE&&(s[a]=q.STOP_TYPE)):(s[a]=q.SHORT_TYPE,r.blocktype_old[a]==q.NORM_TYPE&&(r.blocktype_old[a]=q.START_TYPE),r.blocktype_old[a]==q.STOP_TYPE&&(r.blocktype_old[a]=q.SHORT_TYPE)),i[a]=r.blocktype_old[a],r.blocktype_old[a]=s[a]}(e,z,f,j),m=0;m<d;m++){var Me,ye,ke,Pe=0;m>1?(Me=_,Pe=-2,ye=q.NORM_TYPE,f[0]!=q.SHORT_TYPE&&f[1]!=q.SHORT_TYPE||(ye=q.SHORT_TYPE),ke=l[a][m-2]):(Me=h,Pe=0,ye=f[m],ke=n[a][m]),ye==q.SHORT_TYPE?Me[Pe+m]=A(ke,D.masking_lower):Me[Pe+m]=w(ke,D.masking_lower),e.analysis&&(D.pinfo.pe[a][m]=Me[Pe+m])}return 0};var I=[-1730326e-23,-.01703172,-1349528e-23,.0418072,-673278e-22,-.0876324,-30835e-21,.1863476,-1104424e-22,-.627638];function W(e,t,i){if(0==i)for(var s=0;s<e.npart_s;s++)e.nb_s2[t][s]=e.nb_s1[t][s],e.nb_s1[t][s]=0}function X(e,t){for(var i=0;i<e.npart_l;i++)e.nb_2[t][i]=e.nb_1[t][i],e.nb_1[t][i]=0}function Y(e,t,i,s,r,a){var n,o,l,h=e.internal_flags,_=new float[q.CBANDS],c=F(q.CBANDS),f=new int[q.CBANDS];for(l=o=0;l<h.npart_s;++l){var d=0,p=0,m=h.numlines_s[l];for(n=0;n<m;++n,++o){var v=t[a][o];d+=v,p<v&&(p=v)}i[l]=d,G(d>=0),_[l]=p,G(m>0),c[l]=d/m,G(c[l]>=0)}for(G(l==h.npart_s),G(129==o);l<q.CBANDS;++l)_[l]=0,c[l]=0;for(function(e,t,i,s){var r=u.length-1,a=0,n=i[a]+i[a+1];for(G(n>=0),n>0?((o=t[a])<t[a+1]&&(o=t[a+1]),G(e.numlines_s[a]+e.numlines_s[a+1]-1>0),(l=0|(n=20*(2*o-n)/(n*(e.numlines_s[a]+e.numlines_s[a+1]-1))))>r&&(l=r),s[a]=l):s[a]=0,a=1;a<e.npart_s-1;a++){var o,l;n=i[a-1]+i[a]+i[a+1],G(a+1<e.npart_s),G(n>=0),n>0?((o=t[a-1])<t[a]&&(o=t[a]),o<t[a+1]&&(o=t[a+1]),G(e.numlines_s[a-1]+e.numlines_s[a]+e.numlines_s[a+1]-1>0),(l=0|(n=20*(3*o-n)/(n*(e.numlines_s[a-1]+e.numlines_s[a]+e.numlines_s[a+1]-1))))>r&&(l=r),s[a]=l):s[a]=0}G(a>0),G(a==e.npart_s-1),n=i[a-1]+i[a],G(n>=0),n>0?((o=t[a-1])<t[a]&&(o=t[a]),G(e.numlines_s[a-1]+e.numlines_s[a]-1>0),(l=0|(n=20*(2*o-n)/(n*(e.numlines_s[a-1]+e.numlines_s[a]-1))))>r&&(l=r),s[a]=l):s[a]=0,G(a==e.npart_s-1)}(h,_,c,f),o=l=0;l<h.npart_s;l++){var g,S,E,R,A,B=h.s3ind_s[l][0],w=h.s3ind_s[l][1];for(g=f[B],S=1,R=h.s3_ss[o]*i[B]*u[f[B]],++o,++B;B<=w;)g+=f[B],S+=1,R=b(R,E=h.s3_ss[o]*i[B]*u[f[B]],B-l),++o,++B;R*=A=.5*u[g=(1+2*g)/(2*S)],s[l]=R,h.nb_s2[r][l]=h.nb_s1[r][l],h.nb_s1[r][l]=R,E=_[l],E*=h.minval_s[l],E*=A,s[l]>E&&(s[l]=E),h.masking_lower>1&&(s[l]*=h.masking_lower),s[l]>i[l]&&(s[l]=i[l]),h.masking_lower<1&&(s[l]*=h.masking_lower),G(s[l]>=0)}for(;l<q.CBANDS;++l)i[l]=0,s[l]=0}function K(e,t,i,r,a){var n,o=F(q.CBANDS),l=F(q.CBANDS),h=H(q.CBANDS+2);T(e,t,i,o,l),M(e,o,l,h);var _=0;for(n=0;n<e.npart_l;n++){var c,f,d,p=e.s3ind[n][0],m=e.s3ind[n][1],v=0,g=0;for(v=h[p],g+=1,f=e.s3_ll[_]*i[p]*u[h[p]],++_,++p;p<=m;)v+=h[p],g+=1,f=b(f,c=e.s3_ll[_]*i[p]*u[h[p]],p-n),++_,++p;if(f*=d=.5*u[v=(1+2*v)/(2*g)],e.blocktype_old[1&a]==q.SHORT_TYPE){var S=2*e.nb_1[a][n];r[n]=S>0?Math.min(f,S):Math.min(f,i[n]*s)}else{var E=16*e.nb_2[a][n],R=2*e.nb_1[a][n];E<=0&&(E=f),R<=0&&(R=f),S=e.blocktype_old[1&a]==q.NORM_TYPE?Math.min(R,E):R,r[n]=Math.min(f,S)}e.nb_2[a][n]=e.nb_1[a][n],e.nb_1[a][n]=f,c=o[n],c*=e.minval_l[n],c*=d,r[n]>c&&(r[n]=c),e.masking_lower>1&&(r[n]*=e.masking_lower),r[n]>i[n]&&(r[n]=i[n]),e.masking_lower<1&&(r[n]*=e.masking_lower),G(r[n]>=0)}for(;n<q.CBANDS;++n)i[n]=0,r[n]=0}function j(e,t,i,s,r,a,n){for(var o,l,h=2*a,_=a>0?Math.pow(10,r):1,u=0;u<n;++u){var c=e[2][u],f=e[3][u],d=t[0][u],p=t[1][u],m=t[2][u],b=t[3][u];if(d<=1.58*p&&p<=1.58*d){var v=i[u]*f,g=i[u]*c;l=Math.max(m,Math.min(b,v)),o=Math.max(b,Math.min(m,g))}else l=m,o=b;if(a>0){var S,E,R=s[u]*_;if(S=Math.min(Math.max(d,R),Math.max(p,R)),(E=(m=Math.max(l,R))+(b=Math.max(o,R)))>0&&S*h<E){var A=S*h/E;m*=A,b*=A,G(E>0)}l=Math.min(m,l),o=Math.min(b,o)}l>c&&(l=c),o>f&&(o=f),t[2][u]=l,t[3][u]=o}}function z(e,t){var i;return(i=e>=0?27*-e:e*t)<=-72?0:Math.exp(i*a)}function Z(e){var t,i,s=0;for(s=0;z(s,e)>1e-20;s-=1);for(r=s,a=0;Math.abs(a-r)>1e-12;)z(s=(a+r)/2,e)>0?a=s:r=s;t=r;var r,a;s=0;for(s=0;z(s,e)>1e-20;s+=1);for(r=0,a=s;Math.abs(a-r)>1e-12;)z(s=(a+r)/2,e)>0?r=s:a=s;i=a;var n,o=0,l=1e3;for(n=0;n<=l;++n){o+=z(s=t+n*(i-t)/l,e)}return(l+1)/(o*(i-t))}function Q(e){return e<0&&(e=0),e*=.001,13*Math.atan(.76*e)+3.5*Math.atan(e*e/56.25)}function J(e,t,i,s,r,a,n,o,l,h,_,u){var c,f=F(q.CBANDS+1),d=o/(u>15?1152:384),p=H(q.HBLKSIZE);o/=l;var m=0,b=0;for(c=0;c<q.CBANDS;c++){var v;for(M=Q(o*m),f[c]=o*m,v=m;Q(o*v)-M<.34&&v<=l/2;v++);for(e[c]=v-m,b=c+1;m<v;)G(m<q.HBLKSIZE),p[m++]=c;if(m>l/2){m=l/2,++c;break}}G(c<q.CBANDS),f[c]=o*m;for(var g=0;g<u;g++){var S,E,R,A,B;R=h[g],A=h[g+1],(S=0|Math.floor(.5+_*(R-.5)))<0&&(S=0),(E=0|Math.floor(.5+_*(A-.5)))>l/2&&(E=l/2),i[g]=(p[S]+p[E])/2,t[g]=p[E];var w=d*A;n[g]=(w-f[t[g]])/(f[t[g]+1]-f[t[g]]),n[g]<0?n[g]=0:n[g]>1&&(n[g]=1),B=Q(o*h[g]*_),B=Math.min(B,15.5)/15.5,a[g]=Math.pow(10,1.25*(1-Math.cos(Math.PI*B))-2.5)}m=0;for(var T=0;T<b;T++){var M,y,k=e[T];M=Q(o*m),y=Q(o*(m+k-1)),s[T]=.5*(M+y),M=Q(o*(m-.5)),y=Q(o*(m+k-.5)),r[T]=y-M,m+=k}return b}function $(e,t,i,s,r,n){var o,l,h,_,u,c,f=V([q.CBANDS,q.CBANDS]),d=0;if(n)for(var p=0;p<t;p++)for(o=0;o<t;o++){var m=(l=i[p]-i[o],h=void 0,_=void 0,u=void 0,c=void 0,h=l,_=(h*=h>=0?3:1.5)>=.5&&h<=2.5?8*((c=h-.5)*c-2*c):0,((u=15.811389+7.5*(h+=.474)-17.5*Math.sqrt(1+h*h))<=-60?0:(h=Math.exp((_+u)*a),h/=.6609193))*s[o]);f[p][o]=m*r[p]}else for(o=0;o<t;o++){var b=15+Math.min(21/i[o],12),v=Z(b);for(p=0;p<t;p++){m=v*z(i[p]-i[o],b)*s[o];f[p][o]=m*r[p]}}for(p=0;p<t;p++){for(o=0;o<t&&!(f[p][o]>0);o++);for(e[p][0]=o,o=t-1;o>0&&!(f[p][o]>0);o--);e[p][1]=o,d+=e[p][1]-e[p][0]+1}var g=F(d),S=0;for(p=0;p<t;p++)for(o=e[p][0];o<=e[p][1];o++)g[S++]=f[p][o];return g}function ee(e){var t=Q(e);return t=Math.min(t,15.5)/15.5,Math.pow(10,1.25*(1-Math.cos(Math.PI*t))-2.5)}function te(e,t){return e<-.3&&(e=3410),e/=1e3,e=Math.max(.1,e),3.64*Math.pow(e,-.8)-6.8*Math.exp(-.6*Math.pow(e-3.4,2))+6*Math.exp(-.15*Math.pow(e-8.7,2))+.001*(.6+.04*t)*Math.pow(e,4)}this.L3psycho_anal_vbr=function(e,t,i,s,a,n,o,l,h,_){var u=e.internal_flags,c=F(q.HBLKSIZE),f=V([3,q.HBLKSIZE_s]),d=V([2,q.BLKSIZE]),p=V([2,3,q.BLKSIZE_s]),m=V([4,q.CBANDS]),b=V([4,q.CBANDS]),S=V([4,3]),R=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],B=H(2),T=e.mode==MPEGMode.JOINT_STEREO?4:u.channels_out;!function(e,t,i,s,a,n,o,l,h,_){for(var u=V([2,576]),c=e.internal_flags,f=c.channels_out,d=e.mode==MPEGMode.JOINT_STEREO?4:f,p=0;p<f;p++){firbuf=t[p];var m=i+576-350-r+192;G(10==I.length);for(var b=0;b<576;b++){var v,g;v=firbuf[m+b+10],g=0;for(var S=0;S<9;S+=2)v+=I[S]*(firbuf[m+b+S]+firbuf[m+b+r-S]),g+=I[S+1]*(firbuf[m+b+S+1]+firbuf[m+b+r-S-1]);u[p][b]=v+g}a[s][p].en.assign(c.en[p]),a[s][p].thm.assign(c.thm[p]),d>2&&(n[s][p].en.assign(c.en[p+2]),n[s][p].thm.assign(c.thm[p+2]))}for(p=0;p<d;p++){var E=F(12),R=F(12),A=[0,0,0,0],B=u[1&p],w=0,T=3==p?c.nsPsy.attackthre_s:c.nsPsy.attackthre,M=1;if(2==p)for(b=0,S=576;S>0;++b,--S){var y=u[0][b],k=u[1][b];u[0][b]=y+k,u[1][b]=y-k}for(b=0;b<3;b++)R[b]=c.nsPsy.last_en_subshort[p][b+6],G(c.nsPsy.last_en_subshort[p][b+4]>0),E[b]=R[b]/c.nsPsy.last_en_subshort[p][b+4],A[0]+=R[b];for(b=0;b<9;b++){for(var P=w+64,N=1;w<P;w++)N<Math.abs(B[w])&&(N=Math.abs(B[w]));c.nsPsy.last_en_subshort[p][b]=R[b+3]=N,A[1+b/3]+=N,N>R[b+3-2]?(G(R[b+3-2]>0),N/=R[b+3-2]):R[b+3-2]>10*N?(G(N>0),N=R[b+3-2]/(10*N)):N=0,E[b+3]=N}for(b=0;b<3;++b){var x=R[3*b+3]+R[3*b+4]+R[3*b+5],C=1;6*R[3*b+5]<x&&(C*=.5,6*R[3*b+4]<x&&(C*=.5)),l[p][b]=C}if(e.analysis){var O=E[0];for(b=1;b<12;b++)O<E[b]&&(O=E[b]);c.pinfo.ers[s][p]=c.pinfo.ers_save[p],c.pinfo.ers_save[p]=O}for(b=0;b<12;b++)0==h[p][b/3]&&E[b]>T&&(h[p][b/3]=b%3+1);for(b=1;b<4;b++){var D=A[b-1],L=A[b];Math.max(D,L)<4e4&&D<1.7*L&&L<1.7*D&&(1==b&&h[p][0]<=h[p][b]&&(h[p][0]=0),h[p][b]=0)}h[p][0]<=c.nsPsy.lastAttacks[p]&&(h[p][0]=0),3!=c.nsPsy.lastAttacks[p]&&h[p][0]+h[p][1]+h[p][2]+h[p][3]==0||(M=0,0!=h[p][1]&&0!=h[p][0]&&(h[p][1]=0),0!=h[p][2]&&0!=h[p][1]&&(h[p][2]=0),0!=h[p][3]&&0!=h[p][2]&&(h[p][3]=0)),p<2?_[p]=M:0==M&&(_[0]=_[1]=0),o[p]=c.tot_ener[p]}}(e,t,i,s,a,n,h,S,R,B),function(e,t){var i=e.internal_flags;e.short_blocks!=O.short_block_coupled||0!=t[0]&&0!=t[1]||(t[0]=t[1]=0);for(var s=0;s<i.channels_out;s++)e.short_blocks==O.short_block_dispensed&&(t[s]=1),e.short_blocks==O.short_block_forced&&(t[s]=0)}(e,B);for(var M=0;M<T;M++){k(e,t,i,M,s,c,d,x=1&M),N(e,s,M,c),0!=B[x]?K(u,c,m[M],b[M],M):X(u,M)}B[0]+B[1]==2&&e.mode==MPEGMode.JOINT_STEREO&&j(m,b,u.mld_cb_l,u.ATH.cb_l,e.ATHlower*u.ATH.adjust,e.msfix,u.npart_l);for(M=0;M<T;M++){0!=B[x=1&M]&&g(u,m[M],b[M],M)}for(var y=0;y<3;y++){for(M=0;M<T;++M){0!=B[x=1&M]?W(u,M,y):(P(e,t,i,M,y,f,p,x),Y(e,f,m[M],b[M],M,y))}B[0]+B[1]==0&&e.mode==MPEGMode.JOINT_STEREO&&j(m,b,u.mld_cb_s,u.ATH.cb_s,e.ATHlower*u.ATH.adjust,e.msfix,u.npart_s);for(M=0;M<T;++M){0==B[x=1&M]&&v(u,m[M],b[M],M,y)}}for(M=0;M<T;M++){var x;if(0==B[x=1&M])for(var C=0;C<q.SBMAX_s;C++){var D=F(3);for(y=0;y<3;y++){var L=u.thm[M].s[C][y];if(L*=.8,R[M][y]>=2||1==R[M][y+1]){var U=0!=y?y-1:2,z=E(u.thm[M].s[C][U],L,.36);L=Math.min(L,z)}else if(1==R[M][y]){U=0!=y?y-1:2,z=E(u.thm[M].s[C][U],L,.18);L=Math.min(L,z)}else if(0!=y&&3==R[M][y-1]||0==y&&3==u.nsPsy.lastAttacks[M]){U=2!=y?y+1:0,z=E(u.thm[M].s[C][U],L,.18);L=Math.min(L,z)}L*=S[M][y],D[y]=L}for(y=0;y<3;y++)u.thm[M].s[C][y]=D[y]}}for(M=0;M<T;M++)u.nsPsy.lastAttacks[M]=R[M][2];!function(e,t,i){for(var s=e.internal_flags,r=0;r<s.channels_out;r++){var a=q.NORM_TYPE;0!=t[r]?(G(s.blocktype_old[r]!=q.START_TYPE),s.blocktype_old[r]==q.SHORT_TYPE&&(a=q.STOP_TYPE)):(a=q.SHORT_TYPE,s.blocktype_old[r]==q.NORM_TYPE&&(s.blocktype_old[r]=q.START_TYPE),s.blocktype_old[r]==q.STOP_TYPE&&(s.blocktype_old[r]=q.SHORT_TYPE)),i[r]=s.blocktype_old[r],s.blocktype_old[r]=a}}(e,B,_);for(M=0;M<T;M++){var Z,Q,J,$;M>1?(Z=l,Q=-2,J=q.NORM_TYPE,_[0]!=q.SHORT_TYPE&&_[1]!=q.SHORT_TYPE||(J=q.SHORT_TYPE),$=n[s][M-2]):(Z=o,Q=0,J=_[M],$=a[s][M]),J==q.SHORT_TYPE?Z[Q+M]=A($,u.masking_lower):Z[Q+M]=w($,u.masking_lower),e.analysis&&(u.pinfo.pe[s][M]=Z[Q+M])}return 0},this.psymodel_init=function(i){var s,r=i.internal_flags,a=!0,n=13,o=24,u=0,c=0,f=-8.25,d=-4.5,p=F(q.CBANDS),m=F(q.CBANDS),b=F(q.CBANDS),v=i.out_samplerate;switch(i.experimentalZ){default:case 0:a=!0;break;case 1:a=i.VBR!=x.vbr_mtrh&&i.VBR!=x.vbr_mt;break;case 2:a=!1;break;case 3:n=8,u=-1.75,c=-.0125,f=-8.25,d=-2.25}for(r.ms_ener_ratio_old=.25,r.blocktype_old[0]=r.blocktype_old[1]=q.NORM_TYPE,s=0;s<4;++s){for(var g=0;g<q.CBANDS;++g)r.nb_1[s][g]=1e20,r.nb_2[s][g]=1e20,r.nb_s1[s][g]=r.nb_s2[s][g]=1;for(var S=0;S<q.SBMAX_l;S++)r.en[s].l[S]=1e20,r.thm[s].l[S]=1e20;for(g=0;g<3;++g){for(S=0;S<q.SBMAX_s;S++)r.en[s].s[S][g]=1e20,r.thm[s].s[S][g]=1e20;r.nsPsy.lastAttacks[s]=0}for(g=0;g<9;g++)r.nsPsy.last_en_subshort[s][g]=10}for(r.loudness_sq_save[0]=r.loudness_sq_save[1]=0,r.npart_l=J(r.numlines_l,r.bo_l,r.bm_l,p,m,r.mld_l,r.PSY.bo_l_weight,v,q.BLKSIZE,r.scalefac_band.l,q.BLKSIZE/1152,q.SBMAX_l),G(r.npart_l<q.CBANDS),s=0;s<r.npart_l;s++){var E=u;p[s]>=n&&(E=c*(p[s]-n)/(o-n)+u*(o-p[s])/(o-n)),b[s]=Math.pow(10,E/10),r.numlines_l[s]>0?r.rnumlines_l[s]=1/r.numlines_l[s]:r.rnumlines_l[s]=0}r.s3_ll=$(r.s3ind,r.npart_l,p,m,b,a);var R;g=0;for(s=0;s<r.npart_l;s++){w=C.MAX_VALUE;for(var A=0;A<r.numlines_l[s];A++,g++){var B=v*g/(1e3*q.BLKSIZE);T=this.ATHformula(1e3*B,i)-20,T=Math.pow(10,.1*T),w>(T*=r.numlines_l[s])&&(w=T)}r.ATH.cb_l[s]=w,(w=20*p[s]/10-20)>6&&(w=100),w<-15&&(w=-15),w-=8,r.minval_l[s]=Math.pow(10,w/10)*r.numlines_l[s]}for(r.npart_s=J(r.numlines_s,r.bo_s,r.bm_s,p,m,r.mld_s,r.PSY.bo_s_weight,v,q.BLKSIZE_s,r.scalefac_band.s,q.BLKSIZE_s/384,q.SBMAX_s),G(r.npart_s<q.CBANDS),g=0,s=0;s<r.npart_s;s++){var w;E=f;p[s]>=n&&(E=d*(p[s]-n)/(o-n)+f*(o-p[s])/(o-n)),b[s]=Math.pow(10,E/10),w=C.MAX_VALUE;for(A=0;A<r.numlines_s[s];A++,g++){var T;B=v*g/(1e3*q.BLKSIZE_s);T=this.ATHformula(1e3*B,i)-20,T=Math.pow(10,.1*T),w>(T*=r.numlines_s[s])&&(w=T)}r.ATH.cb_s[s]=w,w=7*p[s]/12-7,p[s]>12&&(w*=1+3.1*Math.log(1+w)),p[s]<12&&(w*=1+2.3*Math.log(1-w)),w<-15&&(w=-15),w-=8,r.minval_s[s]=Math.pow(10,w/10)*r.numlines_s[s]}r.s3_ss=$(r.s3ind_s,r.npart_s,p,m,b,a),l=Math.pow(10,9/16),h=Math.pow(10,1.5),_=Math.pow(10,1.5),e.init_fft(r),r.decay=Math.exp(-1*t/(.01*v/192)),R=3.5,2&i.exp_nspsytune&&(R=1),Math.abs(i.msfix)>0&&(R=i.msfix),i.msfix=R;for(var M=0;M<r.npart_l;M++)r.s3ind[M][1]>r.npart_l-1&&(r.s3ind[M][1]=r.npart_l-1);var y=576*r.mode_gr/v;if(r.ATH.decay=Math.pow(10,-1.2*y),r.ATH.adjust=.01,r.ATH.adjustLimit=1,G(r.bo_l[q.SBMAX_l-1]<=r.npart_l),G(r.bo_s[q.SBMAX_s-1]<=r.npart_s),-1!=i.ATHtype){var k=i.out_samplerate/q.BLKSIZE,P=0;for(B=0,s=0;s<q.BLKSIZE/2;++s)B+=k,r.ATH.eql_w[s]=1/Math.pow(10,this.ATHformula(B,i)/10),P+=r.ATH.eql_w[s];for(P=1/P,s=q.BLKSIZE/2;--s>=0;)r.ATH.eql_w[s]*=P}for(M=g=0;M<r.npart_s;++M)for(s=0;s<r.numlines_s[M];++s)++g;G(129==g);for(M=g=0;M<r.npart_l;++M)for(s=0;s<r.numlines_l[M];++s)++g;for(G(513==g),g=0,s=0;s<r.npart_l;s++){B=v*(g+r.numlines_l[s]/2)/(1*q.BLKSIZE);r.mld_cb_l[s]=ee(B),g+=r.numlines_l[s]}for(;s<q.CBANDS;++s)r.mld_cb_l[s]=1;for(g=0,s=0;s<r.npart_s;s++){B=v*(g+r.numlines_s[s]/2)/(1*q.BLKSIZE_s);r.mld_cb_s[s]=ee(B),g+=r.numlines_s[s]}for(;s<q.CBANDS;++s)r.mld_cb_s[s]=1;return 0},this.ATHformula=function(e,t){var i;switch(t.ATHtype){case 0:i=te(e,9);break;case 1:i=te(e,-1);break;case 2:default:i=te(e,0);break;case 3:i=te(e,1)+6;break;case 4:i=te(e,t.ATHcurve)}return i}};function X(e){var t=e;this.ordinal=function(){return t}}a(W),X.STEREO=new X(0),X.JOINT_STEREO=new X(1),X.DUAL_CHANNEL=new X(2),X.MONO=new X(3),X.NOT_SET=new X(4);var Y=X,K=a(Y),j=Y;var z=function(){this.class_id=0,this.num_samples=0,this.num_channels=0,this.in_samplerate=0,this.out_samplerate=0,this.scale=0,this.scale_left=0,this.scale_right=0,this.analysis=!1,this.bWriteVbrTag=!1,this.decode_only=!1,this.quality=0,this.mode=j.STEREO,this.force_ms=!1,this.free_format=!1,this.findReplayGain=!1,this.decode_on_the_fly=!1,this.write_id3tag_automatic=!1,this.brate=0,this.compression_ratio=0,this.copyright=0,this.original=0,this.extension=0,this.emphasis=0,this.error_protection=0,this.strict_ISO=!1,this.disable_reservoir=!1,this.quant_comp=0,this.quant_comp_short=0,this.experimentalY=!1,this.experimentalZ=0,this.exp_nspsytune=0,this.preset=0,this.VBR=null,this.VBR_q_frac=0,this.VBR_q=0,this.VBR_mean_bitrate_kbps=0,this.VBR_min_bitrate_kbps=0,this.VBR_max_bitrate_kbps=0,this.VBR_hard_min=0,this.lowpassfreq=0,this.highpassfreq=0,this.lowpasswidth=0,this.highpasswidth=0,this.maskingadjust=0,this.maskingadjust_short=0,this.ATHonly=!1,this.ATHshort=!1,this.noATH=!1,this.ATHtype=0,this.ATHcurve=0,this.ATHlower=0,this.athaa_type=0,this.athaa_loudapprox=0,this.athaa_sensitivity=0,this.short_blocks=null,this.useTemporal=!1,this.interChRatio=0,this.msfix=0,this.tune=!1,this.tune_value_a=0,this.version=0,this.encoder_delay=0,this.encoder_padding=0,this.framesize=0,this.frameNum=0,this.lame_allocated_gfp=0,this.internal_flags=null};a(z);var Z=T(),Q={};Q.SFBMAX=3*Z.SBMAX_s;var J=Q;a(J);var $=B;$.System,$.VbrMode,$.Float,$.ShortBlock,$.Util,$.Arrays,$.new_array_n,$.new_byte,$.new_double;var ee=$.new_float;$.new_float_n;var te=$.new_int;$.new_int_n,$.assert;var ie=J;var se=function(){this.xr=ee(576),this.l3_enc=te(576),this.scalefac=te(ie.SFBMAX),this.xrpow_max=0,this.part2_3_length=0,this.big_values=0,this.count1=0,this.global_gain=0,this.scalefac_compress=0,this.block_type=0,this.mixed_block_flag=0,this.table_select=te(3),this.subblock_gain=te(4),this.region0_count=0,this.region1_count=0,this.preflag=0,this.scalefac_scale=0,this.count1table_select=0,this.part2_length=0,this.sfb_lmax=0,this.sfb_smin=0,this.psy_lmax=0,this.sfbmax=0,this.psymax=0,this.sfbdivide=0,this.width=te(ie.SFBMAX),this.window=te(ie.SFBMAX),this.count1bits=0,this.sfb_partition_table=null,this.slen=te(4),this.max_nonzero_coeff=0;var e=this;function t(e){return new Int32Array(e)}this.assign=function(i){var s;e.xr=(s=i.xr,new Float32Array(s)),e.l3_enc=t(i.l3_enc),e.scalefac=t(i.scalefac),e.xrpow_max=i.xrpow_max,e.part2_3_length=i.part2_3_length,e.big_values=i.big_values,e.count1=i.count1,e.global_gain=i.global_gain,e.scalefac_compress=i.scalefac_compress,e.block_type=i.block_type,e.mixed_block_flag=i.mixed_block_flag,e.table_select=t(i.table_select),e.subblock_gain=t(i.subblock_gain),e.region0_count=i.region0_count,e.region1_count=i.region1_count,e.preflag=i.preflag,e.scalefac_scale=i.scalefac_scale,e.count1table_select=i.count1table_select,e.part2_length=i.part2_length,e.sfb_lmax=i.sfb_lmax,e.sfb_smin=i.sfb_smin,e.psy_lmax=i.psy_lmax,e.sfbmax=i.sfbmax,e.psymax=i.psymax,e.sfbdivide=i.sfbdivide,e.width=t(i.width),e.window=t(i.window),e.count1bits=i.count1bits,e.sfb_partition_table=i.sfb_partition_table.slice(0),e.slen=t(i.slen),e.max_nonzero_coeff=i.max_nonzero_coeff}};a(se);var re=B;re.System,re.VbrMode,re.Float,re.ShortBlock,re.Util,re.Arrays,re.new_array_n,re.new_byte,re.new_double,re.new_float,re.new_float_n;var ae=re.new_int;re.new_int_n,re.assert;var ne=se;var oe=function(){this.tt=[[null,null],[null,null]],this.main_data_begin=0,this.private_bits=0,this.resvDrain_pre=0,this.resvDrain_post=0,this.scfsi=[ae(4),ae(4)];for(var e=0;e<2;e++)for(var t=0;t<2;t++)this.tt[e][t]=new ne};a(oe);var le=B,he=le.System;le.VbrMode,le.Float,le.ShortBlock,le.Util,le.Arrays,le.new_array_n,le.new_byte,le.new_double,le.new_float,le.new_float_n;var _e=le.new_int;le.new_int_n,le.assert;var ue=T();var ce=function(e,t,i,s){this.l=_e(1+ue.SBMAX_l),this.s=_e(1+ue.SBMAX_s),this.psfb21=_e(1+ue.PSFB21),this.psfb12=_e(1+ue.PSFB12);var r=this.l,a=this.s;4==arguments.length&&(this.arrL=arguments[0],this.arrS=arguments[1],this.arr21=arguments[2],this.arr12=arguments[3],he.arraycopy(this.arrL,0,r,0,Math.min(this.arrL.length,this.l.length)),he.arraycopy(this.arrS,0,a,0,Math.min(this.arrS.length,this.s.length)),he.arraycopy(this.arr21,0,this.psfb21,0,Math.min(this.arr21.length,this.psfb21.length)),he.arraycopy(this.arr12,0,this.psfb12,0,Math.min(this.arr12.length,this.psfb12.length)))};a(ce);var fe=B;fe.System,fe.VbrMode,fe.Float,fe.ShortBlock,fe.Util,fe.Arrays,fe.new_array_n,fe.new_byte,fe.new_double;var de=fe.new_float,pe=fe.new_float_n,me=fe.new_int;fe.new_int_n,fe.assert;var be=T();var ve=function(){this.last_en_subshort=pe([4,9]),this.lastAttacks=me(4),this.pefirbuf=de(19),this.longfact=de(be.SBMAX_l),this.shortfact=de(be.SBMAX_s),this.attackthre=0,this.attackthre_s=0};a(ve);var ge=function(){this.sum=0,this.seen=0,this.want=0,this.pos=0,this.size=0,this.bag=null,this.nVbrNumFrames=0,this.nBytesWritten=0,this.TotalFrameSize=0};a(ge);var Se=B;Se.System,Se.VbrMode,Se.Float,Se.ShortBlock,Se.Util,Se.Arrays,Se.new_array_n;var Ee=Se.new_byte,Re=Se.new_double,Ae=Se.new_float,Be=Se.new_float_n,we=Se.new_int,Te=Se.new_int_n;Se.assert;var Me=oe,ye=ce,ke=ve,Pe=ge,Ne=w(),Ie=T(),xe=J;function Ce(){function e(){this.write_timing=0,this.ptr=0,this.buf=Ee(40)}this.Class_ID=0,this.lame_encode_frame_init=0,this.iteration_init_init=0,this.fill_buffer_resample_init=0,this.mfbuf=Be([2,Ce.MFSIZE]),this.mode_gr=0,this.channels_in=0,this.channels_out=0,this.resample_ratio=0,this.mf_samples_to_encode=0,this.mf_size=0,this.VBR_min_bitrate=0,this.VBR_max_bitrate=0,this.bitrate_index=0,this.samplerate_index=0,this.mode_ext=0,this.lowpass1=0,this.lowpass2=0,this.highpass1=0,this.highpass2=0,this.noise_shaping=0,this.noise_shaping_amp=0,this.substep_shaping=0,this.psymodel=0,this.noise_shaping_stop=0,this.subblock_gain=0,this.use_best_huffman=0,this.full_outer_loop=0,this.l3_side=new Me,this.ms_ratio=Ae(2),this.padding=0,this.frac_SpF=0,this.slot_lag=0,this.tag_spec=null,this.nMusicCRC=0,this.OldValue=we(2),this.CurrentStep=we(2),this.masking_lower=0,this.bv_scf=we(576),this.pseudohalf=we(xe.SFBMAX),this.sfb21_extra=!1,this.inbuf_old=new Array(2),this.blackfilt=new Array(2*Ce.BPC+1),this.itime=Re(2),this.sideinfo_len=0,this.sb_sample=Be([2,2,18,Ie.SBLIMIT]),this.amp_filter=Ae(32),this.header=new Array(Ce.MAX_HEADER_BUF),this.h_ptr=0,this.w_ptr=0,this.ancillary_flag=0,this.ResvSize=0,this.ResvMax=0,this.scalefac_band=new ye,this.minval_l=Ae(Ie.CBANDS),this.minval_s=Ae(Ie.CBANDS),this.nb_1=Be([4,Ie.CBANDS]),this.nb_2=Be([4,Ie.CBANDS]),this.nb_s1=Be([4,Ie.CBANDS]),this.nb_s2=Be([4,Ie.CBANDS]),this.s3_ss=null,this.s3_ll=null,this.decay=0,this.thm=new Array(4),this.en=new Array(4),this.tot_ener=Ae(4),this.loudness_sq=Be([2,2]),this.loudness_sq_save=Ae(2),this.mld_l=Ae(Ie.SBMAX_l),this.mld_s=Ae(Ie.SBMAX_s),this.bm_l=we(Ie.SBMAX_l),this.bo_l=we(Ie.SBMAX_l),this.bm_s=we(Ie.SBMAX_s),this.bo_s=we(Ie.SBMAX_s),this.npart_l=0,this.npart_s=0,this.s3ind=Te([Ie.CBANDS,2]),this.s3ind_s=Te([Ie.CBANDS,2]),this.numlines_s=we(Ie.CBANDS),this.numlines_l=we(Ie.CBANDS),this.rnumlines_l=Ae(Ie.CBANDS),this.mld_cb_l=Ae(Ie.CBANDS),this.mld_cb_s=Ae(Ie.CBANDS),this.numlines_s_num1=0,this.numlines_l_num1=0,this.pe=Ae(4),this.ms_ratio_s_old=0,this.ms_ratio_l_old=0,this.ms_ener_ratio_old=0,this.blocktype_old=we(2),this.nsPsy=new ke,this.VBR_seek_table=new Pe,this.ATH=null,this.PSY=null,this.nogap_total=0,this.nogap_current=0,this.decode_on_the_fly=!0,this.findReplayGain=!0,this.findPeakSample=!0,this.PeakSample=0,this.RadioGain=0,this.AudiophileGain=0,this.rgdata=null,this.noclipGainChange=0,this.noclipScale=0,this.bitrate_stereoMode_Hist=Te([16,5]),this.bitrate_blockType_Hist=Te([16,6]),this.pinfo=null,this.hip=null,this.in_buffer_nsamples=0,this.in_buffer_0=null,this.in_buffer_1=null,this.iteration_loop=null;for(var t=0;t<this.en.length;t++)this.en[t]=new Ne;for(t=0;t<this.thm.length;t++)this.thm[t]=new Ne;for(t=0;t<this.header.length;t++)this.header[t]=new e}Ce.MFSIZE=3456+Ie.ENCDELAY-Ie.MDCTDELAY,Ce.MAX_HEADER_BUF=256,Ce.MAX_BITS_PER_CHANNEL=4095,Ce.MAX_BITS_PER_GRANULE=7680,Ce.BPC=320;var Oe=Ce;a(Oe);var De=B;De.System,De.VbrMode,De.Float,De.ShortBlock,De.Util,De.Arrays,De.new_array_n,De.new_byte,De.new_double;var Le=De.new_float;De.new_float_n,De.new_int,De.new_int_n,De.assert;var Fe=T();var Ve=function(){this.useAdjust=0,this.aaSensitivityP=0,this.adjust=0,this.adjustLimit=0,this.decay=0,this.floor=0,this.l=Le(Fe.SBMAX_l),this.s=Le(Fe.SBMAX_s),this.psfb21=Le(Fe.PSFB21),this.psfb12=Le(Fe.PSFB12),this.cb_l=Le(Fe.CBANDS),this.cb_s=Le(Fe.CBANDS),this.eql_w=Le(Fe.BLKSIZE/2)};a(Ve);var He=B,Ge=He.System;He.VbrMode,He.Float,He.ShortBlock,He.Util;var Ue=He.Arrays;function qe(){qe.YULE_ORDER;qe.MAX_SAMP_FREQ;var e=qe.RMS_WINDOW_TIME_NUMERATOR,t=qe.RMS_WINDOW_TIME_DENOMINATOR;qe.MAX_SAMPLES_PER_WINDOW;var i=[[.038575994352,-3.84664617118067,-.02160367184185,7.81501653005538,-.00123395316851,-11.34170355132042,-9291677959e-14,13.05504219327545,-.01655260341619,-12.28759895145294,.02161526843274,9.4829380631979,-.02074045215285,-5.87257861775999,.00594298065125,2.75465861874613,.00306428023191,-.86984376593551,.00012025322027,.13919314567432,.00288463683916],[.0541865640643,-3.47845948550071,-.02911007808948,6.36317777566148,-.00848709379851,-8.54751527471874,-.00851165645469,9.4769360780128,-.00834990904936,-8.81498681370155,.02245293253339,6.85401540936998,-.02596338512915,-4.39470996079559,.01624864962975,2.19611684890774,-.00240879051584,-.75104302451432,.00674613682247,.13149317958808,-.00187763777362],[.15457299681924,-2.37898834973084,-.09331049056315,2.84868151156327,-.06247880153653,-2.64577170229825,.02163541888798,2.23697657451713,-.05588393329856,-1.67148153367602,.04781476674921,1.00595954808547,.00222312597743,-.45953458054983,.03174092540049,.16378164858596,-.01390589421898,-.05032077717131,.00651420667831,.0234789740702,-.00881362733839],[.30296907319327,-1.61273165137247,-.22613988682123,1.0797749225997,-.08587323730772,-.2565625775407,.03282930172664,-.1627671912044,-.00915702933434,-.22638893773906,-.02364141202522,.39120800788284,-.00584456039913,-.22138138954925,.06276101321749,.04500235387352,-828086748e-14,.02005851806501,.00205861885564,.00302439095741,-.02950134983287],[.33642304856132,-1.49858979367799,-.2557224142557,.87350271418188,-.11828570177555,.12205022308084,.11921148675203,-.80774944671438,-.07834489609479,.47854794562326,-.0046997791438,-.12453458140019,-.0058950022444,-.04067510197014,.05724228140351,.08333755284107,.00832043980773,-.04237348025746,-.0163538138454,.02977207319925,-.0176017656815],[.4491525660845,-.62820619233671,-.14351757464547,.29661783706366,-.22784394429749,-.372563729424,-.01419140100551,.00213767857124,.04078262797139,-.42029820170918,-.12398163381748,.22199650564824,.04097565135648,.00613424350682,.10478503600251,.06747620744683,-.01863887810927,.05784820375801,-.03193428438915,.03222754072173,.00541907748707],[.56619470757641,-1.04800335126349,-.75464456939302,.29156311971249,.1624213774223,-.26806001042947,.16744243493672,.00819999645858,-.18901604199609,.45054734505008,.3093178284183,-.33032403314006,-.27562961986224,.0673936833311,.00647310677246,-.04784254229033,.08647503780351,.01639907836189,-.0378898455484,.01807364323573,-.00588215443421],[.58100494960553,-.51035327095184,-.53174909058578,-.31863563325245,-.14289799034253,-.20256413484477,.17520704835522,.1472815413433,.02377945217615,.38952639978999,.15558449135573,-.23313271880868,-.25344790059353,-.05246019024463,.01628462406333,-.02505961724053,.06920467763959,.02442357316099,-.03721611395801,.01818801111503,-.00749618797172],[.53648789255105,-.2504987195602,-.42163034350696,-.43193942311114,-.00275953611929,-.03424681017675,.04267842219415,-.04678328784242,-.10214864179676,.26408300200955,.14590772289388,.15113130533216,-.02459864859345,-.17556493366449,-.11202315195388,-.18823009262115,-.04060034127,.05477720428674,.0478866554818,.0470440968812,-.02217936801134]],s=[[.98621192462708,-1.97223372919527,-1.97242384925416,.97261396931306,.98621192462708],[.98500175787242,-1.96977855582618,-1.97000351574484,.9702284756635,.98500175787242],[.97938932735214,-1.95835380975398,-1.95877865470428,.95920349965459,.97938932735214],[.97531843204928,-1.95002759149878,-1.95063686409857,.95124613669835,.97531843204928],[.97316523498161,-1.94561023566527,-1.94633046996323,.94705070426118,.97316523498161],[.96454515552826,-1.92783286977036,-1.92909031105652,.93034775234268,.96454515552826],[.96009142950541,-1.91858953033784,-1.92018285901082,.92177618768381,.96009142950541],[.95856916599601,-1.9154210807478,-1.91713833199203,.91885558323625,.95856916599601],[.94597685600279,-1.88903307939452,-1.89195371200558,.89487434461664,.94597685600279]];function r(e,t,i,s,r,a){for(;0!=r--;)i[s]=1e-10+e[t+0]*a[0]-i[s-1]*a[1]+e[t-1]*a[2]-i[s-2]*a[3]+e[t-2]*a[4]-i[s-3]*a[5]+e[t-3]*a[6]-i[s-4]*a[7]+e[t-4]*a[8]-i[s-5]*a[9]+e[t-5]*a[10]-i[s-6]*a[11]+e[t-6]*a[12]-i[s-7]*a[13]+e[t-7]*a[14]-i[s-8]*a[15]+e[t-8]*a[16]-i[s-9]*a[17]+e[t-9]*a[18]-i[s-10]*a[19]+e[t-10]*a[20],++s,++t}function a(e,t,i,s,r,a){for(;0!=r--;)i[s]=e[t+0]*a[0]-i[s-1]*a[1]+e[t-1]*a[2]-i[s-2]*a[3]+e[t-2]*a[4],++s,++t}function n(e){return e*e}this.InitGainAnalysis=function(i,s){return function(i,s){for(var r=0;r<MAX_ORDER;r++)i.linprebuf[r]=i.lstepbuf[r]=i.loutbuf[r]=i.rinprebuf[r]=i.rstepbuf[r]=i.routbuf[r]=0;switch(0|s){case 48e3:i.reqindex=0;break;case 44100:i.reqindex=1;break;case 32e3:i.reqindex=2;break;case 24e3:i.reqindex=3;break;case 22050:i.reqindex=4;break;case 16e3:i.reqindex=5;break;case 12e3:i.reqindex=6;break;case 11025:i.reqindex=7;break;case 8e3:i.reqindex=8;break;default:return INIT_GAIN_ANALYSIS_ERROR}return i.sampleWindow=0|(s*e+t-1)/t,i.lsum=0,i.rsum=0,i.totsamp=0,Ue.ill(i.A,0),INIT_GAIN_ANALYSIS_OK}(i,s)!=INIT_GAIN_ANALYSIS_OK?INIT_GAIN_ANALYSIS_ERROR:(i.linpre=MAX_ORDER,i.rinpre=MAX_ORDER,i.lstep=MAX_ORDER,i.rstep=MAX_ORDER,i.lout=MAX_ORDER,i.rout=MAX_ORDER,Ue.fill(i.B,0),INIT_GAIN_ANALYSIS_OK)},this.AnalyzeSamples=function(e,t,o,l,h,_,u){var c,f,d,p,m,b,v;if(0==_)return GAIN_ANALYSIS_OK;switch(v=0,m=_,u){case 1:l=t,h=o;break;case 2:break;default:return GAIN_ANALYSIS_ERROR}for(_<MAX_ORDER?(Ge.arraycopy(t,o,e.linprebuf,MAX_ORDER,_),Ge.arraycopy(l,h,e.rinprebuf,MAX_ORDER,_)):(Ge.arraycopy(t,o,e.linprebuf,MAX_ORDER,MAX_ORDER),Ge.arraycopy(l,h,e.rinprebuf,MAX_ORDER,MAX_ORDER));m>0;){b=m>e.sampleWindow-e.totsamp?e.sampleWindow-e.totsamp:m,v<MAX_ORDER?(c=e.linpre+v,f=e.linprebuf,d=e.rinpre+v,p=e.rinprebuf,b>MAX_ORDER-v&&(b=MAX_ORDER-v)):(c=o+v,f=t,d=h+v,p=l),r(f,c,e.lstepbuf,e.lstep+e.totsamp,b,i[e.reqindex]),r(p,d,e.rstepbuf,e.rstep+e.totsamp,b,i[e.reqindex]),a(e.lstepbuf,e.lstep+e.totsamp,e.loutbuf,e.lout+e.totsamp,b,s[e.reqindex]),a(e.rstepbuf,e.rstep+e.totsamp,e.routbuf,e.rout+e.totsamp,b,s[e.reqindex]),c=e.lout+e.totsamp,f=e.loutbuf,d=e.rout+e.totsamp,p=e.routbuf;for(var g=b%8;0!=g--;)e.lsum+=n(f[c++]),e.rsum+=n(p[d++]);for(g=b/8;0!=g--;)e.lsum+=n(f[c+0])+n(f[c+1])+n(f[c+2])+n(f[c+3])+n(f[c+4])+n(f[c+5])+n(f[c+6])+n(f[c+7]),c+=8,e.rsum+=n(p[d+0])+n(p[d+1])+n(p[d+2])+n(p[d+3])+n(p[d+4])+n(p[d+5])+n(p[d+6])+n(p[d+7]),d+=8;if(m-=b,v+=b,e.totsamp+=b,e.totsamp==e.sampleWindow){var S=10*qe.STEPS_per_dB*Math.log10((e.lsum+e.rsum)/e.totsamp*.5+1e-37),E=S<=0?0:0|S;E>=e.A.length&&(E=e.A.length-1),e.A[E]++,e.lsum=e.rsum=0,Ge.arraycopy(e.loutbuf,e.totsamp,e.loutbuf,0,MAX_ORDER),Ge.arraycopy(e.routbuf,e.totsamp,e.routbuf,0,MAX_ORDER),Ge.arraycopy(e.lstepbuf,e.totsamp,e.lstepbuf,0,MAX_ORDER),Ge.arraycopy(e.rstepbuf,e.totsamp,e.rstepbuf,0,MAX_ORDER),e.totsamp=0}if(e.totsamp>e.sampleWindow)return GAIN_ANALYSIS_ERROR}return _<MAX_ORDER?(Ge.arraycopy(e.linprebuf,_,e.linprebuf,0,MAX_ORDER-_),Ge.arraycopy(e.rinprebuf,_,e.rinprebuf,0,MAX_ORDER-_),Ge.arraycopy(t,o,e.linprebuf,MAX_ORDER-_,_),Ge.arraycopy(l,h,e.rinprebuf,MAX_ORDER-_,_)):(Ge.arraycopy(t,o+_-MAX_ORDER,e.linprebuf,0,MAX_ORDER),Ge.arraycopy(l,h+_-MAX_ORDER,e.rinprebuf,0,MAX_ORDER)),GAIN_ANALYSIS_OK},this.GetTitleGain=function(e){for(var t=function(e,t){var i,s=0;for(i=0;i<t;i++)s+=e[i];if(0==s)return GAIN_NOT_ENOUGH_SAMPLES;var r=0|Math.ceil(s*(1-.95));for(i=t;i-- >0&&!((r-=e[i])<=0););return 64.82-i/qe.STEPS_per_dB}(e.A,e.A.length),i=0;i<e.A.length;i++)e.B[i]+=e.A[i],e.A[i]=0;for(i=0;i<MAX_ORDER;i++)e.linprebuf[i]=e.lstepbuf[i]=e.loutbuf[i]=e.rinprebuf[i]=e.rstepbuf[i]=e.routbuf[i]=0;return e.totsamp=0,e.lsum=e.rsum=0,t}}He.new_array_n,He.new_byte,He.new_double,He.new_float,He.new_float_n,He.new_int,He.new_int_n,He.assert,qe.STEPS_per_dB=100,qe.MAX_dB=120,qe.GAIN_NOT_ENOUGH_SAMPLES=-24601,qe.GAIN_ANALYSIS_ERROR=0,qe.GAIN_ANALYSIS_OK=1,qe.INIT_GAIN_ANALYSIS_ERROR=0,qe.INIT_GAIN_ANALYSIS_OK=1,qe.YULE_ORDER=10,qe.MAX_ORDER=qe.YULE_ORDER,qe.MAX_SAMP_FREQ=48e3,qe.RMS_WINDOW_TIME_NUMERATOR=1,qe.RMS_WINDOW_TIME_DENOMINATOR=20,qe.MAX_SAMPLES_PER_WINDOW=qe.MAX_SAMP_FREQ*qe.RMS_WINDOW_TIME_NUMERATOR/qe.RMS_WINDOW_TIME_DENOMINATOR+1;var We=qe;a(We);var Xe=B;Xe.System,Xe.VbrMode,Xe.Float,Xe.ShortBlock,Xe.Util,Xe.Arrays,Xe.new_array_n,Xe.new_byte,Xe.new_double;var Ye=Xe.new_float;Xe.new_float_n;var Ke=Xe.new_int;Xe.new_int_n,Xe.assert;var je=We;var ze=function(){this.linprebuf=Ye(2*je.MAX_ORDER),this.linpre=0,this.lstepbuf=Ye(je.MAX_SAMPLES_PER_WINDOW+je.MAX_ORDER),this.lstep=0,this.loutbuf=Ye(je.MAX_SAMPLES_PER_WINDOW+je.MAX_ORDER),this.lout=0,this.rinprebuf=Ye(2*je.MAX_ORDER),this.rinpre=0,this.rstepbuf=Ye(je.MAX_SAMPLES_PER_WINDOW+je.MAX_ORDER),this.rstep=0,this.routbuf=Ye(je.MAX_SAMPLES_PER_WINDOW+je.MAX_ORDER),this.rout=0,this.sampleWindow=0,this.totsamp=0,this.lsum=0,this.rsum=0,this.freqindex=0,this.first=0,this.A=Ke(0|je.STEPS_per_dB*je.MAX_dB),this.B=Ke(0|je.STEPS_per_dB*je.MAX_dB)};a(ze);var Ze=function(e){this.bits=e};a(Ze);var Qe=B;Qe.System,Qe.VbrMode,Qe.Float,Qe.ShortBlock,Qe.Util,Qe.Arrays,Qe.new_array_n,Qe.new_byte,Qe.new_double;var Je=Qe.new_float;Qe.new_float_n;var $e=Qe.new_int;Qe.new_int_n;var et=Qe.assert,tt=Ze,it=T(),st=J,rt=Oe;var at=function(e){var t=e;this.quantize=t,this.iteration_loop=function(e,t,i,s){var r,a=e.internal_flags,n=Je(st.SFBMAX),o=Je(576),l=$e(2),h=0,_=a.l3_side,u=new tt(h);this.quantize.rv.ResvFrameBegin(e,u),h=u.bits;for(var c=0;c<a.mode_gr;c++){r=this.quantize.qupvt.on_pe(e,t,l,h,c,c),a.mode_ext==it.MPG_MD_MS_LR&&(this.quantize.ms_convert(a.l3_side,c),this.quantize.qupvt.reduce_side(l,i[c],h,r));for(var f=0;f<a.channels_out;f++){var d,p,m=_.tt[c][f];m.block_type!=it.SHORT_TYPE?(d=0,p=a.PSY.mask_adjust-d):(d=0,p=a.PSY.mask_adjust_short-d),a.masking_lower=Math.pow(10,.1*p),this.quantize.init_outer_loop(a,m),this.quantize.init_xrpow(a,m,o)&&(this.quantize.qupvt.calc_xmin(e,s[c][f],m,n),this.quantize.outer_loop(e,m,n,o,f,l[f])),this.quantize.iteration_finish_one(a,c,f),et(m.part2_3_length<=rt.MAX_BITS_PER_CHANNEL),et(m.part2_3_length<=l[f])}}this.quantize.rv.ResvFrameEnd(a,h)}};function nt(e,t,i,s){this.xlen=e,this.linmax=t,this.table=i,this.hlen=s}a(at);var ot={t1HB:[1,1,1,0],t2HB:[1,2,1,3,1,1,3,2,0],t3HB:[3,2,1,1,1,1,3,2,0],t5HB:[1,2,6,5,3,1,4,4,7,5,7,1,6,1,1,0],t6HB:[7,3,5,1,6,2,3,2,5,4,4,1,3,3,2,0],t7HB:[1,2,10,19,16,10,3,3,7,10,5,3,11,4,13,17,8,4,12,11,18,15,11,2,7,6,9,14,3,1,6,4,5,3,2,0],t8HB:[3,4,6,18,12,5,5,1,2,16,9,3,7,3,5,14,7,3,19,17,15,13,10,4,13,5,8,11,5,1,12,4,4,1,1,0],t9HB:[7,5,9,14,15,7,6,4,5,5,6,7,7,6,8,8,8,5,15,6,9,10,5,1,11,7,9,6,4,1,14,4,6,2,6,0],t10HB:[1,2,10,23,35,30,12,17,3,3,8,12,18,21,12,7,11,9,15,21,32,40,19,6,14,13,22,34,46,23,18,7,20,19,33,47,27,22,9,3,31,22,41,26,21,20,5,3,14,13,10,11,16,6,5,1,9,8,7,8,4,4,2,0],t11HB:[3,4,10,24,34,33,21,15,5,3,4,10,32,17,11,10,11,7,13,18,30,31,20,5,25,11,19,59,27,18,12,5,35,33,31,58,30,16,7,5,28,26,32,19,17,15,8,14,14,12,9,13,14,9,4,1,11,4,6,6,6,3,2,0],t12HB:[9,6,16,33,41,39,38,26,7,5,6,9,23,16,26,11,17,7,11,14,21,30,10,7,17,10,15,12,18,28,14,5,32,13,22,19,18,16,9,5,40,17,31,29,17,13,4,2,27,12,11,15,10,7,4,1,27,12,8,12,6,3,1,0],t13HB:[1,5,14,21,34,51,46,71,42,52,68,52,67,44,43,19,3,4,12,19,31,26,44,33,31,24,32,24,31,35,22,14,15,13,23,36,59,49,77,65,29,40,30,40,27,33,42,16,22,20,37,61,56,79,73,64,43,76,56,37,26,31,25,14,35,16,60,57,97,75,114,91,54,73,55,41,48,53,23,24,58,27,50,96,76,70,93,84,77,58,79,29,74,49,41,17,47,45,78,74,115,94,90,79,69,83,71,50,59,38,36,15,72,34,56,95,92,85,91,90,86,73,77,65,51,44,43,42,43,20,30,44,55,78,72,87,78,61,46,54,37,30,20,16,53,25,41,37,44,59,54,81,66,76,57,54,37,18,39,11,35,33,31,57,42,82,72,80,47,58,55,21,22,26,38,22,53,25,23,38,70,60,51,36,55,26,34,23,27,14,9,7,34,32,28,39,49,75,30,52,48,40,52,28,18,17,9,5,45,21,34,64,56,50,49,45,31,19,12,15,10,7,6,3,48,23,20,39,36,35,53,21,16,23,13,10,6,1,4,2,16,15,17,27,25,20,29,11,17,12,16,8,1,1,0,1],t15HB:[7,12,18,53,47,76,124,108,89,123,108,119,107,81,122,63,13,5,16,27,46,36,61,51,42,70,52,83,65,41,59,36,19,17,15,24,41,34,59,48,40,64,50,78,62,80,56,33,29,28,25,43,39,63,55,93,76,59,93,72,54,75,50,29,52,22,42,40,67,57,95,79,72,57,89,69,49,66,46,27,77,37,35,66,58,52,91,74,62,48,79,63,90,62,40,38,125,32,60,56,50,92,78,65,55,87,71,51,73,51,70,30,109,53,49,94,88,75,66,122,91,73,56,42,64,44,21,25,90,43,41,77,73,63,56,92,77,66,47,67,48,53,36,20,71,34,67,60,58,49,88,76,67,106,71,54,38,39,23,15,109,53,51,47,90,82,58,57,48,72,57,41,23,27,62,9,86,42,40,37,70,64,52,43,70,55,42,25,29,18,11,11,118,68,30,55,50,46,74,65,49,39,24,16,22,13,14,7,91,44,39,38,34,63,52,45,31,52,28,19,14,8,9,3,123,60,58,53,47,43,32,22,37,24,17,12,15,10,2,1,71,37,34,30,28,20,17,26,21,16,10,6,8,6,2,0],t16HB:[1,5,14,44,74,63,110,93,172,149,138,242,225,195,376,17,3,4,12,20,35,62,53,47,83,75,68,119,201,107,207,9,15,13,23,38,67,58,103,90,161,72,127,117,110,209,206,16,45,21,39,69,64,114,99,87,158,140,252,212,199,387,365,26,75,36,68,65,115,101,179,164,155,264,246,226,395,382,362,9,66,30,59,56,102,185,173,265,142,253,232,400,388,378,445,16,111,54,52,100,184,178,160,133,257,244,228,217,385,366,715,10,98,48,91,88,165,157,148,261,248,407,397,372,380,889,884,8,85,84,81,159,156,143,260,249,427,401,392,383,727,713,708,7,154,76,73,141,131,256,245,426,406,394,384,735,359,710,352,11,139,129,67,125,247,233,229,219,393,743,737,720,885,882,439,4,243,120,118,115,227,223,396,746,742,736,721,712,706,223,436,6,202,224,222,218,216,389,386,381,364,888,443,707,440,437,1728,4,747,211,210,208,370,379,734,723,714,1735,883,877,876,3459,865,2,377,369,102,187,726,722,358,711,709,866,1734,871,3458,870,434,0,12,10,7,11,10,17,11,9,13,12,10,7,5,3,1,3],t24HB:[15,13,46,80,146,262,248,434,426,669,653,649,621,517,1032,88,14,12,21,38,71,130,122,216,209,198,327,345,319,297,279,42,47,22,41,74,68,128,120,221,207,194,182,340,315,295,541,18,81,39,75,70,134,125,116,220,204,190,178,325,311,293,271,16,147,72,69,135,127,118,112,210,200,188,352,323,306,285,540,14,263,66,129,126,119,114,214,202,192,180,341,317,301,281,262,12,249,123,121,117,113,215,206,195,185,347,330,308,291,272,520,10,435,115,111,109,211,203,196,187,353,332,313,298,283,531,381,17,427,212,208,205,201,193,186,177,169,320,303,286,268,514,377,16,335,199,197,191,189,181,174,333,321,305,289,275,521,379,371,11,668,184,183,179,175,344,331,314,304,290,277,530,383,373,366,10,652,346,171,168,164,318,309,299,287,276,263,513,375,368,362,6,648,322,316,312,307,302,292,284,269,261,512,376,370,364,359,4,620,300,296,294,288,282,273,266,515,380,374,369,365,361,357,2,1033,280,278,274,267,264,259,382,378,372,367,363,360,358,356,0,43,20,19,17,15,13,11,9,7,6,4,7,5,3,1,3],t32HB:[1,10,8,20,12,20,16,32,14,12,24,0,28,16,24,16],t33HB:[15,28,26,48,22,40,36,64,14,24,20,32,12,16,8,0],t1l:[1,4,3,5],t2l:[1,4,7,4,5,7,6,7,8],t3l:[2,3,7,4,4,7,6,7,8],t5l:[1,4,7,8,4,5,8,9,7,8,9,10,8,8,9,10],t6l:[3,4,6,8,4,4,6,7,5,6,7,8,7,7,8,9],t7l:[1,4,7,9,9,10,4,6,8,9,9,10,7,7,9,10,10,11,8,9,10,11,11,11,8,9,10,11,11,12,9,10,11,12,12,12],t8l:[2,4,7,9,9,10,4,4,6,10,10,10,7,6,8,10,10,11,9,10,10,11,11,12,9,9,10,11,12,12,10,10,11,11,13,13],t9l:[3,4,6,7,9,10,4,5,6,7,8,10,5,6,7,8,9,10,7,7,8,9,9,10,8,8,9,9,10,11,9,9,10,10,11,11],t10l:[1,4,7,9,10,10,10,11,4,6,8,9,10,11,10,10,7,8,9,10,11,12,11,11,8,9,10,11,12,12,11,12,9,10,11,12,12,12,12,12,10,11,12,12,13,13,12,13,9,10,11,12,12,12,13,13,10,10,11,12,12,13,13,13],t11l:[2,4,6,8,9,10,9,10,4,5,6,8,10,10,9,10,6,7,8,9,10,11,10,10,8,8,9,11,10,12,10,11,9,10,10,11,11,12,11,12,9,10,11,12,12,13,12,13,9,9,9,10,11,12,12,12,9,9,10,11,12,12,12,12],t12l:[4,4,6,8,9,10,10,10,4,5,6,7,9,9,10,10,6,6,7,8,9,10,9,10,7,7,8,8,9,10,10,10,8,8,9,9,10,10,10,11,9,9,10,10,10,11,10,11,9,9,9,10,10,11,11,12,10,10,10,11,11,11,11,12],t13l:[1,5,7,8,9,10,10,11,10,11,12,12,13,13,14,14,4,6,8,9,10,10,11,11,11,11,12,12,13,14,14,14,7,8,9,10,11,11,12,12,11,12,12,13,13,14,15,15,8,9,10,11,11,12,12,12,12,13,13,13,13,14,15,15,9,9,11,11,12,12,13,13,12,13,13,14,14,15,15,16,10,10,11,12,12,12,13,13,13,13,14,13,15,15,16,16,10,11,12,12,13,13,13,13,13,14,14,14,15,15,16,16,11,11,12,13,13,13,14,14,14,14,15,15,15,16,18,18,10,10,11,12,12,13,13,14,14,14,14,15,15,16,17,17,11,11,12,12,13,13,13,15,14,15,15,16,16,16,18,17,11,12,12,13,13,14,14,15,14,15,16,15,16,17,18,19,12,12,12,13,14,14,14,14,15,15,15,16,17,17,17,18,12,13,13,14,14,15,14,15,16,16,17,17,17,18,18,18,13,13,14,15,15,15,16,16,16,16,16,17,18,17,18,18,14,14,14,15,15,15,17,16,16,19,17,17,17,19,18,18,13,14,15,16,16,16,17,16,17,17,18,18,21,20,21,18],t15l:[3,5,6,8,8,9,10,10,10,11,11,12,12,12,13,14,5,5,7,8,9,9,10,10,10,11,11,12,12,12,13,13,6,7,7,8,9,9,10,10,10,11,11,12,12,13,13,13,7,8,8,9,9,10,10,11,11,11,12,12,12,13,13,13,8,8,9,9,10,10,11,11,11,11,12,12,12,13,13,13,9,9,9,10,10,10,11,11,11,11,12,12,13,13,13,14,10,9,10,10,10,11,11,11,11,12,12,12,13,13,14,14,10,10,10,11,11,11,11,12,12,12,12,12,13,13,13,14,10,10,10,11,11,11,11,12,12,12,12,13,13,14,14,14,10,10,11,11,11,11,12,12,12,13,13,13,13,14,14,14,11,11,11,11,12,12,12,12,12,13,13,13,13,14,15,14,11,11,11,11,12,12,12,12,13,13,13,13,14,14,14,15,12,12,11,12,12,12,13,13,13,13,13,13,14,14,15,15,12,12,12,12,12,13,13,13,13,14,14,14,14,14,15,15,13,13,13,13,13,13,13,13,14,14,14,14,15,15,14,15,13,13,13,13,13,13,13,14,14,14,14,14,15,15,15,15],t16_5l:[1,5,7,9,10,10,11,11,12,12,12,13,13,13,14,11,4,6,8,9,10,11,11,11,12,12,12,13,14,13,14,11,7,8,9,10,11,11,12,12,13,12,13,13,13,14,14,12,9,9,10,11,11,12,12,12,13,13,14,14,14,15,15,13,10,10,11,11,12,12,13,13,13,14,14,14,15,15,15,12,10,10,11,11,12,13,13,14,13,14,14,15,15,15,16,13,11,11,11,12,13,13,13,13,14,14,14,14,15,15,16,13,11,11,12,12,13,13,13,14,14,15,15,15,15,17,17,13,11,12,12,13,13,13,14,14,15,15,15,15,16,16,16,13,12,12,12,13,13,14,14,15,15,15,15,16,15,16,15,14,12,13,12,13,14,14,14,14,15,16,16,16,17,17,16,13,13,13,13,13,14,14,15,16,16,16,16,16,16,15,16,14,13,14,14,14,14,15,15,15,15,17,16,16,16,16,18,14,15,14,14,14,15,15,16,16,16,18,17,17,17,19,17,14,14,15,13,14,16,16,15,16,16,17,18,17,19,17,16,14,11,11,11,12,12,13,13,13,14,14,14,14,14,14,14,12],t16l:[1,5,7,9,10,10,11,11,12,12,12,13,13,13,14,10,4,6,8,9,10,11,11,11,12,12,12,13,14,13,14,10,7,8,9,10,11,11,12,12,13,12,13,13,13,14,14,11,9,9,10,11,11,12,12,12,13,13,14,14,14,15,15,12,10,10,11,11,12,12,13,13,13,14,14,14,15,15,15,11,10,10,11,11,12,13,13,14,13,14,14,15,15,15,16,12,11,11,11,12,13,13,13,13,14,14,14,14,15,15,16,12,11,11,12,12,13,13,13,14,14,15,15,15,15,17,17,12,11,12,12,13,13,13,14,14,15,15,15,15,16,16,16,12,12,12,12,13,13,14,14,15,15,15,15,16,15,16,15,13,12,13,12,13,14,14,14,14,15,16,16,16,17,17,16,12,13,13,13,13,14,14,15,16,16,16,16,16,16,15,16,13,13,14,14,14,14,15,15,15,15,17,16,16,16,16,18,13,15,14,14,14,15,15,16,16,16,18,17,17,17,19,17,13,14,15,13,14,16,16,15,16,16,17,18,17,19,17,16,13,10,10,10,11,11,12,12,12,13,13,13,13,13,13,13,10],t24l:[4,5,7,8,9,10,10,11,11,12,12,12,12,12,13,10,5,6,7,8,9,10,10,11,11,11,12,12,12,12,12,10,7,7,8,9,9,10,10,11,11,11,11,12,12,12,13,9,8,8,9,9,10,10,10,11,11,11,11,12,12,12,12,9,9,9,9,10,10,10,10,11,11,11,12,12,12,12,13,9,10,9,10,10,10,10,11,11,11,11,12,12,12,12,12,9,10,10,10,10,10,11,11,11,11,12,12,12,12,12,13,9,11,10,10,10,11,11,11,11,12,12,12,12,12,13,13,10,11,11,11,11,11,11,11,11,11,12,12,12,12,13,13,10,11,11,11,11,11,11,11,12,12,12,12,12,13,13,13,10,12,11,11,11,11,12,12,12,12,12,12,13,13,13,13,10,12,12,11,11,11,12,12,12,12,12,12,13,13,13,13,10,12,12,12,12,12,12,12,12,12,12,13,13,13,13,13,10,12,12,12,12,12,12,12,12,13,13,13,13,13,13,13,10,13,12,12,12,12,12,12,13,13,13,13,13,13,13,13,10,9,9,9,9,9,9,9,9,9,9,9,10,10,10,10,6],t32l:[1,5,5,7,5,8,7,9,5,7,7,9,7,9,9,10],t33l:[4,5,5,6,5,6,6,7,5,6,6,7,6,7,7,8]};ot.ht=[new nt(0,0,null,null),new nt(2,0,ot.t1HB,ot.t1l),new nt(3,0,ot.t2HB,ot.t2l),new nt(3,0,ot.t3HB,ot.t3l),new nt(0,0,null,null),new nt(4,0,ot.t5HB,ot.t5l),new nt(4,0,ot.t6HB,ot.t6l),new nt(6,0,ot.t7HB,ot.t7l),new nt(6,0,ot.t8HB,ot.t8l),new nt(6,0,ot.t9HB,ot.t9l),new nt(8,0,ot.t10HB,ot.t10l),new nt(8,0,ot.t11HB,ot.t11l),new nt(8,0,ot.t12HB,ot.t12l),new nt(16,0,ot.t13HB,ot.t13l),new nt(0,0,null,ot.t16_5l),new nt(16,0,ot.t15HB,ot.t15l),new nt(1,1,ot.t16HB,ot.t16l),new nt(2,3,ot.t16HB,ot.t16l),new nt(3,7,ot.t16HB,ot.t16l),new nt(4,15,ot.t16HB,ot.t16l),new nt(6,63,ot.t16HB,ot.t16l),new nt(8,255,ot.t16HB,ot.t16l),new nt(10,1023,ot.t16HB,ot.t16l),new nt(13,8191,ot.t16HB,ot.t16l),new nt(4,15,ot.t24HB,ot.t24l),new nt(5,31,ot.t24HB,ot.t24l),new nt(6,63,ot.t24HB,ot.t24l),new nt(7,127,ot.t24HB,ot.t24l),new nt(8,255,ot.t24HB,ot.t24l),new nt(9,511,ot.t24HB,ot.t24l),new nt(11,2047,ot.t24HB,ot.t24l),new nt(13,8191,ot.t24HB,ot.t24l),new nt(0,0,ot.t32HB,ot.t32l),new nt(0,0,ot.t33HB,ot.t33l)],ot.largetbl=[65540,327685,458759,589832,655369,655370,720906,720907,786443,786444,786444,851980,851980,851980,917517,655370,262149,393222,524295,589832,655369,720906,720906,720907,786443,786443,786444,851980,917516,851980,917516,655370,458759,524295,589832,655369,720905,720906,786442,786443,851979,786443,851979,851980,851980,917516,917517,720905,589832,589832,655369,720905,720906,786442,786442,786443,851979,851979,917515,917516,917516,983052,983052,786441,655369,655369,720905,720906,786442,786442,851978,851979,851979,917515,917516,917516,983052,983052,983053,720905,655370,655369,720906,720906,786442,851978,851979,917515,851979,917515,917516,983052,983052,983052,1048588,786441,720906,720906,720906,786442,851978,851979,851979,851979,917515,917516,917516,917516,983052,983052,1048589,786441,720907,720906,786442,786442,851979,851979,851979,917515,917516,983052,983052,983052,983052,1114125,1114125,786442,720907,786443,786443,851979,851979,851979,917515,917515,983051,983052,983052,983052,1048588,1048589,1048589,786442,786443,786443,786443,851979,851979,917515,917515,983052,983052,983052,983052,1048588,983053,1048589,983053,851978,786444,851979,786443,851979,917515,917516,917516,917516,983052,1048588,1048588,1048589,1114125,1114125,1048589,786442,851980,851980,851979,851979,917515,917516,983052,1048588,1048588,1048588,1048588,1048589,1048589,983053,1048589,851978,851980,917516,917516,917516,917516,983052,983052,983052,983052,1114124,1048589,1048589,1048589,1048589,1179661,851978,983052,917516,917516,917516,983052,983052,1048588,1048588,1048589,1179661,1114125,1114125,1114125,1245197,1114125,851978,917517,983052,851980,917516,1048588,1048588,983052,1048589,1048589,1114125,1179661,1114125,1245197,1114125,1048589,851978,655369,655369,655369,720905,720905,786441,786441,786441,851977,851977,851977,851978,851978,851978,851978,655366],ot.table23=[65538,262147,458759,262148,327684,458759,393222,458759,524296],ot.table56=[65539,262148,458758,524296,262148,327684,524294,589831,458757,524294,589831,655368,524295,524295,589832,655369],ot.bitrate_table=[[0,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1],[0,32,40,48,56,64,80,96,112,128,160,192,224,256,320,-1],[0,8,16,24,32,40,48,56,64,-1,-1,-1,-1,-1,-1,-1]],ot.samplerate_table=[[22050,24e3,16e3,-1],[44100,48e3,32e3,-1],[11025,12e3,8e3,-1]],ot.scfsi_band=[0,6,11,16,21];var lt=ot;a(lt);var ht=ce,_t=B;_t.System;var ut=_t.VbrMode,ct=_t.Float;_t.ShortBlock;var ft=_t.Util;_t.Arrays,_t.new_array_n,_t.new_byte,_t.new_double;var dt=_t.new_float;_t.new_float_n;var pt=_t.new_int;_t.new_int_n;var mt=_t.assert,bt=T(),vt=Ze,gt=Oe;function St(){var e=null,t=null,i=null;this.setModules=function(s,r,a){e=s,t=r,i=a},this.IPOW20=function(e){return mt(0<=e&&e<St.Q_MAX),_[e]};var s=2220446049250313e-31,r=St.IXMAX_VAL+2,a=St.Q_MAX,n=St.Q_MAX2;St.LARGE_BITS;var o=100;this.nr_of_sfb_block=[[[6,5,5,5],[9,9,9,9],[6,9,9,9]],[[6,5,7,3],[9,9,12,6],[6,9,12,6]],[[11,10,0,0],[18,18,0,0],[15,18,0,0]],[[7,7,7,0],[12,12,12,0],[6,15,12,0]],[[6,6,6,3],[12,9,9,6],[6,12,9,6]],[[8,8,5,0],[15,12,9,0],[6,18,9,0]]];var l=[0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,2,2,3,3,3,2,0];this.pretab=l,this.sfBandIndex=[new ht([0,6,12,18,24,30,36,44,54,66,80,96,116,140,168,200,238,284,336,396,464,522,576],[0,4,8,12,18,24,32,42,56,74,100,132,174,192],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]),new ht([0,6,12,18,24,30,36,44,54,66,80,96,114,136,162,194,232,278,332,394,464,540,576],[0,4,8,12,18,26,36,48,62,80,104,136,180,192],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]),new ht([0,6,12,18,24,30,36,44,54,66,80,96,116,140,168,200,238,284,336,396,464,522,576],[0,4,8,12,18,26,36,48,62,80,104,134,174,192],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]),new ht([0,4,8,12,16,20,24,30,36,44,52,62,74,90,110,134,162,196,238,288,342,418,576],[0,4,8,12,16,22,30,40,52,66,84,106,136,192],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]),new ht([0,4,8,12,16,20,24,30,36,42,50,60,72,88,106,128,156,190,230,276,330,384,576],[0,4,8,12,16,22,28,38,50,64,80,100,126,192],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]),new ht([0,4,8,12,16,20,24,30,36,44,54,66,82,102,126,156,194,240,296,364,448,550,576],[0,4,8,12,16,22,30,42,58,78,104,138,180,192],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]),new ht([0,6,12,18,24,30,36,44,54,66,80,96,116,140,168,200,238,284,336,396,464,522,576],[0,4,8,12,18,26,36,48,62,80,104,134,174,192],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]),new ht([0,6,12,18,24,30,36,44,54,66,80,96,116,140,168,200,238,284,336,396,464,522,576],[0,4,8,12,18,26,36,48,62,80,104,134,174,192],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]),new ht([0,12,24,36,48,60,72,88,108,132,160,192,232,280,336,400,476,566,568,570,572,574,576],[0,8,16,24,36,52,72,96,124,160,162,164,166,192],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0])];var h=dt(a+n+1),_=dt(a),u=dt(r),c=dt(r);function f(e,t){var s=i.ATHformula(t,e);return s-=o,s=Math.pow(10,s/10+e.ATHlower)}function d(e){this.s=e}this.adj43=c,this.iteration_init=function(t){var i,s=t.internal_flags,o=s.l3_side;if(0==s.iteration_init_init){for(s.iteration_init_init=1,o.main_data_begin=0,function(e){for(var t=e.internal_flags.ATH.l,i=e.internal_flags.ATH.psfb21,s=e.internal_flags.ATH.s,r=e.internal_flags.ATH.psfb12,a=e.internal_flags,n=e.out_samplerate,o=0;o<bt.SBMAX_l;o++){var l=a.scalefac_band.l[o],h=a.scalefac_band.l[o+1];t[o]=ct.MAX_VALUE;for(var _=l;_<h;_++){var u=f(e,_*n/1152);t[o]=Math.min(t[o],u)}}for(o=0;o<bt.PSFB21;o++)for(l=a.scalefac_band.psfb21[o],h=a.scalefac_band.psfb21[o+1],i[o]=ct.MAX_VALUE,_=l;_<h;_++)u=f(e,_*n/1152),i[o]=Math.min(i[o],u);for(o=0;o<bt.SBMAX_s;o++){for(l=a.scalefac_band.s[o],h=a.scalefac_band.s[o+1],s[o]=ct.MAX_VALUE,_=l;_<h;_++)u=f(e,_*n/384),s[o]=Math.min(s[o],u);s[o]*=a.scalefac_band.s[o+1]-a.scalefac_band.s[o]}for(o=0;o<bt.PSFB12;o++){for(l=a.scalefac_band.psfb12[o],h=a.scalefac_band.psfb12[o+1],r[o]=ct.MAX_VALUE,_=l;_<h;_++)u=f(e,_*n/384),r[o]=Math.min(r[o],u);r[o]*=a.scalefac_band.s[13]-a.scalefac_band.s[12]}if(e.noATH){for(o=0;o<bt.SBMAX_l;o++)t[o]=1e-20;for(o=0;o<bt.PSFB21;o++)i[o]=1e-20;for(o=0;o<bt.SBMAX_s;o++)s[o]=1e-20;for(o=0;o<bt.PSFB12;o++)r[o]=1e-20}a.ATH.floor=10*Math.log10(f(e,-1))}(t),u[0]=0,i=1;i<r;i++)u[i]=Math.pow(i,4/3);for(i=0;i<r-1;i++)c[i]=i+1-Math.pow(.5*(u[i]+u[i+1]),.75);for(c[i]=.5,i=0;i<a;i++)_[i]=Math.pow(2,-.1875*(i-210));for(i=0;i<=a+n;i++)h[i]=Math.pow(2,.25*(i-210-n));var l,d,p,m;for(e.huffman_init(s),(i=t.exp_nspsytune>>2&63)>=32&&(i-=64),l=Math.pow(10,i/4/10),(i=t.exp_nspsytune>>8&63)>=32&&(i-=64),d=Math.pow(10,i/4/10),(i=t.exp_nspsytune>>14&63)>=32&&(i-=64),p=Math.pow(10,i/4/10),(i=t.exp_nspsytune>>20&63)>=32&&(i-=64),m=p*Math.pow(10,i/4/10),i=0;i<bt.SBMAX_l;i++){b=i<=6?l:i<=13?d:i<=20?p:m,s.nsPsy.longfact[i]=b}for(i=0;i<bt.SBMAX_s;i++){var b;b=i<=5?l:i<=10?d:i<=11?p:m,s.nsPsy.shortfact[i]=b}}},this.on_pe=function(e,i,s,r,a,n){var o,l,h=e.internal_flags,_=0,u=pt(2),c=new vt(_),f=t.ResvMaxBits(e,r,c,n),d=(_=c.bits)+f;for(d>gt.MAX_BITS_PER_GRANULE&&(d=gt.MAX_BITS_PER_GRANULE),o=0,l=0;l<h.channels_out;++l)s[l]=Math.min(gt.MAX_BITS_PER_CHANNEL,_/h.channels_out),u[l]=0|s[l]*i[a][l]/700-s[l],u[l]>3*r/4&&(u[l]=3*r/4),u[l]<0&&(u[l]=0),u[l]+s[l]>gt.MAX_BITS_PER_CHANNEL&&(u[l]=Math.max(0,gt.MAX_BITS_PER_CHANNEL-s[l])),o+=u[l];if(o>f)for(l=0;l<h.channels_out;++l)u[l]=f*u[l]/o;for(l=0;l<h.channels_out;++l)s[l]+=u[l],f-=u[l];for(o=0,l=0;l<h.channels_out;++l)o+=s[l];if(o>gt.MAX_BITS_PER_GRANULE){var p=0;for(l=0;l<h.channels_out;++l)s[l]*=gt.MAX_BITS_PER_GRANULE,s[l]/=o,p+=s[l];mt(p<=gt.MAX_BITS_PER_GRANULE)}return d},this.reduce_side=function(e,t,i,s){mt(s<=gt.MAX_BITS_PER_GRANULE),mt(e[0]+e[1]<=gt.MAX_BITS_PER_GRANULE);var r=.33*(.5-t)/.5;r<0&&(r=0),r>.5&&(r=.5);var a=0|.5*r*(e[0]+e[1]);a>gt.MAX_BITS_PER_CHANNEL-e[0]&&(a=gt.MAX_BITS_PER_CHANNEL-e[0]),a<0&&(a=0),e[1]>=125&&(e[1]-a>125?(e[0]<i&&(e[0]+=a),e[1]-=a):(e[0]+=e[1]-125,e[1]=125)),(a=e[0]+e[1])>s&&(e[0]=s*e[0]/a,e[1]=s*e[1]/a),mt(e[0]<=gt.MAX_BITS_PER_CHANNEL),mt(e[1]<=gt.MAX_BITS_PER_CHANNEL),mt(e[0]+e[1]<=gt.MAX_BITS_PER_GRANULE)},this.athAdjust=function(e,t,i){var s=90.30873362,r=ft.FAST_LOG10_X(t,10),a=e*e,n=0;return r-=i,a>1e-20&&(n=1+ft.FAST_LOG10_X(a,10/s)),n<0&&(n=0),r*=n,r+=i+s-94.82444863,Math.pow(10,.1*r)},this.calc_xmin=function(e,t,i,r){var a,n=0,o=e.internal_flags,l=0,h=0,_=o.ATH,u=i.xr,c=e.VBR==ut.vbr_mtrh?1:0,f=o.masking_lower;for(e.VBR!=ut.vbr_mtrh&&e.VBR!=ut.vbr_mt||(f=1),a=0;a<i.psy_lmax;a++){E=(S=e.VBR==ut.vbr_rh||e.VBR==ut.vbr_mtrh?athAdjust(_.adjust,_.l[a],_.floor):_.adjust*_.l[a])/(b=i.width[a]),R=s,T=b>>1,w=0;do{w+=M=u[l]*u[l],R+=M<E?M:E,w+=y=u[++l]*u[l],R+=y<E?y:E,l++}while(--T>0);if(w>S&&h++,a==bt.SBPSY_l)R<(B=S*o.nsPsy.longfact[a])&&(R=B);if(0!=c&&(S=R),!e.ATHonly)if((A=t.en.l[a])>0)B=w*t.thm.l[a]*f/A,0!=c&&(B*=o.nsPsy.longfact[a]),S<B&&(S=B);r[n++]=0!=c?S:S*o.nsPsy.longfact[a]}var d=575;if(i.block_type!=bt.SHORT_TYPE)for(var p=576;0!=p--&&BitStream.EQ(u[p],0);)d=p;i.max_nonzero_coeff=d;for(var m=i.sfb_smin;a<i.psymax;m++,a+=3){var b,v,g;for(g=e.VBR==ut.vbr_rh||e.VBR==ut.vbr_mtrh?athAdjust(_.adjust,_.s[m],_.floor):_.adjust*_.s[m],b=i.width[a],v=0;v<3;v++){var S,E,R,A,B,w=0,T=b>>1;E=g/b,R=s;do{var M,y;w+=M=u[l]*u[l],R+=M<E?M:E,w+=y=u[++l]*u[l],R+=y<E?y:E,l++}while(--T>0);if(w>g&&h++,m==bt.SBPSY_s)R<(B=g*o.nsPsy.shortfact[m])&&(R=B);if(S=0!=c?R:g,!e.ATHonly&&!e.ATHshort)if((A=t.en.s[m][v])>0)B=w*t.thm.s[m][v]*f/A,0!=c&&(B*=o.nsPsy.shortfact[m]),S<B&&(S=B);r[n++]=0!=c?S:S*o.nsPsy.shortfact[m]}e.useTemporal&&(r[n-3]>r[n-3+1]&&(r[n-3+1]+=(r[n-3]-r[n-3+1])*o.decay),r[n-3+1]>r[n-3+2]&&(r[n-3+2]+=(r[n-3+1]-r[n-3+2])*o.decay))}return h},this.calc_noise_core=function(e,t,i,s){var r=0,a=t.s,n=e.l3_enc;if(a>e.count1)for(;0!=i--;){l=e.xr[a],a++,r+=l*l,l=e.xr[a],a++,r+=l*l}else if(a>e.big_values){var o=dt(2);for(o[0]=0,o[1]=s;0!=i--;){l=Math.abs(e.xr[a])-o[n[a]],a++,r+=l*l,l=Math.abs(e.xr[a])-o[n[a]],a++,r+=l*l}}else for(;0!=i--;){var l;l=Math.abs(e.xr[a])-u[n[a]]*s,a++,r+=l*l,l=Math.abs(e.xr[a])-u[n[a]]*s,a++,r+=l*l}return t.s=a,r},this.calc_noise=function(e,t,i,s,r){var a,n,o,_=0,u=0,c=0,f=0,p=0,m=-20,b=0,v=e.scalefac,g=0;for(s.over_SSD=0,a=0;a<e.psymax;a++){var S,E=e.global_gain-(v[g++]+(0!=e.preflag?l[a]:0)<<e.scalefac_scale+1)-8*e.subblock_gain[e.window[a]],R=0;if(null!=r&&r.step[a]==E)R=r.noise[a],b+=e.width[a],i[_++]=R/t[u++],R=r.noise_log[a];else{var A,B=(mt(0<=(o=E)+St.Q_MAX2&&o<St.Q_MAX),h[o+St.Q_MAX2]);if(n=e.width[a]>>1,b+e.width[a]>e.max_nonzero_coeff)n=(A=e.max_nonzero_coeff-b+1)>0?A>>1:0;var w=new d(b);R=this.calc_noise_core(e,w,n,B),b=w.s,null!=r&&(r.step[a]=E,r.noise[a]=R),R=i[_++]=R/t[u++],R=ft.FAST_LOG10(Math.max(R,1e-20)),null!=r&&(r.noise_log[a]=R)}if(null!=r&&(r.global_gain=e.global_gain),p+=R,R>0)S=Math.max(0|10*R+.5,1),s.over_SSD+=S*S,c++,f+=R;m=Math.max(m,R)}return s.over_count=c,s.tot_noise=p,s.over_noise=f,s.max_noise=m,c},this.set_pinfo=function(e,t,i,s,r){var a,n,o,h,_,u=e.internal_flags,c=0==t.scalefac_scale?.5:1,f=t.scalefac,d=dt(L3Side.SFBMAX),p=dt(L3Side.SFBMAX),m=new CalcNoiseResult;calc_xmin(e,i,t,d),calc_noise(t,d,p,m,null);var b=0;for(n=t.sfb_lmax,t.block_type!=bt.SHORT_TYPE&&0==t.mixed_block_flag&&(n=22),a=0;a<n;a++){var v=u.scalefac_band.l[a],g=(S=u.scalefac_band.l[a+1])-v;for(h=0;b<S;b++)h+=t.xr[b]*t.xr[b];h/=g,_=1e15,u.pinfo.en[s][r][a]=_*h,u.pinfo.xfsf[s][r][a]=_*d[a]*p[a]/g,i.en.l[a]>0&&!e.ATHonly?h/=i.en.l[a]:h=0,u.pinfo.thr[s][r][a]=_*Math.max(h*i.thm.l[a],u.ATH.l[a]),u.pinfo.LAMEsfb[s][r][a]=0,0!=t.preflag&&a>=11&&(u.pinfo.LAMEsfb[s][r][a]=-c*l[a]),a<bt.SBPSY_l&&(mt(f[a]>=0),u.pinfo.LAMEsfb[s][r][a]-=c*f[a])}if(t.block_type==bt.SHORT_TYPE)for(n=a,a=t.sfb_smin;a<bt.SBMAX_s;a++){v=u.scalefac_band.s[a],g=(S=u.scalefac_band.s[a+1])-v;for(var S,E=0;E<3;E++){for(h=0,o=v;o<S;o++)h+=t.xr[b]*t.xr[b],b++;h=Math.max(h/g,1e-20),_=1e15,u.pinfo.en_s[s][r][3*a+E]=_*h,u.pinfo.xfsf_s[s][r][3*a+E]=_*d[n]*p[n]/g,i.en.s[a][E]>0?h/=i.en.s[a][E]:h=0,(e.ATHonly||e.ATHshort)&&(h=0),u.pinfo.thr_s[s][r][3*a+E]=_*Math.max(h*i.thm.s[a][E],u.ATH.s[a]),u.pinfo.LAMEsfb_s[s][r][3*a+E]=-2*t.subblock_gain[E],a<bt.SBPSY_s&&(u.pinfo.LAMEsfb_s[s][r][3*a+E]-=c*f[n]),n++}}u.pinfo.LAMEqss[s][r]=t.global_gain,u.pinfo.LAMEmainbits[s][r]=t.part2_3_length+t.part2_length,u.pinfo.LAMEsfbits[s][r]=t.part2_length,u.pinfo.over[s][r]=m.over_count,u.pinfo.max_noise[s][r]=10*m.max_noise,u.pinfo.over_noise[s][r]=10*m.over_noise,u.pinfo.tot_noise[s][r]=10*m.tot_noise,u.pinfo.over_SSD[s][r]=m.over_SSD}}St.Q_MAX=257,St.Q_MAX2=116,St.LARGE_BITS=1e5,St.IXMAX_VAL=8206;var Et=St;a(Et);var Rt=B,At=Rt.System;Rt.VbrMode,Rt.Float,Rt.ShortBlock,Rt.Util;var Bt=Rt.Arrays;Rt.new_array_n,Rt.new_byte,Rt.new_double,Rt.new_float,Rt.new_float_n;var wt=Rt.new_int;Rt.new_int_n;var Tt=Rt.assert,Mt=T(),yt=lt,kt=se,Pt=Et;var Nt=function e(){var t=null;function i(e){this.bits=0|e}this.qupvt=null,this.setModules=function(e){this.qupvt=e,t=e};var s=[[0,0],[0,0],[0,0],[0,0],[0,0],[0,1],[1,1],[1,1],[1,2],[2,2],[2,3],[2,3],[3,4],[3,4],[3,4],[4,5],[4,5],[4,6],[5,6],[5,6],[5,7],[6,7],[6,7]];function r(e,t,i,s,r,a){var n=.5946/t;for(Tt(e>0),e>>=1;0!=e--;)r[a++]=n>i[s++]?0:1,r[a++]=n>i[s++]?0:1}function a(e,i,s,r,a,n){Tt(e>0);var o=(e>>=1)%2;for(e>>=1;0!=e--;){var l,h,_,u,c,f,d,p;l=s[r++]*i,h=s[r++]*i,c=0|l,_=s[r++]*i,f=0|h,u=s[r++]*i,d=0|_,l+=t.adj43[c],p=0|u,h+=t.adj43[f],a[n++]=0|l,_+=t.adj43[d],a[n++]=0|h,u+=t.adj43[p],a[n++]=0|_,a[n++]=0|u}0!=o&&(c=0|(l=s[r++]*i),f=0|(h=s[r++]*i),l+=t.adj43[c],h+=t.adj43[f],a[n++]=0|l,a[n++]=0|h)}var n=[1,2,5,7,7,10,10,13,13,13,13,13,13,13,13];function o(e,t,i,s){var r=function(e,t,i){var s=0,r=0;do{var a=e[t++],n=e[t++];s<a&&(s=a),r<n&&(r=n)}while(t<i);return s<r&&(s=r),s}(e,t,i);switch(r){case 0:return r;case 1:return function(e,t,i,s){var r=0,a=yt.ht[1].hlen;do{var n=2*e[t+0]+e[t+1];t+=2,r+=a[n]}while(t<i);return s.bits+=r,1}(e,t,i,s);case 2:case 3:return function(e,t,i,s,r){var a,n,o=0,l=yt.ht[s].xlen;n=2==s?yt.table23:yt.table56;do{var h=e[t+0]*l+e[t+1];t+=2,o+=n[h]}while(t<i);return a=65535&o,(o>>=16)>a&&(o=a,s++),r.bits+=o,s}(e,t,i,n[r-1],s);case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:return function(e,t,i,s,r){var a=0,n=0,o=0,l=yt.ht[s].xlen,h=yt.ht[s].hlen,_=yt.ht[s+1].hlen,u=yt.ht[s+2].hlen;do{var c=e[t+0]*l+e[t+1];t+=2,a+=h[c],n+=_[c],o+=u[c]}while(t<i);var f=s;return a>n&&(a=n,f++),a>o&&(a=o,f=s+2),r.bits+=a,f}(e,t,i,n[r-1],s);default:if(r>Pt.IXMAX_VAL)return s.bits=Pt.LARGE_BITS,-1;var a,o;for(r-=15,a=24;a<32&&!(yt.ht[a].linmax>=r);a++);for(o=a-8;o<24&&!(yt.ht[o].linmax>=r);o++);return function(e,t,i,s,r,a){var n,o=65536*yt.ht[s].xlen+yt.ht[r].xlen,l=0;do{var h=e[t++],_=e[t++];0!=h&&(h>14&&(h=15,l+=o),h*=16),0!=_&&(_>14&&(_=15,l+=o),h+=_),l+=yt.largetbl[h]}while(t<i);return n=65535&l,(l>>=16)>n&&(l=n,s=r),a.bits+=l,s}(e,t,i,o,a,s)}}function l(e,t,s,r,a,n,l,h){for(var _=t.big_values,u=2;u<Mt.SBMAX_l+1;u++){var c=e.scalefac_band.l[u];if(c>=_)break;var f=a[u-2]+t.count1bits;if(s.part2_3_length<=f)break;var d=new i(f),p=o(r,c,_,d);f=d.bits,s.part2_3_length<=f||(s.assign(t),s.part2_3_length=f,s.region0_count=n[u-2],s.region1_count=u-2-n[u-2],s.table_select[0]=l[u-2],s.table_select[1]=h[u-2],s.table_select[2]=p)}}this.noquant_count_bits=function(e,t,s){var r=t.l3_enc,a=Math.min(576,t.max_nonzero_coeff+2>>1<<1);for(null!=s&&(s.sfb_count1=0);a>1&&!(r[a-1]|r[a-2]);a-=2);t.count1=a;for(var n=0,l=0;a>3;a-=4){var h;if((2147483647&(r[a-1]|r[a-2]|r[a-3]|r[a-4]))>1)break;h=2*(2*(2*r[a-4]+r[a-3])+r[a-2])+r[a-1],n+=yt.t32l[h],l+=yt.t33l[h]}var _=n;if(t.count1table_select=0,n>l&&(_=l,t.count1table_select=1),t.count1bits=_,t.big_values=a,0==a)return _;if(t.block_type==Mt.SHORT_TYPE)(n=3*e.scalefac_band.s[3])>t.big_values&&(n=t.big_values),l=t.big_values;else if(t.block_type==Mt.NORM_TYPE){if(Tt(a<=576),n=t.region0_count=e.bv_scf[a-2],l=t.region1_count=e.bv_scf[a-1],Tt(n+l+2<Mt.SBPSY_l),l=e.scalefac_band.l[n+l+2],n=e.scalefac_band.l[n+1],l<a){var u=new i(_);t.table_select[2]=o(r,l,a,u),_=u.bits}}else t.region0_count=7,t.region1_count=Mt.SBMAX_l-1-7-1,(n=e.scalefac_band.l[8])>(l=a)&&(n=l);if(n=Math.min(n,a),l=Math.min(l,a),Tt(n>=0),Tt(l>=0),0<n){u=new i(_);t.table_select[0]=o(r,0,n,u),_=u.bits}if(n<l){u=new i(_);t.table_select[1]=o(r,n,l,u),_=u.bits}if(2==e.use_best_huffman&&(t.part2_3_length=_,best_huffman_divide(e,t),_=t.part2_3_length),null!=s&&t.block_type==Mt.NORM_TYPE){for(var c=0;e.scalefac_band.l[c]<t.big_values;)c++;s.sfb_count1=c}return _},this.count_bits=function(e,i,s,n){var o=s.l3_enc,l=Pt.IXMAX_VAL/t.IPOW20(s.global_gain);if(s.xrpow_max>l)return Pt.LARGE_BITS;if(function(e,i,s,n,o){var l,h,_,u=0,c=0,f=0,d=0,p=i,m=0,b=p,v=0,g=e,S=0;for(_=null!=o&&n.global_gain==o.global_gain,h=n.block_type==Mt.SHORT_TYPE?38:21,l=0;l<=h;l++){var E=-1;if((_||n.block_type==Mt.NORM_TYPE)&&(E=n.global_gain-(n.scalefac[l]+(0!=n.preflag?t.pretab[l]:0)<<n.scalefac_scale+1)-8*n.subblock_gain[n.window[l]]),Tt(n.width[l]>=0),_&&o.step[l]==E)0!=c&&(a(c,s,g,S,b,v),c=0),0!=f&&(r(f,s,g,S,b,v),f=0);else{var R,A=n.width[l];if(u+n.width[l]>n.max_nonzero_coeff&&(R=n.max_nonzero_coeff-u+1,Bt.fill(i,n.max_nonzero_coeff,576,0),(A=R)<0&&(A=0),l=h+1),0==c&&0==f&&(b=p,v=m,g=e,S=d),null!=o&&o.sfb_count1>0&&l>=o.sfb_count1&&o.step[l]>0&&E>=o.step[l]?(0!=c&&(a(c,s,g,S,b,v),c=0,b=p,v=m,g=e,S=d),f+=A):(0!=f&&(r(f,s,g,S,b,v),f=0,b=p,v=m,g=e,S=d),c+=A),A<=0){0!=f&&(r(f,s,g,S,b,v),f=0),0!=c&&(a(c,s,g,S,b,v),c=0);break}}l<=h&&(m+=n.width[l],d+=n.width[l],u+=n.width[l])}0!=c&&(a(c,s,g,S,b,v),c=0),0!=f&&(r(f,s,g,S,b,v),f=0)}(i,o,t.IPOW20(s.global_gain),s,n),2&e.substep_shaping)for(var h=0,_=s.global_gain+s.scalefac_scale,u=.634521682242439/t.IPOW20(_),c=0;c<s.sfbmax;c++){var f,d=s.width[c];if(Tt(d>=0),0==e.pseudohalf[c])h+=d;else for(f=h,h+=d;f<h;++f)o[f]=i[f]>=u?o[f]:0}return this.noquant_count_bits(e,s,n)},this.best_huffman_divide=function(e,t){var s=new kt,r=t.l3_enc,a=wt(23),n=wt(23),h=wt(23),_=wt(23);if(t.block_type!=Mt.SHORT_TYPE||1!=e.mode_gr){s.assign(t),t.block_type==Mt.NORM_TYPE&&(!function(e,t,s,r,a,n,l){for(var h=t.big_values,_=0;_<=22;_++)r[_]=Pt.LARGE_BITS;for(_=0;_<16;_++){var u=e.scalefac_band.l[_+1];if(u>=h)break;var c=0,f=new i(c),d=o(s,0,u,f);c=f.bits;for(var p=0;p<8;p++){var m=e.scalefac_band.l[_+p+2];if(m>=h)break;var b=c,v=o(s,u,m,f=new i(b));b=f.bits,r[_+p]>b&&(r[_+p]=b,a[_+p]=_,n[_+p]=d,l[_+p]=v)}}}(e,t,r,a,n,h,_),l(e,s,t,r,a,n,h,_));var u=s.big_values;if(!(0==u||(r[u-2]|r[u-1])>1||(u=t.count1+2)>576)){s.assign(t),s.count1=u;var c=0,f=0;for(Tt(u<=576);u>s.big_values;u-=4){var d=2*(2*(2*r[u-4]+r[u-3])+r[u-2])+r[u-1];c+=yt.t32l[d],f+=yt.t33l[d]}if(s.big_values=u,s.count1table_select=0,c>f&&(c=f,s.count1table_select=1),s.count1bits=c,s.block_type==Mt.NORM_TYPE)l(e,s,t,r,a,n,h,_);else{if(s.part2_3_length=c,(c=e.scalefac_band.l[8])>u&&(c=u),c>0){var p=new i(s.part2_3_length);s.table_select[0]=o(r,0,c,p),s.part2_3_length=p.bits}if(u>c){p=new i(s.part2_3_length);s.table_select[1]=o(r,c,u,p),s.part2_3_length=p.bits}t.part2_3_length>s.part2_3_length&&t.assign(s)}}}};var h=[1,1,1,1,8,2,2,2,4,4,4,8,8,8,16,16],_=[1,2,4,8,1,2,4,8,2,4,8,2,4,8,4,8],u=[0,0,0,0,3,1,1,1,2,2,2,3,3,3,4,4],c=[0,1,2,3,0,1,2,3,1,2,3,1,2,3,2,3];e.slen1_tab=u,e.slen2_tab=c,this.best_scalefac_store=function(e,i,s,r){var a,n,o,l,f=r.tt[i][s],d=0;for(o=0,a=0;a<f.sfbmax;a++){var p=f.width[a];for(Tt(p>=0),o+=p,l=-p;l<0&&0==f.l3_enc[l+o];l++);0==l&&(f.scalefac[a]=d=-2)}if(0==f.scalefac_scale&&0==f.preflag){var m=0;for(a=0;a<f.sfbmax;a++)f.scalefac[a]>0&&(m|=f.scalefac[a]);if(!(1&m)&&0!=m){for(a=0;a<f.sfbmax;a++)f.scalefac[a]>0&&(f.scalefac[a]>>=1);f.scalefac_scale=d=1}}if(0==f.preflag&&f.block_type!=Mt.SHORT_TYPE&&2==e.mode_gr){for(a=11;a<Mt.SBPSY_l&&!(f.scalefac[a]<t.pretab[a]&&-2!=f.scalefac[a]);a++);if(a==Mt.SBPSY_l){for(a=11;a<Mt.SBPSY_l;a++)f.scalefac[a]>0&&(f.scalefac[a]-=t.pretab[a]);f.preflag=d=1}}for(n=0;n<4;n++)r.scfsi[s][n]=0;for(2==e.mode_gr&&1==i&&r.tt[0][s].block_type!=Mt.SHORT_TYPE&&r.tt[1][s].block_type!=Mt.SHORT_TYPE&&(!function(e,t){for(var i,s=t.tt[1][e],r=t.tt[0][e],a=0;a<yt.scfsi_band.length-1;a++){for(i=yt.scfsi_band[a];i<yt.scfsi_band[a+1]&&!(r.scalefac[i]!=s.scalefac[i]&&s.scalefac[i]>=0);i++);if(i==yt.scfsi_band[a+1]){for(i=yt.scfsi_band[a];i<yt.scfsi_band[a+1];i++)s.scalefac[i]=-1;t.scfsi[e][a]=1}}var n=0,o=0;for(i=0;i<11;i++)-1!=s.scalefac[i]&&(o++,n<s.scalefac[i]&&(n=s.scalefac[i]));for(var l=0,f=0;i<Mt.SBPSY_l;i++)-1!=s.scalefac[i]&&(f++,l<s.scalefac[i]&&(l=s.scalefac[i]));for(a=0;a<16;a++)if(n<h[a]&&l<_[a]){var d=u[a]*o+c[a]*f;s.part2_length>d&&(s.part2_length=d,s.scalefac_compress=a)}}(s,r),d=0),a=0;a<f.sfbmax;a++)-2==f.scalefac[a]&&(f.scalefac[a]=0);0!=d&&(2==e.mode_gr?this.scale_bitcount(f):this.scale_bitcount_lsf(e,f))};var f=[0,18,36,54,54,36,54,72,54,72,90,72,90,108,108,126],d=[0,18,36,54,51,35,53,71,52,70,88,69,87,105,104,122],p=[0,10,20,30,33,21,31,41,32,42,52,43,53,63,64,74];this.scale_bitcount=function(e){var i,s,r,a=0,n=0,o=e.scalefac;if(Tt(function(e,t){for(var i=0;i<t;++i)if(e[i]<0)return!1;return!0}(o,e.sfbmax)),e.block_type==Mt.SHORT_TYPE)r=f,0!=e.mixed_block_flag&&(r=d);else if(r=p,0==e.preflag){for(s=11;s<Mt.SBPSY_l&&!(o[s]<t.pretab[s]);s++);if(s==Mt.SBPSY_l)for(e.preflag=1,s=11;s<Mt.SBPSY_l;s++)o[s]-=t.pretab[s]}for(s=0;s<e.sfbdivide;s++)a<o[s]&&(a=o[s]);for(;s<e.sfbmax;s++)n<o[s]&&(n=o[s]);for(e.part2_length=Pt.LARGE_BITS,i=0;i<16;i++)a<h[i]&&n<_[i]&&e.part2_length>r[i]&&(e.part2_length=r[i],e.scalefac_compress=i);return e.part2_length==Pt.LARGE_BITS};var m=[[15,15,7,7],[15,15,7,0],[7,3,0,0],[15,31,31,0],[7,7,7,0],[3,3,0,0]];this.scale_bitcount_lsf=function(e,i){var s,r,a,n,o,l,h,_,u=wt(4),c=i.scalefac;for(s=0!=i.preflag?2:0,h=0;h<4;h++)u[h]=0;if(i.block_type==Mt.SHORT_TYPE){r=1;var f=t.nr_of_sfb_block[s][r];for(_=0,a=0;a<4;a++)for(n=f[a]/3,h=0;h<n;h++,_++)for(o=0;o<3;o++)c[3*_+o]>u[a]&&(u[a]=c[3*_+o])}else{r=0;f=t.nr_of_sfb_block[s][r];for(_=0,a=0;a<4;a++)for(n=f[a],h=0;h<n;h++,_++)c[_]>u[a]&&(u[a]=c[_])}for(l=!1,a=0;a<4;a++)u[a]>m[s][a]&&(l=!0);if(!l){var d,p,v,g;for(i.sfb_partition_table=t.nr_of_sfb_block[s][r],a=0;a<4;a++)i.slen[a]=b[u[a]];switch(d=i.slen[0],p=i.slen[1],v=i.slen[2],g=i.slen[3],s){case 0:i.scalefac_compress=(5*d+p<<4)+(v<<2)+g;break;case 1:i.scalefac_compress=400+(5*d+p<<2)+v;break;case 2:i.scalefac_compress=500+3*d+p;break;default:At.err.printf("intensity stereo not implemented yet\n")}}if(!l)for(Tt(null!=i.sfb_partition_table),i.part2_length=0,a=0;a<4;a++)i.part2_length+=i.slen[a]*i.sfb_partition_table[a];return l};var b=[0,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4];this.huffman_init=function(e){for(var t=2;t<=576;t+=2){for(var i,r=0;e.scalefac_band.l[++r]<t;);for(i=s[r][0];e.scalefac_band.l[i+1]>t;)i--;for(i<0&&(i=s[r][0]),e.bv_scf[t-2]=i,i=s[r][1];e.scalefac_band.l[i+e.bv_scf[t-2]+2]>t;)i--;i<0&&(i=s[r][1]),e.bv_scf[t-1]=i}}};a(Nt);var It=B,xt=It.System;It.VbrMode,It.Float,It.ShortBlock,It.Util;var Ct=It.Arrays;It.new_array_n;var Ot=It.new_byte;It.new_double,It.new_float;var Dt=It.new_float_n,Lt=It.new_int;It.new_int_n;var Ft=It.assert,Vt=Nt,Ht=lt,Gt=T(),Ut=Oe;function qt(){var e=this,t=32,i=null,s=null,r=null,a=null;this.setModules=function(e,t,n,o){i=e,s=t,r=n,a=o};var n=null,o=0,l=0,h=0;function _(e){xt.arraycopy(e.header[e.w_ptr].buf,0,n,l,e.sideinfo_len),l+=e.sideinfo_len,o+=8*e.sideinfo_len,e.w_ptr=e.w_ptr+1&Ut.MAX_HEADER_BUF-1}function u(e,i,s){for(Ft(s<t-2);s>0;){var r;0==h&&(h=8,l++,Ft(l<Lame.LAME_MAXMP3BUFFER),Ft(e.header[e.w_ptr].write_timing>=o),e.header[e.w_ptr].write_timing==o&&_(e),n[l]=0),r=Math.min(s,h),h-=r,Ft((s-=r)<t),Ft(h<t),n[l]|=i>>s<<h,o+=r}}function c(e,i,s){for(Ft(s<t-2);s>0;){var r;0==h&&(h=8,l++,Ft(l<Lame.LAME_MAXMP3BUFFER),n[l]=0),r=Math.min(s,h),h-=r,Ft((s-=r)<t),Ft(h<t),n[l]|=i>>s<<h,o+=r}}function f(e,t){var i,s=e.internal_flags;if(Ft(t>=0),t>=8&&(u(s,76,8),t-=8),t>=8&&(u(s,65,8),t-=8),t>=8&&(u(s,77,8),t-=8),t>=8&&(u(s,69,8),t-=8),t>=32){var a=r.getLameShortVersion();if(t>=32)for(i=0;i<a.length&&t>=8;++i)t-=8,u(s,a.charAt(i),8)}for(;t>=1;t-=1)u(s,s.ancillary_flag,1),s.ancillary_flag^=e.disable_reservoir?0:1;Ft(0==t)}function d(e,i,s){for(var r=e.header[e.h_ptr].ptr;s>0;){var a=Math.min(s,8-(7&r));Ft((s-=a)<t),e.header[e.h_ptr].buf[r>>3]|=i>>s<<8-(7&r)-a,r+=a}e.header[e.h_ptr].ptr=r}function p(e,t){e<<=8;for(var i=0;i<8;i++)65536&((t<<=1)^(e<<=1))&&(t^=32773);return t}function m(e,t){var i,s=Ht.ht[t.count1table_select+32],r=0,a=t.big_values,n=t.big_values;for(Ft(t.count1table_select<2),i=(t.count1-t.big_values)/4;i>0;--i){var o,l=0,h=0;0!=(o=t.l3_enc[a+0])&&(h+=8,t.xr[n+0]<0&&l++,Ft(o<=1)),0!=(o=t.l3_enc[a+1])&&(h+=4,l*=2,t.xr[n+1]<0&&l++,Ft(o<=1)),0!=(o=t.l3_enc[a+2])&&(h+=2,l*=2,t.xr[n+2]<0&&l++,Ft(o<=1)),0!=(o=t.l3_enc[a+3])&&(h++,l*=2,t.xr[n+3]<0&&l++,Ft(o<=1)),a+=4,n+=4,u(e,l+s.table[h],s.hlen[h]),r+=s.hlen[h]}return r}function b(e,i,s,r,a){var n=Ht.ht[i],o=0;if(Ft(i<32),0==i)return o;for(var l=s;l<r;l+=2){var h=0,_=0,c=n.xlen,f=n.xlen,d=0,p=a.l3_enc[l],m=a.l3_enc[l+1];if(0!=p&&(a.xr[l]<0&&d++,h--),i>15){if(p>14){var b=p-15;Ft(b<=n.linmax),d|=b<<1,_=c,p=15}if(m>14){var v=m-15;Ft(v<=n.linmax),d<<=c,d|=v,_+=c,m=15}f=16}0!=m&&(d<<=1,a.xr[l+1]<0&&d++,h--),Ft((p|m)<16),p=p*f+m,_-=h,h+=n.hlen[p],Ft(h<=t),Ft(_<=t),u(e,n.table[p],h),u(e,d,_),o+=h+_}return o}function v(e,t){var i=3*e.scalefac_band.s[3];i>t.big_values&&(i=t.big_values);var s=b(e,t.table_select[0],0,i,t);return s+=b(e,t.table_select[1],i,t.big_values,t)}function g(e,t){var i,s,r,a;i=t.big_values,Ft(0<=i&&i<=576);var n=t.region0_count+1;return Ft(0<=n),Ft(n<e.scalefac_band.l.length),r=e.scalefac_band.l[n],n+=t.region1_count+1,Ft(0<=n),Ft(n<e.scalefac_band.l.length),r>i&&(r=i),(a=e.scalefac_band.l[n])>i&&(a=i),s=b(e,t.table_select[0],0,r,t),s+=b(e,t.table_select[1],r,a,t),s+=b(e,t.table_select[2],a,i,t)}function S(){this.total=0}function E(t,i){var s,r,a,n,h,_=t.internal_flags;return h=_.w_ptr,-1==(n=_.h_ptr-1)&&(n=Ut.MAX_HEADER_BUF-1),s=_.header[n].write_timing-o,i.total=s,s>=0&&(r=1+n-h,n<h&&(r=1+n-h+Ut.MAX_HEADER_BUF),s-=8*r*_.sideinfo_len),s+=a=e.getframebits(t),i.total+=a,i.total%8!=0?i.total=1+i.total/8:i.total=i.total/8,i.total+=l+1,s<0&&xt.err.println("strange error flushing buffer ... \n"),s}this.getframebits=function(e){var t,i=e.internal_flags;return t=0!=i.bitrate_index?Ht.bitrate_table[e.version][i.bitrate_index]:e.brate,Ft(8<=t&&t<=640),8*(0|72e3*(e.version+1)*t/e.out_samplerate+i.padding)},this.CRC_writeheader=function(e,t){var i=65535;i=p(255&t[2],i),i=p(255&t[3],i);for(var s=6;s<e.sideinfo_len;s++)i=p(255&t[s],i);t[4]=byte(i>>8),t[5]=byte(255&i)},this.flush_bitstream=function(e){var t,s,r=e.internal_flags,a=r.h_ptr-1;if(-1==a&&(a=Ut.MAX_HEADER_BUF-1),t=r.l3_side,!((s=E(e,new S))<0)){if(f(e,s),Ft(r.header[a].write_timing+this.getframebits(e)==o),r.ResvSize=0,t.main_data_begin=0,r.findReplayGain){var n=i.GetTitleGain(r.rgdata);Ft(NEQ(n,GainAnalysis.GAIN_NOT_ENOUGH_SAMPLES)),r.RadioGain=0|Math.floor(10*n+.5)}r.findPeakSample&&(r.noclipGainChange=0|Math.ceil(20*Math.log10(r.PeakSample/32767)*10),r.noclipGainChange>0&&(EQ(e.scale,1)||EQ(e.scale,0))?r.noclipScale=Math.floor(32767/r.PeakSample*100)/100:r.noclipScale=-1)}},this.add_dummy_byte=function(e,t,i){for(var s,r=e.internal_flags;i-- >0;)for(c(0,t,8),s=0;s<Ut.MAX_HEADER_BUF;++s)r.header[s].write_timing+=8},this.format_bitstream=function(e){var t,i=e.internal_flags;t=i.l3_side;var s=this.getframebits(e);f(e,t.resvDrain_pre),function(e,t){var i,s,r,a=e.internal_flags;if(i=a.l3_side,a.header[a.h_ptr].ptr=0,Ct.fill(a.header[a.h_ptr].buf,0,a.sideinfo_len,0),e.out_samplerate<16e3?d(a,4094,12):d(a,4095,12),d(a,e.version,1),d(a,1,2),d(a,e.error_protection?0:1,1),d(a,a.bitrate_index,4),d(a,a.samplerate_index,2),d(a,a.padding,1),d(a,e.extension,1),d(a,e.mode.ordinal(),2),d(a,a.mode_ext,2),d(a,e.copyright,1),d(a,e.original,1),d(a,e.emphasis,2),e.error_protection&&d(a,0,16),1==e.version){for(Ft(i.main_data_begin>=0),d(a,i.main_data_begin,9),2==a.channels_out?d(a,i.private_bits,3):d(a,i.private_bits,5),r=0;r<a.channels_out;r++){var n;for(n=0;n<4;n++)d(a,i.scfsi[r][n],1)}for(s=0;s<2;s++)for(r=0;r<a.channels_out;r++)d(a,(o=i.tt[s][r]).part2_3_length+o.part2_length,12),d(a,o.big_values/2,9),d(a,o.global_gain,8),d(a,o.scalefac_compress,4),o.block_type!=Gt.NORM_TYPE?(d(a,1,1),d(a,o.block_type,2),d(a,o.mixed_block_flag,1),14==o.table_select[0]&&(o.table_select[0]=16),d(a,o.table_select[0],5),14==o.table_select[1]&&(o.table_select[1]=16),d(a,o.table_select[1],5),d(a,o.subblock_gain[0],3),d(a,o.subblock_gain[1],3),d(a,o.subblock_gain[2],3)):(d(a,0,1),14==o.table_select[0]&&(o.table_select[0]=16),d(a,o.table_select[0],5),14==o.table_select[1]&&(o.table_select[1]=16),d(a,o.table_select[1],5),14==o.table_select[2]&&(o.table_select[2]=16),d(a,o.table_select[2],5),Ft(0<=o.region0_count&&o.region0_count<16),Ft(0<=o.region1_count&&o.region1_count<8),d(a,o.region0_count,4),d(a,o.region1_count,3)),d(a,o.preflag,1),d(a,o.scalefac_scale,1),d(a,o.count1table_select,1)}else for(Ft(i.main_data_begin>=0),d(a,i.main_data_begin,8),d(a,i.private_bits,a.channels_out),s=0,r=0;r<a.channels_out;r++){var o;d(a,(o=i.tt[s][r]).part2_3_length+o.part2_length,12),d(a,o.big_values/2,9),d(a,o.global_gain,8),d(a,o.scalefac_compress,9),o.block_type!=Gt.NORM_TYPE?(d(a,1,1),d(a,o.block_type,2),d(a,o.mixed_block_flag,1),14==o.table_select[0]&&(o.table_select[0]=16),d(a,o.table_select[0],5),14==o.table_select[1]&&(o.table_select[1]=16),d(a,o.table_select[1],5),d(a,o.subblock_gain[0],3),d(a,o.subblock_gain[1],3),d(a,o.subblock_gain[2],3)):(d(a,0,1),14==o.table_select[0]&&(o.table_select[0]=16),d(a,o.table_select[0],5),14==o.table_select[1]&&(o.table_select[1]=16),d(a,o.table_select[1],5),14==o.table_select[2]&&(o.table_select[2]=16),d(a,o.table_select[2],5),Ft(0<=o.region0_count&&o.region0_count<16),Ft(0<=o.region1_count&&o.region1_count<8),d(a,o.region0_count,4),d(a,o.region1_count,3)),d(a,o.scalefac_scale,1),d(a,o.count1table_select,1)}e.error_protection&&CRC_writeheader(a,a.header[a.h_ptr].buf);var l=a.h_ptr;Ft(a.header[l].ptr==8*a.sideinfo_len),a.h_ptr=l+1&Ut.MAX_HEADER_BUF-1,a.header[a.h_ptr].write_timing=a.header[l].write_timing+t,a.h_ptr==a.w_ptr&&xt.err.println("Error: MAX_HEADER_BUF too small in bitstream.c \n")}(e,s);var r=8*i.sideinfo_len;if(r+=function(e){var t,i,s,r,a=0,n=e.internal_flags,o=n.l3_side;if(1==e.version)for(t=0;t<2;t++)for(i=0;i<n.channels_out;i++){var l=o.tt[t][i],h=Vt.slen1_tab[l.scalefac_compress],_=Vt.slen2_tab[l.scalefac_compress];for(r=0,s=0;s<l.sfbdivide;s++)-1!=l.scalefac[s]&&(u(n,l.scalefac[s],h),r+=h);for(;s<l.sfbmax;s++)-1!=l.scalefac[s]&&(u(n,l.scalefac[s],_),r+=_);Ft(r==l.part2_length),l.block_type==Gt.SHORT_TYPE?r+=v(n,l):r+=g(n,l),r+=m(n,l),Ft(r==l.part2_3_length+l.part2_length),a+=r}else for(t=0,i=0;i<n.channels_out;i++){l=o.tt[t][i];var c,f,d=0;if(Ft(null!=l.sfb_partition_table),r=0,s=0,f=0,l.block_type==Gt.SHORT_TYPE){for(;f<4;f++){var p=l.sfb_partition_table[f]/3,b=l.slen[f];for(c=0;c<p;c++,s++)u(n,Math.max(l.scalefac[3*s+0],0),b),u(n,Math.max(l.scalefac[3*s+1],0),b),u(n,Math.max(l.scalefac[3*s+2],0),b),d+=3*b}r+=v(n,l)}else{for(;f<4;f++)for(p=l.sfb_partition_table[f],b=l.slen[f],c=0;c<p;c++,s++)u(n,Math.max(l.scalefac[s],0),b),d+=b;r+=g(n,l)}r+=m(n,l),Ft(r==l.part2_3_length),Ft(d==l.part2_length),a+=d+r}return a}(e),f(e,t.resvDrain_post),r+=t.resvDrain_post,t.main_data_begin+=(s-r)/8,E(e,new S)!=i.ResvSize&&xt.err.println("Internal buffer inconsistency. flushbits <> ResvSize"),8*t.main_data_begin!=i.ResvSize&&(xt.err.printf("bit reservoir error: \nl3_side.main_data_begin: %d \nResvoir size:             %d \nresv drain (post)         %d \nresv drain (pre)          %d \nheader and sideinfo:      %d \ndata bits:                %d \ntotal bits:               %d (remainder: %d) \nbitsperframe:             %d \n",8*t.main_data_begin,i.ResvSize,t.resvDrain_post,t.resvDrain_pre,8*i.sideinfo_len,r-t.resvDrain_post-8*i.sideinfo_len,r,r%8,s),xt.err.println("This is a fatal error.  It has several possible causes:"),xt.err.println("90%%  LAME compiled with buggy version of gcc using advanced optimizations"),xt.err.println(" 9%%  Your system is overclocked"),xt.err.println(" 1%%  bug in LAME encoding library"),i.ResvSize=8*t.main_data_begin),Ft(o%8==0),o>1e9){var a;for(a=0;a<Ut.MAX_HEADER_BUF;++a)i.header[a].write_timing-=o;o=0}return 0},this.copy_buffer=function(e,t,r,o,_){var u=l+1;if(u<=0)return 0;if(0!=o&&u>o)return-1;if(xt.arraycopy(n,0,t,r,u),l=-1,h=0,0!=_){var c=Lt(1);if(c[0]=e.nMusicCRC,a.updateMusicCRC(c,t,r,u),e.nMusicCRC=c[0],u>0&&(e.VBR_seek_table.nBytesWritten+=u),e.decode_on_the_fly)for(var f,d=Dt([2,1152]),p=u,m=-1;0!=m;)if(m=s.hip_decode1_unclipped(e.hip,t,r,p,d[0],d[1]),p=0,-1==m&&(m=0),m>0){if(Ft(m<=1152),e.findPeakSample){for(f=0;f<m;f++)d[0][f]>e.PeakSample?e.PeakSample=d[0][f]:-d[0][f]>e.PeakSample&&(e.PeakSample=-d[0][f]);if(e.channels_out>1)for(f=0;f<m;f++)d[1][f]>e.PeakSample?e.PeakSample=d[1][f]:-d[1][f]>e.PeakSample&&(e.PeakSample=-d[1][f])}if(e.findReplayGain&&i.AnalyzeSamples(e.rgdata,d[0],0,d[1],0,m,e.channels_out)==GainAnalysis.GAIN_ANALYSIS_ERROR)return-6}}return u},this.init_bit_stream_w=function(e){n=Ot(Lame.LAME_MAXMP3BUFFER),e.h_ptr=e.w_ptr=0,e.header[e.h_ptr].write_timing=0,l=-1,h=0,o=0}}qt.EQ=function(e,t){return Math.abs(e)>Math.abs(t)?Math.abs(e-t)<=1e-6*Math.abs(e):Math.abs(e-t)<=1e-6*Math.abs(t)},qt.NEQ=function(e,t){return!qt.EQ(e,t)};var Wt=qt,Xt=a(Wt),Yt=B,Kt=Yt.System,jt=Yt.VbrMode;Yt.Float;var zt=Yt.ShortBlock;Yt.Util,Yt.Arrays,Yt.new_array_n,Yt.new_byte,Yt.new_double;var Zt=Yt.new_float;Yt.new_float_n,Yt.new_int;var Qt=Yt.new_int_n,Jt=Yt.new_short_n,$t=Yt.assert,ei=W,ti=z,ii=Oe,si=Ve,ri=ze,ai=at,ni=Wt,oi=lt,li=T();var hi=function e(){var t,i,s,r,a,n=this;e.V9=410,e.V8=420,e.V7=430,e.V6=440,e.V5=450,e.V4=460,e.V3=470,e.V2=480,e.V1=490,e.V0=500,e.R3MIX=1e3,e.STANDARD=1001,e.EXTREME=1002,e.INSANE=1003,e.STANDARD_FAST=1004,e.EXTREME_FAST=1005,e.MEDIUM=1006,e.MEDIUM_FAST=1007,e.LAME_MAXMP3BUFFER=147456;var o,l,h,_=new ei;function u(){this.mask_adjust=0,this.mask_adjust_short=0,this.bo_l_weight=Zt(li.SBMAX_l),this.bo_s_weight=Zt(li.SBMAX_s)}function c(){this.lowerlimit=0}function f(e,t){this.lowpass=t}this.enc=new li,this.setModules=function(e,n,u,c,f,d,p,m,b){t=e,i=n,s=u,r=c,a=f,o=d,l=m,h=b,this.enc.setModules(i,_,r,o)};var d=4294479419;function p(e){return e>1?0:e<=0?1:Math.cos(Math.PI/2*e)}function m(e,t){switch(e){case 44100:return t.version=1,0;case 48e3:return t.version=1,1;case 32e3:return t.version=1,2;case 22050:case 11025:return t.version=0,0;case 24e3:case 12e3:return t.version=0,1;case 16e3:case 8e3:return t.version=0,2;default:return t.version=0,-1}}function b(e,t,i){i<16e3&&(t=2);for(var s=oi.bitrate_table[t][1],r=2;r<=14;r++)oi.bitrate_table[t][r]>0&&Math.abs(oi.bitrate_table[t][r]-e)<Math.abs(s-e)&&(s=oi.bitrate_table[t][r]);return s}function v(e,t,i){i<16e3&&(t=2);for(var s=0;s<=14;s++)if(oi.bitrate_table[t][s]>0&&oi.bitrate_table[t][s]==e)return s;return-1}function g(e,t){var i=[new f(8,2e3),new f(16,3700),new f(24,3900),new f(32,5500),new f(40,7e3),new f(48,7500),new f(56,1e4),new f(64,11e3),new f(80,13500),new f(96,15100),new f(112,15600),new f(128,17e3),new f(160,17500),new f(192,18600),new f(224,19400),new f(256,19700),new f(320,20500)],s=n.nearestBitrateFullIndex(t);e.lowerlimit=i[s].lowpass}function S(e){var t=li.BLKSIZE+e.framesize-li.FFTOFFSET;return t=Math.max(t,512+e.framesize-32),$t(ii.MFSIZE>=t),t}function E(e,t,i,s,r,a){var o=n.enc.lame_encode_mp3_frame(e,t,i,s,r,a);return e.frameNum++,o}function R(){this.n_in=0,this.n_out=0}function A(){this.num_used=0}function B(e,t){return 0!=t?B(t,e%t):e}function w(e,t,i){var s=Math.PI*t;(e/=i)<0&&(e=0),e>1&&(e=1);var r=e-.5,a=.42-.5*Math.cos(2*e*Math.PI)+.08*Math.cos(4*e*Math.PI);return Math.abs(r)<1e-9?s/Math.PI:a*Math.sin(i*s*r)/(Math.PI*i*r)}function T(e,t,i,s,r,a,n,o,l){var h,_,u=e.internal_flags,c=0,f=e.out_samplerate/B(e.out_samplerate,e.in_samplerate);f>ii.BPC&&(f=ii.BPC);var d=Math.abs(u.resample_ratio-Math.floor(.5+u.resample_ratio))<1e-4?1:0,p=1/u.resample_ratio;p>1&&(p=1);var m=31;0==m%2&&--m;var b=(m+=d)+1;if(0==u.fill_buffer_resample_init){for(u.inbuf_old[0]=Zt(b),u.inbuf_old[1]=Zt(b),h=0;h<=2*f;++h)u.blackfilt[h]=Zt(b);for(u.itime[0]=0,u.itime[1]=0,c=0;c<=2*f;c++){var v=0,g=(c-f)/(2*f);for(h=0;h<=m;h++)v+=u.blackfilt[c][h]=w(h-g,p,m);for(h=0;h<=m;h++)u.blackfilt[c][h]/=v}u.fill_buffer_resample_init=1}var S=u.inbuf_old[l];for(_=0;_<s;_++){var E,R;if(E=_*u.resample_ratio,m+(c=0|Math.floor(E-u.itime[l]))-m/2>=n)break;g=E-u.itime[l]-(c+m%2*.5);$t(Math.abs(g)<=.501),R=0|Math.floor(2*g*f+f+.5);var A=0;for(h=0;h<=m;++h){var T=0|h+c-m/2;$t(T<n),$t(T+b>=0),A+=(T<0?S[b+T]:r[a+T])*u.blackfilt[R][h]}t[i+_]=A}if(o.num_used=Math.min(n,m+c-m/2),u.itime[l]+=o.num_used-_*u.resample_ratio,o.num_used>=b)for(h=0;h<b;h++)S[h]=r[a+o.num_used+h-b];else{var M=b-o.num_used;for(h=0;h<M;++h)S[h]=S[h+o.num_used];for(c=0;h<b;++h,++c)S[h]=r[a+c];$t(c==o.num_used)}return _}function M(e,t,i,s,r,a){var n=e.internal_flags;if(n.resample_ratio<.9999||n.resample_ratio>1.0001)for(var o=0;o<n.channels_out;o++){var l=new A;a.n_out=T(e,t[o],n.mf_size,e.framesize,i[o],s,r,l,o),a.n_in=l.num_used}else{a.n_out=Math.min(e.framesize,r),a.n_in=a.n_out;for(var h=0;h<a.n_out;++h)t[0][n.mf_size+h]=i[0][s+h],2==n.channels_out&&(t[1][n.mf_size+h]=i[1][s+h])}}this.lame_init=function(){var e=new ti;return function(e){var t;e.class_id=d,t=e.internal_flags=new ii,e.mode=MPEGMode.NOT_SET,e.original=1,e.in_samplerate=44100,e.num_channels=2,e.num_samples=-1,e.bWriteVbrTag=!0,e.quality=-1,e.short_blocks=null,t.subblock_gain=-1,e.lowpassfreq=0,e.highpassfreq=0,e.lowpasswidth=-1,e.highpasswidth=-1,e.VBR=jt.vbr_off,e.VBR_q=4,e.ATHcurve=-1,e.VBR_mean_bitrate_kbps=128,e.VBR_min_bitrate_kbps=0,e.VBR_max_bitrate_kbps=0,e.VBR_hard_min=0,t.VBR_min_bitrate=1,t.VBR_max_bitrate=13,e.quant_comp=-1,e.quant_comp_short=-1,e.msfix=-1,t.resample_ratio=1,t.OldValue[0]=180,t.OldValue[1]=180,t.CurrentStep[0]=4,t.CurrentStep[1]=4,t.masking_lower=1,t.nsPsy.attackthre=-1,t.nsPsy.attackthre_s=-1,e.scale=-1,e.athaa_type=-1,e.ATHtype=-1,e.athaa_loudapprox=-1,e.athaa_sensitivity=0,e.useTemporal=null,e.interChRatio=-1,t.mf_samples_to_encode=li.ENCDELAY+li.POSTDELAY,e.encoder_padding=0,t.mf_size=li.ENCDELAY-li.MDCTDELAY,e.findReplayGain=!1,e.decode_on_the_fly=!1,t.decode_on_the_fly=!1,t.findReplayGain=!1,t.findPeakSample=!1,t.RadioGain=0,t.AudiophileGain=0,t.noclipGainChange=0,t.noclipScale=-1,e.preset=0,e.write_id3tag_automatic=!0}(e),e.lame_allocated_gfp=1,e},this.nearestBitrateFullIndex=function(e){var t=[8,16,24,32,40,48,56,64,80,96,112,128,160,192,224,256,320],i=0,s=0,r=0,a=0;a=t[16],r=16,s=t[16],i=16;for(var n=0;n<16;n++)if(Math.max(e,t[n+1])!=e){a=t[n+1],r=n+1,s=t[n],i=n;break}return a-e>e-s?i:r},this.lame_init_params=function(e){var n,f,S,E=e.internal_flags;if(E.Class_ID=0,null==E.ATH&&(E.ATH=new si),null==E.PSY&&(E.PSY=new u),null==E.rgdata&&(E.rgdata=new ri),E.channels_in=e.num_channels,1==E.channels_in&&(e.mode=MPEGMode.MONO),E.channels_out=e.mode==MPEGMode.MONO?1:2,E.mode_ext=li.MPG_MD_MS_LR,e.mode==MPEGMode.MONO&&(e.force_ms=!1),e.VBR==jt.vbr_off&&128!=e.VBR_mean_bitrate_kbps&&0==e.brate&&(e.brate=e.VBR_mean_bitrate_kbps),e.VBR==jt.vbr_off||e.VBR==jt.vbr_mtrh||e.VBR==jt.vbr_mt||(e.free_format=!1),e.VBR==jt.vbr_off&&0==e.brate&&ni.EQ(e.compression_ratio,0)&&(e.compression_ratio=11.025),e.VBR==jt.vbr_off&&e.compression_ratio>0&&(0==e.out_samplerate&&(e.out_samplerate=map2MP3Frequency(int(.97*e.in_samplerate))),e.brate=0|16*e.out_samplerate*E.channels_out/(1e3*e.compression_ratio),E.samplerate_index=m(e.out_samplerate,e),e.free_format||(e.brate=b(e.brate,e.version,e.out_samplerate))),0!=e.out_samplerate&&(e.out_samplerate<16e3?(e.VBR_mean_bitrate_kbps=Math.max(e.VBR_mean_bitrate_kbps,8),e.VBR_mean_bitrate_kbps=Math.min(e.VBR_mean_bitrate_kbps,64)):e.out_samplerate<32e3?(e.VBR_mean_bitrate_kbps=Math.max(e.VBR_mean_bitrate_kbps,8),e.VBR_mean_bitrate_kbps=Math.min(e.VBR_mean_bitrate_kbps,160)):(e.VBR_mean_bitrate_kbps=Math.max(e.VBR_mean_bitrate_kbps,32),e.VBR_mean_bitrate_kbps=Math.min(e.VBR_mean_bitrate_kbps,320))),0==e.lowpassfreq){var R=16e3;switch(e.VBR){case jt.vbr_off:g(A=new c,e.brate),R=A.lowerlimit;break;case jt.vbr_abr:var A;g(A=new c,e.VBR_mean_bitrate_kbps),R=A.lowerlimit;break;case jt.vbr_rh:var B=[19500,19e3,18600,18e3,17500,16e3,15600,14900,12500,1e4,3950];if(0<=e.VBR_q&&e.VBR_q<=9){var w=B[e.VBR_q],T=B[e.VBR_q+1],M=e.VBR_q_frac;R=linear_int(w,T,M)}else R=19500;break;default:B=[19500,19e3,18500,18e3,17500,16500,15500,14500,12500,9500,3950];if(0<=e.VBR_q&&e.VBR_q<=9){w=B[e.VBR_q],T=B[e.VBR_q+1],M=e.VBR_q_frac;R=linear_int(w,T,M)}else R=19500}e.mode!=MPEGMode.MONO||e.VBR!=jt.vbr_off&&e.VBR!=jt.vbr_abr||(R*=1.5),e.lowpassfreq=0|R}if(0==e.out_samplerate&&(2*e.lowpassfreq>e.in_samplerate&&(e.lowpassfreq=e.in_samplerate/2),e.out_samplerate=(n=0|e.lowpassfreq,f=e.in_samplerate,S=44100,f>=48e3?S=48e3:f>=44100?S=44100:f>=32e3?S=32e3:f>=24e3?S=24e3:f>=22050?S=22050:f>=16e3?S=16e3:f>=12e3?S=12e3:f>=11025?S=11025:f>=8e3&&(S=8e3),-1==n?S:(n<=15960&&(S=44100),n<=15250&&(S=32e3),n<=11220&&(S=24e3),n<=9970&&(S=22050),n<=7230&&(S=16e3),n<=5420&&(S=12e3),n<=4510&&(S=11025),n<=3970&&(S=8e3),f<S?f>44100?48e3:f>32e3?44100:f>24e3?32e3:f>22050?24e3:f>16e3?22050:f>12e3?16e3:f>11025?12e3:f>8e3?11025:8e3:S))),e.lowpassfreq=Math.min(20500,e.lowpassfreq),e.lowpassfreq=Math.min(e.out_samplerate/2,e.lowpassfreq),e.VBR==jt.vbr_off&&(e.compression_ratio=16*e.out_samplerate*E.channels_out/(1e3*e.brate)),e.VBR==jt.vbr_abr&&(e.compression_ratio=16*e.out_samplerate*E.channels_out/(1e3*e.VBR_mean_bitrate_kbps)),e.bWriteVbrTag||(e.findReplayGain=!1,e.decode_on_the_fly=!1,E.findPeakSample=!1),E.findReplayGain=e.findReplayGain,E.decode_on_the_fly=e.decode_on_the_fly,E.decode_on_the_fly&&(E.findPeakSample=!0),E.findReplayGain&&t.InitGainAnalysis(E.rgdata,e.out_samplerate)==GainAnalysis.INIT_GAIN_ANALYSIS_ERROR)return e.internal_flags=null,-6;switch(E.decode_on_the_fly&&!e.decode_only&&(null!=E.hip&&h.hip_decode_exit(E.hip),E.hip=h.hip_decode_init()),E.mode_gr=e.out_samplerate<=24e3?1:2,e.framesize=576*E.mode_gr,e.encoder_delay=li.ENCDELAY,E.resample_ratio=e.in_samplerate/e.out_samplerate,e.VBR){case jt.vbr_mt:case jt.vbr_rh:case jt.vbr_mtrh:e.compression_ratio=[5.7,6.5,7.3,8.2,10,11.9,13,14,15,16.5][e.VBR_q];break;case jt.vbr_abr:e.compression_ratio=16*e.out_samplerate*E.channels_out/(1e3*e.VBR_mean_bitrate_kbps);break;default:e.compression_ratio=16*e.out_samplerate*E.channels_out/(1e3*e.brate)}if(e.mode==MPEGMode.NOT_SET&&(e.mode=MPEGMode.JOINT_STEREO),e.highpassfreq>0?(E.highpass1=2*e.highpassfreq,e.highpasswidth>=0?E.highpass2=2*(e.highpassfreq+e.highpasswidth):E.highpass2=2*e.highpassfreq,E.highpass1/=e.out_samplerate,E.highpass2/=e.out_samplerate):(E.highpass1=0,E.highpass2=0),e.lowpassfreq>0?(E.lowpass2=2*e.lowpassfreq,e.lowpasswidth>=0?(E.lowpass1=2*(e.lowpassfreq-e.lowpasswidth),E.lowpass1<0&&(E.lowpass1=0)):E.lowpass1=2*e.lowpassfreq,E.lowpass1/=e.out_samplerate,E.lowpass2/=e.out_samplerate):(E.lowpass1=0,E.lowpass2=0),function(e){var t=e.internal_flags,i=32,s=-1;if(t.lowpass1>0){for(var r=999,a=0;a<=31;a++)(h=a/31)>=t.lowpass2&&(i=Math.min(i,a)),t.lowpass1<h&&h<t.lowpass2&&(r=Math.min(r,a));t.lowpass1=999==r?(i-.75)/31:(r-.75)/31,t.lowpass2=i/31}if(t.highpass2>0&&t.highpass2<.75/31*.9&&(t.highpass1=0,t.highpass2=0,Kt.err.println("Warning: highpass filter disabled.  highpass frequency too small\n")),t.highpass2>0){var n=-1;for(a=0;a<=31;a++)(h=a/31)<=t.highpass1&&(s=Math.max(s,a)),t.highpass1<h&&h<t.highpass2&&(n=Math.max(n,a));t.highpass1=s/31,t.highpass2=-1==n?(s+.75)/31:(n+.75)/31}for(a=0;a<32;a++){var o,l,h=a/31;o=t.highpass2>t.highpass1?p((t.highpass2-h)/(t.highpass2-t.highpass1+1e-20)):1,l=t.lowpass2>t.lowpass1?p((h-t.lowpass1)/(t.lowpass2-t.lowpass1+1e-20)):1,t.amp_filter[a]=o*l}}(e),E.samplerate_index=m(e.out_samplerate,e),E.samplerate_index<0)return e.internal_flags=null,-1;if(e.VBR==jt.vbr_off){if(e.free_format)E.bitrate_index=0;else if(e.brate=b(e.brate,e.version,e.out_samplerate),E.bitrate_index=v(e.brate,e.version,e.out_samplerate),E.bitrate_index<=0)return e.internal_flags=null,-1}else E.bitrate_index=1;e.analysis&&(e.bWriteVbrTag=!1),null!=E.pinfo&&(e.bWriteVbrTag=!1),i.init_bit_stream_w(E);for(var y,k=E.samplerate_index+3*e.version+6*(e.out_samplerate<16e3?1:0),P=0;P<li.SBMAX_l+1;P++)E.scalefac_band.l[P]=r.sfBandIndex[k].l[P];for(P=0;P<li.PSFB21+1;P++){var N=(E.scalefac_band.l[22]-E.scalefac_band.l[21])/li.PSFB21,I=E.scalefac_band.l[21]+P*N;E.scalefac_band.psfb21[P]=I}E.scalefac_band.psfb21[li.PSFB21]=576;for(P=0;P<li.SBMAX_s+1;P++)E.scalefac_band.s[P]=r.sfBandIndex[k].s[P];for(P=0;P<li.PSFB12+1;P++){N=(E.scalefac_band.s[13]-E.scalefac_band.s[12])/li.PSFB12,I=E.scalefac_band.s[12]+P*N;E.scalefac_band.psfb12[P]=I}for(E.scalefac_band.psfb12[li.PSFB12]=192,1==e.version?E.sideinfo_len=1==E.channels_out?21:36:E.sideinfo_len=1==E.channels_out?13:21,e.error_protection&&(E.sideinfo_len+=2),function(e){var t=e.internal_flags;e.frameNum=0,e.write_id3tag_automatic&&l.id3tag_write_v2(e),t.bitrate_stereoMode_Hist=Qt([16,5]),t.bitrate_blockType_Hist=Qt([16,6]),t.PeakSample=0,e.bWriteVbrTag&&o.InitVbrTag(e)}(e),E.Class_ID=d,y=0;y<19;y++)E.nsPsy.pefirbuf[y]=700*E.mode_gr*E.channels_out;switch(-1==e.ATHtype&&(e.ATHtype=4),$t(e.VBR_q<=9),$t(e.VBR_q>=0),e.VBR){case jt.vbr_mt:e.VBR=jt.vbr_mtrh;case jt.vbr_mtrh:null==e.useTemporal&&(e.useTemporal=!1),s.apply_preset(e,500-10*e.VBR_q,0),e.quality<0&&(e.quality=LAME_DEFAULT_QUALITY),e.quality<5&&(e.quality=0),e.quality>5&&(e.quality=5),E.PSY.mask_adjust=e.maskingadjust,E.PSY.mask_adjust_short=e.maskingadjust_short,e.experimentalY?E.sfb21_extra=!1:E.sfb21_extra=e.out_samplerate>44e3,E.iteration_loop=new VBRNewIterationLoop(a);break;case jt.vbr_rh:s.apply_preset(e,500-10*e.VBR_q,0),E.PSY.mask_adjust=e.maskingadjust,E.PSY.mask_adjust_short=e.maskingadjust_short,e.experimentalY?E.sfb21_extra=!1:E.sfb21_extra=e.out_samplerate>44e3,e.quality>6&&(e.quality=6),e.quality<0&&(e.quality=LAME_DEFAULT_QUALITY),E.iteration_loop=new VBROldIterationLoop(a);break;default:var x;E.sfb21_extra=!1,e.quality<0&&(e.quality=LAME_DEFAULT_QUALITY),(x=e.VBR)==jt.vbr_off&&(e.VBR_mean_bitrate_kbps=e.brate),s.apply_preset(e,e.VBR_mean_bitrate_kbps,0),e.VBR=x,E.PSY.mask_adjust=e.maskingadjust,E.PSY.mask_adjust_short=e.maskingadjust_short,x==jt.vbr_off?E.iteration_loop=new ai(a):E.iteration_loop=new ABRIterationLoop(a)}if($t(e.scale>=0),e.VBR!=jt.vbr_off){if(E.VBR_min_bitrate=1,E.VBR_max_bitrate=14,e.out_samplerate<16e3&&(E.VBR_max_bitrate=8),0!=e.VBR_min_bitrate_kbps&&(e.VBR_min_bitrate_kbps=b(e.VBR_min_bitrate_kbps,e.version,e.out_samplerate),E.VBR_min_bitrate=v(e.VBR_min_bitrate_kbps,e.version,e.out_samplerate),E.VBR_min_bitrate<0))return-1;if(0!=e.VBR_max_bitrate_kbps&&(e.VBR_max_bitrate_kbps=b(e.VBR_max_bitrate_kbps,e.version,e.out_samplerate),E.VBR_max_bitrate=v(e.VBR_max_bitrate_kbps,e.version,e.out_samplerate),E.VBR_max_bitrate<0))return-1;e.VBR_min_bitrate_kbps=oi.bitrate_table[e.version][E.VBR_min_bitrate],e.VBR_max_bitrate_kbps=oi.bitrate_table[e.version][E.VBR_max_bitrate],e.VBR_mean_bitrate_kbps=Math.min(oi.bitrate_table[e.version][E.VBR_max_bitrate],e.VBR_mean_bitrate_kbps),e.VBR_mean_bitrate_kbps=Math.max(oi.bitrate_table[e.version][E.VBR_min_bitrate],e.VBR_mean_bitrate_kbps)}return e.tune&&(E.PSY.mask_adjust+=e.tune_value_a,E.PSY.mask_adjust_short+=e.tune_value_a),function(e){var t=e.internal_flags;switch(e.quality){default:case 9:t.psymodel=0,t.noise_shaping=0,t.noise_shaping_amp=0,t.noise_shaping_stop=0,t.use_best_huffman=0,t.full_outer_loop=0;break;case 8:e.quality=7;case 7:t.psymodel=1,t.noise_shaping=0,t.noise_shaping_amp=0,t.noise_shaping_stop=0,t.use_best_huffman=0,t.full_outer_loop=0;break;case 6:case 5:t.psymodel=1,0==t.noise_shaping&&(t.noise_shaping=1),t.noise_shaping_amp=0,t.noise_shaping_stop=0,-1==t.subblock_gain&&(t.subblock_gain=1),t.use_best_huffman=0,t.full_outer_loop=0;break;case 4:t.psymodel=1,0==t.noise_shaping&&(t.noise_shaping=1),t.noise_shaping_amp=0,t.noise_shaping_stop=0,-1==t.subblock_gain&&(t.subblock_gain=1),t.use_best_huffman=1,t.full_outer_loop=0;break;case 3:t.psymodel=1,0==t.noise_shaping&&(t.noise_shaping=1),t.noise_shaping_amp=1,t.noise_shaping_stop=1,-1==t.subblock_gain&&(t.subblock_gain=1),t.use_best_huffman=1,t.full_outer_loop=0;break;case 2:t.psymodel=1,0==t.noise_shaping&&(t.noise_shaping=1),0==t.substep_shaping&&(t.substep_shaping=2),t.noise_shaping_amp=1,t.noise_shaping_stop=1,-1==t.subblock_gain&&(t.subblock_gain=1),t.use_best_huffman=1,t.full_outer_loop=0;break;case 1:case 0:t.psymodel=1,0==t.noise_shaping&&(t.noise_shaping=1),0==t.substep_shaping&&(t.substep_shaping=2),t.noise_shaping_amp=2,t.noise_shaping_stop=1,-1==t.subblock_gain&&(t.subblock_gain=1),t.use_best_huffman=1,t.full_outer_loop=0}}(e),$t(e.scale>=0),e.athaa_type<0?E.ATH.useAdjust=3:E.ATH.useAdjust=e.athaa_type,E.ATH.aaSensitivityP=Math.pow(10,e.athaa_sensitivity/-10),null==e.short_blocks&&(e.short_blocks=zt.short_block_allowed),e.short_blocks!=zt.short_block_allowed||e.mode!=MPEGMode.JOINT_STEREO&&e.mode!=MPEGMode.STEREO||(e.short_blocks=zt.short_block_coupled),e.quant_comp<0&&(e.quant_comp=1),e.quant_comp_short<0&&(e.quant_comp_short=0),e.msfix<0&&(e.msfix=0),e.exp_nspsytune=1|e.exp_nspsytune,e.internal_flags.nsPsy.attackthre<0&&(e.internal_flags.nsPsy.attackthre=ei.NSATTACKTHRE),e.internal_flags.nsPsy.attackthre_s<0&&(e.internal_flags.nsPsy.attackthre_s=ei.NSATTACKTHRE_S),$t(e.scale>=0),e.scale<0&&(e.scale=1),e.ATHtype<0&&(e.ATHtype=4),e.ATHcurve<0&&(e.ATHcurve=4),e.athaa_loudapprox<0&&(e.athaa_loudapprox=2),e.interChRatio<0&&(e.interChRatio=0),null==e.useTemporal&&(e.useTemporal=!0),E.slot_lag=E.frac_SpF=0,e.VBR==jt.vbr_off&&(E.slot_lag=E.frac_SpF=72e3*(e.version+1)*e.brate%e.out_samplerate|0),r.iteration_init(e),_.psymodel_init(e),$t(e.scale>=0),0},this.lame_encode_flush=function(e,t,s,r){var a,n,o,h,_=e.internal_flags,u=Jt([2,1152]),c=0,f=_.mf_samples_to_encode-li.POSTDELAY,d=S(e);if(_.mf_samples_to_encode<1)return 0;for(a=0,e.in_samplerate!=e.out_samplerate&&(f+=16*e.out_samplerate/e.in_samplerate),(o=e.framesize-f%e.framesize)<576&&(o+=e.framesize),e.encoder_padding=o,h=(f+o)/e.framesize;h>0&&c>=0;){var p=d-_.mf_size,m=e.frameNum;p*=e.in_samplerate,(p/=e.out_samplerate)>1152&&(p=1152),p<1&&(p=1),n=r-a,0==r&&(n=0),s+=c=this.lame_encode_buffer(e,u[0],u[1],p,t,s,n),a+=c,h-=m!=e.frameNum?1:0}if(_.mf_samples_to_encode=0,c<0)return c;if(n=r-a,0==r&&(n=0),i.flush_bitstream(e),(c=i.copy_buffer(_,t,s,n,1))<0)return c;if(s+=c,n=r-(a+=c),0==r&&(n=0),e.write_id3tag_automatic){if(l.id3tag_write_v1(e),(c=i.copy_buffer(_,t,s,n,0))<0)return c;a+=c}return a},this.lame_encode_buffer=function(e,s,r,a,n,o,l){var h=e.internal_flags,_=[null,null];if(h.Class_ID!=d)return-3;if(0==a)return 0;!function(e,t){(null==e.in_buffer_0||e.in_buffer_nsamples<t)&&(e.in_buffer_0=Zt(t),e.in_buffer_1=Zt(t),e.in_buffer_nsamples=t)}(h,a),_[0]=h.in_buffer_0,_[1]=h.in_buffer_1;for(var u=0;u<a;u++)_[0][u]=s[u],h.channels_in>1&&(_[1][u]=r[u]);return function(e,s,r,a,n,o,l){var h,_,u,c,f,p=e.internal_flags,m=0,b=[null,null],v=[null,null];if(p.Class_ID!=d)return-3;if(0==a)return 0;if(f=i.copy_buffer(p,n,o,l,0),f<0)return f;if(o+=f,m+=f,v[0]=s,v[1]=r,ni.NEQ(e.scale,0)&&ni.NEQ(e.scale,1))for(_=0;_<a;++_)v[0][_]*=e.scale,2==p.channels_out&&(v[1][_]*=e.scale);if(ni.NEQ(e.scale_left,0)&&ni.NEQ(e.scale_left,1))for(_=0;_<a;++_)v[0][_]*=e.scale_left;if(ni.NEQ(e.scale_right,0)&&ni.NEQ(e.scale_right,1))for(_=0;_<a;++_)v[1][_]*=e.scale_right;if(2==e.num_channels&&1==p.channels_out)for(_=0;_<a;++_)v[0][_]=.5*(v[0][_]+v[1][_]),v[1][_]=0;c=S(e),b[0]=p.mfbuf[0],b[1]=p.mfbuf[1];var g=0;for(;a>0;){var A=[null,null],B=0,w=0;A[0]=v[0],A[1]=v[1];var T=new R;if(M(e,b,A,g,a,T),B=T.n_in,w=T.n_out,p.findReplayGain&&!p.decode_on_the_fly&&t.AnalyzeSamples(p.rgdata,b[0],p.mf_size,b[1],p.mf_size,w,p.channels_out)==GainAnalysis.GAIN_ANALYSIS_ERROR)return-6;if(a-=B,g+=B,p.channels_out,p.mf_size+=w,$t(p.mf_size<=ii.MFSIZE),p.mf_samples_to_encode<1&&(p.mf_samples_to_encode=li.ENCDELAY+li.POSTDELAY),p.mf_samples_to_encode+=w,p.mf_size>=c){var y=l-m;if(0==l&&(y=0),(h=E(e,b[0],b[1],n,o,y))<0)return h;for(o+=h,m+=h,p.mf_size-=e.framesize,p.mf_samples_to_encode-=e.framesize,u=0;u<p.channels_out;u++)for(_=0;_<p.mf_size;_++)b[u][_]=b[u][_+e.framesize]}}return $t(0==a),m}(e,_[0],_[1],a,n,o,l)}},_i=a(hi),ui=B;ui.System;var ci=ui.VbrMode;ui.Float,ui.ShortBlock,ui.Util,ui.Arrays,ui.new_array_n,ui.new_byte,ui.new_double,ui.new_float,ui.new_float_n,ui.new_int,ui.new_int_n,ui.assert;var fi=function(){function e(e,t,i,s,r,a,n,o,l,h,_,u,c,f,d){this.vbr_q=e,this.quant_comp=t,this.quant_comp_s=i,this.expY=s,this.st_lrm=r,this.st_s=a,this.masking_adj=n,this.masking_adj_short=o,this.ath_lower=l,this.ath_curve=h,this.ath_sensitivity=_,this.interch=u,this.safejoint=c,this.sfb21mod=f,this.msfix=d}function t(e,t,i,s,r,a,n,o,l,h,_,u,c,f){this.quant_comp=t,this.quant_comp_s=i,this.safejoint=s,this.nsmsfix=r,this.st_lrm=a,this.st_s=n,this.nsbass=o,this.scale=l,this.masking_adj=h,this.ath_lower=_,this.ath_curve=u,this.interch=c,this.sfscale=f}var i;this.setModules=function(e){i=e};var s=[new e(0,9,9,0,5.2,125,-4.2,-6.3,4.8,1,0,0,2,21,.97),new e(1,9,9,0,5.3,125,-3.6,-5.6,4.5,1.5,0,0,2,21,1.35),new e(2,9,9,0,5.6,125,-2.2,-3.5,2.8,2,0,0,2,21,1.49),new e(3,9,9,1,5.8,130,-1.8,-2.8,2.6,3,-4,0,2,20,1.64),new e(4,9,9,1,6,135,-.7,-1.1,1.1,3.5,-8,0,2,0,1.79),new e(5,9,9,1,6.4,140,.5,.4,-7.5,4,-12,2e-4,0,0,1.95),new e(6,9,9,1,6.6,145,.67,.65,-14.7,6.5,-19,4e-4,0,0,2.3),new e(7,9,9,1,6.6,145,.8,.75,-19.7,8,-22,6e-4,0,0,2.7),new e(8,9,9,1,6.6,145,1.2,1.15,-27.5,10,-23,7e-4,0,0,0),new e(9,9,9,1,6.6,145,1.6,1.6,-36,11,-25,8e-4,0,0,0),new e(10,9,9,1,6.6,145,2,2,-36,12,-25,8e-4,0,0,0)],r=[new e(0,9,9,0,4.2,25,-7,-4,7.5,1,0,0,2,26,.97),new e(1,9,9,0,4.2,25,-5.6,-3.6,4.5,1.5,0,0,2,21,1.35),new e(2,9,9,0,4.2,25,-4.4,-1.8,2,2,0,0,2,18,1.49),new e(3,9,9,1,4.2,25,-3.4,-1.25,1.1,3,-4,0,2,15,1.64),new e(4,9,9,1,4.2,25,-2.2,.1,0,3.5,-8,0,2,0,1.79),new e(5,9,9,1,4.2,25,-1,1.65,-7.7,4,-12,2e-4,0,0,1.95),new e(6,9,9,1,4.2,25,-0,2.47,-7.7,6.5,-19,4e-4,0,0,2),new e(7,9,9,1,4.2,25,.5,2,-14.5,8,-22,6e-4,0,0,2),new e(8,9,9,1,4.2,25,1,2.4,-22,10,-23,7e-4,0,0,2),new e(9,9,9,1,4.2,25,1.5,2.95,-30,11,-25,8e-4,0,0,2),new e(10,9,9,1,4.2,25,2,2.95,-36,12,-30,8e-4,0,0,2)];function a(e,t,i){var a=e.VBR==ci.vbr_rh?s:r,n=e.VBR_q_frac,o=a[t],l=a[t+1],h=o;o.st_lrm=o.st_lrm+n*(l.st_lrm-o.st_lrm),o.st_s=o.st_s+n*(l.st_s-o.st_s),o.masking_adj=o.masking_adj+n*(l.masking_adj-o.masking_adj),o.masking_adj_short=o.masking_adj_short+n*(l.masking_adj_short-o.masking_adj_short),o.ath_lower=o.ath_lower+n*(l.ath_lower-o.ath_lower),o.ath_curve=o.ath_curve+n*(l.ath_curve-o.ath_curve),o.ath_sensitivity=o.ath_sensitivity+n*(l.ath_sensitivity-o.ath_sensitivity),o.interch=o.interch+n*(l.interch-o.interch),o.msfix=o.msfix+n*(l.msfix-o.msfix),function(e,t){var i=0;0>t&&(i=-1,t=0);9<t&&(i=-1,t=9);e.VBR_q=t,e.VBR_q_frac=0}(e,h.vbr_q),0!=i?e.quant_comp=h.quant_comp:Math.abs(e.quant_comp- -1)>0||(e.quant_comp=h.quant_comp),0!=i?e.quant_comp_short=h.quant_comp_s:Math.abs(e.quant_comp_short- -1)>0||(e.quant_comp_short=h.quant_comp_s),0!=h.expY&&(e.experimentalY=0!=h.expY),0!=i?e.internal_flags.nsPsy.attackthre=h.st_lrm:Math.abs(e.internal_flags.nsPsy.attackthre- -1)>0||(e.internal_flags.nsPsy.attackthre=h.st_lrm),0!=i?e.internal_flags.nsPsy.attackthre_s=h.st_s:Math.abs(e.internal_flags.nsPsy.attackthre_s- -1)>0||(e.internal_flags.nsPsy.attackthre_s=h.st_s),0!=i?e.maskingadjust=h.masking_adj:Math.abs(e.maskingadjust-0)>0||(e.maskingadjust=h.masking_adj),0!=i?e.maskingadjust_short=h.masking_adj_short:Math.abs(e.maskingadjust_short-0)>0||(e.maskingadjust_short=h.masking_adj_short),0!=i?e.ATHlower=-h.ath_lower/10:Math.abs(10*-e.ATHlower-0)>0||(e.ATHlower=-h.ath_lower/10),0!=i?e.ATHcurve=h.ath_curve:Math.abs(e.ATHcurve- -1)>0||(e.ATHcurve=h.ath_curve),0!=i?e.athaa_sensitivity=h.ath_sensitivity:Math.abs(e.athaa_sensitivity- -1)>0||(e.athaa_sensitivity=h.ath_sensitivity),h.interch>0&&(0!=i?e.interChRatio=h.interch:Math.abs(e.interChRatio- -1)>0||(e.interChRatio=h.interch)),h.safejoint>0&&(e.exp_nspsytune=e.exp_nspsytune|h.safejoint),h.sfb21mod>0&&(e.exp_nspsytune=e.exp_nspsytune|h.sfb21mod<<20),0!=i?e.msfix=h.msfix:Math.abs(e.msfix- -1)>0||(e.msfix=h.msfix),0==i&&(e.VBR_q=t,e.VBR_q_frac=n)}var n=[new t(8,9,9,0,0,6.6,145,0,.95,0,-30,11,.0012,1),new t(16,9,9,0,0,6.6,145,0,.95,0,-25,11,.001,1),new t(24,9,9,0,0,6.6,145,0,.95,0,-20,11,.001,1),new t(32,9,9,0,0,6.6,145,0,.95,0,-15,11,.001,1),new t(40,9,9,0,0,6.6,145,0,.95,0,-10,11,9e-4,1),new t(48,9,9,0,0,6.6,145,0,.95,0,-10,11,9e-4,1),new t(56,9,9,0,0,6.6,145,0,.95,0,-6,11,8e-4,1),new t(64,9,9,0,0,6.6,145,0,.95,0,-2,11,8e-4,1),new t(80,9,9,0,0,6.6,145,0,.95,0,0,8,7e-4,1),new t(96,9,9,0,2.5,6.6,145,0,.95,0,1,5.5,6e-4,1),new t(112,9,9,0,2.25,6.6,145,0,.95,0,2,4.5,5e-4,1),new t(128,9,9,0,1.95,6.4,140,0,.95,0,3,4,2e-4,1),new t(160,9,9,1,1.79,6,135,0,.95,-2,5,3.5,0,1),new t(192,9,9,1,1.49,5.6,125,0,.97,-4,7,3,0,0),new t(224,9,9,1,1.25,5.2,125,0,.98,-6,9,2,0,0),new t(256,9,9,1,.97,5.2,125,0,1,-8,10,1,0,0),new t(320,9,9,1,.9,5.2,125,0,1,-10,12,0,0,0)];function o(e,t,s){var r=t,a=i.nearestBitrateFullIndex(t);if(e.VBR=ci.vbr_abr,e.VBR_mean_bitrate_kbps=r,e.VBR_mean_bitrate_kbps=Math.min(e.VBR_mean_bitrate_kbps,320),e.VBR_mean_bitrate_kbps=Math.max(e.VBR_mean_bitrate_kbps,8),e.brate=e.VBR_mean_bitrate_kbps,e.VBR_mean_bitrate_kbps>320&&(e.disable_reservoir=!0),n[a].safejoint>0&&(e.exp_nspsytune=2|e.exp_nspsytune),n[a].sfscale>0&&(e.internal_flags.noise_shaping=2),Math.abs(n[a].nsbass)>0){var o=int(4*n[a].nsbass);o<0&&(o+=64),e.exp_nspsytune=e.exp_nspsytune|o<<2}return 0!=s?e.quant_comp=n[a].quant_comp:Math.abs(e.quant_comp- -1)>0||(e.quant_comp=n[a].quant_comp),0!=s?e.quant_comp_short=n[a].quant_comp_s:Math.abs(e.quant_comp_short- -1)>0||(e.quant_comp_short=n[a].quant_comp_s),0!=s?e.msfix=n[a].nsmsfix:Math.abs(e.msfix- -1)>0||(e.msfix=n[a].nsmsfix),0!=s?e.internal_flags.nsPsy.attackthre=n[a].st_lrm:Math.abs(e.internal_flags.nsPsy.attackthre- -1)>0||(e.internal_flags.nsPsy.attackthre=n[a].st_lrm),0!=s?e.internal_flags.nsPsy.attackthre_s=n[a].st_s:Math.abs(e.internal_flags.nsPsy.attackthre_s- -1)>0||(e.internal_flags.nsPsy.attackthre_s=n[a].st_s),0!=s?e.scale=n[a].scale:Math.abs(e.scale- -1)>0||(e.scale=n[a].scale),0!=s?e.maskingadjust=n[a].masking_adj:Math.abs(e.maskingadjust-0)>0||(e.maskingadjust=n[a].masking_adj),n[a].masking_adj>0?0!=s?e.maskingadjust_short=.9*n[a].masking_adj:Math.abs(e.maskingadjust_short-0)>0||(e.maskingadjust_short=.9*n[a].masking_adj):0!=s?e.maskingadjust_short=1.1*n[a].masking_adj:Math.abs(e.maskingadjust_short-0)>0||(e.maskingadjust_short=1.1*n[a].masking_adj),0!=s?e.ATHlower=-n[a].ath_lower/10:Math.abs(10*-e.ATHlower-0)>0||(e.ATHlower=-n[a].ath_lower/10),0!=s?e.ATHcurve=n[a].ath_curve:Math.abs(e.ATHcurve- -1)>0||(e.ATHcurve=n[a].ath_curve),0!=s?e.interChRatio=n[a].interch:Math.abs(e.interChRatio- -1)>0||(e.interChRatio=n[a].interch),t}this.apply_preset=function(e,t,i){switch(t){case Lame.R3MIX:t=Lame.V3,e.VBR=ci.vbr_mtrh;break;case Lame.MEDIUM:t=Lame.V4,e.VBR=ci.vbr_rh;break;case Lame.MEDIUM_FAST:t=Lame.V4,e.VBR=ci.vbr_mtrh;break;case Lame.STANDARD:t=Lame.V2,e.VBR=ci.vbr_rh;break;case Lame.STANDARD_FAST:t=Lame.V2,e.VBR=ci.vbr_mtrh;break;case Lame.EXTREME:t=Lame.V0,e.VBR=ci.vbr_rh;break;case Lame.EXTREME_FAST:t=Lame.V0,e.VBR=ci.vbr_mtrh;break;case Lame.INSANE:return t=320,e.preset=t,o(e,t,i),e.VBR=ci.vbr_off,t}switch(e.preset=t,t){case Lame.V9:return a(e,9,i),t;case Lame.V8:return a(e,8,i),t;case Lame.V7:return a(e,7,i),t;case Lame.V6:return a(e,6,i),t;case Lame.V5:return a(e,5,i),t;case Lame.V4:return a(e,4,i),t;case Lame.V3:return a(e,3,i),t;case Lame.V2:return a(e,2,i),t;case Lame.V1:return a(e,1,i),t;case Lame.V0:return a(e,0,i),t}return 8<=t&&t<=320?o(e,t,i):(e.preset=0,t)}};a(fi);var di=function(){this.setModules=function(e,t){}};a(di);var pi=function(){this.over_noise=0,this.tot_noise=0,this.max_noise=0,this.over_count=0,this.over_SSD=0,this.bits=0};a(pi);var mi=B,bi=mi.new_float,vi=mi.new_int;mi.assert;var gi=function(){this.global_gain=0,this.sfb_count1=0,this.step=vi(39),this.noise=bi(39),this.noise_log=bi(39)};a(gi);var Si=B,Ei=Si.System,Ri=Si.VbrMode;Si.Float,Si.ShortBlock;var Ai=Si.Util,Bi=Si.Arrays;Si.new_array_n,Si.new_byte,Si.new_double;var wi=Si.new_float;Si.new_float_n,Si.new_int,Si.new_int_n;var Ti=Si.assert,Mi=di,yi=pi,ki=gi,Pi=T(),Ni=se,Ii=J;var xi=function(){var e,t,i;this.rv=null,this.qupvt=null;var s,r=new Mi;function a(e){this.ordinal=e}function n(e){for(var t=0;t<e.sfbmax;t++)if(e.scalefac[t]+e.subblock_gain[e.window[t]]==0)return!1;return!0}function o(e,t,i,s,r){var a;switch(e){default:case 9:t.over_count>0?(a=i.over_SSD<=t.over_SSD,i.over_SSD==t.over_SSD&&(a=i.bits<t.bits)):a=i.max_noise<0&&10*i.max_noise+i.bits<=10*t.max_noise+t.bits;break;case 0:a=i.over_count<t.over_count||i.over_count==t.over_count&&i.over_noise<t.over_noise||i.over_count==t.over_count&&BitStream.EQ(i.over_noise,t.over_noise)&&i.tot_noise<t.tot_noise;break;case 8:i.max_noise=function(e,t){for(var i,s=1e-37,r=0;r<t.psymax;r++)s+=(i=e[r],Ai.FAST_LOG10(.368+.632*i*i*i));return Math.max(1e-20,s)}(r,s);case 1:a=i.max_noise<t.max_noise;break;case 2:a=i.tot_noise<t.tot_noise;break;case 3:a=i.tot_noise<t.tot_noise&&i.max_noise<t.max_noise;break;case 4:a=i.max_noise<=0&&t.max_noise>.2||i.max_noise<=0&&t.max_noise<0&&t.max_noise>i.max_noise-.2&&i.tot_noise<t.tot_noise||i.max_noise<=0&&t.max_noise>0&&t.max_noise>i.max_noise-.2&&i.tot_noise<t.tot_noise+t.over_noise||i.max_noise>0&&t.max_noise>-.05&&t.max_noise>i.max_noise-.1&&i.tot_noise+i.over_noise<t.tot_noise+t.over_noise||i.max_noise>0&&t.max_noise>-.1&&t.max_noise>i.max_noise-.15&&i.tot_noise+i.over_noise+i.over_noise<t.tot_noise+t.over_noise+t.over_noise;break;case 5:a=i.over_noise<t.over_noise||BitStream.EQ(i.over_noise,t.over_noise)&&i.tot_noise<t.tot_noise;break;case 6:a=i.over_noise<t.over_noise||BitStream.EQ(i.over_noise,t.over_noise)&&(i.max_noise<t.max_noise||BitStream.EQ(i.max_noise,t.max_noise)&&i.tot_noise<=t.tot_noise);break;case 7:a=i.over_count<t.over_count||i.over_noise<t.over_noise}return 0==t.over_count&&(a=a&&i.bits<t.bits),a}function l(e,t,r,a,o){var l=e.internal_flags;!function(e,t,i,s,r){var a,n=e.internal_flags;a=0==t.scalefac_scale?1.2968395546510096:1.6817928305074292;for(var o=0,l=0;l<t.sfbmax;l++)o<i[l]&&(o=i[l]);var h=n.noise_shaping_amp;switch(3==h&&(h=r?2:1),h){case 2:break;case 1:o>1?o=Math.pow(o,.5):o*=.95;break;default:o>1?o=1:o*=.95}var _=0;for(l=0;l<t.sfbmax;l++){var u,c=t.width[l];if(_+=c,!(i[l]<o)){if(2&n.substep_shaping&&(n.pseudohalf[l]=0==n.pseudohalf[l]?1:0,0==n.pseudohalf[l]&&2==n.noise_shaping_amp))return;for(t.scalefac[l]++,u=-c;u<0;u++)s[_+u]*=a,s[_+u]>t.xrpow_max&&(t.xrpow_max=s[_+u]);if(2==n.noise_shaping_amp)return}}}(e,t,r,a,o);var h=n(t);return!h&&(!(h=2==l.mode_gr?s.scale_bitcount(t):s.scale_bitcount_lsf(l,t))||(l.noise_shaping>1&&(Bi.fill(l.pseudohalf,0),0==t.scalefac_scale?(!function(e,t){for(var s=0,r=0;r<e.sfbmax;r++){var a=e.width[r],n=e.scalefac[r];if(0!=e.preflag&&(n+=i.pretab[r]),s+=a,1&n){n++;for(var o=-a;o<0;o++)t[s+o]*=1.2968395546510096,t[s+o]>e.xrpow_max&&(e.xrpow_max=t[s+o])}e.scalefac[r]=n>>1}e.preflag=0,e.scalefac_scale=1}(t,a),h=!1):t.block_type==Pi.SHORT_TYPE&&l.subblock_gain>0&&(h=function(e,t,s){var r,a=t.scalefac;for(r=0;r<t.sfb_lmax;r++)if(a[r]>=16)return!0;for(var n=0;n<3;n++){var o=0,l=0;for(r=t.sfb_lmax+n;r<t.sfbdivide;r+=3)o<a[r]&&(o=a[r]);for(;r<t.sfbmax;r+=3)l<a[r]&&(l=a[r]);if(!(o<16&&l<8)){if(t.subblock_gain[n]>=7)return!0;t.subblock_gain[n]++;var h=e.scalefac_band.l[t.sfb_lmax];for(r=t.sfb_lmax+n;r<t.sfbmax;r+=3){var _=t.width[r],u=a[r];if(Ti(u>=0),(u-=4>>t.scalefac_scale)>=0)a[r]=u,h+=3*_;else{a[r]=0;var c=210+(u<<t.scalefac_scale+1);d=i.IPOW20(c),h+=_*(n+1);for(var f=-_;f<0;f++)s[h+f]*=d,s[h+f]>t.xrpow_max&&(t.xrpow_max=s[h+f]);h+=_*(3-n-1)}}var d=i.IPOW20(202);for(h+=t.width[r]*(n+1),f=-t.width[r];f<0;f++)s[h+f]*=d,s[h+f]>t.xrpow_max&&(t.xrpow_max=s[h+f])}}return!1}(l,t,a)||n(t))),h||(h=2==l.mode_gr?s.scale_bitcount(t):s.scale_bitcount_lsf(l,t)),!h))}this.setModules=function(a,n,o,l){e=a,t=n,this.rv=n,i=o,this.qupvt=o,s=l,r.setModules(i,s)},this.ms_convert=function(e,t){for(var i=0;i<576;++i){var s=e.tt[t][0].xr[i],r=e.tt[t][1].xr[i];e.tt[t][0].xr[i]=(s+r)*(.5*Ai.SQRT2),e.tt[t][1].xr[i]=(s-r)*(.5*Ai.SQRT2)}},this.init_xrpow=function(e,t,i){var s=0,r=0|t.max_nonzero_coeff;if(Ti(null!=i),t.xrpow_max=0,Ti(0<=r&&r<=575),Bi.fill(i,r,576,0),s=function(e,t,i,s){s=0;for(var r=0;r<=i;++r){var a=Math.abs(e.xr[r]);s+=a,t[r]=Math.sqrt(a*Math.sqrt(a)),t[r]>e.xrpow_max&&(e.xrpow_max=t[r])}return s}(t,i,r,s),s>1e-20){var a=0;2&e.substep_shaping&&(a=1);for(var n=0;n<t.psymax;n++)e.pseudohalf[n]=a;return!0}return Bi.fill(t.l3_enc,0,576,0),!1},this.init_outer_loop=function(e,t){t.part2_3_length=0,t.big_values=0,t.count1=0,t.global_gain=210,t.scalefac_compress=0,t.table_select[0]=0,t.table_select[1]=0,t.table_select[2]=0,t.subblock_gain[0]=0,t.subblock_gain[1]=0,t.subblock_gain[2]=0,t.subblock_gain[3]=0,t.region0_count=0,t.region1_count=0,t.preflag=0,t.scalefac_scale=0,t.count1table_select=0,t.part2_length=0,t.sfb_lmax=Pi.SBPSY_l,t.sfb_smin=Pi.SBPSY_s,t.psy_lmax=e.sfb21_extra?Pi.SBMAX_l:Pi.SBPSY_l,t.psymax=t.psy_lmax,t.sfbmax=t.sfb_lmax,t.sfbdivide=11;for(var s=0;s<Pi.SBMAX_l;s++)t.width[s]=e.scalefac_band.l[s+1]-e.scalefac_band.l[s],t.window[s]=3;if(t.block_type==Pi.SHORT_TYPE){var r=wi(576);t.sfb_smin=0,t.sfb_lmax=0,0!=t.mixed_block_flag&&(t.sfb_smin=3,t.sfb_lmax=2*e.mode_gr+4),t.psymax=t.sfb_lmax+3*((e.sfb21_extra?Pi.SBMAX_s:Pi.SBPSY_s)-t.sfb_smin),t.sfbmax=t.sfb_lmax+3*(Pi.SBPSY_s-t.sfb_smin),t.sfbdivide=t.sfbmax-18,t.psy_lmax=t.sfb_lmax;var a=e.scalefac_band.l[t.sfb_lmax];Ei.arraycopy(t.xr,0,r,0,576);for(s=t.sfb_smin;s<Pi.SBMAX_s;s++)for(var n=e.scalefac_band.s[s],o=e.scalefac_band.s[s+1],l=0;l<3;l++)for(var h=n;h<o;h++)t.xr[a++]=r[3*h+l];var _=t.sfb_lmax;for(s=t.sfb_smin;s<Pi.SBMAX_s;s++)t.width[_]=t.width[_+1]=t.width[_+2]=e.scalefac_band.s[s+1]-e.scalefac_band.s[s],t.window[_]=0,t.window[_+1]=1,t.window[_+2]=2,_+=3}t.count1bits=0,t.sfb_partition_table=i.nr_of_sfb_block[0][0],t.slen[0]=0,t.slen[1]=0,t.slen[2]=0,t.slen[3]=0,t.max_nonzero_coeff=575,Bi.fill(t.scalefac,0),function(e,t){var s=e.ATH,r=t.xr;if(t.block_type!=Pi.SHORT_TYPE)for(var a=!1,n=Pi.PSFB21-1;n>=0&&!a;n--){var o=e.scalefac_band.psfb21[n],l=e.scalefac_band.psfb21[n+1],h=i.athAdjust(s.adjust,s.psfb21[n],s.floor);e.nsPsy.longfact[21]>1e-12&&(h*=e.nsPsy.longfact[21]);for(var _=l-1;_>=o;_--){if(!(Math.abs(r[_])<h)){a=!0;break}r[_]=0}}else for(var u=0;u<3;u++)for(a=!1,n=Pi.PSFB12-1;n>=0&&!a;n--){l=(o=3*e.scalefac_band.s[12]+(e.scalefac_band.s[13]-e.scalefac_band.s[12])*u+(e.scalefac_band.psfb12[n]-e.scalefac_band.psfb12[0]))+(e.scalefac_band.psfb12[n+1]-e.scalefac_band.psfb12[n]);var c=i.athAdjust(s.adjust,s.psfb12[n],s.floor);for(e.nsPsy.shortfact[12]>1e-12&&(c*=e.nsPsy.shortfact[12]),_=l-1;_>=o;_--){if(!(Math.abs(r[_])<c)){a=!0;break}r[_]=0}}}(e,t)},a.BINSEARCH_NONE=new a(0),a.BINSEARCH_UP=new a(1),a.BINSEARCH_DOWN=new a(2),this.trancate_smallspectrums=function(e,t,r,a){var n=wi(Ii.SFBMAX);if((4&e.substep_shaping||t.block_type!=Pi.SHORT_TYPE)&&!(128&e.substep_shaping)){i.calc_noise(t,r,n,new yi,null);for(var o=0;o<576;o++){var l=0;0!=t.l3_enc[o]&&(l=Math.abs(t.xr[o])),a[o]=l}o=0;var h=8;t.block_type==Pi.SHORT_TYPE&&(h=6);do{var _,u,c,f,d=t.width[h];if(o+=d,!(n[h]>=1||(Bi.sort(a,o-d,d),BitStream.EQ(a[o-1],0)))){_=(1-n[h])*r[h],u=0,f=0;do{var p;for(c=1;f+c<d&&!BitStream.NEQ(a[f+o-d],a[f+o+c-d]);c++);if(_<(p=a[f+o-d]*a[f+o-d]*c)){0!=f&&(u=a[f+o-d-1]);break}_-=p,f+=c}while(f<d);if(!BitStream.EQ(u,0))do{Math.abs(t.xr[o-d])<=u&&(t.l3_enc[o-d]=0)}while(--d>0)}}while(++h<t.psymax);t.part2_3_length=s.noquant_count_bits(e,t,null)}},this.outer_loop=function(e,t,r,n,h,_){var u=e.internal_flags,c=new Ni,f=wi(576),d=wi(Ii.SFBMAX),p=new yi,m=new ki,b=9999999,v=!1,g=!1,S=0;if(function(e,t,i,r,n){var o,l=e.CurrentStep[r],h=!1,_=e.OldValue[r],u=a.BINSEARCH_NONE;for(t.global_gain=_,i-=t.part2_length,Ti(0!=l);;){var c;if(o=s.count_bits(e,n,t,null),1==l||o==i)break;o>i?(u==a.BINSEARCH_DOWN&&(h=!0),h&&(l/=2),u=a.BINSEARCH_UP,c=l):(u==a.BINSEARCH_UP&&(h=!0),h&&(l/=2),u=a.BINSEARCH_DOWN,c=-l),t.global_gain+=c,t.global_gain<0&&(t.global_gain=0,h=!0),t.global_gain>255&&(t.global_gain=255,h=!0)}for(Ti(t.global_gain>=0),Ti(t.global_gain<256);o>i&&t.global_gain<255;)t.global_gain++,o=s.count_bits(e,n,t,null);e.CurrentStep[r]=_-t.global_gain>=4?4:2,e.OldValue[r]=t.global_gain,t.part2_3_length=o}(u,t,_,h,n),0==u.noise_shaping)return 100;i.calc_noise(t,r,d,p,m),p.bits=t.part2_3_length,c.assign(t);var E=0;for(Ei.arraycopy(n,0,f,0,576);!v;){do{var R,A=new yi,B=255;if(R=2&u.substep_shaping?20:3,u.sfb21_extra){if(d[c.sfbmax]>1)break;if(c.block_type==Pi.SHORT_TYPE&&(d[c.sfbmax+1]>1||d[c.sfbmax+2]>1))break}if(!l(e,c,d,n,g))break;0!=c.scalefac_scale&&(B=254);var w=_-c.part2_length;if(w<=0)break;for(;(c.part2_3_length=s.count_bits(u,n,c,m))>w&&c.global_gain<=B;)c.global_gain++;if(c.global_gain>B)break;if(0==p.over_count){for(;(c.part2_3_length=s.count_bits(u,n,c,m))>b&&c.global_gain<=B;)c.global_gain++;if(c.global_gain>B)break}if(i.calc_noise(c,r,d,A,m),A.bits=c.part2_3_length,0!=(o(t.block_type!=Pi.SHORT_TYPE?e.quant_comp:e.quant_comp_short,p,A,c,d)?1:0))b=t.part2_3_length,p=A,t.assign(c),E=0,Ei.arraycopy(n,0,f,0,576);else if(0==u.full_outer_loop){if(++E>R&&0==p.over_count)break;if(3==u.noise_shaping_amp&&g&&E>30)break;if(3==u.noise_shaping_amp&&g&&c.global_gain-S>15)break}}while(c.global_gain+c.scalefac_scale<255);3==u.noise_shaping_amp?g?v=!0:(c.assign(t),Ei.arraycopy(f,0,n,0,576),E=0,S=c.global_gain,g=!0):v=!0}return Ti(t.global_gain+t.scalefac_scale<=255),e.VBR==Ri.vbr_rh||e.VBR==Ri.vbr_mtrh?Ei.arraycopy(f,0,n,0,576):1&u.substep_shaping&&trancate_smallspectrums(u,t,r,n),p.over_count},this.iteration_finish_one=function(e,i,r){var a=e.l3_side,n=a.tt[i][r];s.best_scalefac_store(e,i,r,a),1==e.use_best_huffman&&s.best_huffman_divide(e,n),t.ResvAdjust(e,n)},this.VBR_encode_granule=function(e,t,i,s,r,a,n){var o,l=e.internal_flags,h=new Ni,_=wi(576),u=n,c=n+1,f=(n+a)/2,d=0,p=l.sfb21_extra;Ti(u<=LameInternalFlags.MAX_BITS_PER_CHANNEL),Bi.fill(h.l3_enc,0);do{Ti(f>=a),Ti(f<=n),Ti(a<=n),l.sfb21_extra=!(f>u-42)&&p,outer_loop(e,t,i,s,r,f)<=0?(d=1,c=t.part2_3_length,h.assign(t),Ei.arraycopy(s,0,_,0,576),o=(n=c-32)-a,f=(n+a)/2):(o=n-(a=f+32),f=(n+a)/2,0!=d&&(d=2,t.assign(h),Ei.arraycopy(_,0,s,0,576)))}while(o>12);l.sfb21_extra=p,2==d&&Ei.arraycopy(h.l3_enc,0,t.l3_enc,0,576),Ti(t.part2_3_length<=u)},this.get_framebits=function(i,s){var r=i.internal_flags;r.bitrate_index=r.VBR_min_bitrate;var a=e.getframebits(i);r.bitrate_index=1,a=e.getframebits(i);for(var n=1;n<=r.VBR_max_bitrate;n++){r.bitrate_index=n;var o=new MeanBits(a);s[n]=t.ResvFrameBegin(i,o),a=o.bits}},this.VBR_old_prepare=function(e,s,r,a,n,o,l,h,_){var u,c=e.internal_flags,f=0,d=1,p=0;c.bitrate_index=c.VBR_max_bitrate;var m=t.ResvFrameBegin(e,new MeanBits(0))/c.mode_gr;get_framebits(e,o);for(var b=0;b<c.mode_gr;b++){var v=i.on_pe(e,s,h[b],m,b,0);c.mode_ext==Pi.MPG_MD_MS_LR&&(ms_convert(c.l3_side,b),i.reduce_side(h[b],r[b],m,v));for(var g=0;g<c.channels_out;++g){var S=c.l3_side.tt[b][g];S.block_type!=Pi.SHORT_TYPE?(f=1.28/(1+Math.exp(3.5-s[b][g]/300))-.05,u=c.PSY.mask_adjust-f):(f=2.56/(1+Math.exp(3.5-s[b][g]/300))-.14,u=c.PSY.mask_adjust_short-f),c.masking_lower=Math.pow(10,.1*u),init_outer_loop(c,S),_[b][g]=i.calc_xmin(e,a[b][g],S,n[b][g]),0!=_[b][g]&&(d=0),l[b][g]=126,p+=h[b][g]}}for(b=0;b<c.mode_gr;b++)for(g=0;g<c.channels_out;g++)p>o[c.VBR_max_bitrate]&&(h[b][g]*=o[c.VBR_max_bitrate],h[b][g]/=p),l[b][g]>h[b][g]&&(l[b][g]=h[b][g]);return d},this.bitpressure_strategy=function(e,t,i,s){for(var r=0;r<e.mode_gr;r++)for(var a=0;a<e.channels_out;a++){for(var n=e.l3_side.tt[r][a],o=t[r][a],l=0,h=0;h<n.psy_lmax;h++)o[l++]*=1+.029*h*h/Pi.SBMAX_l/Pi.SBMAX_l;if(n.block_type==Pi.SHORT_TYPE)for(h=n.sfb_smin;h<Pi.SBMAX_s;h++)o[l++]*=1+.029*h*h/Pi.SBMAX_s/Pi.SBMAX_s,o[l++]*=1+.029*h*h/Pi.SBMAX_s/Pi.SBMAX_s,o[l++]*=1+.029*h*h/Pi.SBMAX_s/Pi.SBMAX_s;s[r][a]=0|Math.max(i[r][a],.9*s[r][a])}},this.VBR_new_prepare=function(e,s,r,a,n,o){var l,h=e.internal_flags,_=1,u=0,c=0;if(e.free_format){h.bitrate_index=0;f=new MeanBits(u);l=t.ResvFrameBegin(e,f),u=f.bits,n[0]=l}else{h.bitrate_index=h.VBR_max_bitrate;var f=new MeanBits(u);t.ResvFrameBegin(e,f),u=f.bits,get_framebits(e,n),l=n[h.VBR_max_bitrate]}for(var d=0;d<h.mode_gr;d++){i.on_pe(e,s,o[d],u,d,0),h.mode_ext==Pi.MPG_MD_MS_LR&&ms_convert(h.l3_side,d);for(var p=0;p<h.channels_out;++p){var m=h.l3_side.tt[d][p];h.masking_lower=Math.pow(10,.1*h.PSY.mask_adjust),init_outer_loop(h,m),0!=i.calc_xmin(e,r[d][p],m,a[d][p])&&(_=0),c+=o[d][p]}}for(d=0;d<h.mode_gr;d++)for(p=0;p<h.channels_out;p++)c>l&&(o[d][p]*=l,o[d][p]/=c);return _},this.calc_target_bits=function(s,r,a,n,o,l){var h,_,u,c,f=s.internal_flags,d=f.l3_side,p=0;f.bitrate_index=f.VBR_max_bitrate;var m=new MeanBits(p);for(l[0]=t.ResvFrameBegin(s,m),p=m.bits,f.bitrate_index=1,p=e.getframebits(s)-8*f.sideinfo_len,o[0]=p/(f.mode_gr*f.channels_out),p=s.VBR_mean_bitrate_kbps*s.framesize*1e3,1&f.substep_shaping&&(p*=1.09),p/=s.out_samplerate,p-=8*f.sideinfo_len,p/=f.mode_gr*f.channels_out,(h=.93+.07*(11-s.compression_ratio)/5.5)<.9&&(h=.9),h>1&&(h=1),_=0;_<f.mode_gr;_++){var b=0;for(u=0;u<f.channels_out;u++){if(n[_][u]=int(h*p),r[_][u]>700){var v=int((r[_][u]-700)/1.4),g=d.tt[_][u];n[_][u]=int(h*p),g.block_type==Pi.SHORT_TYPE&&v<p/2&&(v=p/2),v>3*p/2?v=3*p/2:v<0&&(v=0),n[_][u]+=v}n[_][u]>LameInternalFlags.MAX_BITS_PER_CHANNEL&&(n[_][u]=LameInternalFlags.MAX_BITS_PER_CHANNEL),b+=n[_][u]}if(b>LameInternalFlags.MAX_BITS_PER_GRANULE)for(u=0;u<f.channels_out;++u)n[_][u]*=LameInternalFlags.MAX_BITS_PER_GRANULE,n[_][u]/=b}if(f.mode_ext==Pi.MPG_MD_MS_LR)for(_=0;_<f.mode_gr;_++)i.reduce_side(n[_],a[_],p*f.channels_out,LameInternalFlags.MAX_BITS_PER_GRANULE);for(c=0,_=0;_<f.mode_gr;_++)for(u=0;u<f.channels_out;u++)n[_][u]>LameInternalFlags.MAX_BITS_PER_CHANNEL&&(n[_][u]=LameInternalFlags.MAX_BITS_PER_CHANNEL),c+=n[_][u];if(c>l[0])for(_=0;_<f.mode_gr;_++)for(u=0;u<f.channels_out;u++)n[_][u]*=l[0],n[_][u]/=c}};a(xi);var Ci=B.assert;var Oi=function(){var e;this.setModules=function(t){e=t},this.ResvFrameBegin=function(t,i){var s,r=t.internal_flags,a=r.l3_side,n=e.getframebits(t);i.bits=(n-8*r.sideinfo_len)/r.mode_gr;var o=2048*r.mode_gr-8;t.brate>320?s=8*int(1e3*t.brate/(t.out_samplerate/1152)/8+.5):(s=11520,t.strict_ISO&&(s=8*int(32e4/(t.out_samplerate/1152)/8+.5))),r.ResvMax=s-n,r.ResvMax>o&&(r.ResvMax=o),(r.ResvMax<0||t.disable_reservoir)&&(r.ResvMax=0);var l=i.bits*r.mode_gr+Math.min(r.ResvSize,r.ResvMax);return l>s&&(l=s),Ci(0==r.ResvMax%8),Ci(r.ResvMax>=0),a.resvDrain_pre=0,null!=r.pinfo&&(r.pinfo.mean_bits=i.bits/2,r.pinfo.resvsize=r.ResvSize),l},this.ResvMaxBits=function(e,t,i,s){var r,a=e.internal_flags,n=a.ResvSize,o=a.ResvMax;0!=s&&(n+=t),1&a.substep_shaping&&(o*=.9),i.bits=t,10*n>9*o?(r=n-9*o/10,i.bits+=r,a.substep_shaping|=128):(r=0,a.substep_shaping&=127,e.disable_reservoir||1&a.substep_shaping||(i.bits-=.1*t));var l=n<6*a.ResvMax/10?n:6*a.ResvMax/10;return(l-=r)<0&&(l=0),l},this.ResvAdjust=function(e,t){e.ResvSize-=t.part2_3_length+t.part2_length},this.ResvFrameEnd=function(e,t){var i,s=e.l3_side;e.ResvSize+=t*e.mode_gr;var r=0;s.resvDrain_post=0,s.resvDrain_pre=0,0!=(i=e.ResvSize%8)&&(r+=i),(i=e.ResvSize-r-e.ResvMax)>0&&(Ci(0==i%8),Ci(i>=0),r+=i);var a=Math.min(8*s.main_data_begin,r)/8;s.resvDrain_pre+=8*a,r-=8*a,e.ResvSize-=8*a,s.main_data_begin-=a,s.resvDrain_post+=r,e.ResvSize-=r}};a(Oi);var Di=function(){this.getLameVersion=function(){return"3.98.4"},this.getLameShortVersion=function(){return"3.98.4"},this.getLameVeryShortVersion=function(){return"LAME3.98r"},this.getPsyVersion=function(){return"0.93"},this.getLameUrl=function(){return"http://www.mp3dev.org/"},this.getLameOsBitness=function(){return"32bits"}};a(Di);var Li=B,Fi=Li.System,Vi=Li.VbrMode;Li.Float;var Hi=Li.ShortBlock;Li.Util;var Gi=Li.Arrays;Li.new_array_n;var Ui=Li.new_byte;Li.new_double,Li.new_float,Li.new_float_n,Li.new_int,Li.new_int_n;var qi=Li.assert;function Wi(){var e,t,i;this.setModules=function(s,r,a){e=s,t=r,i=a};var s=Wi.NUMTOCENTRIES,r=Wi.MAXFRAMESIZE,a=s+4+4+4+4+4+9+1+1+8+1+1+3+1+1+2+4+2+2,n="Xing",o="Info",l=[0,49345,49537,320,49921,960,640,49729,50689,1728,1920,51009,1280,50625,50305,1088,52225,3264,3456,52545,3840,53185,52865,3648,2560,51905,52097,2880,51457,2496,2176,51265,55297,6336,6528,55617,6912,56257,55937,6720,7680,57025,57217,8e3,56577,7616,7296,56385,5120,54465,54657,5440,55041,6080,5760,54849,53761,4800,4992,54081,4352,53697,53377,4160,61441,12480,12672,61761,13056,62401,62081,12864,13824,63169,63361,14144,62721,13760,13440,62529,15360,64705,64897,15680,65281,16320,16e3,65089,64001,15040,15232,64321,14592,63937,63617,14400,10240,59585,59777,10560,60161,11200,10880,59969,60929,11968,12160,61249,11520,60865,60545,11328,58369,9408,9600,58689,9984,59329,59009,9792,8704,58049,58241,9024,57601,8640,8320,57409,40961,24768,24960,41281,25344,41921,41601,25152,26112,42689,42881,26432,42241,26048,25728,42049,27648,44225,44417,27968,44801,28608,28288,44609,43521,27328,27520,43841,26880,43457,43137,26688,30720,47297,47489,31040,47873,31680,31360,47681,48641,32448,32640,48961,32e3,48577,48257,31808,46081,29888,30080,46401,30464,47041,46721,30272,29184,45761,45953,29504,45313,29120,28800,45121,20480,37057,37249,20800,37633,21440,21120,37441,38401,22208,22400,38721,21760,38337,38017,21568,39937,23744,23936,40257,24320,40897,40577,24128,23040,39617,39809,23360,39169,22976,22656,38977,34817,18624,18816,35137,19200,35777,35457,19008,19968,36545,36737,20288,36097,19904,19584,35905,17408,33985,34177,17728,34561,18368,18048,34369,33281,17088,17280,33601,16640,33217,32897,16448];function h(e,t){var i=255&e[t+0];return i<<=8,i|=255&e[t+1],i<<=8,i|=255&e[t+2],i<<=8,i|=255&e[t+3]}function _(e,t,i){e[t+0]=255&i>>24,e[t+1]=255&i>>16,e[t+2]=255&i>>8,e[t+3]=255&i}function u(e,t,i){e[t+0]=255&i>>8,e[t+1]=255&i}function c(e,t,i){return 255&(e<<t|i&~(-1<<t))}function f(t,i){var s=t.internal_flags;i[0]=c(i[0],8,255),i[1]=c(i[1],3,7),i[1]=c(i[1],1,t.out_samplerate<16e3?0:1),i[1]=c(i[1],1,t.version),i[1]=c(i[1],2,1),i[1]=c(i[1],1,t.error_protection?0:1),i[2]=c(i[2],4,s.bitrate_index),i[2]=c(i[2],2,s.samplerate_index),i[2]=c(i[2],1,0),i[2]=c(i[2],1,t.extension),i[3]=c(i[3],2,t.mode.ordinal()),i[3]=c(i[3],2,s.mode_ext),i[3]=c(i[3],1,t.copyright),i[3]=c(i[3],1,t.original),i[3]=c(i[3],2,t.emphasis),i[0]=255;var r,a,n=241&i[1];r=1==t.version?128:t.out_samplerate<16e3?32:64,t.VBR==Vi.vbr_off&&(r=t.brate),a=t.free_format?0:255&16*e.BitrateIndex(r,t.version,t.out_samplerate),1==t.version?(i[1]=255&n|10,n=13&i[2],i[2]=255&(a|n)):(i[1]=255&n|2,n=13&i[2],i[2]=255&(a|n))}function d(e,t){return t=t>>8^l[255&(t^e)]}this.addVbrFrame=function(e){var t=e.internal_flags,i=Tables.bitrate_table[e.version][t.bitrate_index];qi(null!=t.VBR_seek_table.bag),function(e,t){if(e.nVbrNumFrames++,e.sum+=t,e.seen++,!(e.seen<e.want)&&(e.pos<e.size&&(e.bag[e.pos]=e.sum,e.pos++,e.seen=0),e.pos==e.size)){for(var i=1;i<e.size;i+=2)e.bag[i/2]=e.bag[i];e.want*=2,e.pos/=2}}(t.VBR_seek_table,i)},this.getVbrTag=function(e){var t=new VBRTagData,i=0;t.flags=0;var r=e[i+1]>>3&1,a=e[i+2]>>2&3,l=e[i+3]>>6&3,_=e[i+2]>>4&15;if(_=Tables.bitrate_table[r][_],e[i+1]>>4==14?t.samprate=Tables.samplerate_table[2][a]:t.samprate=Tables.samplerate_table[r][a],!function(e,t){return new String(e,t,4(),null).equals(n)||new String(e,t,4(),null).equals(o)}(e,i+=0!=r?3!=l?36:21:3!=l?21:13))return null;i+=4,t.hId=r;var u=t.flags=h(e,i);if(i+=4,1&u&&(t.frames=h(e,i),i+=4),2&u&&(t.bytes=h(e,i),i+=4),4&u){if(null!=t.toc)for(var c=0;c<s;c++)t.toc[c]=e[i+c];i+=s}t.vbrScale=-1,8&u&&(t.vbrScale=h(e,i),i+=4),t.headersize=72e3*(r+1)*_/t.samprate;var f=e[(i+=21)+0]<<4;f+=e[i+1]>>4;var d=(15&e[i+1])<<8;return(f<0||f>3e3)&&(f=-1),((d+=255&e[i+2])<0||d>3e3)&&(d=-1),t.encDelay=f,t.encPadding=d,t},this.InitVbrTag=function(e){var i,s=e.internal_flags;i=1==e.version?128:e.out_samplerate<16e3?32:64,e.VBR==Vi.vbr_off&&(i=e.brate);var n=72e3*(e.version+1)*i/e.out_samplerate,o=s.sideinfo_len+a;if(s.VBR_seek_table.TotalFrameSize=n,n<o||n>r)e.bWriteVbrTag=!1;else{s.VBR_seek_table.nVbrNumFrames=0,s.VBR_seek_table.nBytesWritten=0,s.VBR_seek_table.sum=0,s.VBR_seek_table.seen=0,s.VBR_seek_table.want=1,s.VBR_seek_table.pos=0,null==s.VBR_seek_table.bag&&(s.VBR_seek_table.bag=new int[400],s.VBR_seek_table.size=400);var l=Ui(r);f(e,l);for(var h=s.VBR_seek_table.TotalFrameSize,_=0;_<h;++_)t.add_dummy_byte(e,255&l[_],1)}},this.updateMusicCRC=function(e,t,i,s){for(var r=0;r<s;++r)e[0]=d(t[i+r],e[0])},this.getLameTagFrame=function(e,r){var a=e.internal_flags;if(!e.bWriteVbrTag)return 0;if(a.Class_ID!=Lame.LAME_ID)return 0;if(a.VBR_seek_table.pos<=0)return 0;if(r.length<a.VBR_seek_table.TotalFrameSize)return a.VBR_seek_table.TotalFrameSize;Gi.fill(r,0,a.VBR_seek_table.TotalFrameSize,0),f(e,r);var l=Ui(s);if(e.free_format)for(var h=1;h<s;++h)l[h]=255&255*h/100;else!function(e,t){if(!(e.pos<=0))for(var i=1;i<s;++i){var r=i/s,a=0|Math.floor(r*e.pos);a>e.pos-1&&(a=e.pos-1);var n=0|256*e.bag[a]/e.sum;n>255&&(n=255),t[i]=255&n}}(a.VBR_seek_table,l);var c=a.sideinfo_len;e.error_protection&&(c-=2),e.VBR==Vi.vbr_off?(r[c++]=255&o.charAt(0),r[c++]=255&o.charAt(1),r[c++]=255&o.charAt(2),r[c++]=255&o.charAt(3)):(r[c++]=255&n.charAt(0),r[c++]=255&n.charAt(1),r[c++]=255&n.charAt(2),r[c++]=255&n.charAt(3)),_(r,c,15),_(r,c+=4,a.VBR_seek_table.nVbrNumFrames),c+=4;var p=a.VBR_seek_table.nBytesWritten+a.VBR_seek_table.TotalFrameSize;_(r,c,0|p),c+=4,Fi.arraycopy(l,0,r,c,l.length),c+=l.length,e.error_protection&&t.CRC_writeheader(a,r);var m=0;for(h=0;h<c;h++)m=d(r[h],m);return c+=function(e,t,s,r,a){var n,o,l,h,c,f=e.internal_flags,p=0,m=e.encoder_delay,b=e.encoder_padding,v=100-10*e.VBR_q-e.quality,g=i.getLameVeryShortVersion(),S=[1,5,3,2,4,0,3],E=0|(e.lowpassfreq/100+.5>255?255:e.lowpassfreq/100+.5),R=0,A=0,B=e.internal_flags.noise_shaping,w=0,T=0,M=0,y=!!(1&e.exp_nspsytune),k=!!(2&e.exp_nspsytune),P=!1,N=!1,I=e.internal_flags.nogap_total,x=e.internal_flags.nogap_current,C=e.ATHtype;switch(e.VBR){case vbr_abr:c=e.VBR_mean_bitrate_kbps;break;case vbr_off:c=e.brate;break;default:c=e.VBR_min_bitrate_kbps}switch(n=0+(e.VBR.ordinal()<S.length?S[e.VBR.ordinal()]:0),f.findReplayGain&&(f.RadioGain>510&&(f.RadioGain=510),f.RadioGain<-510&&(f.RadioGain=-510),A=8192,A|=3072,f.RadioGain>=0?A|=f.RadioGain:(A|=512,A|=-f.RadioGain)),f.findPeakSample&&(R=Math.abs(0|f.PeakSample/32767*Math.pow(2,23)+.5)),-1!=I&&(x>0&&(N=!0),x<I-1&&(P=!0)),h=C+((y?1:0)<<4)+((k?1:0)<<5)+((P?1:0)<<6)+((N?1:0)<<7),v<0&&(v=0),e.mode){case MONO:w=0;break;case STEREO:w=1;break;case DUAL_CHANNEL:w=2;break;case JOINT_STEREO:w=e.force_ms?4:3;break;case NOT_SET:default:w=7}M=e.in_samplerate<=32e3?0:48e3==e.in_samplerate?2:e.in_samplerate>48e3?3:1,(e.short_blocks==Hi.short_block_forced||e.short_blocks==Hi.short_block_dispensed||-1==e.lowpassfreq&&-1==e.highpassfreq||e.scale_left<e.scale_right||e.scale_left>e.scale_right||e.disable_reservoir&&e.brate<320||e.noATH||e.ATHonly||0==C||e.in_samplerate<=32e3)&&(T=1),o=B+(w<<2)+(T<<5)+(M<<6),l=f.nMusicCRC,_(s,r+p,v),p+=4;for(var O=0;O<9;O++)s[r+p+O]=255&g.charAt(O);s[r+(p+=9)]=255&n,s[r+ ++p]=255&E,_(s,r+ ++p,R),u(s,r+(p+=4),A),u(s,r+(p+=2),0),s[r+(p+=2)]=255&h,s[r+ ++p]=c>=255?255:255&c,s[r+ ++p]=255&m>>4,s[r+p+1]=255&(m<<4)+(b>>8),s[r+p+2]=255&b,s[r+(p+=3)]=255&o,p++,s[r+p++]=0,u(s,r+p,e.preset),_(s,r+(p+=2),t),u(s,r+(p+=4),l),p+=2;for(var D=0;D<p;D++)a=d(s[r+D],a);return u(s,r+p,a),p+2}(e,p,r,c,m),a.VBR_seek_table.TotalFrameSize},this.putVbrTag=function(e,t){if(e.internal_flags.VBR_seek_table.pos<=0)return-1;if(t.seek(t.length()),0==t.length())return-1;var i=function(e){e.seek(0);var t=Ui(10);return e.readFully(t),new String(t,"ISO-8859-1").startsWith("ID3")?0:((127&t[6])<<21|(127&t[7])<<14|(127&t[8])<<7|127&t[9])+t.length}(t);t.seek(i);var s=Ui(r),a=getLameTagFrame(e,s);return a>s.length?-1:(a<1||t.write(s,0,a),0)}}Wi.NUMTOCENTRIES=100,Wi.MAXFRAMESIZE=2880;var Xi=Wi;a(Xi);var Yi=B;Yi.System,Yi.VbrMode,Yi.Float,Yi.ShortBlock,Yi.Util,Yi.Arrays,Yi.new_array_n;var Ki=Yi.new_byte;Yi.new_double,Yi.new_float,Yi.new_float_n,Yi.new_int,Yi.new_int_n;var ji=Yi.assert,zi=hi,Zi=fi,Qi=We,Ji=Et,$i=xi,es=Nt,ts=Oi,is=Y,ss=Wt;T();var rs=Di,as=Xi;function ns(){this.setModules=function(e,t){}}function os(){this.setModules=function(e,t,i){}}function ls(){}function hs(){this.setModules=function(e,t){}}function _s(){this.dataOffset=0,this.dataLen=0,this.channels=0,this.sampleRate=0}function us(e){return e.charCodeAt(0)<<24|e.charCodeAt(1)<<16|e.charCodeAt(2)<<8|e.charCodeAt(3)}_s.RIFF=us("RIFF"),_s.WAVE=us("WAVE"),_s.fmt_=us("fmt "),_s.data=us("data"),_s.readHeader=function(e){var t=new _s,i=e.getUint32(0,!1);if(_s.RIFF==i&&(e.getUint32(4,!0),_s.WAVE==e.getUint32(8,!1)&&_s.fmt_==e.getUint32(12,!1))){var s=e.getUint32(16,!0),r=20;switch(s){case 16:case 18:t.channels=e.getUint16(r+2,!0),t.sampleRate=e.getUint32(r+4,!0);break;default:throw"extended fmt chunk not implemented"}r+=s;for(var a=_s.data,n=0;a!=i&&(i=e.getUint32(r,!1),n=e.getUint32(r+4,!0),a!=i);)r+=n+8;return t.dataLen=n,t.dataOffset=r+8,t}},n.Mp3Encoder=function(e,t,i){3!=arguments.length&&(console.error("WARN: Mp3Encoder(channels, samplerate, kbps) not specified"),e=1,t=44100,i=128);var s=new zi,r=new ns,a=new Qi,n=new ss,o=new Zi,l=new Ji,h=new $i,_=new as,u=new rs,c=new hs,f=new ts,d=new es,p=new os,m=new ls;s.setModules(a,n,o,l,h,_,u,c,m),n.setModules(a,m,u,_),c.setModules(n,u),o.setModules(s),h.setModules(n,f,l,d),l.setModules(d,f,s.enc.psy),f.setModules(n),d.setModules(l),_.setModules(s,n,u),r.setModules(p,m),p.setModules(u,c,o);var b=s.lame_init();b.num_channels=e,b.in_samplerate=t,b.brate=i,b.mode=is.STEREO,b.quality=3,b.bWriteVbrTag=!1,b.disable_reservoir=!0,b.write_id3tag_automatic=!1;var v=s.lame_init_params(b);ji(0==v);var g=1152,S=0|1.25*g+7200,E=Ki(S);this.encodeBuffer=function(t,i){1==e&&(i=t),ji(t.length==i.length),t.length>g&&(g=t.length,E=Ki(S=0|1.25*g+7200));var r=s.lame_encode_buffer(b,t,i,t.length,E,0,S);return new Int8Array(E.subarray(0,r))},this.flush=function(){var e=s.lame_encode_flush(b,E,0,S);return new Int8Array(E.subarray(0,e))}},n.WavHeader=_s,"undefined"!=typeof window&&(window.MPEGMode=K,window.Lame=_i,window.BitStream=Xt);const cs={calcAudioDuration:(e,t)=>{if(e){let i=e.duration+1;return t&&(i/=t),i}return 0},loadAudioBuffer:(t,i)=>e(void 0,void 0,void 0,(function*(){const e=yield cs.readAsArrayBufferPromisified(i),s=yield t.decodeAudioData(e);return cs.decodeBuffer(t,s)})),readAsArrayBufferPromisified:e=>new Promise(((t,i)=>{const s=new FileReader;s.onload=e=>{var s;const r=null===(s=null==e?void 0:e.target)||void 0===s?void 0:s.result;r instanceof ArrayBuffer?t(r):i()},e&&s.readAsArrayBuffer(e)})),decodeBuffer:(e,t)=>{if(1==t.numberOfChannels){e.resume();const i=t.duration,s=e.sampleRate,r=e.createBuffer(2,s*i+2*s,s),a=t.getChannelData(0),n=r.getChannelData(0),o=r.getChannelData(1);for(let e=0;e<a.length;e++)n[e]=a[e],o[e]=a[e];return r}return t},convertAudioBufferToFloat32Array:e=>{const t=[];for(let i=0;i<e.numberOfChannels;i++)t.push(e.getChannelData(i));return t},convertAudioParamToFloat32Array:(e,t)=>{const i=new Float32Array(t);for(let s=0;s<t;s++)i.set([e.value],s);return i},sumAudioBufferChannel:(e,t)=>e.getChannelData(t).reduce(((e,t)=>e+t),0),sumAudioBuffer(e){let t=0;for(let i=0;i<e.numberOfChannels;i++)t+=this.sumAudioBufferChannel(e,i);return t},isAudioWorkletCompatible:e=>void 0!==e&&void 0!==e.audioWorklet,isSettingValueValid:e=>!(void 0===e||isNaN(Number(e))||"string"==typeof e&&""===e.trim()),encodeMP3(e,t,i,s){const r=new n.Mp3Encoder(Math.max(2,t),i,s),a=[],o=this.floatArray2Int16(e[0]),l=this.floatArray2Int16(e[1]),h=r.encodeBuffer(o,l);a.push(h);const _=r.flush();return a.push(_),a},floatArray2Int16(e){const t=new Int16Array(e.length);for(let i=0,s=e.length;i<s;i++)e[i]<0?t[i]=32768*e[i]:t[i]=32767*e[i];return t}};class fs extends i{constructor(e,t,i,s){super(),this.frequencyBooster=200,this.frequencyReduce=200,this.dbBooster=15,this.dbReduce=-2,this.frequencyBooster=e,this.dbBooster=t,this.frequencyReduce=i,this.dbReduce=s}getNode(e){const t=e.createBiquadFilter();t.type="lowshelf",t.frequency.value=this.frequencyBooster,t.gain.value=this.dbBooster;const i=e.createBiquadFilter();return i.type="highshelf",i.frequency.value=this.frequencyReduce,i.gain.value=this.dbReduce,i.connect(t),{input:i,output:t}}get order(){return 3}get id(){return s.FILTERS_NAMES.BASS_BOOST}getSettings(){return{frequencyBooster:this.frequencyBooster,frequencyReduce:this.frequencyReduce,dbBooster:this.dbBooster,dbReduce:this.dbReduce}}setSetting(t,i){return e(this,void 0,void 0,(function*(){if(cs.isSettingValueValid(i))switch(t){case"frequencyBooster":this.frequencyBooster=parseInt(i);break;case"frequencyReduce":this.frequencyReduce=parseInt(i);break;case"dbBooster":this.dbBooster=parseInt(i);break;case"dbReduce":this.dbReduce=parseInt(i)}}))}}class ds{constructor(e,t){this._value=0,this._minValue=0,this._maxValue=Number.MAX_SAFE_INTEGER,this._defaultValue=0,this.context=null,this.automationRate="a-rate",this._defaultValue=void 0!==t?t:0,this._value=this._defaultValue,this.context=e}get value(){return this._value}set value(e){this._value=Math.max(this._minValue,Math.min(this._maxValue,e))}get minValue(){return this._minValue}get maxValue(){return this._maxValue}get defaultValue(){return this._defaultValue}setValueAtTime(e,t){return console.warn("setValueAtTime used with AudioParamPolyfill, is not fully compatible with standard AudioParam"),this.value=e,new ds(this.context,e)}linearRampToValueAtTime(e,t){return console.warn("linearRampToValueAtTime used with AudioParamPolyfill, is not fully compatible with standard AudioParam"),this.value=e,new ds(this.context,e)}exponentialRampToValueAtTime(e,t){return console.warn("exponentialRampToValueAtTime used with AudioParamPolyfill, is not fully compatible with standard AudioParam"),this.value=e,new ds(this.context,e)}cancelAndHoldAtTime(e){throw new Error("Method not implemented.")}cancelScheduledValues(e){throw new Error("Method not implemented.")}setTargetAtTime(e,t,i){throw new Error("Method not implemented.")}setValueCurveAtTime(e,t,i){throw new Error("Method not implemented.")}}class ps{constructor(e,t,i){this._parameters=new Map,this._port=null,this.currentContext=null,this.workletProcessor=t,this.currentContext=e,this._scriptProcessorNode=e.createScriptProcessor(i,2,2),this.setupPort(),this.setupProcessor(),this.setupWorkletScope(e)}setupPort(){const e=new MessageChannel;e.port1.onmessage=e=>{this.workletProcessor&&this.workletProcessor.port2&&this.workletProcessor.port2.postMessage(e.data)},this.workletProcessor&&this.workletProcessor.port2&&(this.workletProcessor.port2.onmessage=t=>{e.port1.postMessage(t.data)}),this._port=e.port2}setupProcessor(){if(!this._scriptProcessorNode)return;this._scriptProcessorNode.onaudioprocess=e=>{if(this.workletProcessor){const t=[cs.convertAudioBufferToFloat32Array(e.inputBuffer)],i=[cs.convertAudioBufferToFloat32Array(e.outputBuffer)],s=[];for(const[e,t]of this._parameters.entries())s.push([e,cs.convertAudioParamToFloat32Array(t,1)]);const r=Object.fromEntries(s);this.workletProcessor.process(t,i,r)}};const e=this.workletProcessor.defaultParameterDescriptors;e&&e.forEach((e=>{this.currentContext&&this._parameters.set(e.name,new ds(this.currentContext,e.defaultValue))}))}setupWorkletScope(e){"undefined"!=typeof window&&(window.sampleRate=e.sampleRate)}get port(){return this._port}get parameters(){return this._parameters}get node(){return this._scriptProcessorNode}get context(){var e;return null===(e=this._scriptProcessorNode)||void 0===e?void 0:e.context}}class ms{static registerProcessor(e,t){ms.processorsMap.set(e,t)}static getProcessor(e){const t=ms.processorsMap.get(e);return t?new t:null}}ms.processorsMap=new Map;class bs{constructor(){this.messageChannel=null,this.messageChannel=new MessageChannel}process(e,t,i){return!0}get port(){return this.messageChannel&&this.messageChannel.port1}get port2(){return this.messageChannel&&this.messageChannel.port2}get parameters(){throw new Error("Method not implemented.")}get parameterDescriptors(){throw new Error("Method not implemented.")}get defaultParameterDescriptors(){return[]}}"undefined"==typeof window||"AudioWorkletProcessor"in window||(window.AudioWorkletProcessor=bs,window.registerProcessor=ms.registerProcessor),"undefined"==typeof global||"AudioWorkletProcessor"in global||(global.AudioWorkletProcessor=bs,global.registerProcessor=ms.registerProcessor);class vs extends i{constructor(){super(...arguments),this.currentWorkletNode=null,this.fallbackToScriptProcessor=!1,this.keepCurrentNodeIfPossible=!1}initializeWorklet(t){return e(this,void 0,void 0,(function*(){if(this.stop(),!cs.isAudioWorkletCompatible(t))return console.error("Audio Worklets not supported on this browser. Fallback to ScriptProcessor"),void(this.fallbackToScriptProcessor=!0);const e=(this.configService?this.configService.getWorkletBasePath():"")+this.workletPath;yield t.audioWorklet.addModule(e).catch((t=>{console.error(`Error when loading Worklet (${e}) for filter ${this.id}. Fallback to ScriptProcessor. Exception:`,t),this.fallbackToScriptProcessor=!0}))}))}isAudioWorkletEnabled(){return this.configService?this.configService.isAudioWorkletEnabled():s.ENABLE_AUDIO_WORKLET}initializeNode(e,t){if(this.isAudioWorkletEnabled()&&!this.fallbackToScriptProcessor)this.currentWorkletNode=new AudioWorkletNode(e,t);else{const i=ms.getProcessor(t);if(!i)throw new Error(`No processor registered with name ${t} for filter ${this.id} to use the fallback/polyfill for AudioWorklet. Make sure you have created the class.`);this.currentWorkletNode=new ps(e,i,this.configService.getBufferSize())}this.currentWorkletNode&&this.currentWorkletNode.port&&(this.currentWorkletNode.port.onmessage=e=>this.receiveEvent(e))}applyCurrentSettingsToWorklet(){if(this.currentWorkletNode&&this.currentWorkletNode.parameters){const e=this.getSettings();for(const t of Object.keys(e)){const i=this.currentWorkletNode.parameters.get(t);i&&(i.value=e[t],i.setValueAtTime(e[t],0))}}}getNode(e){if(this.keepCurrentNodeIfPossible&&this.currentWorkletNode&&this.currentWorkletNode.context==e||(this.stop(),this.initializeNode(e,this.workletName)),this.applyCurrentSettingsToWorklet(),this.setEnabled(this.isEnabled()),this.currentWorkletNode)return this.currentWorkletNode instanceof ps?{input:this.currentWorkletNode.node,output:this.currentWorkletNode.node}:{input:this.currentWorkletNode,output:this.currentWorkletNode};throw new Error("Worklet node has not yet been created")}stop(){this.currentWorkletNode&&this.currentWorkletNode.port&&(this.currentWorkletNode.port.postMessage("stop"),this.currentWorkletNode.port.onmessage=null),this.currentWorkletNode=null}setEnabled(e){this.currentWorkletNode&&this.currentWorkletNode.port&&this.currentWorkletNode.port.postMessage(e?"enable":"disable"),super.setEnabled(e)}isWorklet(){return!0}}class gs extends AudioWorkletProcessor{constructor(){super(),this.stopped=!1,this.phaser=null,this.last=null,this.port.onmessage=e=>{"stop"==e.data&&this.stop()}}static get parameterDescriptors(){return[{name:"bits",defaultValue:16},{name:"normFreq",defaultValue:.9}]}get defaultParameterDescriptors(){return gs.parameterDescriptors}process(e,t,i){if(this.stopped)return!1;const s=e[0],r=t[0],a=2*Math.pow(.5,i.bits[0]),n=(1-i.normFreq[0])/(sampleRate/48e3);if(null==this.last&&(this.last=new Array(s.length).fill(0)),null==this.phaser&&(this.phaser=new Array(s.length).fill(0)),s&&s[0]){const e=s[0].length;for(let t=0;t<s.length;t++){const i=s[t],o=r[t];if(i&&o)for(let s=0;s<e;s++)this.phaser[t]+=n,this.phaser[t]>=1&&(this.phaser[t]-=1,this.last[t]=a*Math.floor(i[s]*(1/a)+.5)),o[s]=this.last[t]}}return!0}stop(){this.stopped=!0,this.phaser=null,this.last=null}}registerProcessor(s.WORKLET_NAMES.BITCRUSHER,gs);let Ss=class extends vs{constructor(e,t){super(),this.bits=16,this.normFreq=.9,this.bits=e,this.normFreq=t}receiveEvent(e){}get workletPath(){return s.WORKLET_PATHS.BITCRUSHER}get workletName(){return s.WORKLET_NAMES.BITCRUSHER}get order(){return 6}get id(){return s.FILTERS_NAMES.BITCRUSHER}getSettings(){return{bits:this.bits,normFreq:this.normFreq}}setSetting(t,i){return e(this,void 0,void 0,(function*(){if(cs.isSettingValueValid(i)){switch(t){case"bits":this.bits=parseInt(i);break;case"normFreq":this.normFreq=parseFloat(i)}this.applyCurrentSettingsToWorklet()}}))}};class Es extends i{constructor(e,t){super(),this.delay=.2,this.gain=.75,this.delay=e,this.gain=t}getNode(e){const t=e.createDelay(179);t.delayTime.value=this.delay;const i=e.createGain();return i.gain.value=this.gain,i.connect(t),t.connect(i),{input:i,output:t}}get order(){return 7}get id(){return s.FILTERS_NAMES.ECHO}getAddingTime(){return 5}getSettings(){return{delay:this.delay,gain:this.gain}}setSetting(t,i){return e(this,void 0,void 0,(function*(){if(cs.isSettingValueValid(i))switch(t){case"delay":this.delay=parseFloat(i);break;case"gain":this.gain=parseFloat(i)}}))}}class Rs extends i{constructor(e){super(),this.highFrequency=3500,this.highFrequency=e}getNode(e){const t=e.createBiquadFilter();return t.type="highpass",t.frequency.value=this.highFrequency,{input:t,output:t}}get order(){return 4}get id(){return s.FILTERS_NAMES.HIGH_PASS}getSettings(){return{highFrequency:this.highFrequency}}setSetting(t,i){return e(this,void 0,void 0,(function*(){if(cs.isSettingValueValid(i)&&"highFrequency"===t)this.highFrequency=parseInt(i)}))}}class As{constructor(e){this._array=new Float32Array,this.n=0,this.length=0,this.readPointer=0,this.writePointer=0,this.n=Math.floor(e),this.init()}init(){this._array=new Float32Array(2*this.n),this.length=this._array.length,this.readPointer=0,this.writePointer=this.n-1,this._array.fill(0)}read(){const e=this._array[this.readPointer%this.length];return this.readPointer=(this.readPointer+1)%this.length,e}push(e){this._array[this.writePointer%this.length]=e,this.writePointer=(this.writePointer+1)%this.length}reset(){this.init()}clear(){this._array=new Float32Array,this.length=0,this.readPointer=0,this.writePointer=0}sum(){return this._array.reduce(((e,t)=>e+t),0)}}class Bs extends AudioWorkletProcessor{constructor(){super(),this.delayBuffer=[],this.envelopeSample=0,this.stopped=!1,this.disabled=!1,this.port.onmessage=e=>{"reset"==e.data?this.reset():"stop"==e.data?this.stop():"disable"==e.data?this.disabled=!0:"enable"==e.data&&(this.disabled=!1)}}static get parameterDescriptors(){return[{name:"preGain",defaultValue:0},{name:"postGain",defaultValue:0},{name:"attackTime",defaultValue:0},{name:"releaseTime",defaultValue:3},{name:"threshold",defaultValue:-.05},{name:"lookAheadTime",defaultValue:0}]}get defaultParameterDescriptors(){return Bs.parameterDescriptors}getEnvelope(e,t,i,s){const r=Math.exp(-1/(s*t)),a=Math.exp(-1/(s*i)),n=new Float32Array(e.length);for(let t=0;t<e.length;t++){const i=Math.abs(e[t]);this.envelopeSample<i?this.envelopeSample=i+r*(this.envelopeSample-i):this.envelopeSample=i+a*(this.envelopeSample-i),n[t]=this.envelopeSample}return n}getMaxEnvelope(e,t,i){let s=e[0][i];for(let r=0;r<t;r++)e[r][i]>s&&(s=e[r][i]);return s}ampToDB(e){return 20*Math.log10(e)}dBToAmp(e){return Math.pow(10,e/20)}process(e,t,i){if(this.stopped)return!1;const s=e[0],r=t[0],a=[],n=this.dBToAmp(i.postGain[0]),o=this.dBToAmp(i.preGain[0]);for(let e=0;e<r.length;e++){const t=s[e],n=r[e];if(null==this.delayBuffer[e]&&(this.delayBuffer[e]=new As(i.lookAheadTime[0]*sampleRate)),t&&n)for(let e=0;e<t.length;++e)this.disabled?n[e]=t[e]:n[e]=o*t[e];!this.disabled&&n&&(a[e]=this.getEnvelope(n,i.attackTime[0],i.releaseTime[0],sampleRate))}for(let e=0;e<r.length;e++){const t=s[e],o=r[e];if(i.lookAheadTime[0]>0&&o)for(let t=0;t<o.length;t++)this.delayBuffer[e].push(o[t]),o[t]=this.delayBuffer[e].read();if(this.disabled)continue;const l=1;if(t&&o)for(let e=0;e<t.length;e++){let t=l*(i.threshold[0]-this.ampToDB(this.getMaxEnvelope(a,r.length,e)));t=Math.min(0,t);const s=this.dBToAmp(t);o[e]*=s*n}}return!0}reset(){for(let e=0;e<this.delayBuffer.length;e++)null!=this.delayBuffer[e]&&this.delayBuffer[e].reset();this.envelopeSample=0}stop(){for(let e=0;e<this.delayBuffer.length;e++)null!=this.delayBuffer[e]&&this.delayBuffer[e].clear();this.delayBuffer=[],this.envelopeSample=0,this.stopped=!0}}registerProcessor(s.WORKLET_NAMES.LIMITER,Bs);class ws extends vs{constructor(e,t,i,s,r,a){super(),this.preGain=0,this.postGain=0,this.attackTime=0,this.releaseTime=3,this.threshold=-.05,this.lookAheadTime=.1,this.preGain=e||this.preGain,this.postGain=t||this.postGain,this.attackTime=i||this.attackTime,this.releaseTime=s||this.releaseTime,this.threshold=r||this.threshold,this.lookAheadTime=a||this.lookAheadTime,this.keepCurrentNodeIfPossible=!0,this.enable(),this.setDefaultEnabled(!0)}receiveEvent(e){}get workletPath(){return s.WORKLET_PATHS.LIMITER}get workletName(){return s.WORKLET_NAMES.LIMITER}get order(){return 11}get id(){return s.FILTERS_NAMES.LIMITER}getAddingTime(){return this.lookAheadTime}getSettings(){return{preGain:this.preGain,postGain:this.postGain,attackTime:this.attackTime,releaseTime:this.releaseTime,threshold:this.threshold,lookAheadTime:this.lookAheadTime}}setSetting(t,i){return e(this,void 0,void 0,(function*(){if(cs.isSettingValueValid(i)){switch(t){case"preGain":this.preGain=parseFloat(i);break;case"postGain":this.postGain=parseFloat(i);break;case"attackTime":this.attackTime=parseFloat(i);break;case"releaseTime":this.releaseTime=parseFloat(i);break;case"threshold":this.threshold=parseFloat(i);break;case"lookAheadTime":this.lookAheadTime=parseFloat(i)}this.applyCurrentSettingsToWorklet()}}))}}class Ts extends i{constructor(e){super(),this.lowFrequency=3500,this.lowFrequency=e}getNode(e){const t=e.createBiquadFilter();return t.type="lowpass",t.frequency.value=this.lowFrequency,{input:t,output:t}}get order(){return 5}get id(){return s.FILTERS_NAMES.LOW_PASS}getSettings(){return{lowFrequency:this.lowFrequency}}setSetting(t,i){return e(this,void 0,void 0,(function*(){if(cs.isSettingValueValid(i)&&"lowFrequency"===t)this.lowFrequency=parseInt(i)}))}}class Ms extends t{}class ys extends Ms{renderAudio(e,t){return new Promise((i=>{const s=t.numberOfChannels,r=e.sampleRate*t.duration+2*e.sampleRate,a=e.createBuffer(s,r,e.sampleRate);for(let e=0;e<s;e++){const i=a.getChannelData(e),s=t.getChannelData(e);for(let e=0;e<r;e++)e<s.length?i[e]=s[s.length-1-e]:i[e]=0}i(a)}))}get order(){return 0}get id(){return s.FILTERS_NAMES.RETURN_AUDIO}}class ks extends i{constructor(){super(...arguments),this.reverbEnvironment=s.DEFAULT_REVERB_ENVIRONMENT,this.reverbCustomEnvironmentAddTime=5,this.customEnvironment=null}getNode(e){const t=e.createConvolver();this.reverbEnvironment&&("custom"!=this.reverbEnvironment.url||this.customEnvironment)||(this.reverbEnvironment=s.DEFAULT_REVERB_ENVIRONMENT);const i=this.getReverbBuffer(e);return i&&(t.buffer=i),{input:t,output:t}}getReverbBuffer(e){if("custom"==this.reverbEnvironment.url&&this.customEnvironment){if(this.customEnvironment.sampleRate===e.sampleRate)return this.customEnvironment;this.reverbEnvironment=s.DEFAULT_REVERB_ENVIRONMENT}else if(this.bufferFetcherService)return this.bufferFetcherService.getAudioBuffer(this.reverbEnvironment.url)}get order(){return 9}get id(){return s.FILTERS_NAMES.REVERB}getAddingTime(){const e=this.getSettings();if(e&&e.reverbEnvironment){if("custom"==e.reverbEnvironment.value)return this.reverbCustomEnvironmentAddTime;if(e.reverbEnvironment.additionalData)return e.reverbEnvironment.additionalData.addDuration}return 0}getSettings(){var e;return this.reverbEnvironment?{reverbEnvironment:{name:this.reverbEnvironment.name,value:this.reverbEnvironment.url,additionalData:{size:this.reverbEnvironment.size,link:this.reverbEnvironment.link,addDuration:this.reverbEnvironment.addDuration}},downloadedBuffers:null===(e=this.bufferFetcherService)||void 0===e?void 0:e.getDownloadedBuffersList(),hasCustomEnvironment:!!this.customEnvironment,reverbCustomEnvironmentAddTime:this.reverbCustomEnvironmentAddTime}:{reverbCustomEnvironmentAddTime:this.reverbCustomEnvironmentAddTime}}setSetting(t,i){return e(this,void 0,void 0,(function*(){var e;if("reverbEnvironment"==t){const t=i;if(t){const i=t.value;try{"custom"!=i&&(yield null===(e=this.bufferFetcherService)||void 0===e?void 0:e.fetchBuffer(i)),t.additionalData?this.reverbEnvironment={name:t.name,url:i,size:t.additionalData.size,addDuration:t.additionalData.addDuration,link:t.additionalData.link}:this.reverbEnvironment={name:t.name,url:i,size:0,addDuration:0,link:""}}catch(e){}}}else"reverbCustomEnvironmentAddTime"==t?cs.isSettingValueValid(i)&&(this.reverbCustomEnvironmentAddTime=parseInt(i)):"reverbCustomEnvironmentFile"==t&&this.bufferDecoderService&&i&&(this.customEnvironment=yield this.bufferDecoderService.decodeBufferFromFile(i),this.customEnvironment||(this.reverbEnvironment=s.DEFAULT_REVERB_ENVIRONMENT))}))}}class Ps{constructor(){this._vector=new Float32Array,this._position=0,this._frameCount=0}get vector(){return this._vector}get position(){return this._position}get startIndex(){return 2*this._position}get frameCount(){return this._frameCount}get endIndex(){return 2*(this._position+this._frameCount)}clear(){this.receive(this._frameCount),this.rewind()}put(e){this._frameCount+=e}putSamples(e,t,i=0){const s=2*(t=t||0);i>=0||(i=(e.length-s)/2);const r=2*i;this.ensureCapacity(i+this._frameCount);const a=this.endIndex;this.vector.set(e.subarray(s,s+r),a),this._frameCount+=i}putBuffer(e,t,i=0){t=t||0,i>=0||(i=e.frameCount-t),this.putSamples(e.vector,e.position+t,i)}receive(e){e>=0&&!(e>this._frameCount)||(e=this.frameCount),this._frameCount-=e,this._position+=e}receiveSamples(e,t=0){const i=2*t,s=this.startIndex;e.set(this._vector.subarray(s,s+i)),this.receive(t)}extract(e,t=0,i=0){const s=this.startIndex+2*t,r=2*i;e.set(this._vector.subarray(s,s+r))}ensureCapacity(e=0){const t=parseInt(2*e);if(this._vector.length<t){const e=new Float32Array(t);e.set(this._vector.subarray(this.startIndex,this.endIndex)),this._vector=e,this._position=0}else this.rewind()}ensureAdditionalCapacity(e=0){this.ensureCapacity(this._frameCount+e)}rewind(){this._position>0&&(this._vector.set(this._vector.subarray(this.startIndex,this.endIndex)),this._position=0)}}class Ns{constructor(e){e?(this._inputBuffer=new Ps,this._outputBuffer=new Ps):this._inputBuffer=this._outputBuffer=null}get inputBuffer(){return this._inputBuffer}set inputBuffer(e){this._inputBuffer=e}get outputBuffer(){return this._outputBuffer}set outputBuffer(e){this._outputBuffer=e}clear(){this._inputBuffer.clear(),this._outputBuffer.clear()}}class Is extends Ns{constructor(e){super(e),this.reset(),this._rate=1}set rate(e){this._rate=e}reset(){this.slopeCount=0,this.prevSampleL=0,this.prevSampleR=0}clone(){const e=new Is;return e.rate=this._rate,e}process(){const e=this._inputBuffer.frameCount;this._outputBuffer.ensureAdditionalCapacity(e/this._rate+1);const t=this.transpose(e);this._inputBuffer.receive(),this._outputBuffer.put(t)}transpose(e=0){if(0===e)return 0;const t=this._inputBuffer.vector,i=this._inputBuffer.startIndex,s=this._outputBuffer.vector,r=this._outputBuffer.endIndex;let a=0,n=0;for(;this.slopeCount<1;)s[r+2*n]=(1-this.slopeCount)*this.prevSampleL+this.slopeCount*t[i],s[r+2*n+1]=(1-this.slopeCount)*this.prevSampleR+this.slopeCount*t[i+1],n+=1,this.slopeCount+=this._rate;if(this.slopeCount-=1,1!==e)e:for(;;){for(;this.slopeCount>1;)if(this.slopeCount-=1,a+=1,a>=e-1)break e;const o=i+2*a;s[r+2*n]=(1-this.slopeCount)*t[o]+this.slopeCount*t[o+2],s[r+2*n+1]=(1-this.slopeCount)*t[o+1]+this.slopeCount*t[o+3],n+=1,this.slopeCount+=this._rate}return this.prevSampleL=t[i+2*e-2],this.prevSampleR=t[i+2*e-1],n}}class xs{constructor(e){this._pipe=e}get pipe(){return this._pipe}get inputBuffer(){return this._pipe.inputBuffer}get outputBuffer(){return this._pipe.outputBuffer}fillInputBuffer(){throw new Error("fillInputBuffer() not overridden")}fillOutputBuffer(e=0){for(;this.outputBuffer.frameCount<e;){const e=16384-this.inputBuffer.frameCount;if(this.fillInputBuffer(e),this.inputBuffer.frameCount<16384)break;this._pipe.process()}}clear(){this._pipe.clear()}}const Cs=function(){};class Os extends xs{constructor(e,t,i=Cs){super(t),this.callback=i,this.sourceSound=e,this.historyBufferSize=22050,this._sourcePosition=0,this.outputBufferPosition=0,this._position=0}get position(){return this._position}set position(e){if(e>this._position)throw new RangeError("New position may not be greater than current position");const t=this.outputBufferPosition-(this._position-e);if(t<0)throw new RangeError("New position falls outside of history buffer");this.outputBufferPosition=t,this._position=e}get sourcePosition(){return this._sourcePosition}set sourcePosition(e){this.clear(),this._sourcePosition=e}onEnd(){this.callback()}fillInputBuffer(e=0){const t=new Float32Array(2*e),i=this.sourceSound.extract(t,e,this._sourcePosition);this._sourcePosition+=i,this.inputBuffer.putSamples(t,0,i)}extract(e,t=0){this.fillOutputBuffer(this.outputBufferPosition+t);const i=Math.min(t,this.outputBuffer.frameCount-this.outputBufferPosition);this.outputBuffer.extract(e,this.outputBufferPosition,i);const s=this.outputBufferPosition+i;return this.outputBufferPosition=Math.min(this.historyBufferSize,s),this.outputBuffer.receive(Math.max(s-this.historyBufferSize,0)),this._position+=i,i}handleSampleData(e){this.extract(e.data,4096)}clear(){super.clear(),this.outputBufferPosition=0}}const Ds=[[124,186,248,310,372,434,496,558,620,682,744,806,868,930,992,1054,1116,1178,1240,1302,1364,1426,1488,0],[-100,-75,-50,-25,25,50,75,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[-20,-15,-10,-5,5,10,15,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[-4,-3,-2,-1,1,2,3,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],Ls=-10/1.5;class Fs extends Ns{constructor(e){super(e),this._quickSeek=!0,this.midBufferDirty=!1,this.midBuffer=null,this.overlapLength=0,this.autoSeqSetting=!0,this.autoSeekSetting=!0,this._tempo=1,this.setParameters(44100,0,0,8)}clear(){super.clear(),this.clearMidBuffer()}clearMidBuffer(){this.midBufferDirty&&(this.midBufferDirty=!1,this.midBuffer=null)}setParameters(e,t,i,s){e>0&&(this.sampleRate=e),s>0&&(this.overlapMs=s),t>0?(this.sequenceMs=t,this.autoSeqSetting=!1):this.autoSeqSetting=!0,i>0?(this.seekWindowMs=i,this.autoSeekSetting=!1):this.autoSeekSetting=!0,this.calculateSequenceParameters(),this.calculateOverlapLength(this.overlapMs),this.tempo=this._tempo}set tempo(e){let t;this._tempo=e,this.calculateSequenceParameters(),this.nominalSkip=this._tempo*(this.seekWindowLength-this.overlapLength),this.skipFract=0,t=Math.floor(this.nominalSkip+.5),this.sampleReq=Math.max(t+this.overlapLength,this.seekWindowLength)+this.seekLength}get tempo(){return this._tempo}get inputChunkSize(){return this.sampleReq}get outputChunkSize(){return this.overlapLength+Math.max(0,this.seekWindowLength-2*this.overlapLength)}calculateOverlapLength(e=0){let t;t=this.sampleRate*e/1e3,t=t<16?16:t,t-=t%8,this.overlapLength=t,this.refMidBuffer=new Float32Array(2*this.overlapLength),this.midBuffer=new Float32Array(2*this.overlapLength)}checkLimits(e,t,i){return e<t?t:e>i?i:e}calculateSequenceParameters(){let e,t;this.autoSeqSetting&&(e=150+-50*this._tempo,e=this.checkLimits(e,50,125),this.sequenceMs=Math.floor(e+.5)),this.autoSeekSetting&&(t=28.333333333333332+Ls*this._tempo,t=this.checkLimits(t,15,25),this.seekWindowMs=Math.floor(t+.5)),this.seekWindowLength=Math.floor(this.sampleRate*this.sequenceMs/1e3),this.seekLength=Math.floor(this.sampleRate*this.seekWindowMs/1e3)}set quickSeek(e){this._quickSeek=e}clone(){const e=new Fs;return e.tempo=this._tempo,e.setParameters(this.sampleRate,this.sequenceMs,this.seekWindowMs,this.overlapMs),e}seekBestOverlapPosition(){return this._quickSeek?this.seekBestOverlapPositionStereoQuick():this.seekBestOverlapPositionStereo()}seekBestOverlapPositionStereo(){let e,t,i,s=0;for(this.preCalculateCorrelationReferenceStereo(),e=0,t=Number.MIN_VALUE;s<this.seekLength;s+=1)i=this.calculateCrossCorrelationStereo(2*s,this.refMidBuffer),i>t&&(t=i,e=s);return e}seekBestOverlapPositionStereoQuick(){let e,t,i,s,r,a=0;for(this.preCalculateCorrelationReferenceStereo(),t=Number.MIN_VALUE,e=0,s=0,r=0;a<4;a+=1){let n=0;for(;Ds[a][n]&&(r=s+Ds[a][n],!(r>=this.seekLength));)i=this.calculateCrossCorrelationStereo(2*r,this.refMidBuffer),i>t&&(t=i,e=r),n+=1;s=e}return e}preCalculateCorrelationReferenceStereo(){let e,t,i=0;for(;i<this.overlapLength;i+=1)t=i*(this.overlapLength-i),e=2*i,this.refMidBuffer[e]=this.midBuffer[e]*t,this.refMidBuffer[e+1]=this.midBuffer[e+1]*t}calculateCrossCorrelationStereo(e,t){const i=this._inputBuffer.vector;e+=this._inputBuffer.startIndex;let s=0,r=2;const a=2*this.overlapLength;let n;for(;r<a;r+=2)n=r+e,s+=i[n]*t[r]+i[n+1]*t[r+1];return s}overlap(e){this.overlapStereo(2*e)}overlapStereo(e){const t=this._inputBuffer.vector;e+=this._inputBuffer.startIndex;const i=this._outputBuffer.vector,s=this._outputBuffer.endIndex;let r,a,n=0;const o=1/this.overlapLength;let l,h,_;for(;n<this.overlapLength;n+=1)a=(this.overlapLength-n)*o,l=n*o,r=2*n,h=r+e,_=r+s,i[_+0]=t[h+0]*l+this.midBuffer[r+0]*a,i[_+1]=t[h+1]*l+this.midBuffer[r+1]*a}process(){let e,t,i;if(null===this.midBuffer){if(this._inputBuffer.frameCount<this.overlapLength)return;this.midBuffer=new Float32Array(2*this.overlapLength),this._inputBuffer.receiveSamples(this.midBuffer,this.overlapLength)}for(;this._inputBuffer.frameCount>=this.sampleReq;){e=this.seekBestOverlapPosition(),this._outputBuffer.ensureAdditionalCapacity(this.overlapLength),this.overlap(Math.floor(e)),this._outputBuffer.put(this.overlapLength),t=this.seekWindowLength-2*this.overlapLength,t>0&&this._outputBuffer.putBuffer(this._inputBuffer,e+this.overlapLength,t);const s=this._inputBuffer.startIndex+2*(e+this.seekWindowLength-this.overlapLength);this.midBuffer.set(this._inputBuffer.vector.subarray(s,s+2*this.overlapLength)),this.skipFract+=this.nominalSkip,i=Math.floor(this.skipFract),this.skipFract-=i,this._inputBuffer.receive(i)}}}const Vs=function(e,t){return(e>t?e-t:t-e)>1e-10};class Hs{constructor(){this.transposer=new Is(!1),this.stretch=new Fs(!1),this._inputBuffer=new Ps,this._intermediateBuffer=new Ps,this._outputBuffer=new Ps,this._rate=0,this._tempo=0,this.virtualPitch=1,this.virtualRate=1,this.virtualTempo=1,this.calculateEffectiveRateAndTempo()}clear(){this.transposer.clear(),this.stretch.clear()}clone(){const e=new Hs;return e.rate=this.rate,e.tempo=this.tempo,e}get rate(){return this._rate}set rate(e){this.virtualRate=e,this.calculateEffectiveRateAndTempo()}set rateChange(e){this._rate=1+.01*e}get tempo(){return this._tempo}set tempo(e){this.virtualTempo=e,this.calculateEffectiveRateAndTempo()}set tempoChange(e){this.tempo=1+.01*e}set pitch(e){this.virtualPitch=e,this.calculateEffectiveRateAndTempo()}set pitchOctaves(e){this.pitch=Math.exp(.69314718056*e),this.calculateEffectiveRateAndTempo()}set pitchSemitones(e){this.pitchOctaves=e/12}get inputBuffer(){return this._inputBuffer}get outputBuffer(){return this._outputBuffer}calculateEffectiveRateAndTempo(){const e=this._tempo,t=this._rate;this._tempo=this.virtualTempo/this.virtualPitch,this._rate=this.virtualRate*this.virtualPitch,Vs(this._tempo,e)&&(this.stretch.tempo=this._tempo),Vs(this._rate,t)&&(this.transposer.rate=this._rate),this._rate>1?this._outputBuffer!=this.transposer.outputBuffer&&(this.stretch.inputBuffer=this._inputBuffer,this.stretch.outputBuffer=this._intermediateBuffer,this.transposer.inputBuffer=this._intermediateBuffer,this.transposer.outputBuffer=this._outputBuffer):this._outputBuffer!=this.stretch.outputBuffer&&(this.transposer.inputBuffer=this._inputBuffer,this.transposer.outputBuffer=this._intermediateBuffer,this.stretch.inputBuffer=this._intermediateBuffer,this.stretch.outputBuffer=this._outputBuffer)}process(){this._rate>1?(this.stretch.process(),this.transposer.process()):(this.transposer.process(),this.stretch.process())}}class Gs{constructor(e){this.buffer=e,this._position=0}get dualChannel(){return this.buffer.numberOfChannels>1}get position(){return this._position}set position(e){this._position=e}extract(e,t=0,i=0){this.position=i;let s=this.buffer.getChannelData(0),r=this.dualChannel?this.buffer.getChannelData(1):this.buffer.getChannelData(0),a=0;for(;a<t;a++)e[2*a]=s[a+i],e[2*a+1]=r[a+i];return Math.min(t,s.length-i)}}const Us=function(e){const t=Math.floor(e/60);return`${t}:${i=parseInt(e-60*t),s=2,r=r||"0",(i+="").length>=s?i:new Array(s-i.length+1).join(r)+i}`;var i,s,r},qs=function(e){const t=this.timePlayed,i=this.sampleRate;if(this.sourcePosition=e,this.timePlayed=e/i,t!==this.timePlayed){const e=new CustomEvent("play",{detail:{timePlayed:this.timePlayed,formattedTimePlayed:this.formattedTimePlayed,percentagePlayed:this.percentagePlayed}});this._node.dispatchEvent(e)}};class Ws{constructor(e,t,i,s=Cs){this._soundtouch=new Hs;const r=new Gs(t);this.timePlayed=0,this.sourcePosition=0,this._filter=new Os(r,this._soundtouch,s),this._node=function(e,t,i=Cs,s=4096){const r=e.createScriptProcessor(s,2,2),a=new Float32Array(2*s);return r.onaudioprocess=e=>{let r=e.outputBuffer.getChannelData(0),n=e.outputBuffer.getChannelData(1),o=t.extract(a,s);i(t.sourcePosition),0===o&&t.onEnd();let l=0;for(;l<o;l++)r[l]=a[2*l],n[l]=a[2*l+1]},r}(e,this._filter,(e=>qs.call(this,e)),i),this.tempo=1,this.rate=1,this.duration=t.duration,this.sampleRate=e.sampleRate,this.listeners=[]}get formattedDuration(){return Us(this.duration)}get formattedTimePlayed(){return Us(this.timePlayed)}get percentagePlayed(){return 100*this._filter.sourcePosition/(this.duration*this.sampleRate)}set percentagePlayed(e){this._filter.sourcePosition=parseInt(e*this.duration*this.sampleRate),this.sourcePosition=this._filter.sourcePosition,this.timePlayed=this.sourcePosition/this.sampleRate}get node(){return this._node}set pitch(e){this._soundtouch.pitch=e}set pitchSemitones(e){this._soundtouch.pitchSemitones=e}set rate(e){this._soundtouch.rate=e}set tempo(e){this._soundtouch.tempo=e}connect(e){this._node.connect(e)}disconnect(){this._node.disconnect()}on(e,t){this.listeners.push({name:e,cb:t}),this._node.addEventListener(e,(e=>t(e.detail)))}off(e=null){let t=this.listeners;e&&(t=t.filter((t=>t.name===e))),t.forEach((e=>{this._node.removeEventListener(e.name,(t=>e.cb(t.detail)))}))}}let Xs;"undefined"!=typeof window&&void 0!==window.AudioWorkletNode&&(Xs=class extends AudioWorkletNode{constructor(e,t,i){super(e,t,i),this.name="",this.running=!1,this._tempo=1,this._pitch=1,this.name=this.constructor.name,this.running=!0,this.updateInterval=i.processorOptions.updateInterval}setup(t,i){return e(this,void 0,void 0,(function*(){return new Promise((e=>{this.port&&(this.port.onmessage=t=>{t&&t.data&&"OK"===t.data.status&&"setup"===t.data.args[0]&&(this.port.onmessage=this.messageProcessor.bind(this),e())},this.port.postMessage({command:"setup",args:[t,i]}),this._tempo=t,this._pitch=i)}))}))}set updateInterval(e){this.port.postMessage({command:"updateInterval",args:[e]})}get node(){return this}set tempo(e){this.port.postMessage({command:"setTempo",args:[e]})}set pitch(e){this.port.postMessage({command:"setPitch",args:[e]})}get tempo(){return this.port.postMessage({command:"getTempo",args:[]}),this._tempo}get pitch(){return this.port.postMessage({command:"getPitch",args:[]}),this._pitch}stop(){return e(this,void 0,void 0,(function*(){this.running&&(this.port.postMessage({command:"stop",args:[]}),this.disconnect(),this.running=!1)}))}messageProcessor(e){if(e.data.command){const{command:t}=e.data;if("End"===t)this.stop();if(e.data.status){const t=e.data.args[1];switch(e.data.args[0]){case"getTempo":this._tempo=t;break;case"getPitch":this._pitch=t}return}}}});var Ys,Ks=Xs;class js extends vs{constructor(){super(),this.speedAudio=1,this.frequencyAudio=1,this.currentSpeedAudio=1,this.isOfflineMode=!1,this.enable(),this.setDefaultEnabled(!0)}initializeWorklet(){return e(this,void 0,void 0,(function*(){}))}receiveEvent(e){}get workletPath(){return s.WORKLET_PATHS.SOUNDTOUCH}constructAudioWorkletProcessor(){throw new Error("Method not implemented.")}get workletName(){return s.WORKLET_NAMES.SOUNDTOUCH}getEntrypointNode(t,i,s){return e(this,void 0,void 0,(function*(){if(this.isOfflineMode=s,this.cleanUpOldNodes(),s){if(!this.isEnabled()||1==this.speedAudio&&1==this.frequencyAudio){const e=t.createBufferSource();return e.buffer=i,e.start(),{input:e,output:e}}return this.isAudioWorkletEnabled()&&cs.isAudioWorkletCompatible(t)&&1==this.speedAudio?this.renderWithWorklet(i,t):this.renderWithScriptProcessorNode(i,t)}return this.currentPitchShifter=this.getSoundtouchScriptProcessorNode(i,t),this.updateState(),{input:this.currentPitchShifter,output:this.currentPitchShifter}}))}cleanUpOldNodes(){this.currentPitchShifterWorklet&&(this.currentPitchShifterWorklet.stop(),this.currentPitchShifterWorklet.disconnect()),this.currentPitchShifter&&(this.currentPitchShifter.disconnect(),this.currentPitchShifter._filter=null)}getSoundtouchScriptProcessorNode(e,t){return new Ws(t,e,s.SOUNDTOUCH_PITCH_SHIFTER_BUFFER_SIZE)}renderWithScriptProcessorNode(t,i){return e(this,void 0,void 0,(function*(){const e=cs.calcAudioDuration(t,this.speedAudio),s=new OfflineAudioContext(2,i.sampleRate*e,i.sampleRate);this.currentPitchShifter=this.getSoundtouchScriptProcessorNode(t,s),this.updateState(),this.currentPitchShifter.connect(s.destination);const r=yield s.startRendering(),a=i.createBufferSource();return a.buffer=r,a.start(),this.cleanUpOldNodes(),{input:a,output:a}}))}renderWithWorklet(t,i){return e(this,void 0,void 0,(function*(){const e=cs.calcAudioDuration(t,this.speedAudio);try{yield i.audioWorklet.addModule((this.configService?this.configService.getWorkletBasePath():"")+s.WORKLET_PATHS.SOUNDTOUCH);const r=i.createBufferSource();return r.buffer=t,r.start(),this.currentPitchShifterWorklet=new Ks(i,"soundtouch-worklet",{processorOptions:{bypass:!1,recording:!1,nInputFrames:this.approximateNInputFrames(e,i),updateInterval:10,sampleRate:t.sampleRate}}),r.connect(this.currentPitchShifterWorklet.node),this.isEnabled()?yield this.currentPitchShifterWorklet.setup(this.speedAudio,this.frequencyAudio):yield this.currentPitchShifterWorklet.setup(1,1),{input:this.currentPitchShifterWorklet,output:this.currentPitchShifterWorklet}}catch(e){return console.error(e),this.renderWithScriptProcessorNode(t,i)}}))}approximateNInputFrames(e,t){return e*t.sampleRate*(Math.round(14*Math.exp(-4*this.frequencyAudio))+1)}get order(){return 2}get id(){return s.FILTERS_NAMES.SOUNDTOUCH}getSettings(){return{speedAudio:this.speedAudio,frequencyAudio:this.frequencyAudio}}isAudioWorkletEnabled(){return this.configService?this.configService.isSoundtouchAudioWorkletEnabled():s.ENABLE_SOUNDTOUCH_AUDIO_WORKLET}getCurrentPitchShifter(){return this.isOfflineMode?1==this.speedAudio&&1==this.frequencyAudio?null:this.isAudioWorkletEnabled()&&this.currentPitchShifterWorklet&&1==this.speedAudio?this.currentPitchShifterWorklet:this.currentPitchShifter:this.currentPitchShifter}updateState(){const e=this.getCurrentPitchShifter();this.isEnabled()?(e&&(e.pitch=this.frequencyAudio,e.tempo=this.speedAudio),this.currentSpeedAudio=this.speedAudio):(e&&(e.pitch=1,e.tempo=1),this.currentSpeedAudio=1)}setSetting(t,i){return e(this,void 0,void 0,(function*(){if(!cs.isSettingValueValid(i))return;const e=parseFloat(i);switch(t){case"speedAudio":this.speedAudio=e;break;case"frequencyAudio":this.frequencyAudio=e}this.updateState()}))}setEnabled(e){super.setEnabled(e),this.updateState()}getSpeed(){return this.currentSpeedAudio}}class zs extends i{getNode(e){const t=e.createBiquadFilter();t.type="lowpass",t.frequency.value=2e3;const i=e.createBiquadFilter();i.type="lowpass",i.frequency.value=2e3;const s=e.createBiquadFilter();s.type="highpass",s.frequency.value=500;const r=e.createBiquadFilter();return r.type="highpass",r.frequency.value=500,t.connect(i),i.connect(s),s.connect(r),{input:t,output:r}}get order(){return 7}get id(){return s.FILTERS_NAMES.TELEPHONIZER}getSettings(){return{}}setSetting(t,i){return e(this,void 0,void 0,(function*(){}))}}class Zs{constructor(){this.listeners={},this.listeners={}}on(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}emit(e,t){this.listeners[e]&&this.listeners[e].forEach((e=>{e(t)}))}off(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter((e=>e!==t)))}}!function(e){e.LOADING_BUFFERS="loadingBuffers",e.LOADING_BUFFERS_ERROR="loadingBuffersError",e.FETCHING_BUFFERS="fetchingBuffers",e.FETCHING_BUFFERS_ERROR="fetchingBuffersError",e.FINISHED_FETCHING_BUFFERS="finishedFetchingBuffers",e.LOADED_BUFFERS="loadedBuffers",e.COMPATIBILITY_MODE_AUTO_ENABLED="compatibilityModeAutoEnabled",e.RENDERING_AUDIO_PROBLEM_DETECTED="renderingAudioProblemDetected",e.AUDIO_RENDERING_FINISHED="audioRenderingFinished",e.OFFLINE_AUDIO_RENDERING_FINISHED="offlineAudioRenderingFinished",e.PLAYING_STOPPED="playingStopped",e.PLAYING_STARTED="playingStarted",e.PLAYING_FINISHED="playingFinished",e.PLAYING_UPDATE="playingUpdate",e.RECORDER_INIT="recorderInit",e.RECORDER_SUCCESS="recorderSuccess",e.RECORDER_ERROR="recorderError",e.RECORDER_UPDATE_CONSTRAINTS="recorderUpdateConstraints",e.RECORDER_RECORDING="recorderRecording",e.RECORDER_STOPPED="recorderStopped",e.RECORDER_PAUSED="recorderPaused",e.RECORDER_RESETED="recorderReseted",e.RECORDER_COUNT_UPDATE="recorderCountUpdate",e.SAMPLE_RATE_CHANGED="sampleRateChanged",e.DECODING_AUDIO_FILE="decodingAudioFile",e.DECODED_AUDIO_FILE="decodedAudioFile",e.ERROR_DECODING_AUDIO_FILE="errorDecodingAudioFile",e.RECORDER_NOT_FOUND_ERROR="recorderNotFoundError",e.RECORDER_UNKNOWN_ERROR="recorderUnknownError",e.UPDATE_AUDIO_TREATMENT_PERCENT="updateAudioTreatmentPercent",e.UPDATE_REMAINING_TIME_ESTIMATED="updateRemainingTimeEstimated",e.CANCELLED_AND_LOADED_INITIAL_AUDIO="cancelledAndLoadedInitialAudio",e.CANCELLING_AUDIO_PROCESSING="cancellingAudioProcessing"}(Ys||(Ys={}));class Qs extends t{constructor(t,i){super(),this.context=null,this.buffer=null,this.source=null,this.currentTime=0,this.displayTime=0,this.duration=0,this.interval=null,this.playing=!1,this.loop=!1,this.speedAudio=1,this.onBeforePlayingCallback=()=>e(this,void 0,void 0,(function*(){})),this.compatibilityMode=!1,this.currentNode=null,this.context=t,this.eventEmitter=i||new Zs}init(e){this.playing=!1,this.context&&(this.context.resume(),!this.compatibilityMode&&this.buffer&&(null==this.source||e||this.source.disconnect(),this.source=this.context.createBufferSource(),this.source.buffer=this.buffer,this.duration=this.buffer.duration*this.speedAudio,this.source.connect(this.context.destination))),this.updateInfos()}loadBuffer(e){this.compatibilityMode=!1,this.reset(),this.buffer=e,this.init()}setCompatibilityMode(e,t){this.compatibilityMode=!0,this.reset(),this.init(),null!=t&&(this.duration=t*this.speedAudio),this.currentNode=e,this.updateInfos()}reset(e){clearInterval(this.interval),this.currentTime=0,this.displayTime=0,e||this.stop()}stop(){var e;clearInterval(this.interval),null!=this.source&&null!=this.source&&this.playing&&(this.source.stop(0),this.playing=!1),this.currentNode&&(this.currentNode.disconnect(),this.compatibilityMode&&(this.currentTime=0,this.displayTime=0)),null===(e=this.eventEmitter)||void 0===e||e.emit(Ys.PLAYING_STOPPED),this.updateInfos()}start(t){return e(this,void 0,void 0,(function*(){var e;if(this.source||this.compatibilityMode){if(t||this.stop(),this.init(t),yield this.onBeforePlayingCallback(),null===(e=this.eventEmitter)||void 0===e||e.emit(Ys.PLAYING_STARTED),this.compatibilityMode){if(!this.currentNode||!this.context)return;this.currentNode.connect(this.context.destination)}else{if(!this.source)return;this.source.start(0,t?0:this.currentTime/this.speedAudio),this.playing=!0}let i=performance.now();this.interval=window.setInterval((()=>{var e,s;const r=performance.now(),a=r-i;i=r,this.currentTime+=a/1e3*this.speedAudio,this.displayTime=this.currentTime,this.currentTime>this.duration?this.loop?this.compatibilityMode?null===(e=this.eventEmitter)||void 0===e||e.emit(Ys.PLAYING_FINISHED):(this.reset(t),this.start()):(null===(s=this.eventEmitter)||void 0===s||s.emit(Ys.PLAYING_FINISHED),this.reset(t)):this.updateInfos()}),100)}}))}playDirect(){return e(this,void 0,void 0,(function*(){this.compatibilityMode?this.start(!1):this.start(!0)}))}pause(){this.stop()}updateInfos(){var e;null===(e=this.eventEmitter)||void 0===e||e.emit(Ys.PLAYING_UPDATE)}setTimePercent(e){this.compatibilityMode||(this.currentTime=Math.round(this.duration*(e/100)),this.displayTime=this.currentTime,this.playing?(this.pause(),this.start()):this.updateInfos())}setTime(e){this.compatibilityMode||(this.currentTime=e,this.displayTime=this.currentTime,this.playing?(this.pause(),this.start()):this.updateInfos())}onBeforePlaying(e){this.onBeforePlayingCallback=e}toggleLoop(){this.loop=!this.loop}on(e,t){var i;null===(i=this.eventEmitter)||void 0===i||i.on(e,t)}updateContext(e){this.context=e}get currentTimeDisplay(){return("0"+Math.trunc(this.displayTime/60)).slice(-2)+":"+("0"+Math.trunc(this.displayTime%60)).slice(-2)}get maxTimeDisplay(){return("0"+Math.trunc(this.duration/60)).slice(-2)+":"+("0"+Math.trunc(this.duration%60)).slice(-2)}get percent(){return 100-Math.round((this.duration-this.displayTime)/this.duration*100)}get remainingTimeDisplay(){return("0"+Math.trunc((this.duration-this.displayTime)/60)).slice(-2)+":"+("0"+Math.trunc((this.duration-this.displayTime)%60)).slice(-2)}get order(){return-1}get id(){return s.BUFFER_PLAYER}}class Js{constructor(e,t,i){this.buffers=new Map,this.bufferErrors=[],this.configService=null,this.context=e,this.eventEmitter=i||new Zs,this.configService=t}fetchBuffer(t,i){return e(this,void 0,void 0,(function*(){var e,s,r,a;const n=(this.configService?this.configService.getSoundBasePath():"")+t;if(null==this.buffers.get(this.getKeyFromLocation(n))||i){null===(e=this.eventEmitter)||void 0===e||e.emit(Ys.FETCHING_BUFFERS,n);try{const e=yield fetch(n);if(!e.ok)throw this.bufferErrors.push(n),null===(s=this.eventEmitter)||void 0===s||s.emit(Ys.FETCHING_BUFFERS_ERROR,n),Ys.FETCHING_BUFFERS_ERROR;{const t=yield e.arrayBuffer(),i=yield this.context.decodeAudioData(t);this.buffers.set(this.getKeyFromLocation(n),yield cs.decodeBuffer(this.context,i))}null===(r=this.eventEmitter)||void 0===r||r.emit(Ys.FINISHED_FETCHING_BUFFERS,n)}catch(e){throw this.bufferErrors.push(n),null===(a=this.eventEmitter)||void 0===a||a.emit(Ys.FETCHING_BUFFERS_ERROR,n),Ys.FETCHING_BUFFERS_ERROR}}}))}fetchAllBuffers(t){return e(this,void 0,void 0,(function*(){for(const e of t)yield this.fetchBuffer(e)}))}getAudioBuffer(e){return this.buffers.get(this.getKeyFromLocation(e))}getOrFetchAudioBuffer(t){return e(this,void 0,void 0,(function*(){return null==this.getAudioBuffer(t)&&(yield this.fetchBuffer(t)),this.getAudioBuffer(t)}))}getDownloadedBuffersList(){return Array.from(this.buffers.keys())}getKeyFromLocation(e){return e.substring(e.lastIndexOf("/")+1)}updateContext(e){this.context=e}reset(){this.buffers.clear()}}class $s{constructor(e,t,i){this.FILTER_QUALITY=6,this.FOURIER_SIZE=4096,this.WAVETABLEBOOST=40,this.SAWTOOTHBOOST=.4,this.oscillatorType=4,this.oscillatorDetuneValue=0,this.audioContext=null,this.carrierBuffer=null,this.modulatorNode=null,this.vocoding=!1,this.modulatorInput=null,this.carrierInput=null,this.modulatorGain=null,this.modulatorGainValue=1,this.noiseBuffer=null,this.noiseNode=null,this.noiseGain=null,this.noiseGainValue=.2,this.carrierSampleNode=null,this.carrierSampleGain=null,this.carrierSampleGainValue=0,this.oscillatorNode=null,this.oscillatorGain=null,this.oscillatorGainValue=1,this.wavetable=null,this.wavetableSignalGain=null,this.modFilterBands=null,this.modFilterPostGains=null,this.heterodynes=null,this.powers=null,this.lpFilters=null,this.lpFilterPostGains=null,this.carrierBands=null,this.carrierFilterPostGains=null,this.carrierBandGains=null,this.vocoderBands=null,this.numVocoderBands=0,this.hpFilterGain=null,this.outputGain=null,this.audioContext=e,this.carrierBuffer=t,this.modulatorBuffer=i}init(){this.generateVocoderBands(55,7040,28),this.setupVocoderGraph(),this.vocode()}getNodes(){return{modulatorNode:this.modulatorNode,modulatorGain:this.modulatorGain,synthLevel:this.oscillatorGain,noiseNode:this.noiseGain,oscillatorNode:this.oscillatorNode,hpFilterGain:this.hpFilterGain,outputGain:this.outputGain}}shutOffCarrier(){this.oscillatorNode&&this.noiseNode&&this.carrierSampleNode&&(this.oscillatorNode.stop(0),this.oscillatorNode=null,this.noiseNode.stop(0),this.noiseNode=null,this.carrierSampleNode.stop(0),this.carrierSampleNode=null)}selectSawtooth(){this.wavetableSignalGain&&(this.wavetableSignalGain.gain.value=this.SAWTOOTHBOOST),this.oscillatorNode&&(this.oscillatorNode.type="sawtooth")}selectWavetable(){this.wavetableSignalGain&&(this.wavetableSignalGain.gain.value=this.WAVETABLEBOOST),this.oscillatorNode&&this.wavetable&&this.oscillatorNode.setPeriodicWave(this.wavetable),this.wavetableSignalGain&&(this.wavetableSignalGain.gain.value=this.WAVETABLEBOOST)}updateModGain(e){this.modulatorGainValue=e,this.modulatorGain&&(this.modulatorGain.gain.value=e)}updateSampleLevel(e){this.carrierSampleGainValue=e,this.carrierSampleGain&&(this.carrierSampleGain.gain.value=e)}updateSynthLevel(e){this.oscillatorGainValue=e,this.oscillatorGain&&(this.oscillatorGain.gain.value=e)}updateNoiseLevel(e){this.noiseGainValue=e,this.noiseGain&&(this.noiseGain.gain.value=e)}updateDetuneValue(e){this.oscillatorDetuneValue=e,this.oscillatorNode&&(this.oscillatorNode.detune.value=e)}generateVocoderBands(e,t,i){const s=1200*Math.log(t/e)/Math.LN2/i,r=Math.pow(2,s/1200);this.vocoderBands=[];let a=e;for(let e=0;e<i;e++)this.vocoderBands[e]={frequency:a},a*=r;this.numVocoderBands=i}loadNoiseBuffer(){if(!this.audioContext)return;const e=5*this.audioContext.sampleRate;this.noiseBuffer=this.audioContext.createBuffer(1,e,this.audioContext.sampleRate);const t=this.noiseBuffer.getChannelData(0);for(let i=0;i<e;++i)t[i]=2*Math.random()-1}initBandpassFilters(){if(!this.audioContext)return;this.modulatorInput=this.audioContext.createGain(),this.carrierInput=this.audioContext.createGain(),null==this.modFilterBands&&(this.modFilterBands=[]),null==this.modFilterPostGains&&(this.modFilterPostGains=[]),null==this.heterodynes&&(this.heterodynes=[]),null==this.powers&&(this.powers=[]),null==this.lpFilters&&(this.lpFilters=[]),null==this.lpFilterPostGains&&(this.lpFilterPostGains=[]),null==this.carrierBands&&(this.carrierBands=[]),null==this.carrierFilterPostGains&&(this.carrierFilterPostGains=[]),null==this.carrierBandGains&&(this.carrierBandGains=[]);const e=new Float32Array(65536),t=32768;let i;for(let s=0;s<t;++s)i=s/t,e[t+s]=i,e[t-s-1]=i;const s=this.audioContext.createBiquadFilter();s.type="highpass",s.frequency.value=8e3,s.Q.value=1,this.modulatorInput.connect(s),this.hpFilterGain=this.audioContext.createGain(),this.hpFilterGain.gain.value=0,s.connect(this.hpFilterGain),this.modulatorBuffer&&this.hpFilterGain.connect(this.audioContext.destination),this.modFilterBands.length=0,this.modFilterPostGains.length=0,this.heterodynes.length=0,this.powers.length=0,this.lpFilters.length=0,this.lpFilterPostGains.length=0,this.carrierBands.length=0,this.carrierFilterPostGains.length=0,this.carrierBandGains.length=0,this.outputGain=this.audioContext.createGain(),this.modulatorBuffer&&this.outputGain.connect(this.audioContext.destination);const r=new Float32Array(65536);for(let e=-32768;e<32768;e++)r[e+32768]=(e>0?e:-e)/32768;for(let t=0;t<this.numVocoderBands;t++){const i=this.audioContext.createBiquadFilter();i.type="bandpass",this.vocoderBands&&(i.frequency.value=this.vocoderBands[t].frequency),i.Q.value=this.FILTER_QUALITY,this.modulatorInput.connect(i),this.modFilterBands.push(i);const s=this.audioContext.createBiquadFilter();s.type="bandpass",this.vocoderBands&&(s.frequency.value=this.vocoderBands[t].frequency),s.Q.value=this.FILTER_QUALITY,i.connect(s);const a=this.audioContext.createGain();a.gain.value=6,s.connect(a),this.modFilterPostGains.push(a);const n=this.audioContext.createOscillator();this.vocoderBands&&(n.frequency.value=this.vocoderBands[t].frequency),n.start(0);const o=this.audioContext.createGain();a.connect(o),o.gain.value=0,n.connect(o.gain);const l=this.audioContext.createGain();l.gain.value=2,o.connect(l),this.heterodynes.push(l);const h=this.audioContext.createWaveShaper();h.curve=r,l.connect(h);const _=this.audioContext.createBiquadFilter();_.type="lowpass",_.frequency.value=5,_.Q.value=1,this.lpFilters.push(_),h.connect(_);const u=this.audioContext.createGain();u.gain.value=1,_.connect(u),this.lpFilterPostGains.push(u);const c=this.audioContext.createWaveShaper();c.curve=e,u.connect(c);const f=this.audioContext.createBiquadFilter();f.type="bandpass",this.vocoderBands&&(f.frequency.value=this.vocoderBands[t].frequency),f.Q.value=this.FILTER_QUALITY,this.carrierBands.push(f),this.carrierInput.connect(f);const d=this.audioContext.createBiquadFilter();d.type="bandpass",this.vocoderBands&&(d.frequency.value=this.vocoderBands[t].frequency),d.Q.value=this.FILTER_QUALITY,f.connect(d);const p=this.audioContext.createGain();p.gain.value=10,d.connect(p),this.carrierFilterPostGains.push(p);const m=this.audioContext.createGain();this.carrierBandGains.push(m),p.connect(m),m.gain.value=0,c.connect(m.gain),m.connect(this.outputGain)}const a=new Float32Array(this.FOURIER_SIZE),n=new Float32Array(this.FOURIER_SIZE);a[0]=0,n[0]=0;for(let e=1;e<this.FOURIER_SIZE;e++)a[e]=1,n[e]=1;this.wavetable=this.audioContext.createPeriodicWave(a,n),this.loadNoiseBuffer()}setupVocoderGraph(){this.initBandpassFilters()}createCarriersAndPlay(e){this.audioContext&&e&&(this.carrierSampleNode=this.audioContext.createBufferSource(),this.carrierSampleNode.buffer=this.carrierBuffer,this.carrierSampleNode.loop=!0,this.carrierSampleGain=this.audioContext.createGain(),this.carrierSampleGain.gain.value=this.carrierSampleGainValue,this.carrierSampleNode.connect(this.carrierSampleGain),this.carrierSampleGain.connect(e),this.wavetableSignalGain=this.audioContext.createGain(),this.oscillatorNode=this.audioContext.createOscillator(),4==this.oscillatorType&&this.wavetable?(this.oscillatorNode.setPeriodicWave(this.wavetable),this.wavetableSignalGain.gain.value=this.WAVETABLEBOOST):this.wavetableSignalGain.gain.value=this.SAWTOOTHBOOST,this.oscillatorNode.frequency.value=110,this.oscillatorNode.detune.value=this.oscillatorDetuneValue,this.oscillatorNode.connect(this.wavetableSignalGain),this.oscillatorGain=this.audioContext.createGain(),this.oscillatorGain.gain.value=this.oscillatorGainValue,this.wavetableSignalGain.connect(this.oscillatorGain),this.oscillatorGain.connect(e),this.noiseNode=this.audioContext.createBufferSource(),this.noiseNode.buffer=this.noiseBuffer,this.noiseNode.loop=!0,this.noiseGain=this.audioContext.createGain(),this.noiseGain.gain.value=this.noiseGainValue,this.noiseNode.connect(this.noiseGain),this.noiseGain.connect(e),this.oscillatorNode.start(0),this.noiseNode.start(0),this.carrierSampleNode.start(0))}vocode(){if(this.audioContext){if(this.vocoding)return this.modulatorNode&&this.modulatorNode.stop(0),this.shutOffCarrier(),void(this.vocoding=!1);this.createCarriersAndPlay(this.carrierInput),this.vocoding=!0,this.modulatorGain=this.audioContext.createGain(),this.modulatorGain.gain.value=this.modulatorGainValue,this.modulatorBuffer&&(this.modulatorNode=this.audioContext.createBufferSource(),this.modulatorNode.buffer=this.modulatorBuffer,this.modulatorNode.connect(this.modulatorGain),this.modulatorNode.start(0)),this.modulatorInput&&this.modulatorGain.connect(this.modulatorInput)}}}class er extends i{constructor(){super(...arguments),this.currentVocoder=null,this.modulatorGainValue=1,this.carrierSampleGainValue=0,this.oscillatorGainValue=1,this.noiseGainValue=.2,this.oscillatorDetuneValue=0}getNode(e){var t;const i=null===(t=this.bufferFetcherService)||void 0===t?void 0:t.getAudioBuffer(s.VOCODER_MODULATOR);this.currentVocoder=new $s(e,i),this.currentVocoder.init(),this.applyCurrentSettingsToVocoder();const{modulatorGain:r,outputGain:a}=this.currentVocoder.getNodes();return{input:r,output:a}}getSettings(){return{modulatorGainValue:this.modulatorGainValue,carrierSampleGainValue:this.carrierSampleGainValue,oscillatorGainValue:this.oscillatorGainValue,noiseGainValue:this.noiseGainValue,oscillatorDetuneValue:this.oscillatorDetuneValue}}setSetting(t,i){return e(this,void 0,void 0,(function*(){if(cs.isSettingValueValid(i)){switch(t){case"modulatorGainValue":this.modulatorGainValue=parseFloat(i);break;case"carrierSampleGainValue":this.carrierSampleGainValue=parseFloat(i);break;case"oscillatorGainValue":this.oscillatorGainValue=parseFloat(i);break;case"noiseGainValue":this.noiseGainValue=parseFloat(i);break;case"oscillatorDetuneValue":this.oscillatorDetuneValue=parseFloat(i)}this.applyCurrentSettingsToVocoder()}}))}applyCurrentSettingsToVocoder(){this.currentVocoder&&(this.currentVocoder.updateModGain(this.modulatorGainValue),this.currentVocoder.updateSampleLevel(this.carrierSampleGainValue),this.currentVocoder.updateSynthLevel(this.oscillatorGainValue),this.currentVocoder.updateNoiseLevel(this.noiseGainValue),this.currentVocoder.updateDetuneValue(this.oscillatorDetuneValue))}get order(){return 1}get id(){return s.FILTERS_NAMES.VOCODER}}class tr{constructor(){this.mapConfig=new Map}getConfig(e){return this.mapConfig.get(e)}setConfig(e,t){this.mapConfig.set(e,t)}isCompatibilityModeEnabled(){return"true"==this.getConfig(s.PREFERENCES_KEYS.COMPATIBILITY_MODE_ENABLED)}isCompatibilityModeChecked(){return"true"==this.getConfig(s.PREFERENCES_KEYS.COMPATIBILITY_MODE_CHECKED)}isAudioWorkletEnabled(){const e=this.getConfig(s.PREFERENCES_KEYS.ENABLE_AUDIO_WORKLET);return null!=e?"true"==e:s.ENABLE_AUDIO_WORKLET}isSoundtouchAudioWorkletEnabled(){const e=this.getConfig(s.PREFERENCES_KEYS.ENABLE_SOUNDTOUCH_AUDIO_WORKLET);return null!=e?"true"==e:s.ENABLE_SOUNDTOUCH_AUDIO_WORKLET}getBufferSize(){const e=this.getConfig(s.PREFERENCES_KEYS.BUFFER_SIZE);return null!=e?parseInt(e):s.DEFAULT_BUFFER_SIZE}getSampleRate(){const e=this.getConfig(s.PREFERENCES_KEYS.SAMPLE_RATE);return null!=e?parseInt(e):s.DEFAULT_SAMPLE_RATE}enableCompatibilityMode(){this.setConfig(s.PREFERENCES_KEYS.COMPATIBILITY_MODE_ENABLED,"true")}disableCompatibilityMode(){this.setConfig(s.PREFERENCES_KEYS.COMPATIBILITY_MODE_ENABLED,"false")}getWorkletBasePath(){return""}getSoundBasePath(){return""}isInitialRenderingDisabled(){const e=this.getConfig(s.PREFERENCES_KEYS.DISABLE_INITIAL_RENDERING);return null!=e?"true"==e:s.DISABLE_INITIAL_RENDERING}}var ir=!!(r===r.window&&r.URL&&r.Blob&&r.Worker);function sr(e,t){var i,s=this;if(t=t||{},ir)return i=e.toString().trim().match(/^function\s*\w*\s*\([\w\s,]*\)\s*{([\w\W]*?)}$/)[1],new r.Worker(r.URL.createObjectURL(new r.Blob([i],{type:"text/javascript"})));this.self=t,this.self.postMessage=function(e){setTimeout((function(){s.onmessage({data:e})}),0)},setTimeout(e.bind(t,t),0)}sr.prototype.postMessage=function(e){var t=this;setTimeout((function(){t.self.onmessage({data:e})}),0)};var rr=a(sr);const ar={};function nr(){return new rr((function(){let e,t,i=0,s=[];this.onmessage=function(e){switch(e.data.command){case"init":r(e.data.config);break;case"record":a(e.data.buffer);break;case"exportWAV":n(e.data.type);break;case"getBuffer":o();break;case"clear":l()}};const r=i=>{e=i.sampleRate,t=i.numChannels,h()},a=e=>{for(let i=0;i<t;i++)s[i].push(e[i]);i+=e[0].length},n=e=>{const r=[];for(let e=0;e<t;e++)r.push(_(s[e],i));let a;a=2===t?u(r[0],r[1]):r[0];const n=f(a),o=new Blob([n],{type:e});this.postMessage({command:"exportWAV",data:o})},o=()=>{const e=[];for(let r=0;r<t;r++)e.push(_(s[r],i));this.postMessage({command:"getBuffer",data:e})},l=()=>{i=0,s=[],h()},h=()=>{for(let e=0;e<t;e++)s[e]=[]},_=(e,t)=>{const i=new Float32Array(t);let s=0;for(let t=0;t<e.length;t++)e[t]?(i.set(e[t],s),s+=e[t].length):console.warn("RecorderWorker: undefined buffer has been detected");return i},u=(e,t)=>{const i=e.length+t.length,s=new Float32Array(i);let r=0,a=0;for(;r<i;)s[r++]=e[a],s[r++]=t[a],a++;return s},c=(e,t,i)=>{for(let s=0;s<i.length;s++)e.setUint8(t+s,i.charCodeAt(s))},f=i=>{const s=new ArrayBuffer(44+2*i.length),r=new DataView(s);return c(r,0,"RIFF"),r.setUint32(4,36+2*i.length,!0),c(r,8,"WAVE"),c(r,12,"fmt "),r.setUint32(16,16,!0),r.setUint16(20,1,!0),r.setUint16(22,t,!0),r.setUint32(24,e,!0),r.setUint32(28,4*e,!0),r.setUint16(32,2*t,!0),r.setUint16(34,16,!0),c(r,36,"data"),r.setUint32(40,2*i.length,!0),((e,t,i)=>{for(let s=0;s<i.length;s++,t+=2){const r=Math.max(-1,Math.min(1,i[s]));e.setInt16(t,r<0?32768*r:32767*r,!0)}})(r,44,i),r}}),ar)}class or{constructor(e){this.worker=null,this.node=null,this.context=null,this.config={bufferLen:4096,sampleRate:44100,numChannels:2,mimeType:"audio/wav",workletBasePath:"worklets/",callback:()=>{}},this.callbacks={getBuffer:[],exportWAV:[]},this.recording=!1,Object.assign(this.config,e)}setup(t){return e(this,void 0,void 0,(function*(){this.node&&(this.node instanceof AudioWorkletNode&&this.node.port.postMessage("stop"),this.node.disconnect()),t&&(this.context=t.context,yield this.createRecorderNode(),this.node&&this.context&&(t.connect(this.node),this.node.connect(this.context.destination))),this.context&&!this.worker&&(this.worker=nr(),this.worker&&(this.worker.postMessage({command:"init",config:{sampleRate:this.context.sampleRate,numChannels:this.config.numChannels}}),this.worker.onmessage=e=>{let t=null;switch(e.data.command){case"getBuffer":t=this.callbacks.getBuffer;break;case s.EXPORT_WAV_COMMAND:t=this.callbacks.exportWAV}if(t){const i=t.pop();"function"==typeof i&&i(e.data.data)}}))}))}createRecorderNode(){return e(this,void 0,void 0,(function*(){if(this.context)if(cs.isAudioWorkletCompatible(this.context)&&s.ENABLE_RECORDER_AUDIO_WORKLET)try{yield this.createRecorderWorklet()}catch(e){this.createRecorderScriptProcessorNode()}else this.createRecorderScriptProcessorNode()}))}createRecorderWorklet(){return e(this,void 0,void 0,(function*(){if(this.context&&(yield this.context.audioWorklet.addModule(this.config.workletBasePath+s.WORKLET_PATHS.RECORDER_WORKLET),this.node=new AudioWorkletNode(this.context,s.WORKLET_NAMES.RECORDER_WORKLET),this.node&&this.node.port)){const e=this.node.parameters.get("numChannels");e&&(e.value=this.config.numChannels,e.setValueAtTime(this.config.numChannels,0)),this.node.port.onmessage=e=>{this.worker&&"record"==e.data.command&&e.data.buffer.length>0&&this.worker.postMessage({command:"record",buffer:e.data.buffer})}}}))}createRecorderScriptProcessorNode(){this.context&&(this.node=this.context.createScriptProcessor.call(this.context,this.config.bufferLen,this.config.numChannels,this.config.numChannels),this.node.onaudioprocess=e=>{if(!this.recording)return;const t=[];for(let i=0;i<this.config.numChannels;i++)t.push(e.inputBuffer.getChannelData(i));this.worker&&this.worker.postMessage({command:"record",buffer:t})})}record(){this.recording=!0,this.node instanceof AudioWorkletNode&&this.node.port.postMessage("record")}stop(){this.recording=!1,this.node instanceof AudioWorkletNode&&this.node.port.postMessage("stop")}clear(){this.worker&&this.worker.postMessage({command:"clear"})}kill(){this.clear(),this.stop(),this.worker&&this.worker.terminate()}getBuffer(e){if(!(e=e||this.config.callback))throw new Error("Callback not set");this.callbacks.getBuffer.push(e),this.worker&&this.worker.postMessage({command:"getBuffer"})}exportWAV(e,t){if(t=t||this.config.mimeType,!(e=e||this.config.callback))throw new Error("Callback not set");this.callbacks.exportWAV.push(e),this.worker&&this.worker.postMessage({command:s.EXPORT_WAV_COMMAND,type:t})}static forceDownload(e,t){const i=window.document.createElement("a"),s=(window.URL||window.webkitURL).createObjectURL(e);window.document.body.appendChild(i),i.href=s,i.download=t||"output.wav",i.click(),window.URL.revokeObjectURL(s)}}class lr{constructor(e,t){this.context=e,this.eventEmitter=t||new Zs}decodeBufferFromFile(t){return e(this,void 0,void 0,(function*(){this.eventEmitter&&this.eventEmitter.emit(Ys.DECODING_AUDIO_FILE);try{const e=yield cs.loadAudioBuffer(this.context,t);return this.eventEmitter&&this.eventEmitter.emit(Ys.DECODED_AUDIO_FILE),e}catch(e){console.error(e),this.eventEmitter&&(this.eventEmitter.emit(Ys.DECODED_AUDIO_FILE),this.eventEmitter.emit(Ys.ERROR_DECODING_AUDIO_FILE))}return null}))}updateContext(e){this.context=e}}class hr extends AudioWorkletProcessor{constructor(){super(),this.stopped=!1,this.samplesCount=0,this.port.onmessage=e=>{"stop"==e.data&&this.stop()}}static get parameterDescriptors(){return[]}get defaultParameterDescriptors(){return hr.parameterDescriptors}process(e,t){if(this.stopped)return!1;const i=e[0],s=t[0];if(i&&i[0]&&(this.samplesCount+=i[0].length),s){for(let e=0;e<s.length;e++){const t=i[e],r=s[e];if(t)for(let e=0;e<t.length;e++)r[e]=t[e]}this.port.postMessage({command:"update",samplesCount:this.samplesCount})}return!0}stop(){this.stopped=!0}}registerProcessor(s.WORKLET_NAMES.PASSTHROUGH,hr);class _r extends vs{constructor(){super(),this._totalSamples=0,this.currentTime=0,this.lastSampleCount=0,this.samplePerSecond=0,this.currentTimeSamplesPerSecond=0}receiveEvent(e){const t=performance.now(),i=e.data.samplesCount;"update"===e.data.command&&this.calculatePercentageProcessed(t,i),this.calculateRemainingTimeProcessing(t,i)}calculatePercentageProcessed(e,t){0===this.currentTime&&(this.currentTime=e);const i=e-this.currentTime,r=t/this._totalSamples;this.eventEmitter&&i>=s.TREATMENT_TIME_COUNTING_THROTTLE_INTERVAL&&(this.eventEmitter.emit(Ys.UPDATE_AUDIO_TREATMENT_PERCENT,100*r),this.currentTime=e)}calculateRemainingTimeProcessing(e,t){0===this.currentTimeSamplesPerSecond&&(this.currentTimeSamplesPerSecond=e);const i=e-this.currentTimeSamplesPerSecond,s=this._totalSamples-t;if(this.eventEmitter&&s<=0)this.eventEmitter.emit(Ys.UPDATE_REMAINING_TIME_ESTIMATED,0);else if(this.eventEmitter&&i>=1e3){this.calculateSmoothedSamplePerSecond(i,t);const r=s/this.samplePerSecond;this.currentTimeSamplesPerSecond=e,this.lastSampleCount=t,isNaN(r)||!isFinite(r)?this.eventEmitter.emit(Ys.UPDATE_REMAINING_TIME_ESTIMATED,-1):this.eventEmitter.emit(Ys.UPDATE_REMAINING_TIME_ESTIMATED,r)}}calculateSmoothedSamplePerSecond(e,t){if(e>0){const i=(t-this.lastSampleCount)/(e/1e3);this.samplePerSecond=s.TREATMENT_TIME_COUNTING_SMOOTHING_FACTOR*i+(1-s.TREATMENT_TIME_COUNTING_SMOOTHING_FACTOR)*this.samplePerSecond}}get workletName(){return s.WORKLET_NAMES.PASSTHROUGH}get workletPath(){return s.WORKLET_PATHS.PASSTHROUGH}get order(){return 10}get id(){return s.FILTERS_NAMES.PASSTHROUGH}set totalSamples(e){this._totalSamples=e,this.currentTime=0,this.currentTimeSamplesPerSecond=0,this.samplePerSecond=0,this.lastSampleCount=0}getSettings(){return{}}isEnabled(){return!0}setSetting(t,i){return e(this,void 0,void 0,(function*(){}))}}class ur extends t{constructor(e,t,i,r,a){super(),this.principalBuffer=null,this.sumPrincipalBuffer=0,this.renderedBuffer=null,this.entrypointFilter=null,this.filters=[],this.renderers=[],this.currentNodes=null,this.savingBuffer=!1,this.previousSampleRate=s.DEFAULT_SAMPLE_RATE,this.audioBuffersToFetch=[],this.playingStoppedCallback=null,this.audioRenderingLastCanceled=!1,this.initialRenderingDone=!1,this.downloadingInitialData=!1,this.currentContext=e,this.eventEmitter=i||new Zs,this.bufferPlayer=t||new Qs(e),this.configService=r||new tr,this.bufferFetcherService=new Js(this.currentContext,this.configService,this.eventEmitter),this.bufferDecoderService=new lr(this.currentContext,this.eventEmitter),this.audioBuffersToFetch=a||[],this.setup()}setup(){this.configService&&(this.previousSampleRate=this.configService.getSampleRate(),this.eventEmitter&&this.eventEmitter.emit(Ys.SAMPLE_RATE_CHANGED,this.previousSampleRate)),this.currentContext||this.createNewContext(this.previousSampleRate),this.bufferPlayer&&(this.bufferPlayer.onBeforePlaying((()=>e(this,void 0,void 0,(function*(){this.bufferPlayer&&this.bufferPlayer.compatibilityMode&&this.currentContext&&(yield this.setupOutput(this.currentContext))})))),this.bufferPlayer.on(Ys.PLAYING_FINISHED,(()=>{this.savingBuffer&&this.playingStoppedCallback&&this.off(Ys.PLAYING_STOPPED,this.playingStoppedCallback),this.bufferPlayer&&this.bufferPlayer.loop&&this.bufferPlayer.start()}))),this.setupDefaultFilters(),this.setupDefaultRenderers(),this.audioBuffersToFetch.length>0&&this.fetchBuffers(!1)}addFilters(...e){for(const t of e)t.initializeDefaultSettings(),t.bufferFetcherService=this.bufferFetcherService,t.bufferDecoderService=this.bufferDecoderService,t.configService=this.configService,t.eventEmitter=this.eventEmitter;this.filters.push(...e)}addRenderers(...e){for(const t of e)t.bufferFetcherService=this.bufferFetcherService,t.bufferDecoderService=this.bufferDecoderService,t.configService=this.configService;this.renderers.push(...e)}setupDefaultFilters(){const e=new fs(200,15,200,-2),t=new Ss(16,.9),i=new Es(.2,.75),s=new Rs(3500),r=new Ts(3500),a=new ks,n=new js,o=new ws(0,0,0,3,-.05,.1),l=new zs,h=new er,_=new _r;this.entrypointFilter=n,this.addFilters(e,t,i,s,r,a,o,l,n,h,_)}setupDefaultRenderers(){const e=new ys;this.addRenderers(e)}fetchBuffers(t){return e(this,void 0,void 0,(function*(){if(!this.downloadingInitialData&&this.bufferFetcherService){this.downloadingInitialData=!0,this.eventEmitter&&!t&&this.eventEmitter.emit(Ys.LOADING_BUFFERS);try{yield this.bufferFetcherService.fetchAllBuffers(this.audioBuffersToFetch),this.downloadingInitialData=!1,this.eventEmitter&&!t&&this.eventEmitter.emit(Ys.LOADED_BUFFERS)}catch(e){this.eventEmitter&&!t&&this.eventEmitter.emit(Ys.LOADING_BUFFERS_ERROR)}}}))}createNewContextIfNeeded(){return e(this,void 0,void 0,(function*(){if(this.configService&&this.configService.isCompatibilityModeEnabled()&&this.principalBuffer)this.currentSampleRate!=this.principalBuffer.sampleRate&&(yield this.createNewContext(this.principalBuffer.sampleRate),this.previousSampleRate=this.principalBuffer.sampleRate,yield this.resetBufferFetcher());else{let e=s.DEFAULT_SAMPLE_RATE;this.configService&&(e=this.configService.getSampleRate()),e!=this.previousSampleRate&&(yield this.createNewContext(e),this.previousSampleRate=e,yield this.resetBufferFetcher())}}))}resetBufferFetcher(){return e(this,void 0,void 0,(function*(){this.bufferFetcherService&&(this.bufferFetcherService.reset(),yield this.fetchBuffers(!0),yield this.resetReverbFilterBuffer())}))}resetReverbFilterBuffer(){return e(this,void 0,void 0,(function*(){var e;const t=this.getFiltersSettings().get(s.FILTERS_NAMES.REVERB);if(t){const i=null===(e=t.reverbEnvironment)||void 0===e?void 0:e.value;i&&"custom"!==i&&this.bufferFetcherService&&(yield this.bufferFetcherService.fetchBuffer(i))}}))}createNewContext(t){return e(this,void 0,void 0,(function*(){this.currentContext&&(yield this.currentContext.close());const e={latencyHint:"interactive"};0!=t&&(e.sampleRate=t),this.currentContext=new AudioContext(e),this.eventEmitter&&this.eventEmitter.emit(Ys.SAMPLE_RATE_CHANGED,this.currentContext.sampleRate),this.bufferPlayer&&this.bufferPlayer.updateContext(this.currentContext),this.bufferFetcherService&&this.bufferFetcherService.updateContext(this.currentContext),this.bufferDecoderService&&this.bufferDecoderService.updateContext(this.currentContext)}))}prepareContext(){return e(this,void 0,void 0,(function*(){yield this.createNewContextIfNeeded(),this.currentContext&&this.currentContext.resume()}))}get currentSampleRate(){return this.currentContext?this.currentContext.sampleRate:0}get defaultDeviceSampleRate(){const e=new AudioContext;let t=0;return e&&(t=e.sampleRate,e.close()),t}loadBufferFromFile(t){return e(this,void 0,void 0,(function*(){if(this.principalBuffer=null,yield this.prepareContext(),!this.currentContext||!this.bufferDecoderService)throw new Error("Audio Context is not ready!");if(this.principalBuffer=yield this.bufferDecoderService.decodeBufferFromFile(t),this.initialRenderingDone=!1,!this.principalBuffer)throw new Error("Error decoding audio file");this.sumPrincipalBuffer=cs.sumAudioBuffer(this.principalBuffer),this.resetAudioRenderingProgress()}))}resetAudioRenderingProgress(){this.eventEmitter&&(this.eventEmitter.emit(Ys.UPDATE_AUDIO_TREATMENT_PERCENT,0),this.eventEmitter.emit(Ys.UPDATE_REMAINING_TIME_ESTIMATED,-1))}loadBuffer(e){this.principalBuffer=e,this.sumPrincipalBuffer=cs.sumAudioBuffer(this.principalBuffer),this.initialRenderingDone=!1}connectNodes(t,i,s,r){return e(this,void 0,void 0,(function*(){if(!this.entrypointFilter)return;let e=null;if(s&&this.currentNodes)e=this.currentNodes.input;else{const s=yield this.entrypointFilter.getEntrypointNode(t,i,!r);e=s.input}const a=[];let n=e;this.disconnectOldNodes(s);const o=this.filters.sort(((e,t)=>e.order-t.order)).filter(((e,t)=>e!==this.entrypointFilter&&(e.isEnabled()||t>=this.filters.length-1)));for(const e of o){const i=e.getNode(t);n&&n.connect(i.input),n=i.output,a.push(i)}this.entrypointFilter&&this.entrypointFilter.updateState(),this.currentNodes={input:e,output:n,intermediateNodes:a.filter((t=>t.input!=n&&t.output!=n&&t.input!=e&&t.output!=e))}}))}disconnectOldNodes(e){if(this.currentNodes&&(this.currentNodes.input.disconnect(),e||this.currentNodes.output.disconnect(),this.currentNodes.intermediateNodes))for(const e of this.currentNodes.intermediateNodes)e.input.disconnect(),e.output.disconnect()}reconnectNodesIfNeeded(){return e(this,void 0,void 0,(function*(){if(this.bufferPlayer&&this.bufferPlayer.compatibilityMode&&this.currentContext&&this.principalBuffer&&this.bufferPlayer&&this.entrypointFilter){yield this.connectNodes(this.currentContext,this.principalBuffer,!0,this.bufferPlayer.compatibilityMode);const e=this.entrypointFilter.getSpeed();this.bufferPlayer.speedAudio=e,this.bufferPlayer.duration=this.calculateAudioDuration(e)*e}}))}initializeWorklets(t){return e(this,void 0,void 0,(function*(){for(const e of this.filters)e.isWorklet()&&(yield e.initializeWorklet(t))}))}getOutputBuffer(){return this.renderedBuffer}renderAudio(){return e(this,void 0,void 0,(function*(){if(yield this.prepareContext(),!this.currentContext)throw new Error("AudioContext is not yet available");if(!this.entrypointFilter)throw new Error("Entrypoint filter is not available");if(!this.initialRenderingDone&&this.configService&&this.configService.isInitialRenderingDisabled())return this.loadInitialBuffer(),this.initialRenderingDone=!0,!0;this.configService&&this.bufferPlayer&&!this.configService.isCompatibilityModeEnabled()&&this.bufferPlayer.compatibilityMode&&this.bufferPlayer.stop();const e=this.entrypointFilter.getSpeed(),t=this.calculateAudioDuration(e),i=new OfflineAudioContext(2,this.currentContext.sampleRate*t,this.currentContext.sampleRate),s=this.configService&&this.configService.isCompatibilityModeEnabled()?this.currentContext:i;return this.renderedBuffer=yield this.executeAudioRenderers(s),this.currentOfflineContext=null,this.audioRenderingLastCanceled=!1,this.setupPasstroughFilter(t),yield this.setupOutput(s,t,i)}))}executeAudioRenderers(t){return e(this,void 0,void 0,(function*(){let e=this.principalBuffer;for(const i of this.renderers.sort(((e,t)=>e.order-t.order)))i.isEnabled()&&(e=yield i.renderAudio(t,e));return e}))}setupPasstroughFilter(e){this.resetAudioRenderingProgress();const t=this.filters.find((e=>e.id===s.FILTERS_NAMES.PASSTHROUGH));t&&this.currentContext&&(t.totalSamples=e*this.currentContext.sampleRate)}setupOutput(t,i,s){return e(this,void 0,void 0,(function*(){if(this.renderedBuffer&&this.configService&&this.eventEmitter&&this.bufferPlayer){if(yield this.initializeWorklets(t),yield this.connectNodes(t,this.renderedBuffer,!1,this.configService.isCompatibilityModeEnabled()),this.entrypointFilter){const e=this.entrypointFilter.getSpeed();this.bufferPlayer.speedAudio=e}if(!this.configService.isCompatibilityModeEnabled()&&s&&this.currentNodes){this.currentOfflineContext=s,this.currentNodes.output.connect(t.destination);const e=yield s.startRendering();if(!this.loadRenderedAudio(e))return yield this.setupOutput(this.currentContext,i);if(this.audioRenderingLastCanceled)return!1;this.eventEmitter.emit(Ys.OFFLINE_AUDIO_RENDERING_FINISHED)}else this.bufferPlayer.setCompatibilityMode(this.currentNodes.output,i);return this.eventEmitter.emit(Ys.AUDIO_RENDERING_FINISHED),!0}return!1}))}loadRenderedAudio(e){if(this.eventEmitter&&this.bufferPlayer){if(this.audioRenderingLastCanceled)this.initialRenderingDone||(this.loadInitialBuffer(),this.eventEmitter.emit(Ys.CANCELLED_AND_LOADED_INITIAL_AUDIO));else{if(0==cs.sumAudioBuffer(e)&&0!==this.sumPrincipalBuffer){if(this.configService&&!this.configService.isCompatibilityModeChecked())return this.setCompatibilityModeChecked(!0),this.configService.enableCompatibilityMode(),this.eventEmitter.emit(Ys.COMPATIBILITY_MODE_AUTO_ENABLED),!1;this.eventEmitter.emit(Ys.RENDERING_AUDIO_PROBLEM_DETECTED)}this.renderedBuffer=e,this.bufferPlayer.loadBuffer(this.renderedBuffer)}this.initialRenderingDone=!0}return!0}loadInitialBuffer(){this.bufferPlayer&&(this.renderedBuffer=this.principalBuffer,this.bufferPlayer.loadBuffer(this.principalBuffer))}cancelAudioRendering(){this.currentOfflineContext&&!this.audioRenderingLastCanceled&&(this.audioRenderingLastCanceled=!0,this.disconnectOldNodes(!1),this.eventEmitter&&this.eventEmitter.emit(Ys.CANCELLING_AUDIO_PROCESSING))}calculateAudioDuration(e){if(this.principalBuffer){let t=cs.calcAudioDuration(this.principalBuffer,e);for(const e of this.filters)e.isEnabled()&&(t+=e.getAddingTime());return t}return 0}get order(){return-1}get id(){return s.AUDIO_EDITOR}isEnabled(){return!0}isAudioWorkletAvailable(){return!!this.currentContext&&cs.isAudioWorkletCompatible(this.currentContext)}setCompatibilityModeChecked(e){this.configService&&this.configService.setConfig(s.PREFERENCES_KEYS.COMPATIBILITY_MODE_CHECKED,""+e)}getFiltersState(){const e={};return[...this.filters,...this.renderers].forEach((t=>{e[t.id]=t.isEnabled()})),e}getFiltersSettings(){const e=new Map;for(const t of this.filters)e.set(t.id,t.getSettings());return e}toggleFilter(e){const t=this.filters.find((t=>t.id===e)),i=this.renderers.find((t=>t.id===e));t&&t.toggle(),i&&i.toggle(),this.reconnectNodesIfNeeded()}changeFilterSettings(t,i){return e(this,void 0,void 0,(function*(){const e=this.filters.find((e=>e.id===t));if(e){for(const t of Object.keys(i))yield e.setSetting(t,i[t]);yield this.reconnectNodesIfNeeded()}}))}resetFilterSettings(t){return e(this,void 0,void 0,(function*(){const e=this.filters.find((e=>e.id===t));e&&(yield e.resetSettings(),this.reconnectNodesIfNeeded())}))}resetAllFiltersState(){[...this.filters,...this.renderers].forEach((e=>{e.isDefaultEnabled()?e.enable():e.disable()})),this.reconnectNodesIfNeeded()}exit(){this.bufferPlayer&&(this.bufferPlayer.stop(),this.bufferPlayer.reset()),this.cancelAudioRendering(),this.principalBuffer=null}on(e,t){this.eventEmitter&&this.eventEmitter.on(e,t)}off(e,t){this.eventEmitter&&this.eventEmitter.off(e,t)}saveBuffer(e){return this.savingBuffer?Promise.reject():(this.savingBuffer=!0,new Promise(((t,i)=>{if(!this.bufferPlayer)return i();if(this.bufferPlayer.compatibilityMode)this.bufferPlayer.start().then((()=>{if(!this.configService)return i();const r=new or({bufferLen:this.configService.getBufferSize(),sampleRate:this.configService.getSampleRate(),numChannels:2,workletBasePath:this.configService.getWorkletBasePath(),mimeType:"mp3"==(null==e?void 0:e.format)?"audio/mp3":"audio/wav",bitrate:(null==e?void 0:e.bitrate)||s.DEFAULT_MP3_BITRATE});r.setup(this.currentNodes.output).then((()=>{r.record(),this.playingStoppedCallback=()=>{r.kill(),this.savingBuffer=!1,this.off(Ys.PLAYING_FINISHED,i),this.playingStoppedCallback&&this.off(Ys.PLAYING_STOPPED,this.playingStoppedCallback),t(!0)};const i=()=>{this.playingStoppedCallback&&this.off(Ys.PLAYING_STOPPED,this.playingStoppedCallback),r.stop(),r.exportWAV((s=>{this.downloadAudioBlob(s,e),this.savingBuffer=!1,this.off(Ys.PLAYING_FINISHED,i),r.kill(),t(!0)}))};this.on(Ys.PLAYING_FINISHED,i),this.on(Ys.PLAYING_STOPPED,this.playingStoppedCallback)}))}));else{if(!this.renderedBuffer||!this.currentContext)return t(!1);const i=nr();if(i){const r=[];for(let e=0;e<this.renderedBuffer.numberOfChannels;e++)r.push(this.renderedBuffer.getChannelData(e));"mp3"===(null==e?void 0:e.format)?(this.exportMP3(r,e),t(!0)):(i.onmessage=r=>{r.data.command==s.EXPORT_WAV_COMMAND&&this.downloadAudioBlob(r.data.data,e),i.terminate(),this.savingBuffer=!1,t(!0)},i.postMessage({command:s.INIT_COMMAND,config:{sampleRate:this.renderedBuffer.sampleRate,numChannels:2,bitrate:(null==e?void 0:e.bitrate)||s.DEFAULT_MP3_BITRATE}}),i.postMessage({command:s.RECORD_COMMAND,buffer:r}),i.postMessage({command:s.EXPORT_WAV_COMMAND,type:s.AUDIO_WAV}))}}})))}downloadAudioBlob(e,t){or.forceDownload(e,"audio-"+(new Date).toISOString()+"."+((null==t?void 0:t.format)||s.DEFAULT_SAVE_FORMAT))}exportMP3(e,t){if(this.configService){const i=cs.encodeMP3(e,2,this.currentSampleRate,(null==t?void 0:t.bitrate)||s.DEFAULT_MP3_BITRATE),r=new Blob(i,{type:"audio/mp3"});console.log(i),this.downloadAudioBlob(r,t)}}}class cr{constructor(e,t){this.seconds=0,this.initialSeconds=0,this.interval=null,this.incr=1,this.countCallback=()=>{},this.seconds=e,this.initialSeconds=e,this.interval,this.incr=t}start(){this.interval=window.setInterval((()=>this.count()),1e3)}stop(){clearInterval(this.interval)}count(){this.seconds+=this.incr,this.seconds<=0&&this.stop(),this.countCallback&&this.countCallback()}onCount(e){this.countCallback=e}}class fr extends t{constructor(e,t,i){super(),this.input=null,this.stream=null,this.recorder=null,this.alreadyInit=!1,this.timer=null,this.enableAudioFeedback=!1,this.recording=!1,this.deviceList=[],this.constraints={audio:{noiseSuppression:!0,echoCancellation:!0,autoGainControl:!0,sampleRate:{ideal:44100}}},this.eventEmitter=null,this.previousSampleRate=s.DEFAULT_SAMPLE_RATE,this.sampleRateConfigNotSupported=!1,this.context=e,this.eventEmitter=t||new Zs,this.configService=i||null,this.configService&&(this.previousSampleRate=this.configService.getSampleRate())}init(){return e(this,void 0,void 0,(function*(){var e;if(this.isRecordingAvailable()){this.sampleRateConfigNotSupported=!navigator.mediaDevices.getSupportedConstraints().sampleRate,this.context?yield this.createNewContextIfNeeded():yield this.createNewContext(this.previousSampleRate),null===(e=this.eventEmitter)||void 0===e||e.emit(Ys.RECORDER_INIT);try{const e=yield navigator.mediaDevices.getUserMedia(this.constraints);this.context&&this.context.resume(),yield this.setup(e,!1,!1),this.alreadyInit=!0,this.timer=new cr(0,1),this.timer.onCount((()=>{var e;null===(e=this.eventEmitter)||void 0===e||e.emit(Ys.RECORDER_COUNT_UPDATE)})),this.successCallback()}catch(e){console.error(e);if(e)switch(e.name){case"SecurityError":case"NotAllowedError":this.errorCallback();break;case"NotFoundError":this.notFoundErrorCallback();break;case"NotSupportedError":this.sampleRateConfigNotSupported||(this.previousSampleRate=0,this.sampleRateConfigNotSupported=!0,this.init());break;default:this.unknownErrorCallback()}}navigator.mediaDevices.ondevicechange=()=>this.updateInputList()}}))}createNewContextIfNeeded(){return e(this,void 0,void 0,(function*(){let e=s.DEFAULT_SAMPLE_RATE;this.configService&&(e=this.configService.getSampleRate()),e!=this.previousSampleRate&&(yield this.createNewContext(e),this.previousSampleRate=e)}))}createNewContext(t){return e(this,void 0,void 0,(function*(){this.context&&(yield this.context.close());const e={latencyHint:"balanced"};0==t||this.sampleRateConfigNotSupported||(e.sampleRate=t),this.context=new AudioContext(e),this.constraints.audio.sampleRate={ideal:this.context.sampleRate}}))}successCallback(){var e;null===(e=this.eventEmitter)||void 0===e||e.emit(Ys.RECORDER_SUCCESS)}errorCallback(){var e;null===(e=this.eventEmitter)||void 0===e||e.emit(Ys.RECORDER_ERROR)}notFoundErrorCallback(){var e;null===(e=this.eventEmitter)||void 0===e||e.emit(Ys.RECORDER_NOT_FOUND_ERROR)}unknownErrorCallback(){var e;null===(e=this.eventEmitter)||void 0===e||e.emit(Ys.RECORDER_UNKNOWN_ERROR)}audioFeedback(e){var t;this.context&&(e?(this.input&&this.input.connect(this.context.destination),this.enableAudioFeedback=!0):(this.input&&this.input.connect(this.context.destination)&&this.input.disconnect(this.context.destination),this.enableAudioFeedback=!1),null===(t=this.eventEmitter)||void 0===t||t.emit(Ys.RECORDER_UPDATE_CONSTRAINTS))}getConstraints(){if(this.stream){const e=this.stream.getTracks();if(e&&e.length>0)return e[0].getSettings()}return null}updateConstraints(){var e;const t=this.getConstraints();t&&(this.constraints.audio=Object.assign(this.constraints.audio,t),null===(e=this.eventEmitter)||void 0===e||e.emit(Ys.RECORDER_UPDATE_CONSTRAINTS))}resetConstraints(t){return e(this,void 0,void 0,(function*(){if(this.stream){const e=this.enableAudioFeedback,i=this.recording,s=this.stream.getTracks();if(t&&(this.updateConstraints(),this.constraints.audio=Object.assign(this.constraints.audio,t.audio)),s&&s.length>0)try{yield s[0].applyConstraints(this.constraints.audio);const r=this.getConstraints(),a=t?Object.keys(t.audio)[0]:"";if(this.audioFeedback(!1),this.pause(),!t||r&&r[a]!=t.audio[a]){this.stopStream();const t=yield navigator.mediaDevices.getUserMedia(this.constraints);yield this.setup(t,i,e)}else yield this.setup(null,i,e)}catch(e){this.errorCallback()}}}))}setup(t,i,s){return e(this,void 0,void 0,(function*(){t&&this.context&&(this.input=this.context.createMediaStreamSource(t),this.stream=t),this.recorder&&this.input&&(yield this.recorder.setup(this.input),i&&(yield this.record())),this.audioFeedback(s),this.updateConstraints(),yield this.updateInputList()}))}setNoiseSuppression(e){this.resetConstraints({audio:{noiseSuppression:e}})}setAutoGain(e){this.resetConstraints({audio:{autoGainControl:e}})}setEchoCancellation(e){this.resetConstraints({audio:{echoCancellation:e}})}updateInputList(){return e(this,void 0,void 0,(function*(){if(this.deviceList){const e=yield navigator.mediaDevices.enumerateDevices();this.deviceList=[],e.forEach((e=>{"audioinput"==e.kind&&this.deviceList.push(e)}))}}))}changeInput(e,t){t&&(this.constraints.audio.deviceId=e,this.constraints.audio.groupId=t,this.resetConstraints())}record(){return e(this,void 0,void 0,(function*(){this.alreadyInit&&this.configService&&this.input&&(this.recorder||(this.recorder=new or({bufferLen:this.configService.getBufferSize(),sampleRate:this.configService.getSampleRate(),numChannels:2,workletBasePath:this.configService.getWorkletBasePath(),mimeType:"audio/wav"}),yield this.recorder.setup(this.input)),this.recorder&&this.recorder.record(),this.timer&&this.timer.start(),this.recording=!0,this.eventEmitter&&this.eventEmitter.emit(Ys.RECORDER_RECORDING))}))}stop(){return e(this,void 0,void 0,(function*(){this.alreadyInit&&this.recorder&&(this.recorder.stop(),this.timer&&this.timer.stop(),this.recording=!1,this.recorder.getBuffer((e=>{var t;if(this.context){this.context.resume();const i=this.context.createBuffer(2,e[0].length,this.context.sampleRate);i.getChannelData(0).set(e[0]),i.getChannelData(1).set(e[1]),null===(t=this.eventEmitter)||void 0===t||t.emit(Ys.RECORDER_STOPPED,i),this.reset()}})))}))}pause(){var e;this.alreadyInit&&(this.recorder&&this.recorder.stop(),this.timer&&this.timer.stop(),this.recording=!1,null===(e=this.eventEmitter)||void 0===e||e.emit(Ys.RECORDER_PAUSED))}stopStream(){if(this.stream){const e=this.stream.getTracks();for(let t=0,i=e.length;t<i;t++)e[t].stop()}}reset(){var e;this.recorder&&this.recorder.kill(),this.timer&&this.timer.stop(),this.audioFeedback(!1),this.stopStream(),this.input=null,this.recorder=null,this.stream=null,this.alreadyInit=!1,this.timer=null,null===(e=this.eventEmitter)||void 0===e||e.emit(Ys.RECORDER_RESETED)}get currentTimeDisplay(){var e,t,i;return(null===(e=this.timer)||void 0===e?void 0:e.seconds)?("0"+Math.trunc((null===(t=this.timer)||void 0===t?void 0:t.seconds)/60)).slice(-2)+":"+("0"+Math.trunc((null===(i=this.timer)||void 0===i?void 0:i.seconds)%60)).slice(-2):"00:00"}get currentTime(){return this.timer?this.timer.seconds:0}getSettings(){return{deviceList:this.deviceList,audioFeedback:this.enableAudioFeedback,constraints:this.constraints.audio}}on(e,t){var i;null===(i=this.eventEmitter)||void 0===i||i.on(e,t)}isRecordingAvailable(){return void 0!==navigator.mediaDevices&&void 0!==navigator.mediaDevices.getUserMedia}get order(){return-1}get id(){throw s.VOICE_RECORDER}}export{t as AbstractAudioElement,i as AbstractAudioFilter,vs as AbstractAudioFilterWorklet,Ms as AbstractAudioRenderer,ur as AudioEditor,Qs as BufferPlayer,s as Constants,Zs as EventEmitter,Ys as EventType,tr as GenericConfigService,cs as UtilFunctions,fr as VoiceRecorder};
//# sourceMappingURL=SimpleSoundStudioLibrary.js.map
