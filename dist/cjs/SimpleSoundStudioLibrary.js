"use strict";function e(e,t,i,r){var n,s=arguments.length,o=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(o=(s<3?n(o):s>3?n(t,i,o):n(t,i))||o);return s>3&&o&&Object.defineProperty(t,i,o),o}function t(e,t){return function(i,r){t(i,r,e)}}function i(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function r(e,t,i,r){return new(i||(i=Promise))(function(n,s){function o(e){try{c(r.next(e))}catch(e){s(e)}}function a(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(o,a)}c((r=r.apply(e,t||[])).next())})}"function"==typeof SuppressedError&&SuppressedError;var n,s="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},o={};function a(e){return("object"==typeof e&&null!==e||"function"==typeof e)&&"function"==typeof e.then}function c(e){switch(typeof e){case"string":case"symbol":return e.toString();case"function":return e.name;default:throw new Error(`Unexpected ${typeof e} service id type`)}}!function(){return n||(n=1,function(e){!function(){var t="object"==typeof globalThis?globalThis:"object"==typeof s?s:"object"==typeof self?self:"object"==typeof this?this:function(){try{return Function("return this;")()}catch(e){}}()||function(){try{return(0,eval)("(function() { return this; })()")}catch(e){}}(),i=r(e);function r(e,t){return function(i,r){Object.defineProperty(e,i,{configurable:!0,writable:!0,value:r}),t&&t(i,r)}}void 0!==t.Reflect&&(i=r(t.Reflect,i)),function(e,t){var i=Object.prototype.hasOwnProperty,r="function"==typeof Symbol,n=r&&void 0!==Symbol.toPrimitive?Symbol.toPrimitive:"@@toPrimitive",s=r&&void 0!==Symbol.iterator?Symbol.iterator:"@@iterator",o="function"==typeof Object.create,a={__proto__:[]}instanceof Array,c=!o&&!a,u={create:o?function(){return le(Object.create(null))}:a?function(){return le({__proto__:null})}:function(){return le({})},has:c?function(e,t){return i.call(e,t)}:function(e,t){return t in e},get:c?function(e,t){return i.call(e,t)?e[t]:void 0}:function(e,t){return e[t]}},h=Object.getPrototypeOf(Function),l="function"==typeof Map&&"function"==typeof Map.prototype.entries?Map:ce(),d="function"==typeof Set&&"function"==typeof Set.prototype.entries?Set:ue(),f="function"==typeof WeakMap?WeakMap:he(),p=r?Symbol.for("@reflect-metadata:registry"):void 0,v=ne(),g=se(v);function m(e,t,i,r){if(k(i)){if(!K(e))throw new TypeError;if(!z(t))throw new TypeError;return I(e,t)}if(!K(e))throw new TypeError;if(!G(t))throw new TypeError;if(!G(r)&&!k(r)&&!L(r))throw new TypeError;return L(r)&&(r=void 0),T(e,t,i=H(i),r)}function E(e,t){function i(i,r){if(!G(i))throw new TypeError;if(!k(r)&&!Y(r))throw new TypeError;O(e,t,i,r)}return i}function y(e,t,i,r){if(!G(i))throw new TypeError;return k(r)||(r=H(r)),O(e,t,i,r)}function S(e,t,i){if(!G(t))throw new TypeError;return k(i)||(i=H(i)),B(e,t,i)}function b(e,t,i){if(!G(t))throw new TypeError;return k(i)||(i=H(i)),P(e,t,i)}function A(e,t,i){if(!G(t))throw new TypeError;return k(i)||(i=H(i)),N(e,t,i)}function _(e,t,i){if(!G(t))throw new TypeError;return k(i)||(i=H(i)),M(e,t,i)}function R(e,t){if(!G(e))throw new TypeError;return k(t)||(t=H(t)),D(e,t)}function C(e,t){if(!G(e))throw new TypeError;return k(t)||(t=H(t)),F(e,t)}function w(e,t,i){if(!G(t))throw new TypeError;if(k(i)||(i=H(i)),!G(t))throw new TypeError;k(i)||(i=H(i));var r=ae(t,i,!1);return!k(r)&&r.OrdinaryDeleteMetadata(e,t,i)}function I(e,t){for(var i=e.length-1;i>=0;--i){var r=(0,e[i])(t);if(!k(r)&&!L(r)){if(!z(r))throw new TypeError;t=r}}return t}function T(e,t,i,r){for(var n=e.length-1;n>=0;--n){var s=(0,e[n])(t,i,r);if(!k(s)&&!L(s)){if(!G(s))throw new TypeError;r=s}}return r}function B(e,t,i){if(P(e,t,i))return!0;var r=ie(t);return!L(r)&&B(e,r,i)}function P(e,t,i){var r=ae(t,i,!1);return!k(r)&&j(r.OrdinaryHasOwnMetadata(e,t,i))}function N(e,t,i){if(P(e,t,i))return M(e,t,i);var r=ie(t);return L(r)?void 0:N(e,r,i)}function M(e,t,i){var r=ae(t,i,!1);if(!k(r))return r.OrdinaryGetOwnMetadata(e,t,i)}function O(e,t,i,r){ae(i,r,!0).OrdinaryDefineOwnMetadata(e,t,i,r)}function D(e,t){var i=F(e,t),r=ie(e);if(null===r)return i;var n=D(r,t);if(n.length<=0)return i;if(i.length<=0)return n;for(var s=new d,o=[],a=0,c=i;a<c.length;a++){var u=c[a];s.has(u)||(s.add(u),o.push(u))}for(var h=0,l=n;h<l.length;h++){u=l[h];s.has(u)||(s.add(u),o.push(u))}return o}function F(e,t){var i=ae(e,t,!1);return i?i.OrdinaryOwnMetadataKeys(e,t):[]}function x(e){if(null===e)return 1;switch(typeof e){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return null===e?1:6;default:return 6}}function k(e){return void 0===e}function L(e){return null===e}function U(e){return"symbol"==typeof e}function G(e){return"object"==typeof e?null!==e:"function"==typeof e}function W(e,t){switch(x(e)){case 0:case 1:case 2:case 3:case 4:case 5:return e}var i="string",r=Q(e,n);if(void 0!==r){var s=r.call(e,i);if(G(s))throw new TypeError;return s}return V(e)}function V(e,t){var i,r,n=e.toString;if($(n)&&!G(r=n.call(e)))return r;if($(i=e.valueOf)&&!G(r=i.call(e)))return r;throw new TypeError}function j(e){return!!e}function q(e){return""+e}function H(e){var t=W(e);return U(t)?t:q(t)}function K(e){return Array.isArray?Array.isArray(e):e instanceof Object?e instanceof Array:"[object Array]"===Object.prototype.toString.call(e)}function $(e){return"function"==typeof e}function z(e){return"function"==typeof e}function Y(e){switch(x(e)){case 3:case 4:return!0;default:return!1}}function X(e,t){return e===t||e!=e&&t!=t}function Q(e,t){var i=e[t];if(null!=i){if(!$(i))throw new TypeError;return i}}function Z(e){var t=Q(e,s);if(!$(t))throw new TypeError;var i=t.call(e);if(!G(i))throw new TypeError;return i}function J(e){return e.value}function ee(e){var t=e.next();return!t.done&&t}function te(e){var t=e.return;t&&t.call(e)}function ie(e){var t=Object.getPrototypeOf(e);if("function"!=typeof e||e===h)return t;if(t!==h)return t;var i=e.prototype,r=i&&Object.getPrototypeOf(i);if(null==r||r===Object.prototype)return t;var n=r.constructor;return"function"!=typeof n||n===e?t:n}function re(){var e,i,r,n;k(p)||void 0===t.Reflect||p in t.Reflect||"function"!=typeof t.Reflect.defineMetadata||(e=oe(t.Reflect));var s=new f,o={registerProvider:a,getProvider:u,setProvider:v};return o;function a(t){if(!Object.isExtensible(o))throw new Error("Cannot add provider to a frozen registry.");switch(!0){case e===t:break;case k(i):i=t;break;case i===t:break;case k(r):r=t;break;case r===t:break;default:void 0===n&&(n=new d),n.add(t)}}function c(t,s){if(!k(i)){if(i.isProviderFor(t,s))return i;if(!k(r)){if(r.isProviderFor(t,s))return i;if(!k(n))for(var o=Z(n);;){var a=ee(o);if(!a)return;var c=J(a);if(c.isProviderFor(t,s))return te(o),c}}}if(!k(e)&&e.isProviderFor(t,s))return e}function u(e,t){var i,r=s.get(e);return k(r)||(i=r.get(t)),k(i)?(k(i=c(e,t))||(k(r)&&(r=new l,s.set(e,r)),r.set(t,i)),i):i}function h(e){if(k(e))throw new TypeError;return i===e||r===e||!k(n)&&n.has(e)}function v(e,t,i){if(!h(i))throw new Error("Metadata provider not registered.");var r=u(e,t);if(r!==i){if(!k(r))return!1;var n=s.get(e);k(n)&&(n=new l,s.set(e,n)),n.set(t,i)}return!0}}function ne(){var e;return!k(p)&&G(t.Reflect)&&Object.isExtensible(t.Reflect)&&(e=t.Reflect[p]),k(e)&&(e=re()),!k(p)&&G(t.Reflect)&&Object.isExtensible(t.Reflect)&&Object.defineProperty(t.Reflect,p,{enumerable:!1,configurable:!1,writable:!1,value:e}),e}function se(e){var t=new f,i={isProviderFor:function(e,i){var r=t.get(e);return!k(r)&&r.has(i)},OrdinaryDefineOwnMetadata:o,OrdinaryHasOwnMetadata:n,OrdinaryGetOwnMetadata:s,OrdinaryOwnMetadataKeys:a,OrdinaryDeleteMetadata:c};return v.registerProvider(i),i;function r(r,n,s){var o=t.get(r),a=!1;if(k(o)){if(!s)return;o=new l,t.set(r,o),a=!0}var c=o.get(n);if(k(c)){if(!s)return;if(c=new l,o.set(n,c),!e.setProvider(r,n,i))throw o.delete(n),a&&t.delete(r),new Error("Wrong provider for target.")}return c}function n(e,t,i){var n=r(t,i,!1);return!k(n)&&j(n.has(e))}function s(e,t,i){var n=r(t,i,!1);if(!k(n))return n.get(e)}function o(e,t,i,n){r(i,n,!0).set(e,t)}function a(e,t){var i=[],n=r(e,t,!1);if(k(n))return i;for(var s=Z(n.keys()),o=0;;){var a=ee(s);if(!a)return i.length=o,i;var c=J(a);try{i[o]=c}catch(e){try{te(s)}finally{throw e}}o++}}function c(e,i,n){var s=r(i,n,!1);if(k(s))return!1;if(!s.delete(e))return!1;if(0===s.size){var o=t.get(i);k(o)||(o.delete(n),0===o.size&&t.delete(o))}return!0}}function oe(e){var t=e.defineMetadata,i=e.hasOwnMetadata,r=e.getOwnMetadata,n=e.getOwnMetadataKeys,s=e.deleteMetadata,o=new f,a={isProviderFor:function(e,t){var i=o.get(e);return!(k(i)||!i.has(t))||!!n(e,t).length&&(k(i)&&(i=new d,o.set(e,i)),i.add(t),!0)},OrdinaryDefineOwnMetadata:t,OrdinaryHasOwnMetadata:i,OrdinaryGetOwnMetadata:r,OrdinaryOwnMetadataKeys:n,OrdinaryDeleteMetadata:s};return a}function ae(e,t,i){var r=v.getProvider(e,t);if(!k(r))return r;if(i){if(v.setProvider(e,t,g))return g;throw new Error("Illegal state.")}}function ce(){var e={},t=[],i=function(){function e(e,t,i){this._index=0,this._keys=e,this._values=t,this._selector=i}return e.prototype["@@iterator"]=function(){return this},e.prototype[s]=function(){return this},e.prototype.next=function(){var e=this._index;if(e>=0&&e<this._keys.length){var i=this._selector(this._keys[e],this._values[e]);return e+1>=this._keys.length?(this._index=-1,this._keys=t,this._values=t):this._index++,{value:i,done:!1}}return{value:void 0,done:!0}},e.prototype.throw=function(e){throw this._index>=0&&(this._index=-1,this._keys=t,this._values=t),e},e.prototype.return=function(e){return this._index>=0&&(this._index=-1,this._keys=t,this._values=t),{value:e,done:!0}},e}(),r=function(){function t(){this._keys=[],this._values=[],this._cacheKey=e,this._cacheIndex=-2}return Object.defineProperty(t.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),t.prototype.has=function(e){return this._find(e,!1)>=0},t.prototype.get=function(e){var t=this._find(e,!1);return t>=0?this._values[t]:void 0},t.prototype.set=function(e,t){var i=this._find(e,!0);return this._values[i]=t,this},t.prototype.delete=function(t){var i=this._find(t,!1);if(i>=0){for(var r=this._keys.length,n=i+1;n<r;n++)this._keys[n-1]=this._keys[n],this._values[n-1]=this._values[n];return this._keys.length--,this._values.length--,X(t,this._cacheKey)&&(this._cacheKey=e,this._cacheIndex=-2),!0}return!1},t.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=e,this._cacheIndex=-2},t.prototype.keys=function(){return new i(this._keys,this._values,n)},t.prototype.values=function(){return new i(this._keys,this._values,o)},t.prototype.entries=function(){return new i(this._keys,this._values,a)},t.prototype["@@iterator"]=function(){return this.entries()},t.prototype[s]=function(){return this.entries()},t.prototype._find=function(e,t){if(!X(this._cacheKey,e)){this._cacheIndex=-1;for(var i=0;i<this._keys.length;i++)if(X(this._keys[i],e)){this._cacheIndex=i;break}}return this._cacheIndex<0&&t&&(this._cacheIndex=this._keys.length,this._keys.push(e),this._values.push(void 0)),this._cacheIndex},t}();return r;function n(e,t){return e}function o(e,t){return t}function a(e,t){return[e,t]}}function ue(){return function(){function e(){this._map=new l}return Object.defineProperty(e.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),e.prototype.has=function(e){return this._map.has(e)},e.prototype.add=function(e){return this._map.set(e,e),this},e.prototype.delete=function(e){return this._map.delete(e)},e.prototype.clear=function(){this._map.clear()},e.prototype.keys=function(){return this._map.keys()},e.prototype.values=function(){return this._map.keys()},e.prototype.entries=function(){return this._map.entries()},e.prototype["@@iterator"]=function(){return this.keys()},e.prototype[s]=function(){return this.keys()},e}()}function he(){var e=16,t=u.create(),r=n();return function(){function e(){this._key=n()}return e.prototype.has=function(e){var t=s(e,!1);return void 0!==t&&u.has(t,this._key)},e.prototype.get=function(e){var t=s(e,!1);return void 0!==t?u.get(t,this._key):void 0},e.prototype.set=function(e,t){return s(e,!0)[this._key]=t,this},e.prototype.delete=function(e){var t=s(e,!1);return void 0!==t&&delete t[this._key]},e.prototype.clear=function(){this._key=n()},e}();function n(){var e;do{e="@@WeakMap@@"+c()}while(u.has(t,e));return t[e]=!0,e}function s(e,t){if(!i.call(e,r)){if(!t)return;Object.defineProperty(e,r,{value:u.create()})}return e[r]}function o(e,t){for(var i=0;i<t;++i)e[i]=255*Math.random()|0;return e}function a(e){if("function"==typeof Uint8Array){var t=new Uint8Array(e);return"undefined"!=typeof crypto?crypto.getRandomValues(t):"undefined"!=typeof msCrypto?msCrypto.getRandomValues(t):o(t,e),t}return o(new Array(e),e)}function c(){var t=a(e);t[6]=79&t[6]|64,t[8]=191&t[8]|128;for(var i="",r=0;r<e;++r){var n=t[r];4!==r&&6!==r&&8!==r||(i+="-"),n<16&&(i+="0"),i+=n.toString(16).toLowerCase()}return i}}function le(e){return e.__=void 0,delete e.__,e}e("decorate",m),e("metadata",E),e("defineMetadata",y),e("hasMetadata",S),e("hasOwnMetadata",b),e("getMetadata",A),e("getOwnMetadata",_),e("getMetadataKeys",R),e("getOwnMetadataKeys",C),e("deleteMetadata",w)}(i,t),void 0===t.Reflect&&(t.Reflect=e)}()}(e||(e={}))),o;var e}();const u=Symbol.for("@inversifyjs/common/islazyServiceIdentifier");class h{[u];#e;constructor(e){this.#e=e,this[u]=!0}static is(e){return"object"==typeof e&&null!==e&&!0===e[u]}unwrap(){return this.#e()}}function l(e,t,i){return Reflect.getOwnMetadata(t,e,i)}function d(e,t,i,r){Reflect.defineMetadata(t,i,e,r)}function f(e,t,i,r,n){const s=r(l(e,t,n)??i());Reflect.defineMetadata(t,s,e,n)}const p="@inversifyjs/container/bindingId";function v(){const e=l(Object,p)??0;return e===Number.MAX_SAFE_INTEGER?d(Object,p,Number.MIN_SAFE_INTEGER):f(Object,p,()=>e,e=>e+1),e}const g="Request",m="Singleton",E="Transient",y="ConstantValue",S="DynamicValue",b="Factory",A="Instance",_="Provider",R="ResolvedValue",C="ServiceRedirection";function*w(...e){for(const t of e)yield*t}class I{#e;#t;#i;constructor(e){this.#e=new Map,this.#t={};for(const t of Reflect.ownKeys(e))this.#t[t]=new Map;this.#i=e}add(e,t){this.#r(e).push(t);for(const i of Reflect.ownKeys(t))this.#n(i,t[i]).push(e)}clone(){const e=this.#s(),t=this.#o(),i=Reflect.ownKeys(this.#i),r=this._buildNewInstance(this.#i);this.#a(this.#e,r.#e,e,t);for(const t of i)this.#c(this.#t[t],r.#t[t],e);return r}get(e,t){return this.#t[e].get(t)}getAllKeys(e){return this.#t[e].keys()}removeByRelation(e,t){const i=this.get(e,t);if(void 0===i)return;const r=new Set(i);for(const i of r){const r=this.#e.get(i);if(void 0===r)throw new Error("Expecting model relation, none found");for(const n of r)n[e]===t&&this.#u(i,n);this.#e.delete(i)}}_buildNewInstance(e){return new I(e)}_cloneModel(e){return e}_cloneRelation(e){return e}#s(){const e=new Map;for(const t of this.#e.keys()){const i=this._cloneModel(t);e.set(t,i)}return e}#o(){const e=new Map;for(const t of this.#e.values())for(const i of t){const t=this._cloneRelation(i);e.set(i,t)}return e}#r(e){let t=this.#e.get(e);return void 0===t&&(t=[],this.#e.set(e,t)),t}#n(e,t){let i=this.#t[e].get(t);return void 0===i&&(i=[],this.#t[e].set(t,i)),i}#h(e,t){const i=t.get(e);if(void 0===i)throw new Error("Expecting model to be cloned, none found");return i}#l(e,t){const i=t.get(e);if(void 0===i)throw new Error("Expecting relation to be cloned, none found");return i}#c(e,t,i){for(const[r,n]of e){const e=new Array;for(const t of n)e.push(this.#h(t,i));t.set(r,e)}}#a(e,t,i,r){for(const[n,s]of e){const e=new Array;for(const t of s)e.push(this.#l(t,r));t.set(this.#h(n,i),e)}}#u(e,t){for(const i of Reflect.ownKeys(t))this.#d(e,i,t[i])}#d(e,t,i){const r=this.#t[t].get(i);if(void 0!==r){const n=r.indexOf(e);-1!==n&&r.splice(n,1),0===r.length&&this.#t[t].delete(i)}}}var T;!function(e){e.moduleId="moduleId",e.serviceId="serviceId"}(T||(T={}));class B{#f;#p;constructor(e,t){this.#f=t??new I({moduleId:{isOptional:!0},serviceId:{isOptional:!1}}),this.#p=e}static build(e){return new B(e)}add(e,t){this.#f.add(e,t)}clone(){return new B(this.#p,this.#f.clone())}get(e){const t=[],i=this.#f.get(T.serviceId,e);void 0!==i&&t.push(i);const r=this.#p()?.get(e);if(void 0!==r&&t.push(r),0!==t.length)return w(...t)}removeAllByModuleId(e){this.#f.removeByRelation(T.moduleId,e)}removeAllByServiceId(e){this.#f.removeByRelation(T.serviceId,e)}}const P="@inversifyjs/core/classMetadataReflectKey";function N(){return{constructorArguments:[],lifecycle:{postConstructMethodNames:new Set,preDestroyMethodNames:new Set},properties:new Map,scope:void 0}}const M="@inversifyjs/core/pendingClassMetadataCountReflectKey",O=Symbol.for("@inversifyjs/core/InversifyCoreError");class D extends Error{[O];kind;constructor(e,t,i){super(t,i),this[O]=!0,this.kind=e}static is(e){return"object"==typeof e&&null!==e&&!0===e[O]}static isErrorOfKind(e,t){return D.is(e)&&e.kind===t}}var F,x,k,L,U;function G(e){const t=l(e,P)??N();if(!function(e){const t=l(e,M);return void 0!==t&&0!==t}(e))return function(e,t){const i=[];if(t.length<e.length)throw new D(F.missingInjectionDecorator,`Found unexpected missing metadata on type "${e.name}". "${e.name}" constructor requires at least ${e.length.toString()} arguments, found ${t.length.toString()} instead.\nAre you using @inject, @multiInject or @unmanaged decorators in every non optional constructor argument?\n\nIf you're using typescript and want to rely on auto injection, set "emitDecoratorMetadata" compiler option to true`);for(let e=0;e<t.length;++e)void 0===t[e]&&i.push(e);if(i.length>0)throw new D(F.missingInjectionDecorator,`Found unexpected missing metadata on type "${e.name}" at constructor indexes "${i.join('", "')}".\n\nAre you using @inject, @multiInject or @unmanaged decorators at those indexes?\n\nIf you're using typescript and want to rely on auto injection, set "emitDecoratorMetadata" compiler option to true`)}(e,t.constructorArguments),t;!function(e,t){const i=[];for(let r=0;r<t.constructorArguments.length;++r){const n=t.constructorArguments[r];void 0!==n&&n.kind!==x.unknown||i.push(`  - Missing or incomplete metadata for type "${e.name}" at constructor argument with index ${r.toString()}.\nEvery constructor parameter must be decorated either with @inject, @multiInject or @unmanaged decorator.`)}for(const[r,n]of t.properties)n.kind===x.unknown&&i.push(`  - Missing or incomplete metadata for type "${e.name}" at property "${r.toString()}".\nThis property must be decorated either with @inject or @multiInject decorator.`);if(0===i.length)throw new D(F.unknown,`Unexpected class metadata for type "${e.name}" with uncompletion traces.\nThis might be caused by one of the following reasons:\n\n1. A third party library is targeting inversify reflection metadata.\n2. A bug is causing the issue. Consider submiting an issue to fix it.`);throw new D(F.missingInjectionDecorator,`Invalid class metadata at type ${e.name}:\n\n${i.join("\n\n")}`)}(e,t)}function W(e,t){const i=G(t).scope??e.scope;return{cache:{isRight:!1,value:void 0},id:v(),implementationType:t,isSatisfiedBy:()=>!0,moduleId:void 0,onActivation:void 0,onDeactivation:void 0,scope:i,serviceIdentifier:t,type:A}}function V(e){return e.isRight?{isRight:!0,value:e.value}:e}!function(e){e[e.injectionDecoratorConflict=0]="injectionDecoratorConflict",e[e.missingInjectionDecorator=1]="missingInjectionDecorator",e[e.planning=2]="planning",e[e.resolution=3]="resolution",e[e.unknown=4]="unknown"}(F||(F={})),function(e){e[e.unknown=32]="unknown"}(x||(x={})),function(e){e.id="id",e.moduleId="moduleId",e.serviceId="serviceId"}(k||(k={}));let j=class e extends I{_buildNewInstance(t){return new e(t)}_cloneModel(e){return function(e){switch(e.type){case y:case S:return function(e){return{cache:V(e.cache),id:e.id,isSatisfiedBy:e.isSatisfiedBy,moduleId:e.moduleId,onActivation:e.onActivation,onDeactivation:e.onDeactivation,scope:e.scope,serviceIdentifier:e.serviceIdentifier,type:e.type,value:e.value}}(e);case b:return function(e){return{cache:V(e.cache),factory:e.factory,id:e.id,isSatisfiedBy:e.isSatisfiedBy,moduleId:e.moduleId,onActivation:e.onActivation,onDeactivation:e.onDeactivation,scope:e.scope,serviceIdentifier:e.serviceIdentifier,type:e.type}}(e);case A:return function(e){return{cache:V(e.cache),id:e.id,implementationType:e.implementationType,isSatisfiedBy:e.isSatisfiedBy,moduleId:e.moduleId,onActivation:e.onActivation,onDeactivation:e.onDeactivation,scope:e.scope,serviceIdentifier:e.serviceIdentifier,type:e.type}}(e);case _:return function(e){return{cache:V(e.cache),id:e.id,isSatisfiedBy:e.isSatisfiedBy,moduleId:e.moduleId,onActivation:e.onActivation,onDeactivation:e.onDeactivation,provider:e.provider,scope:e.scope,serviceIdentifier:e.serviceIdentifier,type:e.type}}(e);case R:return function(e){return{cache:V(e.cache),factory:e.factory,id:e.id,isSatisfiedBy:e.isSatisfiedBy,metadata:e.metadata,moduleId:e.moduleId,onActivation:e.onActivation,onDeactivation:e.onDeactivation,scope:e.scope,serviceIdentifier:e.serviceIdentifier,type:e.type}}(e);case C:return function(e){return{id:e.id,isSatisfiedBy:e.isSatisfiedBy,moduleId:e.moduleId,serviceIdentifier:e.serviceIdentifier,targetServiceIdentifier:e.targetServiceIdentifier,type:e.type}}(e)}}(e)}},q=class e{#v;#g;#p;constructor(e,t,i){this.#g=i??new j({id:{isOptional:!1},moduleId:{isOptional:!0},serviceId:{isOptional:!1}}),this.#p=e,this.#v=t}static build(t,i){return new e(t,i)}clone(){return new e(this.#p,this.#v,this.#g.clone())}get(e){const t=this.getNonParentBindings(e)??this.#p()?.get(e);if(void 0!==t)return t;const i=this.#m(e);return void 0===i?i:[i]}*getChained(e){const t=this.getNonParentBindings(e);void 0!==t&&(yield*t);const i=this.#p();if(void 0===i){if(void 0===t){const t=this.#m(e);void 0!==t&&(yield t)}}else yield*i.getChained(e)}getBoundServices(){const e=new Set(this.#g.getAllKeys(k.serviceId)),t=this.#p();if(void 0!==t)for(const i of t.getBoundServices())e.add(i);return e}getById(e){return this.#g.get(k.id,e)??this.#p()?.getById(e)}getByModuleId(e){return this.#g.get(k.moduleId,e)??this.#p()?.getByModuleId(e)}getNonParentBindings(e){return this.#g.get(k.serviceId,e)}getNonParentBoundServices(){return this.#g.getAllKeys(k.serviceId)}removeById(e){this.#g.removeByRelation(k.id,e)}removeAllByModuleId(e){this.#g.removeByRelation(k.moduleId,e)}removeAllByServiceId(e){this.#g.removeByRelation(k.serviceId,e)}set(e){const t={[k.id]:e.id,[k.serviceId]:e.serviceIdentifier};void 0!==e.moduleId&&(t[k.moduleId]=e.moduleId),this.#g.add(e,t)}#m(e){if(void 0===this.#v||"function"!=typeof e)return;const t=W(this.#v,e);return this.set(t),t}};!function(e){e.moduleId="moduleId",e.serviceId="serviceId"}(L||(L={}));let H=class e{#E;#p;constructor(e,t){this.#E=t??new I({moduleId:{isOptional:!0},serviceId:{isOptional:!1}}),this.#p=e}static build(t){return new e(t)}add(e,t){this.#E.add(e,t)}clone(){return new e(this.#p,this.#E.clone())}get(e){const t=[],i=this.#E.get(L.serviceId,e);void 0!==i&&t.push(i);const r=this.#p()?.get(e);if(void 0!==r&&t.push(r),0!==t.length)return w(...t)}removeAllByModuleId(e){this.#E.removeByRelation(L.moduleId,e)}removeAllByServiceId(e){this.#E.removeByRelation(L.serviceId,e)}};function K(){return 0}function $(e){return t=>{void 0!==t&&t.kind===x.unknown&&f(e,M,K,e=>e-1)}}!function(e){e[e.multipleInjection=0]="multipleInjection",e[e.singleInjection=1]="singleInjection",e[e.unmanaged=2]="unmanaged"}(U||(U={}));const z=function(e,t){return(...i)=>r=>{if(void 0===r)return e(...i);if(r.kind===U.unmanaged)throw new D(F.injectionDecoratorConflict,"Unexpected injection found. Multiple @inject, @multiInject or @unmanaged decorators found");return t(r,...i)}}(function(e,t,i){return e===U.multipleInjection?{chained:i?.chained??!1,kind:e,name:void 0,optional:!1,tags:new Map,value:t}:{kind:e,name:void 0,optional:!1,tags:new Map,value:t}},function(e,t,i,r){return function(e){if(e.kind!==x.unknown&&!0!==e.isFromTypescriptParamType)throw new D(F.injectionDecoratorConflict,"Unexpected injection found. Multiple @inject, @multiInject or @unmanaged decorators found")}(e),t===U.multipleInjection?{...e,chained:r?.chained??!1,kind:t,value:i}:{...e,kind:t,value:i}});function Y(e,t){return i=>{const r=i.properties.get(t);return i.properties.set(t,e(r)),i}}var X;function Q(e,t,i,r){if(D.isErrorOfKind(r,F.injectionDecoratorConflict)){const n=function(e,t,i){if(void 0===i){if(void 0===t)throw new D(F.unknown,"Unexpected undefined property and index values");return{kind:X.property,property:t,targetClass:e.constructor}}return"number"==typeof i?{index:i,kind:X.parameter,targetClass:e}:{kind:X.method,method:t,targetClass:e}}(e,t,i);throw new D(F.injectionDecoratorConflict,`Unexpected injection error.\n\nCause:\n\n${r.message}\n\nDetails\n\n${function(e){switch(e.kind){case X.method:return`[class: "${e.targetClass.name}", method: "${e.method.toString()}"]`;case X.parameter:return`[class: "${e.targetClass.name}", index: "${e.index.toString()}"]`;case X.property:return`[class: "${e.targetClass.name}", property: "${e.property.toString()}"]`}}(n)}`,{cause:r})}throw r}function Z(e,t){return(i,r,n)=>{try{void 0===n?function(e,t){const i=J(e,t);return(e,t)=>{f(e.constructor,P,N,Y(i(e),t))}}(e,t)(i,r):"number"==typeof n?function(e,t){const i=J(e,t);return(e,t,r)=>{if(!function(e,t){return"function"==typeof e&&void 0===t}(e,t))throw new D(F.injectionDecoratorConflict,`Found an @inject decorator in a non constructor parameter.\nFound @inject decorator at method "${t?.toString()??""}" at class "${e.constructor.name}"`);f(e,P,N,function(e,t){return i=>{const r=i.constructorArguments[t];return i.constructorArguments[t]=e(r),i}}(i(e),r))}}(e,t)(i,r,n):function(e,t){const i=J(e,t);return(e,t,r)=>{if(!function(e){return void 0!==e.set}(r))throw new D(F.injectionDecoratorConflict,`Found an @inject decorator in a non setter property method.\nFound @inject decorator at method "${t.toString()}" at class "${e.constructor.name}"`);f(e.constructor,P,N,Y(i(e),t))}}(e,t)(i,r,n)}catch(e){Q(i,r,n,e)}}}function J(e,t){return i=>{const r=t(i);return t=>(r(t),e(t))}}function ee(e){return Z(z(U.singleInjection,e),$)}!function(e){e[e.method=0]="method",e[e.parameter=1]="parameter",e[e.property=2]="property"}(X||(X={}));const te="@inversifyjs/core/classIsInjectableFlagReflectKey",ie=[Array,BigInt,Boolean,Function,Number,Object,String];function re(e){return e=>{!function(e){if(void 0!==l(e,te))throw new D(F.injectionDecoratorConflict,`Cannot apply @injectable decorator multiple times at class "${e.name}"`);d(e,te,!0)}(e),function(e){const t=l(e,"design:paramtypes");void 0!==t&&f(e,P,N,function(e){return t=>(e.forEach((e,i)=>{var r;void 0!==t.constructorArguments[i]||(r=e,ie.includes(r))||(t.constructorArguments[i]=function(e){return{isFromTypescriptParamType:!0,kind:U.singleInjection,name:void 0,optional:!1,tags:new Map,value:e}}(e))}),t)}(t))}(e)}}function ne(e,t,i){let r;return e.extendConstructorArguments??1?(r=[...t.constructorArguments],i.constructorArguments.map((e,t)=>{r[t]=e})):r=i.constructorArguments,r}function se(e,t,i){return e?new Set([...t,...i]):i}function oe(e,t,i){const r=e.lifecycle?.extendPostConstructMethods??!0,n=se(e.lifecycle?.extendPreDestroyMethods??!0,t.lifecycle.preDestroyMethodNames,i.lifecycle.preDestroyMethodNames);return{postConstructMethodNames:se(r,t.lifecycle.postConstructMethodNames,i.lifecycle.postConstructMethodNames),preDestroyMethodNames:n}}function ae(e,t,i){let r;return r=e.extendProperties??1?new Map(w(t.properties,i.properties)):i.properties,r}function ce(e){return t=>{const i=function(e){const t=Object.getPrototypeOf(e.prototype),i=t?.constructor;return i}(t);if(void 0===i)throw new D(F.injectionDecoratorConflict,`Expected base type for type "${t.name}", none found.`);!function(e){return t=>{const i=G(e.type);f(t,P,N,function(e,t){return i=>({constructorArguments:ne(e,t,i),lifecycle:oe(e,t,i),properties:ae(e,t,i),scope:i.scope})}(e,i))}}({...e,type:i})(t)}}function ue(e,t){return Z(z(U.multipleInjection,e,t),$)}function he(){return(e,t,i)=>{try{f(e.constructor,P,N,(r=t,e=>{if(e.lifecycle.postConstructMethodNames.has(r))throw new D(F.injectionDecoratorConflict,`Unexpected duplicated postConstruct method ${r.toString()}`);return e.lifecycle.postConstructMethodNames.add(r),e}))}catch(i){Q(e,t,void 0,i)}var r}}var le;function de(e){return e instanceof Error&&(e instanceof RangeError&&/stack space|call stack|too much recursion/i.test(e.message)||"InternalError"===e.name&&/too much recursion/.test(e.message))}!function(e){e[e.multipleInjection=0]="multipleInjection",e[e.singleInjection=1]="singleInjection"}(le||(le={}));const fe=Symbol.for("@inversifyjs/core/LazyPlanServiceNode");class pe{[fe];_serviceIdentifier;_serviceNode;constructor(e,t){this[fe]=!0,this._serviceNode=e,this._serviceIdentifier=t}get bindings(){return this._getNode().bindings}get isContextFree(){return this._getNode().isContextFree}get serviceIdentifier(){return this._serviceIdentifier}set bindings(e){this._getNode().bindings=e}set isContextFree(e){this._getNode().isContextFree=e}static is(e){return"object"==typeof e&&null!==e&&!0===e[fe]}invalidate(){this._serviceNode=void 0}isExpanded(){return void 0!==this._serviceNode}_getNode(){return void 0===this._serviceNode&&(this._serviceNode=this._buildPlanServiceNode()),this._serviceNode}}class ve{#y;constructor(e){this.#y=e}get name(){return this.#y.elem.name}get serviceIdentifier(){return this.#y.elem.serviceIdentifier}get tags(){return this.#y.elem.tags}getAncestor(){if(this.#y.elem.getAncestorsCalled=!0,void 0!==this.#y.previous)return new ve(this.#y.previous)}}function ge(e,t,i){const r=i?.customServiceIdentifier??t.serviceIdentifier,n=(!0===i?.chained?[...e.operations.getBindingsChained(r)]:[...e.operations.getBindings(r)??[]]).filter(e=>e.isSatisfiedBy(t));if(0===n.length&&void 0!==e.autobindOptions&&"function"==typeof r){const i=W(e.autobindOptions,r);e.operations.setBinding(i),i.isSatisfiedBy(t)&&n.push(i)}return n}class me{last;constructor(e){this.last=e}concat(e){return new me({elem:e,previous:this.last})}[Symbol.iterator](){let e=this.last;return{next:()=>{if(void 0===e)return{done:!0,value:void 0};const t=e.elem;return e=e.previous,{done:!1,value:t}}}}}function Ee(e){const t=new Map;return void 0!==e.rootConstraints.tag&&t.set(e.rootConstraints.tag.key,e.rootConstraints.tag.value),new me({elem:{getAncestorsCalled:!1,name:e.rootConstraints.name,serviceIdentifier:e.rootConstraints.serviceIdentifier,tags:t},previous:void 0})}function ye(e){return void 0!==e.redirections}function Se(e,t,i,r){const n=i.elem.serviceIdentifier,s=i.previous?.elem.serviceIdentifier;Array.isArray(e)?function(e,t,i,r,n,s){if(0!==e.length){const t=`Ambiguous bindings found for service: "${c(s[s.length-1]??i)}".${Re(s)}\n\nRegistered bindings:\n\n${e.map(e=>function(e){switch(e.type){case A:return`[ type: "${e.type}", serviceIdentifier: "${c(e.serviceIdentifier)}", scope: "${e.scope}", implementationType: "${e.implementationType.name}" ]`;case C:return`[ type: "${e.type}", serviceIdentifier: "${c(e.serviceIdentifier)}", redirection: "${c(e.targetServiceIdentifier)}" ]`;default:return`[ type: "${e.type}", serviceIdentifier: "${c(e.serviceIdentifier)}", scope: "${e.scope}" ]`}}(e.binding)).join("\n")}\n\nTrying to resolve bindings for "${Ae(i,r)}".${_e(n)}`;throw new D(F.planning,t)}t||be(i,r,n,s)}(e,t,n,s,i.elem,r):function(e,t,i,r,n,s){void 0!==e||t||be(i,r,n,s)}(e,t,n,s,i.elem,r)}function be(e,t,i,r){const n=`No bindings found for service: "${c(r[r.length-1]??e)}".\n\nTrying to resolve bindings for "${Ae(e,t)}".${Re(r)}${_e(i)}`;throw new D(F.planning,n)}function Ae(e,t){return void 0===t?`${c(e)} (Root service)`:c(t)}function _e(e){const t=0===e.tags.size?"":`\n- tags:\n  - ${[...e.tags.keys()].map(e=>e.toString()).join("\n  - ")}`;return`\n\nBinding constraints:\n- service identifier: ${c(e.serviceIdentifier)}\n- name: ${e.name?.toString()??"-"}${t}`}function Re(e){return 0===e.length?"":`\n\n- service redirections:\n  - ${e.map(e=>c(e)).join("\n  - ")}`}function Ce(e,t,i,r){if(1===e.redirections.length){const[n]=e.redirections;return void(ye(n)&&Ce(n,t,i,[...r,n.binding.targetServiceIdentifier]))}Se(e.redirections,t,i,r)}function we(e,t,i){if(Array.isArray(e.bindings)&&1===e.bindings.length){const[r]=e.bindings;return void(ye(r)&&Ce(r,t,i,[r.binding.targetServiceIdentifier]))}Se(e.bindings,t,i,[])}function Ie(e){return h.is(e)?e.unwrap():e}function Te(e){return(t,i,r)=>{const n=Ie(r.value),s=i.concat({getAncestorsCalled:!1,name:r.name,serviceIdentifier:n,tags:r.tags}),o=new ve(s.last),a=r.kind===U.multipleInjection&&r.chained,c=ge(t,o,{chained:a}),u=[],h={bindings:u,isContextFree:!0,serviceIdentifier:n};if(u.push(...e(t,s,c,h,a)),h.isContextFree=!s.last.elem.getAncestorsCalled,r.kind===U.singleInjection){we(h,r.optional,s.last);const[e]=u;h.bindings=e}return h}}function Be(e){return(t,i,r)=>{const n=Ie(r.value),s=i.concat({getAncestorsCalled:!1,name:r.name,serviceIdentifier:n,tags:r.tags}),o=new ve(s.last),a=r.kind===le.multipleInjection&&r.chained,c=ge(t,o,{chained:a}),u=[],h={bindings:u,isContextFree:!0,serviceIdentifier:n};if(u.push(...e(t,s,c,h,a)),h.isContextFree=!s.last.elem.getAncestorsCalled,r.kind===le.singleInjection){we(h,r.optional,s.last);const[e]=u;h.bindings=e}return h}}function Pe(e){const t=function(e){return(t,i,r)=>{const n={binding:i,classMetadata:t.operations.getClassMetadata(i.implementationType),constructorParams:[],propertyParams:new Map},s={autobindOptions:t.autobindOptions,node:n,operations:t.operations,servicesBranch:t.servicesBranch};return e(s,r)}}(e),i=function(e){return(t,i,r)=>{const n={binding:i,params:[]},s={autobindOptions:t.autobindOptions,node:n,operations:t.operations,servicesBranch:t.servicesBranch};return e(s,r)}}(e),r=(e,r,s,o,a)=>{const c=ye(o)?o.binding.targetServiceIdentifier:o.serviceIdentifier;e.servicesBranch.push(c);const u=[];for(const o of s)switch(o.type){case A:u.push(t(e,o,r));break;case R:u.push(i(e,o,r));break;case C:{const t=n(e,r,o,a);u.push(t);break}default:u.push({binding:o})}return e.servicesBranch.pop(),u},n=function(e){return(t,i,r,n)=>{const s={binding:r,redirections:[]},o=ge(t,new ve(i.last),{chained:n,customServiceIdentifier:r.targetServiceIdentifier});return s.redirections.push(...e(t,i,o,s,n)),s}}(r);return r}function Ne(e,t,i,r){if(void 0!==e&&(pe.is(i)&&!i.isExpanded()||i.isContextFree)){const r={tree:{root:i}};t.setPlan(e,r)}else t.setNonCachedServiceNode(i,r)}class Me extends pe{#S;#b;#A;#_;constructor(e,t,i,r,n){super(n,Ie(r.value)),this.#b=t,this.#S=e,this.#A=i,this.#_=r}_buildPlanServiceNode(){return this.#b(this.#S,this.#A,this.#_)}}class Oe extends pe{#S;#R;#A;#C;constructor(e,t,i,r,n){super(n,Ie(r.value)),this.#S=e,this.#R=t,this.#A=i,this.#C=r}_buildPlanServiceNode(){return this.#R(this.#S,this.#A,this.#C)}}function De(e,t,i,r){const n=function(e,t){const i=function(e,t){return(i,r,n)=>{if(n.kind===U.unmanaged)return;const s=function(e){let t;if(0===e.tags.size)t=void 0;else{if(1!==e.tags.size)return;{const[i,r]=e.tags.entries().next().value;t={key:i,value:r}}}const i=h.is(e.value)?e.value.unwrap():e.value;return e.kind===U.multipleInjection?{chained:e.chained,isMultiple:!0,name:e.name,optional:e.optional,serviceIdentifier:i,tag:t}:{isMultiple:!1,name:e.name,optional:e.optional,serviceIdentifier:i,tag:t}}(n);if(void 0!==s){const e=i.operations.getPlan(s);if(void 0!==e&&e.tree.root.isContextFree)return e.tree.root}const o=t(i,r,n),a=new Me(i,e,r,n,o);return Ne(s,i.operations,a,{bindingConstraintsList:r,chainedBindings:n.kind===U.multipleInjection&&n.chained,optionalBindings:n.optional}),a}}(e,t);return(e,t,r)=>{const n=t.classMetadata;for(const[s,o]of n.constructorArguments.entries())t.constructorParams[s]=i(e,r,o);for(const[s,o]of n.properties){const n=i(e,r,o);void 0!==n&&t.propertyParams.set(s,n)}return e.node}}(e,i),s=function(e,t){const i=function(e,t){return(i,r,n)=>{const s=function(e){let t;if(0===e.tags.size)t=void 0;else{if(1!==e.tags.size)return;{const[i,r]=e.tags.entries().next().value;t={key:i,value:r}}}const i=h.is(e.value)?e.value.unwrap():e.value;return e.kind===le.multipleInjection?{chained:e.chained,isMultiple:!0,name:e.name,optional:e.optional,serviceIdentifier:i,tag:t}:{isMultiple:!1,name:e.name,optional:e.optional,serviceIdentifier:i,tag:t}}(n);if(void 0!==s){const e=i.operations.getPlan(s);if(void 0!==e&&e.tree.root.isContextFree)return e.tree.root}const o=t(i,r,n),a=new Oe(i,e,r,n,o);return Ne(s,i.operations,a,{bindingConstraintsList:r,chainedBindings:n.kind===le.multipleInjection&&n.chained,optionalBindings:n.optional}),a}}(e,t);return(e,t,r)=>{const n=t.binding.metadata;for(const[s,o]of n.arguments.entries())t.params[s]=i(e,r,o);return e.node}}(t,r);return(e,t)=>e.node.binding.type===A?n(e,e.node,t):s(e,e.node,t)}class Fe extends pe{#S;constructor(e,t){super(t,t.serviceIdentifier),this.#S=e}_buildPlanServiceNode(){return Ge(this.#S)}}const xe=Te(Ue),ke=Be(Ue),Le=Pe(De(xe,ke,xe,ke));function Ue(e,t,i,r,n){return Le(e,t,i,r,n)}const Ge=function(e){return t=>{const i=Ee(t),r=new ve(i.last),n=t.rootConstraints.isMultiple&&t.rootConstraints.chained,s=ge(t,r,{chained:n}),o=[],a={bindings:o,isContextFree:!0,serviceIdentifier:t.rootConstraints.serviceIdentifier};if(o.push(...e(t,i,s,a,n)),a.isContextFree=!i.last.elem.getAncestorsCalled,!t.rootConstraints.isMultiple){we(a,t.rootConstraints.isOptional??!1,i.last);const[e]=o;a.bindings=e}return a}}(Le);function We(e){try{const t=function(e){return e.rootConstraints.isMultiple?{chained:e.rootConstraints.chained,isMultiple:!0,name:e.rootConstraints.name,optional:e.rootConstraints.isOptional??!1,serviceIdentifier:e.rootConstraints.serviceIdentifier,tag:e.rootConstraints.tag}:{isMultiple:!1,name:e.rootConstraints.name,optional:e.rootConstraints.isOptional??!1,serviceIdentifier:e.rootConstraints.serviceIdentifier,tag:e.rootConstraints.tag}}(e),i=e.operations.getPlan(t);if(void 0!==i)return i;const r=Ge(e),n={tree:{root:new Fe(e,r)}};return e.operations.setPlan(t,n),n}catch(t){!function(e,t){if(de(t)){const i=function(e){const t=[...e];return 0===t.length?"(No dependency trace)":t.map(c).join(" -> ")}(function(e){const t=new Set;for(const i of e.servicesBranch){if(t.has(i))return[...t,i];t.add(i)}return[...t]}(e));throw new D(F.planning,`Circular dependency found: ${i}`,{cause:t})}throw t}(e,t)}}var Ve;!function(e){e.bindingAdded="bindingAdded",e.bindingRemoved="bindingRemoved"}(Ve||(Ve={}));class je{#w;#I;#T;constructor(){this.#w=[],this.#I=8,this.#T=1024}*[Symbol.iterator](){let e=0;for(const t of this.#w){const i=t.deref();void 0===i?++e:yield i}this.#w.length>=this.#I&&this.#B(e)&&this.#P(e)}push(e){const t=new WeakRef(e);if(this.#w.push(t),this.#w.length>=this.#I&&this.#w.length%this.#T===0){let e=0;for(const t of this.#w)void 0===t.deref()&&++e;this.#B(e)&&this.#P(e)}}#P(e){const t=new Array(this.#w.length-e);let i=0;for(const e of this.#w)e.deref()&&(t[i++]=e);this.#w=t}#B(e){return e>=.5*this.#w.length}}const qe=Pe(De(xe,ke,function(e,t,i){return He(e,t,i)},function(e,t,i){return Ke(e,t,i)})),He=function(){const e=Te(qe);return(t,i,r)=>{try{return e(t,i,r)}catch(t){if(D.isErrorOfKind(t,F.planning))return;throw t}}}(),Ke=function(){const e=Be(qe);return(t,i,r)=>{try{return e(t,i,r)}catch(t){if(D.isErrorOfKind(t,F.planning))return;throw t}}}();function $e(e,t,i,r,n){if(pe.is(t)&&!t.isExpanded())return{isContextFreeBinding:!0,shouldInvalidateServiceNode:!1};const s=new ve(r.last);return!i.isSatisfiedBy(s)||r.last.elem.getAncestorsCalled?{isContextFreeBinding:!r.last.elem.getAncestorsCalled,shouldInvalidateServiceNode:!1}:function(e,t,i,r,n){let s;try{[s]=qe(e,r,[i],t,n)}catch(e){if(de(e))return{isContextFreeBinding:!1,shouldInvalidateServiceNode:!0};throw e}return function(e,t){if(Array.isArray(e.bindings))e.bindings.push(t);else{if(void 0!==e.bindings){if(!pe.is(e))throw new D(F.planning,"Unexpected non-lazy plan service node. This is likely a bug in the planning logic. Please, report this issue");return{isContextFreeBinding:!0,shouldInvalidateServiceNode:!0}}e.bindings=t}return{isContextFreeBinding:!0,shouldInvalidateServiceNode:!1}}(t,s)}(e,t,i,r,n)}function ze(e,t,i,r){if(pe.is(e)&&!e.isExpanded())return{bindingNodeRemoved:void 0,isContextFreeBinding:!0};const n=new ve(i.last);if(!t.isSatisfiedBy(n)||i.last.elem.getAncestorsCalled)return{bindingNodeRemoved:void 0,isContextFreeBinding:!i.last.elem.getAncestorsCalled};let s;if(Array.isArray(e.bindings))e.bindings=e.bindings.filter(e=>e.binding!==t||(s=e,!1));else if(e.bindings?.binding===t)if(s=e.bindings,r)e.bindings=void 0;else{if(!pe.is(e))throw new D(F.planning,"Unexpected non-lazy plan service node. This is likely a bug in the planning logic. Please, report this issue");e.invalidate()}return{bindingNodeRemoved:s,isContextFreeBinding:!0}}class Ye{#N;#M;#O;#D;#F;#x;constructor(){this.#N=new Map,this.#M=this.#k(),this.#O=this.#k(),this.#D=this.#k(),this.#F=this.#k(),this.#x=new je}clearCache(){for(const e of this.#L())e.clear();for(const e of this.#x)e.clearCache()}get(e){return void 0===e.name?void 0===e.tag?this.#U(this.#M,e).get(e.serviceIdentifier):this.#U(this.#F,e).get(e.serviceIdentifier)?.get(e.tag.key)?.get(e.tag.value):void 0===e.tag?this.#U(this.#O,e).get(e.serviceIdentifier)?.get(e.name):this.#U(this.#D,e).get(e.serviceIdentifier)?.get(e.name)?.get(e.tag.key)?.get(e.tag.value)}invalidateServiceBinding(e){this.#G(e),this.#W(e),this.#V(e),this.#j(e),this.#q(e);for(const t of this.#x)t.invalidateServiceBinding(e)}set(e,t){void 0===e.name?void 0===e.tag?this.#U(this.#M,e).set(e.serviceIdentifier,t):this.#H(this.#H(this.#U(this.#F,e),e.serviceIdentifier),e.tag.key).set(e.tag.value,t):void 0===e.tag?this.#H(this.#U(this.#O,e),e.serviceIdentifier).set(e.name,t):this.#H(this.#H(this.#H(this.#U(this.#D,e),e.serviceIdentifier),e.name),e.tag.key).set(e.tag.value,t)}setNonCachedServiceNode(e,t){let i=this.#N.get(e.serviceIdentifier);void 0===i&&(i=new Map,this.#N.set(e.serviceIdentifier,i)),i.set(e,t)}subscribe(e){this.#x.push(e)}#k(){const e=new Array(8);for(let t=0;t<e.length;++t)e[t]=new Map;return e}#K(e,t,i,r){const n=!!(2&t);let s;return s=n?{chained:!!(0&t),isMultiple:n,serviceIdentifier:e.binding.serviceIdentifier}:{isMultiple:n,serviceIdentifier:e.binding.serviceIdentifier},!!(1&t)&&(s.isOptional=!0),void 0!==i&&(s.name=i),void 0!==r&&(s.tag=r),{autobindOptions:void 0,operations:e.operations,rootConstraints:s,servicesBranch:[]}}#H(e,t){let i=e.get(t);return void 0===i&&(i=new Map,e.set(t,i)),i}#U(e,t){return e[this.#$(t)]}#L(){return[this.#N,...this.#M,...this.#O,...this.#D,...this.#F]}#$(e){return e.isMultiple?(e.chained?4:0)|(e.optional?1:0)|2:e.optional?1:0}#W(e){for(const[t,i]of this.#O.entries()){const r=i.get(e.binding.serviceIdentifier);if(void 0!==r)for(const[i,n]of r.entries())this.#z(e,n,t,i,void 0)}}#V(e){for(const[t,i]of this.#D.entries()){const r=i.get(e.binding.serviceIdentifier);if(void 0!==r)for(const[i,n]of r.entries())for(const[r,s]of n.entries())for(const[n,o]of s.entries())this.#z(e,o,t,i,{key:r,value:n})}}#Y(e){switch(e.binding.type){case C:for(const t of e.redirections)this.#Y(t);break;case A:for(const t of e.constructorParams)void 0!==t&&this.#X(t);for(const t of e.propertyParams.values())this.#X(t);break;case R:for(const t of e.params)this.#X(t)}}#X(e){const t=this.#N.get(e.serviceIdentifier);void 0!==t&&t.has(e)&&(t.delete(e),this.#Q(e))}#Q(e){if((!pe.is(e)||e.isExpanded())&&void 0!==e.bindings)if(Array.isArray(e.bindings))for(const t of e.bindings)this.#Y(t);else this.#Y(e.bindings)}#q(e){const t=this.#N.get(e.binding.serviceIdentifier);if(void 0!==t)switch(e.kind){case Ve.bindingAdded:for(const[i,r]of t){const t=$e({autobindOptions:void 0,operations:e.operations,servicesBranch:[]},i,e.binding,r.bindingConstraintsList,r.chainedBindings);t.isContextFreeBinding?t.shouldInvalidateServiceNode&&pe.is(i)&&(this.#Q(i),i.invalidate()):this.clearCache()}break;case Ve.bindingRemoved:for(const[i,r]of t){const t=ze(i,e.binding,r.bindingConstraintsList,r.optionalBindings);t.isContextFreeBinding?void 0!==t.bindingNodeRemoved&&this.#Y(t.bindingNodeRemoved):this.clearCache()}}}#G(e){for(const[t,i]of this.#M.entries()){const r=i.get(e.binding.serviceIdentifier);this.#z(e,r,t,void 0,void 0)}}#j(e){for(const[t,i]of this.#F.entries()){const r=i.get(e.binding.serviceIdentifier);if(void 0!==r)for(const[i,n]of r.entries())for(const[r,s]of n.entries())this.#z(e,s,t,void 0,{key:i,value:r})}}#z(e,t,i,r,n){if(void 0!==t&&pe.is(t.tree.root)){const c=this.#K(e,i,r,n);switch(e.kind){case Ve.bindingAdded:{const i=(s=c,o=t.tree.root,a=e.binding,pe.is(o)&&!o.isExpanded()?{isContextFreeBinding:!0,shouldInvalidateServiceNode:!1}:$e(s,o,a,Ee(s),s.rootConstraints.isMultiple&&s.rootConstraints.chained));i.isContextFreeBinding?i.shouldInvalidateServiceNode&&(this.#Q(t.tree.root),t.tree.root.invalidate()):this.clearCache()}break;case Ve.bindingRemoved:{const i=function(e,t,i){return pe.is(t)&&!t.isExpanded()?{bindingNodeRemoved:void 0,isContextFreeBinding:!0}:ze(t,i,Ee(e),e.rootConstraints.isOptional??!1)}(c,t.tree.root,e.binding);i.isContextFreeBinding?void 0!==i.bindingNodeRemoved&&this.#Y(i.bindingNodeRemoved):this.clearCache()}}}var s,o,a}}function Xe(e,t){return a(t)?(e.cache={isRight:!0,value:t},t.then(t=>Qe(e,t))):Qe(e,t)}function Qe(e,t){return e.cache={isRight:!0,value:t},t}async function Ze(e,t,i){let r=await t,n=i.next();for(;!0!==n.done;)r=await n.value(e.context,r),n=i.next();return r}function Je(e,t,i){let r=i;if(void 0!==t.onActivation){const i=t.onActivation;r=a(r)?r.then(t=>i(e.context,t)):i(e.context,r)}return function(e,t,i){const r=e.getActivations(t);return void 0===r?i:a(i)?Ze(e,i,r[Symbol.iterator]()):function(e,t,i){let r=t,n=i.next();for(;!0!==n.done;){const t=n.value(e.context,r);if(a(t))return Ze(e,t,i);r=t,n=i.next()}return r}(e,i,r[Symbol.iterator]())}(e,t.serviceIdentifier,r)}function et(e){return(t,i)=>i.cache.isRight?i.cache.value:Xe(i,Je(t,i,e(t,i)))}const tt=et(function(e,t){return t.value});function it(e){return e}function rt(e,t){return(i,r)=>{const n=e(r);switch(n.scope){case m:return n.cache.isRight?n.cache.value:Xe(n,Je(i,n,t(i,r)));case g:{if(i.requestScopeCache.has(n.id))return i.requestScopeCache.get(n.id);const e=Je(i,n,t(i,r));return i.requestScopeCache.set(n.id,e),e}case E:return Je(i,n,t(i,r))}}}const nt=rt(it,function(e,t){return t.value(e.context)}),st=et(function(e,t){return t.factory(e.context)});function ot(e,t,i){const r=function(e,t,i){if(!(i in e))throw new D(F.resolution,`Expecting a "${i.toString()}" property when resolving "${t.implementationType.name}" class @postConstruct decorated method, none found.`);if("function"!=typeof e[i])throw new D(F.resolution,`Expecting a "${i.toString()}" method when resolving "${t.implementationType.name}" class @postConstruct decorated method, a non function property was found instead.`);{let r;try{r=e[i]()}catch(e){throw new D(F.resolution,`Unexpected error found when calling "${i.toString()}" @postConstruct decorated method on class "${t.implementationType.name}"`,{cause:e})}if(a(r))return async function(e,t,i){try{await i}catch(i){throw new D(F.resolution,`Unexpected error found when calling "${t.toString()}" @postConstruct decorated method on class "${e.implementationType.name}"`,{cause:i})}}(t,i,r)}}(e,t,i);return a(r)?r.then(()=>e):e}function at(e,t,i){if(0===i.size)return e;let r=e;for(const e of i)r=a(r)?r.then(i=>ot(i,t,e)):ot(r,t,e);return r}function ct(e){return(t,i,r)=>{const n=new r.binding.implementationType(...t),s=e(i,n,r);return a(s)?s.then(()=>at(n,r.binding,r.classMetadata.lifecycle.postConstructMethodNames)):at(n,r.binding,r.classMetadata.lifecycle.postConstructMethodNames)}}const ut=et(function(e,t){return t.provider(e.context)});function ht(e){return e.binding}function lt(e){return e.binding}const dt=(Et=bt,(e,t,i)=>{const r=[];for(const[n,s]of i.propertyParams){const o=i.classMetadata.properties.get(n);if(void 0===o)throw new D(F.resolution,`Expecting metadata at property "${n.toString()}", none found`);o.kind!==U.unmanaged&&void 0!==s.bindings&&(t[n]=Et(e,s),a(t[n])&&r.push((async()=>{t[n]=await t[n]})()))}if(r.length>0)return Promise.all(r).then(()=>{})}),ft=function(e){return function t(i,r){const n=[];for(const s of r.redirections)ye(s)?n.push(...t(i,s)):n.push(e(i,s));return n}}(St),pt=function(e,t,i){return(r,n)=>{const s=e(r,n);return a(s)?t(s,r,n):i(s,r,n)}}(function(e){return(t,i)=>{const r=[];for(const n of i.constructorParams)void 0===n?r.push(void 0):r.push(e(t,n));return r.some(a)?Promise.all(r):r}}(bt),function(e){return async(t,i,r)=>{const n=await t;return e(n,i,r)}}(ct(dt)),ct(dt)),vt=function(e){return(t,i)=>{const r=e(t,i);return a(r)?r.then(e=>i.binding.factory(...e)):i.binding.factory(...r)}}(function(e){return(t,i)=>{const r=[];for(const n of i.params)r.push(e(t,n));return r.some(a)?Promise.all(r):r}}(bt)),gt=rt(ht,pt),mt=rt(lt,vt);var Et;function yt(e){try{return bt(e,e.planResult.tree.root)}catch(t){!function(e,t){if(de(t)){const i=function(e){const t=[...e];return 0===t.length?"(No dependency trace)":t.map(c).join(" -> ")}(function(e){const t=e.planResult.tree.root,i=[];return function e(t){const r=i.indexOf(t);if(-1!==r)return[...i.slice(r),t].map(e=>e.serviceIdentifier);i.push(t);try{for(const i of function(e){const t=[],i=e.bindings;if(void 0===i)return t;const r=e=>{if(ye(e))for(const t of e.redirections)r(t);else switch(e.binding.type){case A:{const i=e;for(const e of i.constructorParams)void 0!==e&&t.push(e);for(const e of i.propertyParams.values())t.push(e);break}case R:{const i=e;for(const e of i.params)t.push(e);break}}};if(Array.isArray(i))for(const e of i)r(e);else r(i);return t}(t)){const t=e(i);if(void 0!==t)return t}}finally{i.pop()}}(t)??[]}(e));throw new D(F.planning,`Circular dependency found: ${i}`,{cause:t})}throw t}(e,t)}}function St(e,t){switch(t.binding.type){case y:return tt(e,t.binding);case S:return nt(e,t.binding);case b:return st(e,t.binding);case A:return gt(e,t);case _:return ut(e,t.binding);case R:return mt(e,t)}}function bt(e,t){if(void 0!==t.bindings)return Array.isArray(t.bindings)?function(e,t){const i=[];for(const r of t)ye(r)?i.push(...ft(e,r)):i.push(St(e,r));return i.some(a)?Promise.all(i):i}(e,t.bindings):function(e,t){if(ye(t)){const i=ft(e,t);if(1===i.length)return i[0];throw new D(F.resolution,"Unexpected multiple resolved values on single injection")}return St(e,t)}(e,t.bindings)}function At(e){return void 0!==e.scope}function _t(e,t){if("function"==typeof e[t])return e[t]()}function Rt(e,t){const i=e.lifecycle.preDestroyMethodNames;if(0===i.size)return;let r;for(const e of i)r=void 0===r?_t(t,e):r.then(()=>_t(t,e));return r}function Ct(e,t,i){const r=e.getDeactivations(t);if(void 0!==r)return a(i)?wt(i,r[Symbol.iterator]()):function(e,t){let i=t.next();for(;!0!==i.done;){if(a(i.value(e)))return wt(e,t);i=t.next()}}(i,r[Symbol.iterator]())}async function wt(e,t){const i=await e;let r=t.next();for(;!0!==r.done;)await r.value(i),r=t.next()}function It(e,t){const i=function(e,t){if(t.type===A){const i=e.getClassMetadata(t.implementationType),r=t.cache.value;return a(r)?r.then(e=>Rt(i,e)):Rt(i,r)}}(e,t);return void 0===i?Tt(e,t):i.then(()=>Tt(e,t))}function Tt(e,t){const i=t.cache;return a(i.value)?i.value.then(i=>Bt(e,t,i)):Bt(e,t,i.value)}function Bt(e,t,i){let r;return void 0!==t.onDeactivation&&(r=(0,t.onDeactivation)(i)),void 0===r?Ct(e,t.serviceIdentifier,i):r.then(()=>Ct(e,t.serviceIdentifier,i))}function Pt(e,t){if(void 0===t)return;const i=function(e){const t=[];for(const i of e)At(i)&&i.scope===m&&i.cache.isRight&&t.push(i);return t}(t),r=[];for(const t of i){const i=It(e,t);void 0!==i&&r.push(i)}return r.length>0?Promise.all(r).then(()=>{}):void 0}const Nt=Symbol.for("@inversifyjs/plugin/isPlugin"),Mt=Symbol.for("@inversifyjs/container/bindingIdentifier");function Ot(e){return"object"==typeof e&&null!==e&&!0===e[Mt]}class Dt{static always=e=>!0}const Ft=Symbol.for("@inversifyjs/container/InversifyContainerError");class xt extends Error{[Ft];kind;constructor(e,t,i){super(t,i),this[Ft]=!0,this.kind=e}static is(e){return"object"==typeof e&&null!==e&&!0===e[Ft]}static isErrorOfKind(e,t){return xt.is(e)&&e.kind===t}}var kt;function Lt(e){return{[Mt]:!0,id:e.id}}function Ut(e){return t=>{for(let i=t.getAncestor();void 0!==i;i=i.getAncestor())if(e(i))return!0;return!1}}function Gt(e){return t=>t.name===e}function Wt(e){return t=>t.serviceIdentifier===e}function Vt(e,t){return i=>i.tags.has(e)&&i.tags.get(e)===t}function jt(e){return void 0===e.name&&0===e.tags.size}function qt(e){const t=Ut(e);return e=>!t(e)}function Ht(e){return t=>{const i=t.getAncestor();return void 0===i||!e(i)}}function Kt(e){return t=>{const i=t.getAncestor();return void 0!==i&&e(i)}}!function(e){e[e.invalidOperation=0]="invalidOperation"}(kt||(kt={}));class $t{#r;constructor(e){this.#r=e}getIdentifier(){return Lt(this.#r)}inRequestScope(){return this.#r.scope=g,new Qt(this.#r)}inSingletonScope(){return this.#r.scope=m,new Qt(this.#r)}inTransientScope(){return this.#r.scope=E,new Qt(this.#r)}}class zt{#t;#s;#a;#o;constructor(e,t,i,r){this.#t=e,this.#s=t,this.#a=i,this.#o=r}to(e){const t=G(e),i={cache:{isRight:!1,value:void 0},id:v(),implementationType:e,isSatisfiedBy:Dt.always,moduleId:this.#s,onActivation:void 0,onDeactivation:void 0,scope:t.scope??this.#a,serviceIdentifier:this.#o,type:A};return this.#t(i),new Zt(i)}toSelf(){if("function"!=typeof this.#o)throw new Error('"toSelf" function can only be applied when a newable function is used as service identifier');return this.to(this.#o)}toConstantValue(e){const t={cache:{isRight:!1,value:void 0},id:v(),isSatisfiedBy:Dt.always,moduleId:this.#s,onActivation:void 0,onDeactivation:void 0,scope:m,serviceIdentifier:this.#o,type:y,value:e};return this.#t(t),new Qt(t)}toDynamicValue(e){const t={cache:{isRight:!1,value:void 0},id:v(),isSatisfiedBy:Dt.always,moduleId:this.#s,onActivation:void 0,onDeactivation:void 0,scope:this.#a,serviceIdentifier:this.#o,type:S,value:e};return this.#t(t),new Zt(t)}toResolvedValue(e,t){const i={cache:{isRight:!1,value:void 0},factory:e,id:v(),isSatisfiedBy:Dt.always,metadata:this.#n(t),moduleId:this.#s,onActivation:void 0,onDeactivation:void 0,scope:this.#a,serviceIdentifier:this.#o,type:R};return this.#t(i),new Zt(i)}toFactory(e){const t={cache:{isRight:!1,value:void 0},factory:e,id:v(),isSatisfiedBy:Dt.always,moduleId:this.#s,onActivation:void 0,onDeactivation:void 0,scope:m,serviceIdentifier:this.#o,type:b};return this.#t(t),new Qt(t)}toProvider(e){const t={cache:{isRight:!1,value:void 0},id:v(),isSatisfiedBy:Dt.always,moduleId:this.#s,onActivation:void 0,onDeactivation:void 0,provider:e,scope:m,serviceIdentifier:this.#o,type:_};return this.#t(t),new Qt(t)}toService(e){const t={id:v(),isSatisfiedBy:Dt.always,moduleId:this.#s,serviceIdentifier:this.#o,targetServiceIdentifier:e,type:C};this.#t(t)}#n(e){return{arguments:(e??[]).map(e=>function(e){return"object"==typeof e&&!h.is(e)}(e)?function(e){return!0===e.isMultiple}(e)?{chained:e.chained??!1,kind:le.multipleInjection,name:e.name,optional:e.optional??!1,tags:new Map((e.tags??[]).map(e=>[e.key,e.value])),value:e.serviceIdentifier}:{kind:le.singleInjection,name:e.name,optional:e.optional??!1,tags:new Map((e.tags??[]).map(e=>[e.key,e.value])),value:e.serviceIdentifier}:{kind:le.singleInjection,name:void 0,optional:!1,tags:new Map,value:e})}}}class Yt{#r;constructor(e){this.#r=e}getIdentifier(){return Lt(this.#r)}onActivation(e){return this.#r.onActivation=e,new Xt(this.#r)}onDeactivation(e){if(this.#r.onDeactivation=e,this.#r.scope!==m)throw new xt(kt.invalidOperation,`Binding for service "${c(this.#r.serviceIdentifier)}" has a deactivation function, but its scope is not singleton. Deactivation functions can only be used with singleton bindings.`);return new Xt(this.#r)}}class Xt{#r;constructor(e){this.#r=e}getIdentifier(){return Lt(this.#r)}when(e){return this.#r.isSatisfiedBy=e,new Yt(this.#r)}whenAnyAncestor(e){return this.when(Ut(e))}whenAnyAncestorIs(e){return this.when(Ut(Wt(e)))}whenAnyAncestorNamed(e){return this.when(function(e){return Ut(Gt(e))}(e))}whenAnyAncestorTagged(e,t){return this.when(function(e,t){return Ut(Vt(e,t))}(e,t))}whenDefault(){return this.when(jt)}whenNamed(e){return this.when(Gt(e))}whenNoParent(e){return this.when(Ht(e))}whenNoParentIs(e){return this.when(Ht(Wt(e)))}whenNoParentNamed(e){return this.when(function(e){return Ht(Gt(e))}(e))}whenNoParentTagged(e,t){return this.when(function(e,t){return Ht(Vt(e,t))}(e,t))}whenParent(e){return this.when(Kt(e))}whenParentIs(e){return this.when(Kt(Wt(e)))}whenParentNamed(e){return this.when(function(e){return Kt(Gt(e))}(e))}whenParentTagged(e,t){return this.when(function(e,t){return Kt(Vt(e,t))}(e,t))}whenTagged(e,t){return this.when(Vt(e,t))}whenNoAncestor(e){return this.when(qt(e))}whenNoAncestorIs(e){return this.when(qt(Wt(e)))}whenNoAncestorNamed(e){return this.when(function(e){return qt(Gt(e))}(e))}whenNoAncestorTagged(e,t){return this.when(function(e,t){return qt(Vt(e,t))}(e,t))}}class Qt extends Xt{#c;constructor(e){super(e),this.#c=new Yt(e)}onActivation(e){return this.#c.onActivation(e)}onDeactivation(e){return this.#c.onDeactivation(e)}}class Zt extends Qt{#u;constructor(e){super(e),this.#u=new $t(e)}inRequestScope(){return this.#u.inRequestScope()}inSingletonScope(){return this.#u.inSingletonScope()}inTransientScope(){return this.#u.inTransientScope()}}class Jt{#l;#a;#h;#v;constructor(e,t,i,r){this.#l=e,this.#a=t,this.#h=i,this.#v=r}bind(e){return new zt(e=>{this.#p(e)},void 0,this.#a,e)}isBound(e,t){const i=this.#v.bindingService.get(e);return this.#g(e,i,t)}isCurrentBound(e,t){const i=this.#v.bindingService.getNonParentBindings(e);return this.#g(e,i,t)}async rebind(e){return await this.unbind(e),this.bind(e)}rebindSync(e){return this.unbindSync(e),this.bind(e)}async unbind(e){await this.#f(e)}async unbindAll(){const e=[...this.#v.bindingService.getNonParentBoundServices()];await Promise.all(e.map(async e=>function(e,t){const i=e.getBindings(t);return Pt(e,i)}(this.#l,e)));for(const t of e)this.#v.activationService.removeAllByServiceId(t),this.#v.bindingService.removeAllByServiceId(t),this.#v.deactivationService.removeAllByServiceId(t);this.#v.planResultCacheService.clearCache()}unbindSync(e){void 0!==this.#f(e)&&this.#b(e)}#p(e){this.#v.bindingService.set(e),this.#h.invalidateService({binding:e,kind:Ve.bindingAdded})}#b(e){let t;if(Ot(e)){const r=this.#v.bindingService.getById(e.id),n=(i=r,function(e){if(void 0===e)return;const t=e.next();return!0!==t.done?t.value:void 0}(i?.[Symbol.iterator]()))?.serviceIdentifier;t=void 0===n?"Unexpected asynchronous deactivation when unbinding binding identifier. Consider using Container.unbind() instead.":`Unexpected asynchronous deactivation when unbinding "${c(n)}" binding. Consider using Container.unbind() instead.`}else t=`Unexpected asynchronous deactivation when unbinding "${c(e)}" service. Consider using Container.unbind() instead.`;var i;throw new xt(kt.invalidOperation,t)}#f(e){return Ot(e)?this.#d(e):this.#R(e)}#d(e){const t=this.#v.bindingService.getById(e.id),i=void 0===t?void 0:[...t],r=Pt(this.#l,t);if(void 0!==r)return r.then(()=>{this.#y(i,e)});this.#y(i,e)}#y(e,t){if(this.#v.bindingService.removeById(t.id),void 0!==e)for(const t of e)this.#h.invalidateService({binding:t,kind:Ve.bindingRemoved})}#R(e){const t=this.#v.bindingService.get(e),i=void 0===t?void 0:[...t],r=Pt(this.#l,t);if(void 0!==r)return r.then(()=>{this.#T(e,i)});this.#T(e,i)}#T(e,t){if(this.#v.activationService.removeAllByServiceId(e),this.#v.bindingService.removeAllByServiceId(e),this.#v.deactivationService.removeAllByServiceId(e),void 0!==t)for(const e of t)this.#h.invalidateService({binding:e,kind:Ve.bindingRemoved})}#g(e,t,i){if(void 0===t)return!1;const r={getAncestor:()=>{},name:i?.name,serviceIdentifier:e,tags:new Map};void 0!==i?.tag&&r.tags.set(i.tag.key,i.tag.value);for(const e of t)if(e.isSatisfiedBy(r))return!0;return!1}}class ei{#E;#l;#a;#h;#v;constructor(e,t,i,r,n){this.#E=e,this.#l=t,this.#a=i,this.#h=r,this.#v=n}async load(...e){await Promise.all(this.#i(...e))}loadSync(...e){const t=this.#i(...e);for(const e of t)if(void 0!==e)throw new xt(kt.invalidOperation,"Unexpected asynchronous module load. Consider using Container.load() instead.")}async unload(...e){await Promise.all(this.#m(...e)),this.#A(e)}unloadSync(...e){const t=this.#m(...e);for(const e of t)if(void 0!==e)throw new xt(kt.invalidOperation,"Unexpected asynchronous module unload. Consider using Container.unload() instead.");this.#A(e)}#S(e){return{bind:t=>new zt(e=>{this.#p(e)},e,this.#a,t),isBound:this.#E.isBound.bind(this.#E),onActivation:(t,i)=>{this.#v.activationService.add(i,{moduleId:e,serviceId:t})},onDeactivation:(t,i)=>{this.#v.deactivationService.add(i,{moduleId:e,serviceId:t})},rebind:this.#E.rebind.bind(this.#E),rebindSync:this.#E.rebindSync.bind(this.#E),unbind:this.#E.unbind.bind(this.#E),unbindSync:this.#E.unbindSync.bind(this.#E)}}#A(e){for(const t of e)this.#v.activationService.removeAllByModuleId(t.id),this.#v.bindingService.removeAllByModuleId(t.id),this.#v.deactivationService.removeAllByModuleId(t.id);this.#v.planResultCacheService.clearCache()}#i(...e){return e.map(e=>e.load(this.#S(e.id)))}#p(e){this.#v.bindingService.set(e),this.#h.invalidateService({binding:e,kind:Ve.bindingAdded})}#m(...e){return e.map(e=>function(e,t){const i=e.getBindingsFromModule(t);return Pt(e,i)}(this.#l,e.id))}}class ti{deactivationParams;constructor(e){this.deactivationParams=function(e){return{getBindings:e.bindingService.get.bind(e.bindingService),getBindingsFromModule:e.bindingService.getByModuleId.bind(e.bindingService),getClassMetadata:G,getDeactivations:e.deactivationService.get.bind(e.deactivationService)}}(e),e.onReset(()=>{!function(e,t){t.getBindings=e.bindingService.get.bind(e.bindingService),t.getBindingsFromModule=e.bindingService.getByModuleId.bind(e.bindingService),t.getDeactivations=e.deactivationService.get.bind(e.deactivationService)}(e,this.deactivationParams)})}}class ii{planParamsOperations;#v;constructor(e){this.#v=e,this.planParamsOperations={getBindings:this.#v.bindingService.get.bind(this.#v.bindingService),getBindingsChained:this.#v.bindingService.getChained.bind(this.#v.bindingService),getClassMetadata:G,getPlan:this.#v.planResultCacheService.get.bind(this.#v.planResultCacheService),setBinding:this.#p.bind(this),setNonCachedServiceNode:this.#v.planResultCacheService.setNonCachedServiceNode.bind(this.#v.planResultCacheService),setPlan:this.#v.planResultCacheService.set.bind(this.#v.planResultCacheService)},this.#v.onReset(()=>{this.#I()})}#I(){this.planParamsOperations.getBindings=this.#v.bindingService.get.bind(this.#v.bindingService),this.planParamsOperations.getBindingsChained=this.#v.bindingService.getChained.bind(this.#v.bindingService),this.planParamsOperations.setBinding=this.#p.bind(this)}#p(e){this.#v.bindingService.set(e),this.#v.planResultCacheService.invalidateServiceBinding({binding:e,kind:Ve.bindingAdded,operations:this.planParamsOperations})}}class ri{#w;#v;constructor(e,t){this.#w=e,this.#v=t}invalidateService(e){this.#v.planResultCacheService.invalidateServiceBinding({...e,operations:this.#w.planParamsOperations})}}class ni{#_;#M;#L;#v;constructor(e,t,i){this.#v=t,this.#L=i,this.#_=this.#B(e),this.#M=this.#D()}register(e,t){const i=new t(e,this.#M);if(!0!==i[Nt])throw new xt(kt.invalidOperation,"Invalid plugin. The plugin must extend the Plugin class");i.load(this.#_)}#B(e){return{define:(t,i)=>{if(Object.prototype.hasOwnProperty.call(e,t))throw new xt(kt.invalidOperation,`Container already has a method named "${String(t)}"`);e[t]=i},onPlan:this.#L.onPlan.bind(this.#L)}}#D(){const e=this.#v;return{get activationService(){return e.activationService},get bindingService(){return e.bindingService},get deactivationService(){return e.deactivationService},get planResultCacheService(){return e.planResultCacheService}}}}class si{activationService;bindingService;deactivationService;planResultCacheService;#C;constructor(e,t,i,r){this.activationService=e,this.bindingService=t,this.deactivationService=i,this.planResultCacheService=r,this.#C=[]}reset(e,t,i){this.activationService=e,this.bindingService=t,this.deactivationService=i,this.planResultCacheService.clearCache();for(const e of this.#C)e()}onReset(e){this.#C.push(e)}}class oi{#O;#a;#j;#x;#N;#w;#v;constructor(e,t,i,r){this.#w=e,this.#v=t,this.#x=this.#P(),this.#O=i,this.#a=r,this.#j=e=>this.#v.activationService.get(e),this.#N=[],this.#v.onReset(()=>{this.#I()})}get(e,t){const i=this.#k(!1,e,t),r=this.#U(i);if(a(r))throw new xt(kt.invalidOperation,`Unexpected asynchronous service when resolving service "${c(e)}"`);return r}getAll(e,t){const i=this.#k(!0,e,t),r=this.#U(i);if(a(r))throw new xt(kt.invalidOperation,`Unexpected asynchronous service when resolving service "${c(e)}"`);return r}async getAllAsync(e,t){const i=this.#k(!0,e,t);return this.#U(i)}async getAsync(e,t){const i=this.#k(!1,e,t);return this.#U(i)}onPlan(e){this.#N.push(e)}#I(){this.#x=this.#P()}#V(e,t,i){const r=i?.name,n=i?.optional??!1,s=i?.tag;return e?{chained:i?.chained??!1,isMultiple:e,name:r,optional:n,serviceIdentifier:t,tag:s}:{isMultiple:e,name:r,optional:n,serviceIdentifier:t,tag:s}}#F(e,t,i){const r={autobindOptions:i?.autobind??this.#O?{scope:this.#a}:void 0,operations:this.#w.planParamsOperations,rootConstraints:this.#H(e,t,i),servicesBranch:[]};return this.#K(r,i),r}#H(e,t,i){return t?{chained:i?.chained??!1,isMultiple:t,serviceIdentifier:e}:{isMultiple:t,serviceIdentifier:e}}#k(e,t,i){const r=this.#V(e,t,i),n=this.#v.planResultCacheService.get(r);if(void 0!==n)return n;const s=We(this.#F(t,e,i));for(const e of this.#N)e(r,s);return s}#P(){return{get:this.get.bind(this),getAll:this.getAll.bind(this),getAllAsync:this.getAllAsync.bind(this),getAsync:this.getAsync.bind(this)}}#U(e){return yt({context:this.#x,getActivations:this.#j,planResult:e,requestScopeCache:new Map})}#K(e,t){void 0!==t&&(void 0!==t.name&&(e.rootConstraints.name=t.name),!0===t.optional&&(e.rootConstraints.isOptional=!0),void 0!==t.tag&&(e.rootConstraints.tag={key:t.tag.key,value:t.tag.value}),e.rootConstraints.isMultiple&&(e.rootConstraints.chained=t?.chained??!1))}}class ai{#v;#Y;constructor(e){this.#v=e,this.#Y=[]}restore(){const e=this.#Y.pop();if(void 0===e)throw new xt(kt.invalidOperation,"No snapshot available to restore");this.#v.reset(e.activationService,e.bindingService,e.deactivationService)}snapshot(){this.#Y.push({activationService:this.#v.activationService.clone(),bindingService:this.#v.bindingService.clone(),deactivationService:this.#v.deactivationService.clone()})}}const ci=E;class ui{#E;#G;#W;#v;#L;#q;constructor(e){const t=e?.autobind??!1,i=e?.defaultScope??ci;this.#v=this.#z(e,t,i);const r=new ii(this.#v),n=new ri(r,this.#v),s=new ti(this.#v);this.#E=new Jt(s.deactivationParams,i,n,this.#v),this.#G=new ei(this.#E,s.deactivationParams,i,n,this.#v),this.#L=new oi(r,this.#v,t,i),this.#W=new ni(this,this.#v,this.#L),this.#q=new ai(this.#v)}bind(e){return this.#E.bind(e)}get(e,t){return this.#L.get(e,t)}getAll(e,t){return this.#L.getAll(e,t)}async getAllAsync(e,t){return this.#L.getAllAsync(e,t)}async getAsync(e,t){return this.#L.getAsync(e,t)}isBound(e,t){return this.#E.isBound(e,t)}isCurrentBound(e,t){return this.#E.isCurrentBound(e,t)}async load(...e){return this.#G.load(...e)}loadSync(...e){this.#G.loadSync(...e)}onActivation(e,t){this.#v.activationService.add(t,{serviceId:e})}onDeactivation(e,t){this.#v.deactivationService.add(t,{serviceId:e})}register(e){this.#W.register(this,e)}restore(){this.#q.restore()}async rebind(e){return this.#E.rebind(e)}rebindSync(e){return this.#E.rebindSync(e)}snapshot(){this.#q.snapshot()}async unbind(e){await this.#E.unbind(e)}async unbindAll(){return this.#E.unbindAll()}unbindSync(e){this.#E.unbindSync(e)}async unload(...e){return this.#G.unload(...e)}unloadSync(...e){this.#G.unloadSync(...e)}#X(e,t){if(e)return{scope:t}}#z(e,t,i){const r=this.#X(t,i);if(void 0===e?.parent)return new si(B.build(()=>{}),q.build(()=>{},r),H.build(()=>{}),new Ye);const n=new Ye,s=e.parent;return s.#v.planResultCacheService.subscribe(n),new si(B.build(()=>s.#v.activationService),q.build(()=>s.#v.bindingService,r),H.build(()=>s.#v.deactivationService),n)}}const hi={AudioContextManager:Symbol.for("AudioContextManager"),AudioEditor:Symbol.for("AudioEditor"),AudioProcessor:Symbol.for("AudioProcessor"),BufferManager:Symbol.for("BufferManager"),FilterManager:Symbol.for("FilterManager"),RendererManager:Symbol.for("RendererManager"),SaveBufferManager:Symbol.for("SaveBufferManager"),ConfigService:Symbol.for("ConfigService"),EventEmitter:Symbol.for("EventEmitter"),BufferPlayer:Symbol.for("BufferPlayer"),BufferDecoderService:Symbol.for("BufferDecoderService"),BufferFetcherService:Symbol.for("BufferFetcherService"),AudioBuffersToFetch:Symbol.for("AudioBuffersToFetch"),Renderers:Symbol.for("Renderers"),Filters:Symbol.for("Filters"),AudioEncoderManager:Symbol.for("AudioEncoderManager"),AudioEncoders:Symbol.for("AudioEncoders"),EntryPointFilter:Symbol.for("EntryPointFilter"),VoiceRecorder:Symbol.for("VoiceRecorder")};let li=class{constructor(){this.bufferFetcherService=null,this.bufferDecoderService=null,this.configService=null,this.eventEmitter=null,this.contextManager=null}injectDependencies(e,t,i,r,n){e&&(this.bufferFetcherService=e),t&&(this.bufferDecoderService=t),i&&(this.configService=i),r&&(this.eventEmitter=r),n&&(this.contextManager=n)}};e([ee(hi.BufferFetcherService),i("design:type",Object)],li.prototype,"bufferFetcherService",void 0),e([ee(hi.BufferDecoderService),i("design:type",Object)],li.prototype,"bufferDecoderService",void 0),e([ee(hi.ConfigService),i("design:type",Object)],li.prototype,"configService",void 0),e([ee(hi.EventEmitter),i("design:type",Object)],li.prototype,"eventEmitter",void 0),e([ee(hi.AudioContextManager),i("design:type",Object)],li.prototype,"contextManager",void 0),li=e([re()],li);var di=li;const fi={calcAudioDuration:(e,t)=>{if(e){let i=e.duration+1;return null!=t&&(i/=t),i}return 0},loadAudioBuffer:(e,t)=>r(void 0,void 0,void 0,function*(){const i=yield fi.readAsArrayBufferPromisified(t),r=yield e.decodeAudioData(i);return fi.decodeBuffer(e,r)}),readAsArrayBufferPromisified:e=>new Promise((t,i)=>{const r=new FileReader;r.onload=e=>{var r;const n=null===(r=null==e?void 0:e.target)||void 0===r?void 0:r.result;n instanceof ArrayBuffer?t(n):i()},e&&r.readAsArrayBuffer(e)}),decodeBuffer:(e,t)=>{if(1==t.numberOfChannels){e.resume();const{duration:i}=t,{sampleRate:r}=e,n=e.createBuffer(2,r*i+2*r,r),s=t.getChannelData(0),o=n.getChannelData(0),a=n.getChannelData(1);for(let e=0;e<s.length;e++)o[e]=s[e],a[e]=s[e];return n}return t},convertAudioBufferToFloat32Array:e=>{const t=[];for(let i=0;i<e.numberOfChannels;i++)t.push(e.getChannelData(i));return t},convertAudioParamToFloat32Array:(e,t)=>{const i=new Float32Array(t);for(let r=0;r<t;r++)i.set([e.value],r);return i},sumAudioBufferChannel:(e,t)=>e.getChannelData(t).reduce((e,t)=>e+t,0),sumAudioBuffer(e){let t=0;for(let i=0;i<e.numberOfChannels;i++)t+=this.sumAudioBufferChannel(e,i);return t},isAudioWorkletCompatible:e=>void 0!==e&&void 0!==e.audioWorklet,isSettingValueValid:e=>!(void 0===e||isNaN(Number(e))||"string"==typeof e&&""===e.trim()),calculateAudioDuration(e,t,i){if(e&&t){const r=this.calcAudioDuration(e,i),n=t.getAddingTime();return n?r+n:r}return 0},forceDownload(e,t){const i=window.document.createElement("a"),r=URL.createObjectURL(e);window.document.body.appendChild(i),i.href=r,i.download=t||"output.wav",i.click(),URL.revokeObjectURL(r),window.document.body.removeChild(i)},clearAudioBuffer(e){if(e)for(let t=0;t<e.numberOfChannels;t++){const i=e.getChannelData(t);for(let e=0;e<i.length;e++)i[e]=0}},floatTo16BitPCM(e,t,i){for(let r=0;r<i.length;r++,t+=2){const n=this.clampFloatValue(i[r]);e.setInt16(t,n<0?32768*n:32767*n,!0)}},convertFloat32Array2Int16(e){const t=new Int16Array(e.length);for(let i=0,r=e.length;i<r;i++){const r=this.clampFloatValue(e[i]);t[i]=Math.round(32767*r)}return t},clampFloatValue:e=>Math.max(-1,Math.min(1,e)),writeStringToDataView(e,t,i){for(let r=0;r<i.length;r++)e.setUint8(t+r,i.charCodeAt(r))},interleaveBuffers(e,t){const i=e.length+t.length;if(0===i)throw new Error("interleaveBuffers: input buffers are empty or invalid");const r=new(0,e.constructor)(i);let n=0,s=0;for(;n<i;)r[n++]=e[s],r[n++]=t[s],s++;return r},getLengthFromBuffers:e=>e?e.reduce((e,t)=>e+t.length,0):0,mergeBuffers(e){const t=this.getLengthFromBuffers(e);if(0===t)throw new Error("mergeTypedArrayBuffers: input buffers are empty or invalid");const i=new(0,e[0].constructor)(t);let r=0;for(const t of e)t?(i.set(t,r),r+=t.length):console.warn("mergeTypedArrayBuffers: undefined buffer has been detected");return i}};var pi;exports.EventType=void 0,(pi=exports.EventType||(exports.EventType={})).LOADING_BUFFERS="loadingBuffers",pi.LOADING_BUFFERS_ERROR="loadingBuffersError",pi.FETCHING_BUFFERS="fetchingBuffers",pi.FETCHING_BUFFERS_ERROR="fetchingBuffersError",pi.FINISHED_FETCHING_BUFFERS="finishedFetchingBuffers",pi.LOADED_BUFFERS="loadedBuffers",pi.COMPATIBILITY_MODE_AUTO_ENABLED="compatibilityModeAutoEnabled",pi.STARTED_RENDERING_AUDIO="renderingAudio",pi.RENDERING_AUDIO_PROBLEM_DETECTED="renderingAudioProblemDetected",pi.AUDIO_RENDERING_FINISHED="audioRenderingFinished",pi.AUDIO_RENDERING_EXCEPTION_THROWN="audioRenderingExceptionThrown",pi.OFFLINE_AUDIO_RENDERING_FINISHED="offlineAudioRenderingFinished",pi.PLAYING_STOPPED="playingStopped",pi.PLAYING_STARTED="playingStarted",pi.PLAYING_FINISHED="playingFinished",pi.PLAYING_UPDATE="playingUpdate",pi.RECORDER_INIT="recorderInit",pi.RECORDER_SUCCESS="recorderSuccess",pi.RECORDER_ERROR="recorderError",pi.RECORDER_UPDATE_CONSTRAINTS="recorderUpdateConstraints",pi.RECORDER_RECORDING="recorderRecording",pi.RECORDER_STOPPED="recorderStopped",pi.RECORDER_PAUSED="recorderPaused",pi.RECORDER_RESETED="recorderReseted",pi.RECORDER_COUNT_UPDATE="recorderCountUpdate",pi.SAMPLE_RATE_CHANGED="sampleRateChanged",pi.DECODING_AUDIO_FILE="decodingAudioFile",pi.DECODED_AUDIO_FILE="decodedAudioFile",pi.ERROR_DECODING_AUDIO_FILE="errorDecodingAudioFile",pi.RECORDER_NOT_FOUND_ERROR="recorderNotFoundError",pi.RECORDER_UNKNOWN_ERROR="recorderUnknownError",pi.UPDATE_AUDIO_TREATMENT_PERCENT="updateAudioTreatmentPercent",pi.UPDATE_REMAINING_TIME_ESTIMATED="updateRemainingTimeEstimated",pi.CANCELLED_AND_LOADED_INITIAL_AUDIO="cancelledAndLoadedInitialAudio",pi.CANCELLING_AUDIO_PROCESSING="cancellingAudioProcessing",pi.PLAYING_FINISHED_LOOP_ALL="playingFinishedLoopAll",pi.LOADED_AUDIO_FILE_FROM_LIST="loadedAudioFileFromList",pi.AUDIO_SPEED_UPDATED="audioSpeedUpdated",pi.AUDIO_DURATION_UPDATED="audioDurationUpdated",pi.FALLBACK_WORKLET_TO_SCRIPT_PROCESSOR="fallbackWorkletToScriptProcessor",pi.WORKLET_SUCCESSFULLY_LOADED="workletSuccessfullyLoaded";let vi=class extends di{constructor(e,t,i,r,n,s,o){super(),this.principalBuffer=null,this.fileList=null,this.fileListCurrIndex=0,this.loadingAudio=!1,this.renderingAudio=!1,this.filterManager=e,this.rendererManager=t,this.contextManager=i,this.saveBufferManager=r,this.audioProcessor=n,this.bufferManager=s,this.bufferPlayer=o}setup(){this.eventEmitter?(this.eventEmitter.on(exports.EventType.PLAYING_STARTED,()=>r(this,void 0,void 0,function*(){this.bufferPlayer&&this.bufferPlayer.compatibilityMode&&this.contextManager&&this.contextManager.currentContext&&this.audioProcessor&&(yield this.audioProcessor.setupOutput(this.principalBuffer,this.contextManager.currentContext))})),this.eventEmitter.on(exports.EventType.PLAYING_FINISHED,()=>{this.bufferPlayer&&this.bufferPlayer.loop&&this.bufferPlayer.start()}),this.eventEmitter.on(exports.EventType.PLAYING_FINISHED_LOOP_ALL,()=>r(this,void 0,void 0,function*(){this.bufferPlayer&&this.bufferPlayer.loopAll&&!this.renderingAudio&&!this.loadingAudio&&(yield this.loadNextAudio(!0),this.bufferPlayer.start())}))):console.error("Event Emitter is not available!")}addFilters(...e){this.filterManager&&this.filterManager.addFilters(...e)}addRenderers(...e){this.rendererManager&&this.rendererManager.addRenderers(...e)}get currentSampleRate(){return this.contextManager?this.contextManager.currentSampleRate:0}get defaultDeviceSampleRate(){const e=new AudioContext,{sampleRate:t}=e;return e&&e.close(),t}loadBufferFromFile(e){return r(this,void 0,void 0,function*(){if(this.loadingAudio=!0,this.audioProcessor&&(yield this.audioProcessor.prepareContext(this.principalBuffer)),!(this.contextManager&&this.contextManager.currentContext&&this.bufferDecoderService&&this.audioProcessor))throw this.loadingAudio=!1,new Error("Audio Context is not ready!");if(this.clearPrincipalBuffer(),this.principalBuffer=yield this.bufferDecoderService.decodeBufferFromFile(e),this.audioProcessor.initialRenderingDone=!1,!this.principalBuffer)throw this.loadingAudio=!1,new Error("Error decoding audio file");this.audioProcessor.sumInputBuffer=fi.sumAudioBuffer(this.principalBuffer),this.audioProcessor.resetAudioRenderingProgress(),this.bufferPlayer&&this.bufferPlayer.loopAll&&this.totalFileList<=1&&this.bufferPlayer.toggleLoop(),this.loadingAudio=!1})}loadFileList(e){return r(this,void 0,void 0,function*(){this.fileList=e,yield this.loadBufferFromFileListIndex(0)})}loadBufferFromFileListIndex(e){return r(this,void 0,void 0,function*(){if(this.fileList){this.fileListCurrIndex=e;const t=this.fileList.item(this.fileListCurrIndex);this.eventEmitter&&this.eventEmitter.emit(exports.EventType.LOADED_AUDIO_FILE_FROM_LIST,e),t&&(yield this.loadBufferFromFile(t))}})}loadPreviousAudio(e){return r(this,void 0,void 0,function*(){const t=this.currentIndexFileList,i=this.totalFileList,r=t-1;r!=t&&(r<0?yield this.loadBufferFromFileListIndex(i-1):yield this.loadBufferFromFileListIndex(r),yield this.renderAudio(e))})}loadNextAudio(e){return r(this,void 0,void 0,function*(){const t=this.currentIndexFileList,i=this.totalFileList,r=t+1;r!=t&&(r>=i?yield this.loadBufferFromFileListIndex(0):yield this.loadBufferFromFileListIndex(r),yield this.renderAudio(e))})}getCurrentFileList(){if(this.fileList){const e=new Map;for(let t=0;t<this.fileList.length;t++){const i=this.fileList.item(t);i&&e.set(i.name,this.currentIndexFileList===t)}return e}return new Map}get currentIndexFileList(){return this.fileListCurrIndex}get totalFileList(){return this.fileList?this.fileList.length:0}loadBuffer(e){this.principalBuffer=e,this.audioProcessor&&(this.audioProcessor.sumInputBuffer=fi.sumAudioBuffer(this.principalBuffer),this.audioProcessor.initialRenderingDone=!1)}getOutputBuffer(){return this.audioProcessor?this.audioProcessor.renderedBuffer:null}renderAudio(e){return r(this,void 0,void 0,function*(){if(this.audioProcessor)try{this.renderingAudio=!0,this.eventEmitter&&this.eventEmitter.emit(exports.EventType.STARTED_RENDERING_AUDIO);const t=yield this.audioProcessor.renderAudio(this.principalBuffer,e);return this.eventEmitter&&this.eventEmitter.emit(exports.EventType.AUDIO_RENDERING_FINISHED),this.renderingAudio=!1,t}catch(e){this.eventEmitter&&(this.eventEmitter.emit(exports.EventType.AUDIO_RENDERING_FINISHED),this.eventEmitter.emit(exports.EventType.AUDIO_RENDERING_EXCEPTION_THROWN,e)),this.renderingAudio=!1}return!1})}isAudioWorkletAvailable(){return!(!this.contextManager||!this.contextManager.currentContext)&&fi.isAudioWorkletCompatible(this.contextManager.currentContext)}getFiltersState(){return this.filterManager&&this.rendererManager?Object.assign(Object.assign({},this.filterManager.getFiltersState()),this.rendererManager.getRenderersState()):{}}getFiltersSettings(){return this.filterManager?this.filterManager.getFiltersSettings():new Map}reconnectNodesIfNeeded(){return r(this,void 0,void 0,function*(){if(this.contextManager&&this.bufferPlayer&&this.bufferPlayer.compatibilityMode&&this.contextManager.currentContext&&this.principalBuffer&&this.filterManager&&this.filterManager.entrypointFilter&&(yield this.filterManager.connectNodes(this.contextManager.currentContext,this.principalBuffer,!0,this.bufferPlayer.compatibilityMode),this.audioProcessor)){const e=this.filterManager.entrypointFilter.getSpeed(),t=fi.calculateAudioDuration(this.principalBuffer,this.filterManager,e);this.audioProcessor.updateAudioSpeedAndDuration(t)}})}enableFilter(e){this.rendererManager&&this.rendererManager.enableRenderer(e),this.filterManager&&(this.filterManager.enableFilter(e),this.reconnectNodesIfNeeded())}disableFilter(e){this.rendererManager&&this.rendererManager.disableRenderer(e),this.filterManager&&(this.filterManager.disableFilter(e),this.reconnectNodesIfNeeded())}toggleFilter(e){this.rendererManager&&this.rendererManager.toggleRenderer(e),this.filterManager&&(this.filterManager.toggleFilter(e),this.reconnectNodesIfNeeded())}changeFilterSettings(e,t){return r(this,void 0,void 0,function*(){this.filterManager&&(yield this.filterManager.changeFilterSettings(e,t),yield this.reconnectNodesIfNeeded())})}resetFilterSettings(e){return r(this,void 0,void 0,function*(){this.filterManager&&(yield this.filterManager.resetFilterSettings(e),yield this.reconnectNodesIfNeeded())})}resetAllFiltersState(){this.rendererManager&&this.rendererManager.resetAllRenderersState(),this.filterManager&&(this.filterManager.resetAllFiltersState(),this.reconnectNodesIfNeeded())}exit(){this.bufferPlayer&&(this.bufferPlayer.stop(),this.bufferPlayer.reset()),this.cancelAudioRendering(),this.clearBuffers(),this.fileList=null,this.fileListCurrIndex=0}clearBuffers(){this.clearPrincipalBuffer(),this.clearRenderedBuffer()}clearPrincipalBuffer(){fi.clearAudioBuffer(this.principalBuffer),this.principalBuffer=null}clearRenderedBuffer(){this.audioProcessor&&this.audioProcessor.clearRenderedBuffer()}cancelAudioRendering(){this.audioProcessor&&this.audioProcessor.cancelAudioRendering()}on(e,t){this.eventEmitter&&this.eventEmitter.on(e,t)}off(e,t){this.eventEmitter&&this.eventEmitter.off(e,t)}saveBuffer(e){var t;return this.saveBufferManager&&this.audioProcessor?null===(t=this.saveBufferManager)||void 0===t?void 0:t.saveBuffer(this.audioProcessor.renderedBuffer,e):Promise.resolve(!1)}set downloadingInitialData(e){this.bufferManager&&(this.bufferManager.downloadingInitialData=e)}get downloadingInitialData(){return!!this.bufferManager&&this.bufferManager.downloadingInitialData}};e([he(),i("design:type",Function),i("design:paramtypes",[]),i("design:returntype",void 0)],vi.prototype,"setup",null),vi=e([re(),ce(),t(0,ee(hi.FilterManager)),t(1,ee(hi.RendererManager)),t(2,ee(hi.AudioContextManager)),t(3,ee(hi.SaveBufferManager)),t(4,ee(hi.AudioProcessor)),t(5,ee(hi.BufferManager)),t(6,ee(hi.BufferPlayer)),i("design:paramtypes",[Object,Object,Object,Object,Object,Object,Object])],vi);var gi=vi;let mi=class extends di{constructor(){super(...arguments),this.buffer=null,this.source=null,this.gainNode=null,this.intervals=[],this._volume=1,this._duration=0,this.currentTime=0,this.displayTime=0,this.playing=!1,this.loop=!1,this.loopAll=!1,this.speedAudio=1,this.compatibilityMode=!1,this.currentNode=null}setup(){this.eventEmitter?(this.eventEmitter.on(exports.EventType.AUDIO_SPEED_UPDATED,e=>{e&&(this.speedAudio=e)}),this.eventEmitter.on(exports.EventType.AUDIO_DURATION_UPDATED,e=>{e&&(this.duration=e)})):console.error("Event Emitter is not available!")}init(e){this.playing=!1,this.contextManager&&this.contextManager.currentContext&&(this.contextManager.currentContext.resume(),!this.compatibilityMode&&this.buffer&&(null==this.source||e||(this.source.buffer=null,this.source.disconnect()),this.createGainNode(e),this.duration=this.buffer.duration,this.source&&this.gainNode&&(this.source.connect(this.gainNode),this.gainNode.connect(this.contextManager.currentContext.destination)))),this.updateInfos()}createGainNode(e){this.contextManager&&this.contextManager.currentContext&&(e||(this.gainNode&&this.gainNode.disconnect(),this.source&&this.source.disconnect()),this.source=this.contextManager.currentContext.createBufferSource(),this.source.buffer=this.buffer,this.gainNode=this.contextManager.currentContext.createGain(),this.setGainNodeValue())}loadBuffer(e){this.compatibilityMode=!1,this.reset(),this.buffer=e,this.init()}setCompatibilityMode(e,t){this.compatibilityMode=!0,this.reset(),this.init(),null!=t&&(this.duration=t*this.speedAudio),this.currentNode=e,this.updateInfos()}reset(e){this.clearIntervals(),this.currentTime=0,this.displayTime=0,e||this.stop()}stop(){var e;this.clearIntervals(),null!=this.source&&null!=this.source&&this.playing&&(this.source.stop(0),this.playing=!1),this.currentNode&&(this.currentNode.disconnect(),this.compatibilityMode&&(this.currentTime=0,this.displayTime=0)),null===(e=this.eventEmitter)||void 0===e||e.emit(exports.EventType.PLAYING_STOPPED),this.updateInfos()}clearIntervals(){for(const e of this.intervals)clearInterval(e);this.intervals=[]}start(e){return r(this,void 0,void 0,function*(){var t;if(this.source||this.compatibilityMode){if(e||this.stop(),this.init(e),yield null===(t=this.eventEmitter)||void 0===t?void 0:t.emit(exports.EventType.PLAYING_STARTED),this.compatibilityMode){if(!(this.currentNode&&this.contextManager&&this.contextManager.currentContext))return Promise.resolve();this.createGainNode(e),this.gainNode?(this.currentNode.connect(this.gainNode),this.gainNode.connect(this.contextManager.currentContext.destination)):this.currentNode.connect(this.contextManager.currentContext.destination)}else{if(!this.source)return Promise.resolve();this.source.start(0,e?0:this.currentTime/this.speedAudio),this.playing=!0}let i=performance.now();this.intervals.push(window.setInterval(()=>{var t,r,n;const s=performance.now(),o=s-i;i=s,this.currentTime+=o/1e3*this.speedAudio,this.displayTime=this.currentTime,this.currentTime>this.duration?this.loop?this.compatibilityMode?null===(t=this.eventEmitter)||void 0===t||t.emit(exports.EventType.PLAYING_FINISHED):(this.reset(e),this.start()):(null===(r=this.eventEmitter)||void 0===r||r.emit(exports.EventType.PLAYING_FINISHED),this.reset(e),this.loopAll&&(null===(n=this.eventEmitter)||void 0===n||n.emit(exports.EventType.PLAYING_FINISHED_LOOP_ALL))):this.updateInfos()},100))}return Promise.resolve()})}playDirect(){return r(this,void 0,void 0,function*(){this.compatibilityMode?yield this.start(!1):yield this.start(!0)})}pause(){this.stop()}updateInfos(){var e;null===(e=this.eventEmitter)||void 0===e||e.emit(exports.EventType.PLAYING_UPDATE)}setTimePercent(e){this.compatibilityMode||(this.currentTime=Math.round(this.duration*(e/100)),this.displayTime=this.currentTime,this.playing?(this.pause(),this.start()):this.updateInfos())}setTime(e){this.compatibilityMode||(this.currentTime=e,this.displayTime=this.currentTime,this.playing?(this.pause(),this.start()):this.updateInfos())}set volume(e){this._volume=e,this.setGainNodeValue()}setGainNodeValue(){this.gainNode&&(this.gainNode.gain.value=Math.pow(this._volume,2))}get volume(){return this._volume}get duration(){return this._duration}set duration(e){this._duration=e*(this.speedAudio||1)}onBeforePlaying(e){this.eventEmitter&&this.eventEmitter.on(exports.EventType.PLAYING_STARTED,e)}toggleLoop(){this.loopAll=!1,this.loop=!this.loop}toggleLoopAll(){this.loop=!1,this.loopAll=!this.loopAll}on(e,t){this.eventEmitter&&this.eventEmitter.on(e,t)}get currentTimeDisplay(){return("0"+Math.trunc(this.displayTime/60)).slice(-2)+":"+("0"+Math.trunc(this.displayTime%60)).slice(-2)}get maxTimeDisplay(){return("0"+Math.trunc(this.duration/60)).slice(-2)+":"+("0"+Math.trunc(this.duration%60)).slice(-2)}get percent(){return 100-Math.round((this.duration-this.displayTime)/this.duration*100)}get remainingTimeDisplay(){return("0"+Math.trunc((this.duration-this.displayTime)/60)).slice(-2)+":"+("0"+Math.trunc((this.duration-this.displayTime)%60)).slice(-2)}};e([he(),i("design:type",Function),i("design:paramtypes",[]),i("design:returntype",void 0)],mi.prototype,"setup",null),mi=e([re(),ce()],mi);var Ei=mi;class yi{constructor(e,t){this.seconds=0,this.initialSeconds=0,this.interval=null,this.incr=1,this.countCallback=()=>{},this.seconds=e,this.initialSeconds=e,this.incr=t}start(){this.interval=window.setInterval(()=>this.count(),1e3)}stop(){clearInterval(this.interval)}count(){this.seconds+=this.incr,this.seconds<=0&&this.stop(),this.countCallback&&this.countCallback()}onCount(e){this.countCallback=e}}const Si={REVERB:"reverb",ECHO:"echo",BASS_BOOST:"bassboost",BITCRUSHER:"bitcrusher",HIGH_PASS:"highpass",LIMITER:"limiter",LOW_PASS:"lowpass",RENDERING_PROGRESS_CALCULATION:"renderingProgressCalculationFilter",RETURN_AUDIO:"returnAudio",SOUNDTOUCH:"soundtouch",TELEPHONIZER:"telephonizer",VOCODER:"vocoder"},bi={AUDIO_EDITOR:"audioEditor",VOICE_RECORDER:"voiceRecorder",BUFFER_PLAYER:"bufferPlayer",AUDIO_CONTEXT_MANAGER:"audioContextManager",AUDIO_PROCESSOR:"audioProcessor",BUFFER_MANAGER:"bufferManager",FILTER_MANAGER:"filterManager",RENDERER_MANAGER:"rendererManager",SAVE_BUFFER_MANAGER:"saveBufferManager",EXPORT_WAV_COMMAND:"exportWAV",EXPORT_MP3_COMMAND:"exportMP3",AUDIO_WAV:"audio/wav",AUDIO_MP3:"audio/mp3",RECORD_COMMAND:"record",INIT_COMMAND:"init",FILTERS_NAMES:Si,WORKLET_PATHS:{BITCRUSHER:"BitCrusher.worklet.js",LIMITER:"Limiter.worklet.js",SOUNDTOUCH:"Soundtouch.worklet.js",RECORDER_WORKLET:"RecorderWorklet.js",RENDERING_PROGRESS_CALCULATION:"RenderingProgressCalculation.worklet.js"},WORKLET_NAMES:{BITCRUSHER:"bitcrusher-processor",LIMITER:"limiter-processor",SOUNDTOUCH:"soundtouch-processor",RECORDER_WORKLET:"recorder-worklet",RENDERING_PROGRESS_CALCULATION:"rendering-progress-calculation-worklet"},PREFERENCES_KEYS:{COMPATIBILITY_MODE_ENABLED:"compatibility-mode-enabled",COMPATIBILITY_MODE_CHECKED:"compatibility-mode-checked",ENABLE_AUDIO_WORKLET:"enable-audio-worklet",ENABLE_SOUNDTOUCH_AUDIO_WORKLET:"enable-soundtouch-audio-worklet",BUFFER_SIZE:"buffer-size",SAMPLE_RATE:"sample-rate",DISABLE_INITIAL_RENDERING:"disable-initial-rendering",BITRATE_MP3:"bitrate-mp3"},ENABLE_SOUNDTOUCH_AUDIO_WORKLET:!0,ENABLE_AUDIO_WORKLET:!0,ENABLE_RECORDER_AUDIO_WORKLET:!0,SOUNDTOUCH_PITCH_SHIFTER_BUFFER_SIZE:16384,SOUNDTOUCH_DEFAULT_SPEED:1,SOUNDTOUCH_DEFAULT_FREQUENCY:1,SOUNDTOUCH_DEFAULT_PITCH_SEMITONES:0,DEFAULT_REVERB_ENVIRONMENT:{name:"Medium Damping Cave E002 M2S",url:"impulse_response.wav",size:1350278,addDuration:4,link:"http://www.cksde.com/p_6_250.htm"},VOCODER_MODULATOR:"modulator.mp3",DEFAULT_BUFFER_SIZE:0,VALID_BUFFER_SIZE:[0,256,512,1024,2048,4096,8192,16384],VALID_MP3_BITRATES:[32,64,96,128,160,256,320],DEFAULT_SAMPLE_RATE:0,VALID_SAMPLE_RATES:[0,8e3,11025,16e3,22050,32e3,44100,48e3,88200,96e3,176400,192e3],TREATMENT_TIME_COUNTING_THROTTLE_INTERVAL:100,TREATMENT_TIME_COUNTING_SMOOTHING_FACTOR:.9,DISABLE_INITIAL_RENDERING:!1,DEFAULT_SAVE_FORMAT:"wav",DEFAULT_MP3_BITRATE:320};function Ai(e){return new Worker((e||"")+"RecorderWorker.js")}let _i=class{constructor(e){this.worker=null,this.node=null,this.context=null,this.config={bufferLen:4096,sampleRate:44100,numChannels:2,mimeType:"audio/wav",workletBasePath:"worklets/",workerBasePath:"workers/",bitrate:bi.DEFAULT_MP3_BITRATE,callback:()=>{}},this.callbacks={getBuffer:[],exportWAV:[],exportMP3:[]},this.recording=!1,Object.assign(this.config,e)}setup(e){return r(this,void 0,void 0,function*(){this.node&&(this.node instanceof AudioWorkletNode&&this.node.port.postMessage("stop"),this.node.disconnect()),e&&(this.context=e.context,yield this.createRecorderNode(),this.node&&this.context&&(e.connect(this.node),this.node.connect(this.context.destination))),this.context&&!this.worker&&(this.worker=Ai(this.config.workerBasePath),this.worker&&(this.worker.postMessage({command:"init",config:{sampleRate:this.context.sampleRate,numChannels:this.config.numChannels,bitrate:this.config.bitrate}}),this.worker.onmessage=e=>{let t=null;switch(e.data.command){case"getBuffer":t=this.callbacks.getBuffer;break;case bi.EXPORT_WAV_COMMAND:t=this.callbacks.exportWAV;break;case bi.EXPORT_MP3_COMMAND:t=this.callbacks.exportMP3}if(t){const i=t.pop();"function"==typeof i&&i(e.data.data)}}))})}createRecorderNode(){return r(this,void 0,void 0,function*(){if(this.context)if(fi.isAudioWorkletCompatible(this.context)&&bi.ENABLE_RECORDER_AUDIO_WORKLET)try{yield this.createRecorderWorklet()}catch(e){console.error(e),this.createRecorderScriptProcessorNode()}else this.createRecorderScriptProcessorNode()})}createRecorderWorklet(){return r(this,void 0,void 0,function*(){if(this.context&&(yield this.context.audioWorklet.addModule(this.config.workletBasePath+bi.WORKLET_PATHS.RECORDER_WORKLET),this.node=new AudioWorkletNode(this.context,bi.WORKLET_NAMES.RECORDER_WORKLET),this.node&&this.node.port)){const e=this.node.parameters.get("numChannels");e&&(e.value=this.config.numChannels,e.setValueAtTime(this.config.numChannels,0)),this.node.port.onmessage=e=>{this.worker&&"record"==e.data.command&&e.data.buffer.length>0&&this.worker.postMessage({command:"record",buffer:e.data.buffer})}}})}createRecorderScriptProcessorNode(){this.context&&(this.node=this.context.createScriptProcessor.call(this.context,this.config.bufferLen,this.config.numChannels,this.config.numChannels),this.node.onaudioprocess=e=>{if(!this.recording)return;const t=[];for(let i=0;i<this.config.numChannels;i++)t.push(e.inputBuffer.getChannelData(i));this.worker&&this.worker.postMessage({command:"record",buffer:t})})}record(){this.recording=!0,this.node instanceof AudioWorkletNode&&this.node.port.postMessage("record")}stop(){this.recording=!1,this.node instanceof AudioWorkletNode&&this.node.port.postMessage("stop")}clear(){this.worker&&this.worker.postMessage({command:"clear"})}kill(){this.clear(),this.stop(),this.worker&&this.worker.terminate()}getBuffer(e){if(!(e=e||this.config.callback))throw new Error("Callback not set");this.callbacks.getBuffer.push(e),this.worker&&this.worker.postMessage({command:"getBuffer"})}exportWAV(e,t){if(t=t||this.config.mimeType,!(e=e||this.config.callback))throw new Error("Callback not set");this.callbacks.exportWAV.push(e),this.worker&&this.worker.postMessage({command:bi.EXPORT_WAV_COMMAND,type:t})}exportMP3(e,t){if(t=t||this.config.mimeType,!(e=e||this.config.callback))throw new Error("Callback not set");this.callbacks.exportMP3.push(e),this.worker&&this.worker.postMessage({command:bi.EXPORT_MP3_COMMAND,type:t})}};_i=e([re(),i("design:paramtypes",[Object])],_i);var Ri=_i;let Ci=class extends di{constructor(e,t){super(),this.recorder=null,this.input=null,this.stream=null,this.alreadyInit=!1,this.timer=null,this.enableAudioFeedback=!1,this.recording=!1,this.deviceList=[],this.constraints={audio:{noiseSuppression:!0,echoCancellation:!0,autoGainControl:!0,sampleRate:{ideal:44100}}},this.sampleRateConfigNotSupported=!1,this.contextManager=e,this.configService=t}init(){return r(this,void 0,void 0,function*(){var e;if(this.isRecordingAvailable()){this.sampleRateConfigNotSupported=!navigator.mediaDevices.getSupportedConstraints().sampleRate,this.contextManager&&(this.sampleRateConfigNotSupported?this.contextManager.createNewContext(0):this.contextManager.createNewContextIfNeeded()),null===(e=this.eventEmitter)||void 0===e||e.emit(exports.EventType.RECORDER_INIT);try{const e=yield navigator.mediaDevices.getUserMedia(this.constraints);this.contextManager&&this.contextManager.currentContext&&this.contextManager.currentContext.resume(),yield this.setup(e,!1,!1),this.alreadyInit=!0,this.timer=new yi(0,1),this.timer.onCount(()=>{var e;null===(e=this.eventEmitter)||void 0===e||e.emit(exports.EventType.RECORDER_COUNT_UPDATE)}),this.successCallback()}catch(e){console.error(e);if(e)switch(e.name){case"SecurityError":case"NotAllowedError":this.errorCallback();break;case"NotFoundError":this.notFoundErrorCallback();break;case"NotSupportedError":this.sampleRateConfigNotSupported||(this.sampleRateConfigNotSupported=!0,this.init());break;default:this.unknownErrorCallback()}}navigator.mediaDevices.ondevicechange=()=>this.updateInputList()}})}successCallback(){var e;null===(e=this.eventEmitter)||void 0===e||e.emit(exports.EventType.RECORDER_SUCCESS)}errorCallback(){var e;null===(e=this.eventEmitter)||void 0===e||e.emit(exports.EventType.RECORDER_ERROR)}notFoundErrorCallback(){var e;null===(e=this.eventEmitter)||void 0===e||e.emit(exports.EventType.RECORDER_NOT_FOUND_ERROR)}unknownErrorCallback(){var e;null===(e=this.eventEmitter)||void 0===e||e.emit(exports.EventType.RECORDER_UNKNOWN_ERROR)}audioFeedback(e){var t;this.contextManager&&this.contextManager.currentContext&&(e?(this.input&&this.input.connect(this.contextManager.currentContext.destination),this.enableAudioFeedback=!0):(this.input&&(this.input.connect(this.contextManager.currentContext.destination),this.input.disconnect(this.contextManager.currentContext.destination)),this.enableAudioFeedback=!1),null===(t=this.eventEmitter)||void 0===t||t.emit(exports.EventType.RECORDER_UPDATE_CONSTRAINTS))}getConstraints(){if(this.stream){const e=this.stream.getTracks();if(e&&e.length>0)return e[0].getSettings()}return null}updateConstraints(){var e;const t=this.getConstraints();t&&(this.constraints.audio=Object.assign(this.constraints.audio,t),null===(e=this.eventEmitter)||void 0===e||e.emit(exports.EventType.RECORDER_UPDATE_CONSTRAINTS))}resetConstraints(e){return r(this,void 0,void 0,function*(){if(this.stream){const t=this.enableAudioFeedback,i=this.recording,r=this.stream.getTracks();if(e&&(this.updateConstraints(),this.constraints.audio=Object.assign(this.constraints.audio,e.audio)),r&&r.length>0)try{yield r[0].applyConstraints(this.constraints.audio);const n=this.getConstraints(),s=e?Object.keys(e.audio)[0]:"";if(this.audioFeedback(!1),this.pause(),!e||n&&n[s]!=e.audio[s]){this.stopStream();const e=yield navigator.mediaDevices.getUserMedia(this.constraints);yield this.setup(e,i,t)}else yield this.setup(null,i,t)}catch(e){console.error(e),this.errorCallback()}}})}setup(e,t,i){return r(this,void 0,void 0,function*(){e&&this.contextManager&&this.contextManager.currentContext&&(this.input=this.contextManager.currentContext.createMediaStreamSource(e),this.stream=e),this.recorder&&this.input&&(yield this.recorder.setup(this.input),t&&(yield this.record())),this.audioFeedback(i),this.updateConstraints(),yield this.updateInputList()})}setNoiseSuppression(e){this.resetConstraints({audio:{noiseSuppression:e}})}setAutoGain(e){this.resetConstraints({audio:{autoGainControl:e}})}setEchoCancellation(e){this.resetConstraints({audio:{echoCancellation:e}})}updateInputList(){return r(this,void 0,void 0,function*(){if(this.deviceList){const e=yield navigator.mediaDevices.enumerateDevices();this.deviceList=[],e.forEach(e=>{"audioinput"==e.kind&&this.deviceList.push(e)})}})}changeInput(e,t){t&&(this.constraints.audio.deviceId=e,this.constraints.audio.groupId=t,this.resetConstraints())}record(){return r(this,void 0,void 0,function*(){this.alreadyInit&&this.configService&&this.input&&(this.recorder||(this.recorder=new Ri({bufferLen:this.configService.getBufferSize(),sampleRate:this.configService.getSampleRate(),numChannels:2,workletBasePath:this.configService.getWorkletBasePath(),workerBasePath:this.configService.getWorkerBasePath(),mimeType:"audio/wav"}),yield this.recorder.setup(this.input)),this.recorder&&this.recorder.record(),this.timer&&this.timer.start(),this.recording=!0,this.eventEmitter&&this.eventEmitter.emit(exports.EventType.RECORDER_RECORDING))})}stop(){this.alreadyInit&&this.recorder&&(this.recorder.stop(),this.timer&&this.timer.stop(),this.recording=!1,this.recorder.getBuffer(e=>{var t;if(this.contextManager&&this.contextManager.currentContext){this.contextManager.currentContext.resume();const i=this.contextManager.currentContext.createBuffer(2,e[0].length,this.contextManager.currentContext.sampleRate);i.getChannelData(0).set(e[0]),i.getChannelData(1).set(e[1]),null===(t=this.eventEmitter)||void 0===t||t.emit(exports.EventType.RECORDER_STOPPED,i),this.reset()}}))}pause(){var e;this.alreadyInit&&(this.recorder&&this.recorder.stop(),this.timer&&this.timer.stop(),this.recording=!1,null===(e=this.eventEmitter)||void 0===e||e.emit(exports.EventType.RECORDER_PAUSED))}stopStream(){if(this.stream){const e=this.stream.getTracks();for(let t=0,i=e.length;t<i;t++)e[t].stop()}}reset(){var e;this.recorder&&this.recorder.kill(),this.timer&&this.timer.stop(),this.audioFeedback(!1),this.stopStream(),this.input=null,this.recorder=null,this.stream=null,this.alreadyInit=!1,this.timer=null,null===(e=this.eventEmitter)||void 0===e||e.emit(exports.EventType.RECORDER_RESETED)}get currentTimeDisplay(){var e,t,i;return(null===(e=this.timer)||void 0===e?void 0:e.seconds)?("0"+Math.trunc((null===(t=this.timer)||void 0===t?void 0:t.seconds)/60)).slice(-2)+":"+("0"+Math.trunc((null===(i=this.timer)||void 0===i?void 0:i.seconds)%60)).slice(-2):"00:00"}get currentTime(){return this.timer?this.timer.seconds:0}getSettings(){return{deviceList:this.deviceList,audioFeedback:this.enableAudioFeedback,constraints:this.constraints.audio}}on(e,t){var i;null===(i=this.eventEmitter)||void 0===i||i.on(e,t)}isRecordingAvailable(){return void 0!==navigator.mediaDevices&&void 0!==navigator.mediaDevices.getUserMedia}};Ci=e([re(),ce(),t(0,ee(hi.AudioContextManager)),t(1,ee(hi.ConfigService)),i("design:paramtypes",[Object,Object])],Ci);var wi=Ci;let Ii=class extends di{constructor(){super(...arguments),this.enabled=!1,this.defaultEnabled=!1}isEnabled(){return this.enabled}isDefaultEnabled(){return this.defaultEnabled}setDefaultEnabled(e){this.defaultEnabled=e,e?this.enable():this.disable()}setEnabled(e){this.enabled=e}enable(){this.setEnabled(!0)}disable(){this.setEnabled(!1)}toggle(){this.setEnabled(!this.isEnabled())}};Ii=e([re()],Ii);var Ti=Ii;class Bi extends Ti{constructor(){super(...arguments),this.defaultSettings=null,this._totalSamples=0}getAddingTime(){return 0}initializeDefaultSettings(){this.defaultSettings=this.getSettings()}getDefaultSettings(){return this.defaultSettings}resetSettings(){return r(this,void 0,void 0,function*(){if(this.defaultSettings)for(const e in this.defaultSettings)this.defaultSettings&&void 0!==this.defaultSettings[e]&&(yield this.setSetting(e,this.defaultSettings[e]))})}isWorklet(){return!1}bufferFetcherReseted(){return Promise.resolve(!1)}set totalSamples(e){this._totalSamples=e}}class Pi{constructor(e,t){this._value=0,this._minValue=0,this._maxValue=Number.MAX_SAFE_INTEGER,this._defaultValue=0,this.context=null,this.automationRate="a-rate",this._defaultValue=void 0!==t?t:0,this._value=this._defaultValue,this.context=e}get value(){return this._value}set value(e){this._value=Math.max(this._minValue,Math.min(this._maxValue,e))}get minValue(){return this._minValue}get maxValue(){return this._maxValue}get defaultValue(){return this._defaultValue}setValueAtTime(e,t){return console.warn("setValueAtTime used with AudioParamPolyfill, is not fully compatible with standard AudioParam"),this.value=e,new Pi(this.context,e)}linearRampToValueAtTime(e,t){return console.warn("linearRampToValueAtTime used with AudioParamPolyfill, is not fully compatible with standard AudioParam"),this.value=e,new Pi(this.context,e)}exponentialRampToValueAtTime(e,t){return console.warn("exponentialRampToValueAtTime used with AudioParamPolyfill, is not fully compatible with standard AudioParam"),this.value=e,new Pi(this.context,e)}cancelAndHoldAtTime(e){throw new Error("Method not implemented.")}cancelScheduledValues(e){throw new Error("Method not implemented.")}setTargetAtTime(e,t,i){throw new Error("Method not implemented.")}setValueCurveAtTime(e,t,i){throw new Error("Method not implemented.")}}class Ni{constructor(e,t,i){this._parameters=new Map,this._port=null,this.currentContext=null,this.workletProcessor=t,this.currentContext=e,this._scriptProcessorNode=e.createScriptProcessor(i,e.destination.channelCount,e.destination.channelCount),this.setupPort(),this.setupProcessor(),this.setupWorkletScope(e)}setupPort(){const e=new MessageChannel;e.port1.onmessage=e=>{this.workletProcessor&&this.workletProcessor.port2&&this.workletProcessor.port2.postMessage(e.data),e&&"stop"===e.data&&this.stop()},this.workletProcessor&&this.workletProcessor.port2&&(this.workletProcessor.port2.onmessage=t=>{e.port1.postMessage(t.data)}),this._port=e.port2}setupProcessor(){if(!this._scriptProcessorNode||!this.workletProcessor)return;this._scriptProcessorNode.onaudioprocess=e=>{if(this.workletProcessor){const t=[fi.convertAudioBufferToFloat32Array(e.inputBuffer)],i=[fi.convertAudioBufferToFloat32Array(e.outputBuffer)],r=[];for(const[e,t]of this._parameters.entries())r.push([e,fi.convertAudioParamToFloat32Array(t,1)]);const n=Object.fromEntries(r);this.workletProcessor.process(t,i,n)}};const e=this.workletProcessor.defaultParameterDescriptors;e&&e.forEach(e=>{this.currentContext&&this._parameters.set(e.name,new Pi(this.currentContext,e.defaultValue))})}setupWorkletScope(e){"undefined"!=typeof window&&(window.sampleRate=e.sampleRate)}stop(){this._scriptProcessorNode=null,this._port=null,this._parameters=new Map,this.currentContext=null,this.workletProcessor=null}get port(){return this._port}get parameters(){return this._parameters}get node(){return this._scriptProcessorNode}get context(){var e;return null===(e=this._scriptProcessorNode)||void 0===e?void 0:e.context}}class Mi{static registerProcessor(e,t){Mi.processorsMap.set(e,t)}static getProcessor(e){const t=Mi.processorsMap.get(e);return t?new t:null}}Mi.processorsMap=new Map;class Oi{constructor(){this.messageChannel=null,this.messageChannel=new MessageChannel}process(e,t,i){return!0}get port(){return this.messageChannel&&this.messageChannel.port1}get port2(){return this.messageChannel&&this.messageChannel.port2}get parameters(){throw new Error("Method not implemented.")}get parameterDescriptors(){throw new Error("Method not implemented.")}get defaultParameterDescriptors(){return[]}}"undefined"==typeof window||"AudioWorkletProcessor"in window||(window.AudioWorkletProcessor=Oi,window.registerProcessor=Mi.registerProcessor),"undefined"==typeof global||"AudioWorkletProcessor"in global||(global.AudioWorkletProcessor=Oi,global.registerProcessor=Mi.registerProcessor);class Di extends Bi{constructor(){super(...arguments),this.currentWorkletNode=null,this.fallbackToScriptProcessor=!1,this.keepCurrentNodeIfPossible=!1,this.loadedModulesMap=new WeakMap}initializeWorklet(e){return r(this,void 0,void 0,function*(){if(this.stop(),!fi.isAudioWorkletCompatible(e))return console.error("Audio Worklets not supported on this browser. Fallback to ScriptProcessor"),void(this.fallbackToScriptProcessor=!0);const t=(this.configService?this.configService.getWorkletBasePath():"")+this.workletPath,i=this.loadedModulesMap.get(e);i&&i.has(t)||(yield e.audioWorklet.addModule(t).then(()=>{const r=null!=i?i:new Set;i||this.loadedModulesMap.set(e,r),r.add(t),this.eventEmitter&&this.eventEmitter.emit(exports.EventType.WORKLET_SUCCESSFULLY_LOADED)}).catch(e=>{console.error(`Error when loading Worklet (${t}) for filter ${this.id}. Fallback to ScriptProcessor. Exception:`,e),this.fallbackToScriptProcessor=!0,this.eventEmitter&&this.eventEmitter.emit(exports.EventType.FALLBACK_WORKLET_TO_SCRIPT_PROCESSOR)}))})}isAudioWorkletEnabled(){return this.configService?this.configService.isAudioWorkletEnabled():bi.ENABLE_AUDIO_WORKLET}isAudioWorkletAvailable(){return this.isAudioWorkletEnabled()&&!this.fallbackToScriptProcessor}initializeNode(e,t){if(this.isAudioWorkletAvailable())this.currentWorkletNode=new AudioWorkletNode(e,t);else{const i=Mi.getProcessor(t);if(!i)throw new Error(`No processor registered with name ${t} for filter ${this.id} to use the fallback/polyfill for AudioWorklet. Make sure you have created the class.`);this.currentWorkletNode=new Ni(e,i,this.configService.getBufferSize())}this.currentWorkletNode&&this.currentWorkletNode.port&&(this.currentWorkletNode.port.onmessage=e=>this.receiveEvent(e))}applyCurrentSettingsToWorklet(){const e=this.getSettings();for(const t of Object.keys(e))this.setWorkletSetting(t,e[t])}setWorkletSetting(e,t){if(this.currentWorkletNode&&this.currentWorkletNode.parameters){const i=this.currentWorkletNode.parameters.get(e);i&&(i.value=t,i.setValueAtTime(t,0))}}getNode(e){if(this.keepCurrentNodeIfPossible&&this.currentWorkletNode&&this.currentWorkletNode.context==e||(this.stop(),this.initializeNode(e,this.workletName)),this.applyCurrentSettingsToWorklet(),this.setEnabled(this.isEnabled()),this.currentWorkletNode)return this.currentWorkletNode instanceof Ni?{input:this.currentWorkletNode.node,output:this.currentWorkletNode.node}:{input:this.currentWorkletNode,output:this.currentWorkletNode};throw new Error("Worklet node has not yet been created")}stop(){this.currentWorkletNode&&this.currentWorkletNode.port&&(this.currentWorkletNode.port.postMessage("stop"),this.currentWorkletNode.port.close(),this.currentWorkletNode.port.onmessage=null),this.currentWorkletNode=null}setEnabled(e){this.currentWorkletNode&&this.currentWorkletNode.port&&this.currentWorkletNode.port.postMessage(e?"enable":"disable"),super.setEnabled(e)}isWorklet(){return!0}}class Fi extends Ti{}let xi=class{constructor(){this._listeners={},this._listeners={}}on(e,t){this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push(t)}emit(e,t){return r(this,void 0,void 0,function*(){if(this._listeners[e])for(const i of this._listeners[e])yield i(t)})}off(e,t){this._listeners[e]&&(this._listeners[e]=this._listeners[e].filter(e=>e!==t))}get listeners(){return this._listeners}set listeners(e){this._listeners=e}};xi=e([re(),i("design:paramtypes",[])],xi);var ki=xi;let Li=class{constructor(){this.mapConfig=new Map,this.workerBasePath="",this.workletBasePath="",this.soundBasePath=""}getConfig(e){return this.mapConfig.get(e)}setConfig(e,t){this.mapConfig.set(e,t)}isCompatibilityModeEnabled(){return"true"==this.getConfig(bi.PREFERENCES_KEYS.COMPATIBILITY_MODE_ENABLED)}isCompatibilityModeChecked(){return"true"==this.getConfig(bi.PREFERENCES_KEYS.COMPATIBILITY_MODE_CHECKED)}isAudioWorkletEnabled(){const e=this.getConfig(bi.PREFERENCES_KEYS.ENABLE_AUDIO_WORKLET);return null!=e?"true"==e:bi.ENABLE_AUDIO_WORKLET}isSoundtouchAudioWorkletEnabled(){const e=this.getConfig(bi.PREFERENCES_KEYS.ENABLE_SOUNDTOUCH_AUDIO_WORKLET);return null!=e?"true"==e:bi.ENABLE_SOUNDTOUCH_AUDIO_WORKLET}getBufferSize(){const e=this.getConfig(bi.PREFERENCES_KEYS.BUFFER_SIZE);return null!=e?parseInt(e,10):bi.DEFAULT_BUFFER_SIZE}getSampleRate(){const e=this.getConfig(bi.PREFERENCES_KEYS.SAMPLE_RATE);return null!=e?parseInt(e,10):bi.DEFAULT_SAMPLE_RATE}getBitrateMP3(){const e=this.getConfig(bi.PREFERENCES_KEYS.BITRATE_MP3);return null!=e?parseInt(e,10):bi.DEFAULT_MP3_BITRATE}enableCompatibilityMode(){this.setConfig(bi.PREFERENCES_KEYS.COMPATIBILITY_MODE_ENABLED,"true")}disableCompatibilityMode(){this.setConfig(bi.PREFERENCES_KEYS.COMPATIBILITY_MODE_ENABLED,"false")}getWorkletBasePath(){return this.workletBasePath}getWorkerBasePath(){return this.workerBasePath}getSoundBasePath(){return this.soundBasePath}setWorkletBasePath(e){this.workletBasePath=e}setWorkerBasePath(e){this.workerBasePath=e}setSoundBasePath(e){this.soundBasePath=e}isInitialRenderingDisabled(){const e=this.getConfig(bi.PREFERENCES_KEYS.DISABLE_INITIAL_RENDERING);return null!=e?"true"==e:bi.DISABLE_INITIAL_RENDERING}};Li=e([re()],Li);var Ui=Li;let Gi=class{constructor(e,t){this.previousSampleRate=bi.DEFAULT_SAMPLE_RATE,this.eventEmitter=e||new ki,this.configService=t}setup(){this.configService&&(this.previousSampleRate=this.configService.getSampleRate(),this.eventEmitter&&this.eventEmitter.emit(exports.EventType.SAMPLE_RATE_CHANGED,this.previousSampleRate)),this.currentContext||this.createNewContext(this.previousSampleRate)}createNewContextIfNeeded(e){if(this.configService&&this.configService.isCompatibilityModeEnabled()&&e){if(this.currentSampleRate!=e.sampleRate)return this.createNewContext(e.sampleRate),!0}else{let e=bi.DEFAULT_SAMPLE_RATE;if(this.configService&&(e=this.configService.getSampleRate()),e!=this.previousSampleRate)return this.createNewContext(e),!0}return!1}createNewContext(e){this._currentContext&&this._currentContext.close();const t={latencyHint:"interactive"};0!=e&&(t.sampleRate=e),this._currentContext=new AudioContext(t),this.eventEmitter&&this.eventEmitter.emit(exports.EventType.SAMPLE_RATE_CHANGED,this.currentSampleRate),this.previousSampleRate=e}createOfflineAudioContext(e,t,i){const r=document.createElement("iframe");r.style.display="none",document.body.appendChild(r);const n=r.contentWindow;if(!n)throw new Error("Failed to create isolated OfflineAudioContext");const s=new(0,n.OfflineAudioContext)(e,t,i);return s.addEventListener("complete",()=>{setTimeout(()=>document.body.removeChild(r))}),s}get currentSampleRate(){return this.currentContext?this.currentContext.sampleRate:0}get currentContext(){return this._currentContext}};e([he(),i("design:type",Function),i("design:paramtypes",[]),i("design:returntype",void 0)],Gi.prototype,"setup",null),Gi=e([re(),t(0,ee(hi.EventEmitter)),t(1,ee(hi.ConfigService)),i("design:paramtypes",[Object,Object])],Gi);var Wi=Gi;let Vi=class extends di{constructor(e,t,i,r){super(),this._renderedBuffer=null,this.audioRenderingLastCanceled=!1,this.initialRenderingDone=!1,this.sumInputBuffer=0,this.bufferPlayer=i,this.filterManager=e,this.rendererManager=t,this.bufferManager=r}prepareContext(e){return r(this,void 0,void 0,function*(){if(this.contextManager){this.contextManager.createNewContextIfNeeded(e)&&this.bufferManager&&(yield this.bufferManager.resetBufferFetcher()),this.contextManager.currentContext&&this.contextManager.currentContext.resume()}})}updateAudioSpeedAndDuration(e){if(this.eventEmitter){if(this.filterManager&&this.filterManager.entrypointFilter){const e=this.filterManager.entrypointFilter.getSpeed();this.eventEmitter.emit(exports.EventType.AUDIO_SPEED_UPDATED,e)}null!=e&&this.eventEmitter.emit(exports.EventType.AUDIO_DURATION_UPDATED,e)}}resetAudioRenderingProgress(){this.eventEmitter&&(this.eventEmitter.emit(exports.EventType.UPDATE_AUDIO_TREATMENT_PERCENT,0),this.eventEmitter.emit(exports.EventType.UPDATE_REMAINING_TIME_ESTIMATED,-1)),this.filterManager&&this.filterManager.disableFilter(bi.FILTERS_NAMES.RENDERING_PROGRESS_CALCULATION)}startRenderingProgressCalculation(){this.filterManager&&this.filterManager.enableFilter(bi.FILTERS_NAMES.RENDERING_PROGRESS_CALCULATION)}renderAudio(e,t){return r(this,void 0,void 0,function*(){if(yield this.prepareContext(e),!this.contextManager||!this.contextManager.currentContext)throw new Error("AudioContext is not yet available");if(!this.filterManager)throw new Error("Filter manager is not available");if(!this.rendererManager)throw new Error("Renderer manager is not available");if(!this.filterManager.entrypointFilter)throw new Error("Entrypoint filter is not available");if(!e)throw new Error("No principal buffer available");this.eventEmitter&&this.eventEmitter.emit(exports.EventType.AUDIO_SPEED_UPDATED,1);const i=!!this.configService&&this.configService.isCompatibilityModeEnabled();if(!this.initialRenderingDone&&this.configService&&this.configService.isInitialRenderingDisabled()&&!i&&!t)return this.loadInitialBuffer(e),this.initialRenderingDone=!0,!0;this.configService&&this.bufferPlayer&&!i&&this.bufferPlayer.compatibilityMode&&this.bufferPlayer.stop(),this.currentOfflineContext=null,this.audioRenderingLastCanceled=!1;const r=this.filterManager.entrypointFilter.getSpeed(),n=fi.calculateAudioDuration(e,this.filterManager,r),s=i?this.contextManager.currentContext:this.contextManager.createOfflineAudioContext(2,this.contextManager.currentContext.sampleRate*n,this.contextManager.currentContext.sampleRate);return this._renderedBuffer=yield this.rendererManager.executeAudioRenderers(e,s),this.resetAudioRenderingProgress(),this.filterManager.setupTotalSamples(n,this.contextManager.currentContext),this.setupOutput(e,s,n)})}setupOutput(e,t,i){return r(this,void 0,void 0,function*(){if(this._renderedBuffer&&this.configService&&this.eventEmitter&&this.bufferPlayer&&this.filterManager){const r=t instanceof AudioContext;if(r||this.startRenderingProgressCalculation(),yield this.filterManager.initializeWorklets(t),yield this.filterManager.connectNodes(t,this._renderedBuffer,!1,r),!this.filterManager.currentNodes)throw new Error("Audio nodes are not connected. Please call FilterManager.connectNodes before calling AudioProcessor.setupOutput");if(r)this.bufferPlayer.setCompatibilityMode(this.filterManager.currentNodes.output),this.updateAudioSpeedAndDuration(i),this.initialRenderingDone=!0;else{this.currentOfflineContext=t,this.filterManager.currentNodes.output.connect(t.destination);const r=yield t.startRendering();if(this.cleanupAfterOfflineRendering(),this.contextManager&&!this.loadRenderedAudio(e,r))return this.setupOutput(e,this.contextManager.currentContext,i);if(this.audioRenderingLastCanceled)return!1;this.eventEmitter.emit(exports.EventType.OFFLINE_AUDIO_RENDERING_FINISHED)}return this.eventEmitter&&this.eventEmitter.emit(exports.EventType.AUDIO_RENDERING_FINISHED),!0}return!1})}cancelAudioRendering(){this.currentOfflineContext&&!this.audioRenderingLastCanceled&&this.filterManager&&(this.audioRenderingLastCanceled=!0,this.filterManager.disconnectOldNodes(!1),this.eventEmitter&&this.eventEmitter.emit(exports.EventType.CANCELLING_AUDIO_PROCESSING))}cleanupAfterOfflineRendering(){this.filterManager&&(this.filterManager.clearWorklets(),this.filterManager.disconnectOldNodes(!1)),this.currentOfflineContext&&(this.currentOfflineContext.destination.disconnect(),this.currentOfflineContext=null)}loadRenderedAudio(e,t){if(this.eventEmitter&&this.bufferPlayer){if(this.audioRenderingLastCanceled)this.initialRenderingDone||(this.loadInitialBuffer(e),this.eventEmitter.emit(exports.EventType.CANCELLED_AND_LOADED_INITIAL_AUDIO));else{if(0==fi.sumAudioBuffer(t)&&0!==this.sumInputBuffer){if(this.configService&&!this.configService.isCompatibilityModeChecked())return this.setCompatibilityModeChecked(!0),this.configService.enableCompatibilityMode(),this.eventEmitter.emit(exports.EventType.COMPATIBILITY_MODE_AUTO_ENABLED),console.warn("Compatibility mode has been automatically enabled because a problem has been detected with the web browser."),!1;this.eventEmitter.emit(exports.EventType.RENDERING_AUDIO_PROBLEM_DETECTED)}this._renderedBuffer=t,this.bufferPlayer.loadBuffer(this._renderedBuffer),this.updateAudioSpeedAndDuration(null)}this.initialRenderingDone=!0}return!0}loadInitialBuffer(e){this.bufferPlayer&&(this._renderedBuffer=e,this.bufferPlayer.loadBuffer(e))}clearRenderedBuffer(){fi.clearAudioBuffer(this._renderedBuffer),this._renderedBuffer=null}setCompatibilityModeChecked(e){this.configService&&this.configService.setConfig(bi.PREFERENCES_KEYS.COMPATIBILITY_MODE_CHECKED,String(e))}get renderedBuffer(){return this._renderedBuffer}};Vi=e([re(),ce(),t(0,ee(hi.FilterManager)),t(1,ee(hi.RendererManager)),t(2,ee(hi.BufferPlayer)),t(3,ee(hi.BufferManager)),i("design:paramtypes",[Object,Object,Object,Object])],Vi);var ji=Vi;let qi=class extends di{constructor(e,t,i,r){super(),this.downloadingInitialData=!1,this.audioBuffersToFetch=[],this.bufferFetcherService=t,this.eventEmitter=i,this.filterManager=e,this.filterManager=e,this.audioBuffersToFetch=r}setup(){this.audioBuffersToFetch.length>0&&this.fetchBuffers(!1)}fetchBuffers(e){return r(this,void 0,void 0,function*(){if(!this.downloadingInitialData&&this.bufferFetcherService){this.downloadingInitialData=!0,this.eventEmitter&&!e&&this.eventEmitter.emit(exports.EventType.LOADING_BUFFERS);try{yield this.bufferFetcherService.fetchAllBuffers(this.audioBuffersToFetch),this.downloadingInitialData=!1,this.eventEmitter&&!e&&this.eventEmitter.emit(exports.EventType.LOADED_BUFFERS)}catch(t){console.error(t),this.eventEmitter&&!e&&this.eventEmitter.emit(exports.EventType.LOADING_BUFFERS_ERROR)}}})}resetBufferFetcher(){return r(this,void 0,void 0,function*(){this.bufferFetcherService&&(this.bufferFetcherService.reset(),yield this.fetchBuffers(!0),this.filterManager&&(yield this.filterManager.resetFilterBuffers()))})}};e([he(),i("design:type",Function),i("design:paramtypes",[]),i("design:returntype",void 0)],qi.prototype,"setup",null),qi=e([re(),ce(),t(0,ee(hi.FilterManager)),t(1,ee(hi.BufferFetcherService)),t(2,ee(hi.EventEmitter)),t(3,ee(hi.AudioBuffersToFetch)),i("design:paramtypes",[Object,Object,Object,Array])],qi);var Hi=qi;let Ki=class extends di{constructor(e,t){super(),this.filters=[],this._entryPointFilter=null,this._currentNodes=null,this.filters=e,this._entryPointFilter=t}setup(){this.initializeFilters(this.filters)}addFilters(...e){this.initializeFilters(e),this.filters.push(...e)}initializeFilters(e){for(const t of e)t.initializeDefaultSettings(),t.injectDependencies(this.bufferFetcherService,this.bufferDecoderService,this.configService,this.eventEmitter,this.contextManager)}getFiltersState(){const e={};return this.filters.forEach(t=>{e[t.id]=t.isEnabled()}),e}getFiltersSettings(){const e=new Map;for(const t of this.filters)e.set(t.id,t.getSettings());return e}enableFilter(e){const t=this.filters.find(t=>t.id===e);t&&t.enable()}disableFilter(e){const t=this.filters.find(t=>t.id===e);t&&t.disable()}toggleFilter(e){const t=this.filters.find(t=>t.id===e);t&&t.toggle()}changeFilterSettings(e,t){return r(this,void 0,void 0,function*(){const i=this.filters.find(t=>t.id===e);if(i)for(const e of Object.keys(t))yield i.setSetting(e,t[e])})}resetFilterSettings(e){return r(this,void 0,void 0,function*(){const t=this.filters.find(t=>t.id===e);t&&(yield t.resetSettings())})}resetAllFiltersState(){this.filters.forEach(e=>{e.isDefaultEnabled()?e.enable():e.disable()})}connectNodes(e,t,i,n){return r(this,void 0,void 0,function*(){if(!this._entryPointFilter)return;let r=null;if(i&&this._currentNodes)r=this._currentNodes.input;else{const i=yield this._entryPointFilter.getEntrypointNode(e,t,!n);r=i.input}const s=[];let o=r;this.disconnectOldNodes(i);const a=this.filters.sort((e,t)=>e.order-t.order).filter((e,t)=>e!==this._entryPointFilter&&(e.isEnabled()||t>=this.filters.length-1));for(const t of a){const i=t.getNode(e);o&&o.connect(i.input),o=i.output,s.push(i)}this._entryPointFilter&&this._entryPointFilter.updateState(),this._currentNodes={input:r,output:o,intermediateNodes:s.filter(e=>e.input!=o&&e.output!=o&&e.input!=r&&e.output!=r)}})}disconnectOldNodes(e){this._currentNodes&&(this._currentNodes.input.disconnect(),e||this._currentNodes.output.disconnect(),this.disconnecteIntermediateNodes())}disconnecteIntermediateNodes(){if(this._currentNodes&&this._currentNodes.intermediateNodes){for(const e of this._currentNodes.intermediateNodes)e.input.disconnect(),e.output.disconnect();this._currentNodes.intermediateNodes=void 0}}initializeWorklets(e){return r(this,void 0,void 0,function*(){for(const t of this.filters)t.isWorklet()&&(this.clearWorklets(),yield t.initializeWorklet(e))})}clearWorklets(){for(const e of this.filters)e.isWorklet()&&e.stop()}getAddingTime(){let e=0;for(const t of this.filters)t.isEnabled()&&(e+=t.getAddingTime());return e}setupTotalSamples(e,t){if(t){const i=e*t.sampleRate;for(const e of this.filters)e.totalSamples=i}}resetFilterBuffers(){return r(this,void 0,void 0,function*(){for(const e of this.filters)yield e.bufferFetcherReseted()})}get entrypointFilter(){return this._entryPointFilter}get currentNodes(){return this._currentNodes}};e([he(),i("design:type",Function),i("design:paramtypes",[]),i("design:returntype",void 0)],Ki.prototype,"setup",null),Ki=e([re(),ce(),t(0,ue(hi.Filters)),t(1,ee(hi.EntryPointFilter)),i("design:paramtypes",[Array,Object])],Ki);var $i=Ki;let zi=class extends di{constructor(e=[]){super(),this.renderers=[],this.renderers=e}setup(){this.initializeRenderers(this.renderers)}addRenderers(...e){this.initializeRenderers(e),this.renderers.push(...e)}initializeRenderers(e){for(const t of e)t.injectDependencies(this.bufferFetcherService,this.bufferDecoderService,this.configService,this.eventEmitter,this.contextManager)}getRenderersState(){const e={};return this.renderers.forEach(t=>{e[t.id]=t.isEnabled()}),e}enableRenderer(e){const t=this.renderers.find(t=>t.id===e);t&&t.enable()}disableRenderer(e){const t=this.renderers.find(t=>t.id===e);t&&t.disable()}toggleRenderer(e){const t=this.renderers.find(t=>t.id===e);t&&t.toggle()}resetAllRenderersState(){this.renderers.forEach(e=>{e.isDefaultEnabled()?e.enable():e.disable()})}executeAudioRenderers(e,t){return r(this,void 0,void 0,function*(){let i=e;for(const e of this.renderers.sort((e,t)=>e.order-t.order))e.isEnabled()&&(i=yield e.renderAudio(t,i));return i})}};e([he(),i("design:type",Function),i("design:paramtypes",[]),i("design:returntype",void 0)],zi.prototype,"setup",null),zi=e([re(),ce(),t(0,ue(hi.Renderers)),i("design:paramtypes",[Array])],zi);var Yi=zi;let Xi=class extends di{constructor(e,t){super(),this._savingBuffer=!1,this.playingStoppedCallback=null,this.bufferPlayer=t,this.filterManager=e}setup(){this.eventEmitter&&this.eventEmitter.on(exports.EventType.PLAYING_FINISHED,()=>{this._savingBuffer&&this.playingStoppedCallback&&this.eventEmitter&&this.eventEmitter.off(exports.EventType.PLAYING_STOPPED,this.playingStoppedCallback)})}saveBuffer(e,t,i){return r(this,void 0,void 0,function*(){if(this._savingBuffer)throw new Error("The buffer is currently saving");if(!this.bufferPlayer)throw new Error("No buffer player was found");this._savingBuffer=!0;let r=!1;return r=this.bufferPlayer.compatibilityMode?yield this.saveBufferCompatibilityMode(t,i):yield this.saveBufferDirect(e,t),this._savingBuffer=!1,r})}saveBufferDirect(e,t){return new Promise((i,r)=>{var n;if(!e||this.contextManager&&!this.contextManager.currentContext)return void r("No rendered buffer or AudioContext not initialized");const s=Ai(null===(n=this.configService)||void 0===n?void 0:n.getWorkerBasePath());if(s){const r=[];for(let t=0;t<e.numberOfChannels;t++)r.push(e.getChannelData(t));s.onmessage=e=>{e.data.command!=bi.EXPORT_WAV_COMMAND&&e.data.command!=bi.EXPORT_MP3_COMMAND||this.downloadAudioBlob(e.data.data,t),s.terminate(),this._savingBuffer=!1,i(!0)},s.postMessage({command:bi.INIT_COMMAND,config:{sampleRate:e.sampleRate,numChannels:2,bitrate:(null==t?void 0:t.bitrate)||bi.DEFAULT_MP3_BITRATE}}),s.postMessage({command:bi.RECORD_COMMAND,buffer:r}),s.postMessage({command:"mp3"===(null==t?void 0:t.format)||"mp3"===bi.DEFAULT_SAVE_FORMAT?bi.EXPORT_MP3_COMMAND:bi.EXPORT_WAV_COMMAND,type:bi.AUDIO_WAV})}})}saveBufferCompatibilityMode(e,t){return new Promise((i,r)=>{this.bufferPlayer?this.bufferPlayer.start().then(()=>{if(!this.configService)return r("No config service found");if(!this.filterManager)return r("No filter manager found");if(!this.filterManager.currentNodes)return r("No current nodes found");const n=t||new _i({bufferLen:this.configService.getBufferSize(),sampleRate:this.configService.getSampleRate(),numChannels:2,workletBasePath:this.configService.getWorkletBasePath(),workerBasePath:this.configService.getWorkerBasePath(),mimeType:"mp3"==(null==e?void 0:e.format)?bi.AUDIO_MP3:bi.AUDIO_WAV,bitrate:(null==e?void 0:e.bitrate)||bi.DEFAULT_MP3_BITRATE});n.setup(this.filterManager.currentNodes.output).then(()=>{n.record();const t=()=>{this.playingStoppedCallback&&this.eventEmitter&&this.eventEmitter.off(exports.EventType.PLAYING_STOPPED,this.playingStoppedCallback),n.stop();const r=r=>{this.downloadAudioBlob(r,e),this._savingBuffer=!1,this.eventEmitter&&this.eventEmitter.off(exports.EventType.PLAYING_FINISHED,t),n.kill(),i(!0)};"mp3"===(null==e?void 0:e.format)||"mp3"===bi.DEFAULT_SAVE_FORMAT?n.exportMP3(r):n.exportWAV(r)};this.playingStoppedCallback=()=>{n.kill(),this._savingBuffer=!1,this.eventEmitter&&(this.eventEmitter.off(exports.EventType.PLAYING_FINISHED,t),this.playingStoppedCallback&&this.eventEmitter.off(exports.EventType.PLAYING_STOPPED,this.playingStoppedCallback)),i(!0)},this.eventEmitter&&(this.eventEmitter.on(exports.EventType.PLAYING_FINISHED,t),this.eventEmitter.on(exports.EventType.PLAYING_STOPPED,this.playingStoppedCallback))})}):r("No buffer player found")})}downloadAudioBlob(e,t){fi.forceDownload(e,"audio-"+(new Date).toISOString()+"."+((null==t?void 0:t.format)||bi.DEFAULT_SAVE_FORMAT))}get savingBuffer(){return this._savingBuffer}};e([he(),i("design:type",Function),i("design:paramtypes",[]),i("design:returntype",void 0)],Xi.prototype,"setup",null),Xi=e([re(),ce(),t(0,ee(hi.FilterManager)),t(1,ee(hi.BufferPlayer)),i("design:paramtypes",[Object,Object])],Xi);var Qi=Xi;let Zi=class{constructor(e,t,i){this.buffers=new Map,this.bufferErrors=[],this.configService=null,this.contextManager=e,this.eventEmitter=i||new ki,this.configService=t}fetchBuffer(e,t){return r(this,void 0,void 0,function*(){var i,r,n,s;const o=(this.configService?this.configService.getSoundBasePath():"")+e;if(null==this.buffers.get(this.getKeyFromLocation(o))||t){null===(i=this.eventEmitter)||void 0===i||i.emit(exports.EventType.FETCHING_BUFFERS,o);try{const e=yield fetch(o);if(!e.ok)throw this.bufferErrors.push(o),null===(r=this.eventEmitter)||void 0===r||r.emit(exports.EventType.FETCHING_BUFFERS_ERROR,o),exports.EventType.FETCHING_BUFFERS_ERROR;{const t=yield e.arrayBuffer();if(this.contextManager&&this.contextManager.currentContext){const e=yield this.contextManager.currentContext.decodeAudioData(t);this.buffers.set(this.getKeyFromLocation(o),fi.decodeBuffer(this.contextManager.currentContext,e))}}null===(n=this.eventEmitter)||void 0===n||n.emit(exports.EventType.FINISHED_FETCHING_BUFFERS,o)}catch(e){throw console.error(e),this.bufferErrors.push(o),null===(s=this.eventEmitter)||void 0===s||s.emit(exports.EventType.FETCHING_BUFFERS_ERROR,o),exports.EventType.FETCHING_BUFFERS_ERROR}}})}fetchAllBuffers(e){return r(this,void 0,void 0,function*(){for(const t of e)yield this.fetchBuffer(t)})}getAudioBuffer(e){return this.buffers.get(this.getKeyFromLocation(e))}getOrFetchAudioBuffer(e){return r(this,void 0,void 0,function*(){return null==this.getAudioBuffer(e)&&(yield this.fetchBuffer(e)),this.getAudioBuffer(e)})}getDownloadedBuffersList(){return Array.from(this.buffers.keys())}getKeyFromLocation(e){return e.substring(e.lastIndexOf("/")+1)}reset(){this.buffers.clear()}};Zi=e([re(),t(0,ee(hi.AudioContextManager)),t(1,ee(hi.ConfigService)),t(2,ee(hi.EventEmitter)),i("design:paramtypes",[Object,Object,Object])],Zi);var Ji=Zi;let er=class{constructor(e,t){this.contextManager=e,this.eventEmitter=t||new ki}decodeBufferFromFile(e){return r(this,void 0,void 0,function*(){this.eventEmitter&&this.eventEmitter.emit(exports.EventType.DECODING_AUDIO_FILE);try{if(this.contextManager&&this.contextManager.currentContext){const t=yield fi.loadAudioBuffer(this.contextManager.currentContext,e);return this.eventEmitter&&this.eventEmitter.emit(exports.EventType.DECODED_AUDIO_FILE),t}}catch(e){console.error(e),this.eventEmitter&&(this.eventEmitter.emit(exports.EventType.DECODED_AUDIO_FILE),this.eventEmitter.emit(exports.EventType.ERROR_DECODING_AUDIO_FILE))}return null})}};er=e([re(),t(0,ee(hi.AudioContextManager)),t(1,ee(hi.EventEmitter)),i("design:paramtypes",[Object,Object])],er);var tr=er;class ir extends Fi{renderAudio(e,t){const i=t.numberOfChannels,r=e.sampleRate*t.duration+2*e.sampleRate,n=e.createBuffer(i,r,e.sampleRate);for(let e=0;e<i;e++){const i=n.getChannelData(e),s=t.getChannelData(e);for(let e=0;e<r;e++)e<s.length?i[e]=s[s.length-1-e]:i[e]=0}return Promise.resolve(n)}get order(){return 0}get id(){return bi.FILTERS_NAMES.RETURN_AUDIO}}class rr extends Bi{constructor(){super(...arguments),this.frequencyBooster=200,this.frequencyReduce=200,this.dbBooster=20,this.dbReduce=0}getNode(e){const t=e.createBiquadFilter();t.type="lowshelf",t.frequency.value=this.frequencyBooster,t.gain.value=this.dbBooster;const i=e.createBiquadFilter();return i.type="highshelf",i.frequency.value=this.frequencyReduce,i.gain.value=this.dbReduce,i.connect(t),{input:i,output:t}}get order(){return 3}get id(){return bi.FILTERS_NAMES.BASS_BOOST}getSettings(){return{frequencyBooster:this.frequencyBooster,frequencyReduce:this.frequencyReduce,dbBooster:this.dbBooster,dbReduce:this.dbReduce}}setSetting(e,t){if(!fi.isSettingValueValid(t))return Promise.resolve();switch(e){case"frequencyBooster":this.frequencyBooster=parseInt(t,10);break;case"frequencyReduce":this.frequencyReduce=parseInt(t,10);break;case"dbBooster":this.dbBooster=parseInt(t,10);break;case"dbReduce":this.dbReduce=parseInt(t,10)}return Promise.resolve()}}class nr extends AudioWorkletProcessor{constructor(){super(),this.stopped=!1,this.disabled=!1,this.phaser=null,this.last=null,this.port.onmessage=e=>{switch(e.data){case"stop":this.stop();break;case"disable":this.disabled=!0;break;case"enable":this.disabled=!1}}}static get parameterDescriptors(){return[{name:"bits",defaultValue:16},{name:"normFreq",defaultValue:.9}]}get defaultParameterDescriptors(){return nr.parameterDescriptors}process(e,t,i){if(this.stopped||this.disabled)return!1;const r=e[0],n=t[0],s=2*Math.pow(.5,i.bits[0]),o=(1-i.normFreq[0])/(sampleRate/48e3);if(null==this.last&&(this.last=new Array(r.length).fill(0)),null==this.phaser&&(this.phaser=new Array(r.length).fill(0)),r&&r[0]){const e=r[0].length;for(let t=0;t<r.length;t++){const i=r[t],a=n[t];if(i&&a)for(let r=0;r<e;r++)this.phaser[t]+=o,this.phaser[t]>=1&&(this.phaser[t]-=1,this.last[t]=s*Math.floor(i[r]*(1/s)+.5)),a[r]=this.last[t]}}return!0}stop(){this.stopped=!0,this.phaser=null,this.last=null}}registerProcessor(bi.WORKLET_NAMES.BITCRUSHER,nr);class sr extends Di{constructor(){super(...arguments),this.bits=16,this.normFreq=.9}receiveEvent(e){}get workletPath(){return bi.WORKLET_PATHS.BITCRUSHER}get workletName(){return bi.WORKLET_NAMES.BITCRUSHER}get order(){return 6}get id(){return bi.FILTERS_NAMES.BITCRUSHER}getSettings(){return{bits:this.bits,normFreq:this.normFreq}}setSetting(e,t){if(!fi.isSettingValueValid(t))return Promise.resolve();switch(e){case"bits":this.bits=parseInt(t,10);break;case"normFreq":this.normFreq=parseFloat(t)}return this.applyCurrentSettingsToWorklet(),Promise.resolve()}}class or extends Bi{constructor(){super(...arguments),this.delay=.2,this.gain=.75}getNode(e){const t=e.createDelay(179);t.delayTime.value=this.delay;const i=e.createGain();return i.gain.value=this.gain,i.connect(t),t.connect(i),{input:i,output:t}}get order(){return 7}get id(){return bi.FILTERS_NAMES.ECHO}getAddingTime(){return 5}getSettings(){return{delay:this.delay,gain:this.gain}}setSetting(e,t){if(!fi.isSettingValueValid(t))return Promise.resolve();switch(e){case"delay":this.delay=parseFloat(t);break;case"gain":this.gain=parseFloat(t)}return Promise.resolve()}}class ar extends Bi{constructor(){super(...arguments),this.highFrequency=3500}getNode(e){const t=e.createBiquadFilter();return t.type="highpass",t.frequency.value=this.highFrequency,{input:t,output:t}}get order(){return 4}get id(){return bi.FILTERS_NAMES.HIGH_PASS}getSettings(){return{highFrequency:this.highFrequency}}setSetting(e,t){if(!fi.isSettingValueValid(t))return Promise.resolve();if("highFrequency"===e)this.highFrequency=parseInt(t,10);return Promise.resolve()}}class cr{constructor(e){this._array=new Float32Array,this.n=0,this.length=0,this.readPointer=0,this.writePointer=0,this.n=Math.floor(e),this.init()}init(){this._array=new Float32Array(2*this.n),this.length=this._array.length,this.readPointer=0,this.writePointer=this.n-1,this._array.fill(0)}read(){const e=this._array[this.readPointer%this.length];return this.readPointer=(this.readPointer+1)%this.length,e}push(e){this._array[this.writePointer%this.length]=e,this.writePointer=(this.writePointer+1)%this.length}reset(){this.init()}clear(){this._array=new Float32Array,this.length=0,this.readPointer=0,this.writePointer=0}sum(){return this._array.reduce((e,t)=>e+t,0)}}class ur extends AudioWorkletProcessor{constructor(){super(),this.delayBuffer=[],this.envelopeSamples=[],this.stopped=!1,this.disabled=!1,this.port.onmessage=e=>{switch(e.data){case"reset":this.reset();break;case"stop":this.stop();break;case"disable":this.disabled=!0;break;case"enable":this.disabled=!1}}}static get parameterDescriptors(){return[{name:"preGain",defaultValue:0},{name:"postGain",defaultValue:0},{name:"attackTime",defaultValue:0},{name:"releaseTime",defaultValue:3},{name:"threshold",defaultValue:-.05},{name:"lookAheadTime",defaultValue:0}]}get defaultParameterDescriptors(){return ur.parameterDescriptors}process(e,t,i){if(this.stopped)return!1;const r=e[0],n=t[0],s=this.applyPreGainAndComputeEnvelope(r,n,i);return this.applyLimiter(r,n,i,s),!0}getEnvelope(e,t,i,r,n){const s=Math.exp(-1/(r*t)),o=Math.exp(-1/(r*i)),a=new Float32Array(e.length);null==this.envelopeSamples[n]&&(this.envelopeSamples[n]=0);for(let t=0;t<e.length;t++){const i=Math.abs(e[t]);this.envelopeSamples[n]<i?this.envelopeSamples[n]=i+s*(this.envelopeSamples[n]-i):this.envelopeSamples[n]=i+o*(this.envelopeSamples[n]-i),a[t]=this.envelopeSamples[n]}return a}getMaxEnvelope(e,t,i){let r=e[0][i];for(let n=0;n<t;n++)e[n][i]>r&&(r=e[n][i]);return r}ampToDB(e){return 20*Math.log10(e)}dBToAmp(e){return Math.pow(10,e/20)}applyPreGainAndComputeEnvelope(e,t,i){const r=this.dBToAmp(i.preGain[0]),n=[];for(let s=0;s<t.length;s++){const o=e[s],a=t[s];null==this.delayBuffer[s]&&(this.delayBuffer[s]=new cr(i.lookAheadTime[0]*sampleRate)),o&&a&&this.applyPreGain(o,a,r),!this.disabled&&a&&(n[s]=this.getEnvelope(a,i.attackTime[0],i.releaseTime[0],sampleRate,s))}return n}applyPreGain(e,t,i){for(let r=0;r<e.length;++r)this.disabled?t[r]=e[r]:t[r]=i*e[r]}applyLimiter(e,t,i,r){const n=this.dBToAmp(i.postGain[0]);for(let s=0;s<t.length;s++){const o=e[s],a=t[s];if(i.lookAheadTime[0]>0&&a&&this.applyLookAheadDelay(a,s),this.disabled)continue;const c=1;if(o&&a)for(let e=0;e<o.length;e++){let s=c*(i.threshold[0]-this.ampToDB(this.getMaxEnvelope(r,t.length,e)));s=Math.min(0,s);const o=this.dBToAmp(s);a[e]*=o*n}}}applyLookAheadDelay(e,t){for(let i=0;i<e.length;i++)this.delayBuffer[t].push(e[i]),e[i]=this.delayBuffer[t].read()}clearBuffers(){for(let e=0;e<this.delayBuffer.length;e++)null!=this.delayBuffer[e]&&this.delayBuffer[e].clear();this.delayBuffer=[],this.envelopeSamples=[]}reset(){this.clearBuffers()}stop(){this.clearBuffers(),this.stopped=!0}}registerProcessor(bi.WORKLET_NAMES.LIMITER,ur);class hr extends Di{constructor(){super(),this.preGain=0,this.postGain=0,this.attackTime=0,this.releaseTime=5,this.threshold=0,this.lookAheadTime=.35,this.keepCurrentNodeIfPossible=!0,this.setDefaultEnabled(!0)}receiveEvent(e){}get workletPath(){return bi.WORKLET_PATHS.LIMITER}get workletName(){return bi.WORKLET_NAMES.LIMITER}get order(){return 11}get id(){return bi.FILTERS_NAMES.LIMITER}getAddingTime(){return this.lookAheadTime}getSettings(){return{preGain:this.preGain,postGain:this.postGain,attackTime:this.attackTime,releaseTime:this.releaseTime,threshold:this.threshold,lookAheadTime:this.lookAheadTime}}setSetting(e,t){if(!fi.isSettingValueValid(t))return Promise.resolve();switch(e){case"preGain":this.preGain=parseFloat(t);break;case"postGain":this.postGain=parseFloat(t);break;case"attackTime":this.attackTime=parseFloat(t);break;case"releaseTime":this.releaseTime=parseFloat(t);break;case"threshold":this.threshold=parseFloat(t);break;case"lookAheadTime":this.lookAheadTime=parseFloat(t)}return this.applyCurrentSettingsToWorklet(),Promise.resolve()}}class lr extends Bi{constructor(){super(...arguments),this.lowFrequency=3500}getNode(e){const t=e.createBiquadFilter();return t.type="lowpass",t.frequency.value=this.lowFrequency,{input:t,output:t}}get order(){return 5}get id(){return bi.FILTERS_NAMES.LOW_PASS}getSettings(){return{lowFrequency:this.lowFrequency}}setSetting(e,t){if(!fi.isSettingValueValid(t))return Promise.resolve();if("lowFrequency"===e)this.lowFrequency=parseInt(t,10);return Promise.resolve()}}class dr extends Bi{constructor(){super(...arguments),this.reverbEnvironment=bi.DEFAULT_REVERB_ENVIRONMENT,this.reverbCustomEnvironmentAddTime=5,this.customEnvironment=null}getNode(e){const t=e.createConvolver();this.reverbEnvironment&&("custom"!=this.reverbEnvironment.url||this.customEnvironment)||(this.reverbEnvironment=bi.DEFAULT_REVERB_ENVIRONMENT);const i=this.getReverbBuffer(e);return i&&(t.buffer=i),{input:t,output:t}}getReverbBuffer(e){if("custom"==this.reverbEnvironment.url&&this.customEnvironment){if(this.customEnvironment.sampleRate===e.sampleRate)return this.customEnvironment;this.reverbEnvironment=bi.DEFAULT_REVERB_ENVIRONMENT}else if(this.bufferFetcherService)return this.bufferFetcherService.getAudioBuffer(this.reverbEnvironment.url)}get order(){return 9}get id(){return bi.FILTERS_NAMES.REVERB}getAddingTime(){const e=this.getSettings();if(e&&e.reverbEnvironment){if("custom"==e.reverbEnvironment.value)return this.reverbCustomEnvironmentAddTime;if(e.reverbEnvironment.additionalData)return e.reverbEnvironment.additionalData.addDuration}return 0}getSettings(){var e;return this.reverbEnvironment?{reverbEnvironment:{name:this.reverbEnvironment.name,value:this.reverbEnvironment.url,additionalData:{size:this.reverbEnvironment.size,link:this.reverbEnvironment.link,addDuration:this.reverbEnvironment.addDuration}},downloadedBuffers:null===(e=this.bufferFetcherService)||void 0===e?void 0:e.getDownloadedBuffersList(),hasCustomEnvironment:Boolean(this.customEnvironment),reverbCustomEnvironmentAddTime:this.reverbCustomEnvironmentAddTime}:{reverbCustomEnvironmentAddTime:this.reverbCustomEnvironmentAddTime}}setSetting(e,t){return r(this,void 0,void 0,function*(){var i;if("reverbEnvironment"==e){const e=t;if(e){const t=e.value;try{"custom"!=t&&(yield null===(i=this.bufferFetcherService)||void 0===i?void 0:i.fetchBuffer(t)),e.additionalData?this.reverbEnvironment={name:e.name,url:t,size:e.additionalData.size,addDuration:e.additionalData.addDuration,link:e.additionalData.link}:this.reverbEnvironment={name:e.name,url:t,size:0,addDuration:0,link:""}}catch(e){console.error(e)}}}else"reverbCustomEnvironmentAddTime"==e?fi.isSettingValueValid(t)&&(this.reverbCustomEnvironmentAddTime=parseInt(t,10)):"reverbCustomEnvironmentFile"==e&&this.bufferDecoderService&&t&&(this.customEnvironment=yield this.bufferDecoderService.decodeBufferFromFile(t),this.customEnvironment||(this.reverbEnvironment=bi.DEFAULT_REVERB_ENVIRONMENT))})}bufferFetcherReseted(){return r(this,void 0,void 0,function*(){var e;const t=this.getSettings();if(t){const i=null===(e=t.reverbEnvironment)||void 0===e?void 0:e.value;if(i&&"custom"!==i&&this.bufferFetcherService)return yield this.bufferFetcherService.fetchBuffer(i),!0}return!1})}}class fr{constructor(){this._vector=new Float32Array,this._position=0,this._frameCount=0}get vector(){return this._vector}get position(){return this._position}get startIndex(){return 2*this._position}get frameCount(){return this._frameCount}get endIndex(){return 2*(this._position+this._frameCount)}clear(){this.receive(this._frameCount),this.rewind()}put(e){this._frameCount+=e}putSamples(e,t,i=0){const r=2*(t=t||0);i>=0||(i=(e.length-r)/2);const n=2*i;this.ensureCapacity(i+this._frameCount);const s=this.endIndex;this.vector.set(e.subarray(r,r+n),s),this._frameCount+=i}putBuffer(e,t,i=0){t=t||0,i>=0||(i=e.frameCount-t),this.putSamples(e.vector,e.position+t,i)}receive(e){e>=0&&!(e>this._frameCount)||(e=this.frameCount),this._frameCount-=e,this._position+=e}receiveSamples(e,t=0){const i=2*t,r=this.startIndex;e.set(this._vector.subarray(r,r+i)),this.receive(t)}extract(e,t=0,i=0){const r=this.startIndex+2*t,n=2*i;e.set(this._vector.subarray(r,r+n))}ensureCapacity(e=0){const t=parseInt(2*e);if(this._vector.length<t){const e=new Float32Array(t);e.set(this._vector.subarray(this.startIndex,this.endIndex)),this._vector=e,this._position=0}else this.rewind()}ensureAdditionalCapacity(e=0){this.ensureCapacity(this._frameCount+e)}rewind(){this._position>0&&(this._vector.set(this._vector.subarray(this.startIndex,this.endIndex)),this._position=0)}}class pr{constructor(e){e?(this._inputBuffer=new fr,this._outputBuffer=new fr):this._inputBuffer=this._outputBuffer=null}get inputBuffer(){return this._inputBuffer}set inputBuffer(e){this._inputBuffer=e}get outputBuffer(){return this._outputBuffer}set outputBuffer(e){this._outputBuffer=e}clear(){this._inputBuffer.clear(),this._outputBuffer.clear()}}class vr extends pr{constructor(e){super(e),this.reset(),this._rate=1}set rate(e){this._rate=e}reset(){this.slopeCount=0,this.prevSampleL=0,this.prevSampleR=0}clone(){const e=new vr;return e.rate=this._rate,e}process(){const e=this._inputBuffer.frameCount;this._outputBuffer.ensureAdditionalCapacity(e/this._rate+1);const t=this.transpose(e);this._inputBuffer.receive(),this._outputBuffer.put(t)}transpose(e=0){if(0===e)return 0;const t=this._inputBuffer.vector,i=this._inputBuffer.startIndex,r=this._outputBuffer.vector,n=this._outputBuffer.endIndex;let s=0,o=0;for(;this.slopeCount<1;)r[n+2*o]=(1-this.slopeCount)*this.prevSampleL+this.slopeCount*t[i],r[n+2*o+1]=(1-this.slopeCount)*this.prevSampleR+this.slopeCount*t[i+1],o+=1,this.slopeCount+=this._rate;if(this.slopeCount-=1,1!==e)e:for(;;){for(;this.slopeCount>1;)if(this.slopeCount-=1,s+=1,s>=e-1)break e;const a=i+2*s;r[n+2*o]=(1-this.slopeCount)*t[a]+this.slopeCount*t[a+2],r[n+2*o+1]=(1-this.slopeCount)*t[a+1]+this.slopeCount*t[a+3],o+=1,this.slopeCount+=this._rate}return this.prevSampleL=t[i+2*e-2],this.prevSampleR=t[i+2*e-1],o}}class gr{constructor(e){this._pipe=e}get pipe(){return this._pipe}get inputBuffer(){return this._pipe.inputBuffer}get outputBuffer(){return this._pipe.outputBuffer}fillInputBuffer(){throw new Error("fillInputBuffer() not overridden")}fillOutputBuffer(e=0){for(;this.outputBuffer.frameCount<e;){const e=16384-this.inputBuffer.frameCount;if(this.fillInputBuffer(e),this.inputBuffer.frameCount<16384)break;this._pipe.process()}}clear(){this._pipe.clear()}}const mr=function(){};class Er extends gr{constructor(e,t,i=mr){super(t),this.callback=i,this.sourceSound=e,this.historyBufferSize=22050,this._sourcePosition=0,this.outputBufferPosition=0,this._position=0}get position(){return this._position}set position(e){if(e>this._position)throw new RangeError("New position may not be greater than current position");const t=this.outputBufferPosition-(this._position-e);if(t<0)throw new RangeError("New position falls outside of history buffer");this.outputBufferPosition=t,this._position=e}get sourcePosition(){return this._sourcePosition}set sourcePosition(e){this.clear(),this._sourcePosition=e}onEnd(){this.callback()}fillInputBuffer(e=0){const t=new Float32Array(2*e),i=this.sourceSound.extract(t,e,this._sourcePosition);this._sourcePosition+=i,this.inputBuffer.putSamples(t,0,i)}extract(e,t=0){this.fillOutputBuffer(this.outputBufferPosition+t);const i=Math.min(t,this.outputBuffer.frameCount-this.outputBufferPosition);this.outputBuffer.extract(e,this.outputBufferPosition,i);const r=this.outputBufferPosition+i;return this.outputBufferPosition=Math.min(this.historyBufferSize,r),this.outputBuffer.receive(Math.max(r-this.historyBufferSize,0)),this._position+=i,i}handleSampleData(e){this.extract(e.data,4096)}clear(){super.clear(),this.outputBufferPosition=0}}const yr=[[124,186,248,310,372,434,496,558,620,682,744,806,868,930,992,1054,1116,1178,1240,1302,1364,1426,1488,0],[-100,-75,-50,-25,25,50,75,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[-20,-15,-10,-5,5,10,15,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[-4,-3,-2,-1,1,2,3,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],Sr=-10/3.75;class br extends pr{constructor(e){super(e),this._quickSeek=!0,this.midBufferDirty=!1,this.midBuffer=null,this.overlapLength=0,this.autoSeqSetting=!0,this.autoSeekSetting=!0,this._tempo=1,this.setParameters(44100,0,0,8)}clear(){super.clear(),this.clearMidBuffer()}clearMidBuffer(){this.midBufferDirty&&(this.midBufferDirty=!1,this.midBuffer=null)}setParameters(e,t,i,r){e>0&&(this.sampleRate=e),r>0&&(this.overlapMs=r),t>0?(this.sequenceMs=t,this.autoSeqSetting=!1):this.autoSeqSetting=!0,i>0?(this.seekWindowMs=i,this.autoSeekSetting=!1):this.autoSeekSetting=!0,this.calculateSequenceParameters(),this.calculateOverlapLength(this.overlapMs),this.tempo=this._tempo}set tempo(e){let t;this._tempo=e,this.calculateSequenceParameters(),this.nominalSkip=this._tempo*(this.seekWindowLength-this.overlapLength),this.skipFract=0,t=Math.floor(this.nominalSkip+.5),this.sampleReq=Math.max(t+this.overlapLength,this.seekWindowLength)+this.seekLength}get tempo(){return this._tempo}get inputChunkSize(){return this.sampleReq}get outputChunkSize(){return this.overlapLength+Math.max(0,this.seekWindowLength-2*this.overlapLength)}calculateOverlapLength(e=0){let t;t=this.sampleRate*e/1e3,t=t<16?16:t,t-=t%8,this.overlapLength=t,this.refMidBuffer=new Float32Array(2*this.overlapLength),this.midBuffer=new Float32Array(2*this.overlapLength)}checkLimits(e,t,i){return e<t?t:e>i?i:e}calculateSequenceParameters(){let e,t;this.autoSeqSetting&&(e=130+-20*this._tempo,e=this.checkLimits(e,50,125),this.sequenceMs=Math.floor(e+.5)),this.autoSeekSetting&&(t=25.666666666666668+Sr*this._tempo,t=this.checkLimits(t,15,25),this.seekWindowMs=Math.floor(t+.5)),this.seekWindowLength=Math.floor(this.sampleRate*this.sequenceMs/1e3),this.seekLength=Math.floor(this.sampleRate*this.seekWindowMs/1e3)}set quickSeek(e){this._quickSeek=e}clone(){const e=new br;return e.tempo=this._tempo,e.setParameters(this.sampleRate,this.sequenceMs,this.seekWindowMs,this.overlapMs),e}seekBestOverlapPosition(){return this._quickSeek?this.seekBestOverlapPositionStereoQuick():this.seekBestOverlapPositionStereo()}seekBestOverlapPositionStereo(){let e,t,i,r=0;for(this.preCalculateCorrelationReferenceStereo(),e=0,t=Number.MIN_VALUE;r<this.seekLength;r+=1)i=this.calculateCrossCorrelationStereo(2*r,this.refMidBuffer),i>t&&(t=i,e=r);return e}seekBestOverlapPositionStereoQuick(){let e,t,i,r,n,s=0;for(this.preCalculateCorrelationReferenceStereo(),t=Number.MIN_VALUE,e=0,r=0,n=0;s<4;s+=1){let o=0;for(;yr[s][o]&&(n=r+yr[s][o],!(n>=this.seekLength));)i=this.calculateCrossCorrelationStereo(2*n,this.refMidBuffer),i>t&&(t=i,e=n),o+=1;r=e}return e}preCalculateCorrelationReferenceStereo(){let e,t,i=0;for(;i<this.overlapLength;i+=1)t=i*(this.overlapLength-i),e=2*i,this.refMidBuffer[e]=this.midBuffer[e]*t,this.refMidBuffer[e+1]=this.midBuffer[e+1]*t}calculateCrossCorrelationStereo(e,t){const i=this._inputBuffer.vector;e+=this._inputBuffer.startIndex;let r=0,n=2;const s=2*this.overlapLength;let o;for(;n<s;n+=2)o=n+e,r+=i[o]*t[n]+i[o+1]*t[n+1];return r}overlap(e){this.overlapStereo(2*e)}overlapStereo(e){const t=this._inputBuffer.vector;e+=this._inputBuffer.startIndex;const i=this._outputBuffer.vector,r=this._outputBuffer.endIndex;let n,s,o=0;const a=1/this.overlapLength;let c,u,h;for(;o<this.overlapLength;o+=1)s=(this.overlapLength-o)*a,c=o*a,n=2*o,u=n+e,h=n+r,i[h+0]=t[u+0]*c+this.midBuffer[n+0]*s,i[h+1]=t[u+1]*c+this.midBuffer[n+1]*s}process(){let e,t,i;if(null===this.midBuffer){if(this._inputBuffer.frameCount<this.overlapLength)return;this.midBuffer=new Float32Array(2*this.overlapLength),this._inputBuffer.receiveSamples(this.midBuffer,this.overlapLength)}for(;this._inputBuffer.frameCount>=this.sampleReq;){e=this.seekBestOverlapPosition(),this._outputBuffer.ensureAdditionalCapacity(this.overlapLength),this.overlap(Math.floor(e)),this._outputBuffer.put(this.overlapLength),t=this.seekWindowLength-2*this.overlapLength,t>0&&this._outputBuffer.putBuffer(this._inputBuffer,e+this.overlapLength,t);const r=this._inputBuffer.startIndex+2*(e+this.seekWindowLength-this.overlapLength);this.midBuffer.set(this._inputBuffer.vector.subarray(r,r+2*this.overlapLength)),this.skipFract+=this.nominalSkip,i=Math.floor(this.skipFract),this.skipFract-=i,this._inputBuffer.receive(i)}}}const Ar=function(e,t){return(e>t?e-t:t-e)>1e-10};class _r{constructor(){this.transposer=new vr(!1),this.stretch=new br(!1),this._inputBuffer=new fr,this._intermediateBuffer=new fr,this._outputBuffer=new fr,this._rate=0,this._tempo=0,this.virtualPitch=1,this.virtualRate=1,this.virtualTempo=1,this.calculateEffectiveRateAndTempo()}clear(){this.transposer.clear(),this.stretch.clear()}clone(){const e=new _r;return e.rate=this.rate,e.tempo=this.tempo,e}get rate(){return this._rate}set rate(e){this.virtualRate=e,this.calculateEffectiveRateAndTempo()}set rateChange(e){this._rate=1+.01*e}get tempo(){return this._tempo}set tempo(e){this.virtualTempo=e,this.calculateEffectiveRateAndTempo()}set tempoChange(e){this.tempo=1+.01*e}set pitch(e){this.virtualPitch=e,this.calculateEffectiveRateAndTempo()}set pitchOctaves(e){this.pitch=Math.exp(.69314718056*e),this.calculateEffectiveRateAndTempo()}set pitchSemitones(e){this.pitchOctaves=e/12}get inputBuffer(){return this._inputBuffer}get outputBuffer(){return this._outputBuffer}calculateEffectiveRateAndTempo(){const e=this._tempo,t=this._rate;this._tempo=this.virtualTempo/this.virtualPitch,this._rate=this.virtualRate*this.virtualPitch,Ar(this._tempo,e)&&(this.stretch.tempo=this._tempo),Ar(this._rate,t)&&(this.transposer.rate=this._rate),this._rate>1?this._outputBuffer!=this.transposer.outputBuffer&&(this.stretch.inputBuffer=this._inputBuffer,this.stretch.outputBuffer=this._intermediateBuffer,this.transposer.inputBuffer=this._intermediateBuffer,this.transposer.outputBuffer=this._outputBuffer):this._outputBuffer!=this.stretch.outputBuffer&&(this.transposer.inputBuffer=this._inputBuffer,this.transposer.outputBuffer=this._intermediateBuffer,this.stretch.inputBuffer=this._intermediateBuffer,this.stretch.outputBuffer=this._outputBuffer)}process(){this._rate>1?(this.stretch.process(),this.transposer.process()):(this.transposer.process(),this.stretch.process())}}class Rr{constructor(e){this.buffer=e,this._position=0}get dualChannel(){return this.buffer.numberOfChannels>1}get position(){return this._position}set position(e){this._position=e}extract(e,t=0,i=0){this.position=i;let r=this.buffer.getChannelData(0),n=this.dualChannel?this.buffer.getChannelData(1):this.buffer.getChannelData(0),s=0;for(;s<t;s++)e[2*s]=r[s+i],e[2*s+1]=n[s+i];return Math.min(t,r.length-i)}}const Cr=function(e){const t=Math.floor(e/60);return`${t}:${function(e,t,i){return i=i||"0",(e+="").length>=t?e:new Array(t-e.length+1).join(i)+e}(parseInt(e-60*t),2)}`},wr=function(e){const t=this.timePlayed,i=this.sampleRate;if(this.sourcePosition=e,this.timePlayed=e/i,t!==this.timePlayed){const e=new CustomEvent("play",{detail:{timePlayed:this.timePlayed,formattedTimePlayed:this.formattedTimePlayed,percentagePlayed:this.percentagePlayed}});this._node.dispatchEvent(e)}};class Ir{constructor(e,t,i,r=mr){this._soundtouch=new _r;const n=new Rr(t);this.timePlayed=0,this.sourcePosition=0,this._filter=new Er(n,this._soundtouch,r),this._node=function(e,t,i=mr,r=4096){const n=e.createScriptProcessor(r,2,2),s=new Float32Array(2*r);return n.onaudioprocess=e=>{let n=e.outputBuffer.getChannelData(0),o=e.outputBuffer.getChannelData(1),a=t.extract(s,r);i(t.sourcePosition),0===a&&t.onEnd();let c=0;for(;c<a;c++)n[c]=s[2*c],o[c]=s[2*c+1]},n}(e,this._filter,e=>wr.call(this,e),i),this.tempo=1,this.rate=1,this.duration=t.duration,this.sampleRate=e.sampleRate,this.listeners=[]}get formattedDuration(){return Cr(this.duration)}get formattedTimePlayed(){return Cr(this.timePlayed)}get percentagePlayed(){return 100*this._filter.sourcePosition/(this.duration*this.sampleRate)}set percentagePlayed(e){this._filter.sourcePosition=parseInt(e*this.duration*this.sampleRate),this.sourcePosition=this._filter.sourcePosition,this.timePlayed=this.sourcePosition/this.sampleRate}get node(){return this._node}set pitch(e){this._soundtouch.pitch=e}set pitchSemitones(e){this._soundtouch.pitchSemitones=e}set rate(e){this._soundtouch.rate=e}set tempo(e){this._soundtouch.tempo=e}connect(e){this._node.connect(e)}disconnect(){this._node.disconnect()}on(e,t){this.listeners.push({name:e,cb:t}),this._node.addEventListener(e,e=>t(e.detail))}off(e=null){let t=this.listeners;e&&(t=t.filter(t=>t.name===e)),t.forEach(e=>{this._node.removeEventListener(e.name,t=>e.cb(t.detail))})}}class Tr extends Di{constructor(){super(),this.speedAudio=bi.SOUNDTOUCH_DEFAULT_SPEED,this.frequencyAudio=bi.SOUNDTOUCH_DEFAULT_FREQUENCY,this.pitchSemitones=bi.SOUNDTOUCH_DEFAULT_PITCH_SEMITONES,this.currentSpeedAudio=bi.SOUNDTOUCH_DEFAULT_SPEED,this.currentBufferSource=null,this.isOfflineMode=!1,this.setDefaultEnabled(!0)}receiveEvent(e){}get workletPath(){return bi.WORKLET_PATHS.SOUNDTOUCH}get workletName(){return bi.WORKLET_NAMES.SOUNDTOUCH}getEntrypointNode(e,t,i){this.isOfflineMode=i,this.cleanUpOldNodes();const{isWorklet:r,renderWithSoundtouch:n}=this.getCurrentRenderingMode();if(n)return r&&fi.isAudioWorkletCompatible(e)?this.renderWithWorklet(t,e):i?this.renderWithScriptProcessorNode(t,e):(this.currentPitchShifter=this.getSoundtouchScriptProcessorNode(t,e),this.updateState(),Promise.resolve({input:this.currentPitchShifter,output:this.currentPitchShifter}));const s=this.constructBufferSourceNode(e,t);return Promise.resolve({input:s,output:s})}getSoundtouchScriptProcessorNode(e,t){return new Ir(t,e,bi.SOUNDTOUCH_PITCH_SHIFTER_BUFFER_SIZE)}constructBufferSourceNode(e,t){const i=e.createBufferSource();return i.buffer=t,i.start(),this.currentBufferSource=i,i}cleanUpOldNodes(){this.currentPitchShifter&&(this.currentPitchShifter.disconnect(),this.currentPitchShifter._filter=null,this.currentPitchShifter=null),this.currentBufferSource&&(this.currentBufferSource.disconnect(),this.currentBufferSource=null)}renderWithScriptProcessorNode(e,t){return r(this,void 0,void 0,function*(){const i=fi.calcAudioDuration(e,this.speedAudio);if(this.contextManager){const r=this.contextManager.createOfflineAudioContext(2,t.sampleRate*i,t.sampleRate);this.currentPitchShifter=this.getSoundtouchScriptProcessorNode(e,r),this.updateState(),this.currentPitchShifter.connect(r.destination);const n=yield r.startRendering(),s=this.constructBufferSourceNode(t,n);return this.currentPitchShifter.disconnect(),{input:s,output:s}}throw new Error("AudioContextManager is not available!")})}renderWithWorklet(e,t){try{const i=this.constructBufferSourceNode(t,e),r=this.getNode(t);return i.connect(r.input),this.updateState(),Promise.resolve({input:r.input,output:r.output})}catch(i){return console.error(i),this.renderWithScriptProcessorNode(e,t)}}get order(){return 2}get id(){return bi.FILTERS_NAMES.SOUNDTOUCH}getSettings(){return{speedAudio:this.speedAudio,frequencyAudio:this.frequencyAudio,pitchSemitones:this.pitchSemitones}}isAudioWorkletEnabled(){return this.configService?this.configService.isSoundtouchAudioWorkletEnabled():bi.ENABLE_SOUNDTOUCH_AUDIO_WORKLET}getCurrentRenderingMode(){const e=this.speedAudio==bi.SOUNDTOUCH_DEFAULT_SPEED&&this.frequencyAudio==bi.SOUNDTOUCH_DEFAULT_FREQUENCY&&this.pitchSemitones==bi.SOUNDTOUCH_DEFAULT_PITCH_SEMITONES;return!this.isOfflineMode||this.isEnabled()&&!e?this.isAudioWorkletAvailable()?{isWorklet:!0,renderWithSoundtouch:!0}:{isWorklet:!1,renderWithSoundtouch:!0}:{isWorklet:!1,renderWithSoundtouch:!1}}updateState(){const{isWorklet:e,renderWithSoundtouch:t}=this.getCurrentRenderingMode();this.currentSpeedAudio=1;let i=1,r=1,n=0;t&&this.isEnabled()&&(r=this.speedAudio,n=this.pitchSemitones,i=e?this.frequencyAudio*(1/this.speedAudio):this.frequencyAudio,this.currentSpeedAudio=this.speedAudio),e?(this.setWorkletSetting("pitch",i),this.setWorkletSetting("pitchSemitones",n),this.currentBufferSource&&(this.currentBufferSource.playbackRate.value=r)):this.currentPitchShifter&&(this.currentPitchShifter.pitch=i*Math.pow(2,n/12),this.currentPitchShifter.tempo=r)}setSetting(e,t){if(!fi.isSettingValueValid(t))return Promise.resolve();const i=parseFloat(t);switch(e){case"speedAudio":this.speedAudio=i;break;case"frequencyAudio":this.frequencyAudio=i;break;case"pitchSemitones":this.pitchSemitones=i}return this.updateState(),Promise.resolve()}setEnabled(e){super.setEnabled(e),this.updateState()}getSpeed(){return this.currentSpeedAudio}}class Br extends Bi{getNode(e){const t=e.createBiquadFilter();t.type="lowpass",t.frequency.value=2e3;const i=e.createBiquadFilter();i.type="lowpass",i.frequency.value=2e3;const r=e.createBiquadFilter();r.type="highpass",r.frequency.value=500;const n=e.createBiquadFilter();return n.type="highpass",n.frequency.value=500,t.connect(i),i.connect(r),r.connect(n),{input:t,output:n}}get order(){return 7}get id(){return bi.FILTERS_NAMES.TELEPHONIZER}getSettings(){return{}}setSetting(e,t){return r(this,void 0,void 0,function*(){})}}class Pr{constructor(e,t,i){this.FILTER_QUALITY=6,this.FOURIER_SIZE=4096,this.WAVETABLEBOOST=40,this.SAWTOOTHBOOST=.4,this.oscillatorType=4,this.oscillatorDetuneValue=0,this.audioContext=null,this.carrierBuffer=null,this.modulatorNode=null,this.vocoding=!1,this.modulatorInput=null,this.carrierInput=null,this.modulatorGain=null,this.modulatorGainValue=1,this.noiseBuffer=null,this.noiseNode=null,this.noiseGain=null,this.noiseGainValue=.2,this.carrierSampleNode=null,this.carrierSampleGain=null,this.carrierSampleGainValue=0,this.oscillatorNode=null,this.oscillatorGain=null,this.oscillatorGainValue=1,this.wavetable=null,this.wavetableSignalGain=null,this.modFilterBands=null,this.modFilterPostGains=null,this.heterodynes=null,this.powers=null,this.lpFilters=null,this.lpFilterPostGains=null,this.carrierBands=null,this.carrierFilterPostGains=null,this.carrierBandGains=null,this.vocoderBands=null,this.numVocoderBands=0,this.hpFilterGain=null,this.outputGain=null,this.audioContext=e,this.carrierBuffer=t,this.modulatorBuffer=i}init(){this.generateVocoderBands(55,7040,28),this.setupVocoderGraph(),this.vocode()}getNodes(){return{modulatorNode:this.modulatorNode,modulatorGain:this.modulatorGain,synthLevel:this.oscillatorGain,noiseNode:this.noiseGain,oscillatorNode:this.oscillatorNode,hpFilterGain:this.hpFilterGain,outputGain:this.outputGain}}shutOffCarrier(){this.oscillatorNode&&this.noiseNode&&this.carrierSampleNode&&(this.oscillatorNode.stop(0),this.oscillatorNode=null,this.noiseNode.stop(0),this.noiseNode=null,this.carrierSampleNode.stop(0),this.carrierSampleNode=null)}selectSawtooth(){this.wavetableSignalGain&&(this.wavetableSignalGain.gain.value=this.SAWTOOTHBOOST),this.oscillatorNode&&(this.oscillatorNode.type="sawtooth")}selectWavetable(){this.wavetableSignalGain&&(this.wavetableSignalGain.gain.value=this.WAVETABLEBOOST),this.oscillatorNode&&this.wavetable&&this.oscillatorNode.setPeriodicWave(this.wavetable),this.wavetableSignalGain&&(this.wavetableSignalGain.gain.value=this.WAVETABLEBOOST)}updateModGain(e){this.modulatorGainValue=e,this.modulatorGain&&(this.modulatorGain.gain.value=e)}updateSampleLevel(e){this.carrierSampleGainValue=e,this.carrierSampleGain&&(this.carrierSampleGain.gain.value=e)}updateSynthLevel(e){this.oscillatorGainValue=e,this.oscillatorGain&&(this.oscillatorGain.gain.value=e)}updateNoiseLevel(e){this.noiseGainValue=e,this.noiseGain&&(this.noiseGain.gain.value=e)}updateDetuneValue(e){this.oscillatorDetuneValue=e,this.oscillatorNode&&(this.oscillatorNode.detune.value=e)}generateVocoderBands(e,t,i){const r=1200*Math.log(t/e)/Math.LN2/i,n=Math.pow(2,r/1200);this.vocoderBands=[];let s=e;for(let e=0;e<i;e++)this.vocoderBands[e]={frequency:s},s*=n;this.numVocoderBands=i}loadNoiseBuffer(){if(!this.audioContext)return;const e=5*this.audioContext.sampleRate;this.noiseBuffer=this.audioContext.createBuffer(1,e,this.audioContext.sampleRate);const t=this.noiseBuffer.getChannelData(0);for(let i=0;i<e;++i)t[i]=2*Math.random()-1}initBandpassFilters(){if(!this.audioContext)return;this.modulatorInput=this.audioContext.createGain(),this.carrierInput=this.audioContext.createGain(),null==this.modFilterBands&&(this.modFilterBands=[]),null==this.modFilterPostGains&&(this.modFilterPostGains=[]),null==this.heterodynes&&(this.heterodynes=[]),null==this.powers&&(this.powers=[]),null==this.lpFilters&&(this.lpFilters=[]),null==this.lpFilterPostGains&&(this.lpFilterPostGains=[]),null==this.carrierBands&&(this.carrierBands=[]),null==this.carrierFilterPostGains&&(this.carrierFilterPostGains=[]),null==this.carrierBandGains&&(this.carrierBandGains=[]);const e=new Float32Array(65536),t=32768;let i;for(let r=0;r<t;++r)i=r/t,e[t+r]=i,e[t-r-1]=i;const r=this.audioContext.createBiquadFilter();r.type="highpass",r.frequency.value=8e3,r.Q.value=1,this.modulatorInput.connect(r),this.hpFilterGain=this.audioContext.createGain(),this.hpFilterGain.gain.value=0,r.connect(this.hpFilterGain),this.modulatorBuffer&&this.hpFilterGain.connect(this.audioContext.destination),this.modFilterBands.length=0,this.modFilterPostGains.length=0,this.heterodynes.length=0,this.powers.length=0,this.lpFilters.length=0,this.lpFilterPostGains.length=0,this.carrierBands.length=0,this.carrierFilterPostGains.length=0,this.carrierBandGains.length=0,this.outputGain=this.audioContext.createGain(),this.modulatorBuffer&&this.outputGain.connect(this.audioContext.destination);const n=new Float32Array(65536);for(let e=-32768;e<32768;e++)n[e+32768]=(e>0?e:-e)/32768;for(let t=0;t<this.numVocoderBands;t++){const i=this.audioContext.createBiquadFilter();i.type="bandpass",this.vocoderBands&&(i.frequency.value=this.vocoderBands[t].frequency),i.Q.value=this.FILTER_QUALITY,this.modulatorInput.connect(i),this.modFilterBands.push(i);const r=this.audioContext.createBiquadFilter();r.type="bandpass",this.vocoderBands&&(r.frequency.value=this.vocoderBands[t].frequency),r.Q.value=this.FILTER_QUALITY,i.connect(r);const s=this.audioContext.createGain();s.gain.value=6,r.connect(s),this.modFilterPostGains.push(s);const o=this.audioContext.createOscillator();this.vocoderBands&&(o.frequency.value=this.vocoderBands[t].frequency),o.start(0);const a=this.audioContext.createGain();s.connect(a),a.gain.value=0,o.connect(a.gain);const c=this.audioContext.createGain();c.gain.value=2,a.connect(c),this.heterodynes.push(c);const u=this.audioContext.createWaveShaper();u.curve=n,c.connect(u);const h=this.audioContext.createBiquadFilter();h.type="lowpass",h.frequency.value=5,h.Q.value=1,this.lpFilters.push(h),u.connect(h);const l=this.audioContext.createGain();l.gain.value=1,h.connect(l),this.lpFilterPostGains.push(l);const d=this.audioContext.createWaveShaper();d.curve=e,l.connect(d);const f=this.audioContext.createBiquadFilter();f.type="bandpass",this.vocoderBands&&(f.frequency.value=this.vocoderBands[t].frequency),f.Q.value=this.FILTER_QUALITY,this.carrierBands.push(f),this.carrierInput.connect(f);const p=this.audioContext.createBiquadFilter();p.type="bandpass",this.vocoderBands&&(p.frequency.value=this.vocoderBands[t].frequency),p.Q.value=this.FILTER_QUALITY,f.connect(p);const v=this.audioContext.createGain();v.gain.value=10,p.connect(v),this.carrierFilterPostGains.push(v);const g=this.audioContext.createGain();this.carrierBandGains.push(g),v.connect(g),g.gain.value=0,d.connect(g.gain),g.connect(this.outputGain)}const s=new Float32Array(this.FOURIER_SIZE),o=new Float32Array(this.FOURIER_SIZE);s[0]=0,o[0]=0;for(let e=1;e<this.FOURIER_SIZE;e++)s[e]=1,o[e]=1;this.wavetable=this.audioContext.createPeriodicWave(s,o),this.loadNoiseBuffer()}setupVocoderGraph(){this.initBandpassFilters()}createCarriersAndPlay(e){this.audioContext&&e&&(this.carrierSampleNode=this.audioContext.createBufferSource(),this.carrierSampleNode.buffer=this.carrierBuffer,this.carrierSampleNode.loop=!0,this.carrierSampleGain=this.audioContext.createGain(),this.carrierSampleGain.gain.value=this.carrierSampleGainValue,this.carrierSampleNode.connect(this.carrierSampleGain),this.carrierSampleGain.connect(e),this.wavetableSignalGain=this.audioContext.createGain(),this.oscillatorNode=this.audioContext.createOscillator(),4==this.oscillatorType&&this.wavetable?(this.oscillatorNode.setPeriodicWave(this.wavetable),this.wavetableSignalGain.gain.value=this.WAVETABLEBOOST):this.wavetableSignalGain.gain.value=this.SAWTOOTHBOOST,this.oscillatorNode.frequency.value=110,this.oscillatorNode.detune.value=this.oscillatorDetuneValue,this.oscillatorNode.connect(this.wavetableSignalGain),this.oscillatorGain=this.audioContext.createGain(),this.oscillatorGain.gain.value=this.oscillatorGainValue,this.wavetableSignalGain.connect(this.oscillatorGain),this.oscillatorGain.connect(e),this.noiseNode=this.audioContext.createBufferSource(),this.noiseNode.buffer=this.noiseBuffer,this.noiseNode.loop=!0,this.noiseGain=this.audioContext.createGain(),this.noiseGain.gain.value=this.noiseGainValue,this.noiseNode.connect(this.noiseGain),this.noiseGain.connect(e),this.oscillatorNode.start(0),this.noiseNode.start(0),this.carrierSampleNode.start(0))}vocode(){if(this.audioContext){if(this.vocoding)return this.modulatorNode&&this.modulatorNode.stop(0),this.shutOffCarrier(),void(this.vocoding=!1);this.createCarriersAndPlay(this.carrierInput),this.vocoding=!0,this.modulatorGain=this.audioContext.createGain(),this.modulatorGain.gain.value=this.modulatorGainValue,this.modulatorBuffer&&(this.modulatorNode=this.audioContext.createBufferSource(),this.modulatorNode.buffer=this.modulatorBuffer,this.modulatorNode.connect(this.modulatorGain),this.modulatorNode.start(0)),this.modulatorInput&&this.modulatorGain.connect(this.modulatorInput)}}}class Nr extends Bi{constructor(){super(...arguments),this.currentVocoder=null,this.modulatorGainValue=1,this.carrierSampleGainValue=0,this.oscillatorGainValue=1,this.noiseGainValue=.2,this.oscillatorDetuneValue=0}getNode(e){var t;const i=null===(t=this.bufferFetcherService)||void 0===t?void 0:t.getAudioBuffer(bi.VOCODER_MODULATOR);this.currentVocoder=new Pr(e,i),this.currentVocoder.init(),this.applyCurrentSettingsToVocoder();const{modulatorGain:r,outputGain:n}=this.currentVocoder.getNodes();return{input:r,output:n}}getSettings(){return{modulatorGainValue:this.modulatorGainValue,carrierSampleGainValue:this.carrierSampleGainValue,oscillatorGainValue:this.oscillatorGainValue,noiseGainValue:this.noiseGainValue,oscillatorDetuneValue:this.oscillatorDetuneValue}}setSetting(e,t){if(!fi.isSettingValueValid(t))return Promise.resolve();switch(e){case"modulatorGainValue":this.modulatorGainValue=parseFloat(t);break;case"carrierSampleGainValue":this.carrierSampleGainValue=parseFloat(t);break;case"oscillatorGainValue":this.oscillatorGainValue=parseFloat(t);break;case"noiseGainValue":this.noiseGainValue=parseFloat(t);break;case"oscillatorDetuneValue":this.oscillatorDetuneValue=parseFloat(t)}return this.applyCurrentSettingsToVocoder(),Promise.resolve()}applyCurrentSettingsToVocoder(){this.currentVocoder&&(this.currentVocoder.updateModGain(this.modulatorGainValue),this.currentVocoder.updateSampleLevel(this.carrierSampleGainValue),this.currentVocoder.updateSynthLevel(this.oscillatorGainValue),this.currentVocoder.updateNoiseLevel(this.noiseGainValue),this.currentVocoder.updateDetuneValue(this.oscillatorDetuneValue))}get order(){return 1}get id(){return bi.FILTERS_NAMES.VOCODER}}class Mr extends AudioWorkletProcessor{constructor(){super(),this.stopped=!1,this.disabled=!1,this.samplesCount=0,this.port.onmessage=e=>{switch(e.data){case"stop":this.stop();break;case"disable":this.disabled=!0;break;case"enable":this.disabled=!1}}}static get parameterDescriptors(){return[]}get defaultParameterDescriptors(){return Mr.parameterDescriptors}process(e,t){if(this.stopped||this.disabled)return!1;const i=e[0],r=t[0];if(i&&i[0]&&(this.samplesCount+=i[0].length),r){for(let e=0;e<r.length;e++){const t=i[e],n=r[e];if(t)for(let e=0;e<t.length;e++)n[e]=t[e]}this.port.postMessage({command:"update",samplesCount:this.samplesCount})}return!0}stop(){this.stopped=!0}}registerProcessor(bi.WORKLET_NAMES.RENDERING_PROGRESS_CALCULATION,Mr);class Or extends Di{constructor(){super(...arguments),this.currentTime=0,this.lastSampleCount=0,this.samplePerSecond=0,this.currentTimeSamplesPerSecond=0}receiveEvent(e){const t=performance.now(),i=e.data.samplesCount;"update"===e.data.command&&this.calculatePercentageProcessed(t,i),this.calculateRemainingTimeProcessing(t,i)}calculatePercentageProcessed(e,t){0===this.currentTime&&(this.currentTime=e);const i=e-this.currentTime,r=t/this._totalSamples*100;this.eventEmitter&&i>=bi.TREATMENT_TIME_COUNTING_THROTTLE_INTERVAL&&(this.eventEmitter.emit(exports.EventType.UPDATE_AUDIO_TREATMENT_PERCENT,r),this.currentTime=e),r>=100&&this.stop()}calculateRemainingTimeProcessing(e,t){0===this.currentTimeSamplesPerSecond&&(this.currentTimeSamplesPerSecond=e);const i=e-this.currentTimeSamplesPerSecond,r=this._totalSamples-t;if(this.eventEmitter&&r<=0)this.eventEmitter.emit(exports.EventType.UPDATE_REMAINING_TIME_ESTIMATED,0);else if(this.eventEmitter&&i>=1e3){this.calculateSmoothedSamplePerSecond(i,t);const n=r/this.samplePerSecond;this.currentTimeSamplesPerSecond=e,this.lastSampleCount=t,isNaN(n)||!isFinite(n)?this.eventEmitter.emit(exports.EventType.UPDATE_REMAINING_TIME_ESTIMATED,-1):this.eventEmitter.emit(exports.EventType.UPDATE_REMAINING_TIME_ESTIMATED,n)}}calculateSmoothedSamplePerSecond(e,t){if(e>0){const i=(t-this.lastSampleCount)/(e/1e3);this.samplePerSecond=bi.TREATMENT_TIME_COUNTING_SMOOTHING_FACTOR*i+(1-bi.TREATMENT_TIME_COUNTING_SMOOTHING_FACTOR)*this.samplePerSecond}}get workletName(){return bi.WORKLET_NAMES.RENDERING_PROGRESS_CALCULATION}get workletPath(){return bi.WORKLET_PATHS.RENDERING_PROGRESS_CALCULATION}get order(){return 10}get id(){return bi.FILTERS_NAMES.RENDERING_PROGRESS_CALCULATION}set totalSamples(e){super.totalSamples=e,this.currentTime=0,this.currentTimeSamplesPerSecond=0,this.samplePerSecond=0,this.lastSampleCount=0}getSettings(){return{}}setSetting(e,t){return r(this,void 0,void 0,function*(){})}}class Dr{static createNewInstance(e){try{const t=function(){const e=new ui({defaultScope:"Singleton"});return e.bind(hi.EntryPointFilter).to(Tr),e.bind(hi.Renderers).to(ir),e.bind(hi.Filters).toDynamicValue(()=>e.get(hi.EntryPointFilter)),e.bind(hi.Filters).to(rr),e.bind(hi.Filters).to(sr),e.bind(hi.Filters).to(or),e.bind(hi.Filters).to(ar),e.bind(hi.Filters).to(hr),e.bind(hi.Filters).to(lr),e.bind(hi.Filters).to(dr),e.bind(hi.Filters).to(Br),e.bind(hi.Filters).to(Nr),e.bind(hi.Filters).to(Or),e.bind(hi.EventEmitter).to(ki),e.bind(hi.AudioContextManager).to(Wi),e.bind(hi.AudioEditor).to(gi),e.bind(hi.AudioProcessor).to(ji),e.bind(hi.BufferManager).to(Hi),e.bind(hi.FilterManager).to($i),e.bind(hi.RendererManager).to(Yi),e.bind(hi.SaveBufferManager).to(Qi),e.bind(hi.BufferPlayer).to(Ei),e.bind(hi.BufferFetcherService).to(Ji),e.bind(hi.BufferDecoderService).to(tr),e.bind(hi.VoiceRecorder).to(wi),e}();return e&&e.configService?t.bind(hi.ConfigService).toDynamicValue(()=>e.configService):(t.bind(hi.ConfigService).to(Ui),console.warn("No ConfigService provided. Using default generic implementation.")),t.bind(hi.AudioBuffersToFetch).toConstantValue(e&&e.buffersToFetch||[]),{audioEditor:t.get(hi.AudioEditor),audioPlayer:t.get(hi.BufferPlayer),configService:t.get(hi.ConfigService),eventEmitter:t.get(hi.EventEmitter),voiceRecorder:t.get(hi.VoiceRecorder)}}catch(e){throw console.error("Error when creating new Sound Studio instance\n",e),new Error("Error when creating new Sound Studio instance")}}static createAudioEditor(e,t){if(console.warn("[DEPRECATED] SoundStudioFactory.createAudioEditor is deprecated and will be removed in a future release of simple-sound-studio-lib. Please use SoundStudioFactory.createNewInstance instead, which doesn't work as a singleton."),!Dr.ready){const i=Dr.createNewInstance({configService:e,buffersToFetch:t});Dr.audioEditor=i.audioEditor,Dr.audioPlayer=i.audioPlayer,Dr.configService=i.configService,Dr.eventEmitter=i.eventEmitter,Dr.voiceRecorder=i.voiceRecorder,Dr.ready=!0}return Dr.audioEditor}static createVoiceRecorder(){return console.warn("[DEPRECATED] SoundStudioFactory.createVoiceRecorder is deprecated and will be removed in a future release of simple-sound-studio-lib. Please use SoundStudioFactory.createNewInstance instead, which doesn't work as a singleton."),Dr.voiceRecorder}static getAudioEditorInstance(){return console.warn("[DEPRECATED] SoundStudioFactory.getAudioEditorInstance is deprecated and will be removed in a future release of simple-sound-studio-lib. Please use SoundStudioFactory.createNewInstance instead, which doesn't work as a singleton."),Dr.audioEditor}static getAudioPlayerInstance(){return console.warn("[DEPRECATED] SoundStudioFactory.getAudioPlayerInstance is deprecated and will be removed in a future release of simple-sound-studio-lib. Please use SoundStudioFactory.createNewInstance instead, which doesn't work as a singleton."),Dr.audioPlayer}static getAudioRecorderInstance(){return console.warn("[DEPRECATED] SoundStudioFactory.getAudioRecorderInstance is deprecated and will be removed in a future release of simple-sound-studio-lib. Please use SoundStudioFactory.createNewInstance instead, which doesn't work as a singleton."),Dr.voiceRecorder}static getEventEmitterInstance(){return console.warn("[DEPRECATED] SoundStudioFactory.getEventEmitterInstance is deprecated and will be removed in a future release of simple-sound-studio-lib. Please use SoundStudioFactory.createNewInstance instead, which doesn't work as a singleton."),Dr.eventEmitter}static getConfigServiceInstance(){return console.warn("[DEPRECATED] SoundStudioFactory.getConfigServiceInstance is deprecated and will be removed in a future release of simple-sound-studio-lib. Please use SoundStudioFactory.createNewInstance instead, which doesn't work as a singleton."),Dr.configService}}Dr.ready=!1,Dr.audioEditor=null,Dr.audioPlayer=null,Dr.configService=null,Dr.eventEmitter=null,Dr.voiceRecorder=null,exports.AbstractAudioElement=di,exports.AbstractAudioFilter=Bi,exports.AbstractAudioFilterWorklet=Di,exports.AbstractAudioNode=Ti,exports.AbstractAudioRenderer=Fi,exports.AudioEditor=gi,exports.BufferPlayer=Ei,exports.Constants=bi,exports.EventEmitter=ki,exports.FilterNames=Si,exports.GenericConfigService=Ui,exports.SoundStudioFactory=Dr,exports.UtilFunctions=fi,exports.VoiceRecorder=wi;
//# sourceMappingURL=SimpleSoundStudioLibrary.js.map
