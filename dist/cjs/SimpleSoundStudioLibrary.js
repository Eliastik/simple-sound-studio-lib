"use strict";function e(e,t,i,r){var n,s=arguments.length,o=s<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,r);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(o=(s<3?n(o):s>3?n(t,i,o):n(t,i))||o);return s>3&&o&&Object.defineProperty(t,i,o),o}function t(e,t){return function(i,r){t(i,r,e)}}function i(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function r(e,t,i,r){return new(i||(i=Promise))((function(n,s){function o(e){try{u(r.next(e))}catch(e){s(e)}}function a(e){try{u(r.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((r=r.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;var n,s="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},o={};!function(){return n||(n=1,function(e){!function(){var t="object"==typeof globalThis?globalThis:"object"==typeof s?s:"object"==typeof self?self:"object"==typeof this?this:function(){try{return Function("return this;")()}catch(e){}}()||function(){try{return(0,eval)("(function() { return this; })()")}catch(e){}}(),i=r(e);function r(e,t){return function(i,r){Object.defineProperty(e,i,{configurable:!0,writable:!0,value:r}),t&&t(i,r)}}void 0!==t.Reflect&&(i=r(t.Reflect,i)),function(e,t){var i=Object.prototype.hasOwnProperty,r="function"==typeof Symbol,n=r&&void 0!==Symbol.toPrimitive?Symbol.toPrimitive:"@@toPrimitive",s=r&&void 0!==Symbol.iterator?Symbol.iterator:"@@iterator",o="function"==typeof Object.create,a={__proto__:[]}instanceof Array,u=!o&&!a,c={create:o?function(){return le(Object.create(null))}:a?function(){return le({__proto__:null})}:function(){return le({})},has:u?function(e,t){return i.call(e,t)}:function(e,t){return t in e},get:u?function(e,t){return i.call(e,t)?e[t]:void 0}:function(e,t){return e[t]}},h=Object.getPrototypeOf(Function),l="function"==typeof Map&&"function"==typeof Map.prototype.entries?Map:ue(),d="function"==typeof Set&&"function"==typeof Set.prototype.entries?Set:ce(),f="function"==typeof WeakMap?WeakMap:he(),p=r?Symbol.for("@reflect-metadata:registry"):void 0,g=ne(),m=se(g);function v(e,t,i,r){if(k(i)){if(!K(e))throw new TypeError;if(!$(t))throw new TypeError;return C(e,t)}if(!K(e))throw new TypeError;if(!U(t))throw new TypeError;if(!U(r)&&!k(r)&&!L(r))throw new TypeError;return L(r)&&(r=void 0),I(e,t,i=H(i),r)}function y(e,t){function i(i,r){if(!U(i))throw new TypeError;if(!k(r)&&!z(r))throw new TypeError;B(e,t,i,r)}return i}function E(e,t,i,r){if(!U(i))throw new TypeError;return k(r)||(r=H(r)),B(e,t,i,r)}function _(e,t,i){if(!U(t))throw new TypeError;return k(i)||(i=H(i)),N(e,t,i)}function A(e,t,i){if(!U(t))throw new TypeError;return k(i)||(i=H(i)),M(e,t,i)}function b(e,t,i){if(!U(t))throw new TypeError;return k(i)||(i=H(i)),P(e,t,i)}function S(e,t,i){if(!U(t))throw new TypeError;return k(i)||(i=H(i)),D(e,t,i)}function w(e,t){if(!U(e))throw new TypeError;return k(t)||(t=H(t)),O(e,t)}function R(e,t){if(!U(e))throw new TypeError;return k(t)||(t=H(t)),F(e,t)}function T(e,t,i){if(!U(t))throw new TypeError;if(k(i)||(i=H(i)),!U(t))throw new TypeError;k(i)||(i=H(i));var r=ae(t,i,!1);return!k(r)&&r.OrdinaryDeleteMetadata(e,t,i)}function C(e,t){for(var i=e.length-1;i>=0;--i){var r=(0,e[i])(t);if(!k(r)&&!L(r)){if(!$(r))throw new TypeError;t=r}}return t}function I(e,t,i,r){for(var n=e.length-1;n>=0;--n){var s=(0,e[n])(t,i,r);if(!k(s)&&!L(s)){if(!U(s))throw new TypeError;r=s}}return r}function N(e,t,i){if(M(e,t,i))return!0;var r=ie(t);return!L(r)&&N(e,r,i)}function M(e,t,i){var r=ae(t,i,!1);return!k(r)&&j(r.OrdinaryHasOwnMetadata(e,t,i))}function P(e,t,i){if(M(e,t,i))return D(e,t,i);var r=ie(t);return L(r)?void 0:P(e,r,i)}function D(e,t,i){var r=ae(t,i,!1);if(!k(r))return r.OrdinaryGetOwnMetadata(e,t,i)}function B(e,t,i,r){ae(i,r,!0).OrdinaryDefineOwnMetadata(e,t,i,r)}function O(e,t){var i=F(e,t),r=ie(e);if(null===r)return i;var n=O(r,t);if(n.length<=0)return i;if(i.length<=0)return n;for(var s=new d,o=[],a=0,u=i;a<u.length;a++){var c=u[a];s.has(c)||(s.add(c),o.push(c))}for(var h=0,l=n;h<l.length;h++){c=l[h];s.has(c)||(s.add(c),o.push(c))}return o}function F(e,t){var i=ae(e,t,!1);return i?i.OrdinaryOwnMetadataKeys(e,t):[]}function x(e){if(null===e)return 1;switch(typeof e){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return null===e?1:6;default:return 6}}function k(e){return void 0===e}function L(e){return null===e}function G(e){return"symbol"==typeof e}function U(e){return"object"==typeof e?null!==e:"function"==typeof e}function W(e,t){switch(x(e)){case 0:case 1:case 2:case 3:case 4:case 5:return e}var i="string",r=X(e,n);if(void 0!==r){var s=r.call(e,i);if(U(s))throw new TypeError;return s}return V(e)}function V(e,t){var i,r,n=e.toString;if(Y(n)&&!U(r=n.call(e)))return r;if(Y(i=e.valueOf)&&!U(r=i.call(e)))return r;throw new TypeError}function j(e){return!!e}function q(e){return""+e}function H(e){var t=W(e);return G(t)?t:q(t)}function K(e){return Array.isArray?Array.isArray(e):e instanceof Object?e instanceof Array:"[object Array]"===Object.prototype.toString.call(e)}function Y(e){return"function"==typeof e}function $(e){return"function"==typeof e}function z(e){switch(x(e)){case 3:case 4:return!0;default:return!1}}function Q(e,t){return e===t||e!=e&&t!=t}function X(e,t){var i=e[t];if(null!=i){if(!Y(i))throw new TypeError;return i}}function Z(e){var t=X(e,s);if(!Y(t))throw new TypeError;var i=t.call(e);if(!U(i))throw new TypeError;return i}function J(e){return e.value}function ee(e){var t=e.next();return!t.done&&t}function te(e){var t=e.return;t&&t.call(e)}function ie(e){var t=Object.getPrototypeOf(e);if("function"!=typeof e||e===h)return t;if(t!==h)return t;var i=e.prototype,r=i&&Object.getPrototypeOf(i);if(null==r||r===Object.prototype)return t;var n=r.constructor;return"function"!=typeof n||n===e?t:n}function re(){var e,i,r,n;k(p)||void 0===t.Reflect||p in t.Reflect||"function"!=typeof t.Reflect.defineMetadata||(e=oe(t.Reflect));var s=new f,o={registerProvider:a,getProvider:c,setProvider:g};return o;function a(t){if(!Object.isExtensible(o))throw new Error("Cannot add provider to a frozen registry.");switch(!0){case e===t:break;case k(i):i=t;break;case i===t:break;case k(r):r=t;break;case r===t:break;default:void 0===n&&(n=new d),n.add(t)}}function u(t,s){if(!k(i)){if(i.isProviderFor(t,s))return i;if(!k(r)){if(r.isProviderFor(t,s))return i;if(!k(n))for(var o=Z(n);;){var a=ee(o);if(!a)return;var u=J(a);if(u.isProviderFor(t,s))return te(o),u}}}if(!k(e)&&e.isProviderFor(t,s))return e}function c(e,t){var i,r=s.get(e);return k(r)||(i=r.get(t)),k(i)?(k(i=u(e,t))||(k(r)&&(r=new l,s.set(e,r)),r.set(t,i)),i):i}function h(e){if(k(e))throw new TypeError;return i===e||r===e||!k(n)&&n.has(e)}function g(e,t,i){if(!h(i))throw new Error("Metadata provider not registered.");var r=c(e,t);if(r!==i){if(!k(r))return!1;var n=s.get(e);k(n)&&(n=new l,s.set(e,n)),n.set(t,i)}return!0}}function ne(){var e;return!k(p)&&U(t.Reflect)&&Object.isExtensible(t.Reflect)&&(e=t.Reflect[p]),k(e)&&(e=re()),!k(p)&&U(t.Reflect)&&Object.isExtensible(t.Reflect)&&Object.defineProperty(t.Reflect,p,{enumerable:!1,configurable:!1,writable:!1,value:e}),e}function se(e){var t=new f,i={isProviderFor:function(e,i){var r=t.get(e);return!k(r)&&r.has(i)},OrdinaryDefineOwnMetadata:o,OrdinaryHasOwnMetadata:n,OrdinaryGetOwnMetadata:s,OrdinaryOwnMetadataKeys:a,OrdinaryDeleteMetadata:u};return g.registerProvider(i),i;function r(r,n,s){var o=t.get(r),a=!1;if(k(o)){if(!s)return;o=new l,t.set(r,o),a=!0}var u=o.get(n);if(k(u)){if(!s)return;if(u=new l,o.set(n,u),!e.setProvider(r,n,i))throw o.delete(n),a&&t.delete(r),new Error("Wrong provider for target.")}return u}function n(e,t,i){var n=r(t,i,!1);return!k(n)&&j(n.has(e))}function s(e,t,i){var n=r(t,i,!1);if(!k(n))return n.get(e)}function o(e,t,i,n){r(i,n,!0).set(e,t)}function a(e,t){var i=[],n=r(e,t,!1);if(k(n))return i;for(var s=Z(n.keys()),o=0;;){var a=ee(s);if(!a)return i.length=o,i;var u=J(a);try{i[o]=u}catch(e){try{te(s)}finally{throw e}}o++}}function u(e,i,n){var s=r(i,n,!1);if(k(s))return!1;if(!s.delete(e))return!1;if(0===s.size){var o=t.get(i);k(o)||(o.delete(n),0===o.size&&t.delete(o))}return!0}}function oe(e){var t=e.defineMetadata,i=e.hasOwnMetadata,r=e.getOwnMetadata,n=e.getOwnMetadataKeys,s=e.deleteMetadata,o=new f,a={isProviderFor:function(e,t){var i=o.get(e);return!(k(i)||!i.has(t))||!!n(e,t).length&&(k(i)&&(i=new d,o.set(e,i)),i.add(t),!0)},OrdinaryDefineOwnMetadata:t,OrdinaryHasOwnMetadata:i,OrdinaryGetOwnMetadata:r,OrdinaryOwnMetadataKeys:n,OrdinaryDeleteMetadata:s};return a}function ae(e,t,i){var r=g.getProvider(e,t);if(!k(r))return r;if(i){if(g.setProvider(e,t,m))return m;throw new Error("Illegal state.")}}function ue(){var e={},t=[],i=function(){function e(e,t,i){this._index=0,this._keys=e,this._values=t,this._selector=i}return e.prototype["@@iterator"]=function(){return this},e.prototype[s]=function(){return this},e.prototype.next=function(){var e=this._index;if(e>=0&&e<this._keys.length){var i=this._selector(this._keys[e],this._values[e]);return e+1>=this._keys.length?(this._index=-1,this._keys=t,this._values=t):this._index++,{value:i,done:!1}}return{value:void 0,done:!0}},e.prototype.throw=function(e){throw this._index>=0&&(this._index=-1,this._keys=t,this._values=t),e},e.prototype.return=function(e){return this._index>=0&&(this._index=-1,this._keys=t,this._values=t),{value:e,done:!0}},e}(),r=function(){function t(){this._keys=[],this._values=[],this._cacheKey=e,this._cacheIndex=-2}return Object.defineProperty(t.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),t.prototype.has=function(e){return this._find(e,!1)>=0},t.prototype.get=function(e){var t=this._find(e,!1);return t>=0?this._values[t]:void 0},t.prototype.set=function(e,t){var i=this._find(e,!0);return this._values[i]=t,this},t.prototype.delete=function(t){var i=this._find(t,!1);if(i>=0){for(var r=this._keys.length,n=i+1;n<r;n++)this._keys[n-1]=this._keys[n],this._values[n-1]=this._values[n];return this._keys.length--,this._values.length--,Q(t,this._cacheKey)&&(this._cacheKey=e,this._cacheIndex=-2),!0}return!1},t.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=e,this._cacheIndex=-2},t.prototype.keys=function(){return new i(this._keys,this._values,n)},t.prototype.values=function(){return new i(this._keys,this._values,o)},t.prototype.entries=function(){return new i(this._keys,this._values,a)},t.prototype["@@iterator"]=function(){return this.entries()},t.prototype[s]=function(){return this.entries()},t.prototype._find=function(e,t){if(!Q(this._cacheKey,e)){this._cacheIndex=-1;for(var i=0;i<this._keys.length;i++)if(Q(this._keys[i],e)){this._cacheIndex=i;break}}return this._cacheIndex<0&&t&&(this._cacheIndex=this._keys.length,this._keys.push(e),this._values.push(void 0)),this._cacheIndex},t}();return r;function n(e,t){return e}function o(e,t){return t}function a(e,t){return[e,t]}}function ce(){return function(){function e(){this._map=new l}return Object.defineProperty(e.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),e.prototype.has=function(e){return this._map.has(e)},e.prototype.add=function(e){return this._map.set(e,e),this},e.prototype.delete=function(e){return this._map.delete(e)},e.prototype.clear=function(){this._map.clear()},e.prototype.keys=function(){return this._map.keys()},e.prototype.values=function(){return this._map.keys()},e.prototype.entries=function(){return this._map.entries()},e.prototype["@@iterator"]=function(){return this.keys()},e.prototype[s]=function(){return this.keys()},e}()}function he(){var e=16,t=c.create(),r=n();return function(){function e(){this._key=n()}return e.prototype.has=function(e){var t=s(e,!1);return void 0!==t&&c.has(t,this._key)},e.prototype.get=function(e){var t=s(e,!1);return void 0!==t?c.get(t,this._key):void 0},e.prototype.set=function(e,t){return s(e,!0)[this._key]=t,this},e.prototype.delete=function(e){var t=s(e,!1);return void 0!==t&&delete t[this._key]},e.prototype.clear=function(){this._key=n()},e}();function n(){var e;do{e="@@WeakMap@@"+u()}while(c.has(t,e));return t[e]=!0,e}function s(e,t){if(!i.call(e,r)){if(!t)return;Object.defineProperty(e,r,{value:c.create()})}return e[r]}function o(e,t){for(var i=0;i<t;++i)e[i]=255*Math.random()|0;return e}function a(e){if("function"==typeof Uint8Array){var t=new Uint8Array(e);return"undefined"!=typeof crypto?crypto.getRandomValues(t):"undefined"!=typeof msCrypto?msCrypto.getRandomValues(t):o(t,e),t}return o(new Array(e),e)}function u(){var t=a(e);t[6]=79&t[6]|64,t[8]=191&t[8]|128;for(var i="",r=0;r<e;++r){var n=t[r];4!==r&&6!==r&&8!==r||(i+="-"),n<16&&(i+="0"),i+=n.toString(16).toLowerCase()}return i}}function le(e){return e.__=void 0,delete e.__,e}e("decorate",v),e("metadata",y),e("defineMetadata",E),e("hasMetadata",_),e("hasOwnMetadata",A),e("getMetadata",b),e("getOwnMetadata",S),e("getMetadataKeys",w),e("getOwnMetadataKeys",R),e("deleteMetadata",T)}(i,t),void 0===t.Reflect&&(t.Reflect=e)}()}(e||(e={}))),o;var e}();const a=Symbol.for("@inversifyjs/common/islazyServiceIdentifier");let u=class{[a];#e;constructor(e){this.#e=e,this[a]=!0}static is(e){return"object"==typeof e&&null!==e&&!0===e[a]}unwrap(){return this.#e()}};function c(e,t){return Reflect.getMetadata(t,e)}function h(e,t,i,r){const n=r(c(e,t)??i);Reflect.defineMetadata(t,n,e)}const l="named",d="name",f="unmanaged",p="optional",g="inject",m="multi_inject",v="post_construct",y="pre_destroy",E=[g,m,d,f,l,p],_=Symbol.for("@inversifyjs/core/InversifyCoreError");let A=class e extends Error{[_];kind;constructor(e,t,i){super(t,i),this[_]=!0,this.kind=e}static is(e){return"object"==typeof e&&null!==e&&!0===e[_]}static isErrorOfKind(t,i){return e.is(t)&&t.kind===i}};var b,S;function w(e,t){const i=[];for(let e=0;e<t.length;++e)void 0===t[e]&&i.push(e);if(i.length>0)throw new A(b.missingInjectionDecorator,`Found unexpected missing metadata on type "${e.name}" at constructor indexes "${i.join('", "')}".\n\nAre you using @inject, @multiInject or @unmanaged decorators at those indexes?\n\nIf you're using typescript and want to rely on auto injection, set "emitDecoratorMetadata" compiler option to true`)}function R(e){return{kind:S.singleInjection,name:void 0,optional:!1,tags:new Map,targetName:void 0,value:e}}function T(e){const t=e.find((e=>e.key===g)),i=e.find((e=>e.key===m));if(void 0!==e.find((e=>e.key===f)))return function(e,t){if(void 0!==t||void 0!==e)throw new A(b.missingInjectionDecorator,"Expected a single @inject, @multiInject or @unmanaged metadata");return{kind:S.unmanaged}}(t,i);if(void 0===i&&void 0===t)throw new A(b.missingInjectionDecorator,"Expected @inject, @multiInject or @unmanaged metadata");const r=e.find((e=>e.key===l)),n=e.find((e=>e.key===p)),s=e.find((e=>e.key===d));return{kind:void 0===t?S.multipleInjection:S.singleInjection,name:r?.value,optional:void 0!==n,tags:new Map(e.filter((e=>E.every((t=>e.key!==t)))).map((e=>[e.key,e.value]))),targetName:s?.value,value:void 0===t?i?.value:t.value}}function C(e,t,i){try{return T(i)}catch(i){throw A.isErrorOfKind(i,b.missingInjectionDecorator)?new A(b.missingInjectionDecorator,`Expected a single @inject, @multiInject or @unmanaged decorator at type "${e.name}" at constructor arguments at index "${t.toString()}"`,{cause:i}):i}}function I(e){const t=c(e,"design:paramtypes"),i=c(e,"inversify:tagged"),r=[];if(void 0!==i)for(const[t,n]of Object.entries(i)){const i=parseInt(t);r[i]=C(e,i,n)}if(void 0!==t)for(let e=0;e<t.length;++e)if(void 0===r[e]){const i=t[e];r[e]=R(i)}return w(e,r),r}function N(e,t,i){try{return T(i)}catch(i){throw A.isErrorOfKind(i,b.missingInjectionDecorator)?new A(b.missingInjectionDecorator,`Expected a single @inject, @multiInject or @unmanaged decorator at type "${e.name}" at property "${t.toString()}"`,{cause:i}):i}}function M(e){const t=c(e,"inversify:tagged_props"),i=new Map;if(void 0!==t)for(const r of Reflect.ownKeys(t)){const n=t[r];i.set(r,N(e,r,n))}return i}function P(e){const t=c(e,v),i=c(e,y);return{constructorArguments:I(e),lifecycle:{postConstructMethodName:t?.value,preDestroyMethodName:i?.value},properties:M(e)}}function D(e,t){const i=t.getConstructorMetadata(e),r=[];for(const[t,n]of Object.entries(i.userGeneratedMetadata)){const i=parseInt(t);r[i]=C(e,i,n)}if(void 0!==i.compilerGeneratedMetadata)for(let e=0;e<i.compilerGeneratedMetadata.length;++e)if(void 0===r[e]){const t=i.compilerGeneratedMetadata[e];r[e]=R(t)}return w(e,r),r}function B(e,t){const i=t.getPropertiesMetadata(e),r=new Map;for(const t of Reflect.ownKeys(i)){const n=i[t];r.set(t,N(e,t,n))}return r}function O(e,t){const i=c(e,v),r=c(e,y);return{constructorArguments:D(e,t),lifecycle:{postConstructMethodName:i?.value,preDestroyMethodName:r?.value},properties:B(e,t)}}function F(e){const t=Object.getPrototypeOf(e.prototype),i=t?.constructor;return i}function x(e){let t;switch(e.kind){case S.multipleInjection:t={key:m,value:e.value};break;case S.singleInjection:t={key:g,value:e.value}}return t}!function(e){e[e.injectionDecoratorConflict=0]="injectionDecoratorConflict",e[e.missingInjectionDecorator=1]="missingInjectionDecorator",e[e.planning=2]="planning",e[e.unknown=3]="unknown"}(b||(b={})),function(e){e[e.multipleInjection=0]="multipleInjection",e[e.singleInjection=1]="singleInjection",e[e.unmanaged=2]="unmanaged"}(S||(S={}));let k=class{#t;constructor(e){this.#t=e}startsWith(e){return this.#t.startsWith(e)}endsWith(e){return this.#t.endsWith(e)}contains(e){return this.#t.includes(e)}equals(e){return this.#t===e}value(){return this.#t}};const L="@inversifyjs/core/targetId";let G=class{#e;#i;#r;#n;#s;#o;constructor(e,t,i){this.#i=function(){const e=c(Object,L)??0;return e===Number.MAX_SAFE_INTEGER?h(Object,L,e,(()=>Number.MIN_SAFE_INTEGER)):h(Object,L,e,(e=>e+1)),e}(),this.#r=e,this.#n=void 0,this.#e=t,this.#s=new k("string"==typeof e?e:e.toString().slice(7,-1)),this.#o=i}get id(){return this.#i}get identifier(){return this.#r}get metadata(){return void 0===this.#n&&(this.#n=function(e){return e.kind===S.unmanaged?[{key:f,value:!0}]:function(e){const t=[x(e)];void 0!==e.name&&t.push({key:l,value:e.name}),e.optional&&t.push({key:p,value:!0});for(const[i,r]of e.tags)t.push({key:i,value:r});return void 0!==e.targetName&&t.push({key:d,value:e.targetName}),t}(e)}(this.#e)),this.#n}get name(){return this.#s}get type(){return this.#o}get serviceIdentifier(){return u.is(this.#e.value)?this.#e.value.unwrap():this.#e.value}getCustomTags(){return[...this.#e.tags.entries()].map((([e,t])=>({key:e,value:t})))}getNamedTag(){return void 0===this.#e.name?null:{key:l,value:this.#e.name}}hasTag(e){return this.metadata.some((t=>t.key===e))}isArray(){return this.#e.kind===S.multipleInjection}isNamed(){return void 0!==this.#e.name}isOptional(){return this.#e.optional}isTagged(){return this.#e.tags.size>0}matchesArray(e){return this.isArray()&&this.#e.value===e}matchesNamedTag(e){return this.#e.name===e}matchesTag(e){return t=>this.metadata.some((i=>i.key===e&&i.value===t))}};const U=e=>function(e,t){return function(i){const r=e(i);let n=F(i);for(;void 0!==n&&n!==Object;){const e=t(n);for(const[t,i]of e)r.properties.has(t)||r.properties.set(t,i);n=F(n)}const s=[];for(const e of r.constructorArguments)if(e.kind!==S.unmanaged){const t=e.targetName??"";s.push(new G(t,e,"ConstructorArgument"))}for(const[e,t]of r.properties)if(t.kind!==S.unmanaged){const i=t.targetName??e;s.push(new G(i,t,"ClassProperty"))}return s}}(void 0===e?P:t=>O(t,e),void 0===e?M:t=>B(t,e)),W="named",V="inject",j="multi_inject",q="inversify:tagged",H="inversify:tagged_props",K="inversify:paramtypes",Y="design:paramtypes",$="post_construct",z="pre_destroy",Q="Request",X="Singleton",Z="Transient",J="ConstantValue",ee="Constructor",te="DynamicValue",ie="Factory",re="Function",ne="Instance",se="Invalid",oe="Provider",ae="ConstructorArgument",ue="Variable";let ce=0;function he(){return ce++}class le{id;moduleId;activated;serviceIdentifier;implementationType;cache;dynamicValue;scope;type;factory;provider;constraint;onActivation;onDeactivation;constructor(e,t){this.id=he(),this.activated=!1,this.serviceIdentifier=e,this.scope=t,this.type=se,this.constraint=e=>!0,this.implementationType=null,this.cache=null,this.factory=null,this.provider=null,this.onActivation=null,this.onDeactivation=null,this.dynamicValue=null}clone(){const e=new le(this.serviceIdentifier,this.scope);return e.activated=e.scope===X&&this.activated,e.implementationType=this.implementationType,e.dynamicValue=this.dynamicValue,e.scope=this.scope,e.type=this.type,e.factory=this.factory,e.provider=this.provider,e.constraint=this.constraint,e.onActivation=this.onActivation,e.onDeactivation=this.onDeactivation,e.cache=this.cache,e}}const de="Metadata key was used more than once in a parameter:",fe="NULL argument",pe="Key Not Found",ge="The @inject @multiInject @tagged and @named decorators must be applied to the parameters of a class constructor or a class property.",me=(e,t)=>`onDeactivation() error in class ${e}: ${t}`;class ve{getConstructorMetadata(e){return{compilerGeneratedMetadata:Reflect.getMetadata(Y,e)??[],userGeneratedMetadata:Reflect.getMetadata(q,e)??{}}}getPropertiesMetadata(e){return Reflect.getMetadata(H,e)??{}}}var ye;function Ee(e){return e instanceof RangeError||"Maximum call stack size exceeded"===e.message}function _e(e){return"function"==typeof e?e.name:"symbol"==typeof e?e.toString():e}function Ae(e,t,i){let r="";const n=i(e,t);return 0!==n.length&&(r="\nRegistered bindings:",n.forEach((e=>{let t="Object";null!==e.implementationType&&(t=we(e.implementationType)),r=`${r}\n ${t}`,e.constraint.metaData&&(r=`${r} - ${e.constraint.metaData}`)}))),r}function be(e,t){return null!==e.parentRequest&&(e.parentRequest.serviceIdentifier===t||be(e.parentRequest,t))}function Se(e){e.childRequests.forEach((t=>{if(be(e,t.serviceIdentifier)){const e=function(e){const t=function e(t,i=[]){const r=_e(t.serviceIdentifier);return i.push(r),null!==t.parentRequest?e(t.parentRequest,i):i}(e);return t.reverse().join(" --\x3e ")}(t);throw new Error(`Circular dependency found: ${e}`)}Se(t)}))}function we(e){if(null!=e.name&&""!==e.name)return e.name;{const t=e.toString(),i=t.match(/^function\s*([^\s(]+)/);return null===i?`Anonymous function: ${t}`:i[1]}}function Re(e){return`{"key":"${e.key.toString()}","value":"${e.value.toString()}"}`}!function(e){e[e.MultipleBindingsAvailable=2]="MultipleBindingsAvailable",e[e.NoBindingsAvailable=0]="NoBindingsAvailable",e[e.OnlyOneBindingAvailable=1]="OnlyOneBindingAvailable"}(ye||(ye={}));class Te{id;container;plan;currentRequest;constructor(e){this.id=he(),this.container=e}addPlan(e){this.plan=e}setCurrentRequest(e){this.currentRequest=e}}class Ce{key;value;constructor(e,t){this.key=e,this.value=t}toString(){return this.key===W?`named: ${String(this.value).toString()} `:`tagged: { key:${this.key.toString()}, value: ${String(this.value)} }`}}class Ie{parentContext;rootRequest;constructor(e,t){this.parentContext=e,this.rootRequest=t}}function Ne(e,t){const i=function(e){const t=Object.getPrototypeOf(e.prototype),i=t?.constructor;return i}(t);if(void 0===i||i===Object)return 0;const r=U(e)(i),n=r.map((e=>e.metadata.filter((e=>"unmanaged"===e.key)))),s=[].concat.apply([],n).length,o=r.length-s;return o>0?o:Ne(e,i)}class Me{id;serviceIdentifier;parentContext;parentRequest;bindings;childRequests;target;requestScope;constructor(e,t,i,r,n){this.id=he(),this.serviceIdentifier=e,this.parentContext=t,this.parentRequest=i,this.target=n,this.childRequests=[],this.bindings=Array.isArray(r)?r:[r],this.requestScope=null===i?new Map:null}addChildRequest(e,t,i){const r=new Me(e,this.parentContext,this,t,i);return this.childRequests.push(r),r}}function Pe(e){return e._bindingDictionary}function De(e,t,i,r,n){let s=Fe(i.container,n.serviceIdentifier),o=[];return s.length===ye.NoBindingsAvailable&&!0===i.container.options.autoBindInjectable&&"function"==typeof n.serviceIdentifier&&e.getConstructorMetadata(n.serviceIdentifier).compilerGeneratedMetadata&&(i.container.bind(n.serviceIdentifier).toSelf(),s=Fe(i.container,n.serviceIdentifier)),o=t?s:s.filter((e=>{const t=new Me(e.serviceIdentifier,i,r,e,n);return e.constraint(t)})),function(e,t,i,r,n){switch(t.length){case ye.NoBindingsAvailable:if(r.isOptional())return t;{const t=_e(e);let s="No matching bindings found for serviceIdentifier:";throw s+=function(e,t){if(t.isTagged()||t.isNamed()){let i="";const r=t.getNamedTag(),n=t.getCustomTags();return null!==r&&(i+=Re(r)+"\n"),null!==n&&n.forEach((e=>{i+=Re(e)+"\n"})),` ${e}\n ${e} - ${i}`}return` ${e}`}(t,r),s+=Ae(n,t,Fe),null!==i&&(s+=`\nTrying to resolve bindings for "${_e(i.serviceIdentifier)}"`),new Error(s)}case ye.OnlyOneBindingAvailable:return t;case ye.MultipleBindingsAvailable:default:if(r.isArray())return t;{const t=_e(e);let i=`Ambiguous match found for serviceIdentifier: ${t}`;throw i+=Ae(n,t,Fe),new Error(i)}}}(n.serviceIdentifier,o,r,n,i.container),o}function Be(e,t){const i=t.isMultiInject?j:V,r=[new Ce(i,e)];return void 0!==t.customTag&&r.push(new Ce(t.customTag.key,t.customTag.value)),!0===t.isOptional&&r.push(new Ce("optional",!0)),r}function Oe(e,t,i,r,n,s){let o,a;if(null===n){o=De(e,t,r,null,s),a=new Me(i,r,null,o,s);const n=new Ie(r,a);r.addPlan(n)}else o=De(e,t,r,n,s),a=n.addChildRequest(s.serviceIdentifier,o,s);o.forEach((t=>{let i=null;if(s.isArray())i=a.addChildRequest(t.serviceIdentifier,t,s);else{if(null!==t.cache)return;i=a}if(t.type===ne&&null!==t.implementationType){const n=function(e,t){return U(e)(t)}(e,t.implementationType);if(!0!==r.container.options.skipBaseClassChecks){const i=Ne(e,t.implementationType);if(n.length<i){const e=`The number of constructor arguments in the derived class ${we(t.implementationType)} must be >= than the number of constructor arguments of its base class.`;throw new Error(e)}}n.forEach((t=>{Oe(e,!1,t.serviceIdentifier,r,i,t)}))}}))}function Fe(e,t){let i=[];const r=Pe(e);return r.hasKey(t)?i=r.get(t):null!==e.parent&&(i=Fe(e.parent,t)),i}function xe(e){return("object"==typeof e&&null!==e||"function"==typeof e)&&"function"==typeof e.then}function ke(e){return!!xe(e)||Array.isArray(e)&&e.some(xe)}const Le=async(e,t)=>{try{const i=await t;e.cache=i}catch(t){throw e.cache=null,e.activated=!1,t}};var Ge;function Ue(e){const t=new e.constr(...e.constructorInjections);return e.propertyRequests.forEach(((i,r)=>{const n=i.target.identifier,s=e.propertyInjections[r];i.target.isOptional()&&void 0===s||(t[n]=s)})),t}async function We(e){const t=[];for(const i of e)Array.isArray(i)?t.push(Promise.all(i)):t.push(i);return Promise.all(t)}function Ve(e,t){const i=function(e,t){if(Reflect.hasMetadata($,e)){const i=Reflect.getMetadata($,e);try{return t[i.value]?.()}catch(t){if(t instanceof Error)throw new Error(`@postConstruct error in class ${e.name}: ${t.message}`)}}}(e,t);return xe(i)?i.then((()=>t)):t}!function(e){e.DynamicValue="toDynamicValue",e.Factory="toFactory",e.Provider="toProvider"}(Ge||(Ge={}));const je=e=>t=>{t.parentContext.setCurrentRequest(t);const i=t.bindings,r=t.childRequests,n=t.target&&t.target.isArray(),s=!(t.parentRequest&&t.parentRequest.target&&t.target&&t.parentRequest.target.matchesArray(t.target.serviceIdentifier));if(n&&s)return r.map((t=>je(e)(t)));{if(t.target.isOptional()&&0===i.length)return;const r=i[0];return Ke(e,t,r)}},qe=(e,t,i)=>{let r;const n=t.childRequests;switch((e=>{let t=null;switch(e.type){case J:case re:t=e.cache;break;case ee:case ne:t=e.implementationType;break;case te:t=e.dynamicValue;break;case oe:t=e.provider;break;case ie:t=e.factory}if(null===t){const t=_e(e.serviceIdentifier);throw new Error(`Invalid binding type: ${t}`)}})(i),i.type){case J:case re:r=i.cache;break;case ee:r=i.implementationType;break;case ne:r=function(e,t,i,r){!function(e,t){e.scope!==X&&function(e,t){const i=`Class cannot be instantiated in ${e.scope===Q?"request":"transient"} scope.`;if("function"==typeof e.onDeactivation)throw new Error(me(t.name,i));if(Reflect.hasMetadata(z,t))throw new Error(`@preDestroy error in class ${t.name}: ${i}`)}(e,t)}(e,t);const n=function(e,t,i){let r;if(t.length>0){const n=function(e,t){return e.reduce(((e,i)=>{const r=t(i);return i.target.type===ae?e.constructorInjections.push(r):(e.propertyRequests.push(i),e.propertyInjections.push(r)),e.isAsync||(e.isAsync=ke(r)),e}),{constructorInjections:[],isAsync:!1,propertyInjections:[],propertyRequests:[]})}(t,i),s={...n,constr:e};r=n.isAsync?async function(e){const t=await We(e.constructorInjections),i=await We(e.propertyInjections);return Ue({...e,constructorInjections:t,propertyInjections:i})}(s):Ue(s)}else r=new e;return r}(t,i,r);return xe(n)?n.then((e=>Ve(t,e))):Ve(t,n)}(i,i.implementationType,n,je(e));break;default:r=((e,t)=>{const i=(e=>{switch(e.type){case ie:return{factory:e.factory,factoryType:Ge.Factory};case oe:return{factory:e.provider,factoryType:Ge.Provider};case te:return{factory:e.dynamicValue,factoryType:Ge.DynamicValue};default:throw new Error(`Unexpected factory type ${e.type}`)}})(e);return((e,t)=>{try{return e()}catch(e){if(Ee(e))throw t();throw e}})((()=>i.factory.bind(e)(t)),(()=>new Error(`It looks like there is a circular dependency in one of the '${i.factoryType}' bindings. Please investigate bindings with service identifier '${t.currentRequest.serviceIdentifier.toString()}'.`)))})(i,t.parentContext)}return r},He=(e,t,i)=>{let r=((e,t)=>t.scope===X&&t.activated?t.cache:t.scope===Q&&e.has(t.id)?e.get(t.id):null)(e,t);return null!==r||(r=i(),((e,t,i)=>{t.scope===X&&((e,t)=>{e.cache=t,e.activated=!0,xe(t)&&Le(e,t)})(t,i),t.scope===Q&&((e,t,i)=>{e.has(t.id)||e.set(t.id,i)})(e,t,i)})(e,t,r)),r},Ke=(e,t,i)=>He(e,i,(()=>{let r=qe(e,t,i);return r=xe(r)?r.then((e=>Ye(t,i,e))):Ye(t,i,r),r}));function Ye(e,t,i){let r=$e(e.parentContext,t,i);const n=Ze(e.parentContext.container);let s,o=n.next();do{s=o.value;const t=e.parentContext,i=e.serviceIdentifier,a=Xe(s,i);r=xe(r)?Qe(a,t,r):ze(a,t,r),o=n.next()}while(!0!==o.done&&!Pe(s).hasKey(e.serviceIdentifier));return r}const $e=(e,t,i)=>{let r;return r="function"==typeof t.onActivation?t.onActivation(e,i):i,r},ze=(e,t,i)=>{let r=e.next();for(;!0!==r.done;){if(xe(i=r.value(t,i)))return Qe(e,t,i);r=e.next()}return i},Qe=async(e,t,i)=>{let r=await i,n=e.next();for(;!0!==n.done;)r=await n.value(t,r),n=e.next();return r},Xe=(e,t)=>{const i=e._activations;return i.hasKey(t)?i.get(t).values():[].values()},Ze=e=>{const t=[e];let i=e.parent;for(;null!==i;)t.push(i),i=i.parent;return{next:()=>{const e=t.pop();return void 0!==e?{done:!1,value:e}:{done:!0,value:void 0}}}},Je=(e,t)=>{const i=e.parentRequest;return null!==i&&(!!t(i)||Je(i,t))},et=e=>t=>{const i=i=>null!==i&&null!==i.target&&i.target.matchesTag(e)(t);return i.metaData=new Ce(e,t),i},tt=et(W),it=e=>t=>{let i=null;if(null!==t){if(i=t.bindings[0],"string"==typeof e)return i.serviceIdentifier===e;{const i=t.bindings[0].implementationType;return e===i}}return!1};class rt{_binding;constructor(e){this._binding=e}when(e){return this._binding.constraint=e,new nt(this._binding)}whenTargetNamed(e){return this._binding.constraint=tt(e),new nt(this._binding)}whenTargetIsDefault(){return this._binding.constraint=e=>null!==e&&(null!==e.target&&!e.target.isNamed()&&!e.target.isTagged()),new nt(this._binding)}whenTargetTagged(e,t){return this._binding.constraint=et(e)(t),new nt(this._binding)}whenInjectedInto(e){return this._binding.constraint=t=>null!==t&&it(e)(t.parentRequest),new nt(this._binding)}whenParentNamed(e){return this._binding.constraint=t=>null!==t&&tt(e)(t.parentRequest),new nt(this._binding)}whenParentTagged(e,t){return this._binding.constraint=i=>null!==i&&et(e)(t)(i.parentRequest),new nt(this._binding)}whenAnyAncestorIs(e){return this._binding.constraint=t=>null!==t&&Je(t,it(e)),new nt(this._binding)}whenNoAncestorIs(e){return this._binding.constraint=t=>null!==t&&!Je(t,it(e)),new nt(this._binding)}whenAnyAncestorNamed(e){return this._binding.constraint=t=>null!==t&&Je(t,tt(e)),new nt(this._binding)}whenNoAncestorNamed(e){return this._binding.constraint=t=>null!==t&&!Je(t,tt(e)),new nt(this._binding)}whenAnyAncestorTagged(e,t){return this._binding.constraint=i=>null!==i&&Je(i,et(e)(t)),new nt(this._binding)}whenNoAncestorTagged(e,t){return this._binding.constraint=i=>null!==i&&!Je(i,et(e)(t)),new nt(this._binding)}whenAnyAncestorMatches(e){return this._binding.constraint=t=>null!==t&&Je(t,e),new nt(this._binding)}whenNoAncestorMatches(e){return this._binding.constraint=t=>null!==t&&!Je(t,e),new nt(this._binding)}}class nt{_binding;constructor(e){this._binding=e}onActivation(e){return this._binding.onActivation=e,new rt(this._binding)}onDeactivation(e){return this._binding.onDeactivation=e,new rt(this._binding)}}class st{_bindingWhenSyntax;_bindingOnSyntax;_binding;constructor(e){this._binding=e,this._bindingWhenSyntax=new rt(this._binding),this._bindingOnSyntax=new nt(this._binding)}when(e){return this._bindingWhenSyntax.when(e)}whenTargetNamed(e){return this._bindingWhenSyntax.whenTargetNamed(e)}whenTargetIsDefault(){return this._bindingWhenSyntax.whenTargetIsDefault()}whenTargetTagged(e,t){return this._bindingWhenSyntax.whenTargetTagged(e,t)}whenInjectedInto(e){return this._bindingWhenSyntax.whenInjectedInto(e)}whenParentNamed(e){return this._bindingWhenSyntax.whenParentNamed(e)}whenParentTagged(e,t){return this._bindingWhenSyntax.whenParentTagged(e,t)}whenAnyAncestorIs(e){return this._bindingWhenSyntax.whenAnyAncestorIs(e)}whenNoAncestorIs(e){return this._bindingWhenSyntax.whenNoAncestorIs(e)}whenAnyAncestorNamed(e){return this._bindingWhenSyntax.whenAnyAncestorNamed(e)}whenAnyAncestorTagged(e,t){return this._bindingWhenSyntax.whenAnyAncestorTagged(e,t)}whenNoAncestorNamed(e){return this._bindingWhenSyntax.whenNoAncestorNamed(e)}whenNoAncestorTagged(e,t){return this._bindingWhenSyntax.whenNoAncestorTagged(e,t)}whenAnyAncestorMatches(e){return this._bindingWhenSyntax.whenAnyAncestorMatches(e)}whenNoAncestorMatches(e){return this._bindingWhenSyntax.whenNoAncestorMatches(e)}onActivation(e){return this._bindingOnSyntax.onActivation(e)}onDeactivation(e){return this._bindingOnSyntax.onDeactivation(e)}}class ot{_binding;constructor(e){this._binding=e}inRequestScope(){return this._binding.scope=Q,new st(this._binding)}inSingletonScope(){return this._binding.scope=X,new st(this._binding)}inTransientScope(){return this._binding.scope=Z,new st(this._binding)}}class at{_bindingInSyntax;_bindingWhenSyntax;_bindingOnSyntax;_binding;constructor(e){this._binding=e,this._bindingWhenSyntax=new rt(this._binding),this._bindingOnSyntax=new nt(this._binding),this._bindingInSyntax=new ot(e)}inRequestScope(){return this._bindingInSyntax.inRequestScope()}inSingletonScope(){return this._bindingInSyntax.inSingletonScope()}inTransientScope(){return this._bindingInSyntax.inTransientScope()}when(e){return this._bindingWhenSyntax.when(e)}whenTargetNamed(e){return this._bindingWhenSyntax.whenTargetNamed(e)}whenTargetIsDefault(){return this._bindingWhenSyntax.whenTargetIsDefault()}whenTargetTagged(e,t){return this._bindingWhenSyntax.whenTargetTagged(e,t)}whenInjectedInto(e){return this._bindingWhenSyntax.whenInjectedInto(e)}whenParentNamed(e){return this._bindingWhenSyntax.whenParentNamed(e)}whenParentTagged(e,t){return this._bindingWhenSyntax.whenParentTagged(e,t)}whenAnyAncestorIs(e){return this._bindingWhenSyntax.whenAnyAncestorIs(e)}whenNoAncestorIs(e){return this._bindingWhenSyntax.whenNoAncestorIs(e)}whenAnyAncestorNamed(e){return this._bindingWhenSyntax.whenAnyAncestorNamed(e)}whenAnyAncestorTagged(e,t){return this._bindingWhenSyntax.whenAnyAncestorTagged(e,t)}whenNoAncestorNamed(e){return this._bindingWhenSyntax.whenNoAncestorNamed(e)}whenNoAncestorTagged(e,t){return this._bindingWhenSyntax.whenNoAncestorTagged(e,t)}whenAnyAncestorMatches(e){return this._bindingWhenSyntax.whenAnyAncestorMatches(e)}whenNoAncestorMatches(e){return this._bindingWhenSyntax.whenNoAncestorMatches(e)}onActivation(e){return this._bindingOnSyntax.onActivation(e)}onDeactivation(e){return this._bindingOnSyntax.onDeactivation(e)}}class ut{_binding;constructor(e){this._binding=e}to(e){return this._binding.type=ne,this._binding.implementationType=e,new at(this._binding)}toSelf(){if("function"!=typeof this._binding.serviceIdentifier)throw new Error("The toSelf function can only be applied when a constructor is used as service identifier");const e=this._binding.serviceIdentifier;return this.to(e)}toConstantValue(e){return this._binding.type=J,this._binding.cache=e,this._binding.dynamicValue=null,this._binding.implementationType=null,this._binding.scope=X,new st(this._binding)}toDynamicValue(e){return this._binding.type=te,this._binding.cache=null,this._binding.dynamicValue=e,this._binding.implementationType=null,new at(this._binding)}toConstructor(e){return this._binding.type=ee,this._binding.implementationType=e,this._binding.scope=X,new st(this._binding)}toFactory(e){return this._binding.type=ie,this._binding.factory=e,this._binding.scope=X,new st(this._binding)}toFunction(e){if("function"!=typeof e)throw new Error("Value provided to function binding must be a function!");const t=this.toConstantValue(e);return this._binding.type=re,this._binding.scope=X,t}toAutoFactory(e){return this._binding.type=ie,this._binding.factory=t=>()=>t.container.get(e),this._binding.scope=X,new st(this._binding)}toAutoNamedFactory(e){return this._binding.type=ie,this._binding.factory=t=>i=>t.container.getNamed(e,i),new st(this._binding)}toProvider(e){return this._binding.type=oe,this._binding.provider=e,this._binding.scope=X,new st(this._binding)}toService(e){this._binding.type=te,Object.defineProperty(this._binding,"cache",{configurable:!0,enumerable:!0,get:()=>null,set(e){}}),this._binding.dynamicValue=t=>{try{return t.container.get(e)}catch(i){return t.container.getAsync(e)}},this._binding.implementationType=null}}class ct{bindings;activations;deactivations;middleware;moduleActivationStore;static of(e,t,i,r,n){const s=new ct;return s.bindings=e,s.middleware=t,s.deactivations=r,s.activations=i,s.moduleActivationStore=n,s}}class ht{_map;constructor(){this._map=new Map}getMap(){return this._map}add(e,t){if(this._checkNonNulish(e),null==t)throw new Error(fe);const i=this._map.get(e);void 0!==i?i.push(t):this._map.set(e,[t])}get(e){this._checkNonNulish(e);const t=this._map.get(e);if(void 0!==t)return t;throw new Error(pe)}remove(e){if(this._checkNonNulish(e),!this._map.delete(e))throw new Error(pe)}removeIntersection(e){this.traverse(((t,i)=>{const r=e.hasKey(t)?e.get(t):void 0;if(void 0!==r){const e=i.filter((e=>!r.some((t=>e===t))));this._setValue(t,e)}}))}removeByCondition(e){const t=[];return this._map.forEach(((i,r)=>{const n=[];for(const r of i)e(r)?t.push(r):n.push(r);this._setValue(r,n)})),t}hasKey(e){return this._checkNonNulish(e),this._map.has(e)}clone(){const e=new ht;return this._map.forEach(((t,i)=>{t.forEach((t=>{var r;e.add(i,"object"==typeof(r=t)&&null!==r&&"clone"in r&&"function"==typeof r.clone?t.clone():t)}))})),e}traverse(e){this._map.forEach(((t,i)=>{e(i,t)}))}_checkNonNulish(e){if(null==e)throw new Error(fe)}_setValue(e,t){t.length>0?this._map.set(e,t):this._map.delete(e)}}class lt{_map=new Map;remove(e){const t=this._map.get(e);return void 0===t?this._getEmptyHandlersStore():(this._map.delete(e),t)}addDeactivation(e,t,i){this._getModuleActivationHandlers(e).onDeactivations.add(t,i)}addActivation(e,t,i){this._getModuleActivationHandlers(e).onActivations.add(t,i)}clone(){const e=new lt;return this._map.forEach(((t,i)=>{e._map.set(i,{onActivations:t.onActivations.clone(),onDeactivations:t.onDeactivations.clone()})})),e}_getModuleActivationHandlers(e){let t=this._map.get(e);return void 0===t&&(t=this._getEmptyHandlersStore(),this._map.set(e,t)),t}_getEmptyHandlersStore(){return{onActivations:new ht,onDeactivations:new ht}}}class dt{id;parent;options;_middleware;_bindingDictionary;_activations;_deactivations;_snapshots;_metadataReader;_moduleActivationStore;constructor(e){const t=e||{};if("object"!=typeof t)throw new Error("Invalid Container constructor argument. Container options must be an object.");if(void 0===t.defaultScope)t.defaultScope=Z;else if(t.defaultScope!==X&&t.defaultScope!==Z&&t.defaultScope!==Q)throw new Error('Invalid Container option. Default scope must be a string ("singleton" or "transient").');if(void 0===t.autoBindInjectable)t.autoBindInjectable=!1;else if("boolean"!=typeof t.autoBindInjectable)throw new Error("Invalid Container option. Auto bind injectable must be a boolean");if(void 0===t.skipBaseClassChecks)t.skipBaseClassChecks=!1;else if("boolean"!=typeof t.skipBaseClassChecks)throw new Error("Invalid Container option. Skip base check must be a boolean");this.options={autoBindInjectable:t.autoBindInjectable,defaultScope:t.defaultScope,skipBaseClassChecks:t.skipBaseClassChecks},this.id=he(),this._bindingDictionary=new ht,this._snapshots=[],this._middleware=null,this._activations=new ht,this._deactivations=new ht,this.parent=null,this._metadataReader=new ve,this._moduleActivationStore=new lt}static merge(e,t,...i){const r=new dt,n=[e,t,...i].map((e=>Pe(e))),s=Pe(r);return n.forEach((e=>{var t;t=s,e.traverse(((e,i)=>{i.forEach((e=>{t.add(e.serviceIdentifier,e.clone())}))}))})),r}load(...e){const t=this._getContainerModuleHelpersFactory();for(const i of e){const e=t(i.id);i.registry(e.bindFunction,e.unbindFunction,e.isboundFunction,e.rebindFunction,e.unbindAsyncFunction,e.onActivationFunction,e.onDeactivationFunction)}}async loadAsync(...e){const t=this._getContainerModuleHelpersFactory();for(const i of e){const e=t(i.id);await i.registry(e.bindFunction,e.unbindFunction,e.isboundFunction,e.rebindFunction,e.unbindAsyncFunction,e.onActivationFunction,e.onDeactivationFunction)}}unload(...e){e.forEach((e=>{const t=this._removeModuleBindings(e.id);this._deactivateSingletons(t),this._removeModuleHandlers(e.id)}))}async unloadAsync(...e){for(const t of e){const e=this._removeModuleBindings(t.id);await this._deactivateSingletonsAsync(e),this._removeModuleHandlers(t.id)}}bind(e){return this._bind(this._buildBinding(e))}rebind(e){return this.unbind(e),this.bind(e)}async rebindAsync(e){return await this.unbindAsync(e),this.bind(e)}unbind(e){if(this._bindingDictionary.hasKey(e)){const t=this._bindingDictionary.get(e);this._deactivateSingletons(t)}this._removeServiceFromDictionary(e)}async unbindAsync(e){if(this._bindingDictionary.hasKey(e)){const t=this._bindingDictionary.get(e);await this._deactivateSingletonsAsync(t)}this._removeServiceFromDictionary(e)}unbindAll(){this._bindingDictionary.traverse(((e,t)=>{this._deactivateSingletons(t)})),this._bindingDictionary=new ht}async unbindAllAsync(){const e=[];this._bindingDictionary.traverse(((t,i)=>{e.push(this._deactivateSingletonsAsync(i))})),await Promise.all(e),this._bindingDictionary=new ht}onActivation(e,t){this._activations.add(e,t)}onDeactivation(e,t){this._deactivations.add(e,t)}isBound(e){let t=this._bindingDictionary.hasKey(e);return!t&&this.parent&&(t=this.parent.isBound(e)),t}isCurrentBound(e){return this._bindingDictionary.hasKey(e)}isBoundNamed(e,t){return this.isBoundTagged(e,W,t)}isBoundTagged(e,t,i){let r=!1;if(this._bindingDictionary.hasKey(e)){const n=this._bindingDictionary.get(e),s=function(e,t,i){const r=T(Be(t,i));if(r.kind===S.unmanaged)throw new Error("Unexpected metadata when creating target");const n=new G("",r,"Variable"),s=new Te(e);return new Me(t,s,null,[],n)}(this,e,{customTag:{key:t,value:i},isMultiInject:!1});r=n.some((e=>e.constraint(s)))}return!r&&this.parent&&(r=this.parent.isBoundTagged(e,t,i)),r}snapshot(){this._snapshots.push(ct.of(this._bindingDictionary.clone(),this._middleware,this._activations.clone(),this._deactivations.clone(),this._moduleActivationStore.clone()))}restore(){const e=this._snapshots.pop();if(void 0===e)throw new Error("No snapshot available to restore.");this._bindingDictionary=e.bindings,this._activations=e.activations,this._deactivations=e.deactivations,this._middleware=e.middleware,this._moduleActivationStore=e.moduleActivationStore}createChild(e){const t=new dt(e||this.options);return t.parent=this,t}applyMiddleware(...e){const t=this._middleware?this._middleware:this._planAndResolve();this._middleware=e.reduce(((e,t)=>t(e)),t)}applyCustomMetadataReader(e){this._metadataReader=e}get(e){const t=this._getNotAllArgs(e,!1,!1);return this._getButThrowIfAsync(t)}async getAsync(e){const t=this._getNotAllArgs(e,!1,!1);return this._get(t)}getTagged(e,t,i){const r=this._getNotAllArgs(e,!1,!1,t,i);return this._getButThrowIfAsync(r)}async getTaggedAsync(e,t,i){const r=this._getNotAllArgs(e,!1,!1,t,i);return this._get(r)}getNamed(e,t){return this.getTagged(e,W,t)}async getNamedAsync(e,t){return this.getTaggedAsync(e,W,t)}getAll(e,t){const i=this._getAllArgs(e,t,!1);return this._getButThrowIfAsync(i)}async getAllAsync(e,t){const i=this._getAllArgs(e,t,!1);return this._getAll(i)}getAllTagged(e,t,i){const r=this._getNotAllArgs(e,!0,!1,t,i);return this._getButThrowIfAsync(r)}async getAllTaggedAsync(e,t,i){const r=this._getNotAllArgs(e,!0,!1,t,i);return this._getAll(r)}getAllNamed(e,t){return this.getAllTagged(e,W,t)}async getAllNamedAsync(e,t){return this.getAllTaggedAsync(e,W,t)}resolve(e){const t=this.isBound(e);t||this.bind(e).toSelf();const i=this.get(e);return t||this.unbind(e),i}tryGet(e){const t=this._getNotAllArgs(e,!1,!0);return this._getButThrowIfAsync(t)}async tryGetAsync(e){const t=this._getNotAllArgs(e,!1,!0);return this._get(t)}tryGetTagged(e,t,i){const r=this._getNotAllArgs(e,!1,!0,t,i);return this._getButThrowIfAsync(r)}async tryGetTaggedAsync(e,t,i){const r=this._getNotAllArgs(e,!1,!0,t,i);return this._get(r)}tryGetNamed(e,t){return this.tryGetTagged(e,W,t)}async tryGetNamedAsync(e,t){return this.tryGetTaggedAsync(e,W,t)}tryGetAll(e,t){const i=this._getAllArgs(e,t,!0);return this._getButThrowIfAsync(i)}async tryGetAllAsync(e,t){const i=this._getAllArgs(e,t,!0);return this._getAll(i)}tryGetAllTagged(e,t,i){const r=this._getNotAllArgs(e,!0,!0,t,i);return this._getButThrowIfAsync(r)}async tryGetAllTaggedAsync(e,t,i){const r=this._getNotAllArgs(e,!0,!0,t,i);return this._getAll(r)}tryGetAllNamed(e,t){return this.tryGetAllTagged(e,W,t)}async tryGetAllNamedAsync(e,t){return this.tryGetAllTaggedAsync(e,W,t)}_preDestroy(e,t){if(void 0!==e&&Reflect.hasMetadata(z,e)){const i=Reflect.getMetadata(z,e);return t[i.value]?.()}}_removeModuleHandlers(e){const t=this._moduleActivationStore.remove(e);this._activations.removeIntersection(t.onActivations),this._deactivations.removeIntersection(t.onDeactivations)}_removeModuleBindings(e){return this._bindingDictionary.removeByCondition((t=>t.moduleId===e))}_deactivate(e,t){const i=null==t?void 0:Object.getPrototypeOf(t).constructor;try{if(this._deactivations.hasKey(e.serviceIdentifier)){const r=this._deactivateContainer(t,this._deactivations.get(e.serviceIdentifier).values());if(xe(r))return this._handleDeactivationError(r.then((async()=>this._propagateContainerDeactivationThenBindingAndPreDestroyAsync(e,t,i))),e.serviceIdentifier)}const r=this._propagateContainerDeactivationThenBindingAndPreDestroy(e,t,i);if(xe(r))return this._handleDeactivationError(r,e.serviceIdentifier)}catch(t){if(t instanceof Error)throw new Error(me(_e(e.serviceIdentifier),t.message))}}async _handleDeactivationError(e,t){try{await e}catch(e){if(e instanceof Error)throw new Error(me(_e(t),e.message))}}_deactivateContainer(e,t){let i=t.next();for(;"function"==typeof i.value;){const r=i.value(e);if(xe(r))return r.then((async()=>this._deactivateContainerAsync(e,t)));i=t.next()}}async _deactivateContainerAsync(e,t){let i=t.next();for(;"function"==typeof i.value;)await i.value(e),i=t.next()}_getContainerModuleHelpersFactory(){const e=e=>t=>{const i=this._buildBinding(t);return i.moduleId=e,this._bind(i)},t=()=>e=>{this.unbind(e)},i=()=>async e=>this.unbindAsync(e),r=()=>e=>this.isBound(e),n=t=>{const i=e(t);return e=>(this.unbind(e),i(e))},s=e=>(t,i)=>{this._moduleActivationStore.addActivation(e,t,i),this.onActivation(t,i)},o=e=>(t,i)=>{this._moduleActivationStore.addDeactivation(e,t,i),this.onDeactivation(t,i)};return a=>({bindFunction:e(a),isboundFunction:r(),onActivationFunction:s(a),onDeactivationFunction:o(a),rebindFunction:n(a),unbindAsyncFunction:i(),unbindFunction:t()})}_bind(e){return this._bindingDictionary.add(e.serviceIdentifier,e),new ut(e)}_buildBinding(e){const t=this.options.defaultScope||Z;return new le(e,t)}async _getAll(e){return Promise.all(this._get(e))}_get(e){const t={...e,contextInterceptor:e=>e,targetType:ue};if(this._middleware){const e=this._middleware(t);if(null==e)throw new Error("Invalid return type in middleware. Middleware must return!");return e}return this._planAndResolve()(t)}_getButThrowIfAsync(e){const t=this._get(e);if(ke(t))throw new Error(`You are attempting to construct ${function(e){return"function"==typeof e?`[function/class ${e.name||"<anonymous>"}]`:"symbol"==typeof e?e.toString():`'${e}'`}(e.serviceIdentifier)} in a synchronous way but it has asynchronous dependencies.`);return t}_getAllArgs(e,t,i){return{avoidConstraints:!t?.enforceBindingConstraints,isMultiInject:!0,isOptional:i,serviceIdentifier:e}}_getNotAllArgs(e,t,i,r,n){return{avoidConstraints:!1,isMultiInject:t,isOptional:i,key:r,serviceIdentifier:e,value:n}}_getPlanMetadataFromNextArgs(e){const t={isMultiInject:e.isMultiInject};return void 0!==e.key&&(t.customTag={key:e.key,value:e.value}),!0===e.isOptional&&(t.isOptional=!0),t}_planAndResolve(){return e=>{let t=function(e,t,i,r,n,s=!1){const o=new Te(t),a=function(e,t,i){const r=T(Be(t,i));if(r.kind===S.unmanaged)throw new Error("Unexpected metadata when creating target");return new G("",r,e)}(i,r,n);try{return Oe(e,s,r,o,null,a),o}catch(e){throw Ee(e)&&Se(o.plan.rootRequest),e}}(this._metadataReader,this,e.targetType,e.serviceIdentifier,this._getPlanMetadataFromNextArgs(e),e.avoidConstraints);t=e.contextInterceptor(t);const i=function(e){return je(e.plan.rootRequest.requestScope)(e.plan.rootRequest)}(t);return i}}_deactivateIfSingleton(e){if(e.activated)return xe(e.cache)?e.cache.then((t=>this._deactivate(e,t))):this._deactivate(e,e.cache)}_deactivateSingletons(e){for(const t of e)if(xe(this._deactivateIfSingleton(t)))throw new Error("Attempting to unbind dependency with asynchronous destruction (@preDestroy or onDeactivation)")}async _deactivateSingletonsAsync(e){await Promise.all(e.map((async e=>this._deactivateIfSingleton(e))))}_propagateContainerDeactivationThenBindingAndPreDestroy(e,t,i){return this.parent?this._deactivate.bind(this.parent)(e,t):this._bindingDeactivationAndPreDestroy(e,t,i)}async _propagateContainerDeactivationThenBindingAndPreDestroyAsync(e,t,i){this.parent?await this._deactivate.bind(this.parent)(e,t):await this._bindingDeactivationAndPreDestroyAsync(e,t,i)}_removeServiceFromDictionary(e){try{this._bindingDictionary.remove(e)}catch(t){throw new Error(`Could not unbind serviceIdentifier: ${_e(e)}`)}}_bindingDeactivationAndPreDestroy(e,t,i){if("function"==typeof e.onDeactivation){const r=e.onDeactivation(t);if(xe(r))return r.then((()=>this._preDestroy(i,t)))}return this._preDestroy(i,t)}async _bindingDeactivationAndPreDestroyAsync(e,t,i){"function"==typeof e.onDeactivation&&await e.onDeactivation(t),await this._preDestroy(i,t)}}function ft(e,t,i,r){const n=function(e){let t=[];if(Array.isArray(e)){t=e;const i=function(e){const t=new Set;for(const i of e){if(t.has(i))return i;t.add(i)}}(t.map((e=>e.key)));if(void 0!==i)throw new Error(`${de} ${i.toString()}`)}else t=[e];return t}(r);let s={};Reflect.hasOwnMetadata(e,t)&&(s=Reflect.getMetadata(e,t));let o=s[i];if(void 0===o)o=[];else for(const e of o)if(n.some((t=>t.key===e.key)))throw new Error(`${de} ${e.key.toString()}`);o.push(...n),s[i]=o,Reflect.defineMetadata(e,s,t)}function pt(e){return(t,i,r)=>{"number"==typeof r?function(e,t,i,r){!function(e){if(void 0!==e)throw new Error(ge)}(t),ft(q,e,i.toString(),r)}(t,i,r,e):function(e,t,i){if(void 0!==e.prototype)throw new Error(ge);ft(H,e.constructor,t,i)}(t,i,e)}}function gt(){return function(e){if(Reflect.hasOwnMetadata(K,e))throw new Error("Cannot apply @injectable decorator multiple times.");const t=Reflect.getMetadata(Y,e)||[];return Reflect.defineMetadata(K,t,e),e}}function mt(e){return t=>(i,r,n)=>{if(void 0===t){const e="function"==typeof i?i.name:i.constructor.name;throw new Error(`@inject called with undefined this could mean that the class ${e} has a circular dependency problem. You can use a LazyServiceIdentifer to overcome this limitation.`)}pt(new Ce(e,t))(i,r,n)}}const vt=mt(V),yt=mt(j);const Et=function(e,t){return()=>(i,r)=>{const n=new Ce(e,r);if(Reflect.hasOwnMetadata(e,i.constructor))throw new Error(t);Reflect.defineMetadata(e,n,i.constructor)}}($,"Cannot apply @postConstruct decorator multiple times in the same class"),_t={AudioContextManager:Symbol.for("AudioContextManager"),AudioEditor:Symbol.for("AudioEditor"),AudioProcessor:Symbol.for("AudioProcessor"),BufferManager:Symbol.for("BufferManager"),FilterManager:Symbol.for("FilterManager"),RendererManager:Symbol.for("RendererManager"),SaveBufferManager:Symbol.for("SaveBufferManager"),ConfigService:Symbol.for("ConfigService"),EventEmitter:Symbol.for("EventEmitter"),BufferPlayer:Symbol.for("BufferPlayer"),BufferDecoderService:Symbol.for("BufferDecoderService"),BufferFetcherService:Symbol.for("BufferFetcherService"),AudioBuffersToFetch:Symbol.for("AudioBuffersToFetch"),Renderers:Symbol.for("Renderers"),Filters:Symbol.for("Filters"),EntryPointFilter:Symbol.for("EntryPointFilter"),VoiceRecorder:Symbol.for("VoiceRecorder")};let At=class{constructor(){this.bufferFetcherService=null,this.bufferDecoderService=null,this.configService=null,this.eventEmitter=null,this.contextManager=null}injectDependencies(e,t,i,r,n){e&&(this.bufferFetcherService=e),t&&(this.bufferDecoderService=t),i&&(this.configService=i),r&&(this.eventEmitter=r),n&&(this.contextManager=n)}};e([vt(_t.BufferFetcherService),i("design:type",Object)],At.prototype,"bufferFetcherService",void 0),e([vt(_t.BufferDecoderService),i("design:type",Object)],At.prototype,"bufferDecoderService",void 0),e([vt(_t.ConfigService),i("design:type",Object)],At.prototype,"configService",void 0),e([vt(_t.EventEmitter),i("design:type",Object)],At.prototype,"eventEmitter",void 0),e([vt(_t.AudioContextManager),i("design:type",Object)],At.prototype,"contextManager",void 0),At=e([gt()],At);var bt=At;const St={calcAudioDuration:(e,t)=>{if(e){let i=e.duration+1;return null!=t&&(i/=t),i}return 0},loadAudioBuffer:(e,t)=>r(void 0,void 0,void 0,(function*(){const i=yield St.readAsArrayBufferPromisified(t),r=yield e.decodeAudioData(i);return St.decodeBuffer(e,r)})),readAsArrayBufferPromisified:e=>new Promise(((t,i)=>{const r=new FileReader;r.onload=e=>{var r;const n=null===(r=null==e?void 0:e.target)||void 0===r?void 0:r.result;n instanceof ArrayBuffer?t(n):i()},e&&r.readAsArrayBuffer(e)})),decodeBuffer:(e,t)=>{if(1==t.numberOfChannels){e.resume();const{duration:i}=t,{sampleRate:r}=e,n=e.createBuffer(2,r*i+2*r,r),s=t.getChannelData(0),o=n.getChannelData(0),a=n.getChannelData(1);for(let e=0;e<s.length;e++)o[e]=s[e],a[e]=s[e];return n}return t},convertAudioBufferToFloat32Array:e=>{const t=[];for(let i=0;i<e.numberOfChannels;i++)t.push(e.getChannelData(i));return t},convertAudioParamToFloat32Array:(e,t)=>{const i=new Float32Array(t);for(let r=0;r<t;r++)i.set([e.value],r);return i},sumAudioBufferChannel:(e,t)=>e.getChannelData(t).reduce(((e,t)=>e+t),0),sumAudioBuffer(e){let t=0;for(let i=0;i<e.numberOfChannels;i++)t+=this.sumAudioBufferChannel(e,i);return t},isAudioWorkletCompatible:e=>void 0!==e&&void 0!==e.audioWorklet,isSettingValueValid:e=>!(void 0===e||isNaN(Number(e))||"string"==typeof e&&""===e.trim()),calculateAudioDuration(e,t,i){if(e&&t){return this.calcAudioDuration(e,i)+t.getAddingTime()}return 0},forceDownload(e,t){const i=window.document.createElement("a"),r=URL.createObjectURL(e);window.document.body.appendChild(i),i.href=r,i.download=t||"output.wav",i.click(),URL.revokeObjectURL(r),window.document.body.removeChild(i)},clearAudioBuffer(e){if(e)for(let t=0;t<e.numberOfChannels;t++){const i=e.getChannelData(t);for(let e=0;e<i.length;e++)i[e]=0}}};var wt;exports.EventType=void 0,(wt=exports.EventType||(exports.EventType={})).LOADING_BUFFERS="loadingBuffers",wt.LOADING_BUFFERS_ERROR="loadingBuffersError",wt.FETCHING_BUFFERS="fetchingBuffers",wt.FETCHING_BUFFERS_ERROR="fetchingBuffersError",wt.FINISHED_FETCHING_BUFFERS="finishedFetchingBuffers",wt.LOADED_BUFFERS="loadedBuffers",wt.COMPATIBILITY_MODE_AUTO_ENABLED="compatibilityModeAutoEnabled",wt.STARTED_RENDERING_AUDIO="renderingAudio",wt.RENDERING_AUDIO_PROBLEM_DETECTED="renderingAudioProblemDetected",wt.AUDIO_RENDERING_FINISHED="audioRenderingFinished",wt.AUDIO_RENDERING_EXCEPTION_THROWN="audioRenderingExceptionThrown",wt.OFFLINE_AUDIO_RENDERING_FINISHED="offlineAudioRenderingFinished",wt.PLAYING_STOPPED="playingStopped",wt.PLAYING_STARTED="playingStarted",wt.PLAYING_FINISHED="playingFinished",wt.PLAYING_UPDATE="playingUpdate",wt.RECORDER_INIT="recorderInit",wt.RECORDER_SUCCESS="recorderSuccess",wt.RECORDER_ERROR="recorderError",wt.RECORDER_UPDATE_CONSTRAINTS="recorderUpdateConstraints",wt.RECORDER_RECORDING="recorderRecording",wt.RECORDER_STOPPED="recorderStopped",wt.RECORDER_PAUSED="recorderPaused",wt.RECORDER_RESETED="recorderReseted",wt.RECORDER_COUNT_UPDATE="recorderCountUpdate",wt.SAMPLE_RATE_CHANGED="sampleRateChanged",wt.DECODING_AUDIO_FILE="decodingAudioFile",wt.DECODED_AUDIO_FILE="decodedAudioFile",wt.ERROR_DECODING_AUDIO_FILE="errorDecodingAudioFile",wt.RECORDER_NOT_FOUND_ERROR="recorderNotFoundError",wt.RECORDER_UNKNOWN_ERROR="recorderUnknownError",wt.UPDATE_AUDIO_TREATMENT_PERCENT="updateAudioTreatmentPercent",wt.UPDATE_REMAINING_TIME_ESTIMATED="updateRemainingTimeEstimated",wt.CANCELLED_AND_LOADED_INITIAL_AUDIO="cancelledAndLoadedInitialAudio",wt.CANCELLING_AUDIO_PROCESSING="cancellingAudioProcessing",wt.PLAYING_FINISHED_LOOP_ALL="playingFinishedLoopAll",wt.LOADED_AUDIO_FILE_FROM_LIST="loadedAudioFileFromList",wt.AUDIO_SPEED_UPDATED="audioSpeedUpdated",wt.AUDIO_DURATION_UPDATED="audioDurationUpdated";let Rt=class extends bt{constructor(e,t,i,r,n,s,o){super(),this.principalBuffer=null,this.fileList=null,this.fileListCurrIndex=0,this.loadingAudio=!1,this.renderingAudio=!1,this.filterManager=e,this.rendererManager=t,this.contextManager=i,this.saveBufferManager=r,this.audioProcessor=n,this.bufferManager=s,this.bufferPlayer=o}setup(){this.eventEmitter?(this.eventEmitter.on(exports.EventType.PLAYING_STARTED,(()=>r(this,void 0,void 0,(function*(){this.bufferPlayer&&this.bufferPlayer.compatibilityMode&&this.contextManager&&this.contextManager.currentContext&&this.audioProcessor&&(yield this.audioProcessor.setupOutput(this.principalBuffer,this.contextManager.currentContext))})))),this.eventEmitter.on(exports.EventType.PLAYING_FINISHED,(()=>{this.bufferPlayer&&this.bufferPlayer.loop&&this.bufferPlayer.start()})),this.eventEmitter.on(exports.EventType.PLAYING_FINISHED_LOOP_ALL,(()=>r(this,void 0,void 0,(function*(){this.bufferPlayer&&this.bufferPlayer.loopAll&&!this.renderingAudio&&!this.loadingAudio&&(yield this.loadNextAudio(!0),this.bufferPlayer.start())}))))):console.error("Event Emitter is not available!")}addFilters(...e){this.filterManager&&this.filterManager.addFilters(...e)}addRenderers(...e){this.rendererManager&&this.rendererManager.addRenderers(...e)}get currentSampleRate(){return this.contextManager?this.contextManager.currentSampleRate:0}get defaultDeviceSampleRate(){const e=new AudioContext,{sampleRate:t}=e;return e&&e.close(),t}loadBufferFromFile(e){return r(this,void 0,void 0,(function*(){if(this.loadingAudio=!0,this.audioProcessor&&(yield this.audioProcessor.prepareContext(this.principalBuffer)),!(this.contextManager&&this.contextManager.currentContext&&this.bufferDecoderService&&this.audioProcessor))throw this.loadingAudio=!1,new Error("Audio Context is not ready!");if(this.clearPrincipalBuffer(),this.principalBuffer=yield this.bufferDecoderService.decodeBufferFromFile(e),this.audioProcessor.initialRenderingDone=!1,!this.principalBuffer)throw this.loadingAudio=!1,new Error("Error decoding audio file");this.audioProcessor.sumInputBuffer=St.sumAudioBuffer(this.principalBuffer),this.audioProcessor.resetAudioRenderingProgress(),this.bufferPlayer&&this.bufferPlayer.loopAll&&this.totalFileList<=1&&this.bufferPlayer.toggleLoop(),this.loadingAudio=!1}))}loadFileList(e){return r(this,void 0,void 0,(function*(){this.fileList=e,yield this.loadBufferFromFileListIndex(0)}))}loadBufferFromFileListIndex(e){return r(this,void 0,void 0,(function*(){if(this.fileList){this.fileListCurrIndex=e;const t=this.fileList.item(this.fileListCurrIndex);this.eventEmitter&&this.eventEmitter.emit(exports.EventType.LOADED_AUDIO_FILE_FROM_LIST,e),t&&(yield this.loadBufferFromFile(t))}}))}loadPreviousAudio(e){return r(this,void 0,void 0,(function*(){const t=this.currentIndexFileList,i=this.totalFileList,r=t-1;r!=t&&(r<0?yield this.loadBufferFromFileListIndex(i-1):yield this.loadBufferFromFileListIndex(r),yield this.renderAudio(e))}))}loadNextAudio(e){return r(this,void 0,void 0,(function*(){const t=this.currentIndexFileList,i=this.totalFileList,r=t+1;r!=t&&(r>=i?yield this.loadBufferFromFileListIndex(0):yield this.loadBufferFromFileListIndex(r),yield this.renderAudio(e))}))}getCurrentFileList(){if(this.fileList){const e=new Map;for(let t=0;t<this.fileList.length;t++){const i=this.fileList.item(t);i&&e.set(i.name,this.currentIndexFileList===t)}return e}return new Map}get currentIndexFileList(){return this.fileListCurrIndex}get totalFileList(){return this.fileList?this.fileList.length:0}loadBuffer(e){this.principalBuffer=e,this.audioProcessor&&(this.audioProcessor.sumInputBuffer=St.sumAudioBuffer(this.principalBuffer),this.audioProcessor.initialRenderingDone=!1)}getOutputBuffer(){return this.audioProcessor?this.audioProcessor.renderedBuffer:null}renderAudio(e){return r(this,void 0,void 0,(function*(){if(this.audioProcessor)try{this.renderingAudio=!0,this.eventEmitter&&this.eventEmitter.emit(exports.EventType.STARTED_RENDERING_AUDIO);const t=yield this.audioProcessor.renderAudio(this.principalBuffer,e);return this.eventEmitter&&this.eventEmitter.emit(exports.EventType.AUDIO_RENDERING_FINISHED),this.renderingAudio=!1,t}catch(e){this.eventEmitter&&(this.eventEmitter.emit(exports.EventType.AUDIO_RENDERING_FINISHED),this.eventEmitter.emit(exports.EventType.AUDIO_RENDERING_EXCEPTION_THROWN,e)),this.renderingAudio=!1}return!1}))}isAudioWorkletAvailable(){return!(!this.contextManager||!this.contextManager.currentContext)&&St.isAudioWorkletCompatible(this.contextManager.currentContext)}getFiltersState(){return this.filterManager&&this.rendererManager?Object.assign(Object.assign({},this.filterManager.getFiltersState()),this.rendererManager.getRenderersState()):{}}getFiltersSettings(){return this.filterManager?this.filterManager.getFiltersSettings():new Map}reconnectNodesIfNeeded(){return r(this,void 0,void 0,(function*(){if(this.contextManager&&this.bufferPlayer&&this.bufferPlayer.compatibilityMode&&this.contextManager.currentContext&&this.principalBuffer&&this.filterManager&&this.filterManager.entrypointFilter&&(yield this.filterManager.connectNodes(this.contextManager.currentContext,this.principalBuffer,!0,this.bufferPlayer.compatibilityMode),this.audioProcessor)){const e=this.filterManager.entrypointFilter.getSpeed(),t=St.calculateAudioDuration(this.principalBuffer,this.filterManager,e);this.audioProcessor.updateAudioSpeedAndDuration(t)}}))}enableFilter(e){this.rendererManager&&this.rendererManager.enableRenderer(e),this.filterManager&&(this.filterManager.enableFilter(e),this.reconnectNodesIfNeeded())}disableFilter(e){this.rendererManager&&this.rendererManager.disableRenderer(e),this.filterManager&&(this.filterManager.disableFilter(e),this.reconnectNodesIfNeeded())}toggleFilter(e){this.rendererManager&&this.rendererManager.toggleRenderer(e),this.filterManager&&(this.filterManager.toggleFilter(e),this.reconnectNodesIfNeeded())}changeFilterSettings(e,t){return r(this,void 0,void 0,(function*(){this.filterManager&&(yield this.filterManager.changeFilterSettings(e,t),yield this.reconnectNodesIfNeeded())}))}resetFilterSettings(e){return r(this,void 0,void 0,(function*(){this.filterManager&&(yield this.filterManager.resetFilterSettings(e),yield this.reconnectNodesIfNeeded())}))}resetAllFiltersState(){this.rendererManager&&this.rendererManager.resetAllRenderersState(),this.filterManager&&(this.filterManager.resetAllFiltersState(),this.reconnectNodesIfNeeded())}exit(){this.bufferPlayer&&(this.bufferPlayer.stop(),this.bufferPlayer.reset()),this.cancelAudioRendering(),this.clearBuffers(),this.fileList=null,this.fileListCurrIndex=0}clearBuffers(){this.clearPrincipalBuffer(),this.clearRenderedBuffer()}clearPrincipalBuffer(){St.clearAudioBuffer(this.principalBuffer),this.principalBuffer=null}clearRenderedBuffer(){this.audioProcessor&&this.audioProcessor.clearRenderedBuffer()}cancelAudioRendering(){this.audioProcessor&&this.audioProcessor.cancelAudioRendering()}on(e,t){this.eventEmitter&&this.eventEmitter.on(e,t)}off(e,t){this.eventEmitter&&this.eventEmitter.off(e,t)}saveBuffer(e){var t;return this.saveBufferManager&&this.audioProcessor?null===(t=this.saveBufferManager)||void 0===t?void 0:t.saveBuffer(this.audioProcessor.renderedBuffer,e):Promise.resolve(!1)}set downloadingInitialData(e){this.bufferManager&&(this.bufferManager.downloadingInitialData=e)}get downloadingInitialData(){return!!this.bufferManager&&this.bufferManager.downloadingInitialData}};e([Et(),i("design:type",Function),i("design:paramtypes",[]),i("design:returntype",void 0)],Rt.prototype,"setup",null),Rt=e([gt(),t(0,vt(_t.FilterManager)),t(1,vt(_t.RendererManager)),t(2,vt(_t.AudioContextManager)),t(3,vt(_t.SaveBufferManager)),t(4,vt(_t.AudioProcessor)),t(5,vt(_t.BufferManager)),t(6,vt(_t.BufferPlayer)),i("design:paramtypes",[Object,Object,Object,Object,Object,Object,Object])],Rt);var Tt=Rt;let Ct=class extends bt{constructor(){super(...arguments),this.buffer=null,this.source=null,this.gainNode=null,this.intervals=[],this._volume=1,this._duration=0,this.currentTime=0,this.displayTime=0,this.playing=!1,this.loop=!1,this.loopAll=!1,this.speedAudio=1,this.compatibilityMode=!1,this.currentNode=null}setup(){this.eventEmitter?(this.eventEmitter.on(exports.EventType.AUDIO_SPEED_UPDATED,(e=>{e&&(this.speedAudio=e)})),this.eventEmitter.on(exports.EventType.AUDIO_DURATION_UPDATED,(e=>{e&&(this.duration=e)}))):console.error("Event Emitter is not available!")}init(e){this.playing=!1,this.contextManager&&this.contextManager.currentContext&&(this.contextManager.currentContext.resume(),!this.compatibilityMode&&this.buffer&&(null==this.source||e||(this.source.buffer=null,this.source.disconnect()),this.createGainNode(),this.duration=this.buffer.duration,this.source&&this.gainNode&&(this.source.connect(this.gainNode),this.gainNode.connect(this.contextManager.currentContext.destination)))),this.updateInfos()}createGainNode(){this.contextManager&&this.contextManager.currentContext&&(this.gainNode&&this.gainNode.disconnect(),this.source&&this.source.disconnect(),this.source=this.contextManager.currentContext.createBufferSource(),this.source.buffer=this.buffer,this.gainNode=this.contextManager.currentContext.createGain(),this.setGainNodeValue())}loadBuffer(e){this.compatibilityMode=!1,this.reset(),this.buffer=e,this.init()}setCompatibilityMode(e,t){this.compatibilityMode=!0,this.reset(),this.init(),null!=t&&(this.duration=t*this.speedAudio),this.currentNode=e,this.updateInfos()}reset(e){this.clearIntervals(),this.currentTime=0,this.displayTime=0,e||this.stop()}stop(){var e;this.clearIntervals(),null!=this.source&&null!=this.source&&this.playing&&(this.source.stop(0),this.playing=!1),this.currentNode&&(this.currentNode.disconnect(),this.compatibilityMode&&(this.currentTime=0,this.displayTime=0)),null===(e=this.eventEmitter)||void 0===e||e.emit(exports.EventType.PLAYING_STOPPED),this.updateInfos()}clearIntervals(){for(const e of this.intervals)clearInterval(e);this.intervals=[]}start(e){return r(this,void 0,void 0,(function*(){var t;if(this.source||this.compatibilityMode){if(e||this.stop(),this.init(e),yield null===(t=this.eventEmitter)||void 0===t?void 0:t.emit(exports.EventType.PLAYING_STARTED),this.compatibilityMode){if(!(this.currentNode&&this.contextManager&&this.contextManager.currentContext))return Promise.resolve();this.createGainNode(),this.gainNode?(this.currentNode.connect(this.gainNode),this.gainNode.connect(this.contextManager.currentContext.destination)):this.currentNode.connect(this.contextManager.currentContext.destination)}else{if(!this.source)return Promise.resolve();this.source.start(0,e?0:this.currentTime/this.speedAudio),this.playing=!0}let i=performance.now();this.intervals.push(window.setInterval((()=>{var t,r,n;const s=performance.now(),o=s-i;i=s,this.currentTime+=o/1e3*this.speedAudio,this.displayTime=this.currentTime,this.currentTime>this.duration?this.loop?this.compatibilityMode?null===(t=this.eventEmitter)||void 0===t||t.emit(exports.EventType.PLAYING_FINISHED):(this.reset(e),this.start()):(null===(r=this.eventEmitter)||void 0===r||r.emit(exports.EventType.PLAYING_FINISHED),this.reset(e),this.loopAll&&(null===(n=this.eventEmitter)||void 0===n||n.emit(exports.EventType.PLAYING_FINISHED_LOOP_ALL))):this.updateInfos()}),100))}return Promise.resolve()}))}playDirect(){return r(this,void 0,void 0,(function*(){this.compatibilityMode?yield this.start(!1):yield this.start(!0)}))}pause(){this.stop()}updateInfos(){var e;null===(e=this.eventEmitter)||void 0===e||e.emit(exports.EventType.PLAYING_UPDATE)}setTimePercent(e){this.compatibilityMode||(this.currentTime=Math.round(this.duration*(e/100)),this.displayTime=this.currentTime,this.playing?(this.pause(),this.start()):this.updateInfos())}setTime(e){this.compatibilityMode||(this.currentTime=e,this.displayTime=this.currentTime,this.playing?(this.pause(),this.start()):this.updateInfos())}set volume(e){this._volume=e,this.setGainNodeValue()}setGainNodeValue(){this.gainNode&&(this.gainNode.gain.value=Math.pow(this._volume,2))}get volume(){return this._volume}get duration(){return this._duration}set duration(e){this._duration=e*(this.speedAudio||1)}onBeforePlaying(e){this.eventEmitter&&this.eventEmitter.on(exports.EventType.PLAYING_STARTED,e)}toggleLoop(){this.loopAll=!1,this.loop=!this.loop}toggleLoopAll(){this.loop=!1,this.loopAll=!this.loopAll}on(e,t){this.eventEmitter&&this.eventEmitter.on(e,t)}get currentTimeDisplay(){return("0"+Math.trunc(this.displayTime/60)).slice(-2)+":"+("0"+Math.trunc(this.displayTime%60)).slice(-2)}get maxTimeDisplay(){return("0"+Math.trunc(this.duration/60)).slice(-2)+":"+("0"+Math.trunc(this.duration%60)).slice(-2)}get percent(){return 100-Math.round((this.duration-this.displayTime)/this.duration*100)}get remainingTimeDisplay(){return("0"+Math.trunc((this.duration-this.displayTime)/60)).slice(-2)+":"+("0"+Math.trunc((this.duration-this.displayTime)%60)).slice(-2)}};e([Et(),i("design:type",Function),i("design:paramtypes",[]),i("design:returntype",void 0)],Ct.prototype,"setup",null),Ct=e([gt()],Ct);var It=Ct;class Nt{constructor(e,t){this.seconds=0,this.initialSeconds=0,this.interval=null,this.incr=1,this.countCallback=()=>{},this.seconds=e,this.initialSeconds=e,this.incr=t}start(){this.interval=window.setInterval((()=>this.count()),1e3)}stop(){clearInterval(this.interval)}count(){this.seconds+=this.incr,this.seconds<=0&&this.stop(),this.countCallback&&this.countCallback()}onCount(e){this.countCallback=e}}const Mt={REVERB:"reverb",ECHO:"echo",BASS_BOOST:"bassboost",BITCRUSHER:"bitcrusher",HIGH_PASS:"highpass",LIMITER:"limiter",LOW_PASS:"lowpass",RENDERING_PROGRESS_CALCULATION:"renderingProgressCalculationFilter",RETURN_AUDIO:"returnAudio",SOUNDTOUCH:"soundtouch",TELEPHONIZER:"telephonizer",VOCODER:"vocoder"},Pt={AUDIO_EDITOR:"audioEditor",VOICE_RECORDER:"voiceRecorder",BUFFER_PLAYER:"bufferPlayer",AUDIO_CONTEXT_MANAGER:"audioContextManager",AUDIO_PROCESSOR:"audioProcessor",BUFFER_MANAGER:"bufferManager",FILTER_MANAGER:"filterManager",RENDERER_MANAGER:"rendererManager",SAVE_BUFFER_MANAGER:"saveBufferManager",EXPORT_WAV_COMMAND:"exportWAV",EXPORT_MP3_COMMAND:"exportMP3",AUDIO_WAV:"audio/wav",AUDIO_MP3:"audio/mp3",RECORD_COMMAND:"record",INIT_COMMAND:"init",FILTERS_NAMES:Mt,WORKLET_PATHS:{BITCRUSHER:"BitCrusher.worklet.js",LIMITER:"Limiter.worklet.js",SOUNDTOUCH:"Soundtouch.worklet.js",RECORDER_WORKLET:"RecorderWorklet.js",RENDERING_PROGRESS_CALCULATION:"RenderingProgressCalculation.worklet.js"},WORKLET_NAMES:{BITCRUSHER:"bitcrusher-processor",LIMITER:"limiter-processor",SOUNDTOUCH:"soundtouch-processor",RECORDER_WORKLET:"recorder-worklet",RENDERING_PROGRESS_CALCULATION:"rendering-progress-calculation-worklet"},PREFERENCES_KEYS:{COMPATIBILITY_MODE_ENABLED:"compatibility-mode-enabled",COMPATIBILITY_MODE_CHECKED:"compatibility-mode-checked",ENABLE_AUDIO_WORKLET:"enable-audio-worklet",ENABLE_SOUNDTOUCH_AUDIO_WORKLET:"enable-soundtouch-audio-worklet",BUFFER_SIZE:"buffer-size",SAMPLE_RATE:"sample-rate",DISABLE_INITIAL_RENDERING:"disable-initial-rendering",BITRATE_MP3:"bitrate-mp3"},ENABLE_SOUNDTOUCH_AUDIO_WORKLET:!0,ENABLE_AUDIO_WORKLET:!0,ENABLE_RECORDER_AUDIO_WORKLET:!0,SOUNDTOUCH_PITCH_SHIFTER_BUFFER_SIZE:16384,SOUNDTOUCH_DEFAULT_SPEED:1,SOUNDTOUCH_DEFAULT_FREQUENCY:1,SOUNDTOUCH_DEFAULT_PITCH_SEMITONES:0,DEFAULT_REVERB_ENVIRONMENT:{name:"Medium Damping Cave E002 M2S",url:"impulse_response.wav",size:1350278,addDuration:4,link:"http://www.cksde.com/p_6_250.htm"},VOCODER_MODULATOR:"modulator.mp3",DEFAULT_BUFFER_SIZE:0,VALID_BUFFER_SIZE:[0,256,512,1024,2048,4096,8192,16384],VALID_MP3_BITRATES:[32,64,96,128,160,256,320],DEFAULT_SAMPLE_RATE:0,VALID_SAMPLE_RATES:[0,8e3,11025,16e3,22050,32e3,44100,48e3,88200,96e3,176400,192e3],TREATMENT_TIME_COUNTING_THROTTLE_INTERVAL:100,TREATMENT_TIME_COUNTING_SMOOTHING_FACTOR:.9,DISABLE_INITIAL_RENDERING:!1,DEFAULT_SAVE_FORMAT:"wav",DEFAULT_MP3_BITRATE:320};function Dt(e){return new Worker((e||"")+"RecorderWorker.js")}let Bt=class{constructor(e){this.worker=null,this.node=null,this.context=null,this.config={bufferLen:4096,sampleRate:44100,numChannels:2,mimeType:"audio/wav",workletBasePath:"worklets/",workerBasePath:"workers/",bitrate:Pt.DEFAULT_MP3_BITRATE,callback:()=>{}},this.callbacks={getBuffer:[],exportWAV:[],exportMP3:[]},this.recording=!1,Object.assign(this.config,e)}setup(e){return r(this,void 0,void 0,(function*(){this.node&&(this.node instanceof AudioWorkletNode&&this.node.port.postMessage("stop"),this.node.disconnect()),e&&(this.context=e.context,yield this.createRecorderNode(),this.node&&this.context&&(e.connect(this.node),this.node.connect(this.context.destination))),this.context&&!this.worker&&(this.worker=Dt(this.config.workerBasePath),this.worker&&(this.worker.postMessage({command:"init",config:{sampleRate:this.context.sampleRate,numChannels:this.config.numChannels,bitrate:this.config.bitrate}}),this.worker.onmessage=e=>{let t=null;switch(e.data.command){case"getBuffer":t=this.callbacks.getBuffer;break;case Pt.EXPORT_WAV_COMMAND:t=this.callbacks.exportWAV;break;case Pt.EXPORT_MP3_COMMAND:t=this.callbacks.exportMP3}if(t){const i=t.pop();"function"==typeof i&&i(e.data.data)}}))}))}createRecorderNode(){return r(this,void 0,void 0,(function*(){if(this.context)if(St.isAudioWorkletCompatible(this.context)&&Pt.ENABLE_RECORDER_AUDIO_WORKLET)try{yield this.createRecorderWorklet()}catch(e){console.error(e),this.createRecorderScriptProcessorNode()}else this.createRecorderScriptProcessorNode()}))}createRecorderWorklet(){return r(this,void 0,void 0,(function*(){if(this.context&&(yield this.context.audioWorklet.addModule(this.config.workletBasePath+Pt.WORKLET_PATHS.RECORDER_WORKLET),this.node=new AudioWorkletNode(this.context,Pt.WORKLET_NAMES.RECORDER_WORKLET),this.node&&this.node.port)){const e=this.node.parameters.get("numChannels");e&&(e.value=this.config.numChannels,e.setValueAtTime(this.config.numChannels,0)),this.node.port.onmessage=e=>{this.worker&&"record"==e.data.command&&e.data.buffer.length>0&&this.worker.postMessage({command:"record",buffer:e.data.buffer})}}}))}createRecorderScriptProcessorNode(){this.context&&(this.node=this.context.createScriptProcessor.call(this.context,this.config.bufferLen,this.config.numChannels,this.config.numChannels),this.node.onaudioprocess=e=>{if(!this.recording)return;const t=[];for(let i=0;i<this.config.numChannels;i++)t.push(e.inputBuffer.getChannelData(i));this.worker&&this.worker.postMessage({command:"record",buffer:t})})}record(){this.recording=!0,this.node instanceof AudioWorkletNode&&this.node.port.postMessage("record")}stop(){this.recording=!1,this.node instanceof AudioWorkletNode&&this.node.port.postMessage("stop")}clear(){this.worker&&this.worker.postMessage({command:"clear"})}kill(){this.clear(),this.stop(),this.worker&&this.worker.terminate()}getBuffer(e){if(!(e=e||this.config.callback))throw new Error("Callback not set");this.callbacks.getBuffer.push(e),this.worker&&this.worker.postMessage({command:"getBuffer"})}exportWAV(e,t){if(t=t||this.config.mimeType,!(e=e||this.config.callback))throw new Error("Callback not set");this.callbacks.exportWAV.push(e),this.worker&&this.worker.postMessage({command:Pt.EXPORT_WAV_COMMAND,type:t})}exportMP3(e,t){if(t=t||this.config.mimeType,!(e=e||this.config.callback))throw new Error("Callback not set");this.callbacks.exportMP3.push(e),this.worker&&this.worker.postMessage({command:Pt.EXPORT_MP3_COMMAND,type:t})}};Bt=e([gt(),i("design:paramtypes",[Object])],Bt);var Ot=Bt;let Ft=class extends bt{constructor(e,t){super(),this.recorder=null,this.input=null,this.stream=null,this.alreadyInit=!1,this.timer=null,this.enableAudioFeedback=!1,this.recording=!1,this.deviceList=[],this.constraints={audio:{noiseSuppression:!0,echoCancellation:!0,autoGainControl:!0,sampleRate:{ideal:44100}}},this.sampleRateConfigNotSupported=!1,this.contextManager=e,this.configService=t}init(){return r(this,void 0,void 0,(function*(){var e;if(this.isRecordingAvailable()){this.sampleRateConfigNotSupported=!navigator.mediaDevices.getSupportedConstraints().sampleRate,this.contextManager&&(this.sampleRateConfigNotSupported?this.contextManager.createNewContext(0):this.contextManager.createNewContextIfNeeded()),null===(e=this.eventEmitter)||void 0===e||e.emit(exports.EventType.RECORDER_INIT);try{const e=yield navigator.mediaDevices.getUserMedia(this.constraints);this.contextManager&&this.contextManager.currentContext&&this.contextManager.currentContext.resume(),yield this.setup(e,!1,!1),this.alreadyInit=!0,this.timer=new Nt(0,1),this.timer.onCount((()=>{var e;null===(e=this.eventEmitter)||void 0===e||e.emit(exports.EventType.RECORDER_COUNT_UPDATE)})),this.successCallback()}catch(e){console.error(e);if(e)switch(e.name){case"SecurityError":case"NotAllowedError":this.errorCallback();break;case"NotFoundError":this.notFoundErrorCallback();break;case"NotSupportedError":this.sampleRateConfigNotSupported||(this.sampleRateConfigNotSupported=!0,this.init());break;default:this.unknownErrorCallback()}}navigator.mediaDevices.ondevicechange=()=>this.updateInputList()}}))}successCallback(){var e;null===(e=this.eventEmitter)||void 0===e||e.emit(exports.EventType.RECORDER_SUCCESS)}errorCallback(){var e;null===(e=this.eventEmitter)||void 0===e||e.emit(exports.EventType.RECORDER_ERROR)}notFoundErrorCallback(){var e;null===(e=this.eventEmitter)||void 0===e||e.emit(exports.EventType.RECORDER_NOT_FOUND_ERROR)}unknownErrorCallback(){var e;null===(e=this.eventEmitter)||void 0===e||e.emit(exports.EventType.RECORDER_UNKNOWN_ERROR)}audioFeedback(e){var t;this.contextManager&&this.contextManager.currentContext&&(e?(this.input&&this.input.connect(this.contextManager.currentContext.destination),this.enableAudioFeedback=!0):(this.input&&(this.input.connect(this.contextManager.currentContext.destination),this.input.disconnect(this.contextManager.currentContext.destination)),this.enableAudioFeedback=!1),null===(t=this.eventEmitter)||void 0===t||t.emit(exports.EventType.RECORDER_UPDATE_CONSTRAINTS))}getConstraints(){if(this.stream){const e=this.stream.getTracks();if(e&&e.length>0)return e[0].getSettings()}return null}updateConstraints(){var e;const t=this.getConstraints();t&&(this.constraints.audio=Object.assign(this.constraints.audio,t),null===(e=this.eventEmitter)||void 0===e||e.emit(exports.EventType.RECORDER_UPDATE_CONSTRAINTS))}resetConstraints(e){return r(this,void 0,void 0,(function*(){if(this.stream){const t=this.enableAudioFeedback,i=this.recording,r=this.stream.getTracks();if(e&&(this.updateConstraints(),this.constraints.audio=Object.assign(this.constraints.audio,e.audio)),r&&r.length>0)try{yield r[0].applyConstraints(this.constraints.audio);const n=this.getConstraints(),s=e?Object.keys(e.audio)[0]:"";if(this.audioFeedback(!1),this.pause(),!e||n&&n[s]!=e.audio[s]){this.stopStream();const e=yield navigator.mediaDevices.getUserMedia(this.constraints);yield this.setup(e,i,t)}else yield this.setup(null,i,t)}catch(e){console.error(e),this.errorCallback()}}}))}setup(e,t,i){return r(this,void 0,void 0,(function*(){e&&this.contextManager&&this.contextManager.currentContext&&(this.input=this.contextManager.currentContext.createMediaStreamSource(e),this.stream=e),this.recorder&&this.input&&(yield this.recorder.setup(this.input),t&&(yield this.record())),this.audioFeedback(i),this.updateConstraints(),yield this.updateInputList()}))}setNoiseSuppression(e){this.resetConstraints({audio:{noiseSuppression:e}})}setAutoGain(e){this.resetConstraints({audio:{autoGainControl:e}})}setEchoCancellation(e){this.resetConstraints({audio:{echoCancellation:e}})}updateInputList(){return r(this,void 0,void 0,(function*(){if(this.deviceList){const e=yield navigator.mediaDevices.enumerateDevices();this.deviceList=[],e.forEach((e=>{"audioinput"==e.kind&&this.deviceList.push(e)}))}}))}changeInput(e,t){t&&(this.constraints.audio.deviceId=e,this.constraints.audio.groupId=t,this.resetConstraints())}record(){return r(this,void 0,void 0,(function*(){this.alreadyInit&&this.configService&&this.input&&(this.recorder||(this.recorder=new Ot({bufferLen:this.configService.getBufferSize(),sampleRate:this.configService.getSampleRate(),numChannels:2,workletBasePath:this.configService.getWorkletBasePath(),workerBasePath:this.configService.getWorkerBasePath(),mimeType:"audio/wav"}),yield this.recorder.setup(this.input)),this.recorder&&this.recorder.record(),this.timer&&this.timer.start(),this.recording=!0,this.eventEmitter&&this.eventEmitter.emit(exports.EventType.RECORDER_RECORDING))}))}stop(){this.alreadyInit&&this.recorder&&(this.recorder.stop(),this.timer&&this.timer.stop(),this.recording=!1,this.recorder.getBuffer((e=>{var t;if(this.contextManager&&this.contextManager.currentContext){this.contextManager.currentContext.resume();const i=this.contextManager.currentContext.createBuffer(2,e[0].length,this.contextManager.currentContext.sampleRate);i.getChannelData(0).set(e[0]),i.getChannelData(1).set(e[1]),null===(t=this.eventEmitter)||void 0===t||t.emit(exports.EventType.RECORDER_STOPPED,i),this.reset()}})))}pause(){var e;this.alreadyInit&&(this.recorder&&this.recorder.stop(),this.timer&&this.timer.stop(),this.recording=!1,null===(e=this.eventEmitter)||void 0===e||e.emit(exports.EventType.RECORDER_PAUSED))}stopStream(){if(this.stream){const e=this.stream.getTracks();for(let t=0,i=e.length;t<i;t++)e[t].stop()}}reset(){var e;this.recorder&&this.recorder.kill(),this.timer&&this.timer.stop(),this.audioFeedback(!1),this.stopStream(),this.input=null,this.recorder=null,this.stream=null,this.alreadyInit=!1,this.timer=null,null===(e=this.eventEmitter)||void 0===e||e.emit(exports.EventType.RECORDER_RESETED)}get currentTimeDisplay(){var e,t,i;return(null===(e=this.timer)||void 0===e?void 0:e.seconds)?("0"+Math.trunc((null===(t=this.timer)||void 0===t?void 0:t.seconds)/60)).slice(-2)+":"+("0"+Math.trunc((null===(i=this.timer)||void 0===i?void 0:i.seconds)%60)).slice(-2):"00:00"}get currentTime(){return this.timer?this.timer.seconds:0}getSettings(){return{deviceList:this.deviceList,audioFeedback:this.enableAudioFeedback,constraints:this.constraints.audio}}on(e,t){var i;null===(i=this.eventEmitter)||void 0===i||i.on(e,t)}isRecordingAvailable(){return void 0!==navigator.mediaDevices&&void 0!==navigator.mediaDevices.getUserMedia}};Ft=e([gt(),t(0,vt(_t.AudioContextManager)),t(1,vt(_t.ConfigService)),i("design:paramtypes",[Object,Object])],Ft);var xt=Ft;let kt=class extends bt{constructor(){super(...arguments),this.enabled=!1,this.defaultEnabled=!1}isEnabled(){return this.enabled}isDefaultEnabled(){return this.defaultEnabled}setDefaultEnabled(e){this.defaultEnabled=e,e?this.enable():this.disable()}setEnabled(e){this.enabled=e}enable(){this.setEnabled(!0)}disable(){this.setEnabled(!1)}toggle(){this.setEnabled(!this.isEnabled())}};kt=e([gt()],kt);var Lt=kt;class Gt extends Lt{constructor(){super(...arguments),this.defaultSettings=null,this._totalSamples=0}getAddingTime(){return 0}initializeDefaultSettings(){this.defaultSettings=this.getSettings()}getDefaultSettings(){return this.defaultSettings}resetSettings(){return r(this,void 0,void 0,(function*(){if(this.defaultSettings)for(const e in this.defaultSettings)this.defaultSettings&&void 0!==this.defaultSettings[e]&&(yield this.setSetting(e,this.defaultSettings[e]))}))}isWorklet(){return!1}bufferFetcherReseted(){return Promise.resolve(!1)}set totalSamples(e){this._totalSamples=e}}class Ut{constructor(e,t){this._value=0,this._minValue=0,this._maxValue=Number.MAX_SAFE_INTEGER,this._defaultValue=0,this.context=null,this.automationRate="a-rate",this._defaultValue=void 0!==t?t:0,this._value=this._defaultValue,this.context=e}get value(){return this._value}set value(e){this._value=Math.max(this._minValue,Math.min(this._maxValue,e))}get minValue(){return this._minValue}get maxValue(){return this._maxValue}get defaultValue(){return this._defaultValue}setValueAtTime(e,t){return console.warn("setValueAtTime used with AudioParamPolyfill, is not fully compatible with standard AudioParam"),this.value=e,new Ut(this.context,e)}linearRampToValueAtTime(e,t){return console.warn("linearRampToValueAtTime used with AudioParamPolyfill, is not fully compatible with standard AudioParam"),this.value=e,new Ut(this.context,e)}exponentialRampToValueAtTime(e,t){return console.warn("exponentialRampToValueAtTime used with AudioParamPolyfill, is not fully compatible with standard AudioParam"),this.value=e,new Ut(this.context,e)}cancelAndHoldAtTime(e){throw new Error("Method not implemented.")}cancelScheduledValues(e){throw new Error("Method not implemented.")}setTargetAtTime(e,t,i){throw new Error("Method not implemented.")}setValueCurveAtTime(e,t,i){throw new Error("Method not implemented.")}}class Wt{constructor(e,t,i){this._parameters=new Map,this._port=null,this.currentContext=null,this.workletProcessor=t,this.currentContext=e,this._scriptProcessorNode=e.createScriptProcessor(i,2,2),this.setupPort(),this.setupProcessor(),this.setupWorkletScope(e)}setupPort(){const e=new MessageChannel;e.port1.onmessage=e=>{this.workletProcessor&&this.workletProcessor.port2&&this.workletProcessor.port2.postMessage(e.data)},this.workletProcessor&&this.workletProcessor.port2&&(this.workletProcessor.port2.onmessage=t=>{e.port1.postMessage(t.data)}),this._port=e.port2}setupProcessor(){if(!this._scriptProcessorNode)return;this._scriptProcessorNode.onaudioprocess=e=>{if(this.workletProcessor){const t=[St.convertAudioBufferToFloat32Array(e.inputBuffer)],i=[St.convertAudioBufferToFloat32Array(e.outputBuffer)],r=[];for(const[e,t]of this._parameters.entries())r.push([e,St.convertAudioParamToFloat32Array(t,1)]);const n=Object.fromEntries(r);this.workletProcessor.process(t,i,n)}};const e=this.workletProcessor.defaultParameterDescriptors;e&&e.forEach((e=>{this.currentContext&&this._parameters.set(e.name,new Ut(this.currentContext,e.defaultValue))}))}setupWorkletScope(e){"undefined"!=typeof window&&(window.sampleRate=e.sampleRate)}get port(){return this._port}get parameters(){return this._parameters}get node(){return this._scriptProcessorNode}get context(){var e;return null===(e=this._scriptProcessorNode)||void 0===e?void 0:e.context}}class Vt{static registerProcessor(e,t){Vt.processorsMap.set(e,t)}static getProcessor(e){const t=Vt.processorsMap.get(e);return t?new t:null}}Vt.processorsMap=new Map;class jt{constructor(){this.messageChannel=null,this.messageChannel=new MessageChannel}process(e,t,i){return!0}get port(){return this.messageChannel&&this.messageChannel.port1}get port2(){return this.messageChannel&&this.messageChannel.port2}get parameters(){throw new Error("Method not implemented.")}get parameterDescriptors(){throw new Error("Method not implemented.")}get defaultParameterDescriptors(){return[]}}"undefined"==typeof window||"AudioWorkletProcessor"in window||(window.AudioWorkletProcessor=jt,window.registerProcessor=Vt.registerProcessor),"undefined"==typeof global||"AudioWorkletProcessor"in global||(global.AudioWorkletProcessor=jt,global.registerProcessor=Vt.registerProcessor);class qt extends Gt{constructor(){super(...arguments),this.currentWorkletNode=null,this.fallbackToScriptProcessor=!1,this.keepCurrentNodeIfPossible=!1,this.loadedModulesMap=new WeakMap}initializeWorklet(e){return r(this,void 0,void 0,(function*(){if(this.stop(),!St.isAudioWorkletCompatible(e))return console.error("Audio Worklets not supported on this browser. Fallback to ScriptProcessor"),void(this.fallbackToScriptProcessor=!0);const t=(this.configService?this.configService.getWorkletBasePath():"")+this.workletPath,i=this.loadedModulesMap.get(e);i&&i.has(t)||(yield e.audioWorklet.addModule(t).then((()=>{const r=null!=i?i:new Set;i||this.loadedModulesMap.set(e,r),r.add(t)})).catch((e=>{console.error(`Error when loading Worklet (${t}) for filter ${this.id}. Fallback to ScriptProcessor. Exception:`,e),this.fallbackToScriptProcessor=!0})))}))}isAudioWorkletEnabled(){return this.configService?this.configService.isAudioWorkletEnabled():Pt.ENABLE_AUDIO_WORKLET}isAudioWorkletAvailable(){return this.isAudioWorkletEnabled()&&!this.fallbackToScriptProcessor}initializeNode(e,t){if(this.isAudioWorkletAvailable())this.currentWorkletNode=new AudioWorkletNode(e,t);else{const i=Vt.getProcessor(t);if(!i)throw new Error(`No processor registered with name ${t} for filter ${this.id} to use the fallback/polyfill for AudioWorklet. Make sure you have created the class.`);this.currentWorkletNode=new Wt(e,i,this.configService.getBufferSize())}this.currentWorkletNode&&this.currentWorkletNode.port&&(this.currentWorkletNode.port.onmessage=e=>this.receiveEvent(e))}applyCurrentSettingsToWorklet(){const e=this.getSettings();for(const t of Object.keys(e))this.setWorkletSetting(t,e[t])}setWorkletSetting(e,t){if(this.currentWorkletNode&&this.currentWorkletNode.parameters){const i=this.currentWorkletNode.parameters.get(e);i&&(i.value=t,i.setValueAtTime(t,0))}}getNode(e){if(this.keepCurrentNodeIfPossible&&this.currentWorkletNode&&this.currentWorkletNode.context==e||(this.stop(),this.initializeNode(e,this.workletName)),this.applyCurrentSettingsToWorklet(),this.setEnabled(this.isEnabled()),this.currentWorkletNode)return this.currentWorkletNode instanceof Wt?{input:this.currentWorkletNode.node,output:this.currentWorkletNode.node}:{input:this.currentWorkletNode,output:this.currentWorkletNode};throw new Error("Worklet node has not yet been created")}stop(){this.currentWorkletNode&&this.currentWorkletNode.port&&(this.currentWorkletNode.port.postMessage("stop"),this.currentWorkletNode.port.close(),this.currentWorkletNode.port.onmessage=null),this.currentWorkletNode=null}setEnabled(e){this.currentWorkletNode&&this.currentWorkletNode.port&&this.currentWorkletNode.port.postMessage(e?"enable":"disable"),super.setEnabled(e)}isWorklet(){return!0}}class Ht extends Lt{}let Kt=class{constructor(){this._listeners={},this._listeners={}}on(e,t){this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push(t)}emit(e,t){return r(this,void 0,void 0,(function*(){if(this._listeners[e])for(const i of this._listeners[e])yield i(t)}))}off(e,t){this._listeners[e]&&(this._listeners[e]=this._listeners[e].filter((e=>e!==t)))}get listeners(){return this._listeners}set listeners(e){this._listeners=e}};Kt=e([gt(),i("design:paramtypes",[])],Kt);var Yt=Kt;let $t=class{constructor(){this.mapConfig=new Map,this.workerBasePath="",this.workletBasePath="",this.soundBasePath=""}getConfig(e){return this.mapConfig.get(e)}setConfig(e,t){this.mapConfig.set(e,t)}isCompatibilityModeEnabled(){return"true"==this.getConfig(Pt.PREFERENCES_KEYS.COMPATIBILITY_MODE_ENABLED)}isCompatibilityModeChecked(){return"true"==this.getConfig(Pt.PREFERENCES_KEYS.COMPATIBILITY_MODE_CHECKED)}isAudioWorkletEnabled(){const e=this.getConfig(Pt.PREFERENCES_KEYS.ENABLE_AUDIO_WORKLET);return null!=e?"true"==e:Pt.ENABLE_AUDIO_WORKLET}isSoundtouchAudioWorkletEnabled(){const e=this.getConfig(Pt.PREFERENCES_KEYS.ENABLE_SOUNDTOUCH_AUDIO_WORKLET);return null!=e?"true"==e:Pt.ENABLE_SOUNDTOUCH_AUDIO_WORKLET}getBufferSize(){const e=this.getConfig(Pt.PREFERENCES_KEYS.BUFFER_SIZE);return null!=e?parseInt(e,10):Pt.DEFAULT_BUFFER_SIZE}getSampleRate(){const e=this.getConfig(Pt.PREFERENCES_KEYS.SAMPLE_RATE);return null!=e?parseInt(e,10):Pt.DEFAULT_SAMPLE_RATE}getBitrateMP3(){const e=this.getConfig(Pt.PREFERENCES_KEYS.BITRATE_MP3);return null!=e?parseInt(e,10):Pt.DEFAULT_MP3_BITRATE}enableCompatibilityMode(){this.setConfig(Pt.PREFERENCES_KEYS.COMPATIBILITY_MODE_ENABLED,"true")}disableCompatibilityMode(){this.setConfig(Pt.PREFERENCES_KEYS.COMPATIBILITY_MODE_ENABLED,"false")}getWorkletBasePath(){return this.workletBasePath}getWorkerBasePath(){return this.workerBasePath}getSoundBasePath(){return this.soundBasePath}setWorkletBasePath(e){this.workletBasePath=e}setWorkerBasePath(e){this.workerBasePath=e}setSoundBasePath(e){this.soundBasePath=e}isInitialRenderingDisabled(){const e=this.getConfig(Pt.PREFERENCES_KEYS.DISABLE_INITIAL_RENDERING);return null!=e?"true"==e:Pt.DISABLE_INITIAL_RENDERING}};$t=e([gt()],$t);var zt=$t;let Qt=class{constructor(e,t){this.previousSampleRate=Pt.DEFAULT_SAMPLE_RATE,this.eventEmitter=e||new Yt,this.configService=t,this.setup()}setup(){this.configService&&(this.previousSampleRate=this.configService.getSampleRate(),this.eventEmitter&&this.eventEmitter.emit(exports.EventType.SAMPLE_RATE_CHANGED,this.previousSampleRate)),this.currentContext||this.createNewContext(this.previousSampleRate)}createNewContextIfNeeded(e){if(this.configService&&this.configService.isCompatibilityModeEnabled()&&e){if(this.currentSampleRate!=e.sampleRate)return this.createNewContext(e.sampleRate),!0}else{let e=Pt.DEFAULT_SAMPLE_RATE;if(this.configService&&(e=this.configService.getSampleRate()),e!=this.previousSampleRate)return this.createNewContext(e),!0}return!1}createNewContext(e){this._currentContext&&this._currentContext.close();const t={latencyHint:"interactive"};0!=e&&(t.sampleRate=e),this._currentContext=new AudioContext(t),this.eventEmitter&&this.eventEmitter.emit(exports.EventType.SAMPLE_RATE_CHANGED,this.currentSampleRate),this.previousSampleRate=e}createOfflineAudioContext(e,t,i){const r=document.createElement("iframe");r.style.display="none",document.body.appendChild(r);const n=r.contentWindow;if(!n)throw new Error("Failed to create isolated OfflineAudioContext");const s=new(0,n.OfflineAudioContext)(e,t,i);return s.addEventListener("complete",(()=>{setTimeout((()=>document.body.removeChild(r)))})),s}get currentSampleRate(){return this.currentContext?this.currentContext.sampleRate:0}get currentContext(){return this._currentContext}};Qt=e([gt(),t(0,vt(_t.EventEmitter)),t(1,vt(_t.ConfigService)),i("design:paramtypes",[Object,Object])],Qt);var Xt=Qt;let Zt=class extends bt{constructor(e,t,i,r){super(),this._renderedBuffer=null,this.audioRenderingLastCanceled=!1,this.initialRenderingDone=!1,this.sumInputBuffer=0,this.bufferPlayer=i,this.filterManager=e,this.rendererManager=t,this.bufferManager=r}prepareContext(e){return r(this,void 0,void 0,(function*(){if(this.contextManager){this.contextManager.createNewContextIfNeeded(e)&&this.bufferManager&&(yield this.bufferManager.resetBufferFetcher()),this.contextManager.currentContext&&this.contextManager.currentContext.resume()}}))}updateAudioSpeedAndDuration(e){if(this.eventEmitter){if(this.filterManager&&this.filterManager.entrypointFilter){const e=this.filterManager.entrypointFilter.getSpeed();this.eventEmitter.emit(exports.EventType.AUDIO_SPEED_UPDATED,e)}null!=e&&this.eventEmitter.emit(exports.EventType.AUDIO_DURATION_UPDATED,e)}}resetAudioRenderingProgress(){this.eventEmitter&&(this.eventEmitter.emit(exports.EventType.UPDATE_AUDIO_TREATMENT_PERCENT,0),this.eventEmitter.emit(exports.EventType.UPDATE_REMAINING_TIME_ESTIMATED,-1)),this.filterManager&&this.filterManager.disableFilter(Pt.FILTERS_NAMES.RENDERING_PROGRESS_CALCULATION)}startRenderingProgressCalculation(){this.filterManager&&this.filterManager.enableFilter(Pt.FILTERS_NAMES.RENDERING_PROGRESS_CALCULATION)}renderAudio(e,t){return r(this,void 0,void 0,(function*(){if(yield this.prepareContext(e),!this.contextManager||!this.contextManager.currentContext)throw new Error("AudioContext is not yet available");if(!this.filterManager)throw new Error("Filter manager is not available");if(!this.rendererManager)throw new Error("Renderer manager is not available");if(!this.filterManager.entrypointFilter)throw new Error("Entrypoint filter is not available");if(!e)throw new Error("No principal buffer available");if(this.eventEmitter&&this.eventEmitter.emit(exports.EventType.AUDIO_SPEED_UPDATED,1),!this.initialRenderingDone&&this.configService&&this.configService.isInitialRenderingDisabled()&&!this.configService.isCompatibilityModeEnabled()&&!t)return this.loadInitialBuffer(e),this.initialRenderingDone=!0,!0;this.configService&&this.bufferPlayer&&!this.configService.isCompatibilityModeEnabled()&&this.bufferPlayer.compatibilityMode&&this.bufferPlayer.stop(),this.currentOfflineContext=null,this.audioRenderingLastCanceled=!1;const i=this.filterManager.entrypointFilter.getSpeed(),r=St.calculateAudioDuration(e,this.filterManager,i),n=this.configService&&this.configService.isCompatibilityModeEnabled()?this.contextManager.currentContext:this.contextManager.createOfflineAudioContext(2,this.contextManager.currentContext.sampleRate*r,this.contextManager.currentContext.sampleRate);return this._renderedBuffer=yield this.rendererManager.executeAudioRenderers(e,n),this.resetAudioRenderingProgress(),this.filterManager.setupTotalSamples(r,this.contextManager.currentContext),this.setupOutput(e,n,r)}))}setupOutput(e,t,i){return r(this,void 0,void 0,(function*(){if(this._renderedBuffer&&this.configService&&this.eventEmitter&&this.bufferPlayer&&this.filterManager){const r=this.configService.isCompatibilityModeEnabled();if(r||this.startRenderingProgressCalculation(),yield this.filterManager.initializeWorklets(t),yield this.filterManager.connectNodes(t,this._renderedBuffer,!1,this.configService.isCompatibilityModeEnabled()),!r&&this.filterManager.currentNodes){const r=t;this.currentOfflineContext=r,this.filterManager.currentNodes.output.connect(t.destination);const n=yield r.startRendering();if(this.cleanupAfterOfflineRendering(),this.contextManager&&!this.loadRenderedAudio(e,n))return this.setupOutput(e,this.contextManager.currentContext,i);if(this.audioRenderingLastCanceled)return!1;this.eventEmitter.emit(exports.EventType.OFFLINE_AUDIO_RENDERING_FINISHED)}else this.filterManager.currentNodes&&(this.bufferPlayer.setCompatibilityMode(this.filterManager.currentNodes.output),this.updateAudioSpeedAndDuration(i),this.initialRenderingDone=!0);return this.eventEmitter&&this.eventEmitter.emit(exports.EventType.AUDIO_RENDERING_FINISHED),!0}return!1}))}cancelAudioRendering(){this.currentOfflineContext&&!this.audioRenderingLastCanceled&&this.filterManager&&(this.audioRenderingLastCanceled=!0,this.filterManager.disconnectOldNodes(!1),this.eventEmitter&&this.eventEmitter.emit(exports.EventType.CANCELLING_AUDIO_PROCESSING))}cleanupAfterOfflineRendering(){this.filterManager&&(this.filterManager.clearWorklets(),this.filterManager.disconnectOldNodes(!1)),this.currentOfflineContext&&(this.currentOfflineContext.destination.disconnect(),this.currentOfflineContext=null)}loadRenderedAudio(e,t){if(this.eventEmitter&&this.bufferPlayer){if(this.audioRenderingLastCanceled)this.initialRenderingDone||(this.loadInitialBuffer(e),this.eventEmitter.emit(exports.EventType.CANCELLED_AND_LOADED_INITIAL_AUDIO));else{if(0==St.sumAudioBuffer(t)&&0!==this.sumInputBuffer){if(this.configService&&!this.configService.isCompatibilityModeChecked())return this.setCompatibilityModeChecked(!0),this.configService.enableCompatibilityMode(),this.eventEmitter.emit(exports.EventType.COMPATIBILITY_MODE_AUTO_ENABLED),console.warn("Compatibility mode has been automatically enabled because a problem has been detected with the web browser."),!1;this.eventEmitter.emit(exports.EventType.RENDERING_AUDIO_PROBLEM_DETECTED)}this._renderedBuffer=t,this.bufferPlayer.loadBuffer(this._renderedBuffer),this.updateAudioSpeedAndDuration(null)}this.initialRenderingDone=!0}return!0}loadInitialBuffer(e){this.bufferPlayer&&(this._renderedBuffer=e,this.bufferPlayer.loadBuffer(e))}clearRenderedBuffer(){St.clearAudioBuffer(this._renderedBuffer),this._renderedBuffer=null}setCompatibilityModeChecked(e){this.configService&&this.configService.setConfig(Pt.PREFERENCES_KEYS.COMPATIBILITY_MODE_CHECKED,String(e))}get renderedBuffer(){return this._renderedBuffer}};Zt=e([gt(),t(0,vt(_t.FilterManager)),t(1,vt(_t.RendererManager)),t(2,vt(_t.BufferPlayer)),t(3,vt(_t.BufferManager)),i("design:paramtypes",[Object,Object,Object,Object])],Zt);var Jt=Zt;let ei=class extends bt{constructor(e,t,i,r){super(),this.downloadingInitialData=!1,this.audioBuffersToFetch=[],this.bufferFetcherService=t,this.eventEmitter=i,this.filterManager=e,this.filterManager=e,this.audioBuffersToFetch=r}setup(){this.audioBuffersToFetch.length>0&&this.fetchBuffers(!1)}fetchBuffers(e){return r(this,void 0,void 0,(function*(){if(!this.downloadingInitialData&&this.bufferFetcherService){this.downloadingInitialData=!0,this.eventEmitter&&!e&&this.eventEmitter.emit(exports.EventType.LOADING_BUFFERS);try{yield this.bufferFetcherService.fetchAllBuffers(this.audioBuffersToFetch),this.downloadingInitialData=!1,this.eventEmitter&&!e&&this.eventEmitter.emit(exports.EventType.LOADED_BUFFERS)}catch(t){console.error(t),this.eventEmitter&&!e&&this.eventEmitter.emit(exports.EventType.LOADING_BUFFERS_ERROR)}}}))}resetBufferFetcher(){return r(this,void 0,void 0,(function*(){this.bufferFetcherService&&(this.bufferFetcherService.reset(),yield this.fetchBuffers(!0),this.filterManager&&(yield this.filterManager.resetFilterBuffers()))}))}};e([Et(),i("design:type",Function),i("design:paramtypes",[]),i("design:returntype",void 0)],ei.prototype,"setup",null),ei=e([gt(),t(0,vt(_t.FilterManager)),t(1,vt(_t.BufferFetcherService)),t(2,vt(_t.EventEmitter)),t(3,vt(_t.AudioBuffersToFetch)),i("design:paramtypes",[Object,Object,Object,Array])],ei);var ti=ei;let ii=class extends bt{constructor(e,t){super(),this.filters=[],this._entryPointFilter=null,this._currentNodes=null,this.filters=e,this._entryPointFilter=t}setup(){for(const e of this.filters)e.initializeDefaultSettings()}addFilters(...e){for(const t of e)t.initializeDefaultSettings(),t.injectDependencies(this.bufferFetcherService,this.bufferDecoderService,this.configService,this.eventEmitter,this.contextManager);this.filters.push(...e)}getFiltersState(){const e={};return this.filters.forEach((t=>{e[t.id]=t.isEnabled()})),e}getFiltersSettings(){const e=new Map;for(const t of this.filters)e.set(t.id,t.getSettings());return e}enableFilter(e){const t=this.filters.find((t=>t.id===e));t&&t.enable()}disableFilter(e){const t=this.filters.find((t=>t.id===e));t&&t.disable()}toggleFilter(e){const t=this.filters.find((t=>t.id===e));t&&t.toggle()}changeFilterSettings(e,t){return r(this,void 0,void 0,(function*(){const i=this.filters.find((t=>t.id===e));if(i)for(const e of Object.keys(t))yield i.setSetting(e,t[e])}))}resetFilterSettings(e){return r(this,void 0,void 0,(function*(){const t=this.filters.find((t=>t.id===e));t&&(yield t.resetSettings())}))}resetAllFiltersState(){this.filters.forEach((e=>{e.isDefaultEnabled()?e.enable():e.disable()}))}connectNodes(e,t,i,n){return r(this,void 0,void 0,(function*(){if(!this._entryPointFilter)return;let r=null;if(i&&this._currentNodes)r=this._currentNodes.input;else{const i=yield this._entryPointFilter.getEntrypointNode(e,t,!n);r=i.input}const s=[];let o=r;this.disconnectOldNodes(i);const a=this.filters.sort(((e,t)=>e.order-t.order)).filter(((e,t)=>e!==this._entryPointFilter&&(e.isEnabled()||t>=this.filters.length-1)));for(const t of a){const i=t.getNode(e);o&&o.connect(i.input),o=i.output,s.push(i)}this._entryPointFilter&&this._entryPointFilter.updateState(),this._currentNodes={input:r,output:o,intermediateNodes:s.filter((e=>e.input!=o&&e.output!=o&&e.input!=r&&e.output!=r))}}))}disconnectOldNodes(e){this._currentNodes&&(this._currentNodes.input.disconnect(),e||this._currentNodes.output.disconnect(),this.disconnecteIntermediateNodes())}disconnecteIntermediateNodes(){if(this._currentNodes&&this._currentNodes.intermediateNodes){for(const e of this._currentNodes.intermediateNodes)e.input.disconnect(),e.output.disconnect();this._currentNodes.intermediateNodes=void 0}}initializeWorklets(e){return r(this,void 0,void 0,(function*(){for(const t of this.filters)t.isWorklet()&&(this.clearWorklets(),yield t.initializeWorklet(e))}))}clearWorklets(){for(const e of this.filters)e.isWorklet()&&e.stop()}getAddingTime(){let e=0;for(const t of this.filters)t.isEnabled()&&(e+=t.getAddingTime());return e}setupTotalSamples(e,t){if(t){const i=e*t.sampleRate;for(const e of this.filters)e.totalSamples=i}}resetFilterBuffers(){return r(this,void 0,void 0,(function*(){for(const e of this.filters)yield e.bufferFetcherReseted()}))}get entrypointFilter(){return this._entryPointFilter}get currentNodes(){return this._currentNodes}};e([Et(),i("design:type",Function),i("design:paramtypes",[]),i("design:returntype",void 0)],ii.prototype,"setup",null),ii=e([gt(),t(0,yt(_t.Filters)),t(1,vt(_t.EntryPointFilter)),i("design:paramtypes",[Array,Object])],ii);var ri=ii;let ni=class extends bt{constructor(e=[]){super(),this.renderers=[],this.renderers=e}addRenderers(...e){for(const t of e)t.injectDependencies(this.bufferFetcherService,this.bufferDecoderService,this.configService,this.eventEmitter,this.contextManager);this.renderers.push(...e)}getRenderersState(){const e={};return this.renderers.forEach((t=>{e[t.id]=t.isEnabled()})),e}enableRenderer(e){const t=this.renderers.find((t=>t.id===e));t&&t.enable()}disableRenderer(e){const t=this.renderers.find((t=>t.id===e));t&&t.disable()}toggleRenderer(e){const t=this.renderers.find((t=>t.id===e));t&&t.toggle()}resetAllRenderersState(){this.renderers.forEach((e=>{e.isDefaultEnabled()?e.enable():e.disable()}))}executeAudioRenderers(e,t){return r(this,void 0,void 0,(function*(){let i=e;for(const e of this.renderers.sort(((e,t)=>e.order-t.order)))e.isEnabled()&&(i=yield e.renderAudio(t,i));return i}))}};ni=e([gt(),t(0,yt(_t.Renderers)),i("design:paramtypes",[Array])],ni);var si=ni;let oi=class extends bt{constructor(e,t){super(),this._savingBuffer=!1,this.playingStoppedCallback=null,this.bufferPlayer=t,this.filterManager=e}setup(){this.eventEmitter&&this.eventEmitter.on(exports.EventType.PLAYING_FINISHED,(()=>{this._savingBuffer&&this.playingStoppedCallback&&this.eventEmitter&&this.eventEmitter.off(exports.EventType.PLAYING_STOPPED,this.playingStoppedCallback)}))}saveBuffer(e,t,i){return r(this,void 0,void 0,(function*(){if(this._savingBuffer)throw new Error("The buffer is currently saving");if(!this.bufferPlayer)throw new Error("No buffer player was found");this._savingBuffer=!0;let r=!1;return r=this.bufferPlayer.compatibilityMode?yield this.saveBufferCompatibilityMode(t,i):yield this.saveBufferDirect(e,t),this._savingBuffer=!1,r}))}saveBufferDirect(e,t){return new Promise(((i,r)=>{var n;if(!e||this.contextManager&&!this.contextManager.currentContext)return void r("No rendered buffer or AudioContext not initialized");const s=Dt(null===(n=this.configService)||void 0===n?void 0:n.getWorkerBasePath());if(s){const r=[];for(let t=0;t<e.numberOfChannels;t++)r.push(e.getChannelData(t));s.onmessage=e=>{e.data.command!=Pt.EXPORT_WAV_COMMAND&&e.data.command!=Pt.EXPORT_MP3_COMMAND||this.downloadAudioBlob(e.data.data,t),s.terminate(),this._savingBuffer=!1,i(!0)},s.postMessage({command:Pt.INIT_COMMAND,config:{sampleRate:e.sampleRate,numChannels:2,bitrate:(null==t?void 0:t.bitrate)||Pt.DEFAULT_MP3_BITRATE}}),s.postMessage({command:Pt.RECORD_COMMAND,buffer:r}),s.postMessage({command:"mp3"===(null==t?void 0:t.format)||"mp3"===Pt.DEFAULT_SAVE_FORMAT?Pt.EXPORT_MP3_COMMAND:Pt.EXPORT_WAV_COMMAND,type:Pt.AUDIO_WAV})}}))}saveBufferCompatibilityMode(e,t){return new Promise(((i,r)=>{this.bufferPlayer?this.bufferPlayer.start().then((()=>{if(!this.configService)return r("No config service found");if(!this.filterManager)return r("No filter manager found");if(!this.filterManager.currentNodes)return r("No current nodes found");const n=t||new Bt({bufferLen:this.configService.getBufferSize(),sampleRate:this.configService.getSampleRate(),numChannels:2,workletBasePath:this.configService.getWorkletBasePath(),workerBasePath:this.configService.getWorkerBasePath(),mimeType:"mp3"==(null==e?void 0:e.format)?Pt.AUDIO_MP3:Pt.AUDIO_WAV,bitrate:(null==e?void 0:e.bitrate)||Pt.DEFAULT_MP3_BITRATE});n.setup(this.filterManager.currentNodes.output).then((()=>{n.record();const t=()=>{this.playingStoppedCallback&&this.eventEmitter&&this.eventEmitter.off(exports.EventType.PLAYING_STOPPED,this.playingStoppedCallback),n.stop();const r=r=>{this.downloadAudioBlob(r,e),this._savingBuffer=!1,this.eventEmitter&&this.eventEmitter.off(exports.EventType.PLAYING_FINISHED,t),n.kill(),i(!0)};"mp3"===(null==e?void 0:e.format)||"mp3"===Pt.DEFAULT_SAVE_FORMAT?n.exportMP3(r):n.exportWAV(r)};this.playingStoppedCallback=()=>{n.kill(),this._savingBuffer=!1,this.eventEmitter&&(this.eventEmitter.off(exports.EventType.PLAYING_FINISHED,t),this.playingStoppedCallback&&this.eventEmitter.off(exports.EventType.PLAYING_STOPPED,this.playingStoppedCallback)),i(!0)},this.eventEmitter&&(this.eventEmitter.on(exports.EventType.PLAYING_FINISHED,t),this.eventEmitter.on(exports.EventType.PLAYING_STOPPED,this.playingStoppedCallback))}))})):r("No buffer player found")}))}downloadAudioBlob(e,t){St.forceDownload(e,"audio-"+(new Date).toISOString()+"."+((null==t?void 0:t.format)||Pt.DEFAULT_SAVE_FORMAT))}get savingBuffer(){return this._savingBuffer}};e([Et(),i("design:type",Function),i("design:paramtypes",[]),i("design:returntype",void 0)],oi.prototype,"setup",null),oi=e([gt(),t(0,vt(_t.FilterManager)),t(1,vt(_t.BufferPlayer)),i("design:paramtypes",[Object,Object])],oi);var ai=oi;let ui=class{constructor(e,t,i){this.buffers=new Map,this.bufferErrors=[],this.configService=null,this.contextManager=e,this.eventEmitter=i||new Yt,this.configService=t}fetchBuffer(e,t){return r(this,void 0,void 0,(function*(){var i,r,n,s;const o=(this.configService?this.configService.getSoundBasePath():"")+e;if(null==this.buffers.get(this.getKeyFromLocation(o))||t){null===(i=this.eventEmitter)||void 0===i||i.emit(exports.EventType.FETCHING_BUFFERS,o);try{const e=yield fetch(o);if(!e.ok)throw this.bufferErrors.push(o),null===(r=this.eventEmitter)||void 0===r||r.emit(exports.EventType.FETCHING_BUFFERS_ERROR,o),exports.EventType.FETCHING_BUFFERS_ERROR;{const t=yield e.arrayBuffer();if(this.contextManager&&this.contextManager.currentContext){const e=yield this.contextManager.currentContext.decodeAudioData(t);this.buffers.set(this.getKeyFromLocation(o),St.decodeBuffer(this.contextManager.currentContext,e))}}null===(n=this.eventEmitter)||void 0===n||n.emit(exports.EventType.FINISHED_FETCHING_BUFFERS,o)}catch(e){throw console.error(e),this.bufferErrors.push(o),null===(s=this.eventEmitter)||void 0===s||s.emit(exports.EventType.FETCHING_BUFFERS_ERROR,o),exports.EventType.FETCHING_BUFFERS_ERROR}}}))}fetchAllBuffers(e){return r(this,void 0,void 0,(function*(){for(const t of e)yield this.fetchBuffer(t)}))}getAudioBuffer(e){return this.buffers.get(this.getKeyFromLocation(e))}getOrFetchAudioBuffer(e){return r(this,void 0,void 0,(function*(){return null==this.getAudioBuffer(e)&&(yield this.fetchBuffer(e)),this.getAudioBuffer(e)}))}getDownloadedBuffersList(){return Array.from(this.buffers.keys())}getKeyFromLocation(e){return e.substring(e.lastIndexOf("/")+1)}reset(){this.buffers.clear()}};ui=e([gt(),t(0,vt(_t.AudioContextManager)),t(1,vt(_t.ConfigService)),t(2,vt(_t.EventEmitter)),i("design:paramtypes",[Object,Object,Object])],ui);var ci=ui;let hi=class{constructor(e,t){this.contextManager=e,this.eventEmitter=t||new Yt}decodeBufferFromFile(e){return r(this,void 0,void 0,(function*(){this.eventEmitter&&this.eventEmitter.emit(exports.EventType.DECODING_AUDIO_FILE);try{if(this.contextManager&&this.contextManager.currentContext){const t=yield St.loadAudioBuffer(this.contextManager.currentContext,e);return this.eventEmitter&&this.eventEmitter.emit(exports.EventType.DECODED_AUDIO_FILE),t}}catch(e){console.error(e),this.eventEmitter&&(this.eventEmitter.emit(exports.EventType.DECODED_AUDIO_FILE),this.eventEmitter.emit(exports.EventType.ERROR_DECODING_AUDIO_FILE))}return null}))}};hi=e([gt(),t(0,vt(_t.AudioContextManager)),t(1,vt(_t.EventEmitter)),i("design:paramtypes",[Object,Object])],hi);var li=hi;class di extends Ht{renderAudio(e,t){return new Promise((i=>{const r=t.numberOfChannels,n=e.sampleRate*t.duration+2*e.sampleRate,s=e.createBuffer(r,n,e.sampleRate);for(let e=0;e<r;e++){const i=s.getChannelData(e),r=t.getChannelData(e);for(let e=0;e<n;e++)e<r.length?i[e]=r[r.length-1-e]:i[e]=0}i(s)}))}get order(){return 0}get id(){return Pt.FILTERS_NAMES.RETURN_AUDIO}}class fi extends Gt{constructor(){super(...arguments),this.frequencyBooster=200,this.frequencyReduce=200,this.dbBooster=20,this.dbReduce=0}getNode(e){const t=e.createBiquadFilter();t.type="lowshelf",t.frequency.value=this.frequencyBooster,t.gain.value=this.dbBooster;const i=e.createBiquadFilter();return i.type="highshelf",i.frequency.value=this.frequencyReduce,i.gain.value=this.dbReduce,i.connect(t),{input:i,output:t}}get order(){return 3}get id(){return Pt.FILTERS_NAMES.BASS_BOOST}getSettings(){return{frequencyBooster:this.frequencyBooster,frequencyReduce:this.frequencyReduce,dbBooster:this.dbBooster,dbReduce:this.dbReduce}}setSetting(e,t){if(!St.isSettingValueValid(t))return Promise.resolve();switch(e){case"frequencyBooster":this.frequencyBooster=parseInt(t,10);break;case"frequencyReduce":this.frequencyReduce=parseInt(t,10);break;case"dbBooster":this.dbBooster=parseInt(t,10);break;case"dbReduce":this.dbReduce=parseInt(t,10)}return Promise.resolve()}}class pi extends AudioWorkletProcessor{constructor(){super(),this.stopped=!1,this.disabled=!1,this.phaser=null,this.last=null,this.port.onmessage=e=>{switch(e.data){case"stop":this.stop();break;case"disable":this.disabled=!0;break;case"enable":this.disabled=!1}}}static get parameterDescriptors(){return[{name:"bits",defaultValue:16},{name:"normFreq",defaultValue:.9}]}get defaultParameterDescriptors(){return pi.parameterDescriptors}process(e,t,i){if(this.stopped||this.disabled)return!1;const r=e[0],n=t[0],s=2*Math.pow(.5,i.bits[0]),o=(1-i.normFreq[0])/(sampleRate/48e3);if(null==this.last&&(this.last=new Array(r.length).fill(0)),null==this.phaser&&(this.phaser=new Array(r.length).fill(0)),r&&r[0]){const e=r[0].length;for(let t=0;t<r.length;t++){const i=r[t],a=n[t];if(i&&a)for(let r=0;r<e;r++)this.phaser[t]+=o,this.phaser[t]>=1&&(this.phaser[t]-=1,this.last[t]=s*Math.floor(i[r]*(1/s)+.5)),a[r]=this.last[t]}}return!0}stop(){this.stopped=!0,this.phaser=null,this.last=null}}registerProcessor(Pt.WORKLET_NAMES.BITCRUSHER,pi);class gi extends qt{constructor(){super(...arguments),this.bits=16,this.normFreq=.9}receiveEvent(e){}get workletPath(){return Pt.WORKLET_PATHS.BITCRUSHER}get workletName(){return Pt.WORKLET_NAMES.BITCRUSHER}get order(){return 6}get id(){return Pt.FILTERS_NAMES.BITCRUSHER}getSettings(){return{bits:this.bits,normFreq:this.normFreq}}setSetting(e,t){if(!St.isSettingValueValid(t))return Promise.resolve();switch(e){case"bits":this.bits=parseInt(t,10);break;case"normFreq":this.normFreq=parseFloat(t)}return this.applyCurrentSettingsToWorklet(),Promise.resolve()}}class mi extends Gt{constructor(){super(...arguments),this.delay=.2,this.gain=.75}getNode(e){const t=e.createDelay(179);t.delayTime.value=this.delay;const i=e.createGain();return i.gain.value=this.gain,i.connect(t),t.connect(i),{input:i,output:t}}get order(){return 7}get id(){return Pt.FILTERS_NAMES.ECHO}getAddingTime(){return 5}getSettings(){return{delay:this.delay,gain:this.gain}}setSetting(e,t){if(!St.isSettingValueValid(t))return Promise.resolve();switch(e){case"delay":this.delay=parseFloat(t);break;case"gain":this.gain=parseFloat(t)}return Promise.resolve()}}class vi extends Gt{constructor(){super(...arguments),this.highFrequency=3500}getNode(e){const t=e.createBiquadFilter();return t.type="highpass",t.frequency.value=this.highFrequency,{input:t,output:t}}get order(){return 4}get id(){return Pt.FILTERS_NAMES.HIGH_PASS}getSettings(){return{highFrequency:this.highFrequency}}setSetting(e,t){if(!St.isSettingValueValid(t))return Promise.resolve();if("highFrequency"===e)this.highFrequency=parseInt(t,10);return Promise.resolve()}}class yi{constructor(e){this._array=new Float32Array,this.n=0,this.length=0,this.readPointer=0,this.writePointer=0,this.n=Math.floor(e),this.init()}init(){this._array=new Float32Array(2*this.n),this.length=this._array.length,this.readPointer=0,this.writePointer=this.n-1,this._array.fill(0)}read(){const e=this._array[this.readPointer%this.length];return this.readPointer=(this.readPointer+1)%this.length,e}push(e){this._array[this.writePointer%this.length]=e,this.writePointer=(this.writePointer+1)%this.length}reset(){this.init()}clear(){this._array=new Float32Array,this.length=0,this.readPointer=0,this.writePointer=0}sum(){return this._array.reduce(((e,t)=>e+t),0)}}class Ei extends AudioWorkletProcessor{constructor(){super(),this.delayBuffer=[],this.envelopeSample=0,this.stopped=!1,this.disabled=!1,this.port.onmessage=e=>{switch(e.data){case"reset":this.reset();break;case"stop":this.stop();break;case"disable":this.disabled=!0;break;case"enable":this.disabled=!1}}}static get parameterDescriptors(){return[{name:"preGain",defaultValue:0},{name:"postGain",defaultValue:0},{name:"attackTime",defaultValue:0},{name:"releaseTime",defaultValue:3},{name:"threshold",defaultValue:-.05},{name:"lookAheadTime",defaultValue:0}]}get defaultParameterDescriptors(){return Ei.parameterDescriptors}getEnvelope(e,t,i,r){const n=Math.exp(-1/(r*t)),s=Math.exp(-1/(r*i)),o=new Float32Array(e.length);for(let t=0;t<e.length;t++){const i=Math.abs(e[t]);this.envelopeSample<i?this.envelopeSample=i+n*(this.envelopeSample-i):this.envelopeSample=i+s*(this.envelopeSample-i),o[t]=this.envelopeSample}return o}getMaxEnvelope(e,t,i){let r=e[0][i];for(let n=0;n<t;n++)e[n][i]>r&&(r=e[n][i]);return r}ampToDB(e){return 20*Math.log10(e)}dBToAmp(e){return Math.pow(10,e/20)}process(e,t,i){if(this.stopped||this.disabled)return!1;const r=e[0],n=t[0],s=[],o=this.dBToAmp(i.postGain[0]),a=this.dBToAmp(i.preGain[0]);for(let e=0;e<n.length;e++){const t=r[e],o=n[e];if(null==this.delayBuffer[e]&&(this.delayBuffer[e]=new yi(i.lookAheadTime[0]*sampleRate)),t&&o)for(let e=0;e<t.length;++e)this.disabled?o[e]=t[e]:o[e]=a*t[e];!this.disabled&&o&&(s[e]=this.getEnvelope(o,i.attackTime[0],i.releaseTime[0],sampleRate))}for(let e=0;e<n.length;e++){const t=r[e],a=n[e];if(i.lookAheadTime[0]>0&&a)for(let t=0;t<a.length;t++)this.delayBuffer[e].push(a[t]),a[t]=this.delayBuffer[e].read();if(this.disabled)continue;const u=1;if(t&&a)for(let e=0;e<t.length;e++){let t=u*(i.threshold[0]-this.ampToDB(this.getMaxEnvelope(s,n.length,e)));t=Math.min(0,t);const r=this.dBToAmp(t);a[e]*=r*o}}return!0}reset(){for(let e=0;e<this.delayBuffer.length;e++)null!=this.delayBuffer[e]&&this.delayBuffer[e].reset();this.envelopeSample=0}stop(){for(let e=0;e<this.delayBuffer.length;e++)null!=this.delayBuffer[e]&&this.delayBuffer[e].clear();this.delayBuffer=[],this.envelopeSample=0,this.stopped=!0}}registerProcessor(Pt.WORKLET_NAMES.LIMITER,Ei);class _i extends qt{constructor(){super(),this.preGain=0,this.postGain=0,this.attackTime=0,this.releaseTime=5,this.threshold=0,this.lookAheadTime=.35,this.keepCurrentNodeIfPossible=!0,this.setDefaultEnabled(!0)}receiveEvent(e){}get workletPath(){return Pt.WORKLET_PATHS.LIMITER}get workletName(){return Pt.WORKLET_NAMES.LIMITER}get order(){return 11}get id(){return Pt.FILTERS_NAMES.LIMITER}getAddingTime(){return this.lookAheadTime}getSettings(){return{preGain:this.preGain,postGain:this.postGain,attackTime:this.attackTime,releaseTime:this.releaseTime,threshold:this.threshold,lookAheadTime:this.lookAheadTime}}setSetting(e,t){if(!St.isSettingValueValid(t))return Promise.resolve();switch(e){case"preGain":this.preGain=parseFloat(t);break;case"postGain":this.postGain=parseFloat(t);break;case"attackTime":this.attackTime=parseFloat(t);break;case"releaseTime":this.releaseTime=parseFloat(t);break;case"threshold":this.threshold=parseFloat(t);break;case"lookAheadTime":this.lookAheadTime=parseFloat(t)}return this.applyCurrentSettingsToWorklet(),Promise.resolve()}}class Ai extends Gt{constructor(){super(...arguments),this.lowFrequency=3500}getNode(e){const t=e.createBiquadFilter();return t.type="lowpass",t.frequency.value=this.lowFrequency,{input:t,output:t}}get order(){return 5}get id(){return Pt.FILTERS_NAMES.LOW_PASS}getSettings(){return{lowFrequency:this.lowFrequency}}setSetting(e,t){if(!St.isSettingValueValid(t))return Promise.resolve();if("lowFrequency"===e)this.lowFrequency=parseInt(t,10);return Promise.resolve()}}class bi extends Gt{constructor(){super(...arguments),this.reverbEnvironment=Pt.DEFAULT_REVERB_ENVIRONMENT,this.reverbCustomEnvironmentAddTime=5,this.customEnvironment=null}getNode(e){const t=e.createConvolver();this.reverbEnvironment&&("custom"!=this.reverbEnvironment.url||this.customEnvironment)||(this.reverbEnvironment=Pt.DEFAULT_REVERB_ENVIRONMENT);const i=this.getReverbBuffer(e);return i&&(t.buffer=i),{input:t,output:t}}getReverbBuffer(e){if("custom"==this.reverbEnvironment.url&&this.customEnvironment){if(this.customEnvironment.sampleRate===e.sampleRate)return this.customEnvironment;this.reverbEnvironment=Pt.DEFAULT_REVERB_ENVIRONMENT}else if(this.bufferFetcherService)return this.bufferFetcherService.getAudioBuffer(this.reverbEnvironment.url)}get order(){return 9}get id(){return Pt.FILTERS_NAMES.REVERB}getAddingTime(){const e=this.getSettings();if(e&&e.reverbEnvironment){if("custom"==e.reverbEnvironment.value)return this.reverbCustomEnvironmentAddTime;if(e.reverbEnvironment.additionalData)return e.reverbEnvironment.additionalData.addDuration}return 0}getSettings(){var e;return this.reverbEnvironment?{reverbEnvironment:{name:this.reverbEnvironment.name,value:this.reverbEnvironment.url,additionalData:{size:this.reverbEnvironment.size,link:this.reverbEnvironment.link,addDuration:this.reverbEnvironment.addDuration}},downloadedBuffers:null===(e=this.bufferFetcherService)||void 0===e?void 0:e.getDownloadedBuffersList(),hasCustomEnvironment:Boolean(this.customEnvironment),reverbCustomEnvironmentAddTime:this.reverbCustomEnvironmentAddTime}:{reverbCustomEnvironmentAddTime:this.reverbCustomEnvironmentAddTime}}setSetting(e,t){return r(this,void 0,void 0,(function*(){var i;if("reverbEnvironment"==e){const e=t;if(e){const t=e.value;try{"custom"!=t&&(yield null===(i=this.bufferFetcherService)||void 0===i?void 0:i.fetchBuffer(t)),e.additionalData?this.reverbEnvironment={name:e.name,url:t,size:e.additionalData.size,addDuration:e.additionalData.addDuration,link:e.additionalData.link}:this.reverbEnvironment={name:e.name,url:t,size:0,addDuration:0,link:""}}catch(e){console.error(e)}}}else"reverbCustomEnvironmentAddTime"==e?St.isSettingValueValid(t)&&(this.reverbCustomEnvironmentAddTime=parseInt(t,10)):"reverbCustomEnvironmentFile"==e&&this.bufferDecoderService&&t&&(this.customEnvironment=yield this.bufferDecoderService.decodeBufferFromFile(t),this.customEnvironment||(this.reverbEnvironment=Pt.DEFAULT_REVERB_ENVIRONMENT))}))}bufferFetcherReseted(){return r(this,void 0,void 0,(function*(){var e;const t=this.getSettings();if(t){const i=null===(e=t.reverbEnvironment)||void 0===e?void 0:e.value;if(i&&"custom"!==i&&this.bufferFetcherService)return yield this.bufferFetcherService.fetchBuffer(i),!0}return!1}))}}class Si{constructor(){this._vector=new Float32Array,this._position=0,this._frameCount=0}get vector(){return this._vector}get position(){return this._position}get startIndex(){return 2*this._position}get frameCount(){return this._frameCount}get endIndex(){return 2*(this._position+this._frameCount)}clear(){this.receive(this._frameCount),this.rewind()}put(e){this._frameCount+=e}putSamples(e,t,i=0){const r=2*(t=t||0);i>=0||(i=(e.length-r)/2);const n=2*i;this.ensureCapacity(i+this._frameCount);const s=this.endIndex;this.vector.set(e.subarray(r,r+n),s),this._frameCount+=i}putBuffer(e,t,i=0){t=t||0,i>=0||(i=e.frameCount-t),this.putSamples(e.vector,e.position+t,i)}receive(e){e>=0&&!(e>this._frameCount)||(e=this.frameCount),this._frameCount-=e,this._position+=e}receiveSamples(e,t=0){const i=2*t,r=this.startIndex;e.set(this._vector.subarray(r,r+i)),this.receive(t)}extract(e,t=0,i=0){const r=this.startIndex+2*t,n=2*i;e.set(this._vector.subarray(r,r+n))}ensureCapacity(e=0){const t=parseInt(2*e);if(this._vector.length<t){const e=new Float32Array(t);e.set(this._vector.subarray(this.startIndex,this.endIndex)),this._vector=e,this._position=0}else this.rewind()}ensureAdditionalCapacity(e=0){this.ensureCapacity(this._frameCount+e)}rewind(){this._position>0&&(this._vector.set(this._vector.subarray(this.startIndex,this.endIndex)),this._position=0)}}class wi{constructor(e){e?(this._inputBuffer=new Si,this._outputBuffer=new Si):this._inputBuffer=this._outputBuffer=null}get inputBuffer(){return this._inputBuffer}set inputBuffer(e){this._inputBuffer=e}get outputBuffer(){return this._outputBuffer}set outputBuffer(e){this._outputBuffer=e}clear(){this._inputBuffer.clear(),this._outputBuffer.clear()}}class Ri extends wi{constructor(e){super(e),this.reset(),this._rate=1}set rate(e){this._rate=e}reset(){this.slopeCount=0,this.prevSampleL=0,this.prevSampleR=0}clone(){const e=new Ri;return e.rate=this._rate,e}process(){const e=this._inputBuffer.frameCount;this._outputBuffer.ensureAdditionalCapacity(e/this._rate+1);const t=this.transpose(e);this._inputBuffer.receive(),this._outputBuffer.put(t)}transpose(e=0){if(0===e)return 0;const t=this._inputBuffer.vector,i=this._inputBuffer.startIndex,r=this._outputBuffer.vector,n=this._outputBuffer.endIndex;let s=0,o=0;for(;this.slopeCount<1;)r[n+2*o]=(1-this.slopeCount)*this.prevSampleL+this.slopeCount*t[i],r[n+2*o+1]=(1-this.slopeCount)*this.prevSampleR+this.slopeCount*t[i+1],o+=1,this.slopeCount+=this._rate;if(this.slopeCount-=1,1!==e)e:for(;;){for(;this.slopeCount>1;)if(this.slopeCount-=1,s+=1,s>=e-1)break e;const a=i+2*s;r[n+2*o]=(1-this.slopeCount)*t[a]+this.slopeCount*t[a+2],r[n+2*o+1]=(1-this.slopeCount)*t[a+1]+this.slopeCount*t[a+3],o+=1,this.slopeCount+=this._rate}return this.prevSampleL=t[i+2*e-2],this.prevSampleR=t[i+2*e-1],o}}class Ti{constructor(e){this._pipe=e}get pipe(){return this._pipe}get inputBuffer(){return this._pipe.inputBuffer}get outputBuffer(){return this._pipe.outputBuffer}fillInputBuffer(){throw new Error("fillInputBuffer() not overridden")}fillOutputBuffer(e=0){for(;this.outputBuffer.frameCount<e;){const e=16384-this.inputBuffer.frameCount;if(this.fillInputBuffer(e),this.inputBuffer.frameCount<16384)break;this._pipe.process()}}clear(){this._pipe.clear()}}const Ci=function(){};class Ii extends Ti{constructor(e,t,i=Ci){super(t),this.callback=i,this.sourceSound=e,this.historyBufferSize=22050,this._sourcePosition=0,this.outputBufferPosition=0,this._position=0}get position(){return this._position}set position(e){if(e>this._position)throw new RangeError("New position may not be greater than current position");const t=this.outputBufferPosition-(this._position-e);if(t<0)throw new RangeError("New position falls outside of history buffer");this.outputBufferPosition=t,this._position=e}get sourcePosition(){return this._sourcePosition}set sourcePosition(e){this.clear(),this._sourcePosition=e}onEnd(){this.callback()}fillInputBuffer(e=0){const t=new Float32Array(2*e),i=this.sourceSound.extract(t,e,this._sourcePosition);this._sourcePosition+=i,this.inputBuffer.putSamples(t,0,i)}extract(e,t=0){this.fillOutputBuffer(this.outputBufferPosition+t);const i=Math.min(t,this.outputBuffer.frameCount-this.outputBufferPosition);this.outputBuffer.extract(e,this.outputBufferPosition,i);const r=this.outputBufferPosition+i;return this.outputBufferPosition=Math.min(this.historyBufferSize,r),this.outputBuffer.receive(Math.max(r-this.historyBufferSize,0)),this._position+=i,i}handleSampleData(e){this.extract(e.data,4096)}clear(){super.clear(),this.outputBufferPosition=0}}const Ni=[[124,186,248,310,372,434,496,558,620,682,744,806,868,930,992,1054,1116,1178,1240,1302,1364,1426,1488,0],[-100,-75,-50,-25,25,50,75,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[-20,-15,-10,-5,5,10,15,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[-4,-3,-2,-1,1,2,3,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],Mi=-10/3.75;class Pi extends wi{constructor(e){super(e),this._quickSeek=!0,this.midBufferDirty=!1,this.midBuffer=null,this.overlapLength=0,this.autoSeqSetting=!0,this.autoSeekSetting=!0,this._tempo=1,this.setParameters(44100,0,0,8)}clear(){super.clear(),this.clearMidBuffer()}clearMidBuffer(){this.midBufferDirty&&(this.midBufferDirty=!1,this.midBuffer=null)}setParameters(e,t,i,r){e>0&&(this.sampleRate=e),r>0&&(this.overlapMs=r),t>0?(this.sequenceMs=t,this.autoSeqSetting=!1):this.autoSeqSetting=!0,i>0?(this.seekWindowMs=i,this.autoSeekSetting=!1):this.autoSeekSetting=!0,this.calculateSequenceParameters(),this.calculateOverlapLength(this.overlapMs),this.tempo=this._tempo}set tempo(e){let t;this._tempo=e,this.calculateSequenceParameters(),this.nominalSkip=this._tempo*(this.seekWindowLength-this.overlapLength),this.skipFract=0,t=Math.floor(this.nominalSkip+.5),this.sampleReq=Math.max(t+this.overlapLength,this.seekWindowLength)+this.seekLength}get tempo(){return this._tempo}get inputChunkSize(){return this.sampleReq}get outputChunkSize(){return this.overlapLength+Math.max(0,this.seekWindowLength-2*this.overlapLength)}calculateOverlapLength(e=0){let t;t=this.sampleRate*e/1e3,t=t<16?16:t,t-=t%8,this.overlapLength=t,this.refMidBuffer=new Float32Array(2*this.overlapLength),this.midBuffer=new Float32Array(2*this.overlapLength)}checkLimits(e,t,i){return e<t?t:e>i?i:e}calculateSequenceParameters(){let e,t;this.autoSeqSetting&&(e=130+-20*this._tempo,e=this.checkLimits(e,50,125),this.sequenceMs=Math.floor(e+.5)),this.autoSeekSetting&&(t=25.666666666666668+Mi*this._tempo,t=this.checkLimits(t,15,25),this.seekWindowMs=Math.floor(t+.5)),this.seekWindowLength=Math.floor(this.sampleRate*this.sequenceMs/1e3),this.seekLength=Math.floor(this.sampleRate*this.seekWindowMs/1e3)}set quickSeek(e){this._quickSeek=e}clone(){const e=new Pi;return e.tempo=this._tempo,e.setParameters(this.sampleRate,this.sequenceMs,this.seekWindowMs,this.overlapMs),e}seekBestOverlapPosition(){return this._quickSeek?this.seekBestOverlapPositionStereoQuick():this.seekBestOverlapPositionStereo()}seekBestOverlapPositionStereo(){let e,t,i,r=0;for(this.preCalculateCorrelationReferenceStereo(),e=0,t=Number.MIN_VALUE;r<this.seekLength;r+=1)i=this.calculateCrossCorrelationStereo(2*r,this.refMidBuffer),i>t&&(t=i,e=r);return e}seekBestOverlapPositionStereoQuick(){let e,t,i,r,n,s=0;for(this.preCalculateCorrelationReferenceStereo(),t=Number.MIN_VALUE,e=0,r=0,n=0;s<4;s+=1){let o=0;for(;Ni[s][o]&&(n=r+Ni[s][o],!(n>=this.seekLength));)i=this.calculateCrossCorrelationStereo(2*n,this.refMidBuffer),i>t&&(t=i,e=n),o+=1;r=e}return e}preCalculateCorrelationReferenceStereo(){let e,t,i=0;for(;i<this.overlapLength;i+=1)t=i*(this.overlapLength-i),e=2*i,this.refMidBuffer[e]=this.midBuffer[e]*t,this.refMidBuffer[e+1]=this.midBuffer[e+1]*t}calculateCrossCorrelationStereo(e,t){const i=this._inputBuffer.vector;e+=this._inputBuffer.startIndex;let r=0,n=2;const s=2*this.overlapLength;let o;for(;n<s;n+=2)o=n+e,r+=i[o]*t[n]+i[o+1]*t[n+1];return r}overlap(e){this.overlapStereo(2*e)}overlapStereo(e){const t=this._inputBuffer.vector;e+=this._inputBuffer.startIndex;const i=this._outputBuffer.vector,r=this._outputBuffer.endIndex;let n,s,o=0;const a=1/this.overlapLength;let u,c,h;for(;o<this.overlapLength;o+=1)s=(this.overlapLength-o)*a,u=o*a,n=2*o,c=n+e,h=n+r,i[h+0]=t[c+0]*u+this.midBuffer[n+0]*s,i[h+1]=t[c+1]*u+this.midBuffer[n+1]*s}process(){let e,t,i;if(null===this.midBuffer){if(this._inputBuffer.frameCount<this.overlapLength)return;this.midBuffer=new Float32Array(2*this.overlapLength),this._inputBuffer.receiveSamples(this.midBuffer,this.overlapLength)}for(;this._inputBuffer.frameCount>=this.sampleReq;){e=this.seekBestOverlapPosition(),this._outputBuffer.ensureAdditionalCapacity(this.overlapLength),this.overlap(Math.floor(e)),this._outputBuffer.put(this.overlapLength),t=this.seekWindowLength-2*this.overlapLength,t>0&&this._outputBuffer.putBuffer(this._inputBuffer,e+this.overlapLength,t);const r=this._inputBuffer.startIndex+2*(e+this.seekWindowLength-this.overlapLength);this.midBuffer.set(this._inputBuffer.vector.subarray(r,r+2*this.overlapLength)),this.skipFract+=this.nominalSkip,i=Math.floor(this.skipFract),this.skipFract-=i,this._inputBuffer.receive(i)}}}const Di=function(e,t){return(e>t?e-t:t-e)>1e-10};class Bi{constructor(){this.transposer=new Ri(!1),this.stretch=new Pi(!1),this._inputBuffer=new Si,this._intermediateBuffer=new Si,this._outputBuffer=new Si,this._rate=0,this._tempo=0,this.virtualPitch=1,this.virtualRate=1,this.virtualTempo=1,this.calculateEffectiveRateAndTempo()}clear(){this.transposer.clear(),this.stretch.clear()}clone(){const e=new Bi;return e.rate=this.rate,e.tempo=this.tempo,e}get rate(){return this._rate}set rate(e){this.virtualRate=e,this.calculateEffectiveRateAndTempo()}set rateChange(e){this._rate=1+.01*e}get tempo(){return this._tempo}set tempo(e){this.virtualTempo=e,this.calculateEffectiveRateAndTempo()}set tempoChange(e){this.tempo=1+.01*e}set pitch(e){this.virtualPitch=e,this.calculateEffectiveRateAndTempo()}set pitchOctaves(e){this.pitch=Math.exp(.69314718056*e),this.calculateEffectiveRateAndTempo()}set pitchSemitones(e){this.pitchOctaves=e/12}get inputBuffer(){return this._inputBuffer}get outputBuffer(){return this._outputBuffer}calculateEffectiveRateAndTempo(){const e=this._tempo,t=this._rate;this._tempo=this.virtualTempo/this.virtualPitch,this._rate=this.virtualRate*this.virtualPitch,Di(this._tempo,e)&&(this.stretch.tempo=this._tempo),Di(this._rate,t)&&(this.transposer.rate=this._rate),this._rate>1?this._outputBuffer!=this.transposer.outputBuffer&&(this.stretch.inputBuffer=this._inputBuffer,this.stretch.outputBuffer=this._intermediateBuffer,this.transposer.inputBuffer=this._intermediateBuffer,this.transposer.outputBuffer=this._outputBuffer):this._outputBuffer!=this.stretch.outputBuffer&&(this.transposer.inputBuffer=this._inputBuffer,this.transposer.outputBuffer=this._intermediateBuffer,this.stretch.inputBuffer=this._intermediateBuffer,this.stretch.outputBuffer=this._outputBuffer)}process(){this._rate>1?(this.stretch.process(),this.transposer.process()):(this.transposer.process(),this.stretch.process())}}class Oi{constructor(e){this.buffer=e,this._position=0}get dualChannel(){return this.buffer.numberOfChannels>1}get position(){return this._position}set position(e){this._position=e}extract(e,t=0,i=0){this.position=i;let r=this.buffer.getChannelData(0),n=this.dualChannel?this.buffer.getChannelData(1):this.buffer.getChannelData(0),s=0;for(;s<t;s++)e[2*s]=r[s+i],e[2*s+1]=n[s+i];return Math.min(t,r.length-i)}}const Fi=function(e){const t=Math.floor(e/60);return`${t}:${function(e,t,i){return i=i||"0",(e+="").length>=t?e:new Array(t-e.length+1).join(i)+e}(parseInt(e-60*t),2)}`},xi=function(e){const t=this.timePlayed,i=this.sampleRate;if(this.sourcePosition=e,this.timePlayed=e/i,t!==this.timePlayed){const e=new CustomEvent("play",{detail:{timePlayed:this.timePlayed,formattedTimePlayed:this.formattedTimePlayed,percentagePlayed:this.percentagePlayed}});this._node.dispatchEvent(e)}};class ki{constructor(e,t,i,r=Ci){this._soundtouch=new Bi;const n=new Oi(t);this.timePlayed=0,this.sourcePosition=0,this._filter=new Ii(n,this._soundtouch,r),this._node=function(e,t,i=Ci,r=4096){const n=e.createScriptProcessor(r,2,2),s=new Float32Array(2*r);return n.onaudioprocess=e=>{let n=e.outputBuffer.getChannelData(0),o=e.outputBuffer.getChannelData(1),a=t.extract(s,r);i(t.sourcePosition),0===a&&t.onEnd();let u=0;for(;u<a;u++)n[u]=s[2*u],o[u]=s[2*u+1]},n}(e,this._filter,(e=>xi.call(this,e)),i),this.tempo=1,this.rate=1,this.duration=t.duration,this.sampleRate=e.sampleRate,this.listeners=[]}get formattedDuration(){return Fi(this.duration)}get formattedTimePlayed(){return Fi(this.timePlayed)}get percentagePlayed(){return 100*this._filter.sourcePosition/(this.duration*this.sampleRate)}set percentagePlayed(e){this._filter.sourcePosition=parseInt(e*this.duration*this.sampleRate),this.sourcePosition=this._filter.sourcePosition,this.timePlayed=this.sourcePosition/this.sampleRate}get node(){return this._node}set pitch(e){this._soundtouch.pitch=e}set pitchSemitones(e){this._soundtouch.pitchSemitones=e}set rate(e){this._soundtouch.rate=e}set tempo(e){this._soundtouch.tempo=e}connect(e){this._node.connect(e)}disconnect(){this._node.disconnect()}on(e,t){this.listeners.push({name:e,cb:t}),this._node.addEventListener(e,(e=>t(e.detail)))}off(e=null){let t=this.listeners;e&&(t=t.filter((t=>t.name===e))),t.forEach((e=>{this._node.removeEventListener(e.name,(t=>e.cb(t.detail)))}))}}class Li extends qt{constructor(){super(),this.speedAudio=Pt.SOUNDTOUCH_DEFAULT_SPEED,this.frequencyAudio=Pt.SOUNDTOUCH_DEFAULT_FREQUENCY,this.pitchSemitones=Pt.SOUNDTOUCH_DEFAULT_PITCH_SEMITONES,this.currentSpeedAudio=Pt.SOUNDTOUCH_DEFAULT_SPEED,this.currentBufferSource=null,this.isOfflineMode=!1,this.setDefaultEnabled(!0)}receiveEvent(e){}get workletPath(){return Pt.WORKLET_PATHS.SOUNDTOUCH}get workletName(){return Pt.WORKLET_NAMES.SOUNDTOUCH}getEntrypointNode(e,t,i){this.isOfflineMode=i,this.cleanUpOldNodes();const{isWorklet:r,renderWithSoundtouch:n}=this.getCurrentRenderingMode();if(n)return r&&St.isAudioWorkletCompatible(e)?this.renderWithWorklet(t,e):i?this.renderWithScriptProcessorNode(t,e):(this.currentPitchShifter=this.getSoundtouchScriptProcessorNode(t,e),this.updateState(),Promise.resolve({input:this.currentPitchShifter,output:this.currentPitchShifter}));const s=this.constructBufferSourceNode(e,t);return Promise.resolve({input:s,output:s})}getSoundtouchScriptProcessorNode(e,t){return new ki(t,e,Pt.SOUNDTOUCH_PITCH_SHIFTER_BUFFER_SIZE)}constructBufferSourceNode(e,t){const i=e.createBufferSource();return i.buffer=t,i.start(),this.currentBufferSource=i,i}cleanUpOldNodes(){this.currentPitchShifter&&(this.currentPitchShifter.disconnect(),this.currentPitchShifter._filter=null),this.currentBufferSource&&(this.currentBufferSource.disconnect(),this.currentBufferSource=null)}renderWithScriptProcessorNode(e,t){return r(this,void 0,void 0,(function*(){const i=St.calcAudioDuration(e,this.speedAudio);if(this.contextManager){const r=this.contextManager.createOfflineAudioContext(2,t.sampleRate*i,t.sampleRate);this.currentPitchShifter=this.getSoundtouchScriptProcessorNode(e,r),this.updateState(),this.currentPitchShifter.connect(r.destination);const n=yield r.startRendering(),s=this.constructBufferSourceNode(t,n);return this.currentPitchShifter.disconnect(),{input:s,output:s}}throw new Error("AudioContextManager is not available!")}))}renderWithWorklet(e,t){try{const i=this.constructBufferSourceNode(t,e),r=this.getNode(t);return i.connect(r.input),this.updateState(),Promise.resolve({input:r.input,output:r.output})}catch(i){return console.error(i),this.renderWithScriptProcessorNode(e,t)}}get order(){return 2}get id(){return Pt.FILTERS_NAMES.SOUNDTOUCH}getSettings(){return{speedAudio:this.speedAudio,frequencyAudio:this.frequencyAudio,pitchSemitones:this.pitchSemitones}}isAudioWorkletEnabled(){return this.configService?this.configService.isSoundtouchAudioWorkletEnabled():Pt.ENABLE_SOUNDTOUCH_AUDIO_WORKLET}getCurrentRenderingMode(){const e=this.speedAudio==Pt.SOUNDTOUCH_DEFAULT_SPEED&&this.frequencyAudio==Pt.SOUNDTOUCH_DEFAULT_FREQUENCY&&this.pitchSemitones==Pt.SOUNDTOUCH_DEFAULT_PITCH_SEMITONES;return!this.isOfflineMode||this.isEnabled()&&!e?this.isAudioWorkletAvailable()?{isWorklet:!0,renderWithSoundtouch:!0}:{isWorklet:!1,renderWithSoundtouch:!0}:{isWorklet:!1,renderWithSoundtouch:!1}}updateState(){const{isWorklet:e}=this.getCurrentRenderingMode();this.currentSpeedAudio=1;let t=1,i=1,r=0;this.isEnabled()&&(i=this.speedAudio,r=this.pitchSemitones,t=e?this.frequencyAudio*(1/this.speedAudio):this.frequencyAudio,this.currentSpeedAudio=this.speedAudio),e?(this.setWorkletSetting("pitch",t),this.setWorkletSetting("pitchSemitones",r),this.currentBufferSource&&(this.currentBufferSource.playbackRate.value=i)):this.currentPitchShifter&&(this.currentPitchShifter.pitch=t,this.currentPitchShifter.tempo=i,this.currentPitchShifter.pitchSemitones=r)}setSetting(e,t){if(!St.isSettingValueValid(t))return Promise.resolve();const i=parseFloat(t);switch(e){case"speedAudio":this.speedAudio=i;break;case"frequencyAudio":this.frequencyAudio=i;break;case"pitchSemitones":this.pitchSemitones=i}return this.updateState(),Promise.resolve()}setEnabled(e){super.setEnabled(e),this.updateState()}getSpeed(){return this.currentSpeedAudio}}class Gi extends Gt{getNode(e){const t=e.createBiquadFilter();t.type="lowpass",t.frequency.value=2e3;const i=e.createBiquadFilter();i.type="lowpass",i.frequency.value=2e3;const r=e.createBiquadFilter();r.type="highpass",r.frequency.value=500;const n=e.createBiquadFilter();return n.type="highpass",n.frequency.value=500,t.connect(i),i.connect(r),r.connect(n),{input:t,output:n}}get order(){return 7}get id(){return Pt.FILTERS_NAMES.TELEPHONIZER}getSettings(){return{}}setSetting(e,t){return r(this,void 0,void 0,(function*(){}))}}class Ui{constructor(e,t,i){this.FILTER_QUALITY=6,this.FOURIER_SIZE=4096,this.WAVETABLEBOOST=40,this.SAWTOOTHBOOST=.4,this.oscillatorType=4,this.oscillatorDetuneValue=0,this.audioContext=null,this.carrierBuffer=null,this.modulatorNode=null,this.vocoding=!1,this.modulatorInput=null,this.carrierInput=null,this.modulatorGain=null,this.modulatorGainValue=1,this.noiseBuffer=null,this.noiseNode=null,this.noiseGain=null,this.noiseGainValue=.2,this.carrierSampleNode=null,this.carrierSampleGain=null,this.carrierSampleGainValue=0,this.oscillatorNode=null,this.oscillatorGain=null,this.oscillatorGainValue=1,this.wavetable=null,this.wavetableSignalGain=null,this.modFilterBands=null,this.modFilterPostGains=null,this.heterodynes=null,this.powers=null,this.lpFilters=null,this.lpFilterPostGains=null,this.carrierBands=null,this.carrierFilterPostGains=null,this.carrierBandGains=null,this.vocoderBands=null,this.numVocoderBands=0,this.hpFilterGain=null,this.outputGain=null,this.audioContext=e,this.carrierBuffer=t,this.modulatorBuffer=i}init(){this.generateVocoderBands(55,7040,28),this.setupVocoderGraph(),this.vocode()}getNodes(){return{modulatorNode:this.modulatorNode,modulatorGain:this.modulatorGain,synthLevel:this.oscillatorGain,noiseNode:this.noiseGain,oscillatorNode:this.oscillatorNode,hpFilterGain:this.hpFilterGain,outputGain:this.outputGain}}shutOffCarrier(){this.oscillatorNode&&this.noiseNode&&this.carrierSampleNode&&(this.oscillatorNode.stop(0),this.oscillatorNode=null,this.noiseNode.stop(0),this.noiseNode=null,this.carrierSampleNode.stop(0),this.carrierSampleNode=null)}selectSawtooth(){this.wavetableSignalGain&&(this.wavetableSignalGain.gain.value=this.SAWTOOTHBOOST),this.oscillatorNode&&(this.oscillatorNode.type="sawtooth")}selectWavetable(){this.wavetableSignalGain&&(this.wavetableSignalGain.gain.value=this.WAVETABLEBOOST),this.oscillatorNode&&this.wavetable&&this.oscillatorNode.setPeriodicWave(this.wavetable),this.wavetableSignalGain&&(this.wavetableSignalGain.gain.value=this.WAVETABLEBOOST)}updateModGain(e){this.modulatorGainValue=e,this.modulatorGain&&(this.modulatorGain.gain.value=e)}updateSampleLevel(e){this.carrierSampleGainValue=e,this.carrierSampleGain&&(this.carrierSampleGain.gain.value=e)}updateSynthLevel(e){this.oscillatorGainValue=e,this.oscillatorGain&&(this.oscillatorGain.gain.value=e)}updateNoiseLevel(e){this.noiseGainValue=e,this.noiseGain&&(this.noiseGain.gain.value=e)}updateDetuneValue(e){this.oscillatorDetuneValue=e,this.oscillatorNode&&(this.oscillatorNode.detune.value=e)}generateVocoderBands(e,t,i){const r=1200*Math.log(t/e)/Math.LN2/i,n=Math.pow(2,r/1200);this.vocoderBands=[];let s=e;for(let e=0;e<i;e++)this.vocoderBands[e]={frequency:s},s*=n;this.numVocoderBands=i}loadNoiseBuffer(){if(!this.audioContext)return;const e=5*this.audioContext.sampleRate;this.noiseBuffer=this.audioContext.createBuffer(1,e,this.audioContext.sampleRate);const t=this.noiseBuffer.getChannelData(0);for(let i=0;i<e;++i)t[i]=2*Math.random()-1}initBandpassFilters(){if(!this.audioContext)return;this.modulatorInput=this.audioContext.createGain(),this.carrierInput=this.audioContext.createGain(),null==this.modFilterBands&&(this.modFilterBands=[]),null==this.modFilterPostGains&&(this.modFilterPostGains=[]),null==this.heterodynes&&(this.heterodynes=[]),null==this.powers&&(this.powers=[]),null==this.lpFilters&&(this.lpFilters=[]),null==this.lpFilterPostGains&&(this.lpFilterPostGains=[]),null==this.carrierBands&&(this.carrierBands=[]),null==this.carrierFilterPostGains&&(this.carrierFilterPostGains=[]),null==this.carrierBandGains&&(this.carrierBandGains=[]);const e=new Float32Array(65536),t=32768;let i;for(let r=0;r<t;++r)i=r/t,e[t+r]=i,e[t-r-1]=i;const r=this.audioContext.createBiquadFilter();r.type="highpass",r.frequency.value=8e3,r.Q.value=1,this.modulatorInput.connect(r),this.hpFilterGain=this.audioContext.createGain(),this.hpFilterGain.gain.value=0,r.connect(this.hpFilterGain),this.modulatorBuffer&&this.hpFilterGain.connect(this.audioContext.destination),this.modFilterBands.length=0,this.modFilterPostGains.length=0,this.heterodynes.length=0,this.powers.length=0,this.lpFilters.length=0,this.lpFilterPostGains.length=0,this.carrierBands.length=0,this.carrierFilterPostGains.length=0,this.carrierBandGains.length=0,this.outputGain=this.audioContext.createGain(),this.modulatorBuffer&&this.outputGain.connect(this.audioContext.destination);const n=new Float32Array(65536);for(let e=-32768;e<32768;e++)n[e+32768]=(e>0?e:-e)/32768;for(let t=0;t<this.numVocoderBands;t++){const i=this.audioContext.createBiquadFilter();i.type="bandpass",this.vocoderBands&&(i.frequency.value=this.vocoderBands[t].frequency),i.Q.value=this.FILTER_QUALITY,this.modulatorInput.connect(i),this.modFilterBands.push(i);const r=this.audioContext.createBiquadFilter();r.type="bandpass",this.vocoderBands&&(r.frequency.value=this.vocoderBands[t].frequency),r.Q.value=this.FILTER_QUALITY,i.connect(r);const s=this.audioContext.createGain();s.gain.value=6,r.connect(s),this.modFilterPostGains.push(s);const o=this.audioContext.createOscillator();this.vocoderBands&&(o.frequency.value=this.vocoderBands[t].frequency),o.start(0);const a=this.audioContext.createGain();s.connect(a),a.gain.value=0,o.connect(a.gain);const u=this.audioContext.createGain();u.gain.value=2,a.connect(u),this.heterodynes.push(u);const c=this.audioContext.createWaveShaper();c.curve=n,u.connect(c);const h=this.audioContext.createBiquadFilter();h.type="lowpass",h.frequency.value=5,h.Q.value=1,this.lpFilters.push(h),c.connect(h);const l=this.audioContext.createGain();l.gain.value=1,h.connect(l),this.lpFilterPostGains.push(l);const d=this.audioContext.createWaveShaper();d.curve=e,l.connect(d);const f=this.audioContext.createBiquadFilter();f.type="bandpass",this.vocoderBands&&(f.frequency.value=this.vocoderBands[t].frequency),f.Q.value=this.FILTER_QUALITY,this.carrierBands.push(f),this.carrierInput.connect(f);const p=this.audioContext.createBiquadFilter();p.type="bandpass",this.vocoderBands&&(p.frequency.value=this.vocoderBands[t].frequency),p.Q.value=this.FILTER_QUALITY,f.connect(p);const g=this.audioContext.createGain();g.gain.value=10,p.connect(g),this.carrierFilterPostGains.push(g);const m=this.audioContext.createGain();this.carrierBandGains.push(m),g.connect(m),m.gain.value=0,d.connect(m.gain),m.connect(this.outputGain)}const s=new Float32Array(this.FOURIER_SIZE),o=new Float32Array(this.FOURIER_SIZE);s[0]=0,o[0]=0;for(let e=1;e<this.FOURIER_SIZE;e++)s[e]=1,o[e]=1;this.wavetable=this.audioContext.createPeriodicWave(s,o),this.loadNoiseBuffer()}setupVocoderGraph(){this.initBandpassFilters()}createCarriersAndPlay(e){this.audioContext&&e&&(this.carrierSampleNode=this.audioContext.createBufferSource(),this.carrierSampleNode.buffer=this.carrierBuffer,this.carrierSampleNode.loop=!0,this.carrierSampleGain=this.audioContext.createGain(),this.carrierSampleGain.gain.value=this.carrierSampleGainValue,this.carrierSampleNode.connect(this.carrierSampleGain),this.carrierSampleGain.connect(e),this.wavetableSignalGain=this.audioContext.createGain(),this.oscillatorNode=this.audioContext.createOscillator(),4==this.oscillatorType&&this.wavetable?(this.oscillatorNode.setPeriodicWave(this.wavetable),this.wavetableSignalGain.gain.value=this.WAVETABLEBOOST):this.wavetableSignalGain.gain.value=this.SAWTOOTHBOOST,this.oscillatorNode.frequency.value=110,this.oscillatorNode.detune.value=this.oscillatorDetuneValue,this.oscillatorNode.connect(this.wavetableSignalGain),this.oscillatorGain=this.audioContext.createGain(),this.oscillatorGain.gain.value=this.oscillatorGainValue,this.wavetableSignalGain.connect(this.oscillatorGain),this.oscillatorGain.connect(e),this.noiseNode=this.audioContext.createBufferSource(),this.noiseNode.buffer=this.noiseBuffer,this.noiseNode.loop=!0,this.noiseGain=this.audioContext.createGain(),this.noiseGain.gain.value=this.noiseGainValue,this.noiseNode.connect(this.noiseGain),this.noiseGain.connect(e),this.oscillatorNode.start(0),this.noiseNode.start(0),this.carrierSampleNode.start(0))}vocode(){if(this.audioContext){if(this.vocoding)return this.modulatorNode&&this.modulatorNode.stop(0),this.shutOffCarrier(),void(this.vocoding=!1);this.createCarriersAndPlay(this.carrierInput),this.vocoding=!0,this.modulatorGain=this.audioContext.createGain(),this.modulatorGain.gain.value=this.modulatorGainValue,this.modulatorBuffer&&(this.modulatorNode=this.audioContext.createBufferSource(),this.modulatorNode.buffer=this.modulatorBuffer,this.modulatorNode.connect(this.modulatorGain),this.modulatorNode.start(0)),this.modulatorInput&&this.modulatorGain.connect(this.modulatorInput)}}}class Wi extends Gt{constructor(){super(...arguments),this.currentVocoder=null,this.modulatorGainValue=1,this.carrierSampleGainValue=0,this.oscillatorGainValue=1,this.noiseGainValue=.2,this.oscillatorDetuneValue=0}getNode(e){var t;const i=null===(t=this.bufferFetcherService)||void 0===t?void 0:t.getAudioBuffer(Pt.VOCODER_MODULATOR);this.currentVocoder=new Ui(e,i),this.currentVocoder.init(),this.applyCurrentSettingsToVocoder();const{modulatorGain:r,outputGain:n}=this.currentVocoder.getNodes();return{input:r,output:n}}getSettings(){return{modulatorGainValue:this.modulatorGainValue,carrierSampleGainValue:this.carrierSampleGainValue,oscillatorGainValue:this.oscillatorGainValue,noiseGainValue:this.noiseGainValue,oscillatorDetuneValue:this.oscillatorDetuneValue}}setSetting(e,t){if(!St.isSettingValueValid(t))return Promise.resolve();switch(e){case"modulatorGainValue":this.modulatorGainValue=parseFloat(t);break;case"carrierSampleGainValue":this.carrierSampleGainValue=parseFloat(t);break;case"oscillatorGainValue":this.oscillatorGainValue=parseFloat(t);break;case"noiseGainValue":this.noiseGainValue=parseFloat(t);break;case"oscillatorDetuneValue":this.oscillatorDetuneValue=parseFloat(t)}return this.applyCurrentSettingsToVocoder(),Promise.resolve()}applyCurrentSettingsToVocoder(){this.currentVocoder&&(this.currentVocoder.updateModGain(this.modulatorGainValue),this.currentVocoder.updateSampleLevel(this.carrierSampleGainValue),this.currentVocoder.updateSynthLevel(this.oscillatorGainValue),this.currentVocoder.updateNoiseLevel(this.noiseGainValue),this.currentVocoder.updateDetuneValue(this.oscillatorDetuneValue))}get order(){return 1}get id(){return Pt.FILTERS_NAMES.VOCODER}}class Vi extends AudioWorkletProcessor{constructor(){super(),this.stopped=!1,this.disabled=!1,this.samplesCount=0,this.port.onmessage=e=>{switch(e.data){case"stop":this.stop();break;case"disable":this.disabled=!0;break;case"enable":this.disabled=!1}}}static get parameterDescriptors(){return[]}get defaultParameterDescriptors(){return Vi.parameterDescriptors}process(e,t){if(this.stopped||this.disabled)return!1;const i=e[0],r=t[0];if(i&&i[0]&&(this.samplesCount+=i[0].length),r){for(let e=0;e<r.length;e++){const t=i[e],n=r[e];if(t)for(let e=0;e<t.length;e++)n[e]=t[e]}this.port.postMessage({command:"update",samplesCount:this.samplesCount})}return!0}stop(){this.stopped=!0}}registerProcessor(Pt.WORKLET_NAMES.RENDERING_PROGRESS_CALCULATION,Vi);class ji extends qt{constructor(){super(...arguments),this.currentTime=0,this.lastSampleCount=0,this.samplePerSecond=0,this.currentTimeSamplesPerSecond=0}receiveEvent(e){const t=performance.now(),i=e.data.samplesCount;"update"===e.data.command&&this.calculatePercentageProcessed(t,i),this.calculateRemainingTimeProcessing(t,i)}calculatePercentageProcessed(e,t){0===this.currentTime&&(this.currentTime=e);const i=e-this.currentTime,r=t/this._totalSamples*100;this.eventEmitter&&i>=Pt.TREATMENT_TIME_COUNTING_THROTTLE_INTERVAL&&(this.eventEmitter.emit(exports.EventType.UPDATE_AUDIO_TREATMENT_PERCENT,r),this.currentTime=e),r>=100&&this.stop()}calculateRemainingTimeProcessing(e,t){0===this.currentTimeSamplesPerSecond&&(this.currentTimeSamplesPerSecond=e);const i=e-this.currentTimeSamplesPerSecond,r=this._totalSamples-t;if(this.eventEmitter&&r<=0)this.eventEmitter.emit(exports.EventType.UPDATE_REMAINING_TIME_ESTIMATED,0);else if(this.eventEmitter&&i>=1e3){this.calculateSmoothedSamplePerSecond(i,t);const n=r/this.samplePerSecond;this.currentTimeSamplesPerSecond=e,this.lastSampleCount=t,isNaN(n)||!isFinite(n)?this.eventEmitter.emit(exports.EventType.UPDATE_REMAINING_TIME_ESTIMATED,-1):this.eventEmitter.emit(exports.EventType.UPDATE_REMAINING_TIME_ESTIMATED,n)}}calculateSmoothedSamplePerSecond(e,t){if(e>0){const i=(t-this.lastSampleCount)/(e/1e3);this.samplePerSecond=Pt.TREATMENT_TIME_COUNTING_SMOOTHING_FACTOR*i+(1-Pt.TREATMENT_TIME_COUNTING_SMOOTHING_FACTOR)*this.samplePerSecond}}get workletName(){return Pt.WORKLET_NAMES.RENDERING_PROGRESS_CALCULATION}get workletPath(){return Pt.WORKLET_PATHS.RENDERING_PROGRESS_CALCULATION}get order(){return 10}get id(){return Pt.FILTERS_NAMES.RENDERING_PROGRESS_CALCULATION}set totalSamples(e){super.totalSamples=e,this.currentTime=0,this.currentTimeSamplesPerSecond=0,this.samplePerSecond=0,this.lastSampleCount=0}getSettings(){return{}}setSetting(e,t){return r(this,void 0,void 0,(function*(){}))}}class qi{static createNewInstance(e){const t=function(){const e=new dt({defaultScope:"Singleton"});return e.bind(_t.EntryPointFilter).to(Li),e.bind(_t.Renderers).to(di),e.bind(_t.Filters).toDynamicValue((()=>e.get(_t.EntryPointFilter))),e.bind(_t.Filters).to(fi),e.bind(_t.Filters).to(gi),e.bind(_t.Filters).to(mi),e.bind(_t.Filters).to(vi),e.bind(_t.Filters).to(_i),e.bind(_t.Filters).to(Ai),e.bind(_t.Filters).to(bi),e.bind(_t.Filters).to(Gi),e.bind(_t.Filters).to(Wi),e.bind(_t.Filters).to(ji),e.bind(_t.EventEmitter).to(Yt),e.bind(_t.AudioContextManager).to(Xt),e.bind(_t.AudioEditor).to(Tt),e.bind(_t.AudioProcessor).to(Jt),e.bind(_t.BufferManager).to(ti),e.bind(_t.FilterManager).to(ri),e.bind(_t.RendererManager).to(si),e.bind(_t.SaveBufferManager).to(ai),e.bind(_t.BufferPlayer).to(It),e.bind(_t.BufferFetcherService).to(ci),e.bind(_t.BufferDecoderService).to(li),e.bind(_t.VoiceRecorder).to(xt),e}();return e&&e.configService?t.bind(_t.ConfigService).toDynamicValue((()=>e.configService)):(t.bind(_t.ConfigService).to(zt),console.warn("No ConfigService provided. Using default generic implementation.")),t.bind(_t.AudioBuffersToFetch).toConstantValue(e&&e.buffersToFetch||[]),{audioEditor:t.get(_t.AudioEditor),audioPlayer:t.get(_t.BufferPlayer),configService:t.get(_t.ConfigService),eventEmitter:t.get(_t.EventEmitter),voiceRecorder:t.get(_t.VoiceRecorder)}}static createAudioEditor(e,t){if(console.warn("[DEPRECATED] SoundStudioFactory.createAudioEditor is deprecated and will be removed in a future release of simple-sound-studio-lib. Please use SoundStudioFactory.createNewInstance instead, which doesn't work as a singleton."),!qi.ready){const i=qi.createNewInstance({configService:e,buffersToFetch:t});qi.audioEditor=i.audioEditor,qi.audioPlayer=i.audioPlayer,qi.configService=i.configService,qi.eventEmitter=i.eventEmitter,qi.voiceRecorder=i.voiceRecorder,qi.ready=!0}return qi.audioEditor}static createVoiceRecorder(){return console.warn("[DEPRECATED] SoundStudioFactory.createVoiceRecorder is deprecated and will be removed in a future release of simple-sound-studio-lib. Please use SoundStudioFactory.createNewInstance instead, which doesn't work as a singleton."),qi.voiceRecorder}static getAudioEditorInstance(){return console.warn("[DEPRECATED] SoundStudioFactory.getAudioEditorInstance is deprecated and will be removed in a future release of simple-sound-studio-lib. Please use SoundStudioFactory.createNewInstance instead, which doesn't work as a singleton."),qi.audioEditor}static getAudioPlayerInstance(){return console.warn("[DEPRECATED] SoundStudioFactory.getAudioPlayerInstance is deprecated and will be removed in a future release of simple-sound-studio-lib. Please use SoundStudioFactory.createNewInstance instead, which doesn't work as a singleton."),qi.audioPlayer}static getAudioRecorderInstance(){return console.warn("[DEPRECATED] SoundStudioFactory.getAudioRecorderInstance is deprecated and will be removed in a future release of simple-sound-studio-lib. Please use SoundStudioFactory.createNewInstance instead, which doesn't work as a singleton."),qi.voiceRecorder}static getEventEmitterInstance(){return console.warn("[DEPRECATED] SoundStudioFactory.getEventEmitterInstance is deprecated and will be removed in a future release of simple-sound-studio-lib. Please use SoundStudioFactory.createNewInstance instead, which doesn't work as a singleton."),qi.eventEmitter}static getConfigServiceInstance(){return console.warn("[DEPRECATED] SoundStudioFactory.getConfigServiceInstance is deprecated and will be removed in a future release of simple-sound-studio-lib. Please use SoundStudioFactory.createNewInstance instead, which doesn't work as a singleton."),qi.configService}}qi.ready=!1,qi.audioEditor=null,qi.audioPlayer=null,qi.configService=null,qi.eventEmitter=null,qi.voiceRecorder=null,exports.AbstractAudioElement=bt,exports.AbstractAudioFilter=Gt,exports.AbstractAudioFilterWorklet=qt,exports.AbstractAudioNode=Lt,exports.AbstractAudioRenderer=Ht,exports.AudioEditor=Tt,exports.BufferPlayer=It,exports.Constants=Pt,exports.EventEmitter=Yt,exports.FilterNames=Mt,exports.GenericConfigService=zt,exports.SoundStudioFactory=qi,exports.UtilFunctions=St,exports.VoiceRecorder=xt;
//# sourceMappingURL=SimpleSoundStudioLibrary.js.map
