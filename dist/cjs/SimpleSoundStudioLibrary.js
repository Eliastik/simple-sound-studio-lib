"use strict";function t(t,e,i,s){return new(i||(i=Promise))((function(r,o){function n(t){try{h(s.next(t))}catch(t){o(t)}}function a(t){try{h(s.throw(t))}catch(t){o(t)}}function h(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(n,a)}h((s=s.apply(t,e||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;class e{constructor(){this.enabled=!1,this.defaultEnabled=!1,this.bufferFetcherService=null,this.bufferDecoderService=null,this.configService=null}isEnabled(){return this.enabled}isDefaultEnabled(){return this.defaultEnabled}setDefaultEnabled(t){this.defaultEnabled=t}setEnabled(t){this.enabled=t}enable(){this.setEnabled(!0)}disable(){this.setEnabled(!1)}toggle(){this.setEnabled(!this.isEnabled())}}class i extends e{constructor(){super(...arguments),this.defaultSettings=null,this.eventEmitter=void 0}getAddingTime(){return 0}initializeDefaultSettings(){this.defaultSettings=this.getSettings()}getDefaultSettings(){return this.defaultSettings}resetSettings(){return t(this,void 0,void 0,(function*(){if(this.defaultSettings)for(const t in this.defaultSettings)this.defaultSettings&&void 0!==this.defaultSettings[t]&&(yield this.setSetting(t,this.defaultSettings[t]))}))}isWorklet(){return!1}}const s={AUDIO_EDITOR:"audioEditor",VOICE_RECORDER:"voiceRecorder",BUFFER_PLAYER:"bufferPlayer",EXPORT_WAV_COMMAND:"exportWAV",AUDIO_WAV:"audio/wav",RECORD_COMMAND:"record",INIT_COMMAND:"init",FILTERS_NAMES:{REVERB:"reverb",ECHO:"echo",BASS_BOOST:"bassboost",BITCRUSHER:"bitcrusher",HIGH_PASS:"highpass",LIMITER:"limiter",LOW_PASS:"lowpass",PASSTHROUGH:"passthroughfilter",RETURN_AUDIO:"returnAudio",SOUNDTOUCH:"soundtouch",TELEPHONIZER:"telephonizer",VOCODER:"vocoder"},WORKLET_PATHS:{BITCRUSHER:"BitCrusher.worklet.js",LIMITER:"Limiter.worklet.js",SOUNDTOUCH:"Soundtouch.worklet.js",RECORDER_WORKLET:"RecorderWorklet.js",PASSTHROUGH:"Passthrough.worklet.js"},WORKLET_NAMES:{BITCRUSHER:"bitcrusher-processor",LIMITER:"limiter-processor",SOUNDTOUCH:"soundtouch-worklet",RECORDER_WORKLET:"recorder-worklet",PASSTHROUGH:"passthrough"},PREFERENCES_KEYS:{COMPATIBILITY_MODE_ENABLED:"compatibility-mode-enabled",COMPATIBILITY_MODE_CHECKED:"compatibility-mode-checked",ENABLE_AUDIO_WORKLET:"enable-audio-worklet",ENABLE_SOUNDTOUCH_AUDIO_WORKLET:"enable-soundtouch-audio-worklet",BUFFER_SIZE:"buffer-size",SAMPLE_RATE:"sample-rate",DISABLE_INITIAL_RENDERING:"disable-initial-rendering"},ENABLE_SOUNDTOUCH_AUDIO_WORKLET:!0,ENABLE_AUDIO_WORKLET:!0,ENABLE_RECORDER_AUDIO_WORKLET:!0,SOUNDTOUCH_PITCH_SHIFTER_BUFFER_SIZE:16384,DEFAULT_REVERB_ENVIRONMENT:{name:"Medium Damping Cave E002 M2S",url:"impulse_response.wav",size:1350278,addDuration:4,link:"http://www.cksde.com/p_6_250.htm"},VOCODER_MODULATOR:"modulator.mp3",DEFAULT_BUFFER_SIZE:0,VALID_BUFFER_SIZE:[0,256,512,1024,2048,4096,8192,16384],DEFAULT_SAMPLE_RATE:0,VALID_SAMPLE_RATES:[0,8e3,11025,16e3,22050,32e3,44100,48e3,88200,96e3,176400,192e3],TREATMENT_TIME_COUNTING_THROTTLE_INTERVAL:100,TREATMENT_TIME_COUNTING_SMOOTHING_FACTOR:.9,DISABLE_INITIAL_RENDERING:!0},r={calcAudioDuration:(t,e)=>{if(t){let i=t.duration+1;return e&&(i/=e),i}return 0},loadAudioBuffer:(e,i)=>t(void 0,void 0,void 0,(function*(){const t=yield r.readAsArrayBufferPromisified(i),s=yield e.decodeAudioData(t);return r.decodeBuffer(e,s)})),readAsArrayBufferPromisified:t=>new Promise(((e,i)=>{const s=new FileReader;s.onload=t=>{var s;const r=null===(s=null==t?void 0:t.target)||void 0===s?void 0:s.result;r instanceof ArrayBuffer?e(r):i()},t&&s.readAsArrayBuffer(t)})),decodeBuffer:(t,e)=>{if(1==e.numberOfChannels){t.resume();const i=e.duration,s=t.sampleRate,r=t.createBuffer(2,s*i+2*s,s),o=e.getChannelData(0),n=r.getChannelData(0),a=r.getChannelData(1);for(let t=0;t<o.length;t++)n[t]=o[t],a[t]=o[t];return r}return e},convertAudioBufferToFloat32Array:t=>{const e=[];for(let i=0;i<t.numberOfChannels;i++)e.push(t.getChannelData(i));return e},convertAudioParamToFloat32Array:(t,e)=>{const i=new Float32Array(e);for(let s=0;s<e;s++)i.set([t.value],s);return i},sumAudioBufferChannel:(t,e)=>t.getChannelData(e).reduce(((t,e)=>t+e),0),sumAudioBuffer(t){let e=0;for(let i=0;i<t.numberOfChannels;i++)e+=this.sumAudioBufferChannel(t,i);return e},isAudioWorkletCompatible:t=>void 0!==t&&void 0!==t.audioWorklet,isSettingValueValid:t=>!(void 0===t||isNaN(Number(t))||"string"==typeof t&&""===t.trim())};class o extends i{constructor(t,e,i,s){super(),this.frequencyBooster=200,this.frequencyReduce=200,this.dbBooster=15,this.dbReduce=-2,this.frequencyBooster=t,this.dbBooster=e,this.frequencyReduce=i,this.dbReduce=s}getNode(t){const e=t.createBiquadFilter();e.type="lowshelf",e.frequency.value=this.frequencyBooster,e.gain.value=this.dbBooster;const i=t.createBiquadFilter();return i.type="highshelf",i.frequency.value=this.frequencyReduce,i.gain.value=this.dbReduce,i.connect(e),{input:i,output:e}}get order(){return 3}get id(){return s.FILTERS_NAMES.BASS_BOOST}getSettings(){return{frequencyBooster:this.frequencyBooster,frequencyReduce:this.frequencyReduce,dbBooster:this.dbBooster,dbReduce:this.dbReduce}}setSetting(e,i){return t(this,void 0,void 0,(function*(){if(r.isSettingValueValid(i))switch(e){case"frequencyBooster":this.frequencyBooster=parseInt(i);break;case"frequencyReduce":this.frequencyReduce=parseInt(i);break;case"dbBooster":this.dbBooster=parseInt(i);break;case"dbReduce":this.dbReduce=parseInt(i)}}))}}class n{constructor(t,e){this._value=0,this._minValue=0,this._maxValue=Number.MAX_SAFE_INTEGER,this._defaultValue=0,this.context=null,this.automationRate="a-rate",this._defaultValue=void 0!==e?e:0,this._value=this._defaultValue,this.context=t}get value(){return this._value}set value(t){this._value=Math.max(this._minValue,Math.min(this._maxValue,t))}get minValue(){return this._minValue}get maxValue(){return this._maxValue}get defaultValue(){return this._defaultValue}setValueAtTime(t,e){return console.warn("setValueAtTime used with AudioParamPolyfill, is not fully compatible with standard AudioParam"),this.value=t,new n(this.context,t)}linearRampToValueAtTime(t,e){return console.warn("linearRampToValueAtTime used with AudioParamPolyfill, is not fully compatible with standard AudioParam"),this.value=t,new n(this.context,t)}exponentialRampToValueAtTime(t,e){return console.warn("exponentialRampToValueAtTime used with AudioParamPolyfill, is not fully compatible with standard AudioParam"),this.value=t,new n(this.context,t)}cancelAndHoldAtTime(t){throw new Error("Method not implemented.")}cancelScheduledValues(t){throw new Error("Method not implemented.")}setTargetAtTime(t,e,i){throw new Error("Method not implemented.")}setValueCurveAtTime(t,e,i){throw new Error("Method not implemented.")}}class a{constructor(t,e,i){this._parameters=new Map,this._port=null,this.currentContext=null,this.workletProcessor=e,this.currentContext=t,this._scriptProcessorNode=t.createScriptProcessor(i,2,2),this.setupPort(),this.setupProcessor(),this.setupWorkletScope(t)}setupPort(){const t=new MessageChannel;t.port1.onmessage=t=>{this.workletProcessor&&this.workletProcessor.port2&&this.workletProcessor.port2.postMessage(t.data)},this.workletProcessor&&this.workletProcessor.port2&&(this.workletProcessor.port2.onmessage=e=>{t.port1.postMessage(e.data)}),this._port=t.port2}setupProcessor(){if(!this._scriptProcessorNode)return;this._scriptProcessorNode.onaudioprocess=t=>{if(this.workletProcessor){const e=[r.convertAudioBufferToFloat32Array(t.inputBuffer)],i=[r.convertAudioBufferToFloat32Array(t.outputBuffer)],s=[];for(const[t,e]of this._parameters.entries())s.push([t,r.convertAudioParamToFloat32Array(e,1)]);const o=Object.fromEntries(s);this.workletProcessor.process(e,i,o)}};const t=this.workletProcessor.defaultParameterDescriptors;t&&t.forEach((t=>{this.currentContext&&this._parameters.set(t.name,new n(this.currentContext,t.defaultValue))}))}setupWorkletScope(t){"undefined"!=typeof window&&(window.sampleRate=t.sampleRate)}get port(){return this._port}get parameters(){return this._parameters}get node(){return this._scriptProcessorNode}get context(){var t;return null===(t=this._scriptProcessorNode)||void 0===t?void 0:t.context}}class h{static registerProcessor(t,e){h.processorsMap.set(t,e)}static getProcessor(t){const e=h.processorsMap.get(t);return e?new e:null}}h.processorsMap=new Map;class u{constructor(){this.messageChannel=null,this.messageChannel=new MessageChannel}process(t,e,i){return!0}get port(){return this.messageChannel&&this.messageChannel.port1}get port2(){return this.messageChannel&&this.messageChannel.port2}get parameters(){throw new Error("Method not implemented.")}get parameterDescriptors(){throw new Error("Method not implemented.")}get defaultParameterDescriptors(){return[]}}"undefined"==typeof window||"AudioWorkletProcessor"in window||(window.AudioWorkletProcessor=u,window.registerProcessor=h.registerProcessor),"undefined"==typeof global||"AudioWorkletProcessor"in global||(global.AudioWorkletProcessor=u,global.registerProcessor=h.registerProcessor);class l extends i{constructor(){super(...arguments),this.currentWorkletNode=null,this.fallbackToScriptProcessor=!1,this.keepCurrentNodeIfPossible=!1}initializeWorklet(e){return t(this,void 0,void 0,(function*(){if(this.stop(),!r.isAudioWorkletCompatible(e))return console.error("Audio Worklets not supported on this browser. Fallback to ScriptProcessor"),void(this.fallbackToScriptProcessor=!0);const t=(this.configService?this.configService.getWorkletBasePath():"")+this.workletPath;yield e.audioWorklet.addModule(t).catch((e=>{console.error(`Error when loading Worklet (${t}) for filter ${this.id}. Fallback to ScriptProcessor. Exception:`,e),this.fallbackToScriptProcessor=!0}))}))}isAudioWorkletEnabled(){return this.configService?this.configService.isAudioWorkletEnabled():s.ENABLE_AUDIO_WORKLET}initializeNode(t,e){if(this.isAudioWorkletEnabled()&&!this.fallbackToScriptProcessor)this.currentWorkletNode=new AudioWorkletNode(t,e);else{const i=h.getProcessor(e);if(!i)throw new Error(`No processor registered with name ${e} for filter ${this.id} to use the fallback/polyfill for AudioWorklet. Make sure you have created the class.`);this.currentWorkletNode=new a(t,i,this.configService.getBufferSize())}this.currentWorkletNode&&this.currentWorkletNode.port&&(this.currentWorkletNode.port.onmessage=t=>this.receiveEvent(t))}applyCurrentSettingsToWorklet(){if(this.currentWorkletNode&&this.currentWorkletNode.parameters){const t=this.getSettings();for(const e of Object.keys(t)){const i=this.currentWorkletNode.parameters.get(e);i&&(i.value=t[e],i.setValueAtTime(t[e],0))}}}getNode(t){if(this.keepCurrentNodeIfPossible&&this.currentWorkletNode&&this.currentWorkletNode.context==t||(this.stop(),this.initializeNode(t,this.workletName)),this.applyCurrentSettingsToWorklet(),this.setEnabled(this.isEnabled()),this.currentWorkletNode)return this.currentWorkletNode instanceof a?{input:this.currentWorkletNode.node,output:this.currentWorkletNode.node}:{input:this.currentWorkletNode,output:this.currentWorkletNode};throw new Error("Worklet node has not yet been created")}stop(){this.currentWorkletNode&&this.currentWorkletNode.port&&(this.currentWorkletNode.port.postMessage("stop"),this.currentWorkletNode.port.onmessage=null),this.currentWorkletNode=null}setEnabled(t){this.currentWorkletNode&&this.currentWorkletNode.port&&this.currentWorkletNode.port.postMessage(t?"enable":"disable"),super.setEnabled(t)}isWorklet(){return!0}}class c extends AudioWorkletProcessor{constructor(){super(),this.stopped=!1,this.phaser=null,this.last=null,this.port.onmessage=t=>{"stop"==t.data&&this.stop()}}static get parameterDescriptors(){return[{name:"bits",defaultValue:16},{name:"normFreq",defaultValue:.9}]}get defaultParameterDescriptors(){return c.parameterDescriptors}process(t,e,i){if(this.stopped)return!1;const s=t[0],r=e[0],o=2*Math.pow(.5,i.bits[0]),n=(1-i.normFreq[0])/(sampleRate/48e3);if(null==this.last&&(this.last=new Array(s.length).fill(0)),null==this.phaser&&(this.phaser=new Array(s.length).fill(0)),s&&s[0]){const t=s[0].length;for(let e=0;e<s.length;e++){const i=s[e],a=r[e];if(i&&a)for(let s=0;s<t;s++)this.phaser[e]+=n,this.phaser[e]>=1&&(this.phaser[e]-=1,this.last[e]=o*Math.floor(i[s]*(1/o)+.5)),a[s]=this.last[e]}}return!0}stop(){this.stopped=!0,this.phaser=null,this.last=null}}registerProcessor(s.WORKLET_NAMES.BITCRUSHER,c);let d=class extends l{constructor(t,e){super(),this.bits=16,this.normFreq=.9,this.bits=t,this.normFreq=e}receiveEvent(t){}get workletPath(){return s.WORKLET_PATHS.BITCRUSHER}get workletName(){return s.WORKLET_NAMES.BITCRUSHER}get order(){return 6}get id(){return s.FILTERS_NAMES.BITCRUSHER}getSettings(){return{bits:this.bits,normFreq:this.normFreq}}setSetting(e,i){return t(this,void 0,void 0,(function*(){if(r.isSettingValueValid(i)){switch(e){case"bits":this.bits=parseInt(i);break;case"normFreq":this.normFreq=parseFloat(i)}this.applyCurrentSettingsToWorklet()}}))}};class p extends i{constructor(t,e){super(),this.delay=.2,this.gain=.75,this.delay=t,this.gain=e}getNode(t){const e=t.createDelay(179);e.delayTime.value=this.delay;const i=t.createGain();return i.gain.value=this.gain,i.connect(e),e.connect(i),{input:i,output:e}}get order(){return 7}get id(){return s.FILTERS_NAMES.ECHO}getAddingTime(){return 5}getSettings(){return{delay:this.delay,gain:this.gain}}setSetting(e,i){return t(this,void 0,void 0,(function*(){if(r.isSettingValueValid(i))switch(e){case"delay":this.delay=parseFloat(i);break;case"gain":this.gain=parseFloat(i)}}))}}class f extends i{constructor(t){super(),this.highFrequency=3500,this.highFrequency=t}getNode(t){const e=t.createBiquadFilter();return e.type="highpass",e.frequency.value=this.highFrequency,{input:e,output:e}}get order(){return 4}get id(){return s.FILTERS_NAMES.HIGH_PASS}getSettings(){return{highFrequency:this.highFrequency}}setSetting(e,i){return t(this,void 0,void 0,(function*(){if(r.isSettingValueValid(i)&&"highFrequency"===e)this.highFrequency=parseInt(i)}))}}class m{constructor(t){this._array=new Float32Array,this.n=0,this.length=0,this.readPointer=0,this.writePointer=0,this.n=Math.floor(t),this.init()}init(){this._array=new Float32Array(2*this.n),this.length=this._array.length,this.readPointer=0,this.writePointer=this.n-1,this._array.fill(0)}read(){const t=this._array[this.readPointer%this.length];return this.readPointer=(this.readPointer+1)%this.length,t}push(t){this._array[this.writePointer%this.length]=t,this.writePointer=(this.writePointer+1)%this.length}reset(){this.init()}clear(){this._array=new Float32Array,this.length=0,this.readPointer=0,this.writePointer=0}sum(){return this._array.reduce(((t,e)=>t+e),0)}}class E extends AudioWorkletProcessor{constructor(){super(),this.delayBuffer=[],this.envelopeSample=0,this.stopped=!1,this.disabled=!1,this.port.onmessage=t=>{"reset"==t.data?this.reset():"stop"==t.data?this.stop():"disable"==t.data?this.disabled=!0:"enable"==t.data&&(this.disabled=!1)}}static get parameterDescriptors(){return[{name:"preGain",defaultValue:0},{name:"postGain",defaultValue:0},{name:"attackTime",defaultValue:0},{name:"releaseTime",defaultValue:3},{name:"threshold",defaultValue:-.05},{name:"lookAheadTime",defaultValue:0}]}get defaultParameterDescriptors(){return E.parameterDescriptors}getEnvelope(t,e,i,s){const r=Math.exp(-1/(s*e)),o=Math.exp(-1/(s*i)),n=new Float32Array(t.length);for(let e=0;e<t.length;e++){const i=Math.abs(t[e]);this.envelopeSample<i?this.envelopeSample=i+r*(this.envelopeSample-i):this.envelopeSample=i+o*(this.envelopeSample-i),n[e]=this.envelopeSample}return n}getMaxEnvelope(t,e,i){let s=t[0][i];for(let r=0;r<e;r++)t[r][i]>s&&(s=t[r][i]);return s}ampToDB(t){return 20*Math.log10(t)}dBToAmp(t){return Math.pow(10,t/20)}process(t,e,i){if(this.stopped)return!1;const s=t[0],r=e[0],o=[],n=this.dBToAmp(i.postGain[0]),a=this.dBToAmp(i.preGain[0]);for(let t=0;t<r.length;t++){const e=s[t],n=r[t];if(null==this.delayBuffer[t]&&(this.delayBuffer[t]=new m(i.lookAheadTime[0]*sampleRate)),e&&n)for(let t=0;t<e.length;++t)this.disabled?n[t]=e[t]:n[t]=a*e[t];!this.disabled&&n&&(o[t]=this.getEnvelope(n,i.attackTime[0],i.releaseTime[0],sampleRate))}for(let t=0;t<r.length;t++){const e=s[t],a=r[t];if(i.lookAheadTime[0]>0&&a)for(let e=0;e<a.length;e++)this.delayBuffer[t].push(a[e]),a[e]=this.delayBuffer[t].read();if(this.disabled)continue;const h=1;if(e&&a)for(let t=0;t<e.length;t++){let e=h*(i.threshold[0]-this.ampToDB(this.getMaxEnvelope(o,r.length,t)));e=Math.min(0,e);const s=this.dBToAmp(e);a[t]*=s*n}}return!0}reset(){for(let t=0;t<this.delayBuffer.length;t++)null!=this.delayBuffer[t]&&this.delayBuffer[t].reset();this.envelopeSample=0}stop(){for(let t=0;t<this.delayBuffer.length;t++)null!=this.delayBuffer[t]&&this.delayBuffer[t].clear();this.delayBuffer=[],this.envelopeSample=0,this.stopped=!0}}registerProcessor(s.WORKLET_NAMES.LIMITER,E);class v extends l{constructor(t,e,i,s,r,o){super(),this.preGain=0,this.postGain=0,this.attackTime=0,this.releaseTime=3,this.threshold=-.05,this.lookAheadTime=.1,this.preGain=t||this.preGain,this.postGain=e||this.postGain,this.attackTime=i||this.attackTime,this.releaseTime=s||this.releaseTime,this.threshold=r||this.threshold,this.lookAheadTime=o||this.lookAheadTime,this.keepCurrentNodeIfPossible=!0,this.enable(),this.setDefaultEnabled(!0)}receiveEvent(t){}get workletPath(){return s.WORKLET_PATHS.LIMITER}get workletName(){return s.WORKLET_NAMES.LIMITER}get order(){return 11}get id(){return s.FILTERS_NAMES.LIMITER}getAddingTime(){return this.lookAheadTime}getSettings(){return{preGain:this.preGain,postGain:this.postGain,attackTime:this.attackTime,releaseTime:this.releaseTime,threshold:this.threshold,lookAheadTime:this.lookAheadTime}}setSetting(e,i){return t(this,void 0,void 0,(function*(){if(r.isSettingValueValid(i)){switch(e){case"preGain":this.preGain=parseFloat(i);break;case"postGain":this.postGain=parseFloat(i);break;case"attackTime":this.attackTime=parseFloat(i);break;case"releaseTime":this.releaseTime=parseFloat(i);break;case"threshold":this.threshold=parseFloat(i);break;case"lookAheadTime":this.lookAheadTime=parseFloat(i)}this.applyCurrentSettingsToWorklet()}}))}}class g extends i{constructor(t){super(),this.lowFrequency=3500,this.lowFrequency=t}getNode(t){const e=t.createBiquadFilter();return e.type="lowpass",e.frequency.value=this.lowFrequency,{input:e,output:e}}get order(){return 5}get id(){return s.FILTERS_NAMES.LOW_PASS}getSettings(){return{lowFrequency:this.lowFrequency}}setSetting(e,i){return t(this,void 0,void 0,(function*(){if(r.isSettingValueValid(i)&&"lowFrequency"===e)this.lowFrequency=parseInt(i)}))}}class S extends e{}class R extends S{renderAudio(t,e){return new Promise((i=>{const s=e.numberOfChannels,r=t.sampleRate*e.duration+2*t.sampleRate,o=t.createBuffer(s,r,t.sampleRate);for(let t=0;t<s;t++){const i=o.getChannelData(t),s=e.getChannelData(t);for(let t=0;t<r;t++)t<s.length?i[t]=s[s.length-1-t]:i[t]=0}i(o)}))}get order(){return 0}get id(){return s.FILTERS_NAMES.RETURN_AUDIO}}class _ extends i{constructor(){super(...arguments),this.reverbEnvironment=s.DEFAULT_REVERB_ENVIRONMENT,this.reverbCustomEnvironmentAddTime=5,this.customEnvironment=null}getNode(t){const e=t.createConvolver();this.reverbEnvironment&&("custom"!=this.reverbEnvironment.url||this.customEnvironment)||(this.reverbEnvironment=s.DEFAULT_REVERB_ENVIRONMENT);const i=this.getReverbBuffer(t);return i&&(e.buffer=i),{input:e,output:e}}getReverbBuffer(t){if("custom"==this.reverbEnvironment.url&&this.customEnvironment){if(this.customEnvironment.sampleRate===t.sampleRate)return this.customEnvironment;this.reverbEnvironment=s.DEFAULT_REVERB_ENVIRONMENT}else if(this.bufferFetcherService)return this.bufferFetcherService.getAudioBuffer(this.reverbEnvironment.url)}get order(){return 9}get id(){return s.FILTERS_NAMES.REVERB}getAddingTime(){const t=this.getSettings();if(t&&t.reverbEnvironment){if("custom"==t.reverbEnvironment.value)return this.reverbCustomEnvironmentAddTime;if(t.reverbEnvironment.additionalData)return t.reverbEnvironment.additionalData.addDuration}return 0}getSettings(){var t;return this.reverbEnvironment?{reverbEnvironment:{name:this.reverbEnvironment.name,value:this.reverbEnvironment.url,additionalData:{size:this.reverbEnvironment.size,link:this.reverbEnvironment.link,addDuration:this.reverbEnvironment.addDuration}},downloadedBuffers:null===(t=this.bufferFetcherService)||void 0===t?void 0:t.getDownloadedBuffersList(),hasCustomEnvironment:!!this.customEnvironment,reverbCustomEnvironmentAddTime:this.reverbCustomEnvironmentAddTime}:{reverbCustomEnvironmentAddTime:this.reverbCustomEnvironmentAddTime}}setSetting(e,i){return t(this,void 0,void 0,(function*(){var t;if("reverbEnvironment"==e){const e=i;if(e){const i=e.value;try{"custom"!=i&&(yield null===(t=this.bufferFetcherService)||void 0===t?void 0:t.fetchBuffer(i)),e.additionalData?this.reverbEnvironment={name:e.name,url:i,size:e.additionalData.size,addDuration:e.additionalData.addDuration,link:e.additionalData.link}:this.reverbEnvironment={name:e.name,url:i,size:0,addDuration:0,link:""}}catch(t){}}}else"reverbCustomEnvironmentAddTime"==e?r.isSettingValueValid(i)&&(this.reverbCustomEnvironmentAddTime=parseInt(i)):"reverbCustomEnvironmentFile"==e&&this.bufferDecoderService&&i&&(this.customEnvironment=yield this.bufferDecoderService.decodeBufferFromFile(i),this.customEnvironment||(this.reverbEnvironment=s.DEFAULT_REVERB_ENVIRONMENT))}))}}class A{constructor(){this._vector=new Float32Array,this._position=0,this._frameCount=0}get vector(){return this._vector}get position(){return this._position}get startIndex(){return 2*this._position}get frameCount(){return this._frameCount}get endIndex(){return 2*(this._position+this._frameCount)}clear(){this.receive(this._frameCount),this.rewind()}put(t){this._frameCount+=t}putSamples(t,e,i=0){const s=2*(e=e||0);i>=0||(i=(t.length-s)/2);const r=2*i;this.ensureCapacity(i+this._frameCount);const o=this.endIndex;this.vector.set(t.subarray(s,s+r),o),this._frameCount+=i}putBuffer(t,e,i=0){e=e||0,i>=0||(i=t.frameCount-e),this.putSamples(t.vector,t.position+e,i)}receive(t){t>=0&&!(t>this._frameCount)||(t=this.frameCount),this._frameCount-=t,this._position+=t}receiveSamples(t,e=0){const i=2*e,s=this.startIndex;t.set(this._vector.subarray(s,s+i)),this.receive(e)}extract(t,e=0,i=0){const s=this.startIndex+2*e,r=2*i;t.set(this._vector.subarray(s,s+r))}ensureCapacity(t=0){const e=parseInt(2*t);if(this._vector.length<e){const t=new Float32Array(e);t.set(this._vector.subarray(this.startIndex,this.endIndex)),this._vector=t,this._position=0}else this.rewind()}ensureAdditionalCapacity(t=0){this.ensureCapacity(this._frameCount+t)}rewind(){this._position>0&&(this._vector.set(this._vector.subarray(this.startIndex,this.endIndex)),this._position=0)}}class T{constructor(t){t?(this._inputBuffer=new A,this._outputBuffer=new A):this._inputBuffer=this._outputBuffer=null}get inputBuffer(){return this._inputBuffer}set inputBuffer(t){this._inputBuffer=t}get outputBuffer(){return this._outputBuffer}set outputBuffer(t){this._outputBuffer=t}clear(){this._inputBuffer.clear(),this._outputBuffer.clear()}}class C extends T{constructor(t){super(t),this.reset(),this._rate=1}set rate(t){this._rate=t}reset(){this.slopeCount=0,this.prevSampleL=0,this.prevSampleR=0}clone(){const t=new C;return t.rate=this._rate,t}process(){const t=this._inputBuffer.frameCount;this._outputBuffer.ensureAdditionalCapacity(t/this._rate+1);const e=this.transpose(t);this._inputBuffer.receive(),this._outputBuffer.put(e)}transpose(t=0){if(0===t)return 0;const e=this._inputBuffer.vector,i=this._inputBuffer.startIndex,s=this._outputBuffer.vector,r=this._outputBuffer.endIndex;let o=0,n=0;for(;this.slopeCount<1;)s[r+2*n]=(1-this.slopeCount)*this.prevSampleL+this.slopeCount*e[i],s[r+2*n+1]=(1-this.slopeCount)*this.prevSampleR+this.slopeCount*e[i+1],n+=1,this.slopeCount+=this._rate;if(this.slopeCount-=1,1!==t)t:for(;;){for(;this.slopeCount>1;)if(this.slopeCount-=1,o+=1,o>=t-1)break t;const a=i+2*o;s[r+2*n]=(1-this.slopeCount)*e[a]+this.slopeCount*e[a+2],s[r+2*n+1]=(1-this.slopeCount)*e[a+1]+this.slopeCount*e[a+3],n+=1,this.slopeCount+=this._rate}return this.prevSampleL=e[i+2*t-2],this.prevSampleR=e[i+2*t-1],n}}class y{constructor(t){this._pipe=t}get pipe(){return this._pipe}get inputBuffer(){return this._pipe.inputBuffer}get outputBuffer(){return this._pipe.outputBuffer}fillInputBuffer(){throw new Error("fillInputBuffer() not overridden")}fillOutputBuffer(t=0){for(;this.outputBuffer.frameCount<t;){const t=16384-this.inputBuffer.frameCount;if(this.fillInputBuffer(t),this.inputBuffer.frameCount<16384)break;this._pipe.process()}}clear(){this._pipe.clear()}}const B=function(){};class b extends y{constructor(t,e,i=B){super(e),this.callback=i,this.sourceSound=t,this.historyBufferSize=22050,this._sourcePosition=0,this.outputBufferPosition=0,this._position=0}get position(){return this._position}set position(t){if(t>this._position)throw new RangeError("New position may not be greater than current position");const e=this.outputBufferPosition-(this._position-t);if(e<0)throw new RangeError("New position falls outside of history buffer");this.outputBufferPosition=e,this._position=t}get sourcePosition(){return this._sourcePosition}set sourcePosition(t){this.clear(),this._sourcePosition=t}onEnd(){this.callback()}fillInputBuffer(t=0){const e=new Float32Array(2*t),i=this.sourceSound.extract(e,t,this._sourcePosition);this._sourcePosition+=i,this.inputBuffer.putSamples(e,0,i)}extract(t,e=0){this.fillOutputBuffer(this.outputBufferPosition+e);const i=Math.min(e,this.outputBuffer.frameCount-this.outputBufferPosition);this.outputBuffer.extract(t,this.outputBufferPosition,i);const s=this.outputBufferPosition+i;return this.outputBufferPosition=Math.min(this.historyBufferSize,s),this.outputBuffer.receive(Math.max(s-this.historyBufferSize,0)),this._position+=i,i}handleSampleData(t){this.extract(t.data,4096)}clear(){super.clear(),this.outputBufferPosition=0}}const N=[[124,186,248,310,372,434,496,558,620,682,744,806,868,930,992,1054,1116,1178,1240,1302,1364,1426,1488,0],[-100,-75,-50,-25,25,50,75,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[-20,-15,-10,-5,5,10,15,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[-4,-3,-2,-1,1,2,3,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],P=-10/1.5;class I extends T{constructor(t){super(t),this._quickSeek=!0,this.midBufferDirty=!1,this.midBuffer=null,this.overlapLength=0,this.autoSeqSetting=!0,this.autoSeekSetting=!0,this._tempo=1,this.setParameters(44100,0,0,8)}clear(){super.clear(),this.clearMidBuffer()}clearMidBuffer(){this.midBufferDirty&&(this.midBufferDirty=!1,this.midBuffer=null)}setParameters(t,e,i,s){t>0&&(this.sampleRate=t),s>0&&(this.overlapMs=s),e>0?(this.sequenceMs=e,this.autoSeqSetting=!1):this.autoSeqSetting=!0,i>0?(this.seekWindowMs=i,this.autoSeekSetting=!1):this.autoSeekSetting=!0,this.calculateSequenceParameters(),this.calculateOverlapLength(this.overlapMs),this.tempo=this._tempo}set tempo(t){let e;this._tempo=t,this.calculateSequenceParameters(),this.nominalSkip=this._tempo*(this.seekWindowLength-this.overlapLength),this.skipFract=0,e=Math.floor(this.nominalSkip+.5),this.sampleReq=Math.max(e+this.overlapLength,this.seekWindowLength)+this.seekLength}get tempo(){return this._tempo}get inputChunkSize(){return this.sampleReq}get outputChunkSize(){return this.overlapLength+Math.max(0,this.seekWindowLength-2*this.overlapLength)}calculateOverlapLength(t=0){let e;e=this.sampleRate*t/1e3,e=e<16?16:e,e-=e%8,this.overlapLength=e,this.refMidBuffer=new Float32Array(2*this.overlapLength),this.midBuffer=new Float32Array(2*this.overlapLength)}checkLimits(t,e,i){return t<e?e:t>i?i:t}calculateSequenceParameters(){let t,e;this.autoSeqSetting&&(t=150+-50*this._tempo,t=this.checkLimits(t,50,125),this.sequenceMs=Math.floor(t+.5)),this.autoSeekSetting&&(e=28.333333333333332+P*this._tempo,e=this.checkLimits(e,15,25),this.seekWindowMs=Math.floor(e+.5)),this.seekWindowLength=Math.floor(this.sampleRate*this.sequenceMs/1e3),this.seekLength=Math.floor(this.sampleRate*this.seekWindowMs/1e3)}set quickSeek(t){this._quickSeek=t}clone(){const t=new I;return t.tempo=this._tempo,t.setParameters(this.sampleRate,this.sequenceMs,this.seekWindowMs,this.overlapMs),t}seekBestOverlapPosition(){return this._quickSeek?this.seekBestOverlapPositionStereoQuick():this.seekBestOverlapPositionStereo()}seekBestOverlapPositionStereo(){let t,e,i,s=0;for(this.preCalculateCorrelationReferenceStereo(),t=0,e=Number.MIN_VALUE;s<this.seekLength;s+=1)i=this.calculateCrossCorrelationStereo(2*s,this.refMidBuffer),i>e&&(e=i,t=s);return t}seekBestOverlapPositionStereoQuick(){let t,e,i,s,r,o=0;for(this.preCalculateCorrelationReferenceStereo(),e=Number.MIN_VALUE,t=0,s=0,r=0;o<4;o+=1){let n=0;for(;N[o][n]&&(r=s+N[o][n],!(r>=this.seekLength));)i=this.calculateCrossCorrelationStereo(2*r,this.refMidBuffer),i>e&&(e=i,t=r),n+=1;s=t}return t}preCalculateCorrelationReferenceStereo(){let t,e,i=0;for(;i<this.overlapLength;i+=1)e=i*(this.overlapLength-i),t=2*i,this.refMidBuffer[t]=this.midBuffer[t]*e,this.refMidBuffer[t+1]=this.midBuffer[t+1]*e}calculateCrossCorrelationStereo(t,e){const i=this._inputBuffer.vector;t+=this._inputBuffer.startIndex;let s=0,r=2;const o=2*this.overlapLength;let n;for(;r<o;r+=2)n=r+t,s+=i[n]*e[r]+i[n+1]*e[r+1];return s}overlap(t){this.overlapStereo(2*t)}overlapStereo(t){const e=this._inputBuffer.vector;t+=this._inputBuffer.startIndex;const i=this._outputBuffer.vector,s=this._outputBuffer.endIndex;let r,o,n=0;const a=1/this.overlapLength;let h,u,l;for(;n<this.overlapLength;n+=1)o=(this.overlapLength-n)*a,h=n*a,r=2*n,u=r+t,l=r+s,i[l+0]=e[u+0]*h+this.midBuffer[r+0]*o,i[l+1]=e[u+1]*h+this.midBuffer[r+1]*o}process(){let t,e,i;if(null===this.midBuffer){if(this._inputBuffer.frameCount<this.overlapLength)return;this.midBuffer=new Float32Array(2*this.overlapLength),this._inputBuffer.receiveSamples(this.midBuffer,this.overlapLength)}for(;this._inputBuffer.frameCount>=this.sampleReq;){t=this.seekBestOverlapPosition(),this._outputBuffer.ensureAdditionalCapacity(this.overlapLength),this.overlap(Math.floor(t)),this._outputBuffer.put(this.overlapLength),e=this.seekWindowLength-2*this.overlapLength,e>0&&this._outputBuffer.putBuffer(this._inputBuffer,t+this.overlapLength,e);const s=this._inputBuffer.startIndex+2*(t+this.seekWindowLength-this.overlapLength);this.midBuffer.set(this._inputBuffer.vector.subarray(s,s+2*this.overlapLength)),this.skipFract+=this.nominalSkip,i=Math.floor(this.skipFract),this.skipFract-=i,this._inputBuffer.receive(i)}}}const D=function(t,e){return(t>e?t-e:e-t)>1e-10};class w{constructor(){this.transposer=new C(!1),this.stretch=new I(!1),this._inputBuffer=new A,this._intermediateBuffer=new A,this._outputBuffer=new A,this._rate=0,this._tempo=0,this.virtualPitch=1,this.virtualRate=1,this.virtualTempo=1,this.calculateEffectiveRateAndTempo()}clear(){this.transposer.clear(),this.stretch.clear()}clone(){const t=new w;return t.rate=this.rate,t.tempo=this.tempo,t}get rate(){return this._rate}set rate(t){this.virtualRate=t,this.calculateEffectiveRateAndTempo()}set rateChange(t){this._rate=1+.01*t}get tempo(){return this._tempo}set tempo(t){this.virtualTempo=t,this.calculateEffectiveRateAndTempo()}set tempoChange(t){this.tempo=1+.01*t}set pitch(t){this.virtualPitch=t,this.calculateEffectiveRateAndTempo()}set pitchOctaves(t){this.pitch=Math.exp(.69314718056*t),this.calculateEffectiveRateAndTempo()}set pitchSemitones(t){this.pitchOctaves=t/12}get inputBuffer(){return this._inputBuffer}get outputBuffer(){return this._outputBuffer}calculateEffectiveRateAndTempo(){const t=this._tempo,e=this._rate;this._tempo=this.virtualTempo/this.virtualPitch,this._rate=this.virtualRate*this.virtualPitch,D(this._tempo,t)&&(this.stretch.tempo=this._tempo),D(this._rate,e)&&(this.transposer.rate=this._rate),this._rate>1?this._outputBuffer!=this.transposer.outputBuffer&&(this.stretch.inputBuffer=this._inputBuffer,this.stretch.outputBuffer=this._intermediateBuffer,this.transposer.inputBuffer=this._intermediateBuffer,this.transposer.outputBuffer=this._outputBuffer):this._outputBuffer!=this.stretch.outputBuffer&&(this.transposer.inputBuffer=this._inputBuffer,this.transposer.outputBuffer=this._intermediateBuffer,this.stretch.inputBuffer=this._intermediateBuffer,this.stretch.outputBuffer=this._outputBuffer)}process(){this._rate>1?(this.stretch.process(),this.transposer.process()):(this.transposer.process(),this.stretch.process())}}class O{constructor(t){this.buffer=t,this._position=0}get dualChannel(){return this.buffer.numberOfChannels>1}get position(){return this._position}set position(t){this._position=t}extract(t,e=0,i=0){this.position=i;let s=this.buffer.getChannelData(0),r=this.dualChannel?this.buffer.getChannelData(1):this.buffer.getChannelData(0),o=0;for(;o<e;o++)t[2*o]=s[o+i],t[2*o+1]=r[o+i];return Math.min(e,s.length-i)}}const F=function(t){const e=Math.floor(t/60);return`${e}:${i=parseInt(t-60*e),s=2,r=r||"0",(i+="").length>=s?i:new Array(s-i.length+1).join(r)+i}`;var i,s,r},k=function(t){const e=this.timePlayed,i=this.sampleRate;if(this.sourcePosition=t,this.timePlayed=t/i,e!==this.timePlayed){const t=new CustomEvent("play",{detail:{timePlayed:this.timePlayed,formattedTimePlayed:this.formattedTimePlayed,percentagePlayed:this.percentagePlayed}});this._node.dispatchEvent(t)}};class x{constructor(t,e,i,s=B){this._soundtouch=new w;const r=new O(e);this.timePlayed=0,this.sourcePosition=0,this._filter=new b(r,this._soundtouch,s),this._node=function(t,e,i=B,s=4096){const r=t.createScriptProcessor(s,2,2),o=new Float32Array(2*s);return r.onaudioprocess=t=>{let r=t.outputBuffer.getChannelData(0),n=t.outputBuffer.getChannelData(1),a=e.extract(o,s);i(e.sourcePosition),0===a&&e.onEnd();let h=0;for(;h<a;h++)r[h]=o[2*h],n[h]=o[2*h+1]},r}(t,this._filter,(t=>k.call(this,t)),i),this.tempo=1,this.rate=1,this.duration=e.duration,this.sampleRate=t.sampleRate,this.listeners=[]}get formattedDuration(){return F(this.duration)}get formattedTimePlayed(){return F(this.timePlayed)}get percentagePlayed(){return 100*this._filter.sourcePosition/(this.duration*this.sampleRate)}set percentagePlayed(t){this._filter.sourcePosition=parseInt(t*this.duration*this.sampleRate),this.sourcePosition=this._filter.sourcePosition,this.timePlayed=this.sourcePosition/this.sampleRate}get node(){return this._node}set pitch(t){this._soundtouch.pitch=t}set pitchSemitones(t){this._soundtouch.pitchSemitones=t}set rate(t){this._soundtouch.rate=t}set tempo(t){this._soundtouch.tempo=t}connect(t){this._node.connect(t)}disconnect(){this._node.disconnect()}on(t,e){this.listeners.push({name:t,cb:e}),this._node.addEventListener(t,(t=>e(t.detail)))}off(t=null){let e=this.listeners;t&&(e=e.filter((e=>e.name===t))),e.forEach((t=>{this._node.removeEventListener(t.name,(e=>t.cb(e.detail)))}))}}let L;"undefined"!=typeof window&&void 0!==window.AudioWorkletNode&&(L=class extends AudioWorkletNode{constructor(t,e,i){super(t,e,i),this.name="",this.running=!1,this._tempo=1,this._pitch=1,this.name=this.constructor.name,this.running=!0,this.updateInterval=i.processorOptions.updateInterval}setup(e,i){return t(this,void 0,void 0,(function*(){return new Promise((t=>{this.port&&(this.port.onmessage=e=>{e&&e.data&&"OK"===e.data.status&&"setup"===e.data.args[0]&&(this.port.onmessage=this.messageProcessor.bind(this),t())},this.port.postMessage({command:"setup",args:[e,i]}),this._tempo=e,this._pitch=i)}))}))}set updateInterval(t){this.port.postMessage({command:"updateInterval",args:[t]})}get node(){return this}set tempo(t){this.port.postMessage({command:"setTempo",args:[t]})}set pitch(t){this.port.postMessage({command:"setPitch",args:[t]})}get tempo(){return this.port.postMessage({command:"getTempo",args:[]}),this._tempo}get pitch(){return this.port.postMessage({command:"getPitch",args:[]}),this._pitch}stop(){return t(this,void 0,void 0,(function*(){this.running&&(this.port.postMessage({command:"stop",args:[]}),this.disconnect(),this.running=!1)}))}messageProcessor(t){if(t.data.command){const{command:e}=t.data;if("End"===e)this.stop();if(t.data.status){const e=t.data.args[1];switch(t.data.args[0]){case"getTempo":this._tempo=e;break;case"getPitch":this._pitch=e}return}}}});var M,G=L;class U extends l{constructor(){super(),this.speedAudio=1,this.frequencyAudio=1,this.currentSpeedAudio=1,this.isOfflineMode=!1,this.enable(),this.setDefaultEnabled(!0)}initializeWorklet(){return t(this,void 0,void 0,(function*(){}))}receiveEvent(t){}get workletPath(){return s.WORKLET_PATHS.SOUNDTOUCH}constructAudioWorkletProcessor(){throw new Error("Method not implemented.")}get workletName(){return s.WORKLET_NAMES.SOUNDTOUCH}getEntrypointNode(e,i,s){return t(this,void 0,void 0,(function*(){if(this.isOfflineMode=s,this.cleanUpOldNodes(),s){if(!this.isEnabled()||1==this.speedAudio&&1==this.frequencyAudio){const t=e.createBufferSource();return t.buffer=i,t.start(),{input:t,output:t}}return this.isAudioWorkletEnabled()&&r.isAudioWorkletCompatible(e)&&1==this.speedAudio?this.renderWithWorklet(i,e):this.renderWithScriptProcessorNode(i,e)}return this.currentPitchShifter=this.getSoundtouchScriptProcessorNode(i,e),this.updateState(),{input:this.currentPitchShifter,output:this.currentPitchShifter}}))}cleanUpOldNodes(){this.currentPitchShifterWorklet&&(this.currentPitchShifterWorklet.stop(),this.currentPitchShifterWorklet.disconnect()),this.currentPitchShifter&&(this.currentPitchShifter.disconnect(),this.currentPitchShifter._filter=null)}getSoundtouchScriptProcessorNode(t,e){return new x(e,t,s.SOUNDTOUCH_PITCH_SHIFTER_BUFFER_SIZE)}renderWithScriptProcessorNode(e,i){return t(this,void 0,void 0,(function*(){const t=r.calcAudioDuration(e,this.speedAudio),s=new OfflineAudioContext(2,i.sampleRate*t,i.sampleRate);this.currentPitchShifter=this.getSoundtouchScriptProcessorNode(e,s),this.updateState(),this.currentPitchShifter.connect(s.destination);const o=yield s.startRendering(),n=i.createBufferSource();return n.buffer=o,n.start(),this.cleanUpOldNodes(),{input:n,output:n}}))}renderWithWorklet(e,i){return t(this,void 0,void 0,(function*(){const t=r.calcAudioDuration(e,this.speedAudio);try{yield i.audioWorklet.addModule((this.configService?this.configService.getWorkletBasePath():"")+s.WORKLET_PATHS.SOUNDTOUCH);const r=i.createBufferSource();return r.buffer=e,r.start(),this.currentPitchShifterWorklet=new G(i,"soundtouch-worklet",{processorOptions:{bypass:!1,recording:!1,nInputFrames:this.approximateNInputFrames(t,i),updateInterval:10,sampleRate:e.sampleRate}}),r.connect(this.currentPitchShifterWorklet.node),this.isEnabled()?yield this.currentPitchShifterWorklet.setup(this.speedAudio,this.frequencyAudio):yield this.currentPitchShifterWorklet.setup(1,1),{input:this.currentPitchShifterWorklet,output:this.currentPitchShifterWorklet}}catch(t){return console.error(t),this.renderWithScriptProcessorNode(e,i)}}))}approximateNInputFrames(t,e){return t*e.sampleRate*(Math.round(14*Math.exp(-4*this.frequencyAudio))+1)}get order(){return 2}get id(){return s.FILTERS_NAMES.SOUNDTOUCH}getSettings(){return{speedAudio:this.speedAudio,frequencyAudio:this.frequencyAudio}}isAudioWorkletEnabled(){return this.configService?this.configService.isSoundtouchAudioWorkletEnabled():s.ENABLE_SOUNDTOUCH_AUDIO_WORKLET}getCurrentPitchShifter(){return this.isOfflineMode?1==this.speedAudio&&1==this.frequencyAudio?null:this.isAudioWorkletEnabled()&&this.currentPitchShifterWorklet&&1==this.speedAudio?this.currentPitchShifterWorklet:this.currentPitchShifter:this.currentPitchShifter}updateState(){const t=this.getCurrentPitchShifter();this.isEnabled()?(t&&(t.pitch=this.frequencyAudio,t.tempo=this.speedAudio),this.currentSpeedAudio=this.speedAudio):(t&&(t.pitch=1,t.tempo=1),this.currentSpeedAudio=1)}setSetting(e,i){return t(this,void 0,void 0,(function*(){if(!r.isSettingValueValid(i))return;const t=parseFloat(i);switch(e){case"speedAudio":this.speedAudio=t;break;case"frequencyAudio":this.frequencyAudio=t}this.updateState()}))}setEnabled(t){super.setEnabled(t),this.updateState()}getSpeed(){return this.currentSpeedAudio}}class W extends i{getNode(t){const e=t.createBiquadFilter();e.type="lowpass",e.frequency.value=2e3;const i=t.createBiquadFilter();i.type="lowpass",i.frequency.value=2e3;const s=t.createBiquadFilter();s.type="highpass",s.frequency.value=500;const r=t.createBiquadFilter();return r.type="highpass",r.frequency.value=500,e.connect(i),i.connect(s),s.connect(r),{input:e,output:r}}get order(){return 7}get id(){return s.FILTERS_NAMES.TELEPHONIZER}getSettings(){return{}}setSetting(e,i){return t(this,void 0,void 0,(function*(){}))}}class V{constructor(){this.listeners={},this.listeners={}}on(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)}emit(t,e){this.listeners[t]&&this.listeners[t].forEach((t=>{t(e)}))}off(t,e){this.listeners[t]&&(this.listeners[t]=this.listeners[t].filter((t=>t!==e)))}}exports.EventType=void 0,(M=exports.EventType||(exports.EventType={})).LOADING_BUFFERS="loadingBuffers",M.LOADING_BUFFERS_ERROR="loadingBuffersError",M.FETCHING_BUFFERS="fetchingBuffers",M.FETCHING_BUFFERS_ERROR="fetchingBuffersError",M.FINISHED_FETCHING_BUFFERS="finishedFetchingBuffers",M.LOADED_BUFFERS="loadedBuffers",M.COMPATIBILITY_MODE_AUTO_ENABLED="compatibilityModeAutoEnabled",M.RENDERING_AUDIO_PROBLEM_DETECTED="renderingAudioProblemDetected",M.AUDIO_RENDERING_FINISHED="audioRenderingFinished",M.OFFLINE_AUDIO_RENDERING_FINISHED="offlineAudioRenderingFinished",M.PLAYING_STOPPED="playingStopped",M.PLAYING_STARTED="playingStarted",M.PLAYING_FINISHED="playingFinished",M.PLAYING_UPDATE="playingUpdate",M.RECORDER_INIT="recorderInit",M.RECORDER_SUCCESS="recorderSuccess",M.RECORDER_ERROR="recorderError",M.RECORDER_UPDATE_CONSTRAINTS="recorderUpdateConstraints",M.RECORDER_RECORDING="recorderRecording",M.RECORDER_STOPPED="recorderStopped",M.RECORDER_PAUSED="recorderPaused",M.RECORDER_RESETED="recorderReseted",M.RECORDER_COUNT_UPDATE="recorderCountUpdate",M.SAMPLE_RATE_CHANGED="sampleRateChanged",M.DECODING_AUDIO_FILE="decodingAudioFile",M.DECODED_AUDIO_FILE="decodedAudioFile",M.ERROR_DECODING_AUDIO_FILE="errorDecodingAudioFile",M.RECORDER_NOT_FOUND_ERROR="recorderNotFoundError",M.RECORDER_UNKNOWN_ERROR="recorderUnknownError",M.UPDATE_AUDIO_TREATMENT_PERCENT="updateAudioTreatmentPercent",M.UPDATE_REMAINING_TIME_ESTIMATED="updateRemainingTimeEstimated",M.CANCELLED_AND_LOADED_INITIAL_AUDIO="cancelledAndLoadedInitialAudio",M.CANCELLING_AUDIO_PROCESSING="cancellingAudioProcessing";class q extends e{constructor(e,i){super(),this.context=null,this.buffer=null,this.source=null,this.currentTime=0,this.displayTime=0,this.duration=0,this.interval=null,this.playing=!1,this.loop=!1,this.speedAudio=1,this.onBeforePlayingCallback=()=>t(this,void 0,void 0,(function*(){})),this.compatibilityMode=!1,this.currentNode=null,this.context=e,this.eventEmitter=i||new V}init(t){this.playing=!1,this.context&&(this.context.resume(),!this.compatibilityMode&&this.buffer&&(null==this.source||t||this.source.disconnect(),this.source=this.context.createBufferSource(),this.source.buffer=this.buffer,this.duration=this.buffer.duration*this.speedAudio,this.source.connect(this.context.destination))),this.updateInfos()}loadBuffer(t){this.compatibilityMode=!1,this.reset(),this.buffer=t,this.init()}setCompatibilityMode(t,e){this.compatibilityMode=!0,this.reset(),this.init(),null!=e&&(this.duration=e*this.speedAudio),this.currentNode=t,this.updateInfos()}reset(t){clearInterval(this.interval),this.currentTime=0,this.displayTime=0,t||this.stop()}stop(){var t;clearInterval(this.interval),null!=this.source&&null!=this.source&&this.playing&&(this.source.stop(0),this.playing=!1),this.currentNode&&(this.currentNode.disconnect(),this.compatibilityMode&&(this.currentTime=0,this.displayTime=0)),null===(t=this.eventEmitter)||void 0===t||t.emit(exports.EventType.PLAYING_STOPPED),this.updateInfos()}start(e){return t(this,void 0,void 0,(function*(){var t;if(this.source||this.compatibilityMode){if(e||this.stop(),this.init(e),yield this.onBeforePlayingCallback(),null===(t=this.eventEmitter)||void 0===t||t.emit(exports.EventType.PLAYING_STARTED),this.compatibilityMode){if(!this.currentNode||!this.context)return;this.currentNode.connect(this.context.destination)}else{if(!this.source)return;this.source.start(0,e?0:this.currentTime/this.speedAudio),this.playing=!0}let i=performance.now();this.interval=window.setInterval((()=>{var t,s;const r=performance.now(),o=r-i;i=r,this.currentTime+=o/1e3*this.speedAudio,this.displayTime=this.currentTime,this.currentTime>this.duration?this.loop?this.compatibilityMode?null===(t=this.eventEmitter)||void 0===t||t.emit(exports.EventType.PLAYING_FINISHED):(this.reset(e),this.start()):(null===(s=this.eventEmitter)||void 0===s||s.emit(exports.EventType.PLAYING_FINISHED),this.reset(e)):this.updateInfos()}),100)}}))}playDirect(){return t(this,void 0,void 0,(function*(){this.compatibilityMode?this.start(!1):this.start(!0)}))}pause(){this.stop()}updateInfos(){var t;null===(t=this.eventEmitter)||void 0===t||t.emit(exports.EventType.PLAYING_UPDATE)}setTimePercent(t){this.compatibilityMode||(this.currentTime=Math.round(this.duration*(t/100)),this.displayTime=this.currentTime,this.playing?(this.pause(),this.start()):this.updateInfos())}setTime(t){this.compatibilityMode||(this.currentTime=t,this.displayTime=this.currentTime,this.playing?(this.pause(),this.start()):this.updateInfos())}onBeforePlaying(t){this.onBeforePlayingCallback=t}toggleLoop(){this.loop=!this.loop}on(t,e){var i;null===(i=this.eventEmitter)||void 0===i||i.on(t,e)}updateContext(t){this.context=t}get currentTimeDisplay(){return("0"+Math.trunc(this.displayTime/60)).slice(-2)+":"+("0"+Math.trunc(this.displayTime%60)).slice(-2)}get maxTimeDisplay(){return("0"+Math.trunc(this.duration/60)).slice(-2)+":"+("0"+Math.trunc(this.duration%60)).slice(-2)}get percent(){return 100-Math.round((this.duration-this.displayTime)/this.duration*100)}get remainingTimeDisplay(){return("0"+Math.trunc((this.duration-this.displayTime)/60)).slice(-2)+":"+("0"+Math.trunc((this.duration-this.displayTime)%60)).slice(-2)}get order(){return-1}get id(){return s.BUFFER_PLAYER}}class H{constructor(t,e,i){this.buffers=new Map,this.bufferErrors=[],this.configService=null,this.context=t,this.eventEmitter=i||new V,this.configService=e}fetchBuffer(e,i){return t(this,void 0,void 0,(function*(){var t,s,o,n;const a=(this.configService?this.configService.getSoundBasePath():"")+e;if(null==this.buffers.get(this.getKeyFromLocation(a))||i){null===(t=this.eventEmitter)||void 0===t||t.emit(exports.EventType.FETCHING_BUFFERS,a);try{const t=yield fetch(a);if(!t.ok)throw this.bufferErrors.push(a),null===(s=this.eventEmitter)||void 0===s||s.emit(exports.EventType.FETCHING_BUFFERS_ERROR,a),exports.EventType.FETCHING_BUFFERS_ERROR;{const e=yield t.arrayBuffer(),i=yield this.context.decodeAudioData(e);this.buffers.set(this.getKeyFromLocation(a),yield r.decodeBuffer(this.context,i))}null===(o=this.eventEmitter)||void 0===o||o.emit(exports.EventType.FINISHED_FETCHING_BUFFERS,a)}catch(t){throw this.bufferErrors.push(a),null===(n=this.eventEmitter)||void 0===n||n.emit(exports.EventType.FETCHING_BUFFERS_ERROR,a),exports.EventType.FETCHING_BUFFERS_ERROR}}}))}fetchAllBuffers(e){return t(this,void 0,void 0,(function*(){for(const t of e)yield this.fetchBuffer(t)}))}getAudioBuffer(t){return this.buffers.get(this.getKeyFromLocation(t))}getOrFetchAudioBuffer(e){return t(this,void 0,void 0,(function*(){return null==this.getAudioBuffer(e)&&(yield this.fetchBuffer(e)),this.getAudioBuffer(e)}))}getDownloadedBuffersList(){return Array.from(this.buffers.keys())}getKeyFromLocation(t){return t.substring(t.lastIndexOf("/")+1)}updateContext(t){this.context=t}reset(){this.buffers.clear()}}class K{constructor(t,e,i){this.FILTER_QUALITY=6,this.FOURIER_SIZE=4096,this.WAVETABLEBOOST=40,this.SAWTOOTHBOOST=.4,this.oscillatorType=4,this.oscillatorDetuneValue=0,this.audioContext=null,this.carrierBuffer=null,this.modulatorNode=null,this.vocoding=!1,this.modulatorInput=null,this.carrierInput=null,this.modulatorGain=null,this.modulatorGainValue=1,this.noiseBuffer=null,this.noiseNode=null,this.noiseGain=null,this.noiseGainValue=.2,this.carrierSampleNode=null,this.carrierSampleGain=null,this.carrierSampleGainValue=0,this.oscillatorNode=null,this.oscillatorGain=null,this.oscillatorGainValue=1,this.wavetable=null,this.wavetableSignalGain=null,this.modFilterBands=null,this.modFilterPostGains=null,this.heterodynes=null,this.powers=null,this.lpFilters=null,this.lpFilterPostGains=null,this.carrierBands=null,this.carrierFilterPostGains=null,this.carrierBandGains=null,this.vocoderBands=null,this.numVocoderBands=0,this.hpFilterGain=null,this.outputGain=null,this.audioContext=t,this.carrierBuffer=e,this.modulatorBuffer=i}init(){this.generateVocoderBands(55,7040,28),this.setupVocoderGraph(),this.vocode()}getNodes(){return{modulatorNode:this.modulatorNode,modulatorGain:this.modulatorGain,synthLevel:this.oscillatorGain,noiseNode:this.noiseGain,oscillatorNode:this.oscillatorNode,hpFilterGain:this.hpFilterGain,outputGain:this.outputGain}}shutOffCarrier(){this.oscillatorNode&&this.noiseNode&&this.carrierSampleNode&&(this.oscillatorNode.stop(0),this.oscillatorNode=null,this.noiseNode.stop(0),this.noiseNode=null,this.carrierSampleNode.stop(0),this.carrierSampleNode=null)}selectSawtooth(){this.wavetableSignalGain&&(this.wavetableSignalGain.gain.value=this.SAWTOOTHBOOST),this.oscillatorNode&&(this.oscillatorNode.type="sawtooth")}selectWavetable(){this.wavetableSignalGain&&(this.wavetableSignalGain.gain.value=this.WAVETABLEBOOST),this.oscillatorNode&&this.wavetable&&this.oscillatorNode.setPeriodicWave(this.wavetable),this.wavetableSignalGain&&(this.wavetableSignalGain.gain.value=this.WAVETABLEBOOST)}updateModGain(t){this.modulatorGainValue=t,this.modulatorGain&&(this.modulatorGain.gain.value=t)}updateSampleLevel(t){this.carrierSampleGainValue=t,this.carrierSampleGain&&(this.carrierSampleGain.gain.value=t)}updateSynthLevel(t){this.oscillatorGainValue=t,this.oscillatorGain&&(this.oscillatorGain.gain.value=t)}updateNoiseLevel(t){this.noiseGainValue=t,this.noiseGain&&(this.noiseGain.gain.value=t)}updateDetuneValue(t){this.oscillatorDetuneValue=t,this.oscillatorNode&&(this.oscillatorNode.detune.value=t)}generateVocoderBands(t,e,i){const s=1200*Math.log(e/t)/Math.LN2/i,r=Math.pow(2,s/1200);this.vocoderBands=[];let o=t;for(let t=0;t<i;t++)this.vocoderBands[t]={frequency:o},o*=r;this.numVocoderBands=i}loadNoiseBuffer(){if(!this.audioContext)return;const t=5*this.audioContext.sampleRate;this.noiseBuffer=this.audioContext.createBuffer(1,t,this.audioContext.sampleRate);const e=this.noiseBuffer.getChannelData(0);for(let i=0;i<t;++i)e[i]=2*Math.random()-1}initBandpassFilters(){if(!this.audioContext)return;this.modulatorInput=this.audioContext.createGain(),this.carrierInput=this.audioContext.createGain(),null==this.modFilterBands&&(this.modFilterBands=[]),null==this.modFilterPostGains&&(this.modFilterPostGains=[]),null==this.heterodynes&&(this.heterodynes=[]),null==this.powers&&(this.powers=[]),null==this.lpFilters&&(this.lpFilters=[]),null==this.lpFilterPostGains&&(this.lpFilterPostGains=[]),null==this.carrierBands&&(this.carrierBands=[]),null==this.carrierFilterPostGains&&(this.carrierFilterPostGains=[]),null==this.carrierBandGains&&(this.carrierBandGains=[]);const t=new Float32Array(65536),e=32768;let i;for(let s=0;s<e;++s)i=s/e,t[e+s]=i,t[e-s-1]=i;const s=this.audioContext.createBiquadFilter();s.type="highpass",s.frequency.value=8e3,s.Q.value=1,this.modulatorInput.connect(s),this.hpFilterGain=this.audioContext.createGain(),this.hpFilterGain.gain.value=0,s.connect(this.hpFilterGain),this.modulatorBuffer&&this.hpFilterGain.connect(this.audioContext.destination),this.modFilterBands.length=0,this.modFilterPostGains.length=0,this.heterodynes.length=0,this.powers.length=0,this.lpFilters.length=0,this.lpFilterPostGains.length=0,this.carrierBands.length=0,this.carrierFilterPostGains.length=0,this.carrierBandGains.length=0,this.outputGain=this.audioContext.createGain(),this.modulatorBuffer&&this.outputGain.connect(this.audioContext.destination);const r=new Float32Array(65536);for(let t=-32768;t<32768;t++)r[t+32768]=(t>0?t:-t)/32768;for(let e=0;e<this.numVocoderBands;e++){const i=this.audioContext.createBiquadFilter();i.type="bandpass",this.vocoderBands&&(i.frequency.value=this.vocoderBands[e].frequency),i.Q.value=this.FILTER_QUALITY,this.modulatorInput.connect(i),this.modFilterBands.push(i);const s=this.audioContext.createBiquadFilter();s.type="bandpass",this.vocoderBands&&(s.frequency.value=this.vocoderBands[e].frequency),s.Q.value=this.FILTER_QUALITY,i.connect(s);const o=this.audioContext.createGain();o.gain.value=6,s.connect(o),this.modFilterPostGains.push(o);const n=this.audioContext.createOscillator();this.vocoderBands&&(n.frequency.value=this.vocoderBands[e].frequency),n.start(0);const a=this.audioContext.createGain();o.connect(a),a.gain.value=0,n.connect(a.gain);const h=this.audioContext.createGain();h.gain.value=2,a.connect(h),this.heterodynes.push(h);const u=this.audioContext.createWaveShaper();u.curve=r,h.connect(u);const l=this.audioContext.createBiquadFilter();l.type="lowpass",l.frequency.value=5,l.Q.value=1,this.lpFilters.push(l),u.connect(l);const c=this.audioContext.createGain();c.gain.value=1,l.connect(c),this.lpFilterPostGains.push(c);const d=this.audioContext.createWaveShaper();d.curve=t,c.connect(d);const p=this.audioContext.createBiquadFilter();p.type="bandpass",this.vocoderBands&&(p.frequency.value=this.vocoderBands[e].frequency),p.Q.value=this.FILTER_QUALITY,this.carrierBands.push(p),this.carrierInput.connect(p);const f=this.audioContext.createBiquadFilter();f.type="bandpass",this.vocoderBands&&(f.frequency.value=this.vocoderBands[e].frequency),f.Q.value=this.FILTER_QUALITY,p.connect(f);const m=this.audioContext.createGain();m.gain.value=10,f.connect(m),this.carrierFilterPostGains.push(m);const E=this.audioContext.createGain();this.carrierBandGains.push(E),m.connect(E),E.gain.value=0,d.connect(E.gain),E.connect(this.outputGain)}const o=new Float32Array(this.FOURIER_SIZE),n=new Float32Array(this.FOURIER_SIZE);o[0]=0,n[0]=0;for(let t=1;t<this.FOURIER_SIZE;t++)o[t]=1,n[t]=1;this.wavetable=this.audioContext.createPeriodicWave(o,n),this.loadNoiseBuffer()}setupVocoderGraph(){this.initBandpassFilters()}createCarriersAndPlay(t){this.audioContext&&t&&(this.carrierSampleNode=this.audioContext.createBufferSource(),this.carrierSampleNode.buffer=this.carrierBuffer,this.carrierSampleNode.loop=!0,this.carrierSampleGain=this.audioContext.createGain(),this.carrierSampleGain.gain.value=this.carrierSampleGainValue,this.carrierSampleNode.connect(this.carrierSampleGain),this.carrierSampleGain.connect(t),this.wavetableSignalGain=this.audioContext.createGain(),this.oscillatorNode=this.audioContext.createOscillator(),4==this.oscillatorType&&this.wavetable?(this.oscillatorNode.setPeriodicWave(this.wavetable),this.wavetableSignalGain.gain.value=this.WAVETABLEBOOST):this.wavetableSignalGain.gain.value=this.SAWTOOTHBOOST,this.oscillatorNode.frequency.value=110,this.oscillatorNode.detune.value=this.oscillatorDetuneValue,this.oscillatorNode.connect(this.wavetableSignalGain),this.oscillatorGain=this.audioContext.createGain(),this.oscillatorGain.gain.value=this.oscillatorGainValue,this.wavetableSignalGain.connect(this.oscillatorGain),this.oscillatorGain.connect(t),this.noiseNode=this.audioContext.createBufferSource(),this.noiseNode.buffer=this.noiseBuffer,this.noiseNode.loop=!0,this.noiseGain=this.audioContext.createGain(),this.noiseGain.gain.value=this.noiseGainValue,this.noiseNode.connect(this.noiseGain),this.noiseGain.connect(t),this.oscillatorNode.start(0),this.noiseNode.start(0),this.carrierSampleNode.start(0))}vocode(){if(this.audioContext){if(this.vocoding)return this.modulatorNode&&this.modulatorNode.stop(0),this.shutOffCarrier(),void(this.vocoding=!1);this.createCarriersAndPlay(this.carrierInput),this.vocoding=!0,this.modulatorGain=this.audioContext.createGain(),this.modulatorGain.gain.value=this.modulatorGainValue,this.modulatorBuffer&&(this.modulatorNode=this.audioContext.createBufferSource(),this.modulatorNode.buffer=this.modulatorBuffer,this.modulatorNode.connect(this.modulatorGain),this.modulatorNode.start(0)),this.modulatorInput&&this.modulatorGain.connect(this.modulatorInput)}}}class Y extends i{constructor(){super(...arguments),this.currentVocoder=null,this.modulatorGainValue=1,this.carrierSampleGainValue=0,this.oscillatorGainValue=1,this.noiseGainValue=.2,this.oscillatorDetuneValue=0}getNode(t){var e;const i=null===(e=this.bufferFetcherService)||void 0===e?void 0:e.getAudioBuffer(s.VOCODER_MODULATOR);this.currentVocoder=new K(t,i),this.currentVocoder.init(),this.applyCurrentSettingsToVocoder();const{modulatorGain:r,outputGain:o}=this.currentVocoder.getNodes();return{input:r,output:o}}getSettings(){return{modulatorGainValue:this.modulatorGainValue,carrierSampleGainValue:this.carrierSampleGainValue,oscillatorGainValue:this.oscillatorGainValue,noiseGainValue:this.noiseGainValue,oscillatorDetuneValue:this.oscillatorDetuneValue}}setSetting(e,i){return t(this,void 0,void 0,(function*(){if(r.isSettingValueValid(i)){switch(e){case"modulatorGainValue":this.modulatorGainValue=parseFloat(i);break;case"carrierSampleGainValue":this.carrierSampleGainValue=parseFloat(i);break;case"oscillatorGainValue":this.oscillatorGainValue=parseFloat(i);break;case"noiseGainValue":this.noiseGainValue=parseFloat(i);break;case"oscillatorDetuneValue":this.oscillatorDetuneValue=parseFloat(i)}this.applyCurrentSettingsToVocoder()}}))}applyCurrentSettingsToVocoder(){this.currentVocoder&&(this.currentVocoder.updateModGain(this.modulatorGainValue),this.currentVocoder.updateSampleLevel(this.carrierSampleGainValue),this.currentVocoder.updateSynthLevel(this.oscillatorGainValue),this.currentVocoder.updateNoiseLevel(this.noiseGainValue),this.currentVocoder.updateDetuneValue(this.oscillatorDetuneValue))}get order(){return 1}get id(){return s.FILTERS_NAMES.VOCODER}}class z{constructor(){this.mapConfig=new Map}getConfig(t){return this.mapConfig.get(t)}setConfig(t,e){this.mapConfig.set(t,e)}isCompatibilityModeEnabled(){return"true"==this.getConfig(s.PREFERENCES_KEYS.COMPATIBILITY_MODE_ENABLED)}isCompatibilityModeChecked(){return"true"==this.getConfig(s.PREFERENCES_KEYS.COMPATIBILITY_MODE_CHECKED)}isAudioWorkletEnabled(){const t=this.getConfig(s.PREFERENCES_KEYS.ENABLE_AUDIO_WORKLET);return null!=t?"true"==t:s.ENABLE_AUDIO_WORKLET}isSoundtouchAudioWorkletEnabled(){const t=this.getConfig(s.PREFERENCES_KEYS.ENABLE_SOUNDTOUCH_AUDIO_WORKLET);return null!=t?"true"==t:s.ENABLE_SOUNDTOUCH_AUDIO_WORKLET}getBufferSize(){const t=this.getConfig(s.PREFERENCES_KEYS.BUFFER_SIZE);return null!=t?parseInt(t):s.DEFAULT_BUFFER_SIZE}getSampleRate(){const t=this.getConfig(s.PREFERENCES_KEYS.SAMPLE_RATE);return null!=t?parseInt(t):s.DEFAULT_SAMPLE_RATE}enableCompatibilityMode(){this.setConfig(s.PREFERENCES_KEYS.COMPATIBILITY_MODE_ENABLED,"true")}disableCompatibilityMode(){this.setConfig(s.PREFERENCES_KEYS.COMPATIBILITY_MODE_ENABLED,"false")}getWorkletBasePath(){return""}getSoundBasePath(){return""}isInitialRenderingDisabled(){const t=this.getConfig(s.PREFERENCES_KEYS.DISABLE_INITIAL_RENDERING);return null!=t?"true"==t:s.DISABLE_INITIAL_RENDERING}}var j="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};var Q=!!(j===j.window&&j.URL&&j.Blob&&j.Worker);function Z(t,e){var i,s=this;if(e=e||{},Q)return i=t.toString().trim().match(/^function\s*\w*\s*\([\w\s,]*\)\s*{([\w\W]*?)}$/)[1],new j.Worker(j.URL.createObjectURL(new j.Blob([i],{type:"text/javascript"})));this.self=e,this.self.postMessage=function(t){setTimeout((function(){s.onmessage({data:t})}),0)},setTimeout(t.bind(e,e),0)}Z.prototype.postMessage=function(t){var e=this;setTimeout((function(){e.self.onmessage({data:t})}),0)};var $,X=($=Z)&&$.__esModule&&Object.prototype.hasOwnProperty.call($,"default")?$.default:$;const J={};function tt(){return new X((function(){let t,e,i=0,s=[];this.onmessage=function(t){switch(t.data.command){case"init":r(t.data.config);break;case"record":o(t.data.buffer);break;case"exportWAV":n(t.data.type);break;case"getBuffer":a();break;case"clear":h()}};const r=i=>{t=i.sampleRate,e=i.numChannels,u()},o=t=>{for(let i=0;i<e;i++)s[i].push(t[i]);i+=t[0].length},n=t=>{const r=[];for(let t=0;t<e;t++)r.push(l(s[t],i));let o;o=2===e?c(r[0],r[1]):r[0];const n=p(o),a=new Blob([n],{type:t});this.postMessage({command:"exportWAV",data:a})},a=()=>{const t=[];for(let r=0;r<e;r++)t.push(l(s[r],i));this.postMessage({command:"getBuffer",data:t})},h=()=>{i=0,s=[],u()},u=()=>{for(let t=0;t<e;t++)s[t]=[]},l=(t,e)=>{const i=new Float32Array(e);let s=0;for(let e=0;e<t.length;e++)t[e]?(i.set(t[e],s),s+=t[e].length):console.warn("RecorderWorker: undefined buffer has been detected");return i},c=(t,e)=>{const i=t.length+e.length,s=new Float32Array(i);let r=0,o=0;for(;r<i;)s[r++]=t[o],s[r++]=e[o],o++;return s},d=(t,e,i)=>{for(let s=0;s<i.length;s++)t.setUint8(e+s,i.charCodeAt(s))},p=i=>{const s=new ArrayBuffer(44+2*i.length),r=new DataView(s);return d(r,0,"RIFF"),r.setUint32(4,36+2*i.length,!0),d(r,8,"WAVE"),d(r,12,"fmt "),r.setUint32(16,16,!0),r.setUint16(20,1,!0),r.setUint16(22,e,!0),r.setUint32(24,t,!0),r.setUint32(28,4*t,!0),r.setUint16(32,2*e,!0),r.setUint16(34,16,!0),d(r,36,"data"),r.setUint32(40,2*i.length,!0),((t,e,i)=>{for(let s=0;s<i.length;s++,e+=2){const r=Math.max(-1,Math.min(1,i[s]));t.setInt16(e,r<0?32768*r:32767*r,!0)}})(r,44,i),r}}),J)}class et{constructor(t){this.worker=null,this.node=null,this.context=null,this.config={bufferLen:4096,sampleRate:44100,numChannels:2,mimeType:"audio/wav",workletBasePath:"worklets/",callback:()=>{}},this.callbacks={getBuffer:[],exportWAV:[]},this.recording=!1,Object.assign(this.config,t)}setup(e){return t(this,void 0,void 0,(function*(){this.node&&(this.node instanceof AudioWorkletNode&&this.node.port.postMessage("stop"),this.node.disconnect()),e&&(this.context=e.context,yield this.createRecorderNode(),this.node&&this.context&&(e.connect(this.node),this.node.connect(this.context.destination))),this.context&&!this.worker&&(this.worker=tt(),this.worker&&(this.worker.postMessage({command:"init",config:{sampleRate:this.context.sampleRate,numChannels:this.config.numChannels}}),this.worker.onmessage=t=>{let e=null;switch(t.data.command){case"getBuffer":e=this.callbacks.getBuffer;break;case"exportWAV":e=this.callbacks.exportWAV}if(e){const i=e.pop();"function"==typeof i&&i(t.data.data)}}))}))}createRecorderNode(){return t(this,void 0,void 0,(function*(){if(this.context)if(r.isAudioWorkletCompatible(this.context)&&s.ENABLE_RECORDER_AUDIO_WORKLET)try{yield this.createRecorderWorklet()}catch(t){this.createRecorderScriptProcessorNode()}else this.createRecorderScriptProcessorNode()}))}createRecorderWorklet(){return t(this,void 0,void 0,(function*(){if(this.context&&(yield this.context.audioWorklet.addModule(this.config.workletBasePath+s.WORKLET_PATHS.RECORDER_WORKLET),this.node=new AudioWorkletNode(this.context,s.WORKLET_NAMES.RECORDER_WORKLET),this.node&&this.node.port)){const t=this.node.parameters.get("numChannels");t&&(t.value=this.config.numChannels,t.setValueAtTime(this.config.numChannels,0)),this.node.port.onmessage=t=>{this.worker&&"record"==t.data.command&&t.data.buffer.length>0&&this.worker.postMessage({command:"record",buffer:t.data.buffer})}}}))}createRecorderScriptProcessorNode(){this.context&&(this.node=this.context.createScriptProcessor.call(this.context,this.config.bufferLen,this.config.numChannels,this.config.numChannels),this.node.onaudioprocess=t=>{if(!this.recording)return;const e=[];for(let i=0;i<this.config.numChannels;i++)e.push(t.inputBuffer.getChannelData(i));this.worker&&this.worker.postMessage({command:"record",buffer:e})})}record(){this.recording=!0,this.node instanceof AudioWorkletNode&&this.node.port.postMessage("record")}stop(){this.recording=!1,this.node instanceof AudioWorkletNode&&this.node.port.postMessage("stop")}clear(){this.worker&&this.worker.postMessage({command:"clear"})}kill(){this.clear(),this.stop(),this.worker&&this.worker.terminate()}getBuffer(t){if(!(t=t||this.config.callback))throw new Error("Callback not set");this.callbacks.getBuffer.push(t),this.worker&&this.worker.postMessage({command:"getBuffer"})}exportWAV(t,e){if(e=e||this.config.mimeType,!(t=t||this.config.callback))throw new Error("Callback not set");this.callbacks.exportWAV.push(t),this.worker&&this.worker.postMessage({command:"exportWAV",type:e})}static forceDownload(t,e){const i=window.document.createElement("a"),s=(window.URL||window.webkitURL).createObjectURL(t);window.document.body.appendChild(i),i.href=s,i.download=e||"output.wav",i.click(),window.URL.revokeObjectURL(s)}}class it{constructor(t,e){this.context=t,this.eventEmitter=e||new V}decodeBufferFromFile(e){return t(this,void 0,void 0,(function*(){this.eventEmitter&&this.eventEmitter.emit(exports.EventType.DECODING_AUDIO_FILE);try{const t=yield r.loadAudioBuffer(this.context,e);return this.eventEmitter&&this.eventEmitter.emit(exports.EventType.DECODED_AUDIO_FILE),t}catch(t){console.error(t),this.eventEmitter&&(this.eventEmitter.emit(exports.EventType.DECODED_AUDIO_FILE),this.eventEmitter.emit(exports.EventType.ERROR_DECODING_AUDIO_FILE))}return null}))}updateContext(t){this.context=t}}class st extends AudioWorkletProcessor{constructor(){super(),this.stopped=!1,this.samplesCount=0,this.port.onmessage=t=>{"stop"==t.data&&this.stop()}}static get parameterDescriptors(){return[]}get defaultParameterDescriptors(){return st.parameterDescriptors}process(t,e){if(this.stopped)return!1;const i=t[0],s=e[0];if(i&&i[0]&&(this.samplesCount+=i[0].length),s){for(let t=0;t<s.length;t++){const e=i[t],r=s[t];if(e)for(let t=0;t<e.length;t++)r[t]=e[t]}this.port.postMessage({command:"update",samplesCount:this.samplesCount})}return!0}stop(){this.stopped=!0}}registerProcessor(s.WORKLET_NAMES.PASSTHROUGH,st);class rt extends l{constructor(){super(),this._totalSamples=0,this.currentTime=0,this.lastSampleCount=0,this.samplePerSecond=0,this.currentTimeSamplesPerSecond=0}receiveEvent(t){const e=performance.now(),i=t.data.samplesCount;"update"===t.data.command&&this.calculatePercentageProcessed(e,i),this.calculateRemainingTimeProcessing(e,i)}calculatePercentageProcessed(t,e){0===this.currentTime&&(this.currentTime=t);const i=t-this.currentTime,r=e/this._totalSamples;this.eventEmitter&&i>=s.TREATMENT_TIME_COUNTING_THROTTLE_INTERVAL&&(this.eventEmitter.emit(exports.EventType.UPDATE_AUDIO_TREATMENT_PERCENT,100*r),this.currentTime=t)}calculateRemainingTimeProcessing(t,e){0===this.currentTimeSamplesPerSecond&&(this.currentTimeSamplesPerSecond=t);const i=t-this.currentTimeSamplesPerSecond,s=this._totalSamples-e;if(this.eventEmitter&&s<=0)this.eventEmitter.emit(exports.EventType.UPDATE_REMAINING_TIME_ESTIMATED,0);else if(this.eventEmitter&&i>=1e3){this.calculateSmoothedSamplePerSecond(i,e);const r=s/this.samplePerSecond;this.currentTimeSamplesPerSecond=t,this.lastSampleCount=e,isNaN(r)||!isFinite(r)?this.eventEmitter.emit(exports.EventType.UPDATE_REMAINING_TIME_ESTIMATED,-1):this.eventEmitter.emit(exports.EventType.UPDATE_REMAINING_TIME_ESTIMATED,r)}}calculateSmoothedSamplePerSecond(t,e){if(t>0){const i=(e-this.lastSampleCount)/(t/1e3);this.samplePerSecond=s.TREATMENT_TIME_COUNTING_SMOOTHING_FACTOR*i+(1-s.TREATMENT_TIME_COUNTING_SMOOTHING_FACTOR)*this.samplePerSecond}}get workletName(){return s.WORKLET_NAMES.PASSTHROUGH}get workletPath(){return s.WORKLET_PATHS.PASSTHROUGH}get order(){return 10}get id(){return s.FILTERS_NAMES.PASSTHROUGH}set totalSamples(t){this._totalSamples=t,this.currentTime=0,this.currentTimeSamplesPerSecond=0,this.samplePerSecond=0,this.lastSampleCount=0}getSettings(){return{}}isEnabled(){return!0}setSetting(e,i){return t(this,void 0,void 0,(function*(){}))}}class ot{constructor(t,e){this.seconds=0,this.initialSeconds=0,this.interval=null,this.incr=1,this.countCallback=()=>{},this.seconds=t,this.initialSeconds=t,this.interval,this.incr=e}start(){this.interval=window.setInterval((()=>this.count()),1e3)}stop(){clearInterval(this.interval)}count(){this.seconds+=this.incr,this.seconds<=0&&this.stop(),this.countCallback&&this.countCallback()}onCount(t){this.countCallback=t}}exports.AbstractAudioElement=e,exports.AbstractAudioFilter=i,exports.AbstractAudioFilterWorklet=l,exports.AbstractAudioRenderer=S,exports.AudioEditor=class extends e{constructor(t,e,i,r,o){super(),this.principalBuffer=null,this.sumPrincipalBuffer=0,this.renderedBuffer=null,this.entrypointFilter=null,this.filters=[],this.renderers=[],this.currentNodes=null,this.savingBuffer=!1,this.previousSampleRate=s.DEFAULT_SAMPLE_RATE,this.audioBuffersToFetch=[],this.playingStoppedCallback=null,this.audioRenderingLastCanceled=!1,this.initialRenderingDone=!1,this.downloadingInitialData=!1,this.currentContext=t,this.eventEmitter=i||new V,this.bufferPlayer=e||new q(t),this.configService=r||new z,this.bufferFetcherService=new H(this.currentContext,this.configService,this.eventEmitter),this.bufferDecoderService=new it(this.currentContext,this.eventEmitter),this.audioBuffersToFetch=o||[],this.setup()}setup(){this.configService&&(this.previousSampleRate=this.configService.getSampleRate(),this.eventEmitter&&this.eventEmitter.emit(exports.EventType.SAMPLE_RATE_CHANGED,this.previousSampleRate)),this.currentContext||this.createNewContext(this.previousSampleRate),this.bufferPlayer&&(this.bufferPlayer.onBeforePlaying((()=>t(this,void 0,void 0,(function*(){this.bufferPlayer&&this.bufferPlayer.compatibilityMode&&this.currentContext&&(yield this.setupOutput(this.currentContext))})))),this.bufferPlayer.on(exports.EventType.PLAYING_FINISHED,(()=>{this.savingBuffer&&this.playingStoppedCallback&&this.off(exports.EventType.PLAYING_STOPPED,this.playingStoppedCallback),this.bufferPlayer&&this.bufferPlayer.loop&&this.bufferPlayer.start()}))),this.setupDefaultFilters(),this.setupDefaultRenderers(),this.audioBuffersToFetch.length>0&&this.fetchBuffers(!1)}addFilters(...t){for(const e of t)e.initializeDefaultSettings(),e.bufferFetcherService=this.bufferFetcherService,e.bufferDecoderService=this.bufferDecoderService,e.configService=this.configService,e.eventEmitter=this.eventEmitter;this.filters.push(...t)}addRenderers(...t){for(const e of t)e.bufferFetcherService=this.bufferFetcherService,e.bufferDecoderService=this.bufferDecoderService,e.configService=this.configService;this.renderers.push(...t)}setupDefaultFilters(){const t=new o(200,15,200,-2),e=new d(16,.9),i=new p(.2,.75),s=new f(3500),r=new g(3500),n=new _,a=new U,h=new v(0,0,0,3,-.05,.1),u=new W,l=new Y,c=new rt;this.entrypointFilter=a,this.addFilters(t,e,i,s,r,n,h,u,a,l,c)}setupDefaultRenderers(){const t=new R;this.addRenderers(t)}fetchBuffers(e){return t(this,void 0,void 0,(function*(){if(!this.downloadingInitialData&&this.bufferFetcherService){this.downloadingInitialData=!0,this.eventEmitter&&!e&&this.eventEmitter.emit(exports.EventType.LOADING_BUFFERS);try{yield this.bufferFetcherService.fetchAllBuffers(this.audioBuffersToFetch),this.downloadingInitialData=!1,this.eventEmitter&&!e&&this.eventEmitter.emit(exports.EventType.LOADED_BUFFERS)}catch(t){this.eventEmitter&&!e&&this.eventEmitter.emit(exports.EventType.LOADING_BUFFERS_ERROR)}}}))}createNewContextIfNeeded(){return t(this,void 0,void 0,(function*(){if(this.configService&&this.configService.isCompatibilityModeEnabled()&&this.principalBuffer)this.currentSampleRate!=this.principalBuffer.sampleRate&&(yield this.createNewContext(this.principalBuffer.sampleRate),this.previousSampleRate=this.principalBuffer.sampleRate,yield this.resetBufferFetcher());else{let t=s.DEFAULT_SAMPLE_RATE;if(this.configService&&(t=this.configService.getSampleRate()),t!=this.previousSampleRate)return yield this.createNewContext(t),this.previousSampleRate=t,yield this.resetBufferFetcher(),!0}}))}resetBufferFetcher(){return t(this,void 0,void 0,(function*(){this.bufferFetcherService&&(this.bufferFetcherService.reset(),yield this.fetchBuffers(!0),yield this.resetReverbFilterBuffer())}))}resetReverbFilterBuffer(){return t(this,void 0,void 0,(function*(){var t;const e=this.getFiltersSettings().get(s.FILTERS_NAMES.REVERB);if(e){const i=null===(t=e.reverbEnvironment)||void 0===t?void 0:t.value;i&&"custom"!==i&&this.bufferFetcherService&&(yield this.bufferFetcherService.fetchBuffer(i))}}))}createNewContext(e){return t(this,void 0,void 0,(function*(){this.currentContext&&(yield this.currentContext.close());const t={latencyHint:"interactive"};0!=e&&(t.sampleRate=e),this.currentContext=new AudioContext(t),this.eventEmitter&&this.eventEmitter.emit(exports.EventType.SAMPLE_RATE_CHANGED,this.currentContext.sampleRate),this.bufferPlayer&&this.bufferPlayer.updateContext(this.currentContext),this.bufferFetcherService&&this.bufferFetcherService.updateContext(this.currentContext),this.bufferDecoderService&&this.bufferDecoderService.updateContext(this.currentContext)}))}prepareContext(){return t(this,void 0,void 0,(function*(){const t=yield this.createNewContextIfNeeded();return this.currentContext&&this.currentContext.resume(),t}))}get currentSampleRate(){return this.currentContext?this.currentContext.sampleRate:0}get defaultDeviceSampleRate(){const t=new AudioContext;let e=0;return t&&(e=t.sampleRate,t.close()),e}loadBufferFromFile(e){return t(this,void 0,void 0,(function*(){if(this.principalBuffer=null,yield this.prepareContext(),!this.currentContext||!this.bufferDecoderService)throw new Error("Audio Context is not ready!");if(this.principalBuffer=yield this.bufferDecoderService.decodeBufferFromFile(e),this.initialRenderingDone=!1,!this.principalBuffer)throw new Error("Error decoding audio file");this.sumPrincipalBuffer=r.sumAudioBuffer(this.principalBuffer),this.resetAudioRenderingProgress()}))}resetAudioRenderingProgress(){this.eventEmitter&&(this.eventEmitter.emit(exports.EventType.UPDATE_AUDIO_TREATMENT_PERCENT,0),this.eventEmitter.emit(exports.EventType.UPDATE_REMAINING_TIME_ESTIMATED,-1))}loadBuffer(t){this.principalBuffer=t,this.sumPrincipalBuffer=r.sumAudioBuffer(this.principalBuffer),this.initialRenderingDone=!1}connectNodes(e,i,s,r){return t(this,void 0,void 0,(function*(){if(!this.entrypointFilter)return;let t=null;if(s&&this.currentNodes)t=this.currentNodes.input;else{const s=yield this.entrypointFilter.getEntrypointNode(e,i,!r);t=s.input}const o=[];let n=t;this.disconnectOldNodes(s);const a=this.filters.sort(((t,e)=>t.order-e.order)).filter(((t,e)=>t!==this.entrypointFilter&&(t.isEnabled()||e>=this.filters.length-1)));for(const t of a){const i=t.getNode(e);n&&n.connect(i.input),n=i.output,o.push(i)}this.entrypointFilter&&this.entrypointFilter.updateState(),this.currentNodes={input:t,output:n,intermediateNodes:o.filter((e=>e.input!=n&&e.output!=n&&e.input!=t&&e.output!=t))}}))}disconnectOldNodes(t){if(this.currentNodes&&(this.currentNodes.input.disconnect(),t||this.currentNodes.output.disconnect(),this.currentNodes.intermediateNodes))for(const t of this.currentNodes.intermediateNodes)t.input.disconnect(),t.output.disconnect()}reconnectNodesIfNeeded(){return t(this,void 0,void 0,(function*(){if(this.bufferPlayer&&this.bufferPlayer.compatibilityMode&&this.currentContext&&this.principalBuffer&&this.bufferPlayer&&this.entrypointFilter){yield this.connectNodes(this.currentContext,this.principalBuffer,!0,this.bufferPlayer.compatibilityMode);const t=this.entrypointFilter.getSpeed();this.bufferPlayer.speedAudio=t,this.bufferPlayer.duration=this.calculateAudioDuration(t)*t}}))}initializeWorklets(e){return t(this,void 0,void 0,(function*(){for(const t of this.filters)t.isWorklet()&&(yield t.initializeWorklet(e))}))}getOutputBuffer(){return this.renderedBuffer}renderAudio(){return t(this,void 0,void 0,(function*(){const t=yield this.prepareContext();if(!this.currentContext)throw new Error("AudioContext is not yet available");if(!this.entrypointFilter)throw new Error("Entrypoint filter is not available");if(!this.initialRenderingDone&&this.configService&&this.configService.isInitialRenderingDisabled())return this.loadInitialBuffer(),this.initialRenderingDone=!0,!0;this.bufferPlayer&&(t||this.configService&&!this.configService.isCompatibilityModeEnabled()&&this.bufferPlayer.compatibilityMode)&&this.bufferPlayer.stop();const e=this.entrypointFilter.getSpeed(),i=this.calculateAudioDuration(e),s=new OfflineAudioContext(2,this.currentContext.sampleRate*i,this.currentContext.sampleRate),r=this.configService&&this.configService.isCompatibilityModeEnabled()?this.currentContext:s;return this.renderedBuffer=yield this.executeAudioRenderers(r),this.currentOfflineContext=null,this.audioRenderingLastCanceled=!1,this.setupPasstroughFilter(i),yield this.setupOutput(r,i,s)}))}executeAudioRenderers(e){return t(this,void 0,void 0,(function*(){let t=this.principalBuffer;for(const i of this.renderers.sort(((t,e)=>t.order-e.order)))i.isEnabled()&&(t=yield i.renderAudio(e,t));return t}))}setupPasstroughFilter(t){this.resetAudioRenderingProgress();const e=this.filters.find((t=>t.id===s.FILTERS_NAMES.PASSTHROUGH));e&&this.currentContext&&(e.totalSamples=t*this.currentContext.sampleRate)}setupOutput(e,i,s){return t(this,void 0,void 0,(function*(){if(this.renderedBuffer&&this.configService&&this.eventEmitter&&this.bufferPlayer){if(yield this.initializeWorklets(e),yield this.connectNodes(e,this.renderedBuffer,!1,this.configService.isCompatibilityModeEnabled()),this.entrypointFilter){const t=this.entrypointFilter.getSpeed();this.bufferPlayer.speedAudio=t}if(!this.configService.isCompatibilityModeEnabled()&&s&&this.currentNodes){this.currentOfflineContext=s,this.currentNodes.output.connect(e.destination);const t=yield s.startRendering();if(!this.loadRenderedAudio(t))return yield this.setupOutput(this.currentContext,i);if(this.audioRenderingLastCanceled)return!1;this.eventEmitter.emit(exports.EventType.OFFLINE_AUDIO_RENDERING_FINISHED)}else this.bufferPlayer.setCompatibilityMode(this.currentNodes.output,i);return this.eventEmitter.emit(exports.EventType.AUDIO_RENDERING_FINISHED),!0}return!1}))}loadRenderedAudio(t){if(this.eventEmitter&&this.bufferPlayer){if(this.audioRenderingLastCanceled)this.initialRenderingDone||(this.loadInitialBuffer(),this.eventEmitter.emit(exports.EventType.CANCELLED_AND_LOADED_INITIAL_AUDIO));else{if(0==r.sumAudioBuffer(t)&&0!==this.sumPrincipalBuffer){if(this.configService&&!this.configService.isCompatibilityModeChecked())return this.setCompatibilityModeChecked(!0),this.configService.enableCompatibilityMode(),this.eventEmitter.emit(exports.EventType.COMPATIBILITY_MODE_AUTO_ENABLED),!1;this.eventEmitter.emit(exports.EventType.RENDERING_AUDIO_PROBLEM_DETECTED)}this.renderedBuffer=t,this.bufferPlayer.loadBuffer(this.renderedBuffer)}this.initialRenderingDone=!0}return!0}loadInitialBuffer(){this.bufferPlayer&&(this.renderedBuffer=this.principalBuffer,this.bufferPlayer.loadBuffer(this.principalBuffer))}cancelAudioRendering(){this.currentOfflineContext&&!this.audioRenderingLastCanceled&&(this.audioRenderingLastCanceled=!0,this.disconnectOldNodes(!1),this.eventEmitter&&this.eventEmitter.emit(exports.EventType.CANCELLING_AUDIO_PROCESSING))}calculateAudioDuration(t){if(this.principalBuffer){let e=r.calcAudioDuration(this.principalBuffer,t);for(const t of this.filters)t.isEnabled()&&(e+=t.getAddingTime());return e}return 0}get order(){return-1}get id(){return s.AUDIO_EDITOR}isEnabled(){return!0}isAudioWorkletAvailable(){return!!this.currentContext&&r.isAudioWorkletCompatible(this.currentContext)}setCompatibilityModeChecked(t){this.configService&&this.configService.setConfig(s.PREFERENCES_KEYS.COMPATIBILITY_MODE_CHECKED,""+t)}getFiltersState(){const t={};return[...this.filters,...this.renderers].forEach((e=>{t[e.id]=e.isEnabled()})),t}getFiltersSettings(){const t=new Map;for(const e of this.filters)t.set(e.id,e.getSettings());return t}toggleFilter(t){const e=this.filters.find((e=>e.id===t)),i=this.renderers.find((e=>e.id===t));e&&e.toggle(),i&&i.toggle(),this.reconnectNodesIfNeeded()}changeFilterSettings(e,i){return t(this,void 0,void 0,(function*(){const t=this.filters.find((t=>t.id===e));if(t){for(const e of Object.keys(i))yield t.setSetting(e,i[e]);yield this.reconnectNodesIfNeeded()}}))}resetFilterSettings(e){return t(this,void 0,void 0,(function*(){const t=this.filters.find((t=>t.id===e));t&&(yield t.resetSettings(),this.reconnectNodesIfNeeded())}))}resetAllFiltersState(){[...this.filters,...this.renderers].forEach((t=>{t.isDefaultEnabled()?t.enable():t.disable()})),this.reconnectNodesIfNeeded()}exit(){this.bufferPlayer&&(this.bufferPlayer.stop(),this.bufferPlayer.reset()),this.cancelAudioRendering(),this.principalBuffer=null}on(t,e){this.eventEmitter&&this.eventEmitter.on(t,e)}off(t,e){this.eventEmitter&&this.eventEmitter.off(t,e)}saveBuffer(){return this.savingBuffer?Promise.reject():(this.savingBuffer=!0,new Promise(((t,e)=>{if(!this.bufferPlayer)return e();if(this.bufferPlayer.compatibilityMode)this.bufferPlayer.start().then((()=>{if(!this.configService)return e();const i=new et({bufferLen:this.configService.getBufferSize(),sampleRate:this.configService.getSampleRate(),numChannels:2,workletBasePath:this.configService.getWorkletBasePath(),mimeType:"audio/wav"});i.setup(this.currentNodes.output).then((()=>{i.record(),this.playingStoppedCallback=()=>{i.kill(),this.savingBuffer=!1,this.off(exports.EventType.PLAYING_FINISHED,e),this.playingStoppedCallback&&this.off(exports.EventType.PLAYING_STOPPED,this.playingStoppedCallback),t(!0)};const e=()=>{this.playingStoppedCallback&&this.off(exports.EventType.PLAYING_STOPPED,this.playingStoppedCallback),i.stop(),i.exportWAV((s=>{this.downloadAudioBlob(s),this.savingBuffer=!1,this.off(exports.EventType.PLAYING_FINISHED,e),i.kill(),t(!0)}))};this.on(exports.EventType.PLAYING_FINISHED,e),this.on(exports.EventType.PLAYING_STOPPED,this.playingStoppedCallback)}))}));else{if(!this.renderedBuffer||!this.currentContext)return t(!1);const e=tt();if(e){e.onmessage=i=>{i.data.command==s.EXPORT_WAV_COMMAND&&this.downloadAudioBlob(i.data.data),e.terminate(),this.savingBuffer=!1,t(!0)},e.postMessage({command:s.INIT_COMMAND,config:{sampleRate:this.renderedBuffer.sampleRate,numChannels:2}});const i=[];for(let t=0;t<this.renderedBuffer.numberOfChannels;t++)i.push(this.renderedBuffer.getChannelData(t));e.postMessage({command:s.RECORD_COMMAND,buffer:i}),e.postMessage({command:s.EXPORT_WAV_COMMAND,type:s.AUDIO_WAV})}}})))}downloadAudioBlob(t){et.forceDownload(t,"audio-"+(new Date).toISOString()+".wav")}},exports.BufferPlayer=q,exports.Constants=s,exports.EventEmitter=V,exports.GenericConfigService=z,exports.UtilFunctions=r,exports.VoiceRecorder=class extends e{constructor(t,e,i){super(),this.input=null,this.stream=null,this.recorder=null,this.alreadyInit=!1,this.timer=null,this.enableAudioFeedback=!1,this.recording=!1,this.deviceList=[],this.constraints={audio:{noiseSuppression:!0,echoCancellation:!0,autoGainControl:!0,sampleRate:{ideal:44100}}},this.eventEmitter=null,this.previousSampleRate=s.DEFAULT_SAMPLE_RATE,this.sampleRateConfigNotSupported=!1,this.context=t,this.eventEmitter=e||new V,this.configService=i||null,this.configService&&(this.previousSampleRate=this.configService.getSampleRate())}init(){return t(this,void 0,void 0,(function*(){var t;if(this.isRecordingAvailable()){this.sampleRateConfigNotSupported=!navigator.mediaDevices.getSupportedConstraints().sampleRate,this.context?yield this.createNewContextIfNeeded():yield this.createNewContext(this.previousSampleRate),null===(t=this.eventEmitter)||void 0===t||t.emit(exports.EventType.RECORDER_INIT);try{const t=yield navigator.mediaDevices.getUserMedia(this.constraints);this.context&&this.context.resume(),yield this.setup(t,!1,!1),this.alreadyInit=!0,this.timer=new ot(0,1),this.timer.onCount((()=>{var t;null===(t=this.eventEmitter)||void 0===t||t.emit(exports.EventType.RECORDER_COUNT_UPDATE)})),this.successCallback()}catch(t){console.error(t);if(t)switch(t.name){case"SecurityError":case"NotAllowedError":this.errorCallback();break;case"NotFoundError":this.notFoundErrorCallback();break;case"NotSupportedError":this.sampleRateConfigNotSupported||(this.previousSampleRate=0,this.sampleRateConfigNotSupported=!0,this.init());break;default:this.unknownErrorCallback()}}navigator.mediaDevices.ondevicechange=()=>this.updateInputList()}}))}createNewContextIfNeeded(){return t(this,void 0,void 0,(function*(){let t=s.DEFAULT_SAMPLE_RATE;this.configService&&(t=this.configService.getSampleRate()),t!=this.previousSampleRate&&(yield this.createNewContext(t),this.previousSampleRate=t)}))}createNewContext(e){return t(this,void 0,void 0,(function*(){this.context&&(yield this.context.close());const t={latencyHint:"balanced"};0==e||this.sampleRateConfigNotSupported||(t.sampleRate=e),this.context=new AudioContext(t),this.constraints.audio.sampleRate={ideal:this.context.sampleRate}}))}successCallback(){var t;null===(t=this.eventEmitter)||void 0===t||t.emit(exports.EventType.RECORDER_SUCCESS)}errorCallback(){var t;null===(t=this.eventEmitter)||void 0===t||t.emit(exports.EventType.RECORDER_ERROR)}notFoundErrorCallback(){var t;null===(t=this.eventEmitter)||void 0===t||t.emit(exports.EventType.RECORDER_NOT_FOUND_ERROR)}unknownErrorCallback(){var t;null===(t=this.eventEmitter)||void 0===t||t.emit(exports.EventType.RECORDER_UNKNOWN_ERROR)}audioFeedback(t){var e;this.context&&(t?(this.input&&this.input.connect(this.context.destination),this.enableAudioFeedback=!0):(this.input&&this.input.connect(this.context.destination)&&this.input.disconnect(this.context.destination),this.enableAudioFeedback=!1),null===(e=this.eventEmitter)||void 0===e||e.emit(exports.EventType.RECORDER_UPDATE_CONSTRAINTS))}getConstraints(){if(this.stream){const t=this.stream.getTracks();if(t&&t.length>0)return t[0].getSettings()}return null}updateConstraints(){var t;const e=this.getConstraints();e&&(this.constraints.audio=Object.assign(this.constraints.audio,e),null===(t=this.eventEmitter)||void 0===t||t.emit(exports.EventType.RECORDER_UPDATE_CONSTRAINTS))}resetConstraints(e){return t(this,void 0,void 0,(function*(){if(this.stream){const t=this.enableAudioFeedback,i=this.recording,s=this.stream.getTracks();if(e&&(this.updateConstraints(),this.constraints.audio=Object.assign(this.constraints.audio,e.audio)),s&&s.length>0)try{yield s[0].applyConstraints(this.constraints.audio);const r=this.getConstraints(),o=e?Object.keys(e.audio)[0]:"";if(this.audioFeedback(!1),this.pause(),!e||r&&r[o]!=e.audio[o]){this.stopStream();const e=yield navigator.mediaDevices.getUserMedia(this.constraints);yield this.setup(e,i,t)}else yield this.setup(null,i,t)}catch(t){this.errorCallback()}}}))}setup(e,i,s){return t(this,void 0,void 0,(function*(){e&&this.context&&(this.input=this.context.createMediaStreamSource(e),this.stream=e),this.recorder&&this.input&&(yield this.recorder.setup(this.input),i&&(yield this.record())),this.audioFeedback(s),this.updateConstraints(),yield this.updateInputList()}))}setNoiseSuppression(t){this.resetConstraints({audio:{noiseSuppression:t}})}setAutoGain(t){this.resetConstraints({audio:{autoGainControl:t}})}setEchoCancellation(t){this.resetConstraints({audio:{echoCancellation:t}})}updateInputList(){return t(this,void 0,void 0,(function*(){if(this.deviceList){const t=yield navigator.mediaDevices.enumerateDevices();this.deviceList=[],t.forEach((t=>{"audioinput"==t.kind&&this.deviceList.push(t)}))}}))}changeInput(t,e){e&&(this.constraints.audio.deviceId=t,this.constraints.audio.groupId=e,this.resetConstraints())}record(){return t(this,void 0,void 0,(function*(){this.alreadyInit&&this.configService&&this.input&&(this.recorder||(this.recorder=new et({bufferLen:this.configService.getBufferSize(),sampleRate:this.configService.getSampleRate(),numChannels:2,workletBasePath:this.configService.getWorkletBasePath(),mimeType:"audio/wav"}),yield this.recorder.setup(this.input)),this.recorder&&this.recorder.record(),this.timer&&this.timer.start(),this.recording=!0,this.eventEmitter&&this.eventEmitter.emit(exports.EventType.RECORDER_RECORDING))}))}stop(){return t(this,void 0,void 0,(function*(){this.alreadyInit&&this.recorder&&(this.recorder.stop(),this.timer&&this.timer.stop(),this.recording=!1,this.recorder.getBuffer((t=>{var e;if(this.context){this.context.resume();const i=this.context.createBuffer(2,t[0].length,this.context.sampleRate);i.getChannelData(0).set(t[0]),i.getChannelData(1).set(t[1]),null===(e=this.eventEmitter)||void 0===e||e.emit(exports.EventType.RECORDER_STOPPED,i),this.reset()}})))}))}pause(){var t;this.alreadyInit&&(this.recorder&&this.recorder.stop(),this.timer&&this.timer.stop(),this.recording=!1,null===(t=this.eventEmitter)||void 0===t||t.emit(exports.EventType.RECORDER_PAUSED))}stopStream(){if(this.stream){const t=this.stream.getTracks();for(let e=0,i=t.length;e<i;e++)t[e].stop()}}reset(){var t;this.recorder&&this.recorder.kill(),this.timer&&this.timer.stop(),this.audioFeedback(!1),this.stopStream(),this.input=null,this.recorder=null,this.stream=null,this.alreadyInit=!1,this.timer=null,null===(t=this.eventEmitter)||void 0===t||t.emit(exports.EventType.RECORDER_RESETED)}get currentTimeDisplay(){var t,e,i;return(null===(t=this.timer)||void 0===t?void 0:t.seconds)?("0"+Math.trunc((null===(e=this.timer)||void 0===e?void 0:e.seconds)/60)).slice(-2)+":"+("0"+Math.trunc((null===(i=this.timer)||void 0===i?void 0:i.seconds)%60)).slice(-2):"00:00"}get currentTime(){return this.timer?this.timer.seconds:0}getSettings(){return{deviceList:this.deviceList,audioFeedback:this.enableAudioFeedback,constraints:this.constraints.audio}}on(t,e){var i;null===(i=this.eventEmitter)||void 0===i||i.on(t,e)}isRecordingAvailable(){return void 0!==navigator.mediaDevices&&void 0!==navigator.mediaDevices.getUserMedia}get order(){return-1}get id(){throw s.VOICE_RECORDER}};
//# sourceMappingURL=SimpleSoundStudioLibrary.js.map
